This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-12-14T20:42:02.326Z

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

Additional Info:
----------------

For more information about Repomix, visit: https://github.com/yamadashy/repomix

================================================================
Repository Structure
================================================================
.cursor/mcp.json
.gitignore
app/activites/page.tsx
app/admin/activites/page.tsx
app/admin/apporteurs/[id]/ApporteurDetailContent.tsx
app/admin/apporteurs/[id]/page.tsx
app/admin/apporteurs/page.tsx
app/admin/dossiers/[id]/AdminDossierDetailContent.tsx
app/admin/dossiers/[id]/page.tsx
app/admin/dossiers/page.tsx
app/admin/nouveau-dossier/page.tsx
app/admin/onboarding/page.tsx
app/admin/page.tsx
app/admin/profil/AdminNotificationSettings.tsx
app/admin/profil/AdminProfileInfo.tsx
app/admin/profil/page.tsx
app/admin/statistiques/page.tsx
app/api/admin/devis/route.ts
app/api/devis/manage/route.ts
app/api/dossiers/[id]/client/route.ts
app/api/dossiers/[id]/pret/route.ts
app/api/dossiers/create/route.ts
app/api/exade/tarifs/route.ts
app/api/extraction/extract/route.ts
app/api/pdf/generate/route.ts
app/connexion/page.tsx
app/dossier-confirme/[id]/DossierConfirmeContent.tsx
app/dossier-confirme/[id]/page.tsx
app/dossier/[id]/DossierDetailContent.tsx
app/dossier/[id]/page.tsx
app/globals.css
app/invite/[token]/page.tsx
app/layout.tsx
app/mes-dossiers/page.tsx
app/not-found.tsx
app/nouveau-dossier/page.tsx
app/onboarding/page.tsx
app/page.tsx
app/profil/CabinetSection.tsx
app/profil/NotificationSettings.tsx
app/profil/page.tsx
app/profil/ProfileInfo.tsx
app/profil/ResourcesSection.tsx
app/reset-password/page.tsx
components.json
components/ActivityCard.tsx
components/AdminActivity.tsx
components/AdminActivityConnected.tsx
components/AdminHeader.tsx
components/AdminStatsCards.tsx
components/ApporteurActivity.tsx
components/ApporteurHeader.tsx
components/ApporteurStatsCards.tsx
components/AuthProvider.tsx
components/ClientInfoForm.tsx
components/DataComparisonModal.tsx
components/DocumentUpload.tsx
components/DossierCard.tsx
components/DossierProgress.tsx
components/DossierTypeSelection.tsx
components/ExtractionResult.tsx
components/features/broker/BrokerContextProvider.tsx
components/features/document-viewer/DocumentViewerModal.tsx
components/features/exade/ExadeConfiguration.tsx
components/features/invites/InviteModal.tsx
components/features/invites/InvitesBanner.tsx
components/features/wallet/WalletSummaryCard.tsx
components/ui/badge.tsx
components/ui/button.tsx
components/ui/calendar.tsx
components/ui/card.tsx
components/ui/date-picker.tsx
components/ui/dropdown-menu.tsx
components/ui/empty-state.tsx
components/ui/popover.tsx
components/ui/select.tsx
db.md
eslint.config.mjs
hooks/useBrokerContext.ts
lib/config/exade.ts
lib/constants/exade.ts
lib/hooks/useIntersectionObserver.ts
lib/hooks/useOptimisticActivityReadStatus.ts
lib/hooks/useOptimisticReadStatus.ts
lib/hooks/useTheme.ts
lib/services/activities.ts
lib/services/activity-read-status-cache.ts
lib/services/apporteurs.ts
lib/services/client-infos.ts
lib/services/data-comparison.ts
lib/services/devis.ts
lib/services/document-extraction.ts
lib/services/documents.ts
lib/services/dossier-read-status.ts
lib/services/dossiers.ts
lib/services/exade.ts
lib/services/gemini-extraction.ts
lib/services/pret-data.ts
lib/services/read-status-cache.ts
lib/supabase.ts
lib/utils.ts
lib/utils/activity-config.ts
lib/utils/apporteur-badges.ts
lib/utils/formatters.ts
lib/utils/statut-mapping.ts
next-env.d.ts
next.config.ts
package.json
postcss.config.mjs
public/assets/svgs/gmb-courtagegrand.svg
public/assets/svgs/logo-cote.svg
public/assets/svgs/logo-entier-final.svg
public/assets/svgs/logo-entier.svg
public/assets/svgs/logo.svg
public/favicon.svg
README-EXTRACTION.md
README.md
services/api.ts
supabase/functions/generate-pdf/index.ts
supabase/functions/manage-devis/index.ts
supabase/functions/manage-documents/index.ts
supabase/functions/update-client-data/index.ts
supabase/functions/update-pret-data/index.ts
supabase/migrations/test_inter_broker_leak.sql
tailwind.config.js
tsconfig.json
types/data-comparison.ts
types/document-extraction.ts
types/model.ts
types/supabase.ts

================================================================
Repository Files
================================================================

================
File: .cursor/mcp.json
================
{
  "mcpServers": {
    "shadcn": {
      "command": "npx",
      "args": [
        "shadcn@latest",
        "mcp"
      ]
    }
  }
}

================
File: .gitignore
================
# Dependencies
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Next.js
.next/
out/
build/
dist/

# Environment variables
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Logs
logs
*.log

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Coverage directory used by tools like istanbul
coverage/
*.lcov

# nyc test coverage
.nyc_output

# Dependency directories
jspm_packages/

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Microbundle cache
.rpt2_cache/
.rts2_cache_cjs/
.rts2_cache_es/
.rts2_cache_umd/

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# parcel-bundler cache (https://parceljs.org/)
.cache
.parcel-cache

# Next.js build output
.next

# Nuxt.js build / generate output
.nuxt

# Storybook build outputs
.out
.storybook-out

# Temporary folders
tmp/
temp/

# Supabase
.supabase/

# Documentation (sensitive or internal docs)
document/
documents/

# Database
*.db
*.sqlite
*.sqlite3

# Backup files
*.bak
*.backup

# Lock files (keep package-lock.json but ignore others)
yarn.lock
pnpm-lock.yaml

# Build artifacts
*.tsbuildinfo

# Vercel
.vercel

# Turbo
.turbo

================
File: app/activites/page.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useRouter } from 'next/navigation';
import { ActivitiesService } from '@/lib/services/activities';
import { ActivityReadStatusCache } from '@/lib/services/activity-read-status-cache';
import ActivityCard from '@/components/ActivityCard';
import { useBrokerContext } from '@/hooks/useBrokerContext';
import { useTheme } from '@/lib/hooks/useTheme';
import { useAuth } from '@/components/AuthProvider';
import { api } from '@/services/api';
import { getActivityConfig } from '@/lib/utils/activity-config';
import { EmptyState } from '@/components/ui/empty-state';

// Interface pour les activités depuis Supabase
interface Activity {
  id: string;
  user_id: string;
  activity_type: string;
  activity_title: string;
  activity_description: string;
  activity_data?: any;
  created_at: string;
  is_read: boolean;
  dossier_id?: string;
  // Propriétés formatées
  type?: 'success' | 'info' | 'warning' | 'error';
  icon?: string;
  amount?: string;
  status?: string;
  time?: string;
  client_name?: string;
  dossier_number?: string;
}

const ITEMS_PER_PAGE = 20; // Nombre d'éléments par page

export default function ActivitesPage() {
  const router = useRouter();

  // ✅ Utilisation du hook centralisé pour le dark mode
  const { darkMode, isInitialized, toggleDarkMode } = useTheme();
  const { currentBrokerId } = useBrokerContext();

  // Auth hook pour l'utilisateur connecté
  const { user, loading: authLoading } = useAuth();
  
  // États pour les activités
  const [activities, setActivities] = useState<Activity[]>([]);
  const [filteredActivities, setFilteredActivities] = useState<Activity[]>([]);
  const [activitiesLoading, setActivitiesLoading] = useState(false);

  // ID du profil apporteur de l'utilisateur connecté
  const [userId, setUserId] = useState<string>('');

  // États pour les filtres
  const [sortBy, setSortBy] = useState<'date' | 'type'>('date');
  const [filterType, setFilterType] = useState<'all' | 'success' | 'info' | 'warning' | 'error'>('all');
  const [showUnreadOnly, setShowUnreadOnly] = useState(false);

  // États pour la pagination
  const [currentPage, setCurrentPage] = useState(1);

  // Données paginées
  const totalPages = Math.ceil(filteredActivities.length / ITEMS_PER_PAGE);
  const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
  const endIndex = startIndex + ITEMS_PER_PAGE;
  const paginatedItems = filteredActivities.slice(startIndex, endIndex);

  // Réinitialiser la page quand les filtres changent
  useEffect(() => {
    setCurrentPage(1);
  }, [sortBy, filterType, showUnreadOnly]);

  // Fonction pour changer de page
  const handlePageChange = (page: number) => {
    setCurrentPage(page);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // Générer les numéros de pages à afficher
  const getPageNumbers = () => {
    const pages: (number | string)[] = [];
    const maxVisiblePages = 5;

    if (totalPages <= maxVisiblePages) {
      for (let i = 1; i <= totalPages; i++) pages.push(i);
    } else {
      if (currentPage <= 3) {
        for (let i = 1; i <= 4; i++) pages.push(i);
        pages.push('...');
        pages.push(totalPages);
      } else if (currentPage >= totalPages - 2) {
        pages.push(1);
        pages.push('...');
        for (let i = totalPages - 3; i <= totalPages; i++) pages.push(i);
      } else {
        pages.push(1);
        pages.push('...');
        for (let i = currentPage - 1; i <= currentPage + 1; i++) pages.push(i);
        pages.push('...');
        pages.push(totalPages);
      }
    }
    return pages;
  };

  // Fonction pour formater les activités pour l'affichage
  const formatActivityForDisplay = (activity: any): Activity => {
    const activityData = activity.activity_data || {};

    // Déterminer le type et l'icône selon le type d'activité
    let type: 'success' | 'info' | 'warning' | 'error' = 'info';
    let icon = 'ri-file-line';
    let amount = '';
    let status = '';

    switch (activity.activity_type) {
      case 'dossier_created':
        type = 'info';
        icon = 'ri-file-add-line';
        status = 'Nouveau dossier';
        break;

      case 'dossier_attribue':
        type = 'info';
        icon = 'ri-user-received-line';
        status = 'Attribué par l\'admin';
        break;

      case 'devis_envoye':
        type = 'info';
        icon = 'ri-send-plane-line';
        status = 'Devis envoyé au client';
        break;

      case 'devis_accepte':
        type = 'success';
        icon = 'ri-check-double-line';
        amount = activityData.economie_generee ? `Économie : ${Number(activityData.economie_generee).toLocaleString()}€` : '';
        status = 'Devis accepté';
        break;

      case 'dossier_finalise':
        type = 'success';
        icon = 'ri-checkbox-circle-line';
        amount = activityData.economie_generee ? `Économie : ${Number(activityData.economie_generee).toLocaleString()}€` : '';
        status = 'Dossier finalisé';
        break;

      case 'dossier_supprime':
        type = 'error';
        icon = 'ri-delete-bin-line';
        status = 'Supprimé par l\'admin';
        break;

      case 'classement_updated':
        type = 'warning';
        icon = 'ri-trophy-line';
        status = 'Performance mise à jour';
        break;

      default:
        type = 'info';
        icon = 'ri-file-line';
        status = 'Activité';
    }

    return {
      ...activity,
      type,
      icon,
      amount,
      status,
      time: formatTimeAgo(activity.created_at),
      client_name: activityData.client_nom && activityData.client_prenom
        ? `${activityData.client_prenom} ${activityData.client_nom}`
        : undefined,
      dossier_number: activityData.numero_dossier
    };
  };

  // Fonctions existantes
  const fetchActivities = async () => {
    if (!userId) return;

    setActivitiesLoading(true);
    try {
      const data = await ActivitiesService.getActivitiesByUserId(userId);

      // Formater et fusionner avec le cache local
      const formatted = data?.map(activity => {
        const formatted = formatActivityForDisplay(activity);
        // Priorité au cache local
        const cachedStatus = ActivityReadStatusCache.getReadStatus(activity.id);
        const finalIsRead = cachedStatus !== null ? cachedStatus : activity.is_read;

        return {
          ...formatted,
          is_read: finalIsRead
        };
      }) || [];

      setActivities(formatted);
      applyFiltersAndSort(formatted);
    } catch (error) {
      console.error('Erreur lors du chargement des activités:', error);
    } finally {
      setActivitiesLoading(false);
    }
  };

  const markActivityAsRead = (activityId: string) => {
    // Mise à jour optimiste immédiate
    setActivities(prev => prev.map(a => a.id === activityId ? { ...a, is_read: true } : a));
    setFilteredActivities(prev => prev.map(a => a.id === activityId ? { ...a, is_read: true } : a));

    // Ajouter au cache pour synchronisation en arrière-plan
    ActivityReadStatusCache.markAsReadOptimistic(activityId);
  };

  const deleteActivity = async (activityId: string) => {
    try {
      await ActivitiesService.deleteActivity(activityId);
      setActivities(prev => prev.filter(a => a.id !== activityId));
      setFilteredActivities(prev => prev.filter(a => a.id !== activityId));
    } catch (error) {
      console.error("Erreur lors de la suppression de l'activité:", error);
    }
  };

  // Fonction pour gérer le clic sur une activité
  const handleActivityClick = (activity: Activity) => {
    // Naviguer vers le dossier si disponible
    if (activity.dossier_id) {
      router.push(`/dossier/${activity.dossier_id}`);
    }
  };

  const applyFiltersAndSort = (source: Activity[] = activities) => {
    let filtered = [...source];
    if (filterType !== 'all') {
      filtered = filtered.filter(item => item.type === filterType);
    }
    if (showUnreadOnly) {
      filtered = filtered.filter(item => !item.is_read);
    }
    filtered.sort((a, b) => {
      if (sortBy === 'date') {
        return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
      } else {
        return (a.type || '').localeCompare(b.type || '');
      }
    });
    setFilteredActivities(filtered);
  };

  const formatTimeAgo = (dateString: string): string => {
    const now = new Date();
    const date = new Date(dateString);
    const diff = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));
    if (diff < 60) return `Il y a ${diff}min`;
    if (diff < 1440) return `Il y a ${Math.floor(diff / 60)}h`;
    if (diff < 2880) return 'Hier';
    return `${Math.floor(diff / 1440)} jours`;
  };

  const getItemStyles = (type: string) => {
    switch (type) {
      case 'success':
        return { bg: 'bg-green-50 dark:bg-green-900/20', icon: 'text-green-600 dark:text-green-400', border: 'border-green-200 dark:border-green-700' };
      case 'warning':
        return { bg: 'bg-amber-50 dark:bg-amber-900/20', icon: 'text-amber-600 dark:text-amber-400', border: 'border-amber-200 dark:border-amber-700' };
      case 'info':
        return { bg: 'bg-[#335FAD]/5 dark:bg-[#335FAD]/20', icon: 'text-[#335FAD] dark:text-[#335FAD]', border: 'border-[#335FAD]/20 dark:border-[#335FAD]/70' };
      case 'error':
        return { bg: 'bg-red-50 dark:bg-red-900/20', icon: 'text-red-600 dark:text-red-400', border: 'border-red-200 dark:border-red-700' };
      default:
        return { bg: 'bg-gray-50 dark:bg-gray-700', icon: 'text-gray-600 dark:text-gray-400', border: 'border-gray-200 dark:border-gray-600' };
    }
  };

  // UseEffects
  // ✅ Le dark mode est géré par le hook useTheme - pas besoin d'initialisation manuelle

  useEffect(() => {
    const initUser = async () => {
      try {
        // Récupérer le profil apporteur de l'utilisateur connecté
        const apporteur = await api.getCurrentApporteurProfile();
        if (apporteur) {
          setUserId(apporteur.id);
        }
      } catch (error) {
        console.error('Erreur lors de la récupération de l\'utilisateur:', error);
      }
    };

    if (isInitialized && !authLoading && user) {
      initUser();
    }
  }, [isInitialized, authLoading, user]);

  useEffect(() => {
    if (userId) {
      fetchActivities();
    }
  }, [userId]);

  useEffect(() => {
    applyFiltersAndSort();
  }, [sortBy, filterType, showUnreadOnly]);

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      {/* Header */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40">
        <div className="px-4 sm:px-8 py-4 sm:py-6">
          <div className="flex items-center space-x-4">
            <button
              onClick={() => router.back()}
              className="w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg flex items-center justify-center transition-colors cursor-pointer"
            >
              <i className="ri-arrow-left-line text-gray-600 dark:text-gray-300"></i>
            </button>
            <div>
              <h1 className="text-xl sm:text-2xl font-medium text-gray-900 dark:text-white">
                Activités
              </h1>
              <p className="text-sm text-gray-500 dark:text-gray-400">
                Historique de vos actions
              </p>
            </div>
          </div>
        </div>
      </div>

      <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-7xl mx-auto">
        {/* Filtres et contrôles */}
        <div className="mb-6 bg-white dark:bg-gray-800 rounded-2xl p-4 border border-gray-200 dark:border-gray-700">
          <div className="flex flex-col sm:flex-row gap-4">
            {/* Tri */}
            <div className="flex items-center space-x-2">
              <label className="text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap">Trier par:</label>
              <Select value={sortBy} onValueChange={(v) => setSortBy(v as 'date' | 'type')}>
                <SelectTrigger className="w-[160px]">
                  <SelectValue placeholder="Trier par" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="date">Date</SelectItem>
                  <SelectItem value="type">Type</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Filtre par type */}
            <div className="flex items-center space-x-2">
              <label className="text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap">Type:</label>
              <Select value={filterType} onValueChange={(v) => setFilterType(v as any)}>
                <SelectTrigger className="w-[160px]">
                  <SelectValue placeholder="Type" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Tous</SelectItem>
                  <SelectItem value="success">Succès</SelectItem>
                  <SelectItem value="info">Info</SelectItem>
                  <SelectItem value="warning">Attention</SelectItem>
                  <SelectItem value="error">Erreur</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Filtre non lus */}
            <div className="flex items-center space-x-2">
              <input
                type="checkbox"
                id="unread-only"
                checked={showUnreadOnly}
                onChange={e => setShowUnreadOnly(e.target.checked)}
                className="w-4 h-4 text-indigo-600 bg-gray-100 border-gray-300 rounded cursor-pointer"
              />
              <label htmlFor="unread-only" className="text-sm text-gray-600 dark:text-gray-400 cursor-pointer whitespace-nowrap">
                Non lus uniquement
              </label>
            </div>

            {/* Actualiser */}
            <button
              onClick={() => fetchActivities()}
              className="flex items-center px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg text-sm transition-colors cursor-pointer whitespace-nowrap"
            >
              <i className="ri-refresh-line mr-2"></i>
              Actualiser
            </button>
          </div>
        </div>

        {/* Liste des activités */}
        <div className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700">
          {activitiesLoading ? (
            <div className="flex items-center justify-center py-12">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 dark:border-indigo-400"></div>
            </div>
          ) : paginatedItems.length === 0 ? (
            <EmptyState
              icon="ri-time-line"
              title="Aucune activité"
              description={filterType !== 'all' 
                ? "Aucune activité ne correspond à ce filtre. Essayez un autre type d'activité."
                : "Votre historique d'activité est vide pour le moment. Les actions sur vos dossiers apparaîtront ici."
              }
              variant="compact"
            />
          ) : (
            <div className="divide-y divide-gray-200 dark:divide-gray-700">
              {paginatedItems.map(item => {
                const styles = getItemStyles(item.type || 'info');
                return (
                  <div
                    key={item.id}
                    onClick={() => handleActivityClick(item)}
                    onMouseEnter={() => !item.is_read && markActivityAsRead(item.id)}
                    className="p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer"
                  >
                    <div className="flex items-start space-x-4">
                      {/* Icon */}
                      <div className={`w-12 h-12 ${styles.bg} ${styles.border} border rounded-xl flex items-center justify-center flex-shrink-0`}>
                        <i className={`${item.icon} ${styles.icon} text-lg`}></i>
                      </div>

                      {/* Content */}
                      <div className="flex-1 min-w-0">
                        <div className="flex items-start justify-between gap-4">
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center space-x-2 mb-1">
                              <h3 className={`font-medium text-gray-900 dark:text-white ${!item.is_read ? 'font-semibold' : ''}`}>
                                {item.activity_title}
                              </h3>
                              {!item.is_read && <span className="w-2 h-2 bg-indigo-500 rounded-full"></span>}
                            </div>
                            <p className="text-gray-600 dark:text-gray-400 text-sm mb-2">
                              {item.activity_description}
                            </p>

                            {/* Métadonnées */}
                            <div className="flex flex-wrap items-center gap-3 text-xs text-gray-500 dark:text-gray-400">
                              <span>{item.time}</span>
                              {item.dossier_number && (
                                <span className="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded-full">
                                  #{item.dossier_number}
                                </span>
                              )}
                              {item.amount && (
                                <span className="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-full">
                                  {item.amount}
                                </span>
                              )}
                              {item.status && (
                                <span className="px-2 py-1 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD] rounded-full">
                                  {item.status}
                                </span>
                              )}
                            </div>
                          </div>

                          {/* Actions */}
                          <div className="flex items-center space-x-2 flex-shrink-0">
                            {!item.is_read && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  markActivityAsRead(item.id);
                                }}
                                className="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 cursor-pointer"
                                title="Marquer comme lu"
                              >
                                <i className="ri-check-line text-sm"></i>
                              </button>
                            )}

                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                deleteActivity(item.id);
                              }}
                              className="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-600 dark:hover:text-red-400 cursor-pointer"
                              title="Supprimer"
                            >
                              <i className="ri-delete-bin-line text-sm"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>

        {/* Pagination */}
        {totalPages > 1 && (
          <div className="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4">
            {/* Info pagination */}
            <div className="text-sm text-gray-500 dark:text-gray-400">
              Affichage de {startIndex + 1} à {Math.min(endIndex, filteredActivities.length)} sur {filteredActivities.length} éléments
            </div>

            {/* Contrôles pagination */}
            <div className="flex items-center space-x-2">
              {/* Bouton Précédent */}
              <button
                onClick={() => handlePageChange(currentPage - 1)}
                disabled={currentPage === 1}
                className="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
              >
                <i className="ri-arrow-left-line"></i>
              </button>

              {/* Numéros de page */}
              {getPageNumbers().map((page, idx) => (
                <button
                  key={idx}
                  onClick={() => typeof page === 'number' ? handlePageChange(page) : null}
                  disabled={page === '...'}
                  className={`px-3 py-2 text-sm border rounded-lg cursor-pointer ${page === currentPage
                    ? 'bg-indigo-600 border-indigo-600 text-white'
                    : page === '...'
                      ? 'border-transparent text-gray-400 dark:text-gray-500 cursor-default'
                      : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'
                    }`}
                >
                  {page}
                </button>
              ))}

              {/* Bouton Suivant */}
              <button
                onClick={() => handlePageChange(currentPage + 1)}
                disabled={currentPage === totalPages}
                className="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
              >
                <i className="ri-arrow-right-line"></i>
              </button>
            </div>
          </div>
        )}

        {/* Stats en bas (si pas de pagination) */}
        {totalPages <= 1 && filteredActivities.length > 0 && (
          <div className="mt-6 flex justify-between items-center text-sm text-gray-500 dark:text-gray-400">
            <span>
              {filteredActivities.length} activité{filteredActivities.length > 1 ? 's' : ''}
              {showUnreadOnly ? ' non lue' + (filteredActivities.length > 1 ? 's' : '') : ''}
            </span>
            <span>
              {activities.filter(a => !a.is_read).length} non lue{activities.filter(a => !a.is_read).length > 1 ? 's' : ''}
            </span>
          </div>
        )}
      </main>
    </div>
  );
}

================
File: app/admin/activites/page.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useRouter } from 'next/navigation';
import AdminHeader from '@/components/AdminHeader';
import { ActivitiesService } from '@/lib/services/activities';
import { ApporteursService } from '@/lib/services/apporteurs';
import { ActivityReadStatusCache } from '@/lib/services/activity-read-status-cache';
import { EmptyState } from '@/components/ui/empty-state';

// Interface pour les activités admin
interface Activity {
  id: string;
  user_id: string;
  activity_type: string;
  activity_title: string;
  activity_description: string;
  activity_data?: any;
  created_at: string;
  is_read: boolean;
  dossier_id?: string;
  // Données depuis activities_view
  apporteur_nom?: string;
  apporteur_prenom?: string;
  client_nom?: string;
  client_prenom?: string;
  numero_dossier?: string;
  economie_generee?: number;
  montant_capital?: number;
  // Propriétés formatées
  type?: 'success' | 'info' | 'warning' | 'error';
  icon?: string;
  amount?: string;
  status?: string;
  time?: string;
}

interface Apporteur {
  id: string;
  nom: string;
  prenom: string;
}

const ITEMS_PER_PAGE = 20;

export default function AdminActivitesPage() {
  const router = useRouter();
  const [darkMode, setDarkMode] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);
  
  // États pour les activités
  const [activities, setActivities] = useState<Activity[]>([]);
  const [filteredActivities, setFilteredActivities] = useState<Activity[]>([]);
  const [activitiesLoading, setActivitiesLoading] = useState(false);
  
  // Liste des apporteurs pour le filtre
  const [apporteurs, setApporteurs] = useState<Apporteur[]>([]);
  
  // États pour les filtres
  const [sortBy, setSortBy] = useState<'date' | 'type'>('date');
  const [filterType, setFilterType] = useState<'all' | 'success' | 'info' | 'warning' | 'error'>('all');
  const [filterApporteur, setFilterApporteur] = useState<string>('all');
  const [showUnreadOnly, setShowUnreadOnly] = useState(false);

  // États pour la pagination
  const [currentPage, setCurrentPage] = useState(1);

  // Mock admin data
  const adminData = {
    id: 'admin1',
    firstName: 'Alexandre',
    lastName: 'Martin',
    initials: 'AM',
    role: 'Administrateur'
  };

  // Données paginées
  const totalPages = Math.ceil(filteredActivities.length / ITEMS_PER_PAGE);
  const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
  const endIndex = startIndex + ITEMS_PER_PAGE;
  const paginatedItems = filteredActivities.slice(startIndex, endIndex);

  // Réinitialiser la page quand les filtres changent
  useEffect(() => {
    setCurrentPage(1);
  }, [sortBy, filterType, filterApporteur, showUnreadOnly]);

  // Fonction pour changer de page
  const handlePageChange = (page: number) => {
    setCurrentPage(page);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // Générer les numéros de pages à afficher
  const getPageNumbers = () => {
    const pages: (number | string)[] = [];
    const maxVisiblePages = 5;
    
    if (totalPages <= maxVisiblePages) {
      for (let i = 1; i <= totalPages; i++) pages.push(i);
    } else {
      if (currentPage <= 3) {
        for (let i = 1; i <= 4; i++) pages.push(i);
        pages.push('...');
        pages.push(totalPages);
      } else if (currentPage >= totalPages - 2) {
        pages.push(1);
        pages.push('...');
        for (let i = totalPages - 3; i <= totalPages; i++) pages.push(i);
      } else {
        pages.push(1);
        pages.push('...');
        for (let i = currentPage - 1; i <= currentPage + 1; i++) pages.push(i);
        pages.push('...');
        pages.push(totalPages);
      }
    }
    return pages;
  };

  // Fonction pour formater les activités pour l'affichage
  const formatActivityForDisplay = (activity: any): Activity => {
    const activityData = activity.activity_data || {};
    
    // Déterminer le type et l'icône selon le type d'activité
    let type: 'success' | 'info' | 'warning' | 'error' = 'info';
    let icon = 'ri-file-line';
    let amount = '';
    let status = '';
    
    switch (activity.activity_type) {
      case 'dossier_created':
        type = 'info';
        icon = 'ri-file-add-line';
        status = 'Nouveau dossier';
        break;
        
      case 'devis_envoye':
        type = 'info';
        icon = 'ri-send-plane-line';
        status = 'Devis envoyé';
        break;
        
      case 'devis_accepte':
        type = 'success';
        icon = 'ri-check-double-line';
        amount = activity.economie_generee ? `Économie : ${Number(activity.economie_generee).toLocaleString()}€` : '';
        status = 'Devis accepté';
        break;
        
      case 'devis_refuse':
        type = 'error';
        icon = 'ri-close-circle-line';
        status = 'Devis refusé';
        break;
        
      case 'dossier_finalise':
        type = 'success';
        icon = 'ri-checkbox-circle-line';
        amount = activity.economie_generee ? `Économie : ${Number(activity.economie_generee).toLocaleString()}€` : '';
        status = 'Dossier finalisé';
        break;
        
      case 'dossier_attribue':
        type = 'info';
        icon = 'ri-user-received-line';
        status = 'Attribué';
        break;
        
      case 'dossier_supprime':
        type = 'error';
        icon = 'ri-delete-bin-line';
        status = 'Supprimé';
        break;
        
      default:
        type = 'info';
        icon = 'ri-file-line';
        status = 'Activité';
    }

    return {
      ...activity,
      type,
      icon,
      amount,
      status,
      time: formatTimeAgo(activity.created_at)
    };
  };

  // Fonctions
  const fetchActivities = async () => {
    setActivitiesLoading(true);
    try {
      const data = await ActivitiesService.getAllActivities();
      
      // Formater et fusionner avec le cache local
      const formatted = data?.map(activity => {
        const formatted = formatActivityForDisplay(activity);
        // Priorité au cache local
        const cachedStatus = ActivityReadStatusCache.getReadStatus(activity.id);
        const finalIsRead = cachedStatus !== null ? cachedStatus : activity.is_read;
        
        return {
          ...formatted,
          is_read: finalIsRead
        };
      }) || [];
      
      setActivities(formatted);
      applyFiltersAndSort(formatted);
    } catch (error) {
      console.error('Erreur lors du chargement des activités:', error);
    } finally {
      setActivitiesLoading(false);
    }
  };

  const fetchApporteurs = async () => {
    try {
      const data = await ApporteursService.getAllApporteurs();
      setApporteurs(data || []);
    } catch (error) {
      console.error('Erreur lors du chargement des apporteurs:', error);
    }
  };

  const markActivityAsRead = (activityId: string) => {
    // Mise à jour optimiste immédiate
    setActivities(prev => prev.map(a => a.id === activityId ? { ...a, is_read: true } : a));
    setFilteredActivities(prev => prev.map(a => a.id === activityId ? { ...a, is_read: true } : a));
    
    // Ajouter au cache pour synchronisation en arrière-plan
    ActivityReadStatusCache.markAsReadOptimistic(activityId);
  };

  const deleteActivity = async (activityId: string) => {
    try {
      await ActivitiesService.deleteActivity(activityId);
      setActivities(prev => prev.filter(a => a.id !== activityId));
      setFilteredActivities(prev => prev.filter(a => a.id !== activityId));
    } catch (error) {
      console.error("Erreur lors de la suppression de l'activité:", error);
    }
  };

  // Fonction pour gérer le clic sur une activité
  const handleActivityClick = (activity: Activity) => {
    // Naviguer vers le dossier si disponible
    if (activity.dossier_id) {
      router.push(`/admin/dossiers/${activity.dossier_id}`);
    }
  };

  const applyFiltersAndSort = (source: Activity[] = activities) => {
    let filtered = [...source];
    
    // Filtre par type
    if (filterType !== 'all') {
      filtered = filtered.filter(item => item.type === filterType);
    }
    
    // Filtre par apporteur
    if (filterApporteur !== 'all') {
      filtered = filtered.filter(item => item.user_id === filterApporteur);
    }
    
    // Filtre non lus
    if (showUnreadOnly) {
      filtered = filtered.filter(item => !item.is_read);
    }
    
    // Tri
    filtered.sort((a, b) => {
      if (sortBy === 'date') {
        return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
      } else {
        return (a.type || '').localeCompare(b.type || '');
      }
    });
    
    setFilteredActivities(filtered);
  };

  const formatTimeAgo = (dateString: string): string => {
    const now = new Date();
    const date = new Date(dateString);
    const diff = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));
    if (diff < 60) return `Il y a ${diff}min`;
    if (diff < 1440) return `Il y a ${Math.floor(diff / 60)}h`;
    if (diff < 2880) return 'Hier';
    return `${Math.floor(diff / 1440)} jours`;
  };

  const getItemStyles = (type: string) => {
    switch (type) {
      case 'success':
        return { bg: 'bg-green-50 dark:bg-green-900/20', icon: 'text-green-600 dark:text-green-400', border: 'border-green-200 dark:border-green-700' };
      case 'warning':
        return { bg: 'bg-amber-50 dark:bg-amber-900/20', icon: 'text-amber-600 dark:text-amber-400', border: 'border-amber-200 dark:border-amber-700' };
      case 'info':
        return { bg: 'bg-[#335FAD]/5 dark:bg-[#335FAD]/20', icon: 'text-[#335FAD] dark:text-[#335FAD]', border: 'border-[#335FAD]/20 dark:border-[#335FAD]/70' };
      case 'error':
        return { bg: 'bg-red-50 dark:bg-red-900/20', icon: 'text-red-600 dark:text-red-400', border: 'border-red-200 dark:border-red-700' };
      default:
        return { bg: 'bg-gray-50 dark:bg-gray-700', icon: 'text-gray-600 dark:text-gray-400', border: 'border-gray-200 dark:border-gray-600' };
    }
  };

  // UseEffects
  useEffect(() => {
    if (typeof window !== 'undefined' && !isInitialized) {
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      setDarkMode(savedDarkMode);
      if (savedDarkMode) document.documentElement.classList.add('dark');
      else document.documentElement.classList.remove('dark');
      setIsInitialized(true);
    }
  }, [isInitialized]);

  useEffect(() => {
    if (isInitialized) {
      fetchActivities();
      fetchApporteurs();
    }
  }, [isInitialized]);

  useEffect(() => {
    applyFiltersAndSort();
  }, [sortBy, filterType, filterApporteur, showUnreadOnly]);

  if (!isInitialized) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#335FAD]"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      <AdminHeader 
        darkMode={darkMode} 
        setDarkMode={setDarkMode}
        adminData={adminData}
      />
      
      <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <div className="flex items-center space-x-4">
            <button
              onClick={() => router.back()}
              className="w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg flex items-center justify-center transition-colors cursor-pointer"
            >
              <i className="ri-arrow-left-line text-gray-600 dark:text-gray-300"></i>
            </button>
            <div>
              <h1 className="text-xl sm:text-2xl font-medium text-gray-900 dark:text-white">
                Activités de la plateforme
              </h1>
              <p className="text-sm text-gray-500 dark:text-gray-400">
                Vue d'ensemble des activités de tous les apporteurs
              </p>
            </div>
          </div>
        </div>

        {/* Filtres et contrôles */}
        <div className="mb-6 bg-white dark:bg-gray-800 rounded-2xl p-4 border border-gray-200 dark:border-gray-700">
          <div className="flex flex-col sm:flex-row gap-4 flex-wrap">
            {/* Tri */}
            <div className="flex items-center space-x-2">
              <label className="text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap">Trier par:</label>
              <Select value={sortBy} onValueChange={(v) => setSortBy(v as 'date' | 'type')}>
                <SelectTrigger className="w-[160px]">
                  <SelectValue placeholder="Trier par" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="date">Date</SelectItem>
                  <SelectItem value="type">Type</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Filtre par type */}
            <div className="flex items-center space-x-2">
              <label className="text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap">Type:</label>
              <Select value={filterType} onValueChange={(v) => setFilterType(v as any)}>
                <SelectTrigger className="w-[160px]">
                  <SelectValue placeholder="Type" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Tous</SelectItem>
                  <SelectItem value="success">Succès</SelectItem>
                  <SelectItem value="info">Info</SelectItem>
                  <SelectItem value="warning">Attention</SelectItem>
                  <SelectItem value="error">Erreur</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Filtre par apporteur */}
            <div className="flex items-center space-x-2">
              <label className="text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap">Apporteur:</label>
              <Select value={filterApporteur} onValueChange={(v) => setFilterApporteur(v)}>
                <SelectTrigger className="w-[180px]">
                  <SelectValue placeholder="Tous les apporteurs" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Tous</SelectItem>
                  {apporteurs.map(app => (
                    <SelectItem key={app.id} value={app.id}>
                      {app.prenom} {app.nom}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Filtre non lus */}
            <div className="flex items-center space-x-2">
              <input
                type="checkbox"
                id="unread-only"
                checked={showUnreadOnly}
                onChange={e => setShowUnreadOnly(e.target.checked)}
                className="w-4 h-4 text-[#335FAD] bg-gray-100 border-gray-300 rounded cursor-pointer"
              />
              <label htmlFor="unread-only" className="text-sm text-gray-600 dark:text-gray-400 cursor-pointer whitespace-nowrap">
                Non lus uniquement
              </label>
            </div>

            {/* Actualiser */}
            <button
              onClick={() => fetchActivities()}
              className="flex items-center px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg text-sm transition-colors cursor-pointer whitespace-nowrap"
            >
              <i className="ri-refresh-line mr-2"></i>
              Actualiser
            </button>
          </div>
        </div>

        {/* Liste des activités */}
        <div className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700">
          {activitiesLoading ? (
            <div className="flex items-center justify-center py-12">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#335FAD] dark:border-[#335FAD]"></div>
            </div>
          ) : paginatedItems.length === 0 ? (
            <EmptyState
              icon="ri-history-line"
              title="Aucune activité"
              description={filterType !== 'all' || filterApporteur
                ? "Aucune activité ne correspond à ces filtres. Essayez de modifier vos critères."
                : "L'historique des activités est vide. Les actions de vos apporteurs apparaîtront ici."
              }
              variant="compact"
            />
          ) : (
            <div className="divide-y divide-gray-200 dark:divide-gray-700">
              {paginatedItems.map(item => {
                const styles = getItemStyles(item.type || 'info');
                return (
                  <div 
                    key={item.id} 
                    onClick={() => handleActivityClick(item)}
                    onMouseEnter={() => !item.is_read && markActivityAsRead(item.id)}
                    className="p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer"
                  >
                    <div className="flex items-start space-x-4">
                      {/* Icon */}
                      <div className={`w-12 h-12 ${styles.bg} ${styles.border} border rounded-xl flex items-center justify-center flex-shrink-0`}>
                        <i className={`${item.icon} ${styles.icon} text-lg`}></i>
                      </div>

                      {/* Content */}
                      <div className="flex-1 min-w-0">
                        <div className="flex items-start justify-between gap-4">
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center space-x-2 mb-1">
                              <h3 className={`font-medium text-gray-900 dark:text-white ${!item.is_read ? 'font-semibold' : ''}`}>
                                {item.activity_title}
                              </h3>
                              {!item.is_read && <span className="w-2 h-2 bg-[#335FAD] rounded-full"></span>}
                            </div>
                            <p className="text-gray-600 dark:text-gray-400 text-sm mb-2">
                              {item.activity_description}
                            </p>
                            
                            {/* Métadonnées */}
                            <div className="flex flex-wrap items-center gap-3 text-xs text-gray-500 dark:text-gray-400">
                              <span>{item.time}</span>
                              {item.apporteur_nom && item.apporteur_prenom && (
                                <span className="px-2 py-1 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD] rounded-full">
                                  {item.apporteur_prenom} {item.apporteur_nom}
                                </span>
                              )}
                              {item.numero_dossier && (
                                <span className="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded-full">
                                  #{item.numero_dossier}
                                </span>
                              )}
                              {item.client_nom && item.client_prenom && (
                                <span className="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded-full">
                                  {item.client_prenom} {item.client_nom}
                                </span>
                              )}
                              {item.amount && (
                                <span className="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-full">
                                  {item.amount}
                                </span>
                              )}
                            </div>
                          </div>

                          {/* Actions */}
                          <div className="flex items-center space-x-2 flex-shrink-0">
                            {!item.is_read && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  markActivityAsRead(item.id);
                                }}
                                className="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-[#335FAD] dark:hover:text-[#335FAD] cursor-pointer"
                                title="Marquer comme lu"
                              >
                                <i className="ri-check-line text-sm"></i>
                              </button>
                            )}
                            
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                deleteActivity(item.id);
                              }}
                              className="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-600 dark:hover:text-red-400 cursor-pointer"
                              title="Supprimer"
                            >
                              <i className="ri-delete-bin-line text-sm"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>

        {/* Pagination */}
        {totalPages > 1 && (
          <div className="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4">
            {/* Info pagination */}
            <div className="text-sm text-gray-500 dark:text-gray-400">
              Affichage de {startIndex + 1} à {Math.min(endIndex, filteredActivities.length)} sur {filteredActivities.length} éléments
            </div>

            {/* Contrôles pagination */}
            <div className="flex items-center space-x-2">
              {/* Bouton Précédent */}
              <button
                onClick={() => handlePageChange(currentPage - 1)}
                disabled={currentPage === 1}
                className="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
              >
                <i className="ri-arrow-left-line"></i>
              </button>

              {/* Numéros de page */}
              {getPageNumbers().map((page, idx) => (
                <button
                  key={idx}
                  onClick={() => typeof page === 'number' ? handlePageChange(page) : null}
                  disabled={page === '...'}
                  className={`px-3 py-2 text-sm border rounded-lg cursor-pointer ${
                    page === currentPage
                      ? 'bg-[#335FAD] border-[#335FAD] text-white'
                      : page === '...'
                      ? 'border-transparent text-gray-400 dark:text-gray-500 cursor-default'
                      : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'
                  }`}
                >
                  {page}
                </button>
              ))}

              {/* Bouton Suivant */}
              <button
                onClick={() => handlePageChange(currentPage + 1)}
                disabled={currentPage === totalPages}
                className="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
              >
                <i className="ri-arrow-right-line"></i>
              </button>
            </div>
          </div>
        )}

        {/* Stats en bas (si pas de pagination) */}
        {totalPages <= 1 && filteredActivities.length > 0 && (
          <div className="mt-6 flex justify-between items-center text-sm text-gray-500 dark:text-gray-400">
            <span>
              {filteredActivities.length} activité{filteredActivities.length > 1 ? 's' : ''} 
              {showUnreadOnly ? ' non lue' + (filteredActivities.length > 1 ? 's' : '') : ''}
            </span>
            <span>
              {activities.filter(a => !a.is_read).length} non lue{activities.filter(a => !a.is_read).length > 1 ? 's' : ''}
            </span>
          </div>
        )}
      </main>
    </div>
  );
}

================
File: app/admin/apporteurs/[id]/ApporteurDetailContent.tsx
================
'use client';

import { useState, useEffect, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { ApporteursService } from '@/lib/services/apporteurs';
import { mapStatutForDisplay, getStatutBadgeConfig } from '@/lib/utils/statut-mapping';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { getApporteurBadgeConfig } from '@/lib/utils/apporteur-badges';

// ============================================================================
// INTERFACES POUR L'INTÉGRATION SUPABASE
// ============================================================================

// Interface pour les données d'un apporteur - Table 'apporteur_profiles'
interface ApporteurProfile {
  id: string;
  user_id: string;
  nom: string;
  prenom: string;
  email: string;
  telephone: string;
  // Inscription et statut
  date_inscription: string;
  statut: 'actif' | 'inactif' | 'suspendu' | 'en_attente' | 'refuse';
  // Données calculées
  nb_dossiers_traites: number;
  nb_dossiers_en_cours: number;
  nb_dossiers_valides: number;
  economies_generees: number;
  taux_conversion: number;
  // Métadonnées
  created_at: string;
  updated_at: string;
  last_login: string;
}

// Interface pour les statistiques détaillées d'un apporteur
interface ApporteurStatistics {
  // Performance mensuelle
  performance_mensuelle: {
    mois: string;
    dossiers_traites: number;
    dossiers_valides: number;
    economies_generees: number;
    ca_gmb: number;
  }[];
  // Répartition par type de dossier
  repartition_types: {
    type: string;
    nombre: number;
    pourcentage: number;
  }[];
  // Clients récents
  clients_recents: {
    id: string;
    nom: string;
    prenom: string;
    date_soumission: string;
    statut: string;
    economie: number;
    montant_capital: number;
    is_couple: boolean;
  }[];
}

// Interface pour un dossier dans la modale mensuelle
interface DossierMensuel {
  id: string;
  numero: string;
  client_nom: string;
  client_prenom: string;
  date_soumission: string;
  statut: 'nouveau' | 'devis_envoye' | 'valide' | 'refuse' | 'finalise';
  montant_capital: number;
  economie_generee: number;
  ca_gmb: number;
  type_assurance: string;
  is_couple: boolean;
}

interface ApporteurDetailContentProps {
  apporteurId: string;
}

export default function ApporteurDetailContent({ apporteurId }: ApporteurDetailContentProps) {
  const router = useRouter();
  const [apporteur, setApporteur] = useState<ApporteurProfile | null>(null);
  const [statistics, setStatistics] = useState<ApporteurStatistics | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('overview');
  const [showContactModal, setShowContactModal] = useState(false);
  const [showSuspendModal, setShowSuspendModal] = useState(false);
  const [showReactivateModal, setShowReactivateModal] = useState(false);
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [suspendReason, setSuspendReason] = useState('');
  const [contactMessage, setContactMessage] = useState('');
  const [contactSubject, setContactSubject] = useState(''); // NOUVEAU: Champ objet du contact

  // Nouveaux états pour les filtres de performance
  const [performancePeriod, setPerformancePeriod] = useState<'6mois' | '12mois' | '24mois' | 'tout'>('12mois');
  const [showMonthModal, setShowMonthModal] = useState(false);
  const [selectedMonth, setSelectedMonth] = useState<string | null>(null);
  const [monthlyDossiers, setMonthlyDossiers] = useState<DossierMensuel[]>([]);
  const [loadingMonthlyData, setLoadingMonthlyData] = useState(false);


  // ============================================================================
  // SUPABASE INTEGRATION - RÉCUPÉRATION DES DONNÉES APPORTEUR
  // ============================================================================

  /**
   * FONCTION DE RÉCUPÉRATION COMPLÈTE DES DONNÉES APPORTEUR
   * 
   * Cette fonction doit récupérer depuis Supabase :
   * 1. Les informations du profil apporteur
   * 2. Les statistiques calculées (nombre de dossiers, économies, etc.)
   * 3. L'historique de performance
   * 
   * Requête SQL principale :
   * ```sql
   * SELECT 
   *   ap.*,
   *   COUNT(d.id) as nb_dossiers_traites,
   *   COUNT(CASE WHEN d.status = 'valide' THEN 1 END) as nb_dossiers_valides,
   *   COUNT(CASE WHEN d.status IN ('nouveau', 'devis_envoye', 'analyse') THEN 1 END) as nb_dossiers_en_cours,
   *   COALESCE(SUM(CASE WHEN d.status = 'valide' THEN d.economie_client END), 0) as economies_generees,
   *   COALESCE(SUM(CASE WHEN d.status = 'finalise' THEN d.ca_gmb END), 0) as ca_total_gmb,
   *   CASE 
   *     WHEN COUNT(d.id) > 0 THEN 
   *       ROUND((COUNT(CASE WHEN d.status = 'valide' THEN 1 END)::float / COUNT(d.id) * 100), 2)
   *     ELSE 0 
   *   END as taux_conversion
   * FROM apporteur_profiles ap
   * LEFT JOIN dossiers d ON d.apporteur_id = ap.user_id
   * WHERE ap.user_id = $1
   * GROUP BY ap.id
   * ```
   */
  const fetchApporteurComplet = async () => {
    try {
      setIsLoading(true);
      
      // 1. Récupérer les données de base de l'apporteur
      const apporteurData = await ApporteursService.getApporteurById(apporteurId);
      
      // 2. Récupérer les statistiques calculées (méthode centralisée)
      const stats = await ApporteursService.getApporteurStats(apporteurId);
      
      // 3. Récupérer la performance mensuelle (24 mois)
      const monthlyPerformance = await ApporteursService.getMonthlyPerformance(apporteurId, 24);
      
      // Mapper les données pour correspondre à l'interface ApporteurProfile
      const mappedApporteur: ApporteurProfile = {
        id: apporteurData.id,
        user_id: apporteurData.user_id || apporteurData.id,
        nom: apporteurData.nom,
        prenom: apporteurData.prenom,
        email: apporteurData.email,
        telephone: apporteurData.telephone || 'Non renseigné',
        date_inscription: apporteurData.created_at,
        statut: apporteurData.statut,
        nb_dossiers_traites: stats.totalDossiers,
        nb_dossiers_en_cours: stats.totalDossiers - stats.dossiersValides,
        nb_dossiers_valides: stats.dossiersValides,
        economies_generees: stats.economiesGenerees,
        taux_conversion: stats.tauxConversion,
        created_at: apporteurData.created_at,
        updated_at: apporteurData.updated_at,
        last_login: apporteurData.last_login_at || apporteurData.updated_at
      };

      // Extraire les dossiers récents depuis apporteurData.dossiers
      const dossiers = apporteurData.dossiers || [];
      const dossiersRecents = dossiers
        .sort((a: any, b: any) => new Date(b.date_creation).getTime() - new Date(a.date_creation).getTime())
        .slice(0, 5) // Garder les 5 plus récents
        .map((d: any) => ({
          id: d.id,
          nom: d.client_infos?.[0]?.client_nom || 'N/A',
          prenom: d.client_infos?.[0]?.client_prenom || 'N/A',
          date_soumission: d.date_creation,
          statut: d.statut || 'en_attente',
          economie: Number(d.economie_generee || 0),
          montant_capital: Number(d.pret_data?.[0]?.montant_capital || 0),
          is_couple: d.is_couple || false
        }));

      // Mapper les statistiques
      const mappedStatistics: ApporteurStatistics = {
        performance_mensuelle: monthlyPerformance.map((m: any) => ({
          mois: m.month,
          dossiers_traites: m.dossiers_traites,
          dossiers_valides: m.dossiers_valides,
          economies_generees: m.economies_generees,
          ca_gmb: 0 // TODO: À calculer une fois système commission implémenté
        })),
        repartition_types: [], // TODO: À implémenter si nécessaire
        clients_recents: dossiersRecents
      };

      setApporteur(mappedApporteur);
      setStatistics(mappedStatistics);
      
    } catch (error: any) {
      console.error('Erreur lors du chargement des données apporteur:', error);
      alert(`Erreur: ${error.message || 'Impossible de charger les données de l\'apporteur'}`);
    } finally {
      setIsLoading(false);
    }
  };

  // Fonction pour récupérer les dossiers d'un mois spécifique
  const fetchMonthlyDossiers = async (monthStr: string) => {
    setLoadingMonthlyData(true);
    try {
      // Si pas d'apporteur chargé, return
      if (!apporteur) {
        setMonthlyDossiers([]);
        return;
      }

      // Récupérer les dossiers du mois depuis les données déjà fetch dans apporteurData
      const apporteurData = await ApporteursService.getApporteurById(apporteurId);
      const allDossiers = apporteurData.dossiers || [];
      
      const filtered = allDossiers.filter((d: any) => {
        const dossierDate = new Date(d.date_creation);
        const dossierMonth = dossierDate.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' });
        return dossierMonth === monthStr;
      });

      // Mapper vers DossierMensuel
      const mapped: DossierMensuel[] = filtered.map((d: any) => ({
        id: d.id,
        numero: d.numero_dossier || 'N/A',
        client_nom: d.client_infos?.[0]?.client_nom || 'N/A',
        client_prenom: d.client_infos?.[0]?.client_prenom || 'N/A',
        date_soumission: d.date_creation,
        statut: d.statut || 'nouveau' as any,
        montant_capital: Number(d.pret_data?.[0]?.montant_capital || 0),
        economie_generee: Number(d.economie_generee || 0),
        ca_gmb: 0, // TODO: À calculer une fois système commission implémenté
        type_assurance: d.pret_data?.[0]?.type_pret || d.type_dossier || 'N/A',
        is_couple: d.is_couple || false
      }));

      setMonthlyDossiers(mapped);
    } catch (error) {
      console.error('Erreur lors du chargement des dossiers mensuels:', error);
      setMonthlyDossiers([]);
    } finally {
      setLoadingMonthlyData(false);
    }
  };

  // Fonction pour ouvrir la modale d'un mois
  const handleMonthClick = (month: string) => {
    setSelectedMonth(month);
    setShowMonthModal(true);
    fetchMonthlyDossiers(month);
  };

  // Fonction pour naviguer vers un dossier
  const handleDossierClick = (dossierId: string) => {
    router.push(`/admin/dossiers/${dossierId}`);
    setShowMonthModal(false);
  };

  // Fonction pour naviguer vers un dossier récent
  const handleClientRecentClick = (clientId: string) => {
    router.push(`/admin/dossiers/${clientId}`);
  };

  // Filtre les données de performance selon la période sélectionnée
  const getFilteredPerformanceData = () => {
    if (!statistics?.performance_mensuelle) return [];
    
    const dataCount = {
      '6mois': 6,
      '12mois': 12,
      '24mois': 24,
      'tout': statistics.performance_mensuelle.length
    };
    
    return statistics.performance_mensuelle.slice(0, dataCount[performancePeriod]);
  };

  useEffect(() => {
    if (apporteurId) {
      fetchApporteurComplet();
    }
  }, [apporteurId]);

  // Empêcher le scroll du background quand la modale est ouverte
  useEffect(() => {
    if (showMonthModal || showContactModal || showSuspendModal || showReactivateModal || showDeleteModal) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
    
    // Cleanup au démontage du composant
    return () => {
      document.body.style.overflow = 'unset';
    };
  }, [showMonthModal, showContactModal, showSuspendModal, showReactivateModal, showDeleteModal]);

  // ============================================================================
  // SUPABASE INTEGRATION - ACTIONS ADMINISTRATEUR
  // ============================================================================


  /**
   * FONCTION DE SUSPENSION D'UN APPORTEUR
   * 
   * Met à jour le statut de l'apporteur et l'empêche de soumettre de nouveaux dossiers
   */
  const handleSuspendApporteur = async () => {
    if (!suspendReason.trim()) {
      alert('La raison de la suspension est obligatoire.');
      return;
    }
    
    try {
      await ApporteursService.suspendApporteur(apporteurId, suspendReason.trim());
      
      // Rafraîchir les données
      await fetchApporteurComplet();
      
      setShowSuspendModal(false);
      setSuspendReason('');
      alert('Apporteur suspendu avec succès.');
    } catch (error: any) {
      console.error('Erreur lors de la suspension:', error);
      alert(`Erreur: ${error.message || 'Impossible de suspendre l\'apporteur'}`);
    }
  };

  const handleReactivateApporteur = async () => {
    try {
      await ApporteursService.reactivateApporteur(apporteurId);
      
      // Rafraîchir les données
      await fetchApporteurComplet();
      
      setShowReactivateModal(false);
      alert('Apporteur réactivé avec succès.');
    } catch (error: any) {
      console.error('Erreur lors de la réactivation:', error);
      alert(`Erreur: ${error.message || 'Impossible de réactiver l\'apporteur'}`);
    }
  };

  const handleDeleteApporteur = async () => {
    try {
      await ApporteursService.deleteApporteur(apporteurId);
      
      setShowDeleteModal(false);
      alert('Apporteur supprimé avec succès. Redirection...');
      
      // Rediriger vers la liste des apporteurs
      router.push('/admin/apporteurs');
    } catch (error: any) {
      console.error('Erreur lors de la suppression:', error);
      alert(`Erreur: ${error.message || 'Impossible de supprimer l\'apporteur'}`);
    }
  };

  const handleContactApporteur = async () => {
    if (!contactMessage.trim()) {
      alert('Le message ne peut pas être vide.');
      return;
    }
    
    try {
      console.log('⚠️ Fonctionnalité non implémentée: Envoi d\'email via Resend');
      console.log('À:', apporteur?.email);
      console.log('Objet:', contactSubject || 'Message de l\'administration GMB Courtage');
      console.log('Message:', contactMessage);
      
      // TODO: Implémenter l'envoi via Resend une fois intégré
      /*
      await supabase.functions.invoke('send-admin-message', {
        body: {
          to_email: apporteur.email,
          to_name: `${apporteur.prenom} ${apporteur.nom}`,
          subject: contactSubject || 'Message de l\'administration GMB Courtage',
          message: contactMessage
        }
      });
      */
      
      setShowContactModal(false);
      setContactMessage('');
      setContactSubject('');
      alert('Pour l\'instant, cette fonctionnalité affiche juste une alerte. L\'intégration avec Resend sera faite plus tard.');
    } catch (error: any) {
      console.error('Erreur lors de l\'envoi du message:', error);
      alert(`Erreur: ${error.message || 'Impossible d\'envoyer le message'}`);
    }
  };



  // ✅ Utilisation des badges centralisés depuis lib/utils/apporteur-badges.ts
  const getStatutBadge = (statut: string) => {
    const config = getApporteurBadgeConfig(statut);
    
    if (!config) {
      return (
        <span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
          Inconnu
        </span>
      );
    }
    
    return (
      <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${config.color}`}>
        <i className={`${config.icon} mr-2`}></i>
        {config.text}
      </span>
    );
  };

  /**
   * 🎯 Badge de statut - Utilise la source de vérité unique
   * @param statutCanonique - Statut canonique depuis la DB (via statut_canon)
   */
  const getDossierStatutBadge = (statutCanonique: string) => {
    // ✅ Utilise l'utilitaire centralisé pour garantir la cohérence
    const config = getStatutBadgeConfig(statutCanonique);
    
    if (!config) {
      // Fallback si statut inconnu
      return (
        <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
          <i className="ri-question-line mr-1"></i>
          Inconnu
        </span>
      );
    }
    
    const { color, text, icon } = config;
    return (
      <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${color}`}>
        <i className={`${icon} mr-1`}></i>
        {text}
      </span>
    );
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Chargement du profil...</p>
        </div>
      </div>
    );
  }

  if (!apporteur) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center max-w-md mx-auto p-8">
          <div className="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
            <i className="ri-error-warning-line text-red-600 dark:text-red-400 text-2xl"></i>
          </div>
          <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
            Apporteur introuvable
          </h3>
          <p className="text-gray-500 dark:text-gray-400 mb-6">
            Cet apporteur n'existe pas ou a été supprimé.
          </p>
          <button
            onClick={() => router.push('/admin/apporteurs')}
            className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer inline-flex items-center space-x-2"
          >
            <i className="ri-arrow-left-line"></i>
            <span>Retour aux apporteurs</span>
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      {/* Header */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="px-4 sm:px-8 py-6 max-w-7xl mx-auto">
          <div className="flex items-center space-x-4 mb-6">
            <button
              onClick={() => router.back()}
              className="w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg flex items-center justify-center transition-colors cursor-pointer"
            >
              <i className="ri-arrow-left-line text-gray-600 dark:text-gray-300"></i>
            </button>
            <div className="flex-1">
              <div className="flex items-center space-x-3 mb-2">
                <h1 className="text-2xl sm:text-3xl font-light text-gray-900 dark:text-white">
                  {apporteur.prenom} {apporteur.nom}
                </h1>
                {getStatutBadge(apporteur.statut)}
              </div>
              <div className="flex flex-col sm:flex-row sm:items-center space-y-1 sm:space-y-0 sm:space-x-4 text-sm text-gray-600 dark:text-gray-400">
                <span className="flex items-center">
                  <i className="ri-mail-line mr-1"></i>
                  {apporteur.email}
                </span>
              </div>
            </div>
          </div>

          {/* Boutons d'action responsive - Déplacés sous la description */}
          <div className="flex flex-col sm:flex-row gap-3 mb-6">
            <button
              onClick={() => setShowContactModal(true)}
              className="flex-1 sm:flex-none bg-[#335FAD]/80 hover:bg-[#335FAD]/90 dark:bg-[#335FAD]/70 dark:hover:bg-[#335FAD]/80 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer whitespace-nowrap flex items-center justify-center"
            >
              <i className="ri-mail-send-line mr-2"></i>
              Contacter
            </button>
            {apporteur.statut === 'actif' && (
              <button
                onClick={() => setShowSuspendModal(true)}
                className="flex-1 sm:flex-none bg-orange-500 hover:bg-orange-600 dark:bg-orange-400 dark:hover:bg-orange-500 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer whitespace-nowrap flex items-center justify-center"
              >
                <i className="ri-pause-line mr-2"></i>
                Suspendre
              </button>
            )}
            {apporteur.statut === 'suspendu' && (
              <button
                onClick={() => setShowReactivateModal(true)}
                className="flex-1 sm:flex-none bg-green-500 hover:bg-green-600 dark:bg-green-400 dark:hover:bg-green-500 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer whitespace-nowrap flex items-center justify-center"
              >
                <i className="ri-play-line mr-2"></i>
                Réactiver
              </button>
            )}
            <button
              onClick={() => setShowDeleteModal(true)}
              className="flex-1 sm:flex-none bg-red-500 hover:bg-red-600 dark:bg-red-400 dark:hover:bg-red-500 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer whitespace-nowrap flex items-center justify-center"
            >
              <i className="ri-delete-bin-line mr-2"></i>
              Supprimer
            </button>
          </div>

          {/* Navigation tabs */}
          <div className="border-b border-gray-200 dark:border-gray-700">
            <div className="flex space-x-8 overflow-x-auto scrollbar-hide pb-2">
              <button
                onClick={() => setActiveTab('overview')}
                className={`pb-4 px-1 border-b-2 font-medium text-sm transition-colors cursor-pointer whitespace-nowrap ${
                  activeTab === 'overview'
                    ? 'border-indigo-500 text-[#335FAD] dark:text-[#335FAD]/80'
                    : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'
                }`}
              >
                Vue d'ensemble
              </button>
              <button
                onClick={() => setActiveTab('statistics')}
                className={`pb-4 px-1 border-b-2 font-medium text-sm transition-colors cursor-pointer whitespace-nowrap ${
                  activeTab === 'statistics'
                    ? 'border-indigo-500 text-[#335FAD] dark:text-[#335FAD]/80'
                    : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'
                }`}
              >
                Statistiques
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Contenu principal */}
      <main className="px-4 sm:px-8 py-6 max-w-7xl mx-auto">
        {activeTab === 'overview' && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Statistiques principales */}
            <div className="lg:col-span-2 space-y-6">
              {/* KPIs principaux */}
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-6">
                  <div className="flex items-center justify-between">
                    <div className="min-w-0 flex-1 mr-3">
                      <p className="text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Dossiers traités</p>
                      <p className="text-xl sm:text-2xl font-light text-gray-900 dark:text-white">{apporteur.nb_dossiers_traites || 0}</p>
                    </div>
                    <div className="w-10 h-10 sm:w-12 sm:h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 rounded-full flex items-center justify-center flex-shrink-0">
                      <i className="ri-file-text-line text-[#335FAD] dark:text-[#335FAD] text-lg sm:text-xl"></i>
                    </div>
                  </div>
                </div>

                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-6">
                  <div className="flex items-center justify-between">
                    <div className="min-w-0 flex-1 mr-3">
                      <p className="text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Taux de conversion</p>
                      <p className="text-xl sm:text-2xl font-light text-gray-900 dark:text-white">{apporteur.taux_conversion || 0}%</p>
                    </div>
                    <div className="w-10 h-10 sm:w-12 sm:h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center flex-shrink-0">
                      <i className="ri-percent-line text-green-600 dark:text-green-400 text-lg sm:text-xl"></i>
                    </div>
                  </div>
                </div>

                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-6">
                  <div className="flex items-center justify-between">
                    <div className="min-w-0 flex-1 mr-3">
                      <p className="text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Économies générées</p>
                      <p className="text-xl sm:text-2xl font-light text-gray-900 dark:text-white truncate">{formatCurrency(apporteur.economies_generees || 0, { decimals: 0 })}</p>
                    </div>
                    <div className="w-10 h-10 sm:w-12 sm:h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center flex-shrink-0">
                      <i className="ri-money-euro-circle-line text-purple-600 dark:text-purple-400 text-lg sm:text-xl"></i>
                    </div>
                  </div>
                </div>

              </div>

              {/* CA Total GMB Courtage */}
              {/* TODO: Calculer le CA réel une fois que le système de rémunération/commission est implémenté */}
              {/* Pour l'instant, on affiche N/A car le calcul nécessite les données de commission par dossier */}
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                  Chiffre d'affaires généré pour GMB Courtage
                </h3>
                <div className="flex items-center space-x-4">
                  <div className="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center">
                    <i className="ri-money-dollar-circle-line text-[#335FAD] dark:text-[#335FAD]/80 text-2xl"></i>
                  </div>
                  <div>
                    <p className="text-3xl font-light text-gray-500 dark:text-gray-400">N/A</p>
                    <p className="text-sm text-gray-500 dark:text-gray-400">Calcul en cours d'implémentation</p>
                  </div>
                </div>
              </div>

              {/* Dossiers récents */}
              {statistics && (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                  <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                    Dossiers récents
                  </h3>
                  {statistics.clients_recents.length === 0 ? (
                    <div className="text-center py-8">
                      <div className="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i className="ri-folder-open-line text-gray-400 dark:text-gray-500 text-xl"></i>
                      </div>
                      <p className="text-gray-500 dark:text-gray-400 text-sm">Aucun dossier pour le moment</p>
                    </div>
                  ) : (
                  <div className="space-y-4">
                    {statistics.clients_recents.map((client) => (
                      <div 
                        key={client.id} 
                        onClick={() => handleClientRecentClick(client.id)}
                        className="flex items-center justify-between gap-3 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors"
                      >
                        <div className="flex items-center space-x-3 min-w-0 flex-1">
                          <div className="w-10 h-10 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center flex-shrink-0">
                            <span className="text-[#335FAD] dark:text-[#335FAD]/80 font-medium text-sm">
                              {client.prenom.charAt(0)}{client.nom.charAt(0)}
                            </span>
                          </div>
                          <div className="min-w-0 flex-1">
                            <p className="font-medium text-gray-900 dark:text-white truncate">
                              {client.prenom} {client.nom}
                            </p>
                            <p className="text-sm text-gray-500 dark:text-gray-400">
                              {formatDate(client.date_soumission)}
                            </p>
                          </div>
                        </div>
                        <div className="flex items-center gap-2 sm:gap-3 flex-shrink-0">
                          <div className="hidden sm:flex flex-col items-end space-y-2 min-w-0">
                            <div className="flex items-center gap-2">
                              <div className="text-right">
                                <p className="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">Capital</p>
                                <p className="text-sm font-medium text-gray-900 dark:text-white whitespace-nowrap">
                                  {formatCurrency(client.montant_capital, { decimals: 0 })}
                                </p>
                              </div>
                              {client.economie > 0 && (
                                <div className="text-right">
                                  <p className="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">Économie</p>
                                  <p className="text-sm font-medium text-green-600 dark:text-green-400 whitespace-nowrap">
                                {formatCurrency(client.economie)}
                                  </p>
                            </div>
                              )}
                          </div>
                          </div>
                          <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium whitespace-nowrap ${
                            client.is_couple 
                              ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400' 
                              : 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400'
                          }`}>
                            {client.is_couple ? 'Couple' : 'Seul'}
                          </span>
                          <i className="ri-arrow-right-line text-gray-400 dark:text-gray-500 flex-shrink-0"></i>
                        </div>
                      </div>
                    ))}
                  </div>
                  )}
                </div>
              )}
            </div>

            {/* Sidebar */}
            <div className="space-y-6">
              {/* Informations de contact */}
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                  Informations de contact
                </h3>
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Nom complet
                    </label>
                    <p className="text-gray-900 dark:text-white">
                      {apporteur.prenom} {apporteur.nom}
                    </p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Email
                    </label>
                    <p className="text-gray-900 dark:text-white">{apporteur.email}</p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Téléphone
                    </label>
                    <p className="text-gray-900 dark:text-white">{apporteur.telephone}</p>
                  </div>
                </div>
              </div>

              {/* Informations du compte */}
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                  Informations du compte
                </h3>
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Date d'inscription
                    </label>
                    <p className="text-gray-900 dark:text-white">
                      {formatDate(apporteur.date_inscription)}
                    </p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Dernière connexion
                    </label>
                    <p className="text-gray-900 dark:text-white">
                      {formatDate(apporteur.last_login)}
                    </p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Statut du compte
                    </label>
                    {getStatutBadge(apporteur.statut)}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'statistics' && statistics && (
          <div className="space-y-8">
            {/* Performance mensuelle améliorée */}
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                <div>
                  <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                    Performance mensuelle détaillée
                  </h3>
                  <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                    Cliquez sur un mois pour voir les dossiers traités
                  </p>
                </div>
                
                {/* Filtres de période */}
                <div className="flex gap-1 bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                  {(['6mois', '12mois', '24mois', 'tout'] as const).map((period) => (
                    <button
                      key={period}
                      onClick={() => setPerformancePeriod(period)}
                      className={`px-3 py-1.5 text-xs font-medium rounded-md transition-colors cursor-pointer whitespace-nowrap ${
                        performancePeriod === period
                          ? 'bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm'
                          : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
                      }`}
                    >
                      {period === '6mois' ? '6 mois' : 
                       period === '12mois' ? '12 mois' : 
                       period === '24mois' ? '24 mois' : 'Tout'}
                    </button>
                  ))}
                </div>
              </div>
              
              {/* Version desktop */}
              <div className="hidden lg:block overflow-x-auto -mx-6">
                <table className="w-full">
                  <thead className="bg-gray-50 dark:bg-gray-700/50 border-y border-gray-200 dark:border-gray-600">
                    <tr>
                      <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap">
                        <div className="flex items-center space-x-2">
                          <i className="ri-calendar-line"></i>
                          <span>Mois</span>
                        </div>
                      </th>
                      <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap">
                        <div className="flex items-center space-x-2">
                          <i className="ri-file-list-line"></i>
                          <span>Traités</span>
                        </div>
                      </th>
                      <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap">
                        <div className="flex items-center space-x-2">
                          <i className="ri-checkbox-circle-line"></i>
                          <span>Validés</span>
                        </div>
                      </th>
                      <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap">
                        <div className="flex items-center space-x-2">
                          <i className="ri-money-euro-circle-line"></i>
                          <span>Économies</span>
                        </div>
                      </th>
                      <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap">
                        <div className="flex items-center space-x-2">
                          <i className="ri-line-chart-line"></i>
                          <span>CA GMB</span>
                        </div>
                      </th>
                    </tr>
                  </thead>
                  <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {getFilteredPerformanceData().map((month, index) => {
                      const taux = month.dossiers_traites > 0 ? (month.dossiers_valides / month.dossiers_traites * 100) : 0;
                      
                      return (
                        <tr 
                          key={index}
                          onClick={() => handleMonthClick(month.mois)}
                          className="hover:bg-gray-50 dark:hover:bg-gray-700/30 cursor-pointer transition-all"
                        >
                          <td className="px-6 py-4 text-sm whitespace-nowrap">
                            <div className="flex items-center space-x-2">
                              <span className="font-medium text-gray-900 dark:text-white">
                                {month.mois}
                              </span>
                              <i className="ri-eye-line text-gray-400 dark:text-gray-500 text-xs"></i>
                            </div>
                          </td>
                          <td className="px-6 py-4 text-sm whitespace-nowrap">
                            <div className="inline-flex items-center px-2.5 py-1 bg-gray-100 dark:bg-gray-700 rounded-md">
                              <span className="font-semibold text-gray-900 dark:text-white">
                              {month.dossiers_traites}
                            </span>
                            </div>
                          </td>
                          <td className="px-6 py-4 text-sm whitespace-nowrap">
                            <div className="flex items-center space-x-2">
                              <div className="inline-flex items-center px-2.5 py-1 bg-gray-100 dark:bg-gray-700 rounded-md">
                                <span className="font-semibold text-gray-900 dark:text-white">
                                {month.dossiers_valides}
                              </span>
                              </div>
                              <span className={`text-xs font-medium px-2.5 py-1 rounded-md ${
                                taux >= 70 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 
                                taux >= 50 ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400' : 
                                'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400'
                              }`}>
                                {taux.toFixed(0)}%
                              </span>
                            </div>
                          </td>
                          <td className="px-6 py-4 text-sm font-semibold text-green-600 dark:text-green-400 whitespace-nowrap">
                            {formatCurrency(month.economies_generees)}
                          </td>
                          <td className="px-6 py-4 text-sm font-medium text-gray-500 dark:text-gray-400 whitespace-nowrap">
                            {formatCurrency(month.ca_gmb)}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>

              {/* Version mobile/tablette - cartes empilées */}
              <div className="lg:hidden">
                <div className="space-y-4">
                  {getFilteredPerformanceData().map((month, index) => {
                    const taux = month.dossiers_traites > 0 ? (month.dossiers_valides / month.dossiers_traites * 100) : 0;
                    
                    return (
                      <div
                        key={index}
                        onClick={() => handleMonthClick(month.mois)}
                        className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                      >
                        <div className="flex items-center justify-between mb-3">
                          <div className="flex items-center space-x-2">
                            <i className="ri-calendar-line text-gray-400 dark:text-gray-500"></i>
                            <span className="font-medium text-gray-900 dark:text-white">
                              {month.mois}
                            </span>
                          </div>
                          <i className="ri-eye-line text-gray-400 dark:text-gray-500 text-sm"></i>
                        </div>

                        <div className="grid grid-cols-2 gap-3 text-sm">
                          <div>
                            <span className="text-gray-500 dark:text-gray-400 text-xs">Dossiers traités</span>
                            <div className="inline-flex items-center px-2.5 py-1 bg-gray-100 dark:bg-gray-700 rounded-md mt-1">
                              <span className="font-semibold text-gray-900 dark:text-white">
                                {month.dossiers_traites}
                              </span>
                            </div>
                          </div>
                          <div>
                            <span className="text-gray-500 dark:text-gray-400 text-xs">Dossiers validés</span>
                            <div className="inline-flex items-center px-2.5 py-1 bg-gray-100 dark:bg-gray-700 rounded-md mt-1">
                              <span className="font-semibold text-gray-900 dark:text-white">
                                {month.dossiers_valides}
                              </span>
                            </div>
                            <div className="mt-1">
                              <span className={`text-xs font-medium px-2.5 py-1 rounded-md inline-block ${
                                taux >= 70 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 
                                taux >= 50 ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400' : 
                                'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400'
                              }`}>
                                {taux.toFixed(0)}%
                              </span>
                            </div>
                          </div>
                          <div>
                            <span className="text-gray-500 dark:text-gray-400 text-xs">Économies générées</span>
                            <div className="font-semibold text-green-600 dark:text-green-400 mt-1">
                              {formatCurrency(month.economies_generees)}
                            </div>
                          </div>
                          <div>
                            <span className="text-gray-500 dark:text-gray-400 text-xs">CA GMB</span>
                            <div className="font-medium text-gray-900 dark:text-white mt-1">
                              {formatCurrency(month.ca_gmb)}
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>

          </div>
        )}
      </main>

      {/* Modals */}
      
      {/* Modal des dossiers mensuels */}
      {showMonthModal && selectedMonth && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white dark:bg-gray-800 rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            {/* Header de la modale */}
            <div className="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-xl font-medium text-gray-900 dark:text-white">
                    Dossiers de {selectedMonth}
                  </h3>
                  <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                    {apporteur.prenom} {apporteur.nom} • Cliquez sur un dossier pour l'ouvrir
                  </p>
                </div>
                <button
                  onClick={() => setShowMonthModal(false)}
                  className="w-8 h-8 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full flex items-center justify-center transition-colors cursor-pointer"
                >
                  <i className="ri-close-line text-gray-600 dark:text-gray-300"></i>
                </button>
              </div>
            </div>

            {/* Contenu de la modale */}
            <div className="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
              {loadingMonthlyData ? (
                <div className="text-center py-8">
                  <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                  <p className="text-gray-600 dark:text-gray-400">Chargement des dossiers...</p>
                </div>
              ) : monthlyDossiers.length === 0 ? (
                <div className="text-center py-8">
                  <div className="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i className="ri-file-list-3-line text-gray-400 dark:text-gray-500 text-2xl"></i>
                  </div>
                  <h4 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
                    Aucun dossier ce mois-ci
                  </h4>
                  <p className="text-gray-500 dark:text-gray-400">
                    Aucun dossier n'a été traité en {selectedMonth}
                  </p>
                </div>
              ) : (
                <div className="space-y-4">
                  {monthlyDossiers.map((dossier) => (
                    <div 
                      key={dossier.id}
                      onClick={() => handleDossierClick(dossier.id)}
                      className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors border border-transparent hover:border-indigo-200 dark:hover:border-indigo-700"
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex flex-wrap items-center gap-2 mb-3">
                            <h4 className="text-lg font-medium text-gray-900 dark:text-white">
                              {dossier.client_prenom} {dossier.client_nom}
                            </h4>
                            <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                              dossier.is_couple 
                                ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400' 
                                : 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400'
                            }`}>
                              {dossier.is_couple ? 'Couple' : 'Seul'}
                            </span>
                            {getDossierStatutBadge(dossier.statut)}
                          </div>
                          
                          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                            <div>
                              <span className="text-gray-500 dark:text-gray-400">Numéro :</span>
                              <span className="ml-2 text-gray-900 dark:text-white">
                                {dossier.numero}
                              </span>
                            </div>
                            <div>
                              <span className="text-gray-500 dark:text-gray-400">Capital :</span>
                              <span className="ml-2 font-medium text-gray-900 dark:text-white">
                                {formatCurrency(dossier.montant_capital)}
                              </span>
                            </div>
                            <div>
                              <span className="text-gray-500 dark:text-gray-400">Date :</span>
                              <span className="ml-2 text-gray-900 dark:text-white">
                                {formatDate(dossier.date_soumission)}
                              </span>
                            </div>
                          </div>
                          
                          {dossier.economie_generee > 0 && (
                          <div className="flex items-center space-x-4 mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                            <div className="flex items-center space-x-2">
                              <i className="ri-money-euro-circle-line text-green-600 dark:text-green-400"></i>
                              <div>
                                <span className="text-xs text-gray-500 dark:text-gray-400">Économie générée</span>
                                <p className="font-medium text-green-600 dark:text-green-400">
                                  {formatCurrency(dossier.economie_generee)}
                                </p>
                              </div>
                            </div>
                              </div>
                          )}
                        </div>
                        
                        <div className="ml-4 flex-shrink-0">
                          <i className="ri-arrow-right-line text-gray-400 dark:text-gray-500"></i>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Modal de contact */}
      {showContactModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                  Contacter {apporteur.prenom} {apporteur.nom}
                </h3>
                <button
                  onClick={() => setShowContactModal(false)}
                  className="w-8 h-8 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full flex items-center justify-center transition-colors cursor-pointer"
                >
                  <i className="ri-close-line text-gray-600 dark:text-gray-300"></i>
                </button>
              </div>
              
              {/* NOUVEAU: Champ Objet */}
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Objet du message
                </label>
                <input
                  type="text"
                  value={contactSubject}
                  onChange={(e) => setContactSubject(e.target.value)}
                  placeholder="Ex: Demande de précisions sur votre dossier..."
                  className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  maxLength={100}
                />
                <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  {contactSubject.length}/100 caractères
                </p>
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Message
                </label>
                <textarea
                  value={contactMessage}
                  onChange={(e) => setContactMessage(e.target.value)}
                  placeholder="Tapez votre message ici..."
                  className="w-full h-32 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  maxLength={500}
                />
                <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  {contactMessage.length}/500 caractères
                </p>
              </div>

              <div className="flex space-x-3">
                <button
                  onClick={() => {
                    setShowContactModal(false);
                    setContactMessage('');
                    setContactSubject('');
                  }}
                  className="flex-1 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                >
                  Annuler
                </button>
                <button
                  onClick={handleContactApporteur}
                  disabled={!contactMessage.trim()}
                  className="flex-1 bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <i className="ri-send-plane-line mr-2"></i>
                  Envoyer
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal de suspension */}
      {showSuspendModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                  Suspendre {apporteur.prenom} {apporteur.nom}
                </h3>
                <button
                  onClick={() => setShowSuspendModal(false)}
                  className="w-8 h-8 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full flex items-center justify-center transition-colors cursor-pointer"
                >
                  <i className="ri-close-line text-gray-600 dark:text-gray-300"></i>
                </button>
              </div>
              
              <p className="text-gray-600 dark:text-gray-400 mb-4">
                Cette action suspendra temporairement le compte de l'apporteur. Il ne pourra plus soumettre de nouveaux dossiers.
              </p>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Raison de la suspension
                </label>
                <textarea
                  value={suspendReason}
                  onChange={(e) => setSuspendReason(e.target.value)}
                  placeholder="Indiquez la raison de la suspension..."
                  className="w-full h-24 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                  maxLength={300}
                />
              </div>

              <div className="flex space-x-3">
                <button
                  onClick={() => setShowSuspendModal(false)}
                  className="flex-1 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                >Annuler</button>
                <button
                  onClick={handleSuspendApporteur}
                  disabled={!suspendReason.trim()}
                  className="flex-1 bg-orange-600 hover:bg-orange-700 dark:bg-orange-500 dark:hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <i className="ri-pause-line mr-2"></i>
                  Suspendre
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal de réactivation */}
      {showReactivateModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                  Réactiver {apporteur.prenom} {apporteur.nom}
                </h3>
                <button
                  onClick={() => setShowReactivateModal(false)}
                  className="w-8 h-8 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full flex items-center justify-center transition-colors cursor-pointer"
                >
                  <i className="ri-close-line text-gray-600 dark:text-gray-300"></i>
                </button>
              </div>
              
              <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 mb-4">
                <div className="flex items-start space-x-3">
                  <i className="ri-check-circle-line text-green-600 dark:text-green-400 text-xl mt-0.5"></i>
                  <div>
                    <p className="text-green-900 dark:text-green-200 font-medium mb-1">Réactivation du compte</p>
                    <p className="text-green-700 dark:text-green-300 text-sm">
                      Cette action réactivera le compte de l'apporteur. Il pourra à nouveau soumettre de nouveaux dossiers et accéder à toutes les fonctionnalités.
                    </p>
                  </div>
                </div>
              </div>

              <p className="text-gray-600 dark:text-gray-400 mb-6">
                Êtes-vous sûr de vouloir réactiver ce compte ?
              </p>

              <div className="flex space-x-3">
                <button
                  onClick={() => setShowReactivateModal(false)}
                  className="flex-1 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                >Annuler</button>
                <button
                  onClick={handleReactivateApporteur}
                  className="flex-1 bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                >
                  <i className="ri-play-line mr-2"></i>
                  Réactiver
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal de suppression */}
      {showDeleteModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                  Supprimer {apporteur.prenom} {apporteur.nom}
                </h3>
                <button
                  onClick={() => setShowDeleteModal(false)}
                  className="w-8 h-8 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full flex items-center justify-center transition-colors cursor-pointer"
                >
                  <i className="ri-close-line text-gray-600 dark:text-gray-300"></i>
                </button>
              </div>
              
              <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-4">
                <div className="flex items-start space-x-3">
                  <i className="ri-error-warning-line text-red-600 dark:text-red-400 text-xl mt-0.5"></i>
                  <div>
                    <p className="text-red-900 dark:text-red-200 font-medium mb-1">Action irréversible</p>
                    <p className="text-red-700 dark:text-red-300 text-sm">
                      Cette action supprimera définitivement le compte apporteur, ses données personnelles et l'accès à tous ses dossiers. Les dossiers existés seront archivés.
                    </p>
                  </div>
                </div>
              </div>

              <p className="text-gray-600 dark:text-gray-400 mb-6">
                Êtes-vous sûr de vouloir supprimer définitivement ce compte ?
              </p>

              <div className="flex space-x-3">
                <button
                  onClick={() => setShowDeleteModal(false)}
                  className="flex-1 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                >Annuler</button>
                <button
                  onClick={handleDeleteApporteur}
                  className="flex-1 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                >
                  <i className="ri-delete-bin-line mr-2"></i>
                  Supprimer définitivement
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

================
File: app/admin/apporteurs/[id]/page.tsx
================
import { Suspense } from 'react';
import ApporteurDetailContent from './ApporteurDetailContent';
import { supabase } from '@/lib/supabase';

export async function generateStaticParams() {
  try {
    // Récupérer tous les IDs d'apporteurs depuis la DB pour la génération statique
    const { data: apporteurs, error } = await supabase
      .from('apporteur_profiles')
      .select('id');

    if (error) {
      console.error('Erreur lors de la récupération des apporteurs pour generateStaticParams:', error);
      return [];
    }

    // Retourner les IDs pour la génération des pages statiques
    return apporteurs?.map((apporteur) => ({
      id: apporteur.id
    })) || [];
  } catch (error) {
    console.error('Erreur dans generateStaticParams:', error);
    return [];
  }
}

export default async function ApporteurDetailPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Chargement du profil...</p>
        </div>
      </div>
    }>
      <ApporteurDetailContent apporteurId={id} />
    </Suspense>
  );
}

================
File: app/admin/apporteurs/page.tsx
================
'use client';

import { useState, useEffect, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import AdminHeader from '../../../components/AdminHeader';
import { ApporteursService } from '@/lib/services/apporteurs';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { getApporteurBadgeConfig } from '@/lib/utils/apporteur-badges';
import { InviteModal } from '@/components/features/invites/InviteModal';
import { useBrokerContext } from '@/hooks/useBrokerContext';
import { EmptyState } from '@/components/ui/empty-state';

// ============================================================================
// INTERFACES POUR L'INTÉGRATION SUPABASE
// ============================================================================

// Interface pour les données admin
interface AdminData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
}

// Interface pour un apporteur - Correspond à la table apporteur_profiles
interface Apporteur {
  id: string;
  user_id: string;
  nom: string;
  prenom: string;
  email: string;
  telephone: string;
  adresse: string;
  date_inscription: string;
  statut: 'actif' | 'inactif' | 'suspendu';
  derniere_connexion?: string;
  // Statistiques calculées
  nb_dossiers_total: number;
  nb_dossiers_valides: number;
  chiffre_affaires: number;
  taux_conversion: number;
}

export default function AdminApporteursPage() {
  const router = useRouter();
  const [darkMode, setDarkMode] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);
  const [activeTab, setActiveTab] = useState('apporteurs');
  const [searchQuery, setSearchQuery] = useState('');
  const [statusFilter, setStatusFilter] = useState('tous');
  const [sortField, setSortField] = useState<keyof Apporteur>('date_inscription');
  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10);
  const [showInviteModal, setShowInviteModal] = useState(false);
  const { currentBrokerId } = useBrokerContext();

  // Données admin simulées
  const adminData = useMemo<AdminData>(() => ({
    id: 'admin1',
    firstName: 'Alexandre',
    lastName: 'Martin',
    initials: 'AM',
    role: 'Administrateur'
  }), []);

  // ============================================================================
  // SUPABASE INTEGRATION - RÉCUPÉRATION DES DONNÉES APPORTEURS
  // ============================================================================

  /**
   * ÉTAT PRINCIPAL DES APPORTEURS - CONNECTÉ À SUPABASE
   */
  const [apporteurs, setApporteurs] = useState<Apporteur[]>([]);
  const [isLoadingApporteurs, setIsLoadingApporteurs] = useState(true);
  const [error, setError] = useState<string | null>(null);


  // ============================================================================
  // SUPABASE INTEGRATION - FONCTIONS DE RÉCUPÉRATION ET MISE À JOUR
  // ============================================================================

  /**
   * RÉCUPÉRATION DES APPORTEURS AVEC STATISTIQUES
   */
  const fetchApporteurs = async () => {
    try {
      setIsLoadingApporteurs(true);
      setError(null);

      const data = await ApporteursService.getAllApporteurs(currentBrokerId || undefined);

      console.log('🔍 [DEBUG PAGE GLOBALE] Données brutes de getAllApporteurs:', JSON.stringify(data, null, 2));

      // Calculer les statistiques pour chaque apporteur en utilisant la méthode centralisée
      const apporteursWithStats = data.map((apporteur: any) => {
        const dossiers = apporteur.dossiers || [];

        console.log(`🔍 [DEBUG] Apporteur ${apporteur.prenom} ${apporteur.nom}:`, {
          nbDossiers: dossiers.length,
          dossiers: dossiers.map((d: any) => ({ id: d.id, statut: d.statut, economie: d.economie_generee }))
        });

        // Utiliser la méthode centralisée de calcul des stats pour garantir la cohérence
        const stats = ApporteursService.calculateApporteurStats(dossiers);

        console.log(`✅ [DEBUG] Stats calculées pour ${apporteur.prenom} ${apporteur.nom}:`, stats);

        // Déterminer le statut réel de l'apporteur (inactif si pas d'activité depuis 2 mois)
        const lastLoginAt = apporteur.last_login_at || apporteur.updated_at;
        const estInactif = ApporteursService.isApporteurInactif(lastLoginAt, dossiers);

        // Override du statut si l'apporteur est inactif automatiquement
        let statutFinal = apporteur.statut;
        if (statutFinal === 'actif' && estInactif) {
          statutFinal = 'inactif';
        }

        return {
          id: apporteur.id,
          user_id: apporteur.user_id,
          nom: apporteur.nom,
          prenom: apporteur.prenom,
          email: apporteur.email,
          telephone: apporteur.telephone || 'Non renseigné',
          adresse: '', // Non disponible dans DB
          date_inscription: apporteur.created_at,
          statut: statutFinal, // Utilise le statut final (avec vérification d'inactivité)
          derniere_connexion: lastLoginAt,
          nb_dossiers_total: stats.totalDossiers,
          nb_dossiers_valides: stats.dossiersValides,
          chiffre_affaires: stats.economiesGenerees,
          taux_conversion: stats.tauxConversion
        };
      });

      setApporteurs(apporteursWithStats);
    } catch (error: any) {
      console.error('Erreur récupération apporteurs:', error);
      setError(error.message || 'Erreur lors du chargement des apporteurs');
    } finally {
      setIsLoadingApporteurs(false);
    }
  };


  // Initialisation du mode sombre
  useEffect(() => {
    if (typeof window !== 'undefined' && !isInitialized) {
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      setDarkMode(savedDarkMode);

      if (savedDarkMode) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }

      setIsInitialized(true);
    }
  }, [isInitialized]);

  // Récupération des données au montage
  useEffect(() => {
    if (currentBrokerId) {
      fetchApporteurs();
    }
  }, [currentBrokerId]);

  const handleDarkModeToggle = (newDarkMode: boolean) => {
    setDarkMode(newDarkMode);

    if (typeof window !== 'undefined') {
      if (newDarkMode) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('darkMode', 'true');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('darkMode', 'false');
      }
    }
  };

  const handleViewDetails = (apporteurId: string) => {
    router.push(`/admin/apporteurs/${apporteurId}`);
  };

  // Filtrage et tri des apporteurs
  const filteredAndSortedApporteurs = useMemo(() => {
    let filtered = apporteurs.filter(apporteur => {
      const matchesSearch = searchQuery === '' ||
        `${apporteur.prenom} ${apporteur.nom}`.toLowerCase().includes(searchQuery.toLowerCase()) ||
        apporteur.email.toLowerCase().includes(searchQuery.toLowerCase());

      const matchesStatus = statusFilter === 'tous' || apporteur.statut === statusFilter;

      return matchesSearch && matchesStatus;
    });

    filtered.sort((a, b) => {
      let aValue = a[sortField];
      let bValue = b[sortField];

      // Handle sort for specific date fields
      if (sortField === 'date_inscription' || sortField === 'derniere_connexion') {
        const aTime = aValue ? new Date(aValue as string).getTime() : 0;
        const bTime = bValue ? new Date(bValue as string).getTime() : 0;
        if (aTime < bTime) return sortDirection === 'asc' ? -1 : 1;
        if (aTime > bTime) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      }

      // Safe string conversion
      const aString = String(aValue || '').toLowerCase();
      const bString = String(bValue || '').toLowerCase();

      // Compare as strings if they look like strings, otherwise compare values
      if (typeof aValue === 'string' || typeof bValue === 'string') {
        if (aString < bString) return sortDirection === 'asc' ? -1 : 1;
        if (aString > bString) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      }

      // Default comparison for numbers/others
      if ((aValue ?? 0) < (bValue ?? 0)) return sortDirection === 'asc' ? -1 : 1;
      if ((aValue ?? 0) > (bValue ?? 0)) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });

    return filtered;
  }, [apporteurs, searchQuery, statusFilter, sortField, sortDirection]);

  // Pagination
  const totalPages = Math.ceil(filteredAndSortedApporteurs.length / itemsPerPage);
  const paginatedApporteurs = filteredAndSortedApporteurs.slice(
    (currentPage - 1) * itemsPerPage,
    currentPage * itemsPerPage
  );

  // Statistiques générales (calcul corrigé avec détection automatique d'inactivité)
  const stats = useMemo(() => {
    const total = apporteurs.length;
    // Les apporteurs affichés dans 'apporteurs' ont déjà leur statut calculé avec isApporteurInactif
    const actifs = apporteurs.filter(a => a.statut === 'actif').length;
    const suspendus = apporteurs.filter(a => a.statut === 'suspendu').length;

    return { total, actifs, suspendus };
  }, [apporteurs]);

  const handleSort = (field: keyof Apporteur) => {
    if (sortField === field) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortDirection('asc');
    }
  };

  // ✅ Utilisation des badges centralisés depuis lib/utils/apporteur-badges.ts
  const getStatusBadge = (status: string) => {
    const config = getApporteurBadgeConfig(status);

    if (!config) {
      return (
        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
          Inconnu
        </span>
      );
    }

    return (
      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${config.color}`}>
        <i className={`${config.icon} mr-1`}></i>
        {config.text}
      </span>
    );
  };

  if (!isInitialized) {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      <AdminHeader
        darkMode={darkMode}
        setDarkMode={handleDarkModeToggle}
        adminData={adminData}
      />

      {/* Hero section */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="px-4 sm:px-8 py-6 max-w-7xl mx-auto">
          <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
              <h1 className="text-2xl sm:text-3xl font-light text-gray-900 dark:text-white mb-2">
                Gestion des Apporteurs
              </h1>
              <p className="text-gray-600 dark:text-gray-400">
                Gérez les partenaires et analysez les performances
              </p>
            </div>

            <div className="flex items-center space-x-3">
              <button
                onClick={() => setShowInviteModal(true)}
                className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 hover:shadow-lg flex items-center space-x-2 whitespace-nowrap cursor-pointer"
              >
                <i className="ri-add-line text-lg"></i>
                <span>Inviter un Apporteur</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <main className="px-4 sm:px-8 py-6 max-w-7xl mx-auto">
        {/* Statistiques */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div className="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Total apporteurs</p>
                <p className="text-2xl font-light text-gray-900 dark:text-white">{stats.total}</p>
              </div>
              <div className="w-12 h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 rounded-lg flex items-center justify-center">
                <i className="ri-team-line text-[#335FAD] dark:text-[#335FAD] text-xl"></i>
              </div>
            </div>
          </div>

          <div className="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Actifs</p>
                <p className="text-2xl font-light text-gray-900 dark:text-white">{stats.actifs}</p>
              </div>
              <div className="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                <i className="ri-check-line text-green-600 dark:text-green-400 text-xl"></i>
              </div>
            </div>
          </div>

          <div className="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Suspendus</p>
                <p className="text-2xl font-light text-gray-900 dark:text-white">{stats.suspendus}</p>
              </div>
              <div className="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                <i className="ri-pause-line text-gray-600 dark:text-gray-400 text-xl"></i>
              </div>
            </div>
          </div>
        </div>

        {/* Navigation par onglets avec correction du clipping */}
        <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
          <div className="border-b border-gray-200 dark:border-gray-700 overflow-visible">
            <nav className="flex overflow-x-auto relative">
              <button
                onClick={() => setActiveTab('apporteurs')}
                className={`px-6 py-4 text-sm font-medium border-b-2 whitespace-nowrap transition-colors cursor-pointer ${activeTab === 'apporteurs'
                  ? 'border-indigo-500 text-[#335FAD] dark:text-[#335FAD]/80 bg-indigo-50 dark:bg-indigo-900/20'
                  : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50'
                  }`}
              >
                Liste des apporteurs ({stats.total})
              </button>
            </nav>
          </div>

          {activeTab === 'apporteurs' && (
            <>
              {/* État de chargement */}
              {isLoadingApporteurs ? (
                <div className="p-12 text-center">
                  <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-[#335FAD]"></div>
                  <p className="mt-4 text-gray-600 dark:text-gray-400">Chargement des apporteurs...</p>
                </div>
              ) : error ? (
                <div className="p-12 text-center">
                  <div className="inline-flex items-center justify-center w-16 h-16 bg-red-100 dark:bg-red-900/20 rounded-full mb-4">
                    <i className="ri-error-warning-line text-3xl text-red-600 dark:text-red-400"></i>
                  </div>
                  <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">Erreur de chargement</h3>
                  <p className="text-gray-600 dark:text-gray-400 mb-4">{error}</p>
                  <button
                    onClick={fetchApporteurs}
                    className="px-4 py-2 bg-[#335FAD] text-white rounded-lg hover:bg-[#2a4d8f] transition-colors"
                  >
                    Réessayer
                  </button>
                </div>
              ) : (
                <>
                  {/* Barre de recherche et filtres */}
                  <div className="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div className="flex flex-col md:flex-row gap-4">
                      <div className="relative flex-1">
                        <i className="ri-search-line absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500"></i>
                        <input
                          type="text"
                          placeholder="Rechercher par nom ou email..."
                          value={searchQuery}
                          onChange={(e) => setSearchQuery(e.target.value)}
                          className="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent transition-colors"
                        />
                      </div>
                      <Select value={statusFilter} onValueChange={setStatusFilter}>
                        <SelectTrigger className="w-[220px]">
                          <SelectValue placeholder="Tous les statuts" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="tous">Tous les statuts</SelectItem>
                          <SelectItem value="actif">Actifs</SelectItem>
                          <SelectItem value="inactif">Inactifs</SelectItem>
                          <SelectItem value="suspendu">Suspendus</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  </div>

                  {/* Tableau des apporteurs */}
                  {paginatedApporteurs.length === 0 ? (
                    <EmptyState
                      icon="ri-user-add-line"
                      title={searchQuery || filterStatut !== 'tous' ? "Aucun résultat" : "Aucun apporteur"}
                      description={
                        searchQuery || filterStatut !== 'tous'
                          ? "Aucun apporteur ne correspond à vos critères. Modifiez vos filtres."
                          : "Vous n'avez pas encore d'apporteur. Invitez-en un pour commencer à collaborer."
                      }
                      action={!searchQuery && filterStatut === 'tous' ? {
                        label: "Inviter un apporteur",
                        onClick: () => setShowInviteModal(true)
                      } : undefined}
                      secondaryAction={searchQuery || filterStatut !== 'tous' ? {
                        label: "Réinitialiser les filtres",
                        onClick: () => {
                          setSearchQuery('');
                          setFilterStatut('tous');
                        }
                      } : undefined}
                    />
                  ) : (
                  <div className="overflow-x-auto">
                    {/* Version desktop */}
                    <div className="hidden lg:block">
                      <table className="w-full">
                        <thead className="bg-gray-50 dark:bg-gray-800/50">
                          <tr>
                            <th className="px-6 py-4 text-left">
                              <button
                                onClick={() => handleSort('nom')}
                                className="flex items-center space-x-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-gray-300 cursor-pointer"
                              >
                                <span>Apporteur</span>
                                {sortField === 'nom' && (
                                  <i className={`ri-arrow-${sortDirection === 'asc' ? 'up' : 'down'}-line`}></i>
                                )}
                              </button>
                            </th>
                            <th className="px-6 py-4 text-left">
                              <span className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                Statut
                              </span>
                            </th>
                            <th className="px-6 py-4 text-left">
                              <button
                                onClick={() => handleSort('nb_dossiers_valides')}
                                className="flex items-center space-x-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-gray-300 cursor-pointer"
                              >
                                <span>Performance</span>
                                {sortField === 'nb_dossiers_valides' && (
                                  <i className={`ri-arrow-${sortDirection === 'asc' ? 'up' : 'down'}-line`}></i>
                                )}
                              </button>
                            </th>
                            <th className="px-6 py-4 text-left">
                              <button
                                onClick={() => handleSort('chiffre_affaires')}
                                className="flex items-center space-x-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-gray-300 cursor-pointer"
                              >
                                <span>CA</span>
                                {sortField === 'chiffre_affaires' && (
                                  <i className={`ri-arrow-${sortDirection === 'asc' ? 'up' : 'down'}-line`}></i>
                                )}
                              </button>
                            </th>
                            <th className="px-6 py-4 text-left">
                              <button
                                onClick={() => handleSort('date_inscription')}
                                className="flex items-center space-x-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-gray-300 cursor-pointer"
                              >
                                <span>Inscription</span>
                                {sortField === 'date_inscription' && (
                                  <i className={`ri-arrow-${sortDirection === 'asc' ? 'up' : 'down'}-line`}></i>
                                )}
                              </button>
                            </th>
                            <th className="px-6 py-4 text-right">
                              <span className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                Actions
                              </span>
                            </th>
                          </tr>
                        </thead>
                        <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                          {paginatedApporteurs.map((apporteur) => (
                            <tr key={apporteur.id} className="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                              <td className="px-6 py-4">
                                <div className="flex items-center space-x-3">
                                  <div className="w-10 h-10 bg-[#335FAD] dark:bg-[#335FAD] rounded-lg flex items-center justify-center">
                                    <span className="text-white text-sm font-medium">
                                      {apporteur.prenom[0]}{apporteur.nom[0]}
                                    </span>
                                  </div>
                                  <div>
                                    <div className="text-sm font-medium text-gray-900 dark:text-white">
                                      {apporteur.prenom} {apporteur.nom}
                                    </div>
                                    <div className="text-sm text-gray-500 dark:text-gray-400">
                                      {apporteur.email}
                                    </div>
                                  </div>
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                {getStatusBadge(apporteur.statut)}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div className="text-sm font-medium text-gray-900 dark:text-white">
                                  {apporteur.nb_dossiers_valides}/{apporteur.nb_dossiers_total}
                                </div>
                                <div className="text-xs text-gray-500 dark:text-gray-400">
                                  {apporteur.taux_conversion}% conversion
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div className="text-sm font-medium text-gray-900 dark:text-white">
                                  {formatCurrency(apporteur.chiffre_affaires, { decimals: 0 })}
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div className="text-sm text-gray-900 dark:text-white">
                                  {formatDate(apporteur.date_inscription)}
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button
                                  onClick={() => handleViewDetails(apporteur.id)}
                                  className="text-[#335FAD] dark:text-[#335FAD]/80 hover:text-indigo-900 dark:hover:text-indigo-300 cursor-pointer"
                                >
                                  Voir détails
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>

                    {/* Version mobile/tablette - cartes empilées */}
                    <div className="lg:hidden">
                      <div className="p-4 space-y-4">
                        {paginatedApporteurs.map((apporteur) => (
                          <div
                            key={apporteur.id}
                            className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600"
                          >
                            <div className="flex items-start justify-between mb-3">
                              <div className="flex items-center space-x-3">
                                <div className="w-10 h-10 bg-[#335FAD] dark:bg-[#335FAD] rounded-lg flex items-center justify-center">
                                  <span className="text-white text-sm font-medium">
                                    {apporteur.prenom[0]}{apporteur.nom[0]}
                                  </span>
                                </div>
                                <div>
                                  <div className="text-sm font-medium text-gray-900 dark:text-white">
                                    {apporteur.prenom} {apporteur.nom}
                                  </div>
                                  <div className="text-xs text-gray-500 dark:text-gray-400">
                                    {apporteur.email}
                                  </div>
                                </div>
                              </div>
                              {getStatusBadge(apporteur.statut)}
                            </div>

                            <div className="grid grid-cols-2 gap-3 text-sm mb-3">
                              <div>
                                <span className="text-gray-500 dark:text-gray-400 text-xs">Performance</span>
                                <div className="font-medium text-gray-900 dark:text-white">
                                  {apporteur.nb_dossiers_valides}/{apporteur.nb_dossiers_total}
                                </div>
                                <div className="text-xs text-gray-500 dark:text-gray-400">
                                  {apporteur.taux_conversion}% conversion
                                </div>
                              </div>
                              <div>
                                <span className="text-gray-500 dark:text-gray-400 text-xs">CA</span>
                                <div className="font-medium text-gray-900 dark:text-white">
                                  {formatCurrency(apporteur.chiffre_affaires)}
                                </div>
                              </div>
                            </div>

                            <div className="text-xs text-gray-500 dark:text-gray-400 mb-3">
                              Inscrit le {formatDate(apporteur.date_inscription)}
                            </div>

                            <button
                              onClick={() => handleViewDetails(apporteur.id)}
                              className="w-full bg-[#335FAD] hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                            >
                              Voir détails
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                  )}

                  {/* Pagination */}
                  <div className="bg-white dark:bg-gray-800 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                    <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                      <div className="flex items-center space-x-2">
                        <span className="text-sm text-gray-700 dark:text-gray-300">Afficher</span>
                        <Select
                          value={String(itemsPerPage)}
                          onValueChange={(v) => {
                            setItemsPerPage(Number(v));
                            setCurrentPage(1);
                          }}
                        >
                          <SelectTrigger className="w-[100px]">
                            <SelectValue placeholder="10" />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="10">10</SelectItem>
                            <SelectItem value="25">25</SelectItem>
                            <SelectItem value="50">50</SelectItem>
                          </SelectContent>
                        </Select>
                        <span className="text-sm text-gray-700 dark:text-gray-300">
                          résultats sur {filteredAndSortedApporteurs.length}
                        </span>
                      </div>

                      <div className="flex items-center space-x-2">
                        <button
                          onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
                          disabled={currentPage === 1}
                          className="px-3 py-2 rounded-md bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
                        >
                          <i className="ri-arrow-left-s-line"></i>
                        </button>

                        <div className="flex items-center space-x-1">
                          {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                            let pageNum;
                            if (totalPages <= 5) {
                              pageNum = i + 1;
                            } else if (currentPage <= 3) {
                              pageNum = i + 1;
                            } else if (currentPage >= totalPages - 2) {
                              pageNum = totalPages - 4 + i;
                            } else {
                              pageNum = currentPage - 2 + i;
                            }

                            return (
                              <button
                                key={pageNum}
                                onClick={() => setCurrentPage(pageNum)}
                                className={`px-3 py-2 rounded-md text-sm font-medium cursor-pointer ${currentPage === pageNum
                                  ? 'bg-[#335FAD] dark:bg-[#335FAD] text-white'
                                  : 'bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600'
                                  }`}
                              >
                                {pageNum}
                              </button>
                            );
                          })}
                        </div>

                        <button
                          onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
                          disabled={currentPage === totalPages}
                          className="px-3 py-2 rounded-md bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-5

                      0 disabled:cursor-not-allowed cursor-pointer"
                        >
                          <i className="ri-arrow-right-s-line"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </>
              )}
            </>
          )}

        </div>
      </main>

      {/* Modal d'invitation (Centralized Feature 2) */}
      <InviteModal
        isOpen={showInviteModal}
        onClose={() => setShowInviteModal(false)}
        inviteType="apporteur"
      />
    </div>
  );
}

================
File: app/admin/dossiers/[id]/AdminDossierDetailContent.tsx
================
'use client';

import { useState, useEffect, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { DatePicker } from '@/components/ui/date-picker';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { DossiersService } from '@/lib/services/dossiers';
import { DevisService } from '@/lib/services/devis';
import { supabase } from '@/lib/supabase';
import { ClientInfosService } from '@/lib/services/client-infos';
import { PretDataService } from '@/lib/services/pret-data';
import { DocumentsService } from '@/lib/services/documents';
import { DocumentExtractionService } from '@/lib/services/document-extraction';
import { ExtractionResult, ExtractedDataDisplay } from '@/components/ExtractionResult';
import { DataComparisonService } from '@/lib/services/data-comparison';
import DataComparisonModal from '@/components/DataComparisonModal';
import type { DiffReport, ExtractedClientData } from '@/types/data-comparison';
import { CATEGORY_OPTIONS, getCategoryLabel } from '@/lib/constants/exade';
import { getStatutBadgeConfig, mapStatutForDisplay } from '@/lib/utils/statut-mapping';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { DocumentViewerModal } from '@/components/features/document-viewer/DocumentViewerModal';

// ============================================================================
// INTERFACES POUR L'INTÉGRATION SUPABASE
// ============================================================================

// Interface pour les données admin
interface AdminData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
}

// Interface pour un dossier détaillé - Correspond aux tables Supabase
interface DossierDetail {
  id: string;
  numero_dossier: string;
  type: 'seul' | 'couple';
  is_couple: boolean;
  // Emprunteur principal
  client_civilite?: string;
  client_nom: string;
  client_prenom: string;
  client_nom_naissance?: string;
  client_email: string;
  client_telephone: string;
  client_date_naissance: string;
  client_adresse: string;
  client_categorie_professionnelle?: number;  // Code Exade 1-11
  client_fumeur: boolean;
  // Informations du conjoint (si dossier couple)
  conjoint_civilite?: string;
  conjoint_nom?: string;
  conjoint_prenom?: string;
  conjoint_nom_naissance?: string;
  conjoint_date_naissance?: string;
  conjoint_categorie_professionnelle?: number;  // Code Exade 1-11
  conjoint_fumeur?: boolean;
  conjoint_email?: string;
  conjoint_telephone?: string;
  apporteur_id: string;
  apporteur_nom: string;
  apporteur_prenom: string;
  apporteur_email: string;
  date_soumission: string;
  // STATUT CRITIQUE - Synchronisé en temps réel avec la DB
  status: 'nouveau' | 'devis_envoye' | 'devis_disponible' | 'valide' | 'refuse' | 'finalise';
  // Métadonnées d'extraction
  extracted_client_data?: any;
  comparison_modal_seen?: boolean;
  last_extraction_at?: string;
  type_assurance: string;
  montant_capital: number;
  duree_pret: number;
  donnees_saisies: any;
  donnees_ia: any;
  infos_pret: any;
  documents: any;
  commentaire_apporteur?: string;
  cout_assurance_banque?: number;
  commentaire_refus?: string;
  date_validation?: string;
  date_refus?: string;
  date_finalisation?: string;
}

// Interface pour un devis avec données API Exade - Table 'devis' Supabase
interface Devis {
  id: string;
  numero_devis?: string;
  statut?: string | null;
  selected?: boolean;
  refused?: boolean;
  motif_refus?: string;
  commentaire_refus?: string;
  date_generation?: string | null;
  compagnie: string;
  produit: string;
  cout_mensuel: number;
  cout_total: number;
  economie_estimee?: number;
  formalites_medicales: string[];
  couverture: string[];
  exclusions: string[];
  avantages: string[];
  // CHAMPS CRITIQUES pour le workflow
  id_simulation: string;
  id_tarif: string;
  cout_total_tarif: number;
  frais_adhesion: number;
  frais_frac: number;
  detail_pret: {
    capital: number;
    duree: number;
    taux_assurance: number;
  };
  formalites_detaillees: string[];
  erreurs: string[];
}

// Interfaces locales pour les états d'édition afin d'éviter les any implicites
interface EditedClientData {
  client_civilite?: string;
  client_nom: string;
  client_prenom: string;
  client_nom_naissance?: string;
  client_email: string;
  client_telephone: string;
  client_date_naissance: string;
  client_adresse: string;
  client_categorie_professionnelle?: number;  // Code Exade 1-11
  client_fumeur: boolean;
  // Informations du conjoint (si dossier couple)
  conjoint_civilite?: string;
  conjoint_nom?: string;
  conjoint_prenom?: string;
  conjoint_nom_naissance?: string;
  conjoint_date_naissance?: string;
  conjoint_categorie_professionnelle?: number;  // Code Exade 1-11
  conjoint_fumeur?: boolean;
  conjoint_email?: string;
  conjoint_telephone?: string;
}

interface EditedPretData {
  banque_preteuse: string;
  montant_capital: number;
  duree_mois: number;
  type_pret: string;
  cout_assurance_banque: number | null;
}

interface AdminDossierDetailContentProps {
  dossierId: string;
}

export default function AdminDossierDetailContent({ dossierId }: AdminDossierDetailContentProps) {
  const router = useRouter();
  const [darkMode, setDarkMode] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);
  const [activeTab, setActiveTab] = useState('overview');
  const [coutAssuranceBanque, setCoutAssuranceBanque] = useState<number | null>(null);
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  const [selectedDevis, setSelectedDevis] = useState<string | null>(null);
  const [showFinalizeModal, setShowFinalizeModal] = useState(false);
  const [showDevisModal, setShowDevisModal] = useState(false);
  const [selectedDevisDetail, setSelectedDevisDetail] = useState<Devis | null>(null);

  // États pour l'édition
  const [isEditingClient, setIsEditingClient] = useState(false);
  const [isEditingPret, setIsEditingPret] = useState(false);
  const [editedClientData, setEditedClientData] = useState<EditedClientData>({
    client_civilite: '',
    client_nom: '',
    client_prenom: '',
    client_nom_naissance: '',
    client_email: '',
    client_telephone: '',
    client_date_naissance: '',
    client_adresse: '',
    client_categorie_professionnelle: 0,
    client_fumeur: false,
    // Informations du conjoint (si dossier couple)
    conjoint_civilite: '',
    conjoint_nom: '',
    conjoint_prenom: '',
    conjoint_nom_naissance: '',
    conjoint_date_naissance: '',
    conjoint_categorie_professionnelle: 0,
    conjoint_fumeur: false,
    conjoint_email: '',
    conjoint_telephone: ''
  });
  const [editedPretData, setEditedPretData] = useState<EditedPretData>({
    banque_preteuse: '',
    montant_capital: 0,
    duree_mois: 0,
    type_pret: '',
    cout_assurance_banque: null
  });
  const [showDocumentModal, setShowDocumentModal] = useState(false);
  const [documentToDelete, setDocumentToDelete] = useState<string | null>(null);
  const [showDeleteDocModal, setShowDeleteDocModal] = useState(false);

  // États pour l'ajout de documents
  const [newDocumentType, setNewDocumentType] = useState<string>('');
  const [newDocumentFile, setNewDocumentFile] = useState<File | null>(null);
  const [isUploadingDocument, setIsUploadingDocument] = useState(false);

  // États pour l'extraction de documents
  const [extractionResult, setExtractionResult] = useState<any>(null);
  const [isExtracting, setIsExtracting] = useState(false);
  const [extractionError, setExtractionError] = useState<string | null>(null);
  const [isRefreshingDevis, setIsRefreshingDevis] = useState(false);

  // États pour la comparaison de données
  const [showComparisonModal, setShowComparisonModal] = useState(false);
  const [diffReport, setDiffReport] = useState<DiffReport | null>(null);
  const [extractedClientData, setExtractedClientData] = useState<ExtractedClientData | null>(null);
  const [autoCheckDone, setAutoCheckDone] = useState(false);

  // État pour la modale de suppression
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [deleteConfirmInput, setDeleteConfirmInput] = useState(''); // Pour ne vérifier qu'une fois au chargement

  // Données admin simulées
  const adminData = useMemo<AdminData>(() => ({
    id: '00000000-0000-0000-0000-000000000001', // UUID valide pour l'admin
    firstName: 'Alexandre',
    lastName: 'Martin',
    initials: 'AM',
    role: 'Administrateur'
  }), []);

  // ============================================================================
  // SUPABASE INTEGRATION - RÉCUPÉRATION DU DOSSIER EN TEMPS RÉEL
  // ============================================================================

  /**
   * ÉTAT PRINCIPAL DU DOSSIER
   * 
   * Cet état doit être synchronisé en temps réel avec Supabase via :
   * 1. Récupération initiale depuis les tables jointes
   * 2. Subscription temps réel pour les mises à jour de statut
   * 3. Mise à jour automatique quand l'apporteur valide/refuse
   * 
   * Tables Supabase impliquées :
   * - dossiers (statut principal, dates de validation/refus/finalisation)
   * - client_infos (données client)
   * - apporteur_profiles (infos apporteur)
   * - documents (fichiers joints)
   */
  const [dossier, setDossier] = useState<DossierDetail>({
    id: dossierId,
    numero_dossier: `DSS-2024-00${dossierId}`,
    type: 'seul',
    is_couple: false,
    client_nom: 'Martin',
    client_prenom: 'Pierre',
    client_email: 'pierre.martin@email.com',
    client_telephone: '06 12 34 56 78',
    client_date_naissance: '1985-03-15',
    client_adresse: '15 rue de la République, 75001 Paris',
    client_categorie_professionnelle: 1,  // Salarié cadre
    client_fumeur: false,
    apporteur_id: 'ap1',
    apporteur_nom: 'Dubois',
    apporteur_prenom: 'Marie',
    apporteur_email: 'marie.dubois@email.com',
    date_soumission: '2024-01-15T10:30:00Z',
    // STATUT EN TEMPS RÉEL - Reflète l'état exact de la DB
    status: dossierId === '1' ? 'nouveau' : dossierId === '2' ? 'devis_envoye' : dossierId === '3' ? 'valide' : dossierId === '4' ? 'refuse' : 'finalise',
    type_assurance: 'Prêt Immobilier',
    montant_capital: 350000,
    duree_pret: 20,
    donnees_saisies: {
      situation_familiale: 'Marié(e)',
      nombre_enfants: 2,
      profession: 'Ingénieur informatique',
      revenus_mensuels: 4500,
      charges_mensuelles: 1200,
      fumeur: false,
      pratique_sport_risque: false
    },
    donnees_ia: {
      risque_medical: 'Faible',
      score_assurabilite: 85,
      recommandations: ['Contrat standard recommandé', 'Aucune surprime nécessaire'],
      donnees_extraites: {
        age: 39,
        imc: 23.5,
        antecedents_medicaux: 'Aucun',
        profession_risque: 'Standard'
      }
    },
    infos_pret: {
      banque_preteuse: 'Crédit Agricole',
      montant_capital: 350000,
      duree_mois: 240,
      type_pret: 'Amortissable à taux fixe',
      cout_assurance_banque: 280
    },
    documents: {
      offre_pret: null,
      tableau_amortissement: null,
      carte_identite: null,
      carte_identite_conjoint: null,
      autres: []
    },
    commentaire_apporteur: undefined,
    cout_assurance_banque: dossierId === '1' ? undefined : 280,
    commentaire_refus: dossierId === '4' ? 'Le client trouve les tarifs trop élevés par rapport à son assurance bancaire actuelle.' : undefined,
    date_validation: dossierId === '3' ? '2024-01-17T11:30:00Z' : undefined,
    date_refus: dossierId === '4' ? '2024-01-18T08:45:00Z' : undefined,
    date_finalisation: dossierId === '5' ? '2024-01-19T14:20:00Z' : undefined
  });

  /**
   * ÉTAT DES DEVIS - SYNCHRONISÉ AVEC L'API EXADE ET SUPABASE
   * 
   * Cet état contient tous les devis générés pour ce dossier :
   * 1. Données issues de l'API Exade (tarifs, formalités, etc.)
   * 2. Statuts de sélection/refus gérés par l'admin
   * 3. Mise à jour temps réel quand l'apporteur/client valide ou refuse
   * 
   * Workflow complet :
   * - Admin sélectionne un devis -> selected = true, autres = false
   * - Statut dossier passe à 'devis_envoye'
   * - Apporteur/client valide -> statut dossier = 'valide'
   * - Apporteur/client refuse -> statut dossier = 'refuse', devis.refused = true
   * - Admin peut sélectionner un autre devis après refus
   */
  const [devis, setDevis] = useState<Devis[]>([
    {
      id: 'devis1',
      compagnie: 'Generali',
      produit: 'ASSUREA PRET 7301 CI',
      cout_mensuel: 95.50,
      cout_total: 22920,
      economie_estimee: 44280,
      formalites_medicales: ['Questionnaire de santé', 'Examen médical si > 300k€'],
      couverture: ['Décès', 'PTIA', 'ITT', 'IPT'],
      exclusions: ['Sports extrêmes', 'Guerre'],
      avantages: ['Remboursement anticipé sans frais', 'Garantie chômage optionnelle'],
      // STATUT SÉLECTIONNÉ - Reflète la sélection admin en temps réel
      selected: dossierId === '2' || dossierId === '3' || dossierId === '4' || dossierId === '5',
      refused: false,
      id_simulation: 'SIM_2024_001',
      id_tarif: '1',
      cout_total_tarif: 22920,
      frais_adhesion: 30,
      frais_frac: 20,
      detail_pret: {
        capital: 350000,
        duree: 240,
        taux_assurance: 0.33
      },
      formalites_detaillees: [
        'Questionnaire de santé simplifié',
        'Examen médical obligatoire si capital > 300 000€',
        'Analyse d\'urine et prise de sang si âge > 50 ans',
        'Rapport du médecin traitant si antécédents déclarés'
      ],
      erreurs: []
    },
    {
      id: 'devis2',
      compagnie: 'Swisslife',
      produit: 'EMPRUNTEUR SECURITE PLUS',
      cout_mensuel: 102.30,
      cout_total: 24552,
      economie_estimee: 42648,
      formalites_medicales: ['Questionnaire de santé détaillé'],
      couverture: ['Décès', 'PTIA', 'ITT', 'IPT', 'IPP'],
      exclusions: ['Maladies préexistantes', 'Sports à risque'],
      avantages: ['Franchise ITT réduite', 'Prise en charge psychologique'],
      selected: false,
      refused: false,
      id_simulation: 'SIM_2024_002',
      id_tarif: '2',
      cout_total_tarif: 24552,
      frais_adhesion: 45,
      frais_frac: 12,
      detail_pret: {
        capital: 350000,
        duree: 240,
        taux_assurance: 0.39
      },
      formalites_detaillees: [
        'Questionnaire de santé détaillé obligatoire',
        'Téléconsultation médicale systématique',
        'Bilan cardiologique si âge > 45 ans',
        'Examen spécialisé selon profession à risque'
      ],
      erreurs: []
    },
    {
      id: 'devis3',
      compagnie: 'Allianz',
      produit: 'ALLIANZ EMPRUNTEUR OPTIMAL',
      cout_mensuel: 89.75,
      cout_total: 21540,
      economie_estimee: 45660,
      formalites_medicales: ['Questionnaire simplifié', 'Téléconsultation médicale'],
      couverture: ['Décès', 'PTIA', 'ITT', 'IPT'],
      exclusions: ['Suicide 1ère année', 'Alcoolisme'],
      avantages: ['Souscription 100% digitale', 'Tarif préférentiel non-fumeur'],
      selected: false,
      refused: false,
      id_simulation: 'SIM_2024_003',
      id_tarif: '3',
      cout_total_tarif: 21540,
      frais_adhesion: 25,
      frais_frac: 8,
      detail_pret: {
        capital: 350000,
        duree: 240,
        taux_assurance: 0.31
      },
      formalites_detaillees: [
        'Questionnaire de santé simplifié en ligne',
        'Téléconsultation médicale gratuite incluse',
        'Pas d\'examen complémentaire jusqu\'à 500 000€',
        'Validation automatique si profil standard'
      ],
      erreurs: []
    }
  ]);

  // Charger et appliquer les données DB (remplace les mocks)
  /**
   * Fonction pour charger/recharger les données du dossier
   */
  const loadDossierData = async () => {
    try {
      const data: any = await DossiersService.getDossierById(dossierId);
      if (!data) return;
      const ci = Array.isArray(data.client_infos) ? data.client_infos[0] : null;
      const pret = Array.isArray(data.pret_data) ? data.pret_data[0] : null;
      const docs = Array.isArray(data.documents) ? data.documents : [];
      const canon = (data.statut as any) || 'en_attente';
      // ✅ Utilisation de la source de vérité unique pour mapper statut canonique → statut affichage
      const statusForDisplay = mapStatutForDisplay(canon);
      setDossier(prev => ({
        ...(prev as any),
        id: data.id,
        numero_dossier: data.numero_dossier,
        type: (data.is_couple ? 'couple' : 'seul'),
        is_couple: data.is_couple || false,
        client_nom: ci?.client_nom || '',
        client_prenom: ci?.client_prenom || '',
        client_email: ci?.client_email || '',
        client_telephone: ci?.client_telephone || '',
        client_date_naissance: ci?.client_date_naissance || '',
        client_adresse: ci?.client_adresse || '',
        client_profession: ci?.client_profession || '',
        client_fumeur: !!ci?.client_fumeur,
        // Informations du conjoint (si dossier couple)
        conjoint_nom: ci?.conjoint_nom || '',
        conjoint_prenom: ci?.conjoint_prenom || '',
        conjoint_date_naissance: ci?.conjoint_date_naissance || '',
        conjoint_profession: ci?.conjoint_profession || '',
        conjoint_revenus: ci?.conjoint_revenus || '',
        conjoint_fumeur: !!ci?.conjoint_fumeur,
        apporteur_id: data.apporteur_id || '',
        apporteur_nom: data.apporteur_profiles?.nom || (prev as any)?.apporteur_nom || '',
        apporteur_prenom: data.apporteur_profiles?.prenom || (prev as any)?.apporteur_prenom || '',
        apporteur_email: data.apporteur_profiles?.email || (prev as any)?.apporteur_email || '',
        date_soumission: data.created_at || (prev as any)?.date_soumission || '',
        status: statusForDisplay,
        type_assurance: pret?.type_pret || (prev as any)?.type_assurance || 'Prêt Immobilier',
        montant_capital: Number(pret?.montant_capital || (prev as any)?.montant_capital || 0),
        duree_pret: Number(pret?.duree_mois || ((prev as any)?.duree_pret || 0) * 12) / 12,
        infos_pret: {
          ...(prev as any)?.infos_pret,
          banque_preteuse: pret?.banque_preteuse || (prev as any)?.infos_pret?.banque_preteuse || '',
          montant_capital: Number(pret?.montant_capital || (prev as any)?.infos_pret?.montant_capital || 0),
          duree_mois: Number(pret?.duree_mois || (prev as any)?.infos_pret?.duree_mois || 0),
          type_pret: pret?.type_pret || (prev as any)?.infos_pret?.type_pret || '',
        },
        documents: mapDocumentsFromRows(docs, (prev as any)?.documents),
        commentaire_apporteur: data.commentaire || undefined
      }) as any);

      // Charger les données d'extraction après avoir chargé les données du dossier
      await loadExtractionData();

    } catch (e) {
      console.error('[AdminDetail] fetch DB error', e);
    }
  };

  useEffect(() => {
    loadDossierData();
  }, [dossierId]);

  // Vérifier automatiquement au chargement si une extraction récente a des différences
  useEffect(() => {
    const checkPendingExtraction = async () => {
      // Ne vérifier qu'une seule fois et seulement si le dossier est chargé
      if (autoCheckDone || !dossier?.id) return;

      try {
        // Récupérer les métadonnées d'extraction depuis la DB
        const { data: dossierMeta, error } = await supabase
          .from('dossiers')
          .select('extracted_client_data, comparison_modal_seen, last_extraction_at')
          .eq('id', dossierId)
          .single();

        if (error) {
          console.error('[AdminDetail] Erreur récupération métadonnées extraction:', error);
          return;
        }

        // Vérifier si on doit afficher la modale automatiquement
        const shouldShowModal =
          dossierMeta?.extracted_client_data &&
          !dossierMeta?.comparison_modal_seen &&
          dossierMeta?.last_extraction_at;

        if (shouldShowModal) {
          console.log('[AdminDetail] Extraction récente non vue détectée, vérification des différences...');

          // Simuler les données extraites comme si elles venaient de l'API
          const simulatedExtraction = {
            emprunteurs: dossierMeta.extracted_client_data,
            nombreAssures: dossierMeta.extracted_client_data.nombreAssures,
            metadata: {
              champsManquants: dossierMeta.extracted_client_data.champsManquants || []
            }
          };

          // Lancer la comparaison
          await checkDataDifferences(simulatedExtraction);
        }

        setAutoCheckDone(true);
      } catch (error) {
        console.error('[AdminDetail] Erreur vérification extraction automatique:', error);
        setAutoCheckDone(true);
      }
    };

    if (dossier?.id) {
      checkPendingExtraction();
    }
  }, [dossier?.id, autoCheckDone]);

  function mapDocumentsFromRows(rows: any[], prevDocs?: any) {
    const findDocMulti = (types: string[]) => rows.find((r: any) => types.includes(r.document_type));
    const toObj = (row?: any) => row ? {
      id: row.id, // Ajout de l'ID pour la suppression
      nom: row.document_name,
      url: row.storage_path,
      taille: row.file_size ? `${(row.file_size / (1024 * 1024)).toFixed(1)} MB` : '',
      type: row.document_type // Ajout du type pour l'affichage
    } : null;

    // Types principaux
    const principalTypes = ['offre_pret', 'offrePret', 'tableau_amortissement', 'tableauAmortissement',
      'carte_identite', 'carteIdentite', 'carte_identite_conjoint', 'carteIdentiteConjoint'];

    // Filtrer les autres documents (tous sauf les types principaux)
    const autresDocuments = rows
      .filter((r: any) => !principalTypes.includes(r.document_type))
      .map((r: any) => toObj(r));

    return {
      offre_pret: toObj(findDocMulti(['offre_pret', 'offrePret'])) || prevDocs?.offre_pret || null,
      tableau_amortissement: toObj(findDocMulti(['tableau_amortissement', 'tableauAmortissement'])) || prevDocs?.tableau_amortissement || null,
      carte_identite: toObj(findDocMulti(['carte_identite', 'carteIdentite'])) || prevDocs?.carte_identite || null,
      carte_identite_conjoint: toObj(findDocMulti(['carte_identite_conjoint', 'carteIdentiteConjoint'])) || prevDocs?.carte_identite_conjoint || null,
      autres: autresDocuments.length > 0 ? autresDocuments : (prevDocs?.autres || []),
    };
  }

  const buildPublicUrl = (key: string) => {
    const base = (process.env.NEXT_PUBLIC_SUPABASE_URL || '').replace(/\/+$/, '')
    return `${base}/storage/v1/object/public/documents/${key}`
  }

  /**
   * Convertit les types de documents en labels lisibles
   */
  const getDocumentTypeLabel = (type: string): string => {
    const labels: Record<string, string> = {
      'offrePret': 'Offre de Prêt',
      'tableauAmortissement': 'Tableau d\'Amortissement',
      'carteIdentite': 'Carte d\'Identité',
      'carteIdentiteConjoint': 'Carte d\'Identité (Conjoint)',
      'bulletinDePaie': 'Bulletin de Paie',
      'avisImposition': 'Avis d\'Imposition',
      'contratTravail': 'Contrat de Travail',
      'autre': 'Autre Document'
    };
    return labels[type] || type;
  }

  // Charger devis depuis DB; si vide, appeler EXADE puis semer en DB et recharger
  useEffect(() => {
    (async () => {
      if (!dossier?.id) return;
      try {
        // 1) Lire devis DB
        const dbDevis = await DevisService.getDevisByDossierId(dossier.id);
        if (dbDevis && dbDevis.length > 0) {
          // essayer de récupérer le devis sélectionné si disponible dans le dossier
          const selectedId = (dossier as any)?.devis_selectionne_id || null;
          setDevis(dbDevis.map((d: any) => ({
            id: d.id,
            numero_devis: d.numero_devis,
            statut: d.statut,
            selected: selectedId ? d.id === selectedId : false,
            refused: d.statut === 'refuse',
            motif_refus: (d.donnees_devis as any)?.motif_refus,
            commentaire_refus: (d.donnees_devis as any)?.commentaire_refus,
            date_generation: d.date_generation,
            date_envoi: d.date_envoi,
            compagnie: (d.donnees_devis as any)?.compagnie || (d.donnees_devis as any)?.compagnie_libelle || 'Compagnie',
            produit: (d.donnees_devis as any)?.produit || (d.donnees_devis as any)?.reference || '',
            cout_mensuel: (d.donnees_devis as any)?.mensualite || (d.donnees_devis as any)?.cout_mensuel || 0,
            cout_total: (d.donnees_devis as any)?.primeTotale || (d.donnees_devis as any)?.cout_total || 0,
            economie_estimee: (d.donnees_devis as any)?.economie_estimee,
            formalites_medicales: (d.donnees_devis as any)?.garanties?.map((g: any) => g.libelle) || [],
            couverture: (d.donnees_devis as any)?.couverture || [],
            exclusions: (d.donnees_devis as any)?.exclusions || [],
            avantages: (d.donnees_devis as any)?.avantages || [],
            id_simulation: (d.donnees_devis as any)?.id_simulation || '',
            id_tarif: (d.donnees_devis as any)?.id_tarif || (d.donnees_devis as any)?.reference || '',
            cout_total_tarif: (d.donnees_devis as any)?.cout_total_tarif || (d.donnees_devis as any)?.primeTotale || 0,
            frais_adhesion: (d.donnees_devis as any)?.frais_adhesion || 0,
            frais_frac: (d.donnees_devis as any)?.frais_frac || 0,
            detail_pret: {
              capital: (d.donnees_devis as any)?.detail_pret?.capital || dossier.montant_capital,
              duree: (d.donnees_devis as any)?.detail_pret?.duree || dossier.duree_pret * 12,
              taux_assurance: (d.donnees_devis as any)?.detail_pret?.taux_assurance || (dossier as any)?.infos_pret?.taux_assurance || 0
            },
            formalites_detaillees: (d.donnees_devis as any)?.formalites_detaillees || [],
            erreurs: (d.donnees_devis as any)?.erreurs || []
          })) as Devis[]);
          return;
        }

        // 2) Aucun devis: tenter EXADE
        try {
          const resp = await fetch('/api/exade/tarifs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ clientInfo: (dossier as any), pretData: (dossier as any).infos_pret })
          });
          const payload = await resp.json();
          if (!resp.ok) throw new Error(payload?.error || 'Erreur EXADE');
          const tarifs: any[] = payload?.tarifs || [];

          if (tarifs.length > 0) {
            const devisToInsert = tarifs.map((t: any, index: number) => ({
              dossier_id: dossier.id,
              numero_devis: `EX-${Date.now()}-${index + 1}`,
              statut: 'en_attente',
              donnees_devis: t,
              date_generation: new Date().toISOString(),
              date_expiration: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            }));
            await DevisService.createMultipleDevis(devisToInsert as any);
          }
        } catch (exErr) {
          console.error('[AdminDetail] Erreur lors de la génération des devis EXADE', exErr);
          // Afficher un message d'erreur à l'utilisateur mais ne pas créer de données fictives
        }

        // 3) Relire depuis DB
        const freshDevis = await DevisService.getDevisByDossierId(dossier.id);
        const selectedId = (dossier as any)?.devis_selectionne_id || null;
        setDevis((freshDevis as any).map((d: any) => ({
          ...d,
          selected: selectedId ? d.id === selectedId : false,
          refused: d.statut === 'refuse'
        })));
      } catch (e) {
        console.error('[AdminDetail] devis load/seed error', e);
      }
    })();
  }, [dossier?.id]);

  // État pour l'historique complet des devis
  const [devisHistory, setDevisHistory] = useState<any[]>([]);

  // Charger l'historique complet des devis
  useEffect(() => {
    (async () => {
      if (!dossier?.id) return;
      try {
        const history = await DossiersService.getDevisHistory(dossier.id);
        setDevisHistory(history);
      } catch (e) {
        console.error('[AdminDetail] Erreur chargement historique devis:', e);
      }
    })();
  }, [dossier?.id]);

  // ============================================================================
  // SUPABASE INTEGRATION - FONCTIONS DE RÉCUPÉRATION ET SUBSCRIPTION TEMPS RÉEL
  // ============================================================================

  /**
   * FONCTION DE RÉCUPÉRATION COMPLÈTE DU DOSSIER
   * 
   * Cette fonction doit être appelée au montage du composant pour récupérer :
   * 1. Le dossier avec toutes ses relations (JOIN)
   * 2. Tous les devis associés au dossier
   * 3. Les documents depuis Supabase Storage
   * 
   * Requête SQL équivalente :
   * ```sql
   * SELECT 
   *   d.*,
   *   ci.nom, ci.prenom, ci.email, ci.telephone, ci.date_naissance,
   *   ci.adresse, ci.profession, ci.fumeur,
   *   ap.nom as apporteur_nom, ap.prenom as apporteur_prenom, 
   *   ap.email as apporteur_email
   * FROM dossiers d
   * LEFT JOIN client_infos ci ON ci.dossier_id = d.id
   * LEFT JOIN apporteur_profiles ap ON ap.user_id = d.apporteur_id
   * WHERE d.id = $1
   * ```
   * 
   * Puis récupération des devis :
   * ```sql
   * SELECT * FROM devis WHERE dossier_id = $1 ORDER BY cout_total ASC
   * ```
   */
  const fetchDossierComplet = async () => {
    try {
      // SUPABASE: Récupération du dossier complet
      /*
      const { data: dossierData, error: dossierError } = await supabase
        .from('dossiers')
        .select(`
          *,
          client_infos(*),
          apporteur_profiles(*),
          documents(*)
        `)
        .eq('id', dossierId)
        .single();

      if (dossierError) throw dossierError;

      // Récupération des devis
      const { data: devisData, error: devisError } = await supabase
        .from('devis')
        .select('*')
        .eq('dossier_id', dossierId)
        .order('cout_total', { ascending: true });

      if (devisError) throw devisError;

      // Mise à jour des états locaux
      setDossier(dossierData);
      setDevis(devisData);
      */
    } catch (error) {
      console.error('Erreur récupération dossier:', error);
    }
  };

  /**
   * SUBSCRIPTION TEMPS RÉEL POUR LES MISES À JOUR
   * 
   * Cette subscription écoute les changements sur :
   * 1. Table 'dossiers' - Changements de statut
   * 2. Table 'devis' - Sélections/refus de devis
   * 3. Table 'client_infos' - Modifications des données client
   * 
   * Permet la synchronisation automatique entre :
   * - Interface admin (cette page)
   * - Interface apporteur
   * - Interface client
   */
  useEffect(() => {
    // SUPABASE: Établir les subscriptions temps réel
    /*
    const dossierSubscription = supabase
      .channel('dossier-updates')
      .on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'dossiers',
        filter: `id=eq.${dossierId}`
      }, (payload) => {
        console.log('Dossier mis à jour:', payload.new);
        setDossier(prev => ({ ...prev, ...payload.new }));
      })
      .on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'devis',
        filter: `dossier_id=eq.${dossierId}`
      }, (payload) => {
        console.log('Devis mis à jour:', payload.new);
        setDevis(prev => prev.map(d => 
          d.id === payload.new.id ? { ...d, ...payload.new } : d
        ));
      })
      .subscribe();

    return () => {
      supabase.removeChannel(dossierSubscription);
    };
    */
  }, [dossierId]);

  // Initialisation du mode sombre
  useEffect(() => {
    if (typeof window !== 'undefined' && !isInitialized) {
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      setDarkMode(savedDarkMode);

      if (savedDarkMode) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }

      setIsInitialized(true);
    }
  }, [isInitialized]);

  // Initialiser le formulaire une seule fois à partir des données DB chargées
  const [didInitForm, setDidInitForm] = useState(false);
  useEffect(() => {
    if (!didInitForm && dossier?.id) {
      setEditedClientData({
        client_nom: dossier.client_nom,
        client_prenom: dossier.client_prenom,
        client_email: dossier.client_email,
        client_telephone: dossier.client_telephone,
        client_date_naissance: dossier.client_date_naissance,
        client_adresse: dossier.client_adresse,
        client_categorie_professionnelle: dossier.client_categorie_professionnelle || 0,
        client_fumeur: dossier.client_fumeur,
        // Informations du conjoint (si dossier couple)
        conjoint_nom: dossier.conjoint_nom || '',
        conjoint_prenom: dossier.conjoint_prenom || '',
        conjoint_date_naissance: dossier.conjoint_date_naissance || '',
        conjoint_categorie_professionnelle: dossier.conjoint_categorie_professionnelle || 0,
        conjoint_fumeur: dossier.conjoint_fumeur || false
      });

      setEditedPretData({
        banque_preteuse: dossier.infos_pret.banque_preteuse,
        montant_capital: dossier.infos_pret.montant_capital,
        duree_mois: dossier.infos_pret.duree_mois,
        type_pret: dossier.infos_pret.type_pret,
        cout_assurance_banque: dossier.infos_pret.cout_assurance_banque
      });
      setDidInitForm(true);
    }
  }, [dossier, didInitForm]);

  // Si on navigue vers un autre dossier, ré-initialiser le formulaire
  useEffect(() => {
    setDidInitForm(false);
  }, [dossier?.id]);

  const handleStartEditClient = () => {
    // Toujours pré-remplir depuis le dossier courant avant d'entrer en mode édition
    setEditedClientData({
      client_civilite: dossier.client_civilite || '',
      client_nom: dossier.client_nom,
      client_prenom: dossier.client_prenom,
      client_nom_naissance: dossier.client_nom_naissance || '',
      client_email: dossier.client_email,
      client_telephone: dossier.client_telephone,
      client_date_naissance: dossier.client_date_naissance,
      client_adresse: dossier.client_adresse,
      client_categorie_professionnelle: dossier.client_categorie_professionnelle || 0,
      client_fumeur: dossier.client_fumeur,
      // Informations du conjoint (si dossier couple)
      conjoint_civilite: dossier.conjoint_civilite || '',
      conjoint_nom: dossier.conjoint_nom || '',
      conjoint_prenom: dossier.conjoint_prenom || '',
      conjoint_nom_naissance: dossier.conjoint_nom_naissance || '',
      conjoint_date_naissance: dossier.conjoint_date_naissance || '',
      conjoint_categorie_professionnelle: dossier.conjoint_categorie_professionnelle || 0,
      conjoint_fumeur: dossier.conjoint_fumeur || false,
      conjoint_email: dossier.conjoint_email || '',
      conjoint_telephone: dossier.conjoint_telephone || ''
    });
    setIsEditingClient(true);
  };

  const handleDarkModeToggle = (newDarkMode: boolean) => {
    setDarkMode(newDarkMode);

    if (typeof window !== 'undefined') {
      if (newDarkMode) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('darkMode', 'true');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('darkMode', 'false');
      }
    }
  };

  // ============================================================================
  // SUPABASE INTEGRATION - SAUVEGARDE DES MODIFICATIONS
  // ============================================================================

  /**
   * SAUVEGARDE DES DONNÉES CLIENT
   * 
   * Met à jour la table 'client_infos' avec les modifications admin
   * Synchronise automatiquement avec l'interface apporteur
   */
  const handleSaveClientData = async () => {
    try {
      console.log('Sauvegarde des données client:', editedClientData);

      // Validation basique + sauvegarde via service (update si existe, sinon insert)
      const payload: any = {
        dossier_id: dossier.id,
        client_civilite: editedClientData.client_civilite || null,
        client_nom: editedClientData.client_nom,
        client_prenom: editedClientData.client_prenom,
        client_nom_naissance: editedClientData.client_nom_naissance || null,
        client_email: editedClientData.client_email,
        client_telephone: editedClientData.client_telephone,
        client_date_naissance: editedClientData.client_date_naissance,
        client_adresse: editedClientData.client_adresse,
        categorie_professionnelle: editedClientData.client_categorie_professionnelle || null,
        client_fumeur: editedClientData.client_fumeur,
        // Informations du conjoint (si dossier couple)
        conjoint_civilite: editedClientData.conjoint_civilite || null,
        conjoint_nom: editedClientData.conjoint_nom || null,
        conjoint_prenom: editedClientData.conjoint_prenom || null,
        conjoint_nom_naissance: editedClientData.conjoint_nom_naissance || null,
        conjoint_date_naissance: editedClientData.conjoint_date_naissance || null,
        conjoint_categorie_professionnelle: editedClientData.conjoint_categorie_professionnelle || null,
        conjoint_fumeur: editedClientData.conjoint_fumeur || false,
        conjoint_email: editedClientData.conjoint_email || null,
        conjoint_telephone: editedClientData.conjoint_telephone || null,
      };
      const validationErrors = ClientInfosService.validateClientData(payload);
      if (validationErrors.length > 0) {
        alert(validationErrors.join('\n'));
        return;
      }
      const saved = await ClientInfosService.upsertClientInfo(payload);

      // Mettre à jour l'état local (sera synchronisé par subscription)
      setDossier(prev => ({
        ...prev,
        client_civilite: saved?.client_civilite ?? editedClientData.client_civilite,
        client_nom: saved?.client_nom ?? editedClientData.client_nom,
        client_prenom: saved?.client_prenom ?? editedClientData.client_prenom,
        client_nom_naissance: saved?.client_nom_naissance ?? editedClientData.client_nom_naissance,
        client_email: saved?.client_email ?? editedClientData.client_email,
        client_telephone: saved?.client_telephone ?? editedClientData.client_telephone,
        client_date_naissance: saved?.client_date_naissance ?? editedClientData.client_date_naissance,
        client_adresse: saved?.client_adresse ?? editedClientData.client_adresse,
        client_categorie_professionnelle: saved?.categorie_professionnelle ?? editedClientData.client_categorie_professionnelle,
        client_fumeur: saved?.client_fumeur ?? editedClientData.client_fumeur,
        // Informations du conjoint (si dossier couple)
        conjoint_civilite: saved?.conjoint_civilite ?? editedClientData.conjoint_civilite,
        conjoint_nom: saved?.conjoint_nom ?? editedClientData.conjoint_nom,
        conjoint_prenom: saved?.conjoint_prenom ?? editedClientData.conjoint_prenom,
        conjoint_nom_naissance: saved?.conjoint_nom_naissance ?? editedClientData.conjoint_nom_naissance,
        conjoint_date_naissance: saved?.conjoint_date_naissance ?? editedClientData.conjoint_date_naissance,
        conjoint_categorie_professionnelle: saved?.conjoint_categorie_professionnelle ?? editedClientData.conjoint_categorie_professionnelle,
        conjoint_fumeur: saved?.conjoint_fumeur ?? editedClientData.conjoint_fumeur,
        conjoint_email: saved?.conjoint_email ?? editedClientData.conjoint_email,
        conjoint_telephone: saved?.conjoint_telephone ?? editedClientData.conjoint_telephone,
      }));

      // Pas de refetch immédiat pour éviter d'écraser l'état si la DB est ralentie
      setIsEditingClient(false);
    } catch (error: any) {
      console.error('Erreur sauvegarde données client:', error);
      alert(error?.message || 'Erreur lors de la sauvegarde des données client');
    }
  };

  const handleCancelEditClient = () => {
    setIsEditingClient(false);
    // Réinitialiser les données éditées avec les données actuelles du dossier
    setEditedClientData({
      client_civilite: dossier.client_civilite || '',
      client_nom: dossier.client_nom,
      client_prenom: dossier.client_prenom,
      client_nom_naissance: dossier.client_nom_naissance || '',
      client_email: dossier.client_email,
      client_telephone: dossier.client_telephone,
      client_date_naissance: dossier.client_date_naissance,
      client_adresse: dossier.client_adresse,
      client_categorie_professionnelle: dossier.client_categorie_professionnelle || 0,
      client_fumeur: dossier.client_fumeur,
      conjoint_civilite: dossier.conjoint_civilite || '',
      conjoint_nom: dossier.conjoint_nom || '',
      conjoint_prenom: dossier.conjoint_prenom || '',
      conjoint_nom_naissance: dossier.conjoint_nom_naissance || '',
      conjoint_date_naissance: dossier.conjoint_date_naissance || '',
      conjoint_categorie_professionnelle: dossier.conjoint_categorie_professionnelle || 0,
      conjoint_fumeur: dossier.conjoint_fumeur || false,
      conjoint_email: dossier.conjoint_email || '',
      conjoint_telephone: dossier.conjoint_telephone || '',
    });
  };

  /**
   * SUPPRESSION DU DOSSIER
   * Ouvre la modale de confirmation de suppression
   */
  const handleDeleteDossier = () => {
    setDeleteConfirmInput('');
    setShowDeleteModal(true);
  };

  /**
   * Confirme et exécute la suppression du dossier
   */
  const confirmDeleteDossier = async () => {
    if (deleteConfirmInput !== 'SUPPRIMER') {
      alert('Vous devez taper exactement "SUPPRIMER" pour confirmer.');
      return;
    }

    try {
      console.log(`[AdminDetail] Suppression du dossier ${dossierId}`);

      // Suppression via le service (cascade delete géré par la DB)
      await DossiersService.deleteDossier(dossierId);

      console.log(`[AdminDetail] ✅ Dossier ${dossierId} supprimé avec succès`);

      // Fermer la modale
      setShowDeleteModal(false);

      // Redirection vers la liste des dossiers
      router.push('/admin/dossiers');

    } catch (error: any) {
      console.error('[AdminDetail] ❌ Erreur lors de la suppression du dossier:', error);
      alert(`Erreur lors de la suppression du dossier : ${error?.message || 'Erreur inconnue'}`);
      setShowDeleteModal(false);
    }
  };

  /**
   * SAUVEGARDE DES DONNÉES DE PRÊT
   * 
   * Met à jour le JSON 'infos_pret' dans la table 'dossiers'
   * Recalcule automatiquement les économies pour tous les devis
   */
  const handleSavePretData = async () => {
    try {
      console.log('Sauvegarde des données prêt:', editedPretData);

      // Persistance pret_data par dossier_id
      const saved = await PretDataService.upsertByDossierId(dossierId, editedPretData as any);

      // Mettre à jour l'état local
      setDossier(prev => ({
        ...prev,
        infos_pret: {
          banque_preteuse: saved.banque_preteuse,
          montant_capital: saved.montant_capital,
          duree_mois: saved.duree_mois,
          type_pret: saved.type_pret,
          cout_assurance_banque: saved.cout_assurance_banque
        } as any
      }));

      setIsEditingPret(false);
    } catch (error) {
      console.error('Erreur sauvegarde données prêt:', error);
    }
  };

  // ============================================================================
  // SUPABASE INTEGRATION - GESTION DES DOCUMENTS
  // ============================================================================


  /**
   * AJOUT D'UN DOCUMENT
   * 
   * Upload vers Supabase Storage et création de l'entrée en base
   */
  const handleAddDocument = async (documentType: string, file: File) => {
    try {
      console.log('Ajout du document:', documentType, file.name);

      // SUPABASE: Upload et enregistrement
      /*
      const filePath = `${dossierId}/${documentType}/${file.name}`;
      
      // 1. Upload vers Storage
      const { error: uploadError } = await supabase.storage
        .from('documents')
        .upload(filePath, file);

      if (uploadError) throw uploadError;

      // 2. Créer l'entrée en base
      const { error: dbError } = await supabase
        .from('documents')
        .insert({
          dossier_id: dossierId,
          type: documentType,
          nom: file.name,
          file_path: filePath,
          file_size: file.size,
          file_type: file.type,
          uploaded_by: adminData.id
        });

      if (dbError) throw dbError;

      // 3. Récupérer l'URL publique
      const { data: urlData } = supabase.storage
        .from('documents')
        .getPublicUrl(filePath);
      */

      const newDocument = {
        nom: file.name,
        url: `/documents/${file.name}`,
        taille: `${(file.size / 1024 / 1024).toFixed(1)} MB`
      };

      setDossier(prev => ({
        ...prev,
        documents: {
          ...prev.documents,
          [documentType]: newDocument
        }
      }));

      setShowDocumentModal(false);
    } catch (error) {
      console.error('Erreur ajout document:', error);
    }
  };

  // ✅ MIGRATION COMPLÈTE - Utilisation de la source de vérité unique
  const getStatusBadge = (statusDisplay: string) => {
    // Reverse mapping: statut affichage → statut canonique
    const reversMap: Record<string, string> = {
      'nouveau': 'en_attente',
      'devis_envoye': 'devis_disponible',
      'valide': 'devis_accepte',
      'refuse': 'refuse',
      'finalise': 'finalise'
    };

    const statutCanonique = reversMap[statusDisplay] || statusDisplay;
    const config = getStatutBadgeConfig(statutCanonique);

    if (!config) {
      return (
        <span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-300">
          <i className="ri-time-line mr-2"></i>
          En cours
        </span>
      );
    }

    return (
      <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${config.color}`}>
        <i className={`${config.icon} mr-2`}></i>
        {config.text}
      </span>
    );
  };

  // ✅ Utilisation des formatters centralisés depuis lib/utils/formatters.ts

  const calculateEconomie = (coutDevis: number, coutBanque?: number) => {
    if (!coutBanque) return null;
    const economie = (coutBanque * dossier.infos_pret.duree_mois) - coutDevis;
    const pourcentage = ((economie / (coutBanque * dossier.infos_pret.duree_mois)) * 100);
    return { economie, pourcentage };
  };

  const handleDevisRowClick = (devis: Devis) => {
    setSelectedDevisDetail(devis);
    setShowDevisModal(true);
  };

  const handleChoisirDevis = async (devisId: string) => {
    // Note: La création de devis mock n'est plus nécessaire avec le nouveau système
    // Tous les devis sont désormais créés directement en base de données
    // Marquer visuellement le devis sélectionné immédiatement
    setDevis(prev => prev.map(d => ({ ...d, selected: d.id === devisId, refused: d.refused })) as any);
    setSelectedDevis(devisId);
    setShowConfirmModal(true);
  };

  // Fonction pour renvoyer un devis refusé
  const handleRenvoyerDevis = async (devisId: string) => {
    try {
      console.log('Renvoi du devis:', devisId);

      // Utiliser la fonction RPC atomique pour renvoyer le devis
      const { data: rpcResult, error: rpcError } = await supabase.rpc('envoyer_devis_selectionne', {
        p_devis_id: devisId,
        p_dossier_id: dossierId,
        p_admin_id: adminData.id
      });

      if (rpcError) {
        console.error('[AdminDetail] Erreur RPC renvoyer_devis_selectionne:', rpcError);
        throw rpcError;
      }

      console.log('[AdminDetail] Devis renvoyé avec succès:', rpcResult);

      // Mise à jour optimiste des états locaux
      setDevis(prev => prev.map(d => ({
        ...d,
        selected: d.id === devisId,
        refused: false,
        statut: d.id === devisId ? 'envoye' : d.statut
      })));

      setDossier(prev => ({
        ...prev,
        status: 'devis_envoye'
      }));

      // Fermer la modale
      setShowDevisModal(false);

      alert('Devis renvoyé avec succès ! L\'apporteur recevra une notification.');

    } catch (error) {
      console.error('[AdminDetail] Erreur lors du renvoi du devis:', error);
      alert('Erreur lors du renvoi du devis. Veuillez réessayer.');
    }
  };

  // ============================================================================
  // FONCTIONS D'AJOUT DE DOCUMENTS
  // ============================================================================

  /**
   * Upload d'un nouveau document pour le dossier
   */
  const handleUploadDocument = async () => {
    if (!newDocumentType || !newDocumentFile) {
      alert('Veuillez sélectionner un type de document et un fichier');
      return;
    }

    setIsUploadingDocument(true);

    try {
      console.log('[AdminDetail] Upload document:', {
        dossierId: dossier.id,
        type: newDocumentType,
        fileName: newDocumentFile.name,
        fileSize: newDocumentFile.size
      });

      // Créer un FormData pour l'upload
      const formData = new FormData();
      formData.append('dossierId', dossier.id);
      formData.append('documentType', newDocumentType);
      formData.append('file', newDocumentFile);

      const response = await fetch('/api/documents/upload', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Erreur lors de l\'upload');
      }

      const result = await response.json();
      console.log('[AdminDetail] Document uploadé avec succès:', result);

      // Recharger les documents du dossier
      await loadDossierData();

      // Fermer la modal et réinitialiser les états
      setShowDocumentModal(false);
      setNewDocumentType('');
      setNewDocumentFile(null);

      // Afficher un message de succès
      alert('Document ajouté avec succès !');

    } catch (error: any) {
      console.error('[AdminDetail] Erreur upload document:', error);
      alert(`Erreur lors de l'upload: ${error.message}`);
    } finally {
      setIsUploadingDocument(false);
    }
  };

  /**
   * Gestion du changement de fichier
   */
  const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file) {
      validateAndSetFile(file);
    }
  };

  /**
   * Validation et définition du fichier
   */
  const validateAndSetFile = (file: File) => {
    // Vérifier la taille du fichier (50MB max)
    const maxSize = 50 * 1024 * 1024; // 50MB
    if (file.size > maxSize) {
      alert('Le fichier est trop volumineux. Taille maximum: 50MB');
      return;
    }

    setNewDocumentFile(file);
  };

  /**
   * Gestion du glisser-déposer
   */
  const handleDragOver = (event: React.DragEvent) => {
    event.preventDefault();
    event.stopPropagation();
  };

  const handleDragEnter = (event: React.DragEvent) => {
    event.preventDefault();
    event.stopPropagation();
  };

  const handleDragLeave = (event: React.DragEvent) => {
    event.preventDefault();
    event.stopPropagation();
  };

  const handleDrop = (event: React.DragEvent) => {
    event.preventDefault();
    event.stopPropagation();

    const files = event.dataTransfer.files;
    if (files && files.length > 0) {
      const file = files[0];
      validateAndSetFile(file);
    }
  };

  // Fonction pour relancer l'extraction de documents
  const handleRefreshExtraction = async () => {
    setIsExtracting(true);
    setExtractionError(null);

    try {
      console.log('[AdminDetail] Relance de l\'extraction pour le dossier:', dossierId);

      // Appel à l'API route d'extraction
      const response = await fetch('/api/extraction/extract', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ dossierId }),
      });

      console.log('[AdminDetail] Réponse API:', {
        status: response.status,
        statusText: response.statusText,
        ok: response.ok
      });

      const result = await response.json();
      console.log('[AdminDetail] Résultat API:', result);

      if (!response.ok) {
        throw new Error(result.error || `Erreur API ${response.status}: ${response.statusText}`);
      }

      if (result.success && result.data && result.data.pret) {
        // L'extraction est considérée comme réussie si on a au moins les données du prêt
        // Les calculs peuvent être null si le tableau d'amortissement est manquant
        const hasCalculs = result.data.calculs !== null;

        setExtractionResult({
          success: true,
          message: hasCalculs
            ? 'Données extraites automatiquement avec succès'
            : 'Données extraites partiellement (tableau d\'amortissement non trouvé)',
          confidence: result.data.metadata?.confidence || 0,
          warnings: result.data.metadata?.warnings || [],
          sourcesUtilisees: result.data.metadata?.sourcesUtilisees || []
        });

        // Recharger les données du dossier
        await loadExtractionData();

        console.log('[AdminDetail] Extraction réussie avec confidence:', result.data.metadata?.confidence);

        // Vérifier les différences dans les données client et proposer la mise à jour
        await checkDataDifferences(result.data);

        // Si pas de calculs, afficher un avertissement
        if (!hasCalculs) {
          console.warn('[AdminDetail] Calculs métier non disponibles - tableau d\'amortissement non trouvé');
        }
      } else {
        throw new Error('Données d\'extraction incomplètes - aucune information de prêt trouvée');
      }

    } catch (error: unknown) {
      console.error('[AdminDetail] Erreur lors de l\'extraction:', error);
      const errorMessage = error instanceof Error ? error.message : 'Erreur inconnue lors de l\'extraction';
      setExtractionError(errorMessage);
    } finally {
      setIsExtracting(false);
    }
  };

  // Fonction pour comparer les données extraites avec les données actuelles
  const checkDataDifferences = async (extractedData: any) => {
    try {
      if (!extractedData || !extractedData.emprunteurs) {
        console.log('[AdminDetail] Pas de données emprunteur à comparer');
        return;
      }

      // Construire l'objet ExtractedClientData
      const clientData: ExtractedClientData = {
        principal: {
          civilite: extractedData.emprunteurs.principal?.civilite || null,
          nom: extractedData.emprunteurs.principal?.nom || null,
          prenom: extractedData.emprunteurs.principal?.prenom || null,
          nomNaissance: extractedData.emprunteurs.principal?.nomNaissance || null,
          dateNaissance: extractedData.emprunteurs.principal?.dateNaissance || null,
          fumeur: extractedData.emprunteurs.principal?.fumeur || null,
          categorieProfessionnelle: extractedData.emprunteurs.principal?.categorieProfessionnelle || null,
          profession: extractedData.emprunteurs.principal?.profession || null,
          email: extractedData.emprunteurs.principal?.email || null,
          telephone: extractedData.emprunteurs.principal?.telephone || null,
        },
        conjoint: extractedData.emprunteurs.conjoint ? {
          civilite: extractedData.emprunteurs.conjoint.civilite || null,
          nom: extractedData.emprunteurs.conjoint.nom || null,
          prenom: extractedData.emprunteurs.conjoint.prenom || null,
          nomNaissance: extractedData.emprunteurs.conjoint.nomNaissance || null,
          dateNaissance: extractedData.emprunteurs.conjoint.dateNaissance || null,
          fumeur: extractedData.emprunteurs.conjoint.fumeur || null,
          categorieProfessionnelle: extractedData.emprunteurs.conjoint.categorieProfessionnelle || null,
          profession: extractedData.emprunteurs.conjoint.profession || null,
          email: extractedData.emprunteurs.conjoint.email || null,
          telephone: extractedData.emprunteurs.conjoint.telephone || null,
        } : null,
        nombreAssures: extractedData.nombreAssures || (extractedData.emprunteurs.conjoint ? 2 : 1),
        champsManquants: extractedData.metadata?.champsManquants || []
      };

      // Récupérer les données actuelles du dossier
      const currentData = {
        civilite: dossier.client_civilite,
        client_nom: dossier.client_nom,
        client_prenom: dossier.client_prenom,
        nom_naissance: dossier.client_nom_naissance,
        client_date_naissance: dossier.client_date_naissance,
        client_fumeur: dossier.client_fumeur,
        categorie_professionnelle: dossier.client_categorie_professionnelle,
        client_email: dossier.client_email,
        client_telephone: dossier.client_telephone,
        conjoint_civilite: dossier.conjoint_civilite,
        conjoint_nom: dossier.conjoint_nom,
        conjoint_prenom: dossier.conjoint_prenom,
        conjoint_nom_naissance: dossier.conjoint_nom_naissance,
        conjoint_date_naissance: dossier.conjoint_date_naissance,
        conjoint_fumeur: dossier.conjoint_fumeur,
        conjoint_categorie_professionnelle: dossier.conjoint_categorie_professionnelle,
        conjoint_email: dossier.conjoint_email,
        conjoint_telephone: dossier.conjoint_telephone,
      };

      // Générer le rapport de différences
      const report = DataComparisonService.generateDiffReport(
        currentData,
        clientData,
        dossier.is_couple
      );

      console.log('[AdminDetail] Rapport de comparaison:', report);

      // Si des différences sont détectées, afficher la modale
      if (report.hasClientDifferences || report.hasTypeMismatch) {
        setExtractedClientData(clientData);
        setDiffReport(report);
        setShowComparisonModal(true);
      }

    } catch (error) {
      console.error('[AdminDetail] Erreur lors de la comparaison:', error);
    }
  };

  // Fonction pour appliquer les changements sélectionnés
  const handleApplyDataChanges = async (selectedFields: string[], updateType: boolean) => {
    try {
      if (!extractedClientData) {
        console.error('[AdminDetail] Pas de données extraites disponibles');
        return;
      }

      console.log('═══════════════════════════════════════════');
      console.log('[AdminDetail] 🔄 DÉBUT APPLICATION CHANGEMENTS');
      console.log('[AdminDetail] Champs sélectionnés:', selectedFields);
      console.log('[AdminDetail] Mise à jour type dossier:', updateType);
      console.log('[AdminDetail] Données extraites:', extractedClientData);
      console.log('[AdminDetail] Dossier ID:', dossierId);

      // Construire le payload de mise à jour
      const payload = DataComparisonService.buildUpdatePayload(
        selectedFields,
        extractedClientData,
        dossierId
      );

      console.log('[AdminDetail] 📦 Payload construit:', JSON.stringify(payload, null, 2));
      console.log('[AdminDetail] Nombre de clés dans payload:', Object.keys(payload).length);

      // Mettre à jour les données client
      if (Object.keys(payload).length > 1) { // Plus que juste dossier_id
        console.log('[AdminDetail] ✅ Mise à jour des données client...');
        try {
          const result = await ClientInfosService.upsertClientInfo(payload);
          console.log('[AdminDetail] ✅ Données client mises à jour avec succès:', result);
        } catch (clientError: any) {
          console.error('[AdminDetail] ❌ ERREUR mise à jour client:', clientError);
          console.error('[AdminDetail] Message erreur:', clientError?.message);
          console.error('[AdminDetail] Détails erreur:', clientError);
          throw new Error(`Erreur mise à jour client: ${clientError?.message || 'Inconnue'}`);
        }
      } else {
        console.log('[AdminDetail] ⏭️ Pas de données client à mettre à jour');
      }

      // Changer le type de dossier si demandé
      if (updateType && diffReport) {
        console.log('[AdminDetail] 🔄 Changement type dossier vers:', diffReport.detectedType);
        try {
          await DossiersService.changeDossierType(dossierId, diffReport.detectedType);
          console.log('[AdminDetail] ✅ Type de dossier changé avec succès');
        } catch (typeError: any) {
          console.error('[AdminDetail] ❌ ERREUR changement type:', typeError);
          console.error('[AdminDetail] Message erreur:', typeError?.message);
          console.error('[AdminDetail] Détails erreur:', typeError);
          throw new Error(`Erreur changement type: ${typeError?.message || 'Inconnue'}`);
        }
      } else {
        console.log('[AdminDetail] ⏭️ Pas de changement de type');
      }

      // Recharger les données
      console.log('[AdminDetail] 🔄 Rechargement des données...');
      await loadDossierData();
      console.log('[AdminDetail] ✅ Données rechargées');

      // Fermer la modale
      setShowComparisonModal(false);
      setDiffReport(null);
      setExtractedClientData(null);

      console.log('[AdminDetail] ✅ FIN APPLICATION CHANGEMENTS - SUCCÈS');
      console.log('═══════════════════════════════════════════');

      alert('Modifications appliquées avec succès !');

    } catch (error: any) {
      console.error('═══════════════════════════════════════════');
      console.error('[AdminDetail] ❌ ERREUR LORS DE L\'APPLICATION DES CHANGEMENTS');
      console.error('[AdminDetail] Type erreur:', typeof error);
      console.error('[AdminDetail] Message:', error?.message);
      console.error('[AdminDetail] Stack:', error?.stack);
      console.error('[AdminDetail] Objet complet:', error);
      console.error('═══════════════════════════════════════════');
      throw error;
    }
  };

  // Fonction pour actualiser les devis
  const handleRefreshDevis = async () => {
    setIsRefreshingDevis(true);

    try {
      console.log('[AdminDetail] Actualisation des devis pour le dossier:', dossierId);

      // Appel à l'API Exade avec les données extraites
      const response = await fetch('/api/exade/tarifs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          clientInfo: dossier,
          pretData: dossier.infos_pret
        })
      });

      const payload = await response.json();

      if (!response.ok) {
        throw new Error(payload?.error || 'Erreur lors de la génération des devis');
      }

      const tarifs: any[] = payload?.tarifs || [];

      if (tarifs.length > 0) {
        // Supprimer les anciens devis
        await supabase
          .from('devis')
          .delete()
          .eq('dossier_id', dossierId);

        // Créer les nouveaux devis
        const devisToInsert = tarifs.map((t: any, index: number) => ({
          dossier_id: dossierId,
          numero_devis: `EX-${Date.now()}-${index + 1}`,
          statut: 'en_attente',
          donnees_devis: t,
          date_generation: new Date().toISOString(),
          date_expiration: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
        }));

        await DevisService.createMultipleDevis(devisToInsert as any);

        // Recharger les devis
        await loadDossierData();

        console.log('[AdminDetail] Devis actualisés avec succès');
      } else {
        console.warn('[AdminDetail] Aucun devis généré');
      }

    } catch (error) {
      console.error('[AdminDetail] Erreur lors de l\'actualisation des devis:', error);
      alert('Erreur lors de l\'actualisation des devis. Veuillez réessayer.');
    } finally {
      setIsRefreshingDevis(false);
    }
  };

  // Fonction pour charger les données d'extraction
  const loadExtractionData = async () => {
    try {
      // Charger les données de prêt depuis la base de données
      const { data: pretData, error } = await supabase
        .from('pret_data')
        .select('*')
        .eq('dossier_id', dossierId)
        .single();

      if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
        console.error('[AdminDetail] Erreur chargement pret_data:', error);
        return;
      }

      if (pretData) {
        // Mettre à jour les informations du prêt avec les données extraites
        setDossier(prev => ({
          ...prev,
          infos_pret: {
            ...prev.infos_pret,
            banque_preteuse: pretData.banque_preteuse || prev.infos_pret?.banque_preteuse || '',
            montant_capital: pretData.montant_capital || prev.infos_pret?.montant_capital || 0,
            duree_mois: pretData.duree_mois || prev.infos_pret?.duree_mois || 0,
            type_pret: pretData.type_pret || prev.infos_pret?.type_pret || '',
            cout_assurance_banque: pretData.cout_assurance_banque || prev.infos_pret?.cout_assurance_banque || null,
            // Données supplémentaires extraites par l'IA
            date_debut: pretData.date_debut,
            date_fin: pretData.date_fin,
            taux_nominal: pretData.taux_nominal,
            date_debut_effective: pretData.date_debut_effective,
            duree_restante_mois: pretData.duree_restante_mois,
            capital_restant_du: pretData.capital_restant_du
          }
        }));

        // Charger les activités d'extraction pour afficher le statut
        const { data: activities } = await supabase
          .from('activities')
          .select('*')
          .eq('dossier_id', dossierId)
          .in('activity_type', ['extraction_automatique', 'extraction_echouee'])
          .order('created_at', { ascending: false })
          .limit(1);

        if (activities && activities.length > 0) {
          const lastActivity = activities[0];
          if (lastActivity.activity_type === 'extraction_automatique') {
            setExtractionResult({
              success: true,
              message: lastActivity.activity_description,
              confidence: lastActivity.activity_data?.confidence || 0.8,
              warnings: lastActivity.activity_data?.warnings || [],
              sourcesUtilisees: lastActivity.activity_data?.sources_utilisees || []
            });
          } else if (lastActivity.activity_type === 'extraction_echouee') {
            setExtractionError(lastActivity.activity_data?.error || 'Extraction automatique échouée');
          }
        }
      }
    } catch (error) {
      console.error('[AdminDetail] Erreur chargement données extraction:', error);
    }
  };

  // ============================================================================
  // SUPABASE INTEGRATION - WORKFLOW COMPLET DE GESTION DES DEVIS
  // ============================================================================

  /**
   * FONCTION CRITIQUE : ENVOI D'UN DEVIS SÉLECTIONNÉ
   * 
   * Cette fonction orchestre le workflow complet :
   * 1. Marque le devis comme sélectionné (selected = true)
   * 2. Démarque tous les autres devis du dossier (selected = false)
   * 3. Change le statut du dossier : 'nouveau' -> 'devis_envoye'
   * 4. Met à jour les étapes de processus
   * 5. Crée une notification pour l'apporteur
   * 6. Envoie un email automatique
   * 7. Synchronise toutes les interfaces en temps réel
   * 
   * Après cette action :
   * - Le devis apparaît dans la vue d'ensemble admin
   * - L'apporteur reçoit une notification
   * - L'interface apporteur affiche le devis pour validation client
   * - Le client peut valider ou refuser via l'apporteur
   */
  const confirmEnvoiDevis = async () => {
    try {
      console.log('Envoi du devis sélectionné:', selectedDevis);

      // Utiliser la fonction RPC atomique pour l'envoi de devis
      const { data: rpcResult, error: rpcError } = await supabase.rpc('envoyer_devis_selectionne', {
        p_devis_id: selectedDevis,
        p_dossier_id: dossierId,
        p_admin_id: adminData.id
      });

      if (rpcError) {
        console.error('[AdminDetail] Erreur RPC envoyer_devis_selectionne:', rpcError);
        throw rpcError;
      }

      console.log('[AdminDetail] Devis envoyé avec succès:', rpcResult);

      // Mise à jour optimiste des états locaux
      setDevis(prev => prev.map(d => ({
        ...d,
        selected: d.id === selectedDevis,
        refused: false,
        statut: d.id === selectedDevis ? 'envoye' : d.statut
      })));

      setDossier(prev => ({
        ...prev,
        status: 'devis_envoye'
      }));

      // Refetch dossier + devis pour aligner l'état (selected via devis_selectionne_id)
      try {
        const refreshed = await DossiersService.getDossierById(dossierId);
        const selectedId = refreshed?.devis_selectionne_id || null;
        const freshDevis = (refreshed?.devis || []).map((d: any) => ({
          ...d,
          selected: selectedId ? d.id === selectedId : false,
          refused: d.statut === 'refuse',
        }));
        setDossier(prev => ({ ...prev, status: 'devis_envoye' }));
        setDevis(freshDevis);
      } catch (e) {
        console.warn('[AdminDetail] refetch après envoi devis échoué', e);
      }

      setShowConfirmModal(false);
      setSelectedDevis(null);

      console.log('✅ Devis envoyé avec succès - L\'apporteur va recevoir une notification');
    } catch (error) {
      console.error('❌ Erreur lors de l\'envoi du devis:', error);
      alert('Erreur lors de l\'envoi du devis');
    }
  };

  const handleFinaliser = () => {
    setShowFinalizeModal(true);
  };

  /**
   * FINALISATION D'UN DOSSIER VALIDÉ
   * 
   * Cette fonction marque le dossier comme terminé :
   * 1. Change le statut : 'valide' -> 'finalise'
   * 2. Enregistre la date de finalisation
   * 3. Débloque la saisie des frais de gestion pour l'apporteur
   * 4. Archive les documents si nécessaire
   * 5. Crée les notifications finales
   * 
   * Cette action n'est possible qu'après validation client/apporteur
   */
  const confirmFinalisation = async () => {
    try {
      console.log('Finalisation du dossier:', dossier.id);

      // Persistance: statut finalisé côté DB
      await DossiersService.updateDossier(dossierId, { statut: 'finalise' as any });

      // Créer une activité pour l'apporteur
      if (dossier.apporteur_id) {
        await supabase
          .from('activities')
          .insert({
            user_id: dossier.apporteur_id,
            dossier_id: dossierId,
            activity_type: 'dossier_finalise',
            activity_title: 'Dossier finalisé',
            activity_description: `Le dossier ${dossier.numero_dossier} a été finalisé avec succès.`,
            activity_data: {
              dossier_id: dossierId,
              numero_dossier: dossier.numero_dossier,
              action: 'dossier_finalise'
            }
          });
      }

      // Créer une notification pour l'apporteur
      if (dossier.apporteur_id) {
        await supabase
          .from('notifications')
          .insert({
            user_id: dossier.apporteur_id,
            title: 'Dossier finalisé avec succès',
            message: `Félicitations ! Votre dossier ${dossier.numero_dossier} a été finalisé avec succès.`,
            type: 'success',
            data: { dossier_id: dossierId }
          });
      }

      // Mise à jour locale
      setDossier(prev => ({
        ...prev,
        status: 'finalise',
        date_finalisation: new Date().toISOString()
      }));

      setShowFinalizeModal(false);
      console.log('✅ Dossier finalisé avec succès');
    } catch (error) {
      console.error('❌ Erreur lors de la finalisation:', error);
      alert('Erreur lors de la finalisation');
    }
  };

  const handleDownloadDocument = (url: string, nom: string) => {
    console.log('Téléchargement du document:', nom);
    window.open(url, '_blank');
  };

  // State pour le visualiseur de documents
  const [showDocModal, setShowDocModal] = useState(false);
  const [currentDocUrl, setCurrentDocUrl] = useState<string | null>(null);
  const [currentDocTitle, setCurrentDocTitle] = useState('');
  const [currentDocType, setCurrentDocType] = useState('');
  const [currentDocId, setCurrentDocId] = useState<string | null>(null);

  const handleViewDocument = (url: string, title: string = 'Document', type: string = '', id: string | null = null) => {
    console.log('Visualisation du document:', { url, title, type, id });
    setCurrentDocUrl(url);
    setCurrentDocTitle(title);
    setCurrentDocType(type);
    setCurrentDocId(id);
    setShowDocModal(true);
  };

  /**
   * Suppression d'un document
   */
  const handleDeleteDocument = async (documentId: string, documentName: string) => {
    try {
      console.log('[AdminDetail] Suppression du document:', documentId);

      const response = await fetch(`/api/documents/delete?documentId=${documentId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Erreur lors de la suppression');
      }

      const result = await response.json();
      console.log('[AdminDetail] Document supprimé:', result);

      // Fermer la modale
      setShowDeleteDocModal(false);
      setDocumentToDelete(null);

      // Recharger les données du dossier
      await loadDossierData();

      // Afficher un message de succès
      alert('Document supprimé avec succès');

    } catch (error: unknown) {
      console.error('[AdminDetail] Erreur suppression document:', error);
      const errorMsg = error instanceof Error ? error.message : 'Erreur inconnue';
      alert(`Erreur lors de la suppression: ${errorMsg}`);
    }
  };

  /**
   * Ouvrir la modale de suppression
   */
  const openDeleteModal = (documentId: string, documentName: string) => {
    setDocumentToDelete(documentId);
    setShowDeleteDocModal(true);
  };

  if (!isInitialized) {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#335FAD]"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      {/* Header - SANS AdminHeader */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="px-4 sm:px-8 py-6 max-w-7xl mx-auto">
          <div className="flex items-center space-x-4 mb-6">
            <button
              onClick={() => router.back()}
              className="w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg flex items-center justify-center transition-colors cursor-pointer"
            >
              <i className="ri-arrow-left-line text-gray-600 dark:text-gray-300"></i>
            </button>
            <div>
              <div className="flex items-center space-x-3">
                <h1 className="text-2xl sm:text-3xl font-light text-gray-900 dark:text-white">
                  Dossier <span className="font-medium text-[#335FAD] dark:text-[#335FAD]/80">{dossier.numero_dossier}</span>
                </h1>
                {/* BADGE STATUT - Synchronisé en temps réel avec Supabase */}
                {getStatusBadge(dossier.status)}
              </div>
              <p className="text-gray-600 dark:text-gray-400 mt-1">
                {dossier.client_prenom} {dossier.client_nom} • Géré par {dossier.apporteur_prenom} {dossier.apporteur_nom}
              </p>
            </div>
          </div>

          {/* Navigation tabs avec scroll horizontal responsive */}
          <div className="border-b border-gray-200 dark:border-gray-700">
            <div className="flex space-x-8 overflow-x-auto scrollbar-hide pb-2">
              <button
                onClick={() => setActiveTab('overview')}
                className={`pb-4 px-1 border-b-2 font-medium text-sm transition-colors cursor-pointer whitespace-nowrap ${activeTab === 'overview'
                  ? 'border-[#335FAD] text-[#335FAD] dark:text-[#335FAD]/80'
                  : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'
                  }`}
              >
                Vue d&apos;ensemble
              </button>
              <button
                onClick={() => setActiveTab('client')}
                className={`pb-4 px-1 border-b-2 font-medium text-sm transition-colors cursor-pointer whitespace-nowrap ${activeTab === 'client'
                  ? 'border-[#335FAD] text-[#335FAD] dark:text-[#335FAD]/80'
                  : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'
                  }`}
              >
                Données client
              </button>
              <button
                onClick={() => setActiveTab('pret')}
                className={`pb-4 px-1 border-b-2 font-medium text-sm transition-colors cursor-pointer whitespace-nowrap ${activeTab === 'pret'
                  ? 'border-[#335FAD] text-[#335FAD] dark:text-[#335FAD]/80'
                  : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'
                  }`}
              >
                Infos du prêt
              </button>
              <button
                onClick={() => setActiveTab('devis')}
                className={`pb-4 px-1 border-b-2 font-medium text-sm transition-colors cursor-pointer whitespace-nowrap ${activeTab === 'devis'
                  ? 'border-[#335FAD] text-[#335FAD] dark:text-[#335FAD]/80'
                  : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'
                  }`}
              >
                Devis comparatif
              </button>
              <button
                onClick={() => setActiveTab('reglages')}
                className={`pb-4 px-1 border-b-2 font-medium text-sm transition-colors cursor-pointer whitespace-nowrap ${activeTab === 'reglages'
                  ? 'border-[#335FAD] text-[#335FAD] dark:text-[#335FAD]/80'
                  : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'
                  }`}
              >
                Réglages
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Contenu principal */}
      <main className="px-4 sm:px-8 py-6 max-w-7xl mx-auto">
        {activeTab === 'overview' && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Informations principales */}
            <div className="lg:col-span-2 space-y-6">
              {/* Détails du dossier */}
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                  Détails du dossier
                </h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Type de dossier
                    </label>
                    <p className="text-gray-900 dark:text-white font-medium">
                      {dossier.is_couple ? 'Couple' : 'Seul'}
                    </p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Type d'assurance
                    </label>
                    <p className="text-gray-900 dark:text-white">{dossier.type_assurance}</p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Montant du capital
                    </label>
                    <p className="text-gray-900 dark:text-white font-medium">
                      {formatCurrency(dossier.montant_capital)}
                    </p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Durée du prêt
                    </label>
                    <p className="text-gray-900 dark:text-white">{dossier.duree_pret} ans</p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Date de soumission
                    </label>
                    <p className="text-gray-900 dark:text-white">{formatDate(dossier.date_soumission)}</p>
                  </div>
                </div>
              </div>

              {/* ============================================================================ */}
              {/* SECTION CRITIQUE : DEVIS SÉLECTIONNÉ - TRAÇABILITÉ COMPLÈTE */}
              {/* ============================================================================ */}

              {/* 
              FONCTIONNEMENT COMPLET DE CETTE SECTION :
              
              1. SÉLECTION ADMIN (statut: nouveau -> devis_envoye)
                 - Admin sélectionne un devis via confirmEnvoiDevis()
                 - DB: UPDATE devis SET selected = true WHERE id = devisId
                 - DB: UPDATE dossiers SET status = 'devis_envoye'
                 - Cette card devient visible immédiatement
                 - Notification envoyée à l'apporteur
              
              2. VALIDATION CLIENT/APPORTEUR (statut: devis_envoye -> valide)
                 - Client valide via interface apporteur
                 - DB: UPDATE dossiers SET status = 'valide', date_validation = NOW()
                 - Card reste visible avec thème vert
                 - Bouton "Marquer comme finalisé" apparaît
              
              3. REFUS CLIENT/APPORTEUR (statut: devis_envoye -> refuse)
                 - Client refuse via interface apporteur
                 - DB: UPDATE dossiers SET status = 'refuse', commentaire_refus = '...'
                 - Card reste visible avec thème rouge
                 - Bouton "Changer le devis" permet de sélectionner un autre devis
              
              4. FINALISATION ADMIN (statut: valide -> finalise)
                 - Admin finalise via confirmFinalisation()
                 - DB: UPDATE dossiers SET status = 'finalise', date_finalisation = NOW()
                 - Card reste visible avec thème violet
                 - Processus terminé, traçabilité complète conservée
              
              La card reste TOUJOURS visible une fois un devis sélectionné,
              permettant de voir en permanence quel devis a été choisi,
              même après finalisation du dossier.
              */}
              {(dossier.status === 'devis_envoye' || dossier.status === 'valide' || dossier.status === 'refuse' || dossier.status === 'finalise') && devis.find(d => d.selected) && (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-lg font-medium text-gray-900 dark:text-white flex items-center">
                      <i className="ri-check-line text-green-500 mr-2"></i>
                      Devis sélectionné
                    </h3>
                    <button
                      onClick={() => setActiveTab('devis')}
                      className="text-[#335FAD] dark:text-[#335FAD]/80 hover:text-[#335FAD]/70 dark:hover:text-[#335FAD]/90 text-sm font-medium cursor-pointer"
                    >
                      Voir tous les devis
                    </button>
                  </div>

                  {(() => {
                    const selectedDevis = devis.find(d => d.selected);
                    if (!selectedDevis) return null;

                    const economieCalculee = calculateEconomie(selectedDevis.cout_total, dossier.infos_pret.cout_assurance_banque);

                    // THEMING DYNAMIQUE SELON LE STATUT - Reflète l'état du workflow
                    const getDevisTheme = () => {
                      if (dossier.status === 'refuse') {
                        return {
                          bgClass: 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-700',
                          badgeClass: 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400',
                          badgeText: 'Devis refusé par le client',
                          titleClass: 'text-red-900 dark:text-red-200',
                          subtitleClass: 'text-red-700 dark:text-red-300',
                          labelClass: 'text-red-600 dark:text-red-400',
                          valueClass: 'text-red-900 dark:text-red-200',
                          borderColor: 'border-red-200 dark:border-red-700'
                        };
                      } else if (dossier.status === 'finalise') {
                        return {
                          bgClass: 'bg-purple-50 dark:bg-purple-900/20 border-purple-200 dark:border-purple-800',
                          badgeClass: 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400',
                          badgeText: 'Contrat finalisé',
                          titleClass: 'text-purple-900 dark:text-purple-200',
                          subtitleClass: 'text-purple-700 dark:text-purple-300',
                          labelClass: 'text-purple-600 dark:text-purple-400',
                          valueClass: 'text-purple-900 dark:text-purple-200',
                          borderColor: 'border-purple-200 dark:border-purple-700'
                        };
                      } else {
                        return {
                          bgClass: 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800',
                          badgeClass: 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400',
                          badgeText: 'Devis sélectionné',
                          titleClass: 'text-green-900 dark:text-green-200',
                          subtitleClass: 'text-green-700 dark:text-green-300',
                          labelClass: 'text-green-600 dark:text-green-400',
                          valueClass: 'text-green-900 dark:text-green-200',
                          borderColor: 'border-green-200 dark:border-green-700'
                        };
                      }
                    };

                    const theme = getDevisTheme();

                    return (
                      <div className={`${theme.bgClass} border rounded-lg p-4`}>
                        <div className="flex items-start justify-between mb-3">
                          <div>
                            <h4 className={`text-lg font-medium ${theme.titleClass}`}>
                              {selectedDevis.compagnie}
                            </h4>
                            <p className={`text-sm ${theme.subtitleClass}`}>
                              {selectedDevis.produit}
                            </p>
                            <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium mt-2 ${theme.badgeClass}`}>
                              {theme.badgeText}
                            </span>
                          </div>
                          <button
                            onClick={() => handleDevisRowClick(selectedDevis)}
                            className={`${theme.labelClass} hover:opacity-75 text-sm font-medium cursor-pointer`}
                          >
                            Voir détails
                          </button>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                          <div>
                            <label className={`block text-xs font-medium ${theme.labelClass} mb-1`}>
                              Coût mensuel
                            </label>
                            <p className={`${theme.valueClass} font-medium`}>
                              {formatCurrency(selectedDevis.cout_mensuel)}
                            </p>
                          </div>
                          <div>
                            <label className={`block text-xs font-medium ${theme.labelClass} mb-1`}>
                              Coût total
                            </label>
                            <p className={`${theme.valueClass} font-medium`}>
                              {formatCurrency(selectedDevis.cout_total)}
                            </p>
                          </div>
                          <div>
                            <label className={`block text-xs font-medium ${theme.labelClass} mb-1`}>
                              Économie Estimée
                            </label>
                            <p className={`font-medium ${(economieCalculee?.economie || selectedDevis.economie_estimee || 0) > 0
                              ? 'text-green-600 dark:text-green-400'
                              : 'text-red-600 dark:text-red-400'
                              }`}>
                              {formatCurrency(economieCalculee?.economie || selectedDevis.economie_estimee || 0)}
                              {economieCalculee && (
                                <span className="text-xs ml-1">
                                  ({economieCalculee.pourcentage.toFixed(1)}%)
                                </span>
                              )}
                            </p>
                          </div>
                        </div>

                        {/* Motif de refus quand refusé */}
                        {dossier.status === 'refuse' && (
                          <div className={`mt-3 pt-3 border-t ${theme.borderColor}`}>
                            <label className={`block text-xs font-medium ${theme.labelClass} mb-1`}>
                              Motif du refus
                            </label>
                            <p className={`text-sm ${theme.valueClass}`}>
                              {selectedDevis.motif_refus
                                || (selectedDevis as any)?.commentaire_refus
                                || (selectedDevis as any)?.donnees_devis?.motif_refus
                                || (dossier as any)?.commentaire
                                || (dossier as any)?.commentaire_refus
                                || '—'}
                            </p>
                          </div>
                        )}

                        <div className={`mt-3 pt-3 border-t ${theme.borderColor}`}>
                          <label className={`block text-xs font-medium ${theme.labelClass} mb-1`}>
                            Formalités médicales
                          </label>
                          <p className={`text-sm ${theme.valueClass}`}>
                            {(selectedDevis.formalites_medicales || []).join(', ')}
                          </p>
                        </div>
                      </div>
                    );
                  })()}
                </div>
              )}

              {/* Commentaire de l'apporteur */}
              {dossier.commentaire_apporteur && (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                  <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                    Commentaire de l'apporteur
                  </h3>
                  <div className="bg-[#335FAD]/5 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/80 rounded-lg p-4">
                    <div className="flex items-start space-x-3">
                      <i className="ri-chat-quote-line text-[#335FAD] dark:text-[#335FAD] text-xl mt-0.5"></i>
                      <div>
                        <p className="text-[#335FAD] dark:text-[#335FAD]/80 leading-relaxed">
                          {dossier.commentaire_apporteur}
                        </p>
                        <p className="text-[#335FAD] dark:text-[#335FAD] text-sm mt-2">
                          — {dossier.apporteur_prenom} {dossier.apporteur_nom}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* ============================================================================ */}
              {/* WORKFLOW COMPLET - ACTIONS SELON LE STATUT DU DOSSIER */}
              {/* ============================================================================ */}

              {/* STATUT: NOUVEAU - Dossier vient d'arriver, admin doit sélectionner un devis */}
              {dossier.status === 'nouveau' && (
                <div className="bg-[#335FAD]/5 dark:bg-[#335FAD]/20 rounded-xl border border-[#335FAD]/20 dark:border-[#335FAD]/80 p-6">
                  <div className="flex items-start space-x-3">
                    <i className="ri-information-line text-[#335FAD] dark:text-[#335FAD] text-xl mt-0.5"></i>
                    <div className="flex-1">
                      <h4 className="text-lg font-medium text-[#335FAD] dark:text-[#335FAD]/80 mb-2">
                        Nouveau dossier à traiter
                      </h4>
                      <p className="text-[#335FAD]/80 dark:text-[#335FAD]/80 mb-4">
                        Ce dossier est en attente de validation. Vérifiez les données et l'analyse IA, puis consultez les devis pour sélectionner la meilleure offre.
                      </p>
                      <button
                        onClick={() => setActiveTab('devis')}
                        className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                      >
                        Voir les devis
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* STATUT: DEVIS ENVOYÉ - Devis sélectionné et envoyé à l'apporteur */}
              {(dossier.status === 'devis_envoye' || (dossier.status as any) === 'devis_disponible') && (
                <div className="bg-orange-50 dark:bg-orange-900/20 rounded-xl border border-orange-200 dark:border-orange-800 p-6">
                  <div className="flex items-start space-x-3">
                    <i className="ri-send-plane-line text-orange-600 dark:text-orange-400 text-xl mt-0.5"></i>
                    <div className="flex-1">
                      <h4 className="text-lg font-medium text-orange-900 dark:text-orange-200 mb-2">
                        Devis envoyé à l&apos;apporteur
                      </h4>
                      <p className="text-orange-700 dark:text-orange-300 mb-4">
                        Le devis sélectionné a été envoyé à l'apporteur. En attente de la réponse du client.
                      </p>
                      {/* Afficher le devis envoyé */}
                      {Array.isArray(devis) && devis.some((d: any) => d.statut === 'envoye') && (
                        <div className="bg-white dark:bg-gray-800 rounded-lg p-4 border border-orange-200 dark:border-orange-700 mb-4">
                          <p className="text-sm font-medium text-gray-900 dark:text-white mb-2">Devis envoyé :</p>
                          <div className="divide-y divide-orange-100 dark:divide-orange-800">
                            {devis.filter((d: any) => d.statut === 'envoye').map((d: any) => (
                              <div
                                key={d.id}
                                className="py-2 cursor-pointer hover:bg-orange-50/60 dark:hover:bg-orange-900/10 rounded px-2"
                                onClick={() => handleDevisRowClick(d as any)}
                              >
                                <div className="flex items-start justify-between">
                                  <div>
                                    <p className="text-sm text-gray-900 dark:text-white font-medium">
                                      {d.numero_devis || d.id}
                                    </p>
                                    <p className="text-xs text-orange-700 dark:text-orange-300 mt-1">
                                      Envoyé le {d.date_envoi && formatDate(d.date_envoi)}
                                    </p>
                                    <p className="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                      Compagnie: {(d.donnees_devis as any)?.compagnie || 'Assureur'}
                                    </p>
                                  </div>
                                  <span className="text-xs text-orange-600 dark:text-orange-400">Voir détails</span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* STATUT: VALIDÉ - L'apporteur/client a accepté, admin peut finaliser */}
              {dossier.status === 'valide' && (
                <div className="bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-800 p-6">
                  <div className="flex items-start justify-between">
                    <div className="flex items-start space-x-3">
                      <i className="ri-check-line text-green-600 dark:text-green-400 text-xl mt-0.5"></i>
                      <div>
                        <h4 className="text-lg font-medium text-green-900 dark:text-green-200 mb-2">
                          Dossier validé par l&apos;apporteur
                        </h4>
                        <p className="text-green-700 dark:text-green-300">
                          Validé le {dossier.date_validation && formatDate(dossier.date_validation)}
                        </p>
                        {Array.isArray(devis) && devis.some((d: any) => d.statut === 'accepte') && (
                          <div className="bg-white dark:bg-gray-800 rounded-lg p-4 border border-green-200 dark:border-green-700 mt-4">
                            <p className="text-sm font-medium text-gray-900 dark:text-white mb-2">Devis validé :</p>
                            <ul className="text-sm text-gray-700 dark:text-gray-300 list-disc pl-5">
                              {devis.filter((d: any) => d.statut === 'accepte').map((d: any) => (
                                <li key={d.id} className="cursor-pointer" onClick={() => handleDevisRowClick(d as any)}>
                                  {d.numero_devis || d.id}
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}
                      </div>
                    </div>
                    <button
                      onClick={handleFinaliser}
                      className="bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                    >
                      Marquer comme finalisé
                    </button>
                  </div>
                </div>
              )}

              {/* STATUT: REFUSÉ - L'apporteur/client a refusé, possibilité de changer de devis */}
              {dossier.status === 'refuse' && (
                <div className="bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-200 dark:border-red-800 p-6">
                  <div className="flex items-start space-x-3">
                    <i className="ri-close-line text-red-600 dark:text-red-400 text-xl mt-0.5"></i>
                    <div className="flex-1">
                      <h4 className="text-lg font-medium text-red-900 dark:text-red-200 mb-2">
                        Dossier refusé par l&apos;apporteur
                      </h4>
                      <p className="text-red-700 dark:text-red-300 mb-2">
                        Refusé le {dossier.date_refus && formatDate(dossier.date_refus)}
                      </p>
                      {/* Lister les devis refusés */}
                      {Array.isArray(devis) && devis.some((d: any) => d.statut === 'refuse') && (
                        <div className="bg-white dark:bg-gray-800 rounded-lg p-4 border border-red-200 dark:border-red-700 mb-4">
                          <p className="text-sm font-medium text-gray-900 dark:text-white mb-2">Devis refusé(s) :</p>
                          <div className="divide-y divide-red-100 dark:divide-red-800">
                            {devis.filter((d: any) => d.statut === 'refuse').map((d: any) => (
                              <div
                                key={d.id}
                                className="py-2 cursor-pointer hover:bg-red-50/60 dark:hover:bg-red-900/10 rounded px-2"
                                onClick={() => handleDevisRowClick(d as any)}
                              >
                                <div className="flex items-start justify-between">
                                  <div>
                                    <p className="text-sm text-gray-900 dark:text-white font-medium">
                                      {d.numero_devis || d.id}
                                    </p>
                                    <p className="text-xs text-red-700 dark:text-red-300 mt-1">
                                      motif : {d.motif_refus
                                        || (d as any)?.donnees_devis?.motif_refus
                                        || (d as any)?.commentaire_refus
                                        || (dossier as any)?.commentaire
                                        || (dossier as any)?.commentaire_refus
                                        || '—'}
                                    </p>
                                  </div>
                                  <span className="text-xs text-red-600 dark:text-red-400">Voir détails</span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                      {/* BOUTON CRITIQUE: Permet de sélectionner un autre devis après refus */}
                      <button
                        onClick={() => setActiveTab('devis')}
                        className="bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                      >
                        <i className="ri-refresh-line mr-2"></i>
                        Changer le devis
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* STATUT: FINALISÉ - Processus terminé, traçabilité complète */}
              {dossier.status === 'finalise' && (
                <div className="bg-purple-50 dark:bg-purple-900/20 rounded-xl border border-purple-200 dark:border-purple-800 p-6">
                  <div className="flex items-start space-x-3">
                    <i className="ri-checkbox-circle-line text-purple-600 dark:text-purple-400 text-xl mt-0.5"></i>
                    <div>
                      <h4 className="text-lg font-medium text-purple-900 dark:text-purple-200 mb-2">
                        Dossier finalisé
                      </h4>
                      <p className="text-purple-700 dark:text-purple-300">
                        Finalisé le {dossier.date_finalisation && formatDate(dossier.date_finalisation)}
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Sidebar */}
            <div className="space-y-6">
              {/* Informations client */}
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                  Informations client
                </h3>
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Nom complet
                    </label>
                    <p className="text-gray-900 dark:text-white">
                      {dossier.client_civilite || ''} {dossier.client_prenom} {dossier.client_nom}
                    </p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Email
                    </label>
                    <p className="text-gray-900 dark:text-white">{dossier.client_email}</p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Téléphone
                    </label>
                    <p className="text-gray-900 dark:text-white">{dossier.client_telephone}</p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Date de naissance
                    </label>
                    <p className="text-gray-900 dark:text-white">
                      {new Date(dossier.client_date_naissance).toLocaleDateString('fr-FR')}
                    </p>
                  </div>
                </div>
              </div>

              {/* Informations conjoint (si dossier couple) */}
              {dossier.is_couple && (dossier.conjoint_nom || dossier.conjoint_prenom) && (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                  <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                    Informations conjoint
                  </h3>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Nom complet
                      </label>
                      <p className="text-gray-900 dark:text-white">
                        {dossier.conjoint_civilite || ''} {dossier.conjoint_prenom} {dossier.conjoint_nom}
                      </p>
                    </div>
                    {dossier.conjoint_email && (
                      <div>
                        <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                          Email
                        </label>
                        <p className="text-gray-900 dark:text-white">{dossier.conjoint_email}</p>
                      </div>
                    )}
                    {dossier.conjoint_telephone && (
                      <div>
                        <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                          Téléphone
                        </label>
                        <p className="text-gray-900 dark:text-white">{dossier.conjoint_telephone}</p>
                      </div>
                    )}
                    {dossier.conjoint_date_naissance && (
                      <div>
                        <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                          Date de naissance
                        </label>
                        <p className="text-gray-900 dark:text-white">
                          {new Date(dossier.conjoint_date_naissance).toLocaleDateString('fr-FR')}
                        </p>
                      </div>
                    )}
                    {(dossier.conjoint_categorie_professionnelle !== null && dossier.conjoint_categorie_professionnelle !== undefined && dossier.conjoint_categorie_professionnelle > 0) && (
                      <div>
                        <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                          Catégorie professionnelle
                        </label>
                        <p className="text-gray-900 dark:text-white">{getCategoryLabel(dossier.conjoint_categorie_professionnelle)}</p>
                      </div>
                    )}
                    <div>
                      <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Fumeur
                      </label>
                      <p className="text-gray-900 dark:text-white">
                        {dossier.conjoint_fumeur ? 'Oui' : 'Non'}
                      </p>
                    </div>
                  </div>
                </div>
              )}

              {/* Informations apporteur */}
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                  Apporteur d'affaires
                </h3>
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Nom complet
                    </label>
                    <p className="text-gray-900 dark:text-white">
                      {dossier.apporteur_prenom} {dossier.apporteur_nom}
                    </p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                      Email
                    </label>
                    <p className="text-gray-900 dark:text-white">{dossier.apporteur_email}</p>
                  </div>
                  <button
                    onClick={() => router.push(`/admin/apporteurs/${dossier.apporteur_id}`)}
                    className="w-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                  >
                    Voir le profil complet
                  </button>
                </div>
              </div>

              {/* Historique des devis */}
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                  <i className="ri-history-line mr-2"></i>
                  Historique des devis
                </h3>

                {devisHistory && devisHistory.length > 0 ? (
                  <div className="space-y-3">
                    {devisHistory.map((d, index) => (
                      <div
                        key={`${d.devis_id}-${d.action_type}-${index}`}
                        className={`p-4 rounded-lg border transition-colors cursor-pointer ${d.action_type === 'accepte'
                          ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-700'
                          : d.action_type === 'renvoye'
                            ? 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-700'
                            : d.action_type === 'refuse'
                              ? 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-700'
                              : 'bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600'
                          }`}
                        onClick={() => {
                          // Trouver le devis correspondant dans la liste des devis pour la modale
                          const devisForModal = devis.find(devisItem => devisItem.id === d.devis_id);
                          if (devisForModal) {
                            setSelectedDevisDetail(devisForModal);
                            setShowDevisModal(true);
                          }
                        }}
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex items-center space-x-3">
                            <div className={`w-3 h-3 rounded-full ${d.action_type === 'accepte'
                              ? 'bg-green-500'
                              : d.action_type === 'renvoye'
                                ? 'bg-orange-500'
                                : d.action_type === 'refuse'
                                  ? 'bg-red-500'
                                  : 'bg-gray-400'
                              }`}></div>
                            <div>
                              <p className="font-medium text-gray-900 dark:text-white">
                                {d.compagnie} - {d.numero_devis}
                              </p>
                              <p className="text-sm text-gray-500 dark:text-gray-400">
                                {formatCurrency(d.cout_mensuel)}/mois • {formatCurrency(d.cout_total)} total
                              </p>
                              {d.action_date && (
                                <p className="text-xs text-gray-400 dark:text-gray-500">
                                  {d.action_type === 'renvoye' ? 'Renvoyé le' :
                                    d.action_type === 'refuse' ? 'Refusé le' :
                                      d.action_type === 'accepte' ? 'Accepté le' : 'Le'} {formatDate(d.action_date)}
                                </p>
                              )}
                            </div>
                          </div>

                          <div className="flex items-center space-x-2">
                            {d.action_type === 'accepte' && (
                              <span className="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-2 py-1 rounded-full text-xs font-medium">
                                Accepté
                              </span>
                            )}
                            {d.action_type === 'renvoye' && (
                              <span className="bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 px-2 py-1 rounded-full text-xs font-medium">
                                Renvoyé
                              </span>
                            )}
                            {d.action_type === 'refuse' && (
                              <span className="bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 px-2 py-1 rounded-full text-xs font-medium">
                                Refusé
                              </span>
                            )}
                            <i className="ri-arrow-right-s-line text-gray-400"></i>
                          </div>
                        </div>

                        {/* Affichage du motif de refus si le devis est refusé */}
                        {d.action_type === 'refuse' && d.motif_refus && (
                          <div className="mt-3 pt-3 border-t border-red-200 dark:border-red-700">
                            <p className="text-sm text-red-700 dark:text-red-300">
                              <span className="font-medium">motif :</span> {d.motif_refus}
                            </p>
                          </div>
                        )}
                      </div>
                    ))
                    }
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <i className="ri-file-list-3-line text-gray-400 text-3xl mb-3"></i>
                    <p className="text-gray-500 dark:text-gray-400">Aucun devis généré pour ce dossier</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {activeTab === 'client' && (
          <div className="space-y-6">
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                  Données client - Issues du formulaire et de l'IA
                </h3>

                {/* Desktop - bouton à côté du titre */}
                <div className="hidden sm:flex">
                  {!isEditingClient ? (
                    <button
                      onClick={handleStartEditClient}
                      className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                    >
                      <i className="ri-edit-line mr-2"></i>
                      Modifier
                    </button>
                  ) : (
                    <div className="flex space-x-2">
                      <button
                        onClick={handleSaveClientData}
                        className="bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                      >
                        <i className="ri-save-line mr-2"></i>
                        Sauvegarder
                      </button>
                      <button
                        onClick={() => setIsEditingClient(false)}
                        className="bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                      >
                        Annuler
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Form fields */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Civilité
                  </label>
                  {isEditingClient ? (
                    <Select
                      value={editedClientData.client_civilite || ''}
                      onValueChange={(v) => setEditedClientData((prev: EditedClientData) => ({ ...prev, client_civilite: v }))}
                    >
                      <SelectTrigger className="w-full">
                        <SelectValue placeholder="Sélectionner" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="M">M.</SelectItem>
                        <SelectItem value="Mme">Mme</SelectItem>
                        <SelectItem value="Mlle">Mlle</SelectItem>
                      </SelectContent>
                    </Select>
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                      {dossier.client_civilite || '-'}
                    </p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Prénom
                  </label>
                  {isEditingClient ? (
                    <input
                      type="text"
                      value={editedClientData.client_prenom}
                      onChange={(e) => setEditedClientData((prev: EditedClientData) => ({ ...prev, client_prenom: e.target.value }))}
                      className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                    />
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                      {dossier.client_prenom}
                    </p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Nom
                  </label>
                  {isEditingClient ? (
                    <input
                      type="text"
                      value={editedClientData.client_nom}
                      onChange={(e) => setEditedClientData((prev: EditedClientData) => ({ ...prev, client_nom: e.target.value }))}
                      className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                    />
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                      {dossier.client_nom}
                    </p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Date de naissance
                  </label>
                  {isEditingClient ? (
                    <DatePicker
                      value={editedClientData.client_date_naissance}
                      onChange={(value) => setEditedClientData((prev: EditedClientData) => ({ ...prev, client_date_naissance: value }))}
                      placeholder="Sélectionner une date de naissance"
                      className="w-full"
                    />
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                      {new Date(dossier.client_date_naissance).toLocaleDateString('fr-FR')}
                    </p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Statut fumeur
                  </label>
                  {isEditingClient ? (
                    <Select
                      value={editedClientData.client_fumeur ? 'true' : 'false'}
                      onValueChange={(v) => setEditedClientData((prev: EditedClientData) => ({ ...prev, client_fumeur: v === 'true' }))}
                    >
                      <SelectTrigger className="w-full">
                        <SelectValue placeholder="Sélectionner" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="false">Non-fumeur</SelectItem>
                        <SelectItem value="true">Fumeur</SelectItem>
                      </SelectContent>
                    </Select>
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                      {dossier.client_fumeur ? 'Fumeur' : 'Non-fumeur'}
                    </p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Catégorie professionnelle
                  </label>
                  {isEditingClient ? (
                    <Select
                      value={String(editedClientData.client_categorie_professionnelle || 0)}
                      onValueChange={(v) => setEditedClientData((prev: EditedClientData) => ({ ...prev, client_categorie_professionnelle: parseInt(v) }))}
                    >
                      <SelectTrigger className="w-full">
                        <SelectValue placeholder="Sélectionnez" />
                      </SelectTrigger>
                      <SelectContent>
                        {CATEGORY_OPTIONS.map(option => (
                          <SelectItem key={option.value} value={option.value}>
                            {option.label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                      {getCategoryLabel(dossier.client_categorie_professionnelle)}
                    </p>
                  )}
                </div>

                <div className="md:col-span-2">
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Adresse
                  </label>
                  {isEditingClient ? (
                    <input
                      type="text"
                      value={editedClientData.client_adresse}
                      onChange={(e) => setEditedClientData((prev: EditedClientData) => ({ ...prev, client_adresse: e.target.value }))}
                      className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                    />
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                      {dossier.client_adresse}
                    </p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Email
                  </label>
                  {isEditingClient ? (
                    <input
                      type="email"
                      value={editedClientData.client_email}
                      onChange={(e) => setEditedClientData((prev: EditedClientData) => ({ ...prev, client_email: e.target.value }))}
                      className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                    />
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                      {dossier.client_email}
                    </p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Téléphone
                  </label>
                  {isEditingClient ? (
                    <input
                      type="tel"
                      value={editedClientData.client_telephone}
                      onChange={(e) => setEditedClientData((prev: EditedClientData) => ({ ...prev, client_telephone: e.target.value }))}
                      className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                    />
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                      {dossier.client_telephone}
                    </p>
                  )}
                </div>

              </div>

              {/* Mobile - bouton en bas à droite */}
              <div className="sm:hidden mt-6 flex justify-end">
                {!isEditingClient ? (
                  <button
                    onClick={handleStartEditClient}
                    className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                  >
                    <i className="ri-edit-line mr-2"></i>
                    Modifier
                  </button>
                ) : (
                  <div className="flex space-x-2">
                    <button
                      onClick={handleSaveClientData}
                      className="bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                    >
                      <i className="ri-save-line mr-2"></i>
                      Sauvegarder
                    </button>
                    <button
                      onClick={() => setIsEditingClient(false)}
                      className="bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                    >
                      Annuler
                    </button>
                  </div>
                )}
              </div>
            </div>

            {/* Card Informations du conjoint (si dossier couple) */}
            {dossier.type === 'couple' && (dossier.conjoint_nom || dossier.conjoint_prenom) && (
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <div className="flex items-center justify-between mb-6">
                  <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                    Informations du conjoint
                  </h3>

                  {/* Desktop - bouton à côté du titre */}
                  <div className="hidden sm:flex">
                    {!isEditingClient ? (
                      <button
                        onClick={handleStartEditClient}
                        className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                      >
                        <i className="ri-edit-line mr-2"></i>
                        Modifier
                      </button>
                    ) : (
                      <div className="flex space-x-2">
                        <button
                          onClick={handleSaveClientData}
                          className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                        >
                          <i className="ri-save-line mr-2"></i>
                          Sauvegarder
                        </button>
                        <button
                          onClick={handleCancelEditClient}
                          className="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                        >
                          <i className="ri-close-line mr-2"></i>
                          Annuler
                        </button>
                      </div>
                    )}
                  </div>
                </div>

                {/* Mobile - bouton sous le titre */}
                <div className="sm:hidden mb-6">
                  {!isEditingClient ? (
                    <button
                      onClick={handleStartEditClient}
                      className="w-full bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                    >
                      <i className="ri-edit-line mr-2"></i>
                      Modifier
                    </button>
                  ) : (
                    <div className="flex space-x-2">
                      <button
                        onClick={handleSaveClientData}
                        className="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                      >
                        <i className="ri-save-line mr-2"></i>
                        Sauvegarder
                      </button>
                      <button
                        onClick={handleCancelEditClient}
                        className="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                      >
                        <i className="ri-close-line mr-2"></i>
                        Annuler
                      </button>
                    </div>
                  )}
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Civilité du conjoint */}
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                      Civilité du conjoint
                    </label>
                    {isEditingClient ? (
                      <Select
                        value={editedClientData.conjoint_civilite || ''}
                        onValueChange={(v) => setEditedClientData((prev: EditedClientData) => ({ ...prev, conjoint_civilite: v }))}
                      >
                        <SelectTrigger className="w-full">
                          <SelectValue placeholder="Sélectionner" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="M">M.</SelectItem>
                          <SelectItem value="Mme">Mme</SelectItem>
                          <SelectItem value="Mlle">Mlle</SelectItem>
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        {dossier.conjoint_civilite || '-'}
                      </p>
                    )}
                  </div>

                  {/* Nom du conjoint */}
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                      Nom du conjoint
                    </label>
                    {isEditingClient ? (
                      <input
                        type="text"
                        value={editedClientData.conjoint_nom}
                        onChange={(e) => setEditedClientData(prev => ({ ...prev, conjoint_nom: e.target.value }))}
                        className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                      />
                    ) : (
                      <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">{dossier.conjoint_nom || 'Non renseigné'}</p>
                    )}
                  </div>

                  {/* Prénom du conjoint */}
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                      Prénom du conjoint
                    </label>
                    {isEditingClient ? (
                      <input
                        type="text"
                        value={editedClientData.conjoint_prenom}
                        onChange={(e) => setEditedClientData(prev => ({ ...prev, conjoint_prenom: e.target.value }))}
                        className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                      />
                    ) : (
                      <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">{dossier.conjoint_prenom || 'Non renseigné'}</p>
                    )}
                  </div>

                  {/* Date de naissance du conjoint */}
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                      Date de naissance du conjoint
                    </label>
                    {isEditingClient ? (
                      <DatePicker
                        value={editedClientData.conjoint_date_naissance || ''}
                        onChange={(value) => setEditedClientData(prev => ({ ...prev, conjoint_date_naissance: value }))}
                        placeholder="Sélectionner une date de naissance"
                        className="w-full"
                      />
                    ) : (
                      <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        {dossier.conjoint_date_naissance ? new Date(dossier.conjoint_date_naissance).toLocaleDateString('fr-FR') : 'Non renseignée'}
                      </p>
                    )}
                  </div>

                  {/* Profession du conjoint */}
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                      Catégorie professionnelle du conjoint
                    </label>
                    {isEditingClient ? (
                      <Select
                        value={String(editedClientData.conjoint_categorie_professionnelle || 0)}
                        onValueChange={(v) => setEditedClientData(prev => ({ ...prev, conjoint_categorie_professionnelle: parseInt(v) }))}
                      >
                        <SelectTrigger className="w-full">
                          <SelectValue placeholder="Sélectionnez" />
                        </SelectTrigger>
                        <SelectContent>
                          {CATEGORY_OPTIONS.map(option => (
                            <SelectItem key={option.value} value={option.value}>
                              {option.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        {getCategoryLabel(dossier.conjoint_categorie_professionnelle)}
                      </p>
                    )}
                  </div>

                  {/* Statut fumeur du conjoint */}
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                      Statut fumeur du conjoint
                    </label>
                    {isEditingClient ? (
                      <Select
                        value={editedClientData.conjoint_fumeur ? 'oui' : 'non'}
                        onValueChange={(value) => setEditedClientData(prev => ({ ...prev, conjoint_fumeur: value === 'oui' }))}
                      >
                        <SelectTrigger className="w-full">
                          <SelectValue placeholder="Sélectionner" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="non">Non fumeur</SelectItem>
                          <SelectItem value="oui">Fumeur</SelectItem>
                        </SelectContent>
                      </Select>
                    ) : (
                      <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">{dossier.conjoint_fumeur ? 'Fumeur' : 'Non fumeur'}</p>
                    )}
                  </div>

                  {/* Email du conjoint */}
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                      Email du conjoint
                    </label>
                    {isEditingClient ? (
                      <input
                        type="email"
                        value={editedClientData.conjoint_email}
                        onChange={(e) => setEditedClientData(prev => ({ ...prev, conjoint_email: e.target.value }))}
                        className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                        placeholder="email@exemple.fr"
                      />
                    ) : (
                      <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">{dossier.conjoint_email || 'Non renseigné'}</p>
                    )}
                  </div>

                  {/* Téléphone du conjoint */}
                  <div>
                    <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                      Téléphone du conjoint
                    </label>
                    {isEditingClient ? (
                      <input
                        type="tel"
                        value={editedClientData.conjoint_telephone}
                        onChange={(e) => setEditedClientData(prev => ({ ...prev, conjoint_telephone: e.target.value }))}
                        className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                        placeholder="06 12 34 56 78"
                      />
                    ) : (
                      <p className="text-gray-900 dark:text-white p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">{dossier.conjoint_telephone || 'Non renseigné'}</p>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* Tab Pret */}
        {activeTab === 'pret' && (
          <div className="space-y-6">
            {/* Informations du prêt */}
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
              {/* Header avec bouton responsive */}
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                  Informations du prêt - Extraites par l'IA
                </h3>

                {/* Desktop - boutons à côté du titre */}
                <div className="hidden sm:flex space-x-2">
                  <button
                    onClick={handleRefreshExtraction}
                    disabled={isExtracting}
                    className="bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                  >
                    <i className={`ri-refresh-line ${isExtracting ? 'animate-spin' : ''}`}></i>
                    <span>{isExtracting ? 'Extraction...' : 'Actualiser'}</span>
                  </button>

                  {!isEditingPret ? (
                    <button
                      onClick={() => setIsEditingPret(true)}
                      className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                    >
                      <i className="ri-edit-line mr-2"></i>
                      Modifier
                    </button>
                  ) : (
                    <div className="flex space-x-2">
                      <button
                        onClick={handleSavePretData}
                        className="bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover-bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                      >
                        <i className="ri-save-line mr-2"></i>
                        Sauvegarder
                      </button>
                      <button
                        onClick={() => setIsEditingPret(false)}
                        className="bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                      >
                        Annuler
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Affichage du résultat d'extraction */}
              {extractionResult && (
                <div className="mb-6">
                  <ExtractionResult extractionData={extractionResult} />
                </div>
              )}

              {/* Affichage des erreurs d'extraction */}
              {extractionError && (
                <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                  <div className="flex items-center">
                    <i className="ri-error-warning-line text-red-500 mr-2"></i>
                    <div>
                      <h4 className="text-sm font-medium text-red-800">Erreur d'extraction</h4>
                      <p className="text-sm text-red-700 mt-1">{extractionError}</p>
                    </div>
                  </div>
                </div>
              )}

              {/* Form fields */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Banque prêteuse
                  </label>
                  {isEditingPret ? (
                    <input
                      type="text"
                      value={editedPretData.banque_preteuse}
                      onChange={(e) => setEditedPretData((prev: EditedPretData) => ({ ...prev, banque_preteuse: e.target.value }))}
                      className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                    />
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-[#335FAD]/5 dark:bg-[#335FAD]/20 rounded-lg border border-[#335FAD]/20 dark:border-[#335FAD]/80">
                      {dossier.infos_pret.banque_preteuse}
                    </p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Montant du capital emprunté
                  </label>
                  {isEditingPret ? (
                    <input
                      type="number"
                      value={editedPretData.montant_capital}
                      onChange={(e) => setEditedPretData((prev: EditedPretData) => ({ ...prev, montant_capital: Number(e.target.value) }))}
                      className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                    />
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-[#335FAD]/5 dark:bg-[#335FAD]/20 rounded-lg border border-[#335FAD]/20 dark:border-[#335FAD]/80">
                      {formatCurrency(dossier.infos_pret.montant_capital)}
                    </p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Durée du prêt (mois)
                  </label>
                  {isEditingPret ? (
                    <input
                      type="number"
                      value={editedPretData.duree_mois}
                      onChange={(e) => setEditedPretData((prev: EditedPretData) => ({ ...prev, duree_mois: Number(e.target.value) }))}
                      className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                    />
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-[#335FAD]/5 dark:bg-[#335FAD]/20 rounded-lg border border-[#335FAD]/20 dark:border-[#335FAD]/80">
                      {dossier.infos_pret.duree_mois} mois ({Math.round(dossier.infos_pret.duree_mois / 12)} ans)
                    </p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Type de prêt
                  </label>
                  {isEditingPret ? (
                    <input
                      type="text"
                      value={editedPretData.type_pret}
                      onChange={(e) => setEditedPretData((prev: EditedPretData) => ({ ...prev, type_pret: e.target.value }))}
                      className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                    />
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-[#335FAD]/5 dark:bg-[#335FAD]/20 rounded-lg border border-[#335FAD]/20 dark:border-[#335FAD]/80">
                      {dossier.infos_pret.type_pret}
                    </p>
                  )}
                </div>

                <div className="md:col-span-2">
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Coût de l'assurance banque (mensuel)
                  </label>
                  {isEditingPret ? (
                    <input
                      type="number"
                      value={editedPretData.cout_assurance_banque || ''}
                      onChange={(e) => setEditedPretData((prev: EditedPretData) => ({ ...prev, cout_assurance_banque: e.target.value ? Number(e.target.value) : null }))}
                      placeholder="Ex: 280"
                      className="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent"
                    />
                  ) : (
                    <p className="text-gray-900 dark:text-white p-3 bg-[#335FAD]/5 dark:bg-[#335FAD]/20 rounded-lg border border-[#335FAD]/20 dark:border-[#335FAD]/80">
                      {dossier.infos_pret.cout_assurance_banque ? formatCurrency(dossier.infos_pret.cout_assurance_banque) : 'Non disponible dans les documents'}
                    </p>
                  )}
                </div>

                {/* Informations supplémentaires extraites par l'IA */}
                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Date de début du prêt
                  </label>
                  <p className={`p-3 rounded-lg border ${dossier.infos_pret.date_debut
                    ? 'bg-[#335FAD]/5 dark:bg-[#335FAD]/20 border-[#335FAD]/20 dark:border-[#335FAD]/80 text-gray-900 dark:text-white'
                    : 'bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400'
                    }`}>
                    {dossier.infos_pret.date_debut ? formatDate(dossier.infos_pret.date_debut) : 'Non extraite'}
                  </p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Date de fin du prêt
                  </label>
                  <p className={`p-3 rounded-lg border ${dossier.infos_pret.date_fin
                    ? 'bg-[#335FAD]/5 dark:bg-[#335FAD]/20 border-[#335FAD]/20 dark:border-[#335FAD]/80 text-gray-900 dark:text-white'
                    : 'bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400'
                    }`}>
                    {dossier.infos_pret.date_fin ? formatDate(dossier.infos_pret.date_fin) : 'Non extraite'}
                  </p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Taux nominal
                  </label>
                  <p className={`p-3 rounded-lg border ${dossier.infos_pret.taux_nominal
                    ? 'bg-[#335FAD]/5 dark:bg-[#335FAD]/20 border-[#335FAD]/20 dark:border-[#335FAD]/80 text-gray-900 dark:text-white'
                    : 'bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400'
                    }`}>
                    {dossier.infos_pret.taux_nominal ? `${dossier.infos_pret.taux_nominal}%` : 'Non extrait'}
                  </p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Date de début effective (calculée)
                  </label>
                  <p className={`p-3 rounded-lg border ${dossier.infos_pret.date_debut_effective
                    ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-700 text-green-800 dark:text-green-400'
                    : 'bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400'
                    }`}>
                    {dossier.infos_pret.date_debut_effective ? formatDate(dossier.infos_pret.date_debut_effective) : 'Non calculée'}
                  </p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Durée restante (calculée)
                  </label>
                  <p className={`p-3 rounded-lg border ${dossier.infos_pret.duree_restante_mois
                    ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-700 text-green-800 dark:text-green-400'
                    : 'bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400'
                    }`}>
                    {dossier.infos_pret.duree_restante_mois
                      ? `${dossier.infos_pret.duree_restante_mois} mois (${Math.round(dossier.infos_pret.duree_restante_mois / 12)} ans)`
                      : 'Non calculée'
                    }
                  </p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                    Capital restant dû (calculé)
                  </label>
                  <p className={`p-3 rounded-lg border ${dossier.infos_pret.capital_restant_du
                    ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-700 text-green-800 dark:text-green-400'
                    : 'bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400'
                    }`}>
                    {dossier.infos_pret.capital_restant_du
                      ? formatCurrency(dossier.infos_pret.capital_restant_du)
                      : 'Non calculé'
                    }
                  </p>
                </div>
              </div>

              {/* Mobile - bouton en bas à droite */}
              <div className="sm:hidden mt-6 flex justify-end space-x-2">
                <button
                  onClick={handleRefreshExtraction}
                  disabled={isExtracting}
                  className="bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                >
                  <i className={`ri-refresh-line ${isExtracting ? 'animate-spin' : ''}`}></i>
                  <span>{isExtracting ? 'Extraction...' : 'Actualiser'}</span>
                </button>

                {!isEditingPret ? (
                  <button
                    onClick={() => setIsEditingPret(true)}
                    className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                  >
                    <i className="ri-edit-line mr-2"></i>
                    Modifier
                  </button>
                ) : (
                  <div className="flex space-x-2">
                    <button
                      onClick={handleSavePretData}
                      className="bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                    >
                      <i className="ri-save-line mr-2"></i>
                      Sauvegarder
                    </button>
                    <button
                      onClick={() => setIsEditingPret(false)}
                      className="bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                    >
                      Annuler
                    </button>
                  </div>
                )}
              </div>
            </div>

            {/* Section Documents fournis par l'apporteur */}
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                  Documents fournis par l'apporteur
                </h3>
                <button
                  onClick={() => setShowDocumentModal(true)}
                  className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer flex items-center space-x-2"
                >
                  <i className="ri-add-line"></i>
                  <span>Ajouter un document</span>
                </button>
              </div>

              {/* Grille des documents */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {/* Offre de Prêt */}
                <div className={`border-2 rounded-lg p-4 ${dossier.documents.offre_pret
                  ? 'border-green-200 dark:border-green-700 bg-green-50 dark:bg-green-900/20'
                  : 'border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 border-dashed'
                  }`}>
                  <div className="flex items-start justify-between mb-3">
                    <div className="flex items-center space-x-3 flex-1 min-w-0">
                      <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${dossier.documents.offre_pret
                        ? 'bg-green-100 dark:bg-green-900/30'
                        : 'bg-gray-100 dark:bg-gray-600'
                        }`}>
                        <i className={`ri-file-text-line text-sm ${dossier.documents.offre_pret
                          ? 'text-green-600 dark:text-green-400'
                          : 'text-gray-400 dark:text-gray-500'
                          }`}></i>
                      </div>
                      <div className="min-w-0 flex-1">
                        <h4 className="font-medium text-gray-900 dark:text-white text-sm">
                          Offre de Prêt
                          <span className="text-red-500 ml-1">*</span>
                        </h4>
                        <p className="text-xs text-gray-500 dark:text-gray-400">
                          Document officiel de la banque
                        </p>
                      </div>
                    </div>
                    {dossier.documents.offre_pret && (
                      <div className="flex items-center space-x-1 flex-shrink-0">
                        <button
                          onClick={() => handleViewDocument(buildPublicUrl(dossier.documents.offre_pret.url), dossier.documents.offre_pret.nom, 'pdf')}
                          className="p-1.5 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 hover:bg-[#335FAD]/20 dark:hover:bg-[#335FAD]/50 text-[#335FAD] dark:text-[#335FAD] rounded-md transition-colors cursor-pointer"
                          title="Voir le document"
                        >
                          <i className="ri-eye-line text-xs"></i>
                        </button>
                        <button
                          onClick={() => openDeleteModal(dossier.documents.offre_pret.id, dossier.documents.offre_pret.nom)}
                          className="p-1.5 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 rounded-md transition-colors cursor-pointer"
                          title="Supprimer le document"
                        >
                          <i className="ri-delete-bin-line text-xs"></i>
                        </button>
                      </div>
                    )}
                  </div>
                  {dossier.documents.offre_pret && (
                    <div className="mt-2">
                      <p className="text-xs font-medium text-green-700 dark:text-green-400 truncate" title={dossier.documents.offre_pret.nom}>
                        {dossier.documents.offre_pret.nom}
                      </p>
                      <p className="text-xs text-green-600 dark:text-green-500">
                        {dossier.documents.offre_pret.taille}
                      </p>
                    </div>
                  )}
                  {!dossier.documents.offre_pret && (
                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                      Document manquant
                    </p>
                  )}
                </div>

                {/* Tableau d'Amortissement */}
                <div className={`border-2 rounded-lg p-4 ${dossier.documents.tableau_amortissement
                  ? 'border-green-200 dark:border-green-700 bg-green-50 dark:bg-green-900/20'
                  : 'border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 border-dashed'
                  }`}>
                  <div className="flex items-start justify-between mb-3">
                    <div className="flex items-center space-x-3 flex-1 min-w-0">
                      <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${dossier.documents.tableau_amortissement
                        ? 'bg-green-100 dark:bg-green-900/30'
                        : 'bg-gray-100 dark:bg-gray-600'
                        }`}>
                        <i className={`ri-table-line text-sm ${dossier.documents.tableau_amortissement
                          ? 'text-green-600 dark:text-green-400'
                          : 'text-gray-400 dark:text-gray-500'
                          }`}></i>
                      </div>
                      <div className="min-w-0 flex-1">
                        <h4 className="font-medium text-gray-900 dark:text-white text-sm">
                          Tableau d'Amortissement
                          <span className="text-red-500 ml-1">*</span>
                        </h4>
                        <p className="text-xs text-gray-500 dark:text-gray-400">
                          Détail des échéances
                        </p>
                      </div>
                    </div>
                    {dossier.documents.tableau_amortissement && (
                      <div className="flex items-center space-x-1 flex-shrink-0">
                        <button
                          onClick={() => handleViewDocument(buildPublicUrl(dossier.documents.tableau_amortissement.url), dossier.documents.tableau_amortissement.nom, 'pdf')}
                          className="p-1.5 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 hover:bg-[#335FAD]/20 dark:hover:bg-[#335FAD]/50 text-[#335FAD] dark:text-[#335FAD] rounded-md transition-colors cursor-pointer"
                          title="Voir le document"
                        >
                          <i className="ri-eye-line text-xs"></i>
                        </button>
                        <button
                          onClick={() => openDeleteModal(dossier.documents.tableau_amortissement.id, dossier.documents.tableau_amortissement.nom)}
                          className="p-1.5 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 rounded-md transition-colors cursor-pointer"
                          title="Supprimer le document"
                        >
                          <i className="ri-delete-bin-line text-xs"></i>
                        </button>
                      </div>
                    )}
                  </div>
                  {dossier.documents.tableau_amortissement && (
                    <div className="mt-2">
                      <p className="text-xs font-medium text-green-700 dark:text-green-400 truncate" title={dossier.documents.tableau_amortissement.nom}>
                        {dossier.documents.tableau_amortissement.nom}
                      </p>
                      <p className="text-xs text-green-600 dark:text-green-500">
                        {dossier.documents.tableau_amortissement.taille}
                      </p>
                    </div>
                  )}
                  {!dossier.documents.tableau_amortissement && (
                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                      Document manquant
                    </p>
                  )}
                </div>

                {/* Carte d'Identité Emprunteur */}
                <div className={`border-2 rounded-lg p-4 ${dossier.documents.carte_identite
                  ? 'border-green-200 dark:border-green-700 bg-green-50 dark:bg-green-900/20'
                  : 'border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 border-dashed'
                  }`}>
                  <div className="flex items-start justify-between mb-3">
                    <div className="flex items-center space-x-3 flex-1 min-w-0">
                      <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${dossier.documents.carte_identite
                        ? 'bg-green-100 dark:bg-green-900/30'
                        : 'bg-gray-100 dark:bg-gray-600'
                        }`}>
                        <i className={`ri-id-card-line text-sm ${dossier.documents.carte_identite
                          ? 'text-green-600 dark:text-green-400'
                          : 'text-gray-400 dark:text-gray-500'
                          }`}></i>
                      </div>
                      <div className="min-w-0 flex-1">
                        <h4 className="font-medium text-gray-900 dark:text-white text-sm">
                          Carte d'Identité (Emprunteur)
                          <span className="text-red-500 ml-1">*</span>
                        </h4>
                        <p className="text-xs text-gray-500 dark:text-gray-400">
                          Pièce d'identité principale
                        </p>
                      </div>
                    </div>
                    {dossier.documents.carte_identite && (
                      <div className="flex items-center space-x-1 flex-shrink-0">
                        <button
                          onClick={() => handleViewDocument(buildPublicUrl(dossier.documents.carte_identite.url), dossier.documents.carte_identite.nom, 'image')}
                          className="p-1.5 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 hover:bg-[#335FAD]/20 dark:hover:bg-[#335FAD]/50 text-[#335FAD] dark:text-[#335FAD] rounded-md transition-colors cursor-pointer"
                          title="Voir le document"
                        >
                          <i className="ri-eye-line text-xs"></i>
                        </button>
                        <button
                          onClick={() => openDeleteModal(dossier.documents.carte_identite.id, dossier.documents.carte_identite.nom)}
                          className="p-1.5 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 rounded-md transition-colors cursor-pointer"
                          title="Supprimer le document"
                        >
                          <i className="ri-delete-bin-line text-xs"></i>
                        </button>
                      </div>
                    )}
                  </div>
                  {dossier.documents.carte_identite && (
                    <div className="mt-2">
                      <p className="text-xs font-medium text-green-700 dark:text-green-400 truncate" title={dossier.documents.carte_identite.nom}>
                        {dossier.documents.carte_identite.nom}
                      </p>
                      <p className="text-xs text-green-600 dark:text-green-500">
                        {dossier.documents.carte_identite.taille}
                      </p>
                    </div>
                  )}
                  {!dossier.documents.carte_identite && (
                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                      Document manquant
                    </p>
                  )}
                </div>

                {/* Carte d'Identité Conjoint - CONDITIONNEL */}
                {dossier.type === 'couple' && (
                  <div className={`border-2 rounded-lg p-4 ${dossier.documents.carte_identite_conjoint
                    ? 'border-green-200 dark:border-green-700 bg-green-50 dark:bg-green-900/20'
                    : 'border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 border-dashed'
                    }`}>
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex items-center space-x-3 flex-1 min-w-0">
                        <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${dossier.documents.carte_identite_conjoint
                          ? 'bg-green-100 dark:bg-green-900/30'
                          : 'bg-gray-100 dark:bg-gray-600'
                          }`}>
                          <i className={`ri-id-card-line text-sm ${dossier.documents.carte_identite_conjoint
                            ? 'text-green-600 dark:text-green-400'
                            : 'text-gray-400 dark:text-gray-500'
                            }`}></i>
                        </div>
                        <div className="min-w-0 flex-1">
                          <h4 className="font-medium text-gray-900 dark:text-white text-sm">
                            Carte d'Identité (Conjoint)
                            <span className="text-red-500 ml-1">*</span>
                          </h4>
                          <p className="text-xs text-gray-500 dark:text-gray-400">
                            Pièce d'identité du conjoint
                          </p>
                        </div>
                      </div>
                      {dossier.documents.carte_identite_conjoint && (
                        <div className="flex items-center space-x-1 flex-shrink-0">
                          <button
                            onClick={() => handleViewDocument(buildPublicUrl(dossier.documents.carte_identite_conjoint.url), dossier.documents.carte_identite_conjoint.nom, 'image')}
                            className="p-1.5 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 hover:bg-[#335FAD]/20 dark:hover:bg-[#335FAD]/50 text-[#335FAD] dark:text-[#335FAD] rounded-md transition-colors cursor-pointer"
                            title="Voir le document"
                          >
                            <i className="ri-eye-line text-xs"></i>
                          </button>
                          <button
                            onClick={() => openDeleteModal(dossier.documents.carte_identite_conjoint.id, dossier.documents.carte_identite_conjoint.nom)}
                            className="p-1.5 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 rounded-md transition-colors cursor-pointer"
                            title="Supprimer le document"
                          >
                            <i className="ri-delete-bin-line text-xs"></i>
                          </button>
                        </div>
                      )}
                    </div>
                    {dossier.documents.carte_identite_conjoint && (
                      <div className="mt-2">
                        <p className="text-xs font-medium text-green-700 dark:text-green-400 truncate" title={dossier.documents.carte_identite_conjoint.nom}>
                          {dossier.documents.carte_identite_conjoint.nom}
                        </p>
                        <p className="text-xs text-green-600 dark:text-green-500">
                          {dossier.documents.carte_identite_conjoint.taille}
                        </p>
                      </div>
                    )}
                    {!dossier.documents.carte_identite_conjoint && (
                      <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                        Document manquant
                      </p>
                    )}
                  </div>
                )}
              </div>

              {/* Section Autres Documents */}
              {dossier.documents.autres && dossier.documents.autres.length > 0 && (
                <div className="mt-6">
                  <h3 className="text-base font-medium text-gray-900 dark:text-white mb-4">
                    Autres documents ({dossier.documents.autres.length})
                  </h3>
                  <div className="grid grid-cols-1 gap-3">
                    {dossier.documents.autres.map((doc: any, index: number) => (
                      <div
                        key={doc.id || index}
                        className="border-2 border-gray-200 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50"
                      >
                        <div className="flex items-start justify-between">
                          <div className="flex items-center space-x-3 flex-1 min-w-0">
                            <div className="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 bg-gray-100 dark:bg-gray-600">
                              <i className="ri-file-line text-sm text-gray-600 dark:text-gray-400"></i>
                            </div>
                            <div className="min-w-0 flex-1">
                              <h4 className="text-sm font-medium text-gray-900 dark:text-white truncate" title={doc.nom}>
                                {doc.nom}
                              </h4>
                              <div className="flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400 mt-1">
                                <span>{doc.taille}</span>
                                {doc.type && (
                                  <>
                                    <span>•</span>
                                    <span className="capitalize">{getDocumentTypeLabel(doc.type)}</span>
                                  </>
                                )}
                              </div>
                            </div>
                          </div>
                          <div className="flex items-center space-x-1 flex-shrink-0 ml-2">
                            <button
                              onClick={() => handleViewDocument(buildPublicUrl(doc.url), doc.nom, doc.type || '', doc.id)}
                              className="p-1.5 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 hover:bg-[#335FAD]/20 dark:hover:bg-[#335FAD]/50 text-[#335FAD] dark:text-[#335FAD] rounded-md transition-colors cursor-pointer"
                              title="Voir le document"
                            >
                              <i className="ri-eye-line text-xs"></i>
                            </button>
                            <button
                              onClick={() => openDeleteModal(doc.id, doc.nom)}
                              className="p-1.5 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 rounded-md transition-colors cursor-pointer"
                              title="Supprimer le document"
                            >
                              <i className="ri-delete-bin-line text-xs"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Tab Devis Comparatif */}
        {activeTab === 'devis' && (
          <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                Devis comparatif - Solutions d'assurance emprunteur
              </h3>

              <button
                onClick={handleRefreshDevis}
                disabled={isRefreshingDevis}
                className="bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
              >
                <i className={`ri-refresh-line ${isRefreshingDevis ? 'animate-spin' : ''}`}></i>
                <span>{isRefreshingDevis ? 'Actualisation...' : 'Actualiser les devis'}</span>
              </button>
            </div>

            {/* Tableau des devis */}
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead className="bg-gray-50 dark:bg-gray-700">
                  <tr>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Compagnie
                    </th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Produit
                    </th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Coût Mensuel
                    </th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Coût Total
                    </th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Économie Estimée
                    </th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Formalités
                    </th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Action
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                  {devis.map((devisItem) => {
                    const economieCalculee = calculateEconomie(devisItem.cout_total, dossier.infos_pret.cout_assurance_banque);
                    return (
                      <tr
                        key={devisItem.id}
                        className={`hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer ${devisItem.selected ? 'ring-2 ring-[#335FAD] dark:ring-[#335FAD]/80 bg-[#335FAD]/5 dark:bg-[#335FAD]/10' : ''
                          }`}
                        onClick={() => handleDevisRowClick(devisItem)}
                      >
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm font-medium text-gray-900 dark:text-white">{devisItem.compagnie}</div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm text-gray-900 dark:text-white">{devisItem.produit}</div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm text-gray-900 dark:text-white">{formatCurrency(devisItem.cout_mensuel)}</div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm font-medium text-gray-900 dark:text-white">{formatCurrency(devisItem.cout_total)}</div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className={`text-sm font-medium ${(economieCalculee?.economie || devisItem.economie_estimee || 0) > 0
                            ? 'text-green-600 dark:text-green-400'
                            : 'text-red-600 dark:text-red-400'
                            }`}>
                            {formatCurrency(economieCalculee?.economie || devisItem.economie_estimee || 0)}
                            {economieCalculee && (
                              <span className="text-xs ml-1">
                                ({economieCalculee.pourcentage.toFixed(1)}%)
                              </span>
                            )}
                          </div>
                        </td>
                        <td className="px-6 py-4">
                          <div className="text-sm text-gray-900 dark:text-white">
                            {(devisItem.formalites_medicales || []).join(', ')}
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                          {devisItem.statut === 'accepte' ? (
                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
                              <i className="ri-check-double-line mr-1"></i>
                              Accepté
                            </span>
                          ) : devisItem.statut === 'envoye' ? (
                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400">
                              <i className="ri-send-plane-line mr-1"></i>
                              Envoyé
                            </span>
                          ) : devisItem.selected && !devisItem.refused ? (
                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400">
                              <i className="ri-check-line mr-1"></i>
                              Sélectionné
                            </span>
                          ) : devisItem.refused ? (
                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400">
                              <i className="ri-close-line mr-1"></i>
                              <span className="font-medium text-red-800 dark:text-red-400">Refusé</span>
                            </span>
                          ) : (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setSelectedDevisDetail(devisItem);
                                setShowDevisModal(true);
                              }}
                              className="p-2 text-gray-400 dark:text-gray-500 hover:text-[#335FAD] dark:hover:text-[#335FAD] transition-colors cursor-pointer"
                              title="Voir les détails du devis"
                            >
                              <i className="ri-eye-line text-sm"></i>
                            </button>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Tab Réglages */}
        {activeTab === 'reglages' && (
          <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-6 flex items-center gap-2">
              <i className="ri-settings-3-line text-[#335FAD]"></i>
              Réglages du dossier
            </h3>

            {/* Section Type de dossier */}
            <div className="space-y-6">
              <div className="border-b border-gray-200 dark:border-gray-700 pb-6">
                <h4 className="text-base font-medium text-gray-900 dark:text-white mb-4">
                  Type de dossier
                </h4>
                <div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                  <div className="flex-1">
                    <p className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                      Type actuel : <span className="text-[#335FAD] font-semibold">{dossier.is_couple ? 'Couple' : 'Emprunteur seul'}</span>
                    </p>
                    <p className="text-xs text-gray-500 dark:text-gray-400">
                      Modifiez le type du dossier si nécessaire (emprunteur seul ↔ couple)
                    </p>
                  </div>
                  <button
                    onClick={async () => {
                      const newType = dossier.is_couple ? 'seul' : 'couple';
                      const confirmMsg = `Voulez-vous vraiment changer le type du dossier vers "${newType === 'couple' ? 'Couple' : 'Emprunteur seul'}" ?${newType === 'seul' ? '\n\n⚠️ ATTENTION : Les données du conjoint seront supprimées.' : ''}`;

                      if (confirm(confirmMsg)) {
                        try {
                          await DossiersService.changeDossierType(dossierId, newType);
                          await loadDossierData();
                          alert(`Type de dossier changé avec succès vers "${newType === 'couple' ? 'Couple' : 'Emprunteur seul'}"`);
                        } catch (error: unknown) {
                          console.error('Erreur changement type:', error);
                          const errorMsg = error instanceof Error ? error.message : 'Erreur inconnue';
                          alert(`Erreur lors du changement de type de dossier: ${errorMsg}`);
                        }
                      }
                    }}
                    className="px-4 py-2 bg-[#335FAD] hover:bg-[#2a4d8f] text-white rounded-lg transition-colors text-sm font-medium flex items-center gap-2"
                  >
                    <i className="ri-repeat-line"></i>
                    Changer vers {dossier.is_couple ? 'Emprunteur seul' : 'Couple'}
                  </button>
                </div>
              </div>

              {/* Section Extraction */}
              {extractionResult && (
                <div className="border-b border-gray-200 dark:border-gray-700 pb-6">
                  <h4 className="text-base font-medium text-gray-900 dark:text-white mb-4">
                    Dernière extraction
                  </h4>
                  <div className="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                    <div className="flex items-start gap-3">
                      <i className="ri-checkbox-circle-line text-green-600 dark:text-green-400 text-xl mt-0.5"></i>
                      <div className="flex-1">
                        <p className="text-sm font-medium text-green-900 dark:text-green-300 mb-1">
                          {extractionResult.message}
                        </p>
                        <p className="text-xs text-green-700 dark:text-green-400">
                          Confiance : {Math.round(extractionResult.confidence * 100)}%
                        </p>
                        {extractionResult.warnings && extractionResult.warnings.length > 0 && (
                          <div className="mt-2">
                            <p className="text-xs font-medium text-green-700 dark:text-green-400 mb-1">Avertissements :</p>
                            <ul className="text-xs text-green-600 dark:text-green-500 list-disc list-inside">
                              {extractionResult.warnings.map((warning: string, idx: number) => (
                                <li key={idx}>{warning}</li>
                              ))}
                            </ul>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Section Suppression du dossier */}
              <div className="border-b border-gray-200 dark:border-gray-700 pb-6">
                <h4 className="text-base font-medium text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                  <i className="ri-delete-bin-line text-red-600"></i>
                  Zone dangereuse
                </h4>
                <div className="p-4 bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-lg">
                  <div className="flex items-center justify-between">
                    <div className="flex-1">
                      <p className="text-sm font-medium text-red-900 dark:text-red-300 mb-1">
                        Supprimer définitivement ce dossier
                      </p>
                      <p className="text-xs text-red-700 dark:text-red-400">
                        ⚠️ Cette action est irréversible. Toutes les données associées (client, prêt, devis, documents) seront supprimées.
                      </p>
                    </div>
                    <button
                      onClick={handleDeleteDossier}
                      className="ml-4 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors text-sm font-medium flex items-center gap-2"
                    >
                      <i className="ri-delete-bin-line"></i>
                      Supprimer le dossier
                    </button>
                  </div>
                </div>
              </div>

              {/* Info */}
              <div className="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                <div className="flex items-start gap-3">
                  <i className="ri-information-line text-blue-600 dark:text-blue-400 text-xl mt-0.5"></i>
                  <div className="flex-1">
                    <p className="text-sm text-blue-900 dark:text-blue-300">
                      Après chaque extraction automatique, si des différences sont détectées entre les données extraites et les données actuelles,
                      une fenêtre de comparaison s'ouvrira automatiquement pour vous permettre de sélectionner les changements à appliquer.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </main>

      {/* MODAL CONFIRMATION ENVOI DEVIS */}
      {showConfirmModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="flex items-center justify-center min-h-screen px-4">
            <div className="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onClick={() => setShowConfirmModal(false)}></div>
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-xl transform transition-all sm:max-w-lg w-full p-6">
              <div className="text-center">
                <i className="ri-send-plane-line text-[#335FAD] dark:text-[#335FAD]/80 text-2xl mb-3"></i>
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
                  Confirmer l'envoi du devis
                </h3>
                <p className="text-gray-600 dark:text-gray-400 mb-6">
                  Êtes-vous sûr de vouloir choisir ce devis ? Il sera envoyé à l'apporteur pour validation client.
                </p>
                <div className="flex justify-center space-x-3">
                  <button
                    onClick={() => setShowConfirmModal(false)}
                    className="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                  >
                    Annuler
                  </button>
                  <button
                    onClick={confirmEnvoiDevis}
                    className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                  >
                    Confirmer l'envoi
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* MODAL FINALISATION DOSSIER */}
      {showFinalizeModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="flex items-center justify-center min-h-screen px-4">
            <div className="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onClick={() => setShowFinalizeModal(false)}></div>
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-xl transform transition-all sm:max-w-lg w-full p-6">
              <div className="text-center">
                <i className="ri-checkbox-circle-line text-green-600 dark:text-green-400 text-2xl mb-3"></i>
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
                  Marquer le dossier comme finalisé
                </h3>
                <p className="text-gray-600 dark:text-gray-400 mb-6">
                  Êtes-vous sûr de vouloir finaliser ce dossier ? Cette action débloquera la saisie des frais de gestion pour l'apporteur.
                </p>
                <div className="flex justify-center space-x-3">
                  <button
                    onClick={() => setShowFinalizeModal(false)}
                    className="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                  >
                    Annuler
                  </button>
                  <button
                    onClick={confirmFinalisation}
                    className="bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                  >
                    Finaliser le dossier
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* MODAL DÉTAIL DEVIS */}
      {showDevisModal && selectedDevisDetail && (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="flex items-center justify-center min-h-screen px-4">
            <div className="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onClick={() => setShowDevisModal(false)}></div>
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-xl transform transition-all sm:max-w-2xl w-full p-6 max-h-[90vh] my-[5vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-medium text-gray-900 dark:text-white">
                  Détails du devis
                </h3>
                <button
                  onClick={() => setShowDevisModal(false)}
                  className="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 cursor-pointer"
                >
                  <i className="ri-close-line text-xl"></i>
                </button>
              </div>

              <div className="space-y-6">
                {/* Informations principales */}
                <div className="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                  <h4 className="font-medium text-[#335FAD] dark:text-[#335FAD]/80 mb-2">
                    {selectedDevisDetail.compagnie} - {selectedDevisDetail.produit}
                  </h4>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Coût mensuel
                      </label>
                      <p className="text-lg font-medium text-gray-900 dark:text-white">
                        {formatCurrency(selectedDevisDetail.cout_mensuel)}
                      </p>
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Coût total
                      </label>
                      <p className="text-lg font-medium text-gray-900 dark:text-white">
                        {formatCurrency(selectedDevisDetail.cout_total)}
                      </p>
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Économie estimée
                      </label>
                      <p className={`text-lg font-medium ${selectedDevisDetail.economie_estimee && selectedDevisDetail.economie_estimee > 0
                        ? 'text-green-600 dark:text-green-400'
                        : 'text-red-600 dark:text-red-400'
                        }`}>
                        {formatCurrency(selectedDevisDetail.economie_estimee || 0)}
                      </p>
                    </div>
                  </div>
                </div>

                {/* Détails du prêt */}
                <div className="bg-[#335FAD]/5 dark:bg-[#335FAD]/20 rounded-lg p-4 border border-[#335FAD]/20 dark:border-[#335FAD]/80">
                  <h4 className="font-medium text-[#335FAD] dark:text-[#335FAD]/80 mb-3">
                    <i className="ri-file-text-line mr-2"></i>
                    Détails du prêt
                  </h4>

                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                      <label className="block text-xs font-medium text-[#335FAD]/80 dark:text-[#335FAD] mb-1">
                        Capital
                      </label>
                      <p className="text-[#335FAD] dark:text-[#335FAD]/80">
                        {formatCurrency(selectedDevisDetail.detail_pret.capital)}
                      </p>
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-[#335FAD]/80 dark:text-[#335FAD] mb-1">
                        Durée
                      </label>
                      <p className="text-[#335FAD] dark:text-[#335FAD]/80">
                        {selectedDevisDetail.detail_pret.duree} mois
                      </p>
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-[#335FAD]/80 dark:text-[#335FAD] mb-1">
                        Taux d'assurance
                      </label>
                      <p className="text-[#335FAD] dark:text-[#335FAD]/80">
                        {selectedDevisDetail.detail_pret.taux_assurance}%
                      </p>
                    </div>
                  </div>
                </div>

                {/* Formalités médicales */}
                <div className="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4 border border-orange-200 dark:border-orange-800">
                  <h4 className="font-medium text-orange-900 dark:text-orange-200 mb-3">
                    <i className="ri-heart-pulse-line mr-2"></i>
                    Formalités médicales
                  </h4>
                  {selectedDevisDetail.formalites_detaillees.map((formalite, index) => (
                    <div key={index} className="flex items-start mb-2 last:mb-0">
                      <i className="ri-arrow-right-s-line text-orange-600 dark:text-orange-400 mt-0.5"></i>
                      <p className="text-orange-800 dark:text-orange-300 ml-2">{formalite}</p>
                    </div>
                  ))}
                </div>

                {/* Couverture */}
                <div>
                  <h4 className="font-medium text-gray-900 dark:text-white mb-3">
                    <i className="ri-shield-check-line mr-2 text-green-500"></i>
                    Couverture
                  </h4>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    {selectedDevisDetail.couverture.map((item, index) => (
                      <div key={index} className="flex items-center bg-green-50 dark:bg-green-900/20 rounded p-3 border border-green-200 dark:border-green-800">
                        <i className="ri-check-line text-green-600 dark:text-green-400 mr-2"></i>
                        <p className="text-green-800 dark:text-green-300">{item}</p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Exclusions */}
                <div>
                  <h4 className="font-medium text-gray-900 dark:text-white mb-3">
                    <i className="ri-error-warning-line mr-2 text-amber-500"></i>
                    Exclusions et limitations
                  </h4>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    {selectedDevisDetail.exclusions.map((item, index) => (
                      <div key={index} className="flex items-center bg-amber-50 dark:bg-amber-900/20 rounded p-3 border border-amber-200 dark:border-amber-800">
                        <i className="ri-close-line text-amber-600 dark:text-amber-400 mr-2"></i>
                        <p className="text-amber-800 dark:text-amber-300">{item}</p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Avantages */}
                <div>
                  <h4 className="font-medium text-gray-900 dark:text-white mb-3">
                    <i className="ri-star-line mr-2 text-[#335FAD]"></i>
                    Avantages spécifiques
                  </h4>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    {selectedDevisDetail.avantages.map((item, index) => (
                      <div key={index} className="flex items-center bg-[#335FAD]/5 dark:bg-[#335FAD]/10 rounded p-3 border border-[#335FAD]/20 dark:border-[#335FAD]/30">
                        <i className="ri-star-fill text-[#335FAD] dark:text-[#335FAD]/80 mr-2"></i>
                        <p className="text-[#335FAD] dark:text-[#335FAD]/80">{item}</p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Frais */}
                <div className="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                  <h4 className="font-medium text-gray-900 dark:text-white mb-3">
                    <i className="ri-money-euro-circle-line mr-2 text-gray-500"></i>
                    Frais associés
                  </h4>
                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                      <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Frais d'adhésion
                      </label>
                      <p className="text-gray-900 dark:text-white">
                        {formatCurrency(selectedDevisDetail.frais_adhesion)}
                      </p>
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Frais de fractionnement
                      </label>
                      <p className="text-gray-900 dark:text-white">
                        {formatCurrency(selectedDevisDetail.frais_frac)}
                      </p>
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Coût total
                      </label>
                      <p className="text-gray-900 dark:text-white font-medium">
                        {formatCurrency(selectedDevisDetail.cout_total_tarif)}
                      </p>
                    </div>
                  </div>
                </div>

                {/* Footer avec bouton */}
                <div className="mt-6">
                  {!selectedDevisDetail.selected && !selectedDevisDetail.refused && selectedDevisDetail.statut !== 'envoye' && (
                    <button
                      onClick={() => {
                        handleChoisirDevis(selectedDevisDetail.id);
                        setShowDevisModal(false);
                      }}
                      className="w-full bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-3 rounded-lg font-medium transition-colors cursor-pointer flex items-center justify-center"
                    >
                      <i className="ri-check-line mr-2"></i>
                      Choisir ce devis
                    </button>
                  )}

                  {selectedDevisDetail.statut === 'accepte' && (
                    <div className="text-center py-3 bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-300 rounded-lg border border-green-200 dark:border-green-800">
                      <i className="ri-check-double-line mr-2"></i>
                      Devis accepté par le client
                    </div>
                  )}

                  {selectedDevisDetail.statut === 'envoye' && (
                    <div className="text-center py-3 bg-orange-50 dark:bg-orange-900/20 text-orange-800 dark:text-orange-300 rounded-lg border border-orange-200 dark:border-orange-800">
                      <i className="ri-send-plane-line mr-2"></i>
                      Devis envoyé à l'apporteur
                    </div>
                  )}

                  {selectedDevisDetail.selected && !selectedDevisDetail.refused && selectedDevisDetail.statut !== 'envoye' && selectedDevisDetail.statut !== 'accepte' && (
                    <div className="text-center py-3 bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-300 rounded-lg border border-blue-200 dark:border-blue-800">
                      <i className="ri-check-line mr-2"></i>
                      Devis sélectionné pour validation client
                    </div>
                  )}

                  {selectedDevisDetail.refused && (
                    <div className="space-y-3">
                      <div className="bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-300 rounded-lg border border-red-200 dark:border-red-800 p-3 text-center">
                        <i className="ri-close-line mr-2"></i>
                        <span className="font-medium">Refusé par le client</span>
                        <p className="text-sm mt-1">
                          motif : {selectedDevisDetail.motif_refus || '—'}
                        </p>
                      </div>

                      <button
                        onClick={() => handleRenvoyerDevis(selectedDevisDetail.id)}
                        className="w-full bg-orange-600 hover:bg-orange-700 dark:bg-orange-500 dark:hover:bg-orange-600 text-white px-4 py-3 rounded-lg font-medium transition-colors cursor-pointer flex items-center justify-center"
                      >
                        <i className="ri-send-plane-line mr-2"></i>
                        Renvoyer le devis
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* MODAL AJOUT DOCUMENT */}
      {showDocumentModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="flex items-center justify-center min-h-screen px-4">
            <div className="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onClick={() => setShowDocumentModal(false)}></div>
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-xl transform transition-all sm:max-w-md w-full p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                  Ajouter un document
                </h3>
                <button
                  onClick={() => setShowDocumentModal(false)}
                  className="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 cursor-pointer"
                >
                  <i className="ri-close-line text-xl"></i>
                </button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Type de document
                  </label>
                  <Select value={newDocumentType} onValueChange={setNewDocumentType}>
                    <SelectTrigger className="w-full">
                      <SelectValue placeholder="Sélectionner un type" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="offrePret">Offre de Prêt</SelectItem>
                      <SelectItem value="tableauAmortissement">Tableau d'Amortissement</SelectItem>
                      <SelectItem value="carteIdentite">Carte d'Identité (Emprunteur)</SelectItem>
                      {dossier.type === 'couple' && (
                        <SelectItem value="carteIdentiteConjoint">Carte d'Identité (Conjoint)</SelectItem>
                      )}
                      <SelectItem value="bulletinDePaie">Bulletin de Paie</SelectItem>
                      <SelectItem value="avisImposition">Avis d'Imposition</SelectItem>
                      <SelectItem value="contratTravail">Contrat de Travail</SelectItem>
                      <SelectItem value="autre">Autre Document</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Fichier
                  </label>
                  <div className="flex items-center justify-center w-full">
                    <label
                      className="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                      onDragOver={handleDragOver}
                      onDragEnter={handleDragEnter}
                      onDragLeave={handleDragLeave}
                      onDrop={handleDrop}
                    >
                      <div className="flex flex-col items-center justify-center pt-5 pb-6">
                        <i className="ri-upload-cloud-line text-gray-500 dark:text-gray-400 text-2xl mb-2"></i>
                        <p className="text-sm text-gray-500 dark:text-gray-400">
                          <span className="font-medium text-[#335FAD] dark:text-[#335FAD]/80">Cliquez pour télécharger</span> ou glissez-déposez
                        </p>
                        {newDocumentFile && (
                          <p className="text-xs text-green-600 dark:text-green-400 mt-1">
                            ✓ {newDocumentFile.name}
                          </p>
                        )}
                      </div>
                      <input
                        type="file"
                        className="hidden"
                        onChange={handleFileChange}
                        accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                      />
                    </label>
                  </div>
                </div>

                <div className="flex justify-end space-x-3 pt-4">
                  <button
                    onClick={() => {
                      setShowDocumentModal(false);
                      setNewDocumentType('');
                      setNewDocumentFile(null);
                    }}
                    disabled={isUploadingDocument}
                    className="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Annuler
                  </button>
                  <button
                    onClick={handleUploadDocument}
                    disabled={!newDocumentType || !newDocumentFile || isUploadingDocument}
                    className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                  >
                    {isUploadingDocument ? (
                      <>
                        <i className="ri-loader-4-line animate-spin"></i>
                        <span>Upload en cours...</span>
                      </>
                    ) : (
                      <>
                        <i className="ri-upload-line"></i>
                        <span>Ajouter le document</span>
                      </>
                    )}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* MODAL SUPPRESSION DOCUMENT */}
      {showDeleteDocModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="flex items-center justify-center min-h-screen px-4">
            <div className="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onClick={() => setShowDeleteDocModal(false)}></div>
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-xl transform transition-all sm:max-w-md w-full p-6">
              <div className="text-center">
                <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/30 mb-4">
                  <i className="ri-delete-bin-line text-red-600 dark:text-red-400 text-xl"></i>
                </div>
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
                  Supprimer le document
                </h3>
                <p className="text-gray-600 dark:text-gray-400 mb-6">
                  Êtes-vous sûr de vouloir supprimer ce document ? Cette action est irréversible.
                </p>
                <div className="flex justify-center space-x-3">
                  <button
                    onClick={() => setShowDeleteDocModal(false)}
                    className="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                  >
                    Annuler
                  </button>
                  <button
                    onClick={() => {
                      if (documentToDelete) {
                        handleDeleteDocument(documentToDelete, 'document');
                      }
                    }}
                    className="bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                  >
                    Supprimer
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* MODAL COMPARAISON DE DONNÉES */}
      {showComparisonModal && diffReport && (
        <DataComparisonModal
          isOpen={showComparisonModal}
          onClose={async () => {
            // Marquer la modale comme vue dans la DB
            try {
              const { error } = await supabase
                .from('dossiers')
                .update({ comparison_modal_seen: true })
                .eq('id', dossierId);

              if (error) {
                console.error('[AdminDetail] Erreur marquage modale vue:', error);
              }
            } catch (err) {
              console.error('[AdminDetail] Erreur marquage modale:', err);
            }

            setShowComparisonModal(false);
            setDiffReport(null);
            setExtractedClientData(null);
          }}
          diffReport={diffReport}
          onApplyChanges={handleApplyDataChanges}
        />
      )}

      {/* MODAL SUPPRESSION DOSSIER */}
      {showDeleteModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="flex items-center justify-center min-h-screen px-4 py-6">
            <div
              className="fixed inset-0 bg-black bg-opacity-50 transition-opacity"
              onClick={() => setShowDeleteModal(false)}
            ></div>
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-xl transform transition-all sm:max-w-lg w-full p-6 relative z-10 my-8 max-h-[90vh] overflow-y-auto">
              {/* Header avec icône de danger */}
              <div className="text-center mb-6">
                <div className="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 dark:bg-red-900/30 mb-4">
                  <i className="ri-delete-bin-line text-red-600 dark:text-red-400 text-3xl"></i>
                </div>
                <h3 className="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                  Supprimer le dossier {dossier.numero_dossier}
                </h3>
                <p className="text-sm text-gray-600 dark:text-gray-400">
                  Cette action est irréversible et supprimera définitivement :
                </p>
              </div>

              {/* Liste des éléments qui seront supprimés */}
              <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-6">
                <ul className="space-y-2 text-sm text-red-900 dark:text-red-300">
                  <li className="flex items-start">
                    <i className="ri-close-circle-line text-red-600 dark:text-red-400 mr-2 mt-0.5"></i>
                    <span>Le dossier et toutes ses métadonnées</span>
                  </li>
                  <li className="flex items-start">
                    <i className="ri-close-circle-line text-red-600 dark:text-red-400 mr-2 mt-0.5"></i>
                    <span>Les informations client (principal et conjoint)</span>
                  </li>
                  <li className="flex items-start">
                    <i className="ri-close-circle-line text-red-600 dark:text-red-400 mr-2 mt-0.5"></i>
                    <span>Les données de prêt</span>
                  </li>
                  <li className="flex items-start">
                    <i className="ri-close-circle-line text-red-600 dark:text-red-400 mr-2 mt-0.5"></i>
                    <span>Tous les devis générés</span>
                  </li>
                  <li className="flex items-start">
                    <i className="ri-close-circle-line text-red-600 dark:text-red-400 mr-2 mt-0.5"></i>
                    <span>Tous les documents associés</span>
                  </li>
                </ul>
              </div>

              {/* Champ de confirmation */}
              <div className="mb-6">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Pour confirmer, tapez <span className="font-bold text-red-600 dark:text-red-400">SUPPRIMER</span>
                </label>
                <input
                  type="text"
                  value={deleteConfirmInput}
                  onChange={(e) => setDeleteConfirmInput(e.target.value)}
                  placeholder="Tapez SUPPRIMER"
                  className="w-full px-4 py-3 border-2 border-red-300 dark:border-red-700 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 dark:bg-gray-700 dark:text-white transition-colors"
                  autoFocus
                />
              </div>

              {/* Warning final */}
              <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 mb-6">
                <div className="flex items-start">
                  <i className="ri-alert-line text-amber-600 dark:text-amber-400 mr-2 mt-0.5"></i>
                  <p className="text-xs text-amber-800 dark:text-amber-300">
                    <strong>Attention :</strong> Cette action ne peut pas être annulée. Toutes les données seront perdues définitivement.
                  </p>
                </div>
              </div>

              {/* Boutons d'action */}
              <div className="flex justify-end space-x-3">
                <button
                  onClick={() => {
                    setShowDeleteModal(false);
                    setDeleteConfirmInput('');
                  }}
                  className="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg font-medium transition-colors"
                >
                  Annuler
                </button>
                <button
                  onClick={confirmDeleteDossier}
                  disabled={deleteConfirmInput !== 'SUPPRIMER'}
                  className="px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors flex items-center gap-2"
                >
                  <i className="ri-delete-bin-line"></i>
                  Supprimer définitivement
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal Visualiseur de Document */}
      <DocumentViewerModal
        isOpen={showDocModal}
        onClose={() => setShowDocModal(false)}
        documentUrl={currentDocUrl}
        documentId={currentDocId}
        documentTitle={currentDocTitle}
        documentType={currentDocType}
      />
    </div>
  );
}

================
File: app/admin/dossiers/[id]/page.tsx
================
import { Suspense } from 'react';
import { DossiersService } from '@/lib/services/dossiers';
import AdminDossierDetailContent from './AdminDossierDetailContent';

// Page export statique: pas de rendu dynamique côté serveur

// Fallback pour output: export → on renvoie une liste vide (Next export autorise la navigation dynamique si on gère côté client)
export async function generateStaticParams() {
  try {
    const all = await DossiersService.getAllDossiers();
    // Limiter le volume pour l'export statique, sinon renvoyer une liste vide
    return (all || []).slice(0, 50).map((d: any) => ({ id: d.id }));
  } catch {
    return [] as { id: string }[];
  }
}

export default async function AdminDossierDetailPage({ params }: { params: Promise<{ id: string }> }) {
  const awaited = await params;
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Chargement du dossier...</p>
        </div>
      </div>
    }>
      <AdminDossierDetailContent dossierId={awaited.id} />
    </Suspense>
  );
}

================
File: app/admin/dossiers/page.tsx
================
'use client';

import { useState, useEffect, useMemo } from 'react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useRouter } from 'next/navigation';
import AdminHeader from '../../../components/AdminHeader';
import { DossiersService } from '@/lib/services/dossiers';
import { ApporteursService } from '@/lib/services/apporteurs';
import { DossierReadStatusService } from '@/lib/services/dossier-read-status';
import { ReadStatusCache } from '@/lib/services/read-status-cache';
import DossierCard from '@/components/DossierCard';
import { mapStatutForDisplay, getStatutBadgeConfig } from '@/lib/utils/statut-mapping';
import { formatCurrency, formatDate, getAgeColor } from '@/lib/utils/formatters';
import { useBrokerContext } from '@/hooks/useBrokerContext';
import { EmptyState } from '@/components/ui/empty-state';

// Interface pour les données admin
interface AdminData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
}

// Interface pour un dossier (adaptée aux données Supabase)
interface Dossier {
  id: string;
  numero_dossier: string;
  apporteur_id: string | null;
  client_infos: Array<{
    client_nom: string;
    client_prenom: string;
    client_email: string;
    client_telephone: string | null;
  }>;
  pret_data: Array<{
    montant_capital: number;
    banque_preteuse: string;
    duree_mois: number;
    type_pret: string;
  }>;
  apporteur_profiles: {
    nom: string;
    prenom: string;
    email: string;
  } | null;
  statut: string | null; // canonique DB: en_attente, devis_disponible, devis_accepte, refuse, finalise
  type_dossier: string;
  is_couple: boolean;
  date_creation: string | null;
  age_jours?: number;
  is_read?: boolean;
  devis?: Array<{ id: string; statut: string | null; date_generation?: string | null }>;
  admin_status?: 'nouveau' | 'devis_envoye' | 'valide' | 'refuse' | 'finalise';
}

// Interface pour un apporteur avec compteur
interface ApporteurWithCount {
  id: string;
  nom: string;
  prenom: string;
  email: string;
  nouveauxDossiers: number;
  totalDossiers: number;
}

export default function AdminDossiersPage() {
  const router = useRouter();
  const [darkMode, setDarkMode] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedStatus, setSelectedStatus] = useState<'tous' | 'nouveau' | 'en_cours' | 'devis_envoye' | 'valide' | 'refuse' | 'finalise'>('tous');
  const [selectedApporteur, setSelectedApporteur] = useState('');
  const [sortField, setSortField] = useState<keyof Dossier>('date_creation');
  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10);
  const [dossiers, setDossiers] = useState<Dossier[]>([]);
  const [apporteurs, setApporteurs] = useState<ApporteurWithCount[]>([]);
  const [error, setError] = useState<string | null>(null);
  const [unreadStats, setUnreadStats] = useState<Record<string, number>>({});
  const [isMobile, setIsMobile] = useState(false);
  const { currentBrokerId } = useBrokerContext();

  // Données admin simulées
  const adminData = useMemo<AdminData>(() => ({
    id: '00000000-0000-0000-0000-000000000001', // UUID valide pour l'admin
    firstName: 'Alexandre',
    lastName: 'Martin',
    initials: 'AM',
    role: 'Administrateur'
  }), []);

  /**
   * 🎯 Dérive le statut admin depuis le statut canonique
   * ✅ Utilise l'utilitaire centralisé pour garantir la cohérence
   */
  const deriveAdminStatus = (d: any): Dossier['admin_status'] => {
    // Priorité : computed_statut (depuis la vue) > statut (devrait être statut_canon)
    const statutCanonique = (d?.computed_statut || d?.statut || 'en_attente').toString();

    // ✅ Utilise la fonction centralisée de mapping
    return mapStatutForDisplay(statutCanonique) as Dossier['admin_status'];
  };

  // Chargement des dossiers et apporteurs depuis Supabase
  const [refreshKey, setRefreshKey] = useState(0);
  useEffect(() => {
    const loadData = async () => {
      try {
        setLoading(true);
        setError(null);

        // Charger les dossiers
        const dossiersData = await DossiersService.getAllDossiers(currentBrokerId || undefined);

        // Dériver un statut admin rétroactif depuis devis (si présent dans la requête)
        const dossiersWithDerived = dossiersData.map((d: any) => ({
          ...d,
          admin_status: deriveAdminStatus(d)
        }))

        // Ajouter l'âge en jours, admin_status et fusionner avec le cache local
        const dossiersWithAge = dossiersData.map((dossier: any) => {
          const cachedStatus = ReadStatusCache.getReadStatus(dossier.id);
          const finalIsRead = cachedStatus !== null ? cachedStatus : dossier.is_read;
          const admin_status = deriveAdminStatus(dossier);

          return {
            ...dossier,
            is_read: finalIsRead,
            admin_status,
            age_jours: dossier.date_creation
              ? Math.floor((Date.now() - new Date(dossier.date_creation).getTime()) / (1000 * 60 * 60 * 24))
              : 0
          } as Dossier;
        });

        setDossiers(dossiersWithDerived);

        // Charger les apporteurs avec leurs statistiques
        const apporteursData = await ApporteursService.getAllApporteurs(currentBrokerId || undefined);

        const apporteursWithStats = apporteursData.map((apporteur: any) => {
          const totalDossiers = apporteur.dossiers?.length || 0;
          const nouveauxDossiers = apporteur.dossiers?.filter((d: any) =>
            (d.statut === 'en_attente' || d.statut === 'nouveau')
          ).length || 0;

          return {
            id: apporteur.id,
            nom: apporteur.nom,
            prenom: apporteur.prenom,
            email: apporteur.email,
            totalDossiers,
            nouveauxDossiers
          };
        });

        setApporteurs(apporteursWithStats);

      } catch (err) {
        console.error('Erreur lors du chargement des données:', err);
        setError('Erreur lors du chargement des données');
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, [refreshKey, currentBrokerId]);

  // Rafraîchir la liste au retour sur l’onglet/fenêtre
  useEffect(() => {
    const onFocus = () => setRefreshKey((k) => k + 1);
    window.addEventListener('focus', onFocus);
    return () => window.removeEventListener('focus', onFocus);
  }, []);

  // Synchroniser le cache au montage et au démontage
  useEffect(() => {
    // Forcer la synchronisation au montage
    ReadStatusCache.forceSync();

    // Debug: Afficher le cache
    console.log('🔍 Cache au montage:', ReadStatusCache);

    // Nettoyer les timeouts au démontage
    return () => {
      ReadStatusCache.forceSync();
    };
  }, []);

  // Écouter les synchronisations du cache
  useEffect(() => {
    const unsubscribe = ReadStatusCache.onSync(() => {
      // Mettre à jour les dossiers avec le cache après synchronisation
      setDossiers(prev => prev.map(dossier => {
        const cachedStatus = ReadStatusCache.getReadStatus(dossier.id);
        return cachedStatus !== null ? { ...dossier, is_read: cachedStatus } : dossier;
      }));
    });

    return unsubscribe;
  }, []);

  // Calculer les stats de dossiers non lus quand les dossiers changent
  useEffect(() => {
    updateUnreadStats();
  }, [dossiers]);

  // Détecter si on est en mobile/tablette
  useEffect(() => {
    const checkIsMobile = () => {
      setIsMobile(window.innerWidth < 1024); // lg breakpoint
    };

    checkIsMobile();
    window.addEventListener('resize', checkIsMobile);

    return () => window.removeEventListener('resize', checkIsMobile);
  }, []);

  // Les apporteurs sont maintenant chargés depuis la DB dans useEffect

  // Fonction pour marquer un dossier comme lu (optimiste)
  const markDossierAsRead = (dossierId: string) => {
    // Mise à jour optimiste immédiate
    setDossiers(prev => prev.map(dossier =>
      dossier.id === dossierId ? { ...dossier, is_read: true } : dossier
    ));

    // Ajouter au cache pour synchronisation en arrière-plan
    ReadStatusCache.markAsReadOptimistic(dossierId);

    // Recalculer les stats des apporteurs
    updateUnreadStats();
  };

  // Fonction pour mettre à jour les stats de dossiers non lus
  const updateUnreadStats = () => {
    const stats: Record<string, number> = {};

    dossiers.forEach(dossier => {
      if (!dossier.is_read && dossier.apporteur_profiles) {
        const apporteurId = dossier.apporteur_id;
        if (apporteurId) {
          stats[apporteurId] = (stats[apporteurId] || 0) + 1;
        }
      }
    });

    setUnreadStats(stats);
  };

  // Initialisation du mode sombre
  useEffect(() => {
    if (typeof window !== 'undefined' && !isInitialized) {
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      setDarkMode(savedDarkMode);

      if (savedDarkMode) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }

      setIsInitialized(true);
    }
  }, [isInitialized]);

  const handleDarkModeToggle = (newDarkMode: boolean) => {
    setDarkMode(newDarkMode);

    if (typeof window !== 'undefined') {
      if (newDarkMode) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('darkMode', 'true');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('darkMode', 'false');
      }
    }
  };

  const handleViewDetails = (dossierId: string) => {
    router.push(`/admin/dossiers/${dossierId}`);
  };

  // Gestionnaire pour le bouton Nouveau Dossier Admin
  const handleNouveauDossierAdmin = () => {
    router.push('/admin/nouveau-dossier');
  };

  // Fonction pour gérer les clics sur les cartes de statistiques
  const handleStatBadgeClick = (statType: string) => {
    switch (statType) {
      case 'nouveaux':
        setSelectedStatus('nouveau');
        break;
      case 'enCours':
        setSelectedStatus('en_cours');
        break;
      case 'total':
      default:
        setSelectedStatus('tous');
        break;
    }
    setCurrentPage(1);
  };

  // Filtrage et tri des dossiers
  const filteredAndSortedDossiers = useMemo(() => {
    let filtered = dossiers.filter(dossier => {
      const matchesSearch = searchQuery === '' ||
        dossier.numero_dossier.toLowerCase().includes(searchQuery.toLowerCase()) ||
        (dossier.client_infos && dossier.client_infos.length > 0 &&
          `${dossier.client_infos[0].client_prenom} ${dossier.client_infos[0].client_nom}`.toLowerCase().includes(searchQuery.toLowerCase()));

      const matchesStatus = selectedStatus === 'tous' ||
        (selectedStatus === 'en_cours' ? (dossier.admin_status !== 'finalise') : dossier.admin_status === selectedStatus);

      // Filtre par apporteur
      const matchesApporteur = selectedApporteur === '' ||
        (dossier.apporteur_profiles &&
          `${dossier.apporteur_profiles.prenom} ${dossier.apporteur_profiles.nom}` === selectedApporteur);

      return matchesSearch && matchesStatus && matchesApporteur;
    });

    filtered.sort((a, b) => {
      let aValue: any;
      let bValue: any;

      if (sortField === 'date_creation') {
        aValue = new Date(a.date_creation || 0).getTime();
        bValue = new Date(b.date_creation || 0).getTime();
      } else if (sortField === 'pret_data') {
        aValue = a.pret_data && a.pret_data.length > 0 ? a.pret_data[0].montant_capital : 0;
        bValue = b.pret_data && b.pret_data.length > 0 ? b.pret_data[0].montant_capital : 0;
      } else {
        aValue = a[sortField];
        bValue = b[sortField];
      }

      if (typeof aValue === 'string' && typeof bValue === 'string') {
        aValue = aValue.toLowerCase();
        bValue = bValue.toLowerCase();
      }

      if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
      if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });

    return filtered;
  }, [dossiers, searchQuery, selectedStatus, selectedApporteur, sortField, sortDirection]);

  // Pagination
  const totalPages = Math.ceil(filteredAndSortedDossiers.length / itemsPerPage);
  const paginatedDossiers = filteredAndSortedDossiers.slice(
    (currentPage - 1) * itemsPerPage,
    currentPage * itemsPerPage
  );

  // Statistiques calculées depuis les données
  const stats = useMemo(() => {
    const total = dossiers.length;
    const nouveaux = dossiers.filter(d => d.admin_status === 'nouveau').length;
    // En cours = tout sauf Finalisé
    const enCours = dossiers.filter(d => d.admin_status !== 'finalise').length;

    return { total, nouveaux, enCours };
  }, [dossiers]);

  // Compteurs par statut (admin)
  const statusCounts = useMemo(() => {
    return {
      tous: dossiers.length,
      nouveau: dossiers.filter(d => d.admin_status === 'nouveau').length,
      en_cours: dossiers.filter(d => d.admin_status !== 'finalise').length,
      devis_envoye: dossiers.filter(d => d.admin_status === 'devis_envoye').length,
      valide: dossiers.filter(d => d.admin_status === 'valide').length,
      finalise: dossiers.filter(d => d.admin_status === 'finalise').length,
      refuse: dossiers.filter(d => d.admin_status === 'refuse').length
    };
  }, [dossiers]);

  const handleSort = (field: keyof Dossier) => {
    if (sortField === field) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortDirection('asc');
    }
  };

  /**
   * 🎯 Badge de statut - Utilise la source de vérité unique
   * Note: adminStatus est déjà le résultat de mapStatutForDisplay()
   */
  const getStatusBadge = (adminStatus?: Dossier['admin_status']) => {
    // adminStatus est déjà mappé, on doit le "remonter" au statut canonique
    const reversMap: Record<string, string> = {
      'nouveau': 'en_attente',
      'devis_envoye': 'devis_disponible',
      'valide': 'devis_accepte',
      'refuse': 'refuse',
      'finalise': 'finalise'
    };

    const statutCanonique = reversMap[adminStatus || 'nouveau'] || 'en_attente';
    const config = getStatutBadgeConfig(statutCanonique);

    if (!config) {
      return (
        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
          Inconnu
        </span>
      );
    }

    return (
      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${config.color}`}>
        {config.text}
      </span>
    );
  };

  // ✅ Utilisation des formatters centralisés depuis lib/utils/formatters.ts

  if (!isInitialized || loading) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Chargement des dossiers...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
            <i className="ri-error-warning-line text-red-600 dark:text-red-400 text-2xl"></i>
          </div>
          <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
            Erreur de chargement
          </h3>
          <p className="text-gray-500 dark:text-gray-400 mb-4">{error}</p>
          <button
            onClick={() => window.location.reload()}
            className="bg-[#335FAD] hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg"
          >
            Réessayer
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      <AdminHeader
        darkMode={darkMode}
        setDarkMode={handleDarkModeToggle}
        adminData={adminData}
      />

      {/* Hero redesigné */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="px-4 sm:px-8 py-6 max-w-7xl mx-auto">
          <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
              <h1 className="text-2xl sm:text-3xl font-light text-gray-900 dark:text-white mb-2">
                Gestion des Dossiers
              </h1>
              <p className="text-gray-600 dark:text-gray-400">
                Supervisez et traitez tous les dossiers d'assurance de prêt
              </p>
            </div>

            <div className="flex items-center space-x-3">
              <button
                onClick={handleNouveauDossierAdmin}
                className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 hover:shadow-lg flex items-center space-x-2 whitespace-nowrap cursor-pointer"
              >
                <i className="ri-add-line text-lg"></i>
                <span>Créer un Dossier</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <main className="px-4 sm:px-8 py-6 max-w-7xl mx-auto">
        {/* Statistiques - CARTES CLIQUABLES */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div
            onClick={() => handleStatBadgeClick('total')}
            className={`bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm cursor-pointer transition-all duration-200 hover:shadow-md dark:hover:shadow-gray-900/20 ${selectedStatus === 'tous' ? 'ring-2 ring-[#335FAD] bg-[#335FAD]/5 dark:bg-[#335FAD]/10' : ''
              }`}
          >
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Total des dossiers</p>
                <p className="text-2xl font-light text-gray-900 dark:text-white">{stats.total}</p>
              </div>
              <div className="w-12 h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 rounded-lg flex items-center justify-center">
                <i className="ri-file-list-line text-[#335FAD] dark:text-[#335FAD] text-xl"></i>
              </div>
            </div>
          </div>

          <div
            onClick={() => handleStatBadgeClick('nouveaux')}
            className={`bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm cursor-pointer transition-all duration-200 hover:shadow-md dark:hover:shadow-gray-900/20 ${selectedStatus === 'nouveau' ? 'ring-2 ring-green-500 bg-green-50 dark:bg-green-900/20' : ''
              }`}
          >
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Nouveaux dossiers</p>
                <p className="text-2xl font-light text-gray-900 dark:text-white">{stats.nouveaux}</p>
              </div>
              <div className="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                <i className="ri-file-add-line text-green-600 dark:text-green-400 text-xl"></i>
              </div>
            </div>
          </div>

          <div
            onClick={() => handleStatBadgeClick('enCours')}
            className={`bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm cursor-pointer transition-all duration-200 hover:shadow-md dark:hover:shadow-gray-900/20 ${selectedStatus === 'en_cours' ? 'ring-2 ring-orange-500 bg-orange-50 dark:bg-orange-900/20' : ''
              }`}
          >
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 dark:text-gray-400">En cours</p>
                <p className="text-2xl font-light text-gray-900 dark:text-white">{stats.enCours}</p>
              </div>
              <div className="w-12 h-12 bg-orange-100 dark:bg-orange-900/30 rounded-lg flex items-center justify-center">
                <i className="ri-time-line text-orange-600 dark:text-orange-400 text-xl"></i>
              </div>
            </div>
          </div>
        </div>

        {/* Liste des apporteurs scrollable - Marge augmentée */}
        <div className="mb-8 pt-4">
          <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">Apporteurs</h3>
          <div className="flex gap-3 overflow-x-auto pb-3 pt-2">
            <button
              onClick={() => {
                setSelectedApporteur('');
                setCurrentPage(1);
              }}
              className={`flex-shrink-0 px-4 py-2 rounded-full border-2 whitespace-nowrap transition-all duration-200 hover:shadow-md cursor-pointer ${selectedApporteur === ''
                ? 'bg-[#335FAD] dark:bg-[#335FAD] text-white border-[#335FAD] dark:border-[#335FAD] shadow-md'
                : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700'
                }`}
            >
              Tous les apporteurs
            </button>
            {apporteurs.map(apporteur => (
              <button
                key={apporteur.id}
                onClick={() => {
                  setSelectedApporteur(`${apporteur.prenom} ${apporteur.nom}`);
                  setCurrentPage(1);
                }}
                className={`flex-shrink-0 px-4 py-2 rounded-full border-2 whitespace-nowrap transition-all duration-200 hover:shadow-md relative cursor-pointer ${selectedApporteur === `${apporteur.prenom} ${apporteur.nom}`
                  ? 'bg-[#335FAD] dark:bg-[#335FAD] text-white border-[#335FAD] dark:border-[#335FAD] shadow-md'
                  : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700'
                  }`}
              >
                {apporteur.prenom} {apporteur.nom}
                {(unreadStats[apporteur.id] || 0) > 0 && (
                  <span className="absolute -top-2 -right-2 bg-orange-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-medium shadow-lg">
                    {unreadStats[apporteur.id] > 9 ? '9+' : unreadStats[apporteur.id]}
                  </span>
                )}
              </button>
            ))}
          </div>
        </div>

        {/* Onglets par statut (admin) */}
        <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
          <div className="border-b border-gray-200 dark:border-gray-700">
            <nav className="flex overflow-x-auto">
              {[
                { key: 'tous', label: 'Tous', count: statusCounts.tous },
                { key: 'nouveau', label: 'Nouveau', count: statusCounts.nouveau },
                { key: 'en_cours', label: 'En cours', count: statusCounts.en_cours },
                { key: 'devis_envoye', label: 'Devis envoyé', count: statusCounts.devis_envoye },
                { key: 'valide', label: 'Validé', count: statusCounts.valide },
                { key: 'finalise', label: 'Finalisé', count: statusCounts.finalise },
                { key: 'refuse', label: 'Refusé', count: statusCounts.refuse }
              ].map((tab) => (
                <button
                  key={tab.key}
                  onClick={() => {
                    setSelectedStatus(tab.key as any);
                    setCurrentPage(1);
                  }}
                  className={`px-6 py-4 text-sm font-medium border-b-2 whitespace-nowrap transition-colors cursor-pointer ${selectedStatus === tab.key
                    ? 'border-indigo-500 text-[#335FAD] dark:text-[#335FAD]/80 bg-indigo-50 dark:bg-indigo-900/20'
                    : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50'
                    }`}
                >
                  {tab.label} ({tab.count})
                </button>
              ))}
            </nav>
          </div>

          {/* Barre de recherche */}
          <div className="p-6 border-b border-gray-200 dark:border-gray-700">
            <div className="relative max-w-md">
              <i className="ri-search-line absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500"></i>
              <input
                type="text"
                placeholder="Rechercher par numéro, client ou apporteur..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-[#335FAD] focus:border-transparent transition-colors"
              />
            </div>
          </div>

          {/* Tableau responsive amélioré - COLONNE PRIORITÉ SUPPRIMÉE */}
          <div className="overflow-x-auto">
            {/* Version desktop */}
            <div className="hidden lg:block">
              <table className="w-full">
                <thead className="bg-gray-50 dark:bg-gray-800/50">
                  <tr>
                    <th className="px-6 py-4 text-left">
                      <button
                        onClick={() => handleSort('numero_dossier')}
                        className="flex items-center space-x-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-gray-300 cursor-pointer"
                      >
                        <span>Numéro</span>
                        {sortField === 'numero_dossier' && (
                          <i className={`ri-arrow-${sortDirection === 'asc' ? 'up' : 'down'}-line`}></i>
                        )}
                      </button>
                    </th>
                    <th className="px-6 py-4 text-left">
                      <span className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Client
                      </span>
                    </th>
                    <th className="px-6 py-4 text-left">
                      <span className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Apporteur
                      </span>
                    </th>
                    <th className="px-6 py-4 text-left">
                      <span className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Statut
                      </span>
                    </th>
                    <th className="px-6 py-4 text-left">
                      <button
                        onClick={() => handleSort('pret_data')}
                        className="flex items-center space-x-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-gray-300 cursor-pointer"
                      >
                        <span>Montant</span>
                        {sortField === 'pret_data' && (
                          <i className={`ri-arrow-${sortDirection === 'asc' ? 'up' : 'down'}-line`}></i>
                        )}
                      </button>
                    </th>
                    <th className="px-6 py-4 text-left">
                      <button
                        onClick={() => handleSort('date_creation')}
                        className="flex items-center space-x-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-gray-300 cursor-pointer"
                      >
                        <span>Date</span>
                        {sortField === 'date_creation' && (
                          <i className={`ri-arrow-${sortDirection === 'asc' ? 'up' : 'down'}-line`}></i>
                        )}
                      </button>
                    </th>
                    <th className="px-6 py-4 text-right">
                      <span className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                        Actions
                      </span>
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                  {paginatedDossiers.map((dossier) => (
                    <tr
                      key={dossier.id}
                      className={`transition-colors duration-700 ease-out ${!dossier.is_read
                        ? 'bg-orange-50 dark:bg-orange-900/20 hover:bg-orange-100 dark:hover:bg-orange-900/30'
                        : 'hover:bg-gray-50 dark:hover:bg-gray-700/50'
                        }`}
                      onMouseEnter={() => !isMobile && !dossier.is_read && markDossierAsRead(dossier.id)}
                    >
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center gap-2">
                          <div className="text-sm font-medium text-gray-900 dark:text-white">
                            {dossier.numero_dossier}
                          </div>
                          {/* Indicateur de synchronisation */}
                          <div className="w-2 h-2 rounded-full bg-blue-500 animate-pulse"
                            style={{ display: ReadStatusCache.hasPendingUpdates(dossier.id) ? 'block' : 'none' }}
                            title="Synchronisation en cours...">
                          </div>
                        </div>
                        {dossier.age_jours !== undefined && (
                          <div className={`text-xs ${getAgeColor(dossier.age_jours)}`}>
                            {dossier.age_jours}j
                          </div>
                        )}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center gap-2">
                          <div className="text-sm font-medium text-gray-900 dark:text-white">
                            {(dossier.client_infos && dossier.client_infos.length > 0) ?
                              `${dossier.client_infos[0].client_prenom} ${dossier.client_infos[0].client_nom}` :
                              'N/A'
                            }
                          </div>
                          {dossier.is_couple ? (
                            <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">
                              <i className="ri-team-line mr-1 text-xs"></i>
                              Couple
                            </span>
                          ) : (
                            <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300">
                              <i className="ri-user-line mr-1 text-xs"></i>
                              Seul
                            </span>
                          )}
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-sm text-gray-900 dark:text-white">
                          {dossier.apporteur_profiles ?
                            `${dossier.apporteur_profiles.prenom} ${dossier.apporteur_profiles.nom}` :
                            'N/A'
                          }
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        {getStatusBadge(dossier.admin_status)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-sm font-medium text-gray-900 dark:text-white">
                          {(dossier.pret_data && dossier.pret_data.length > 0) ?
                            formatCurrency(dossier.pret_data[0].montant_capital, { compact: true }) :
                            'N/A'
                          }
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-sm text-gray-900 dark:text-white">
                          {dossier.date_creation ? formatDate(dossier.date_creation) : 'N/A'}
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button
                          onClick={() => handleViewDetails(dossier.id)}
                          className="text-[#335FAD] dark:text-[#335FAD]/80 hover:text-indigo-900 dark:hover:text-indigo-300 cursor-pointer"
                        >
                          Voir détails
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Version mobile/tablette - cartes empilées */}
            <div className="lg:hidden">
              <div className="p-4 space-y-4">
                {paginatedDossiers.map((dossier) => (
                  <DossierCard
                    key={dossier.id}
                    dossierId={dossier.id}
                    isRead={dossier.is_read || false}
                    onMarkAsRead={markDossierAsRead}
                    isResponsive={true}
                  >
                    <div
                      className={`rounded-lg p-4 border transition-colors duration-700 ease-out ${!dossier.is_read
                        ? 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800'
                        : 'bg-gray-50 dark:bg-gray-700/50 border-gray-200 dark:border-gray-600'
                        }`}
                    >
                      <div className="flex items-start justify-between mb-3">
                        <div>
                          <div className="text-sm font-medium text-gray-900 dark:text-white">
                            {dossier.numero_dossier}
                          </div>
                          {dossier.age_jours !== undefined && (
                            <div className={`text-xs ${getAgeColor(dossier.age_jours)}`}>
                              {dossier.age_jours}j
                            </div>
                          )}
                        </div>
                        {getStatusBadge(dossier.admin_status)}
                      </div>

                      <div className="space-y-2 mb-3">
                        <div className="flex items-center gap-2">
                          <span className="text-sm font-medium text-gray-900 dark:text-white">
                            {(dossier.client_infos && dossier.client_infos.length > 0) ?
                              `${dossier.client_infos[0].client_prenom} ${dossier.client_infos[0].client_nom}` :
                              'N/A'
                            }
                          </span>
                          {dossier.is_couple ? (
                            <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">
                              <i className="ri-team-line mr-1 text-xs"></i>
                              Couple
                            </span>
                          ) : (
                            <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300">
                              <i className="ri-user-line mr-1 text-xs"></i>
                              Seul
                            </span>
                          )}
                        </div>
                        <div className="text-sm text-gray-600 dark:text-gray-400">
                          Apporteur: {dossier.apporteur_profiles ?
                            `${dossier.apporteur_profiles.prenom} ${dossier.apporteur_profiles.nom}` :
                            'N/A'
                          }
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-sm font-medium text-gray-900 dark:text-white">
                            {(dossier.pret_data && dossier.pret_data.length > 0) ?
                              formatCurrency(dossier.pret_data[0].montant_capital, { compact: true }) :
                              'N/A'
                            }
                          </span>
                        </div>
                        <div className="text-xs text-gray-500 dark:text-gray-400">
                          {dossier.date_creation ? formatDate(dossier.date_creation) : 'N/A'}
                        </div>
                      </div>

                      <button
                        onClick={() => handleViewDetails(dossier.id)}
                        className="w-full bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer"
                      >
                        Voir détails
                      </button>
                    </div>
                  </DossierCard>
                ))}
              </div>
            </div>
          </div>

          {/* Pagination améliorée */}
          <div className="bg-white dark:bg-gray-800 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
            <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
              <div className="flex items-center space-x-2">
                <span className="text-sm text-gray-700 dark:text-gray-300">Afficher</span>
                <Select
                  value={String(itemsPerPage)}
                  onValueChange={(v) => {
                    setItemsPerPage(Number(v));
                    setCurrentPage(1);
                  }}
                >
                  <SelectTrigger className="w-[100px]">
                    <SelectValue placeholder="10" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="10">10</SelectItem>
                    <SelectItem value="25">25</SelectItem>
                    <SelectItem value="50">50</SelectItem>
                  </SelectContent>
                </Select>
                <span className="text-sm text-gray-700 dark:text-gray-300">
                  résultats sur {filteredAndSortedDossiers.length}
                </span>
              </div>

              <div className="flex items-center space-x-2">
                <button
                  onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
                  disabled={currentPage === 1}
                  className="px-3 py-2 rounded-md bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
                >
                  <i className="ri-arrow-left-s-line"></i>
                </button>

                <div className="flex items-center space-x-1">
                  {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                    let pageNum;
                    if (totalPages <= 5) {
                      pageNum = i + 1;
                    } else if (currentPage <= 3) {
                      pageNum = i + 1;
                    } else if (currentPage >= totalPages - 2) {
                      pageNum = totalPages - 4 + i;
                    } else {
                      pageNum = currentPage - 2 + i;
                    }

                    return (
                      <button
                        key={pageNum}
                        onClick={() => setCurrentPage(pageNum)}
                        className={`px-3 py-2 rounded-md text-sm font-medium cursor-pointer ${currentPage === pageNum
                          ? 'bg-indigo-600 dark:bg-indigo-5 0 text-white'
                          : 'bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600'
                          }`}
                      >
                        {pageNum}
                      </button>
                    );
                  })}
                </div>

                <button
                  onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
                  disabled={currentPage === totalPages}
                  className="px-3 py-2 rounded-md bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
                >
                  <i className="ri-arrow-right-s-line"></i>
                </button>
              </div>
            </div>
          </div>

          {/* État vide */}
          {paginatedDossiers.length === 0 && (
            <div className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700">
              {searchQuery || filterStatut !== 'tous' || filterApporteur ? (
                <EmptyState
                  icon="ri-search-line"
                  title="Aucun résultat"
                  description="Aucun dossier ne correspond à vos critères. Essayez de modifier vos filtres."
                  secondaryAction={{
                    label: "Réinitialiser les filtres",
                    onClick: () => {
                      setSearchQuery('');
                      setFilterStatut('tous');
                      setFilterApporteur(null);
                    }
                  }}
                />
              ) : (
                <EmptyState
                  icon="ri-inbox-line"
                  title="Aucun dossier"
                  description="Vos dossiers apparaîtront ici une fois que vos apporteurs en auront créé."
                  action={{
                    label: "Créer un dossier",
                    href: "/admin/nouveau-dossier"
                  }}
                />
              )}
            </div>
          )}
        </div>
      </main>
    </div>
  );
}

================
File: app/admin/nouveau-dossier/page.tsx
================
'use client';

import { useState, useEffect, useMemo } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { Suspense } from 'react';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
// SUPPRESSION DU HEADER ADMIN - Gardé seulement le header de base
import DossierTypeSelection from '../../../components/DossierTypeSelection';
import ClientInfoForm from '../../../components/ClientInfoForm';
import { formatCurrency } from '@/lib/utils/formatters';
import DocumentUpload from '../../../components/DocumentUpload';
import DossierProgress from '../../../components/DossierProgress';

// Types pour le dossier admin
export type DossierType = 'seul' | 'couple';

export interface ClientInfo {
  civilite: string;
  nom: string;
  prenom: string;
  nom_naissance: string;
  dateNaissance: string;
  categorie_professionnelle: number;
  revenus: string;
  fumeur: boolean;
  email: string;
  telephone: string;
  adresse: string;
  conjoint?: {
    civilite: string;
    nom: string;
    prenom: string;
    nom_naissance: string;
    dateNaissance: string;
    categorie_professionnelle: number;
    fumeur: boolean;
  };
}

export interface DocumentsInfo {
  offrePret: File | null;
  tableauAmortissement: File | null;
  carteIdentite: File | null;
  carteIdentiteConjoint?: File | null;
}

// Interface pour les devis de l'API
interface DevisAPI {
  id: string;
  compagnie: string;
  produit: string;
  cout_mensuel: number;
  cout_total: number;
  economie_estimee?: number;
  formalites_medicales: string[];
  couverture: string[];
  exclusions: string[];
  avantages: string[];
  taux_assurance: number;
  frais_adhesion: number;
  frais_frac: number;
}

// Interface pour les données admin
interface AdminData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
}

// Interface DossierData mise à jour pour admin
export interface AdminDossierData {
  type: DossierType;
  clientInfo: ClientInfo | null;
  documents: DocumentsInfo;
  commentaire?: string;
  numeroDossier?: string;
  apporteurId?: string; // ID de l'apporteur assigné
  devisGeneres?: DevisAPI[];
  devisSelectionne?: string;
}

// Composant principal avec gestion des paramètres URL
function AdminNouveauDossierContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [currentStep, setCurrentStep] = useState(1);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isGeneratingDevis, setIsGeneratingDevis] = useState(false);
  const [showIncompleteWarning, setShowIncompleteWarning] = useState(false);
  const [showDevisModal, setShowDevisModal] = useState(false);
  const [selectedDevisDetail, setSelectedDevisDetail] = useState<DevisAPI | null>(null);
  const [showAssignModal, setShowAssignModal] = useState(false);
  const [selectedApporteur, setSelectedApporteur] = useState('');
  const [darkMode, setDarkMode] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);
  
  const [dossierData, setDossierData] = useState<AdminDossierData>({
    type: 'seul',
    clientInfo: null,
    documents: {
      offrePret: null,
      tableauAmortissement: null,
      carteIdentite: null
    },
    commentaire: '',
    devisGeneres: [],
    devisSelectionne: undefined
  });

  // Données admin simulées
  const adminData = useMemo<AdminData>(() => ({
    id: 'admin1',
    firstName: 'Alexandre',
    lastName: 'Martin',
    initials: 'AM',
    role: 'Administrateur'
  }), []);

  // Liste des apporteurs disponibles (TODO: récupérer depuis Supabase)
  const apporteurs = useMemo(() => [
    { id: 'ap1', nom: 'Dubois', prenom: 'Marie', email: 'marie.dubois@email.com' },
    { id: 'ap2', nom: 'Leclerc', prenom: 'Jean', email: 'jean.leclerc@email.com' },
    { id: 'ap3', nom: 'Martin', prenom: 'Paul', email: 'paul.martin@email.com' },
    { id: 'ap4', nom: 'Bernard', prenom: 'Sophie', email: 'sophie.bernard@email.com' }
  ], []);

  // MOCK DATA ENRICHI - Devis simulés pour tester le workflow complet
  // TODO: INTÉGRATION API EXADE - Remplacer par l'appel réel à l'API de génération de devis
  const mockDevis = useMemo<DevisAPI[]>(() => [
    {
      id: 'devis1',
      compagnie: 'Generali',
      produit: 'ASSUREA PRET 7301 CI',
      cout_mensuel: 95.50,
      cout_total: 22920,
      economie_estimee: 44280,
      formalites_medicales: ['Questionnaire de santé simplifié', 'Examen médical si capital > 300k€'],
      couverture: ['Décès', 'PTIA', 'ITT', 'IPT'],
      exclusions: ['Sports extrêmes', 'Guerre', 'Suicide 1ère année'],
      avantages: ['Remboursement anticipé sans frais', 'Garantie chômage optionnelle', 'Téléconsultation médicale gratuite'],
      taux_assurance: 0.33,
      frais_adhesion: 30,
      frais_frac: 20
    },
    {
      id: 'devis2',
      compagnie: 'Swisslife',
      produit: 'EMPRUNTEUR SECURITE PLUS',
      cout_mensuel: 102.30,
      cout_total: 24552,
      economie_estimee: 42648,
      formalites_medicales: ['Questionnaire de santé détaillé', 'Téléconsultation médicale obligatoire'],
      couverture: ['Décès', 'PTIA', 'ITT', 'IPT', 'IPP 33%'],
      exclusions: ['Maladies préexistantes non déclarées', 'Sports à risque', 'Alcoolisme chronique'],
      avantages: ['Franchise ITT réduite à 30 jours', 'Prise en charge psychologique', 'Second avis médical gratuit'],
      taux_assurance: 0.39,
      frais_adhesion: 45,
      frais_frac: 12
    },
    {
      id: 'devis3',
      compagnie: 'Allianz',
      produit: 'ALLIANZ EMPRUNTEUR OPTIMAL',
      cout_mensuel: 89.75,
      cout_total: 21540,
      economie_estimee: 45660,
      formalites_medicales: ['Questionnaire de santé en ligne', 'Téléconsultation médicale gratuite'],
      couverture: ['Décès', 'PTIA', 'ITT', 'IPT', 'Invalidité permanente'],
      exclusions: ['Suicide 1ère année', 'Alcoolisme', 'Usage de stupéfiants'],
      avantages: ['Souscription 100% digitale', 'Tarif préférentiel non-fumeur', 'Application mobile dédiée'],
      taux_assurance: 0.31,
      frais_adhesion: 25,
      frais_frac: 8
    },
    {
      id: 'devis4',
      compagnie: 'Axa',
      produit: 'AXA EMPRUNTEUR SERENITE',
      cout_mensuel: 98.20,
      cout_total: 23568,
      economie_estimee: 43632,
      formalites_medicales: ['Questionnaire médical standard', 'Examen médical selon montant'],
      couverture: ['Décès', 'PTIA', 'ITT 100%', 'IPT 66%'],
      exclusions: ['Pratique de sports aériens', 'Conflits armés', 'Catastrophes naturelles'],
      avantages: ['Garantie dépendance incluse', 'Assistance juridique', 'Service de conciergerie'],
      taux_assurance: 0.35,
      frais_adhesion: 35,
      frais_frac: 15
    },
    {
      id: 'devis5',
      compagnie: 'MAIF',
      produit: 'MAIF PRET HABITATION+',
      cout_mensuel: 87.90,
      cout_total: 21096,
      economie_estimee: 46104,
      formalites_medicales: ['Déclaration de santé simplifiée', 'Examen médical si nécessaire'],
      couverture: ['Décès', 'PTIA', 'ITT', 'IPT', 'Maladies graves'],
      exclusions: ['Sports extrêmes', 'Tentative de suicide', 'Faute intentionnelle'],
      avantages: ['Tarification solidaire', 'Accompagnement personnalisé', 'Garantie fidélité'],
      taux_assurance: 0.30,
      frais_adhesion: 20,
      frais_frac: 10
    }
  ], []);

  // Initialisation du mode sombre
  useEffect(() => {
    if (typeof window !== 'undefined' && !isInitialized) {
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      setDarkMode(savedDarkMode);
      
      if (savedDarkMode) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      
      setIsInitialized(true);
    }
  }, [isInitialized]);

  const handleDarkModeToggle = (newDarkMode: boolean) => {
    setDarkMode(newDarkMode);
    
    if (typeof window !== 'undefined') {
      if (newDarkMode) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('darkMode', 'true');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('darkMode', 'false');
      }
    }
  };

  // EFFET: Vérifier les paramètres URL pour l'étape
  useEffect(() => {
    const step = searchParams.get('step');
    if (step) {
      const stepNumber = parseInt(step, 10);
      if (stepNumber >= 1 && stepNumber <= 4) {
        setCurrentStep(stepNumber);
      }
    }
  }, [searchParams]);

  // Navigation entre les étapes
  const nextStep = () => {
    if (currentStep < 4) {
      setCurrentStep(currentStep + 1);
    }
  };

  const prevStep = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
    }
  };

  // Mise à jour du type de dossier
  const handleTypeSelection = (type: DossierType) => {
    setDossierData(prev => ({
      ...prev,
      type,
      documents: {
        ...prev.documents,
        carteIdentiteConjoint: type === 'couple' ? null : undefined
      }
    }));
    nextStep();
  };

  // Mise à jour des informations client
  const handleClientInfoUpdate = (clientInfo: ClientInfo) => {
    setDossierData(prev => ({
      ...prev,
      clientInfo
    }));
    nextStep();
  };

  // Mise à jour des documents SANS passage automatique à l'étape suivante
  const handleDocumentsUpdate = async (documents: DocumentsInfo) => {
    setDossierData(prev => ({
      ...prev,
      documents
    }));

    // NE PAS appeler nextStep() automatiquement
    // L'utilisateur doit cliquer sur "Envoyer à l'API" pour continuer
  };

  // Fonction séparée pour la soumission de l'étape 3
  const handleSubmitStep3 = async () => {
    // Vérifier si tous les documents obligatoires sont présents
    const isComplete = isDossierComplete();
    
    if (!isComplete) {
      alert('Veuillez uploader tous les documents obligatoires avant de continuer.');
      return;
    }

    // Générer les devis automatiquement
    await generateDevis(dossierData);
    
    // Passer à l'étape suivante
    nextStep();
  };

  // Génération des devis via l'API
  const generateDevis = async (data: AdminDossierData) => {
    setIsGeneratingDevis(true);
    
    try {
      // Essayer d'abord l'API EXADE réelle
      try {
        const response = await fetch('/api/exade/tarifs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            client: {
              nom: data.clientInfo?.nom,
              prenom: data.clientInfo?.prenom,
              dateNaissance: data.clientInfo?.dateNaissance,
              fumeur: data.clientInfo?.fumeur,
              categorie_professionnelle: data.clientInfo?.categorie_professionnelle,
              revenus: parseFloat(data.clientInfo?.revenus || '0')
            },
            pret: {
              montant: 350000, // Valeur par défaut pour les tests
              duree: 240,
              type: 'immobilier'
            },
            conjoint: data.type === 'couple' ? {
              nom: data.clientInfo?.conjoint?.nom,
              prenom: data.clientInfo?.conjoint?.prenom,
              dateNaissance: data.clientInfo?.conjoint?.dateNaissance,
              fumeur: data.clientInfo?.conjoint?.fumeur,
              categorie_professionnelle: data.clientInfo?.conjoint?.categorie_professionnelle
            } : null
          })
        });

        if (response.ok) {
          const apiResponse = await response.json();
          console.log('✅ Devis générés via API EXADE:', apiResponse);
          
          // Mapper les données de l'API vers notre format
          const devisFromAPI = apiResponse.map((quote: any, index: number) => ({
            id: `devis_api_${index}`,
            compagnie: quote.compagnie || 'Compagnie API',
            produit: quote.produit || 'Produit API',
            cout_mensuel: quote.cout_mensuel || 0,
            cout_total: quote.cout_total || 0,
            economie_estimee: quote.economie_estimee || 0,
            formalites_medicales: quote.formalites_medicales || ['Questionnaire médical'],
            couverture: quote.couverture || ['Décès', 'PTIA', 'ITT'],
            exclusions: quote.exclusions || ['Suicide 1ère année'],
            avantages: quote.avantages || ['Tarif préférentiel'],
            taux_assurance: quote.taux_assurance || 0.35,
            frais_adhesion: quote.frais_adhesion || 30,
            frais_frac: quote.frais_frac || 15
          }));

          setDossierData(prev => ({
            ...prev,
            devisGeneres: devisFromAPI
          }));

          console.log('📋 Nombre de devis API:', devisFromAPI.length);
          return;
        }
      } catch (apiError) {
        console.warn('⚠️ API EXADE non disponible, utilisation des données mock:', apiError);
      }

      // Fallback vers les données mock si l'API échoue
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      setDossierData(prev => ({
        ...prev,
        devisGeneres: mockDevis
      }));

      console.log('✅ Devis générés avec succès (simulation)');
      console.log('📋 Nombre de devis:', mockDevis.length);
      console.log('💰 Meilleure économie:', Math.max(...mockDevis.map(d => d.economie_estimee || 0)), '€');

    } catch (error) {
      console.error('❌ Erreur génération devis:', error);
      alert('Erreur lors de la génération des devis');
    } finally {
      setIsGeneratingDevis(false);
    }
  };

  // Vérifier si le dossier est complet
  const isDossierComplete = (data?: AdminDossierData) => {
    const currentData = data || dossierData;
    
    if (!currentData.clientInfo) return false;
    
    const clientInfo = currentData.clientInfo;
    const requiredClientFields = ['civilite', 'nom', 'prenom', 'nom_naissance', 'dateNaissance', 'email', 'telephone'];
    
    for (const field of requiredClientFields) {
      if (!clientInfo[field as keyof ClientInfo] || String(clientInfo[field as keyof ClientInfo]).trim() === '') {
        return false;
      }
    }
    
    // Vérifier categorie_professionnelle
    if (!clientInfo.categorie_professionnelle || clientInfo.categorie_professionnelle === 0) {
      return false;
    }

    if (currentData.type === 'couple' && clientInfo.conjoint) {
      const requiredConjointFields = ['civilite', 'nom', 'prenom', 'nom_naissance', 'dateNaissance'];
      for (const field of requiredConjointFields) {
        if (!clientInfo.conjoint[field as keyof typeof clientInfo.conjoint] || 
            String(clientInfo.conjoint[field as keyof typeof clientInfo.conjoint]).trim() === '') {
          return false;
        }
      }
      
      // Vérifier categorie_professionnelle du conjoint
      if (!clientInfo.conjoint.categorie_professionnelle || clientInfo.conjoint.categorie_professionnelle === 0) {
        return false;
      }
    }

    const requiredDocs = ['offrePret', 'tableauAmortissement', 'carteIdentite'];
    if (currentData.type === 'couple') {
      requiredDocs.push('carteIdentiteConjoint');
    }

    for (const doc of requiredDocs) {
      if (!currentData.documents[doc as keyof DocumentsInfo]) {
        return false;
      }
    }

    return true;
  };

  // Sélectionner un devis
  const handleSelectDevis = (devisId: string) => {
    setDossierData(prev => ({
      ...prev,
      devisSelectionne: devisId
    }));
  };

  // Voir les détails d'un devis
  const handleViewDevisDetails = (devis: DevisAPI) => {
    setSelectedDevisDetail(devis);
    setShowDevisModal(true);
  };

  // Assigner à un apporteur
  const handleAssignToApporteur = () => {
    setShowAssignModal(true);
  };

  // Confirmer l'assignation
  const handleConfirmAssign = () => {
    if (selectedApporteur) {
      setDossierData(prev => ({
        ...prev,
        apporteurId: selectedApporteur
      }));
      setShowAssignModal(false);
      handleFinalSubmit('assign');
    }
  };

  // Envoyer directement par email au client
  const handleSendToClient = () => {
    handleFinalSubmit('email');
  };

  // Soumission finale du dossier
  const handleFinalSubmit = async (action: 'assign' | 'email') => {
    setIsSubmitting(true);
    
    try {
      const response = await fetch('/api/dossiers/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY}`,
        },
        body: JSON.stringify({
          type: dossierData.type,
          clientInfo: dossierData.clientInfo,
          commentaire: dossierData.commentaire,
          documents: dossierData.documents,
          devisSelectionne: dossierData.devisSelectionne,
          apporteurId: dossierData.apporteurId,
          action: action,
          isComplete: true,
          createdByAdmin: true
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Erreur lors de la création du dossier');
      }

      const result = await response.json();
      
      // Si un devis est sélectionné, créer les devis en base
      if (dossierData.devisSelectionne && dossierData.devisGeneres) {
        const selectedDevis = dossierData.devisGeneres.find(d => d.id === dossierData.devisSelectionne);
        if (selectedDevis) {
          // Créer les devis en base via l'API
          const devisResponse = await fetch('/api/admin/devis', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              dossierId: result.dossier.id,
              devis: dossierData.devisGeneres,
              selectedDevisId: dossierData.devisSelectionne
            })
          });

          if (!devisResponse.ok) {
            console.warn('Erreur lors de la création des devis en base');
          }
        }
      }
      
      // Redirection vers le détail du dossier créé
      router.push(`/admin/dossiers/${result.dossier.id}`);
      
    } catch (error) {
      console.error('Erreur lors de la création du dossier:', error);
      alert(`Erreur lors de la création du dossier: ${error instanceof Error ? error.message : 'Erreur inconnue'}`);
    } finally {
      setIsSubmitting(false);
    }
  };

  // Fonction pour enregistrer le dossier sans l'envoyer
  const handleSaveDossier = async () => {
    setIsSubmitting(true);
    
    try {
      const response = await fetch('/api/dossiers/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY}`,
        },
        body: JSON.stringify({
          type: dossierData.type,
          clientInfo: dossierData.clientInfo,
          commentaire: dossierData.commentaire,
          documents: dossierData.documents,
          devisSelectionne: dossierData.devisSelectionne,
          apporteurId: dossierData.apporteurId,
          action: 'save',
          isComplete: true,
          createdByAdmin: true
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Erreur lors de la sauvegarde du dossier');
      }

      const result = await response.json();
      
      // Si un devis est sélectionné, créer les devis en base
      if (dossierData.devisSelectionne && dossierData.devisGeneres) {
        try {
          const devisResponse = await fetch('/api/admin/devis', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              dossierId: result.dossier.id,
              devis: dossierData.devisGeneres,
              selectedDevisId: dossierData.devisSelectionne
            })
          });

          if (!devisResponse.ok) {
            console.warn('Erreur lors de la création des devis en base');
          }
        } catch (devisError) {
          console.warn('Erreur lors de la création des devis:', devisError);
        }
      }
      
      // Redirection vers la page des dossiers admin
      router.push('/admin/dossiers');
    } catch (error) {
      console.error('Erreur lors de la sauvegarde du dossier:', error);
      alert(`Erreur lors de la sauvegarde du dossier: ${error instanceof Error ? error.message : 'Erreur inconnue'}`);
    } finally {
      setIsSubmitting(false);
    }
  };

  // ✅ Utilisation du formatter centralisé depuis lib/utils/formatters.ts

  if (!isInitialized) {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      {/* HEADER SIMPLIFIÉ - Sans AdminHeader */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="px-4 sm:px-8 py-4 sm:py-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <button 
                onClick={() => router.push('/admin')}
                className="w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg flex items-center justify-center transition-colors cursor-pointer"
                title="Retour au tableau de bord"
              >
                <i className="ri-arrow-left-line text-gray-600 dark:text-gray-300"></i>
              </button>
              <div>
                <h1 className="text-xl font-medium text-gray-900 dark:text-white">
                  Créer un Nouveau Dossier
                </h1>
                <p className="text-sm text-gray-500 dark:text-gray-400">
                  Processus guidé avec génération automatique des devis
                </p>
              </div>
            </div>
            
            {/* Progress indicator */}
            <div className="hidden sm:block">
              <DossierProgress currentStep={currentStep} />
            </div>
          </div>
        </div>
      </div>

      {/* Mobile Progress */}
      <div className="sm:hidden px-4 py-4 bg-gray-50 dark:bg-gray-800/50">
        <DossierProgress currentStep={currentStep} />
      </div>

      {/* Main Content */}
      <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-6xl mx-auto">
        {currentStep === 1 && (
          <DossierTypeSelection 
            selectedType={dossierData.type}
            onTypeSelect={handleTypeSelection}
          />
        )}
        
        {currentStep === 2 && (
          <ClientInfoForm 
            dossierType={dossierData.type}
            initialData={dossierData.clientInfo}
            onSubmit={handleClientInfoUpdate}
            onBack={prevStep}
          />
        )}
        
        {currentStep === 3 && (
          <DocumentUpload 
            dossierType={dossierData.type}
            documents={dossierData.documents}
            onDocumentsUpdate={handleDocumentsUpdate}
            onBack={prevStep}
            onSubmit={handleSubmitStep3}
            isSubmitting={isGeneratingDevis}
            submitButtonText={isGeneratingDevis ? "Envoi à l'API..." : "Envoyer à l'API"}
          />
        )}

        {currentStep === 4 && (
          <div className="space-y-6">
            {/* Header de l'étape */}
            <div className="text-center">
              <h2 className="text-2xl font-light text-gray-900 dark:text-white mb-2">
                Devis générés automatiquement
              </h2>
              <p className="text-gray-600 dark:text-gray-400">
                Sélectionnez le meilleur devis et choisissez comment procéder
              </p>
            </div>

            {/* Génération en cours */}
            {isGeneratingDevis && (
              <div className="bg-[#335FAD]/5 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/80 rounded-xl p-6 text-center">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#335FAD] mx-auto mb-4"></div>
                <h3 className="text-lg font-medium text-[#335FAD] dark:text-[#335FAD]/80 mb-2">
                  Génération des devis en cours...
                </h3>
                <p className="text-[#335FAD]/80 dark:text-[#335FAD]/80">
                  Analyse des documents et calcul des meilleures offres disponibles
                </p>
                <div className="mt-4 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 rounded-lg p-3">
                  <p className="text-xs text-[#335FAD] dark:text-[#335FAD] font-medium">
                    🔄 Simulation API - En production, connecté à l'API Exade
                  </p>
                </div>
              </div>
            )}

            {/* Affichage conditionnel : soit en cours de génération, soit les devis */}
            {!isGeneratingDevis && (
              <>
                {/* Liste des devis - Affichage seulement si devis disponibles */}
                {dossierData.devisGeneres && dossierData.devisGeneres.length > 0 ? (
                  <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <div className="flex items-center justify-between mb-6">
                      <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                        Devis disponibles ({dossierData.devisGeneres.length})
                      </h3>
                      <div className="flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full">
                        <i className="ri-information-line"></i>
                        <span>Données simulées pour test</span>
                      </div>
                    </div>
                    
                    <div className="space-y-4">
                      {dossierData.devisGeneres.map((devis) => (
                        <div 
                          key={devis.id}
                          className={`border-2 rounded-xl p-4 transition-all cursor-pointer hover:shadow-md ${
                            dossierData.devisSelectionne === devis.id
                              ? 'border-[#335FAD] bg-[#335FAD]/5 dark:bg-[#335FAD]/10'
                              : 'border-gray-200 dark:border-gray-600 hover:border-gray-300 dark:hover:border-gray-500'
                          }`}
                          onClick={() => handleSelectDevis(devis.id)}
                        >
                          <div className="flex items-start justify-between mb-3">
                            <div className="flex-1">
                              <div className="flex items-center space-x-3 mb-2">
                                <h4 className="text-lg font-medium text-gray-900 dark:text-white">
                                  {devis.compagnie}
                                </h4>
                                {dossierData.devisSelectionne === devis.id && (
                                  <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[#335FAD]/10 text-[#335FAD] dark:bg-[#335FAD]/20 dark:text-[#335FAD]/80">
                                    <i className="ri-check-line mr-1"></i>
                                    Sélectionné
                                  </span>
                                )}
                              </div>
                              <p className="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                {devis.produit}
                              </p>
                              
                              <div className="grid grid-cols-1 sm:grid-cols-4 gap-4">
                                <div>
                                  <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                                    Coût mensuel
                                  </label>
                                  <p className="text-sm font-medium text-gray-900 dark:text-white">
                                    {formatCurrency(devis.cout_mensuel)}
                                  </p>
                                </div>
                                <div>
                                  <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                                    Coût total
                                  </label>
                                  <p className="text-sm font-medium text-gray-900 dark:text-white">
                                    {formatCurrency(devis.cout_total)}
                                  </p>
                                </div>
                                <div>
                                  <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                                    Économie estimée
                                  </label>
                                  <p className="text-sm font-medium text-green-600 dark:text-green-400">
                                    {formatCurrency(devis.economie_estimee || 0)}
                                  </p>
                                </div>
                                <div>
                                  <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                                    Taux d'assurance
                                  </label>
                                  <p className="text-sm font-medium text-gray-900 dark:text-white">
                                    {devis.taux_assurance}%
                                  </p>
                                </div>
                              </div>
                            </div>
                            
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                handleViewDevisDetails(devis);
                              }}
                              className="text-[#335FAD] dark:text-[#335FAD]/80 hover:text-[#335FAD]/70 dark:hover:text-[#335FAD]/90 text-sm font-medium cursor-pointer"
                            >
                              Voir détails
                            </button>
                          </div>
                          
                          <div className="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                            <span>Formalités: {devis.formalites_medicales.join(', ')}</span>
                            <span>Couverture: {devis.couverture.length} garanties</span>
                          </div>
                        </div>
                      ))}
                    </div>

                    {/* Résumé des devis */}
                    <div className="mt-6 bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                      <h4 className="text-sm font-medium text-gray-900 dark:text-white mb-2">
                        📊 Résumé des offres
                      </h4>
                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                        <div>
                          <span className="text-gray-500 dark:text-gray-400">Meilleur tarif :</span>
                          <span className="ml-2 font-medium text-green-600 dark:text-green-400">
                            {formatCurrency(Math.min(...mockDevis.map(d => d.cout_total)))}
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500 dark:text-gray-400">Économie max :</span>
                          <span className="ml-2 font-medium text-green-600 dark:text-green-400">
                            {formatCurrency(Math.max(...mockDevis.map(d => d.economie_estimee || 0)))}
                          </span>
                        </div>
                        <div>
                          <span className="text-gray-500 dark:text-gray-400">Taux moyen :</span>
                          <span className="ml-2 font-medium text-gray-900 dark:text-white">
                            {(mockDevis.reduce((acc, d) => acc + d.taux_assurance, 0) / mockDevis.length).toFixed(2)}%
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                ) : (
                  /* État d'erreur si pas de devis */
                  <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-6 text-center">
                    <i className="ri-error-warning-line text-red-600 dark:text-red-400 text-2xl mb-3"></i>
                    <h3 className="text-lg font-medium text-red-900 dark:text-red-200 mb-2">
                      Aucun devis généré
                    </h3>
                    <p className="text-red-700 dark:text-red-300 mb-4">
                      Une erreur s'est produite lors de la génération des devis. Veuillez réessayer.
                    </p>
                    <button
                      onClick={() => setCurrentStep(3)}
                      className="bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                    >
                      Retour aux documents
                    </button>
                  </div>
                )}

                {/* Actions finales - Seulement si un devis est sélectionné */}
                {dossierData.devisGeneres && dossierData.devisGeneres.length > 0 && dossierData.devisSelectionne && (
                  <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                      Comment souhaitez-vous procéder ?
                    </h3>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <button
                        onClick={handleAssignToApporteur}
                        disabled={isSubmitting}
                        className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white p-4 rounded-xl font-medium transition-colors disabled:opacity-50 cursor-pointer flex items-center justify-center space-x-2"
                      >
                        <i className="ri-user-add-line"></i>
                        <span>Assigner à un apporteur</span>
                      </button>
                      
                      <button
                        onClick={handleSendToClient}
                        disabled={isSubmitting}
                        className="bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white p-4 rounded-xl font-medium transition-colors disabled:opacity-50 cursor-pointer flex items-center justify-center space-x-2"
                      >
                        <i className="ri-mail-send-line"></i>
                        <span>Envoyer directement au client</span>
                      </button>

                      <button
                        onClick={handleSaveDossier}
                        disabled={isSubmitting}
                        className="bg-gray-600 hover:bg-gray-700 dark:bg-gray-500 dark:hover:bg-gray-600 text-white p-4 rounded-xl font-medium transition-colors disabled:opacity-50 cursor-pointer flex items-center justify-center space-x-2"
                      >
                        <i className="ri-save-line"></i>
                        <span>Enregistrer le dossier</span>
                      </button>
                    </div>
                    
                    <div className="mt-4 flex justify-between">
                      <button
                        onClick={prevStep}
                        className="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                      >
                        Retour
                      </button>
                    </div>
                  </div>
                )}
              </>
            )}
          </div>
        )}
      </main>

      {/* MODAL DÉTAIL DEVIS */}
      {showDevisModal && selectedDevisDetail && (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="flex items-center justify-center min-h-screen px-4">
            <div className="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onClick={() => setShowDevisModal(false)}></div>
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-xl transform transition-all sm:max-w-2xl w-full p-6 max-h-[90vh] my-[5vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-medium text-gray-900 dark:text-white">
                  Détails du devis - {selectedDevisDetail.compagnie}
                </h3>
                <button
                  onClick={() => setShowDevisModal(false)}
                  className="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 cursor-pointer"
                >
                  <i className="ri-close-line text-xl"></i>
                </button>
              </div>

              {/* Badge simulation */}
              <div className="mb-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-lg p-3">
                <div className="flex items-center">
                  <i className="ri-code-line text-amber-600 dark:text-amber-400 mr-2"></i>
                  <p className="text-xs text-amber-800 dark:text-amber-300">
                    <strong>Mode Simulation :</strong> Ces données sont fictives pour tester le workflow. 
                    En production, elles proviendront de l'API Exade.
                  </p>
                </div>
              </div>

              <div className="space-y-6">
                {/* Informations principales */}
                <div className="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                  <h4 className="font-medium text-[#335FAD] dark:text-[#335FAD]/80 mb-2">
                    {selectedDevisDetail.produit}
                  </h4>
                  
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Coût mensuel
                      </label>
                      <p className="text-lg font-medium text-gray-900 dark:text-white">
                        {formatCurrency(selectedDevisDetail.cout_mensuel)}
                      </p>
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Coût total
                      </label>
                      <p className="text-lg font-medium text-gray-900 dark:text-white">
                        {formatCurrency(selectedDevisDetail.cout_total)}
                      </p>
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
                        Économie estimée
                      </label>
                      <p className="text-lg font-medium text-green-600 dark:text-green-400">
                        {formatCurrency(selectedDevisDetail.economie_estimee || 0)}
                      </p>
                    </div>
                  </div>
                </div>

                {/* Couverture */}
                <div>
                  <h4 className="font-medium text-gray-900 dark:text-white mb-3">
                    <i className="ri-shield-check-line mr-2 text-green-500"></i>
                    Couverture
                  </h4>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    {selectedDevisDetail.couverture.map((item, index) => (
                      <div key={index} className="flex items-center bg-green-50 dark:bg-green-900/20 rounded p-3 border border-green-200 dark:border-green-800">
                        <i className="ri-check-line text-green-600 dark:text-green-400 mr-2"></i>
                        <p className="text-green-800 dark:text-green-300">{item}</p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Formalités médicales */}
                <div>
                  <h4 className="font-medium text-gray-900 dark:text-white mb-3">
                    <i className="ri-heart-pulse-line mr-2 text-orange-500"></i>
                    Formalités médicales
                  </h4>
                  <div className="space-y-2">
                    {selectedDevisDetail.formalites_medicales.map((formalite, index) => (
                      <div key={index} className="flex items-start bg-orange-50 dark:bg-orange-900/20 rounded p-3 border border-orange-200 dark:border-orange-800">
                        <i className="ri-arrow-right-s-line text-orange-600 dark:text-orange-400 mt-0.5"></i>
                        <p className="text-orange-800 dark:text-orange-300 ml-2">{formalite}</p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Exclusions */}
                <div>
                  <h4 className="font-medium text-gray-900 dark:text-white mb-3">
                    <i className="ri-error-warning-line mr-2 text-amber-500"></i>
                    Exclusions principales
                  </h4>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    {selectedDevisDetail.exclusions.map((item, index) => (
                      <div key={index} className="flex items-center bg-amber-50 dark:bg-amber-900/20 rounded p-3 border border-amber-200 dark:border-amber-800">
                        <i className="ri-close-line text-amber-600 dark:text-amber-400 mr-2"></i>
                        <p className="text-amber-800 dark:text-amber-300">{item}</p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Avantages */}
                <div>
                  <h4 className="font-medium text-gray-900 dark:text-white mb-3">
                    <i className="ri-star-line mr-2 text-[#335FAD]"></i>
                    Avantages spécifiques
                  </h4>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    {selectedDevisDetail.avantages.map((item, index) => (
                      <div key={index} className="flex items-center bg-[#335FAD]/5 dark:bg-[#335FAD]/10 rounded p-3 border border-[#335FAD]/20 dark:border-[#335FAD]/30">
                        <i className="ri-star-fill text-[#335FAD] dark:text-[#335FAD]/80 mr-2"></i>
                        <p className="text-[#335FAD] dark:text-[#335FAD]/80">{item}</p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Footer avec bouton */}
                <div className="mt-6">
                  <button
                    onClick={() => {
                      handleSelectDevis(selectedDevisDetail.id);
                      setShowDevisModal(false);
                    }}
                    className="w-full bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-3 rounded-lg font-medium transition-colors cursor-pointer flex items-center justify-center"
                  >
                    <i className="ri-check-line mr-2"></i>
                    Sélectionner ce devis
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* MODAL ASSIGNATION APPORTEUR */}
      {showAssignModal && (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="flex items-center justify-center min-h-screen px-4">
            <div className="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onClick={() => setShowAssignModal(false)}></div>
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-xl transform transition-all sm:max-w-md w-full p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                  Assigner à un apporteur
                </h3>
                <button
                  onClick={() => setShowAssignModal(false)}
                  className="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 cursor-pointer"
                >
                  <i className="ri-close-line text-xl"></i>
                </button>
              </div>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Sélectionner un apporteur
                  </label>
                  <Select value={selectedApporteur} onValueChange={setSelectedApporteur}>
                    <SelectTrigger className="w-full">
                      <SelectValue placeholder="Choisir un apporteur..." />
                    </SelectTrigger>
                    <SelectContent>
                      {apporteurs.map((apporteur) => (
                        <SelectItem key={apporteur.id} value={apporteur.id}>
                          {apporteur.prenom} {apporteur.nom} - {apporteur.email}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
                
                <div className="bg-[#335FAD]/5 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/70 rounded-lg p-4">
                  <div className="flex items-start">
                    <i className="ri-information-line text-[#335FAD] dark:text-[#335FAD] mr-3 mt-0.5 flex-shrink-0"></i>
                    <div className="text-sm text-[#335FAD] dark:text-[#335FAD]/80">
                      <p className="font-medium mb-1">Information :</p>
                      <p>
                        L'apporteur recevra une notification et pourra gérer le dossier avec le client.
                        Le devis sélectionné sera automatiquement proposé.
                      </p>
                    </div>
                  </div>
                </div>
                
                <div className="flex justify-end space-x-3 pt-4">
                  <button
                    onClick={() => setShowAssignModal(false)}
                    className="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                  >
                    Annuler
                  </button>
                  <button
                    onClick={handleConfirmAssign}
                    disabled={!selectedApporteur || isSubmitting}
                    className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 cursor-pointer"
                  >
                    {isSubmitting ? (
                      <>
                        <i className="ri-loader-4-line mr-2 animate-spin inline"></i>
                        Assignation...
                      </>
                    ) : (
                      'Assigner le dossier'
                    )}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// Composant wrapper avec Suspense pour useSearchParams
export default function AdminNouveauDossierPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Initialisation...</p>
        </div>
      </div>
    }>
      <AdminNouveauDossierContent />
    </Suspense>
  );
}

================
File: app/admin/onboarding/page.tsx
================
'use client';

import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { supabase } from '@/lib/supabase';
import { api } from '@/services/api';

type OnboardingStep = 'welcome' | 'exade' | 'invite' | 'complete';

export default function AdminOnboardingPage() {
  const router = useRouter();
  const [currentStep, setCurrentStep] = useState<OnboardingStep>('welcome');
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [darkMode, setDarkMode] = useState(false);

  // Broker info
  const [brokerInfo, setBrokerInfo] = useState<{
    id: string;
    name: string;
    onboarding_status: string;
  } | null>(null);

  // Exade config state
  const [exadeConfig, setExadeConfig] = useState({
    codeCourtier: '',
    environment: 'stage' as 'stage' | 'prod',
    isEnabled: false
  });

  // Initialize
  useEffect(() => {
    const init = async () => {
      // Dark mode
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      setDarkMode(savedDarkMode);
      if (savedDarkMode) {
        document.documentElement.classList.add('dark');
      }

      // Check auth and load broker
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        router.push('/connexion');
        return;
      }

      // Get user's broker
      const brokers = await api.getMyBrokers();
      if (brokers.length === 0) {
        router.push('/connexion');
        return;
      }

      const broker = brokers[0];
      setBrokerInfo({
        id: broker.id,
        name: broker.name,
        onboarding_status: broker.onboarding_status
      });

      // If already onboarded, redirect to admin
      if (broker.onboarding_status === 'ready') {
        router.push('/admin');
        return;
      }

      // Load existing Exade config if any
      const existingConfig = await api.getExadeConfig(broker.id);
      if (existingConfig) {
        setExadeConfig({
          codeCourtier: existingConfig.code_courtier || '',
          environment: existingConfig.environment || 'stage',
          isEnabled: existingConfig.is_enabled ?? false
        });
      }

      setLoading(false);
    };

    init();
  }, [router]);

  const handleDarkModeToggle = () => {
    const newDarkMode = !darkMode;
    setDarkMode(newDarkMode);
    if (newDarkMode) {
      document.documentElement.classList.add('dark');
      localStorage.setItem('darkMode', 'true');
    } else {
      document.documentElement.classList.remove('dark');
      localStorage.setItem('darkMode', 'false');
    }
  };

  const handleSaveExadeConfig = async () => {
    if (!brokerInfo) return;
    setSaving(true);
    setError(null);
    setSuccess(null);

    try {
      await api.saveExadeConfig(brokerInfo.id, {
        code_courtier: exadeConfig.codeCourtier,
        environment: exadeConfig.environment,
        is_enabled: exadeConfig.isEnabled
      });

      // Update onboarding status to exade_pending (trigger in DB will handle the rest)
      await supabase.rpc('update_broker_onboarding_status', {
        p_broker_id: brokerInfo.id,
        p_status: exadeConfig.isEnabled ? 'ready' : 'exade_pending'
      });

      setSuccess('Configuration Exade enregistrée !');
      
      // Move to next step after brief delay
      setTimeout(() => {
        setCurrentStep('invite');
      }, 1500);
    } catch (err: any) {
      setError(err.message || 'Erreur lors de la sauvegarde');
    } finally {
      setSaving(false);
    }
  };

  const handleSkipExade = () => {
    setCurrentStep('invite');
  };

  const handleFinishOnboarding = async () => {
    if (!brokerInfo) return;
    setSaving(true);

    try {
      // Mark onboarding as complete
      await supabase.rpc('update_broker_onboarding_status', {
        p_broker_id: brokerInfo.id,
        p_status: 'ready'
      });

      setCurrentStep('complete');
      
      // Redirect to admin after animation
      setTimeout(() => {
        router.push('/admin');
      }, 2000);
    } catch (err) {
      console.error('Error finishing onboarding:', err);
      router.push('/admin');
    } finally {
      setSaving(false);
    }
  };

  const handleGenerateEmail = () => {
    const subject = "Configuration Exade - Demande de codes";
    const body = `Bonjour,\n\nJe souhaite configurer le connecteur Exade pour mon cabinet.\n\nCabinet: ${brokerInfo?.name || ''}\nCode Courtier souhaité: ${exadeConfig.codeCourtier}\nEnvironnement: ${exadeConfig.environment}\n\nMerci de me transmettre les informations nécessaires.\n\nCordialement`;
    window.open(`mailto:support@exade.fr?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#335FAD] mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Chargement...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
      {/* Header */}
      <header className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="max-w-4xl mx-auto px-4 sm:px-8 py-4 sm:py-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <div className="w-10 h-10 sm:w-12 sm:h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-xl flex items-center justify-center">
                <i className="ri-building-2-line text-[#335FAD] dark:text-[#335FAD]/80 text-lg sm:text-xl"></i>
              </div>
              <div>
                <h1 className="font-semibold text-lg sm:text-xl text-gray-900 dark:text-white">{brokerInfo?.name}</h1>
                <p className="text-xs text-gray-500 dark:text-gray-400">Configuration de votre cabinet</p>
              </div>
            </div>

            <button 
              onClick={handleDarkModeToggle}
              className="w-10 h-10 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 border border-gray-200 dark:border-gray-600 rounded-lg flex items-center justify-center transition-colors"
            >
              <i className={`${darkMode ? 'ri-sun-line' : 'ri-moon-line'} text-gray-600 dark:text-gray-300 text-sm`}></i>
            </button>
          </div>
        </div>
      </header>

      {/* Progress indicator */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="max-w-4xl mx-auto px-4 sm:px-8 py-6">
          <div className="flex items-center justify-center space-x-4">
            {/* Step 1: Welcome */}
            <div className={`flex items-center ${currentStep === 'welcome' ? 'text-[#335FAD]' : 'text-green-500'}`}>
              <div className={`w-8 h-8 rounded-full flex items-center justify-center border-2 ${
                currentStep === 'welcome' 
                  ? 'border-[#335FAD] bg-[#335FAD]/10' 
                  : 'border-green-500 bg-green-500 text-white'
              }`}>
                {currentStep === 'welcome' ? (
                  <span className="text-sm font-medium">1</span>
                ) : (
                  <i className="ri-check-line text-sm"></i>
                )}
              </div>
              <span className="ml-2 text-sm font-medium hidden sm:inline">Bienvenue</span>
            </div>

            <div className="w-12 h-px bg-gray-200 dark:bg-gray-700"></div>

            {/* Step 2: Exade */}
            <div className={`flex items-center ${currentStep === 'exade' ? 'text-[#335FAD]' : currentStep === 'invite' || currentStep === 'complete' ? 'text-green-500' : 'text-gray-400'}`}>
              <div className={`w-8 h-8 rounded-full flex items-center justify-center border-2 ${
                currentStep === 'exade' 
                  ? 'border-[#335FAD] bg-[#335FAD]/10' 
                  : currentStep === 'invite' || currentStep === 'complete'
                    ? 'border-green-500 bg-green-500 text-white' 
                    : 'border-gray-300'
              }`}>
                {currentStep === 'invite' || currentStep === 'complete' ? (
                  <i className="ri-check-line text-sm"></i>
                ) : (
                  <span className="text-sm font-medium">2</span>
                )}
              </div>
              <span className="ml-2 text-sm font-medium hidden sm:inline">Exade</span>
            </div>

            <div className="w-12 h-px bg-gray-200 dark:bg-gray-700"></div>

            {/* Step 3: Invite */}
            <div className={`flex items-center ${currentStep === 'invite' ? 'text-[#335FAD]' : currentStep === 'complete' ? 'text-green-500' : 'text-gray-400'}`}>
              <div className={`w-8 h-8 rounded-full flex items-center justify-center border-2 ${
                currentStep === 'invite' 
                  ? 'border-[#335FAD] bg-[#335FAD]/10' 
                  : currentStep === 'complete'
                    ? 'border-green-500 bg-green-500 text-white' 
                    : 'border-gray-300'
              }`}>
                {currentStep === 'complete' ? (
                  <i className="ri-check-line text-sm"></i>
                ) : (
                  <span className="text-sm font-medium">3</span>
                )}
              </div>
              <span className="ml-2 text-sm font-medium hidden sm:inline">Apporteurs</span>
            </div>
          </div>
        </div>
      </div>

      {/* Main content */}
      <main className="max-w-4xl mx-auto px-4 sm:px-8 py-8">
        {/* Welcome Step */}
        {currentStep === 'welcome' && (
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-8 text-center">
            <div className="w-20 h-20 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
              <i className="ri-rocket-2-line text-[#335FAD] text-4xl"></i>
            </div>
            
            <h2 className="text-2xl font-semibold text-gray-900 dark:text-white mb-3">
              Bienvenue sur votre espace courtier !
            </h2>
            <p className="text-gray-600 dark:text-gray-400 max-w-md mx-auto mb-8">
              Votre cabinet <strong className="text-gray-900 dark:text-white">{brokerInfo?.name}</strong> a été créé avec succès. 
              Configurons maintenant votre espace de travail.
            </p>

            <div className="grid sm:grid-cols-3 gap-4 mb-8">
              <div className="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                <i className="ri-settings-5-line text-[#335FAD] text-2xl mb-2"></i>
                <h3 className="font-medium text-gray-900 dark:text-white text-sm">Configuration Exade</h3>
                <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Connectez votre compte tarificateur</p>
              </div>
              <div className="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                <i className="ri-user-add-line text-emerald-500 text-2xl mb-2"></i>
                <h3 className="font-medium text-gray-900 dark:text-white text-sm">Inviter des apporteurs</h3>
                <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Développez votre réseau</p>
              </div>
              <div className="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                <i className="ri-folder-add-line text-purple-500 text-2xl mb-2"></i>
                <h3 className="font-medium text-gray-900 dark:text-white text-sm">Gérer les dossiers</h3>
                <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Traitez les demandes clients</p>
              </div>
            </div>

            <button
              onClick={() => setCurrentStep('exade')}
              className="px-8 py-3 bg-[#335FAD] text-white rounded-xl font-medium hover:bg-[#2a4e8f] transition-colors"
            >
              Commencer la configuration
              <i className="ri-arrow-right-line ml-2"></i>
            </button>
          </div>
        )}

        {/* Exade Configuration Step */}
        {currentStep === 'exade' && (
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div className="p-6 border-b border-gray-200 dark:border-gray-700">
              <h2 className="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
                <i className="ri-settings-5-line mr-3 text-[#335FAD]"></i>
                Configuration Exade
              </h2>
              <p className="text-gray-600 dark:text-gray-400 text-sm mt-1">
                Connectez votre compte Exade pour générer automatiquement des devis d'assurance emprunteur.
              </p>
            </div>

            <div className="p-6 space-y-6">
              {/* Info banner */}
              <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-xl p-4">
                <div className="flex items-start gap-3">
                  <i className="ri-information-line text-blue-600 dark:text-blue-400 mt-0.5"></i>
                  <div>
                    <h4 className="text-sm font-medium text-blue-800 dark:text-blue-300">Vous n'avez pas encore de compte Exade ?</h4>
                    <p className="text-xs text-blue-700 dark:text-blue-400 mt-1">
                      Cliquez sur "Générer email de demande" pour contacter Exade et obtenir vos codes d'accès.
                    </p>
                  </div>
                </div>
              </div>

              {/* Form fields */}
              <div className="grid sm:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Code Courtier Exade
                  </label>
                  <input
                    type="text"
                    value={exadeConfig.codeCourtier}
                    onChange={(e) => setExadeConfig({ ...exadeConfig, codeCourtier: e.target.value })}
                    className="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] text-sm"
                    placeholder="Ex: EX-12345"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Environnement
                  </label>
                  <select
                    value={exadeConfig.environment}
                    onChange={(e) => setExadeConfig({ ...exadeConfig, environment: e.target.value as 'stage' | 'prod' })}
                    className="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] text-sm"
                  >
                    <option value="stage">Recette (Test)</option>
                    <option value="prod">Production</option>
                  </select>
                </div>
              </div>

              <div className="flex items-center gap-3">
                <input
                  type="checkbox"
                  id="enable-exade"
                  checked={exadeConfig.isEnabled}
                  onChange={(e) => setExadeConfig({ ...exadeConfig, isEnabled: e.target.checked })}
                  className="rounded border-gray-300 text-[#335FAD] focus:ring-[#335FAD]"
                />
                <label htmlFor="enable-exade" className="text-sm text-gray-700 dark:text-gray-300">
                  Activer l'intégration Exade
                </label>
              </div>

              {/* Error/Success messages */}
              {error && (
                <div className="p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-xl">
                  <p className="text-sm text-red-700 dark:text-red-300 flex items-center">
                    <i className="ri-error-warning-line mr-2"></i>
                    {error}
                  </p>
                </div>
              )}

              {success && (
                <div className="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-xl">
                  <p className="text-sm text-green-700 dark:text-green-300 flex items-center">
                    <i className="ri-checkbox-circle-line mr-2"></i>
                    {success}
                  </p>
                </div>
              )}
            </div>

            <div className="px-6 py-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row justify-between gap-4">
              <button
                onClick={handleGenerateEmail}
                className="px-4 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 font-medium text-sm flex items-center justify-center gap-2"
              >
                <i className="ri-mail-send-line"></i>
                Générer email de demande
              </button>

              <div className="flex gap-3">
                <button
                  onClick={handleSkipExade}
                  className="px-4 py-2.5 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white font-medium text-sm"
                >
                  Passer cette étape
                </button>
                <button
                  onClick={handleSaveExadeConfig}
                  disabled={saving || !exadeConfig.codeCourtier}
                  className="px-6 py-2.5 bg-[#335FAD] text-white rounded-xl hover:bg-[#2a4e8f] font-medium text-sm flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {saving ? <i className="ri-loader-4-line animate-spin"></i> : <i className="ri-save-line"></i>}
                  Enregistrer et continuer
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Invite Step */}
        {currentStep === 'invite' && (
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div className="p-6 border-b border-gray-200 dark:border-gray-700">
              <h2 className="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
                <i className="ri-user-add-line mr-3 text-emerald-500"></i>
                Inviter des apporteurs
              </h2>
              <p className="text-gray-600 dark:text-gray-400 text-sm mt-1">
                Vous pourrez inviter des apporteurs d'affaires depuis votre tableau de bord.
              </p>
            </div>

            <div className="p-8 text-center">
              <div className="w-16 h-16 bg-emerald-100 dark:bg-emerald-900/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i className="ri-team-line text-emerald-600 dark:text-emerald-400 text-3xl"></i>
              </div>

              <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
                Prêt à développer votre réseau ?
              </h3>
              <p className="text-gray-600 dark:text-gray-400 max-w-md mx-auto mb-6">
                Une fois dans votre tableau de bord, vous pourrez générer des liens d'invitation pour vos apporteurs. 
                Chaque apporteur créera son compte via ce lien et sera automatiquement rattaché à votre cabinet.
              </p>

              <div className="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4 max-w-sm mx-auto mb-8">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 rounded-lg flex items-center justify-center">
                    <i className="ri-link text-[#335FAD]"></i>
                  </div>
                  <div className="text-left">
                    <p className="text-sm font-medium text-gray-900 dark:text-white">Lien d'invitation unique</p>
                    <p className="text-xs text-gray-500 dark:text-gray-400">Sécurisé et traçable</p>
                  </div>
                </div>
              </div>
            </div>

            <div className="px-6 py-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-200 dark:border-gray-700 flex justify-end">
              <button
                onClick={handleFinishOnboarding}
                disabled={saving}
                className="px-8 py-3 bg-[#335FAD] text-white rounded-xl font-medium hover:bg-[#2a4e8f] transition-colors flex items-center gap-2"
              >
                {saving ? <i className="ri-loader-4-line animate-spin"></i> : null}
                Accéder à mon tableau de bord
                <i className="ri-arrow-right-line"></i>
              </button>
            </div>
          </div>
        )}

        {/* Complete Step */}
        {currentStep === 'complete' && (
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-8 text-center">
            <div className="w-20 h-20 bg-green-100 dark:bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-6">
              <i className="ri-check-line text-green-600 dark:text-green-400 text-4xl"></i>
            </div>
            
            <h2 className="text-2xl font-semibold text-gray-900 dark:text-white mb-3">
              Configuration terminée !
            </h2>
            <p className="text-gray-600 dark:text-gray-400">
              Redirection vers votre tableau de bord...
            </p>
            
            <div className="mt-6">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#335FAD] mx-auto"></div>
            </div>
          </div>
        )}
      </main>
    </div>
  );
}

================
File: app/admin/page.tsx
================
'use client';

import { useState, useEffect, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import AdminHeader from '../../components/AdminHeader';
import AdminStatsCards from '../../components/AdminStatsCards';
import AdminActivityConnected from '../../components/AdminActivityConnected';
import { WalletSummaryCard } from '@/components/features/wallet/WalletSummaryCard';
import { useTheme } from '@/lib/hooks/useTheme';
import { DossiersService } from '@/lib/services/dossiers';
import { ApporteursService } from '@/lib/services/apporteurs';
import { InvitesBanner } from '@/components/features/invites/InvitesBanner';
import { useBrokerContext } from '@/hooks/useBrokerContext';
import { useAuth } from '@/components/AuthProvider';

// Fonction pour obtenir le message de salutation en fonction de l'heure locale
const getGreeting = (date: Date): string => {
  const hour = date.getHours();
  if (hour >= 5 && hour < 12) return 'Bonjour';
  if (hour >= 12 && hour < 18) return 'Bon après-midi';
  return 'Bonsoir';
};

// Interface pour les données admin depuis Supabase
interface AdminData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
}

// Interface pour les statistiques admin depuis Supabase
interface AdminStats {
  dossiersEnAttente: number;
  dossiersValidationApporteur: number;
  dossiersFinalises: number;
  totalDossiers: number;
  nouveauxApporteurs: number;
  chiffreAffairesMois: number;
  progressionDossiers: number;
  progressionChiffre: number;
}

export default function AdminDashboard() {
  const router = useRouter();
  const [currentTime, setCurrentTime] = useState(new Date());

  // ✅ Utilisation du hook centralisé pour le dark mode
  const { darkMode, isInitialized, toggleDarkMode } = useTheme();

  // ✅ Récupération du contexte broker
  const { currentBrokerId } = useBrokerContext();

  // ✅ Récupération de l'utilisateur connecté
  const { user } = useAuth();

  // ✅ SUPABASE CONNECTED - États pour les vraies données
  const [adminStats, setAdminStats] = useState<AdminStats | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // ✅ SUPABASE CONNECTED - Données admin depuis l'utilisateur connecté
  const adminData = useMemo<AdminData>(() => {
    const firstName = user?.user_metadata?.prenom || 'Admin';
    const lastName = user?.user_metadata?.nom || '';
    return {
      id: user?.id || 'admin1',
      firstName,
      lastName,
      initials: `${firstName.charAt(0)}${lastName.charAt(0) || ''}`.toUpperCase(),
      role: 'Administrateur'
    };
  }, [user]);

  // ✅ SUPABASE CONNECTED - Récupération des statistiques du dashboard
  const fetchDashboardData = async () => {
    try {
      setLoading(true);
      setError(null);

      // Paralléliser les appels pour de meilleures performances
      const [dossierStats, apporteurStats] = await Promise.all([
        DossiersService.getAdminDashboardStats(currentBrokerId!),
        ApporteursService.getApporteursDashboardStats(currentBrokerId!)
      ]);

      console.log('📊 Stats dossiers:', dossierStats);
      console.log('👥 Stats apporteurs:', apporteurStats);

      // Mapper vers l'interface AdminStats
      setAdminStats({
        dossiersEnAttente: dossierStats.dossiersEnAttente,
        dossiersValidationApporteur: dossierStats.dossiersDevisDisponible,
        dossiersFinalises: dossierStats.dossiersFinaliseCeMois,
        totalDossiers: dossierStats.totalDossiers,
        nouveauxApporteurs: apporteurStats.nouveauxApporteursCeMois,
        chiffreAffairesMois: dossierStats.economiesCeMois,
        progressionDossiers: dossierStats.progressionDossiers,
        progressionChiffre: dossierStats.progressionEconomies
      });
    } catch (error: any) {
      console.error('❌ Erreur lors du chargement du dashboard:', error);
      setError(error.message || 'Erreur lors du chargement des statistiques');
    } finally {
      setLoading(false);
    }
  };

  // Timer pour l'heure
  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 1000);
    return () => clearInterval(timer);
  }, []);

  // ✅ SUPABASE CONNECTED - Chargement des données au montage
  useEffect(() => {
    if (currentBrokerId) {
      fetchDashboardData();
    }
  }, [currentBrokerId]);

  // ✅ Le dark mode est géré par le hook useTheme

  // Gestionnaire pour le bouton Nouveau Dossier Admin
  const handleNouveauDossierAdmin = () => {
    router.push('/admin/nouveau-dossier');
  };

  // États de chargement
  if (!isInitialized || loading) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#335FAD] mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Chargement du dashboard...</p>
        </div>
      </div>
    );
  }

  // État d'erreur
  if (error) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <i className="ri-error-warning-line text-5xl text-red-500 mb-4"></i>
          <p className="text-gray-900 dark:text-white font-medium mb-2">Erreur de chargement</p>
          <p className="text-gray-600 dark:text-gray-400 mb-4">{error}</p>
          <button
            onClick={() => fetchDashboardData()}
            className="bg-[#335FAD] text-white px-6 py-2 rounded-lg hover:bg-[#335FAD]/90"
          >
            Réessayer
          </button>
        </div>
      </div>
    );
  }

  // Fallback si pas de broker sélectionné
  if (!currentBrokerId) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
        <AdminHeader
          darkMode={darkMode}
          setDarkMode={toggleDarkMode}
          adminData={adminData}
        />
        <div className="flex items-center justify-center h-[calc(100vh-80px)]">
          <div className="text-center max-w-md p-8 bg-gray-50 dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700">
            <div className="w-16 h-16 bg-[#335FAD]/10 rounded-full flex items-center justify-center mx-auto mb-4">
              <i className="ri-building-line text-3xl text-[#335FAD]"></i>
            </div>
            <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-2">
              Sélectionnez un cabinet
            </h2>
            <p className="text-gray-600 dark:text-gray-400 mb-6">
              Veuillez sélectionner un cabinet de courtage dans le menu ci-dessus pour accéder au tableau de bord.
            </p>
            <div className="animate-bounce text-[#335FAD]">
              <i className="ri-arrow-up-line text-2xl"></i>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Fallback si pas de stats
  if (!adminStats) {
    return null;
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      {/* TODO: SUPABASE - Passer les vraies données admin */}
      <AdminHeader
        darkMode={darkMode}
        setDarkMode={toggleDarkMode}
        adminData={adminData}
      />

      {/* Hero Section */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="px-4 sm:px-8 py-8 sm:py-12 max-w-7xl mx-auto">
          <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
            <div className="flex-1">
              {/* Date - Mobile au-dessus de Bonjour */}
              <div className="mb-4 lg:hidden text-center" suppressHydrationWarning={true}>
                <p className="text-base font-light text-gray-600 dark:text-gray-400" suppressHydrationWarning={true}>
                  {currentTime.toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long'
                  })}
                </p>
              </div>

              <h1 className="text-3xl sm:text-4xl lg:text-5xl font-light text-gray-900 dark:text-white mb-4 text-center lg:text-left" suppressHydrationWarning>
                {getGreeting(currentTime)}, <span className="font-medium text-[#335FAD] dark:text-[#335FAD]">{adminData.firstName}</span>
              </h1>
              <p className="text-lg text-gray-600 dark:text-gray-400 text-center lg:text-left">
                Voici votre tableau de bord
              </p>
            </div>

            {/* Right Side - Desktop only */}
            <div className="hidden lg:flex flex-col items-end space-y-6">
              {/* Date - Desktop à droite */}
              <div className="text-right" suppressHydrationWarning={true}>
                <p className="text-base font-light text-gray-600 dark:text-gray-400" suppressHydrationWarning={true}>
                  {currentTime.toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long'
                  })}
                </p>
              </div>

              {/* Actions Admin - Desktop à droite */}
              <div className="flex items-center space-x-3">
                <button
                  onClick={handleNouveauDossierAdmin}
                  className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 hover:shadow-lg flex items-center space-x-2 whitespace-nowrap cursor-pointer"
                >
                  <i className="ri-add-line text-lg"></i>
                  <span>Créer un Dossier</span>
                </button>

                <button
                  onClick={() => router.push('/admin/dossiers')}
                  className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-xl font-medium transition-all duration-200 hover:shadow-lg flex items-center space-x-2 whitespace-nowrap cursor-pointer"
                >
                  <i className="ri-folder-line text-lg"></i>
                  <span>Tous les Dossiers</span>
                </button>
              </div>
            </div>

            {/* Mobile Buttons */}
            <div className="lg:hidden flex flex-col sm:flex-row justify-center gap-3">
              <button
                onClick={handleNouveauDossierAdmin}
                className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 hover:shadow-lg flex items-center justify-center space-x-2 whitespace-nowrap cursor-pointer"
              >
                <i className="ri-add-line text-lg"></i>
                <span>Créer un Dossier</span>
              </button>

              <button
                onClick={() => router.push('/admin/dossiers')}
                className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-xl font-medium transition-all duration-200 hover:shadow-lg flex items-center justify-center space-x-2 whitespace-nowrap cursor-pointer"
              >
                <i className="ri-folder-line text-lg"></i>
                <span>Tous les Dossiers</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-7xl mx-auto">
        {/* Banner Invitation (Feature 2) */}
        <div className="mb-8">
          <InvitesBanner />
        </div>

        {/* Section Title */}
        <div className="mb-6">
          <p className="text-gray-500 dark:text-gray-400 text-xl font-light">
            Indicateurs clés de performance
          </p>
        </div>

        {/* ✅ SUPABASE CONNECTED - Statistiques réelles */}
        <AdminStatsCards adminStats={adminStats} />

        {/* Main Content Grid */}
        <div className="grid grid-cols-1 xl:grid-cols-3 gap-8 mt-8">
          {/* Activité Récente */}
          <div className="xl:col-span-2">
            <AdminActivityConnected limit={6} />
          </div>

          {/* Classement des Apporteurs */}
          <div>
            <WalletSummaryCard />
          </div>
        </div>
      </main>
    </div>
  );
}

================
File: app/admin/profil/AdminNotificationSettings.tsx
================
'use client';

import { useState } from 'react';

interface AdminNotificationPreferences {
  newApporteur: {
    email: boolean;
    app: boolean;
  };
  dossierSubmitted: {
    email: boolean;
    app: boolean;
  };
  supportRequest: {
    email: boolean;
    app: boolean;
  };
  systemAlerts: {
    email: boolean;
    app: boolean;
  };
  monthlyReport: {
    email: boolean;
    app: boolean;
  };
}

interface AdminNotificationSettingsProps {
  preferences: AdminNotificationPreferences;
  onSave: (preferences: AdminNotificationPreferences) => Promise<{ success: boolean; error?: string }>;
}

export default function AdminNotificationSettings({ preferences, onSave }: AdminNotificationSettingsProps) {
  const [localPreferences, setLocalPreferences] = useState<AdminNotificationPreferences>(preferences);
  const [isSaving, setIsSaving] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);

  // Configuration des types de notifications administrateur
  const notificationTypes = [
    {
      key: 'newApporteur' as keyof AdminNotificationPreferences,
      title: 'Nouvel apporteur inscrit',
      description: 'Soyez averti quand un nouvel apporteur rejoint la plateforme',
      category: 'Essentiel',
      categoryColor: 'text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900/30',
      icon: 'ri-user-add-line',
      iconColor: 'text-green-600 dark:text-green-400'
    },
    {
      key: 'dossierSubmitted' as keyof AdminNotificationPreferences,
      title: 'Nouveau dossier soumis',
      description: 'Recevez une alerte pour chaque nouveau dossier à traiter',
      category: 'Essentiel',
      categoryColor: 'text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900/30',
      icon: 'ri-file-add-line',
      iconColor: 'text-green-600 dark:text-green-400'
    },
    {
      key: 'supportRequest' as keyof AdminNotificationPreferences,
      title: 'Demande de support apporteur',
      description: 'Soyez notifié des demandes d\'aide des apporteurs',
      category: 'Recommandé',
      categoryColor: 'text-[#335FAD] dark:text-[#335FAD] bg-[#335FAD]/10 dark:bg-[#335FAD]/30',
      icon: 'ri-customer-service-line',
      iconColor: 'text-[#335FAD] dark:text-[#335FAD]'
    },
    {
      key: 'systemAlerts' as keyof AdminNotificationPreferences,
      title: 'Alertes système et sécurité',
      description: 'Notifications critiques sur l\'état du système',
      category: 'Critique',
      categoryColor: 'text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/30',
      icon: 'ri-alarm-warning-line',
      iconColor: 'text-red-600 dark:text-red-400'
    },
    {
      key: 'monthlyReport' as keyof AdminNotificationPreferences,
      title: 'Rapport mensuel automatique',
      description: 'Recevez le rapport d\'activité mensuel par email',
      category: 'Optionnel',
      categoryColor: 'text-amber-600 dark:text-amber-400 bg-amber-100 dark:bg-amber-900/30',
      icon: 'ri-file-chart-line',
      iconColor: 'text-amber-600 dark:text-amber-400'
    }
  ];

  // Mettre à jour une préférence
  const updatePreference = (key: keyof AdminNotificationPreferences, channel: 'email' | 'app', value: boolean) => {
    setLocalPreferences(prev => ({
      ...prev,
      [key]: {
        ...prev[key],
        [channel]: value
      }
    }));
  };

  // Sauvegarder les préférences
  const handleSave = async () => {
    setIsSaving(true);
    setMessage(null);

    try {
      const result = await onSave(localPreferences);
      
      if (result.success) {
        setMessage({ type: 'success', text: 'Préférences administrateur mises à jour avec succès' });
      } else {
        setMessage({ type: 'error', text: result.error || 'Erreur lors de la sauvegarde' });
      }
    } catch (error) {
      setMessage({ type: 'error', text: 'Erreur lors de la sauvegarde des préférences' });
    } finally {
      setIsSaving(false);
    }
  };

  // Vérifier s'il y a des changements
  const hasChanges = JSON.stringify(preferences) !== JSON.stringify(localPreferences);

  // Masquer le message après 5 secondes
  useState(() => {
    if (message) {
      const timer = setTimeout(() => setMessage(null), 5000);
      return () => clearTimeout(timer);
    }
  });

  return (
    <div className="space-y-6">
      {/* Message de notification */}
      {message && (
        <div className={`p-4 rounded-xl border flex items-center space-x-3 ${
          message.type === 'success'
            ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-700 text-green-800 dark:text-green-400'
            : 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-700 text-red-800 dark:text-red-400'
        }`}>
          <i className={`${message.type === 'success' ? 'ri-check-circle-line' : 'ri-error-warning-line'} text-lg`}></i>
          <span className="font-medium">{message.text}</span>
          <button
            onClick={() => setMessage(null)}
            className="ml-auto text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
          >
            <i className="ri-close-line"></i>
          </button>
        </div>
      )}

      {/* Section principale */}
      <div className="bg-white dark:bg-gray-800 rounded-2xl border-2 border-gray-100 dark:border-gray-700 p-6">
        <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 space-y-4 sm:space-y-0">
          <div className="flex items-start space-x-4">
            <div className="w-12 h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-xl flex items-center justify-center flex-shrink-0">
              <i className="ri-notification-badge-line text-[#335FAD] dark:text-[#335FAD]/80 text-xl"></i>
            </div>
            <div className="flex-1 min-w-0">
              <h3 className="text-xl font-medium text-gray-900 dark:text-white">
                Notifications Administrateur
              </h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Contrôlez les alertes système et de gestion
              </p>
            </div>
          </div>
        </div>

        {/* Alerte d'information */}
        <div className="bg-[#335FAD]/5 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/70 rounded-xl p-4 mb-6">
          <div className="flex items-start space-x-3">
            <div className="w-6 h-6 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 rounded-lg flex items-center justify-center mt-0.5">
              <i className="ri-shield-check-line text-[#335FAD] dark:text-[#335FAD] text-sm"></i>
            </div>
            <div>
              <h4 className="font-medium text-[#335FAD] dark:text-[#335FAD] mb-1">
                Notifications Administrateur
              </h4>
              <p className="text-[#335FAD]/80 dark:text-[#335FAD]/80 text-sm">
                En tant qu'administrateur, vous recevez des notifications spécifiques pour la gestion de la plateforme, 
                le support des apporteurs et la surveillance système. Configurez ces alertes selon vos besoins de supervision.
              </p>
            </div>
          </div>
        </div>

        {/* Liste des notifications */}
        <div className="space-y-6">
          {notificationTypes.map((notif) => {
            const pref = localPreferences[notif.key];
            
            return (
              <div key={notif.key} className="border border-gray-200 dark:border-gray-700 rounded-xl p-6 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                <div className="flex items-start space-x-4">
                  {/* Icône */}
                  <div className="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-xl flex items-center justify-center flex-shrink-0">
                    <i className={`${notif.icon} ${notif.iconColor} text-lg`}></i>
                  </div>
                  
                  {/* Contenu */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center space-x-3 mb-2">
                      <h4 className="font-medium text-gray-900 dark:text-white text-sm">
                        {notif.title}
                      </h4>
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${notif.categoryColor}`}>
                        {notif.category}
                      </span>
                    </div>
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
                      {notif.description}
                    </p>
                    
                    {/* Options de notification */}
                    <div className="flex flex-col sm:flex-row gap-4">
                      {/* Email */}
                      <label className="flex items-center space-x-3 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={pref.email}
                          onChange={(e) => updatePreference(notif.key, 'email', e.target.checked)}
                          className="w-4 h-4 text-[#335FAD] bg-gray-100 border-gray-300 rounded focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                        />
                        <div className="flex items-center space-x-2">
                          <i className="ri-mail-line text-gray-500 dark:text-gray-400"></i>
                          <span className="text-sm font-medium text-gray-700 dark:text-gray-300">Par email</span>
                        </div>
                      </label>
                      
                      {/* Application */}
                      <label className="flex items-center space-x-3 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={pref.app}
                          onChange={(e) => updatePreference(notif.key, 'app', e.target.checked)}
                          className="w-4 h-4 text-[#335FAD] bg-gray-100 border-gray-300 rounded focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                        />
                        <div className="flex items-center space-x-2">
                          <i className="ri-smartphone-line text-gray-500 dark:text-gray-400"></i>
                          <span className="text-sm font-medium text-gray-700 dark:text-gray-300">Dans l'app</span>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        {/* Actions */}
        {hasChanges && (
          <div className="flex justify-end pt-6 border-t border-gray-200 dark:border-gray-700 mt-6">
            <button
              onClick={handleSave}
              disabled={isSaving}
              className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
            >
              {isSaving ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                  <span>Sauvegarde...</span>
                </>
              ) : (
                <>
                  <i className="ri-save-line"></i>
                  <span>Sauvegarder les préférences</span>
                </>
              )}
            </button>
          </div>
        )}
      </div>

      {/* Résumé des notifications activées */}
      <div className="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
        <h4 className="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
          <i className="ri-dashboard-line mr-2 text-[#335FAD] dark:text-[#335FAD]/80"></i>
          Tableau de bord des notifications
        </h4>
        
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
          {/* Notifications par email */}
          <div>
            <p className="font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center">
              <i className="ri-mail-line mr-2"></i>
              Par email ({Object.values(localPreferences).filter(p => p.email).length})
            </p>
            <ul className="space-y-1 text-gray-600 dark:text-gray-400">
              {notificationTypes.filter(notif => localPreferences[notif.key].email).map(notif => (
                <li key={`${notif.key}-email`} className="flex items-center">
                  <i className="ri-check-line mr-2 text-green-500 text-xs"></i>
                  <span className="truncate">{notif.title}</span>
                </li>
              ))}
              {Object.values(localPreferences).filter(p => p.email).length === 0 && (
                <li className="text-gray-500 dark:text-gray-500 italic">Aucune notification par email</li>
              )}
            </ul>
          </div>
          
          {/* Notifications dans l'app */}
          <div>
            <p className="font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center">
              <i className="ri-smartphone-line mr-2"></i>
              Dans l'app ({Object.values(localPreferences).filter(p => p.app).length})
            </p>
            <ul className="space-y-1 text-gray-600 dark:text-gray-400">
              {notificationTypes.filter(notif => localPreferences[notif.key].app).map(notif => (
                <li key={`${notif.key}-app`} className="flex items-center">
                  <i className="ri-check-line mr-2 text-green-500 text-xs"></i>
                  <span className="truncate">{notif.title}</span>
                </li>
              ))}
              {Object.values(localPreferences).filter(p => p.app).length === 0 && (
                <li className="text-gray-500 dark:text-gray-500 italic">Aucune notification dans l'app</li>
              )}
            </ul>
          </div>
        </div>
      </div>

      {/* Informations sur les notifications système */}
      <div className="bg-amber-50 dark:bg-amber-900/10 border border-amber-200 dark:border-amber-700 rounded-xl p-4">
        <div className="flex items-start space-x-3">
          <div className="w-6 h-6 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center mt-0.5">
            <i className="ri-information-line text-amber-600 dark:text-amber-400 text-sm"></i>
          </div>
          <div>
            <h4 className="font-medium text-amber-800 dark:text-amber-400 mb-1">
              Recommandations de notification
            </h4>
            <ul className="text-amber-700 dark:text-amber-300 text-sm space-y-1">
              <li>• <strong>Alertes système :</strong> Recommandé de garder activé pour la sécurité</li>
              <li>• <strong>Support apporteur :</strong> Important pour maintenir la qualité de service</li>
              <li>• <strong>Nouveaux dossiers :</strong> Essentiel pour la réactivité de traitement</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
}

================
File: app/admin/profil/AdminProfileInfo.tsx
================
'use client';

import { useState } from 'react';

interface AdminData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
  companyName?: string;
  privateEmail: string;
  contactEmail: string;
  privatePhone: string;
  professionalPhone?: string;
  useSamePhone: boolean;
}

interface AdminProfileInfoProps {
  adminData: AdminData;
  onSave: (data: Partial<AdminData>) => Promise<{ success: boolean; error?: string }>;
  onChangePassword: (currentPassword: string, newPassword: string) => Promise<{ success: boolean; error?: string }>;
}

export default function AdminProfileInfo({ adminData, onSave, onChangePassword }: AdminProfileInfoProps) {
  const [isEditing, setIsEditing] = useState(false);
  const [isSaving, setSaving] = useState(false);
  const [isChangingPassword, setIsChangingPassword] = useState(false);
  const [showPasswordForm, setShowPasswordForm] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);

  // Formulaire des informations de base
  const [formData, setFormData] = useState({
    companyName: adminData.companyName || '',
    privateEmail: adminData.privateEmail,
    contactEmail: adminData.contactEmail,
    privatePhone: adminData.privatePhone,
    professionalPhone: adminData.professionalPhone || '',
    useSamePhone: adminData.useSamePhone
  });

  // Formulaire de changement de mot de passe
  const [passwordData, setPasswordData] = useState({
    currentPassword: '',
    newPassword: '',
    confirmPassword: ''
  });

  const [formErrors, setFormErrors] = useState<Record<string, string>>({});
  const [passwordErrors, setPasswordErrors] = useState<Record<string, string>>({});

  // Validation du formulaire principal
  const validateForm = (): boolean => {
    const errors: Record<string, string> = {};

    if (!formData.privateEmail.trim()) {
      errors.privateEmail = 'L\'email privé est obligatoire';
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.privateEmail)) {
      errors.privateEmail = 'Format d\'email invalide';
    }

    if (!formData.contactEmail.trim()) {
      errors.contactEmail = 'L\'email de contact est obligatoire';
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.contactEmail)) {
      errors.contactEmail = 'Format d\'email invalide';
    }

    if (!formData.privatePhone.trim()) {
      errors.privatePhone = 'Le téléphone privé est obligatoire';
    }

    if (!formData.useSamePhone && !formData.professionalPhone.trim()) {
      errors.professionalPhone = 'Le téléphone professionnel est obligatoire';
    }

    setFormErrors(errors);
    return Object.keys(errors).length === 0;
  };

  // Validation du formulaire de mot de passe
  const validatePasswordForm = (): boolean => {
    const errors: Record<string, string> = {};

    if (!passwordData.currentPassword) {
      errors.currentPassword = 'Le mot de passe actuel est obligatoire';
    }

    if (!passwordData.newPassword) {
      errors.newPassword = 'Le nouveau mot de passe est obligatoire';
    } else if (passwordData.newPassword.length < 8) {
      errors.newPassword = 'Le mot de passe doit contenir au moins 8 caractères';
    }

    if (!passwordData.confirmPassword) {
      errors.confirmPassword = 'Veuillez confirmer le nouveau mot de passe';
    } else if (passwordData.newPassword !== passwordData.confirmPassword) {
      errors.confirmPassword = 'Les mots de passe ne correspondent pas';
    }

    setPasswordErrors(errors);
    return Object.keys(errors).length === 0;
  };

  // Gestionnaire de changement de la case à cocher "même téléphone"
  const handleSamePhoneChange = (checked: boolean) => {
    setFormData(prev => ({
      ...prev,
      useSamePhone: checked,
      professionalPhone: checked ? '' : prev.professionalPhone
    }));
    // Effacer l'erreur du téléphone professionnel si on utilise le même
    if (checked && formErrors.professionalPhone) {
      setFormErrors(prev => {
        const newErrors = { ...prev };
        delete newErrors.professionalPhone;
        return newErrors;
      });
    }
  };

  // Sauvegarder les informations
  const handleSave = async () => {
    if (!validateForm()) return;

    setSaving(true);
    setMessage(null);

    try {
      const result = await onSave(formData);
      
      if (result.success) {
        setMessage({ type: 'success', text: 'Informations administrateur mises à jour avec succès' });
        setIsEditing(false);
      } else {
        setMessage({ type: 'error', text: result.error || 'Erreur lors de la sauvegarde' });
      }
    } catch (error) {
      setMessage({ type: 'error', text: 'Erreur lors de la sauvegarde' });
    } finally {
      setSaving(false);
    }
  };

  // Changer le mot de passe
  const handlePasswordChange = async () => {
    if (!validatePasswordForm()) return;

    setIsChangingPassword(true);
    setMessage(null);

    try {
      const result = await onChangePassword(passwordData.currentPassword, passwordData.newPassword);
      
      if (result.success) {
        setMessage({ type: 'success', text: 'Mot de passe modifié avec succès' });
        setShowPasswordForm(false);
        setPasswordData({ currentPassword: '', newPassword: '', confirmPassword: '' });
      } else {
        setMessage({ type: 'error', text: result.error || 'Erreur lors du changement de mot de passe' });
      }
    } catch (error) {
      setMessage({ type: 'error', text: 'Erreur lors du changement de mot de passe' });
    } finally {
      setIsChangingPassword(false);
    }
  };

  // Annuler l'édition
  const handleCancel = () => {
    setFormData({
      companyName: adminData.companyName || '',
      privateEmail: adminData.privateEmail,
      contactEmail: adminData.contactEmail,
      privatePhone: adminData.privatePhone,
      professionalPhone: adminData.professionalPhone || '',
      useSamePhone: adminData.useSamePhone
    });
    setFormErrors({});
    setIsEditing(false);
    setMessage(null);
  };

  // Masquer le message après 5 secondes
  useState(() => {
    if (message) {
      const timer = setTimeout(() => setMessage(null), 5000);
      return () => clearTimeout(timer);
    }
  });

  return (
    <div className="space-y-6">
      {/* Message de notification */}
      {message && (
        <div className={`p-4 rounded-xl border flex items-center space-x-3 ${
          message.type === 'success'
            ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-700 text-green-800 dark:text-green-400'
            : 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-700 text-red-800 dark:text-red-400'
        }`}>
          <i className={`${message.type === 'success' ? 'ri-check-circle-line' : 'ri-error-warning-line'} text-lg`}></i>
          <span className="font-medium">{message.text}</span>
          <button
            onClick={() => setMessage(null)}
            className="ml-auto text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
          >
            <i className="ri-close-line"></i>
          </button>
        </div>
      )}

      {/* Informations principales */}
      <div className="bg-white dark:bg-gray-800 rounded-2xl border-2 border-gray-100 dark:border-gray-700 p-6">
        <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 space-y-4 sm:space-y-0">
          <div className="flex items-start space-x-4">
            <div className="w-12 h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-xl flex items-center justify-center flex-shrink-0">
              <i className="ri-user-star-line text-[#335FAD] dark:text-[#335FAD]/80 text-xl"></i>
            </div>
            <div className="flex-1 min-w-0">
              <h3 className="text-xl font-medium text-gray-900 dark:text-white">
                Informations Administrateur
              </h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Gérez vos informations personnelles et professionnelles
              </p>
            </div>
          </div>
          
          {!isEditing && (
            <div className="flex justify-end sm:justify-start">
              <button
                onClick={() => setIsEditing(true)}
                className="bg-[#335FAD]/10 dark:bg-[#335FAD]/20 hover:bg-[#335FAD]/20 dark:hover:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD]/80 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer flex items-center space-x-2 whitespace-nowrap"
              >
                <i className="ri-edit-line"></i>
                <span>Modifier</span>
              </button>
            </div>
          )}
        </div>

        <div className="space-y-6">
          {/* Nom et Prénom - Non modifiables */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Prénom
              </label>
              <div className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 rounded-xl text-sm text-gray-900 dark:text-white">
                {adminData.firstName}
              </div>
              <p className="text-xs text-gray-500 dark:text-gray-400">
                Non modifiable
              </p>
            </div>
            
            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Nom
              </label>
              <div className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 rounded-xl text-sm text-gray-900 dark:text-white">
                {adminData.lastName}
              </div>
              <p className="text-xs text-gray-500 dark:text-gray-400">
                Non modifiable
              </p>
            </div>
          </div>

          {/* Nom de la société - Modifiable */}
          <div className="space-y-2">
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
              Nom de la Société
            </label>
            {isEditing ? (
              <input
                type="text"
                value={formData.companyName}
                onChange={(e) => setFormData(prev => ({ ...prev, companyName: e.target.value }))}
                placeholder="Nom de votre entreprise"
                className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                  formErrors.companyName 
                    ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                    : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
                } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
              />
            ) : (
              <div className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 rounded-xl text-sm text-gray-900 dark:text-white">
                {adminData.companyName || 'Non renseigné'}
              </div>
            )}
            {formErrors.companyName && (
              <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                <i className="ri-error-warning-line mr-1"></i>
                {formErrors.companyName}
              </p>
            )}
          </div>

          {/* Emails */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Email privé */}
            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Email Privé <span className="text-red-500">*</span>
              </label>
              {isEditing ? (
                <input
                  type="email"
                  value={formData.privateEmail}
                  onChange={(e) => setFormData(prev => ({ ...prev, privateEmail: e.target.value }))}
                  placeholder="votre@email.com"
                  className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                    formErrors.privateEmail 
                      ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                      : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
                  } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
                />
              ) : (
                <div className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 rounded-xl text-sm text-gray-900 dark:text-white">
                  {adminData.privateEmail}
                </div>
              )}
              {formErrors.privateEmail && (
                <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                  <i className="ri-error-warning-line mr-1"></i>
                  {formErrors.privateEmail}
                </p>
              )}
              <p className="text-xs text-gray-500 dark:text-gray-400">
                Utilisé pour vos notifications personnelles
              </p>
            </div>

            {/* Email de contact */}
            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Email de Contact Support <span className="text-red-500">*</span>
              </label>
              {isEditing ? (
                <input
                  type="email"
                  value={formData.contactEmail}
                  onChange={(e) => setFormData(prev => ({ ...prev, contactEmail: e.target.value }))}
                  placeholder="contact@entreprise.com"
                  className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                    formErrors.contactEmail 
                      ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                      : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
                  } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
                />
              ) : (
                <div className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 rounded-xl text-sm text-gray-900 dark:text-white">
                  {adminData.contactEmail}
                </div>
              )}
              {formErrors.contactEmail && (
                <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                  <i className="ri-error-warning-line mr-1"></i>
                  {formErrors.contactEmail}
                </p>
              )}
              <p className="text-xs text-gray-500 dark:text-gray-400">
                Utilisé par les apporteurs pour le support
              </p>
            </div>
          </div>

          {/* Téléphones */}
          <div className="space-y-4">
            {/* Téléphone privé */}
            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Numéro de Téléphone Privé <span className="text-red-500">*</span>
              </label>
              {isEditing ? (
                <input
                  type="tel"
                  value={formData.privatePhone}
                  onChange={(e) => setFormData(prev => ({ ...prev, privatePhone: e.target.value }))}
                  placeholder="06 12 34 56 78"
                  className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                    formErrors.privatePhone 
                      ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                      : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
                  } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
                />
              ) : (
                <div className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 rounded-xl text-sm text-gray-900 dark:text-white">
                  {adminData.privatePhone}
                </div>
              )}
              {formErrors.privatePhone && (
                <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                  <i className="ri-error-warning-line mr-1"></i>
                  {formErrors.privatePhone}
                </p>
              )}
            </div>

            {/* Case à cocher pour utiliser le même téléphone */}
            {isEditing && (
              <div className="flex items-center space-x-3">
                <input
                  type="checkbox"
                  id="useSamePhone"
                  checked={formData.useSamePhone}
                  onChange={(e) => handleSamePhoneChange(e.target.checked)}
                  className="w-4 h-4 text-[#335FAD] bg-gray-100 border-gray-300 rounded focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                />
                <label htmlFor="useSamePhone" className="text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer">
                  Utiliser le même numéro pour le professionnel
                </label>
              </div>
            )}

            {/* Téléphone professionnel */}
            {(!formData.useSamePhone || !isEditing) && (
              <div className="space-y-2">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                  Numéro de Téléphone Professionnel {!formData.useSamePhone && isEditing && <span className="text-red-500">*</span>}
                </label>
                {isEditing ? (
                  <input
                    type="tel"
                    value={formData.professionalPhone}
                    onChange={(e) => setFormData(prev => ({ ...prev, professionalPhone: e.target.value }))}
                    placeholder="01 23 45 67 89"
                    disabled={formData.useSamePhone}
                    className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                      formErrors.professionalPhone 
                        ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                        : formData.useSamePhone
                        ? 'border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-500 dark:text-gray-400'
                        : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
                    } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
                  />
                ) : (
                  <div className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 rounded-xl text-sm text-gray-900 dark:text-white">
                    {adminData.useSamePhone ? adminData.privatePhone : (adminData.professionalPhone || 'Non renseigné')}
                  </div>
                )}
                {formErrors.professionalPhone && (
                  <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                    <i className="ri-error-warning-line mr-1"></i>
                    {formErrors.professionalPhone}
                  </p>
                )}
                <p className="text-xs text-gray-500 dark:text-gray-400">
                  {adminData.useSamePhone && !isEditing ? 'Identique au numéro privé' : 'Utilisé pour les contacts professionnels'}
                </p>
              </div>
            )}
          </div>

          {/* Actions d'édition */}
          {isEditing && (
            <div className="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
              <button
                onClick={handleCancel}
                className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer"
              >
                Annuler
              </button>
              <button
                onClick={handleSave}
                disabled={isSaving}
                className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
              >
                {isSaving ? (
                  <>
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    <span>Sauvegarde...</span>
                  </>
                ) : (
                  <>
                    <i className="ri-save-line"></i>
                    <span>Sauvegarder</span>
                  </>
                )}
              </button>
            </div>
          )}
        </div>
      </div>

      {/* Changement de mot de passe */}
      <div className="bg-white dark:bg-gray-800 rounded-2xl border-2 border-gray-100 dark:border-gray-700 p-6">
        <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 space-y-4 sm:space-y-0">
          <div className="flex items-start space-x-4">
            <div className="w-12 h-12 bg-amber-100 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 rounded-xl flex items-center justify-center flex-shrink-0">
              <i className="ri-shield-lock-line text-amber-600 dark:text-amber-400 text-xl"></i>
            </div>
            <div className="flex-1 min-w-0">
              <h3 className="text-xl font-medium text-gray-900 dark:text-white">
                Sécurité Administrateur
              </h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Modifiez votre mot de passe administrateur pour sécuriser l'accès système
              </p>
            </div>
          </div>
          
          {!showPasswordForm && (
            <div className="flex justify-end sm:justify-start">
              <button
                onClick={() => setShowPasswordForm(true)}
                className="bg-amber-100 dark:bg-amber-900/30 hover:bg-amber-200 dark:hover:bg-amber-900/50 text-amber-700 dark:text-amber-400 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer flex items-center space-x-2 whitespace-nowrap"
              >
                <i className="ri-key-line"></i>
                <span>Changer</span>
              </button>
            </div>
          )}
        </div>

        {showPasswordForm && (
          <div className="space-y-4">
            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Mot de passe actuel <span className="text-red-500">*</span>
              </label>
              <input
                type="password"
                value={passwordData.currentPassword}
                onChange={(e) => setPasswordData(prev => ({ ...prev, currentPassword: e.target.value }))}
                placeholder="Votre mot de passe actuel"
                className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                  passwordErrors.currentPassword 
                    ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                    : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
                } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
              />
              {passwordErrors.currentPassword && (
                <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                  <i className="ri-error-warning-line mr-1"></i>
                  {passwordErrors.currentPassword}
                </p>
              )}
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Nouveau mot de passe <span className="text-red-500">*</span>
              </label>
              <input
                type="password"
                value={passwordData.newPassword}
                onChange={(e) => setPasswordData(prev => ({ ...prev, newPassword: e.target.value }))}
                placeholder="Nouveau mot de passe (min. 8 caractères)"
                className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                  passwordErrors.newPassword 
                    ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                    : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
                } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
              />
              {passwordErrors.newPassword && (
                <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                  <i className="ri-error-warning-line mr-1"></i>
                  {passwordErrors.newPassword}
                </p>
              )}
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Confirmer le nouveau mot de passe <span className="text-red-500">*</span>
              </label>
              <input
                type="password"
                value={passwordData.confirmPassword}
                onChange={(e) => setPasswordData(prev => ({ ...prev, confirmPassword: e.target.value }))}
                placeholder="Confirmez le nouveau mot de passe"
                className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                  passwordErrors.confirmPassword 
                    ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                    : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
                } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
              />
              {passwordErrors.confirmPassword && (
                <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                  <i className="ri-error-warning-line mr-1"></i>
                  {passwordErrors.confirmPassword}
                </p>
              )}
            </div>

            <div className="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
              <button
                onClick={() => {
                  setShowPasswordForm(false);
                  setPasswordData({ currentPassword: '', newPassword: '', confirmPassword: '' });
                  setPasswordErrors({});
                }}
                className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer"
              >
                Annuler
              </button>
              <button
                onClick={handlePasswordChange}
                disabled={isChangingPassword}
                className="bg-amber-600 hover:bg-amber-700 dark:bg-amber-500 dark:hover:bg-amber-600 text-white px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
              >
                {isChangingPassword ? (
                  <>
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    <span>Modification...</span>
                  </>
                ) : (
                  <>
                    <i className="ri-check-line"></i>
                    <span>Changer le mot de passe</span>
                  </>
                )}
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

================
File: app/admin/profil/page.tsx
================
'use client';

import { useState, useEffect, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import AdminHeader from '../../../components/AdminHeader';
import AdminProfileInfo from './AdminProfileInfo';
import AdminNotificationSettings from './AdminNotificationSettings';
import { ExadeConfiguration } from '@/components/features/exade/ExadeConfiguration';
import { useAuth } from '@/components/AuthProvider';
import { useBrokerContext } from '@/hooks/useBrokerContext';
import { supabase } from '@/lib/supabase';

// Interface pour les données du header (simplifiée)
interface AdminHeaderData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
}

// Interface pour les données administrateur depuis Supabase
interface AdminData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
  companyName?: string;
  privateEmail: string;
  contactEmail: string;
  privatePhone: string;
  professionalPhone?: string;
  useSamePhone: boolean;
}

// Interface pour les préférences de notification admin
interface AdminNotificationPreferences {
  newApporteur: {
    email: boolean;
    app: boolean;
  };
  dossierSubmitted: {
    email: boolean;
    app: boolean;
  };
  supportRequest: {
    email: boolean;
    app: boolean;
  };
  systemAlerts: {
    email: boolean;
    app: boolean;
  };
  monthlyReport: {
    email: boolean;
    app: boolean;
  };
}

export default function AdminProfilPage() {
  const router = useRouter();
  const [darkMode, setDarkMode] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);
  const [activeSection, setActiveSection] = useState<'profile' | 'notifications' | 'exade'>('profile');
  const [loading, setLoading] = useState(true);
  
  // ✅ Récupération de l'utilisateur connecté et du broker
  const { user } = useAuth();
  const { currentBrokerId } = useBrokerContext();

  // ✅ Données du header depuis l'utilisateur connecté (cohérent avec le dashboard)
  const adminHeaderData = useMemo<AdminHeaderData>(() => {
    const firstName = user?.user_metadata?.prenom || 'Admin';
    const lastName = user?.user_metadata?.nom || '';
    return {
      id: user?.id || 'admin1',
      firstName,
      lastName,
      initials: `${firstName.charAt(0)}${lastName.charAt(0) || ''}`.toUpperCase(),
      role: 'Administrateur'
    };
  }, [user]);

  // Données du profil (peuvent être éditées séparément)
  const [adminData, setAdminData] = useState<AdminData>({
    id: '',
    firstName: '',
    lastName: '',
    initials: '',
    role: 'Administrateur',
    companyName: '',
    privateEmail: '',
    contactEmail: '',
    privatePhone: '',
    professionalPhone: '',
    useSamePhone: false
  });

  // ✅ Charger les données complètes depuis la DB
  useEffect(() => {
    const fetchProfileData = async () => {
      if (!user || !currentBrokerId) return;
      
      setLoading(true);
      try {
        // Récupérer les données du broker
        const { data: brokerData, error: brokerError } = await supabase
          .from('brokers')
          .select('name, billing_email, billing_address')
          .eq('id', currentBrokerId)
          .single();

        if (brokerError) {
          console.error('Erreur lors de la récupération du broker:', brokerError);
        }

        // Mettre à jour les données admin avec les infos de la DB
        setAdminData({
          id: user.id,
          firstName: user.user_metadata?.prenom || '',
          lastName: user.user_metadata?.nom || '',
          initials: `${(user.user_metadata?.prenom || 'A').charAt(0)}${(user.user_metadata?.nom || '').charAt(0)}`.toUpperCase(),
          role: 'Administrateur',
          companyName: brokerData?.name || '',
          privateEmail: user.email || '',
          contactEmail: brokerData?.billing_email || user.email || '',
          privatePhone: user.user_metadata?.telephone || '',
          professionalPhone: '',
          useSamePhone: true
        });
      } catch (error) {
        console.error('Erreur lors du chargement du profil:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchProfileData();
  }, [user, currentBrokerId]);

  // TODO: SUPABASE - Remplacer par les préférences réelles depuis la base de données
  const [notificationPreferences, setNotificationPreferences] = useState<AdminNotificationPreferences>({
    newApporteur: { email: true, app: true },
    dossierSubmitted: { email: true, app: true },
    supportRequest: { email: true, app: true },
    systemAlerts: { email: true, app: true },
    monthlyReport: { email: true, app: false }
  });

  // ✅ Fonction pour sauvegarder les données administrateur dans la DB
  const saveAdminData = async (updatedData: Partial<AdminData>) => {
    if (!currentBrokerId) {
      return { success: false, error: 'Broker non trouvé' };
    }

    try {
      // Mettre à jour les données du broker (nom société, email contact)
      const { error: brokerError } = await supabase
        .from('brokers')
        .update({
          name: updatedData.companyName,
          billing_email: updatedData.contactEmail,
          updated_at: new Date().toISOString()
        })
        .eq('id', currentBrokerId);

      if (brokerError) {
        console.error('Erreur lors de la mise à jour du broker:', brokerError);
        throw brokerError;
      }

      // Mettre à jour les métadonnées utilisateur (téléphone) si nécessaire
      if (updatedData.privatePhone) {
        const { error: userError } = await supabase.auth.updateUser({
          data: {
            telephone: updatedData.privatePhone
          }
        });

        if (userError) {
          console.error('Erreur lors de la mise à jour du téléphone:', userError);
          // Ne pas bloquer si l'update user échoue
        }
      }

      // Mettre à jour l'état local
      setAdminData(prev => ({ ...prev, ...updatedData }));
      return { success: true };
    } catch (error: any) {
      console.error('Erreur lors de la sauvegarde:', error);
      return { success: false, error: error?.message || 'Erreur inconnue' };
    }
  };

  // Fonction pour sauvegarder les préférences de notification
  const saveNotificationPreferences = async (preferences: AdminNotificationPreferences) => {
    try {
      // const { error } = await supabase
      //   .from('admin_notification_preferences')
      //   .upsert({
      //     user_id: adminData.id,
      //     new_apporteur_email: preferences.newApporteur.email,
      //     new_apporteur_app: preferences.newApporteur.app,
      //     dossier_submitted_email: preferences.dossierSubmitted.email,
      //     dossier_submitted_app: preferences.dossierSubmitted.app,
      //     support_request_email: preferences.supportRequest.email,
      //     support_request_app: preferences.supportRequest.app,
      //     system_alerts_email: preferences.systemAlerts.email,
      //     system_alerts_app: preferences.systemAlerts.app,
      //     monthly_report_email: preferences.monthlyReport.email,
      //     monthly_report_app: preferences.monthlyReport.app,
      //     updated_at: new Date().toISOString()
      //   });
      // 
      // if (error) throw error;

      setNotificationPreferences(preferences);
      return { success: true };
    } catch (error: any) {
      console.error('Erreur lors de la sauvegarde des préférences:', error);
      return { success: false, error: error?.message || 'Erreur inconnue' };
    }
  };

  // ✅ Fonction pour changer le mot de passe via Supabase Auth
  const changePassword = async (currentPassword: string, newPassword: string) => {
    try {
      const { error } = await supabase.auth.updateUser({
        password: newPassword
      });
      
      if (error) throw error;
      return { success: true };
    } catch (error: any) {
      console.error('Erreur lors du changement de mot de passe:', error);
      return { success: false, error: error?.message || 'Erreur inconnue' };
    }
  };

  // Initialisation unique du mode sombre
  useEffect(() => {
    if (typeof window !== 'undefined' && !isInitialized) {
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      setDarkMode(savedDarkMode);

      if (savedDarkMode) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }

      setIsInitialized(true);
    }
  }, [isInitialized]);

  // Gestionnaire du mode sombre
  const handleDarkModeToggle = (newDarkMode: boolean) => {
    setDarkMode(newDarkMode);

    if (typeof window !== 'undefined') {
      if (newDarkMode) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('darkMode', 'true');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('darkMode', 'false');
      }
    }
  };

  // Sections de navigation
  const sections = [
    {
      id: 'profile' as const,
      label: 'Informations du Profil',
      icon: 'ri-user-line',
      description: 'Gérez vos informations administrateur'
    },
    {
      id: 'notifications' as const,
      label: 'Préférences de notification',
      icon: 'ri-notification-3-line',
      description: 'Contrôlez les alertes administrateur'
    },
    {
      id: 'exade' as const,
      label: 'Configuration Exade',
      icon: 'ri-plug-line',
      description: 'Gérez la connexion au tarificateur'
    }
  ];

  if (!isInitialized || loading) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>
          <p className="mt-4 text-gray-500 dark:text-gray-400">Chargement du profil...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      <AdminHeader
        darkMode={darkMode}
        setDarkMode={handleDarkModeToggle}
        adminData={adminHeaderData}
      />

      {/* Hero Section */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="px-4 sm:px-8 py-8 sm:py-12 max-w-7xl mx-auto">
          <div>
            <h1 className="text-3xl sm:text-4xl font-light text-gray-900 dark:text-white mb-4">
              Profil Administrateur
            </h1>
            <p className="text-lg text-gray-600 dark:text-gray-400">
              Gérez vos informations administrateur et vos préférences système
            </p>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-7xl mx-auto">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
          {/* Navigation Sidebar */}
          <div className="lg:col-span-1">
            <div className="bg-white dark:bg-gray-800 rounded-2xl border-2 border-gray-100 dark:border-gray-700 p-6 sticky top-8">
              <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-6">
                Navigation
              </h3>

              <nav className="space-y-2">
                {sections.map((section) => (
                  <button
                    key={section.id}
                    onClick={() => setActiveSection(section.id)}
                    className={`w-full text-left p-3 rounded-xl transition-colors cursor-pointer ${activeSection === section.id
                      ? 'bg-indigo-50 dark:bg-indigo-900/30 text-[#335FAD] dark:text-[#335FAD]/80 border border-indigo-200 dark:border-indigo-700'
                      : 'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'
                      }`}
                  >
                    <div className="flex items-center space-x-3">
                      <i className={`${section.icon} text-lg`}></i>
                      <div className="flex-1 min-w-0">
                        <p className="font-medium text-sm truncate">{section.label}</p>
                        <p className="text-xs text-gray-500 dark:text-gray-400 truncate">
                          {section.description}
                        </p>
                      </div>
                    </div>
                  </button>
                ))}
              </nav>
            </div>
          </div>

          {/* Content Area */}
          <div className="lg:col-span-3">
            {activeSection === 'profile' && (
              <AdminProfileInfo
                adminData={adminData}
                onSave={saveAdminData}
                onChangePassword={changePassword}
              />
            )}

            {activeSection === 'notifications' && (
              <AdminNotificationSettings
                preferences={notificationPreferences}
                onSave={saveNotificationPreferences}
              />
            )}

            {activeSection === 'exade' && (
              <ExadeConfiguration />
            )}
          </div>
        </div>
      </main>
    </div>
  );
}

================
File: app/admin/statistiques/page.tsx
================
'use client';

import { useState, useEffect, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import AdminHeader from '../../../components/AdminHeader';
import { DatePicker } from '@/components/ui/date-picker';
import { formatCurrency, formatNumber, formatPercentage } from '@/lib/utils/formatters';
import { useTheme } from '@/lib/hooks/useTheme';
import { DossiersService } from '@/lib/services/dossiers';
import { DevisService } from '@/lib/services/devis';

// ============================================================================
// INTERFACES POUR L'INTÉGRATION SUPABASE
// ============================================================================

// Interface pour les données admin
interface AdminData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
}

// Interface pour les KPIs globaux
interface GlobalKPIs {
  nb_dossiers_traites: number;
  chiffre_affaires_total: number; // Somme des "Frais de Gestion Nets" - À intégrer plus tard
  economie_moyenne_generee: number;
  capital_total_assure: number;
}

// Interface pour l'analyse de l'activité
interface ActivityAnalysis {
  taux_conversion_global: number;
  delai_traitement_moyen: number; // en jours
  nb_dossiers_soumis: number;
  nb_dossiers_finalises: number;
}

// Interface pour les motifs de refus
interface RefusalReason {
  motif: string;
  nombre: number;
  pourcentage: number;
}

// Interface pour l'analyse par compagnie
interface CompanyAnalysis {
  nom_compagnie: string;
  ca_pourcentage: number;
  ca_montant: number;
  nb_devis_envoyes: number;
  nb_devis_acceptes: number;
  taux_acceptation: number;
}

// Interface pour l'évolution temporelle
interface TemporalEvolution {
  periode: string;
  nb_dossiers: number;
  ca_total: number;
  economies_generees: number;
}

// Types pour les filtres de période
type PeriodFilter = 'semaine' | 'mois' | 'trimestre' | 'annee' | 'personnalise';

interface CustomDateRange {
  debut: string;
  fin: string;
}

export default function AdminStatistiquesPage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(true);
  
  // ✅ Utilisation du hook centralisé pour le dark mode
  const { darkMode, isInitialized, toggleDarkMode } = useTheme();
  
  // États pour les filtres de période - Par défaut "annee" pour voir toutes les données existantes
  const [periodFilter, setPeriodFilter] = useState<PeriodFilter>('annee');
  const [customDateRange, setCustomDateRange] = useState<CustomDateRange>({
    debut: '',
    fin: ''
  });
  const [showCustomDatePicker, setShowCustomDatePicker] = useState(false);

  // États pour les données statistiques
  const [globalKPIs, setGlobalKPIs] = useState<GlobalKPIs | null>(null);
  const [activityAnalysis, setActivityAnalysis] = useState<ActivityAnalysis | null>(null);
  const [refusalReasons, setRefusalReasons] = useState<RefusalReason[]>([]);
  const [companyAnalysis, setCompanyAnalysis] = useState<CompanyAnalysis[]>([]);
  const [temporalEvolution, setTemporalEvolution] = useState<TemporalEvolution[]>([]);

  // Données admin simulées
  const adminData = useMemo<AdminData>(() => ({
    id: 'admin1',
    firstName: 'Alexandre',
    lastName: 'Martin',
    initials: 'AM',
    role: 'Administrateur'
  }), []);

  // ============================================================================
  // SUPABASE INTEGRATION - RÉCUPÉRATION DES STATISTIQUES
  // ============================================================================

  /**
   * FONCTION DE RÉCUPÉRATION DES KPIs GLOBAUX
   * 
   * Cette fonction doit récupérer depuis Supabase :
   * 1. Nombre de dossiers traités (finalisés) sur la période
   * 2. Chiffre d'affaires total (somme des frais de gestion nets) - À implémenter plus tard
   * 3. Économie moyenne générée par dossier
   * 4. Capital total assuré
   * 
   * Query Supabase suggérée :
   * ```sql
   * SELECT 
   *   COUNT(CASE WHEN statut = 'finalise' THEN 1 END) as nb_dossiers_traites,
   *   COALESCE(SUM(frais_gestion_nets), 0) as chiffre_affaires_total,
   *   COALESCE(AVG(CASE WHEN statut = 'finalise' THEN economie_generee END), 0) as economie_moyenne_generee,
   *   COALESCE(SUM(CASE WHEN statut = 'finalise' THEN montant_capital END), 0) as capital_total_assure
   * FROM dossiers 
   * WHERE created_at >= $1 AND created_at <= $2
   *   AND is_draft = false
   * ```
   */
  const fetchGlobalKPIs = async (startDate: string, endDate: string) => {
    try {
      // ✅ SUPABASE CONNECTED - Récupération des KPIs globaux réels
      const data = await DossiersService.getStatistiquesPeriode(startDate, endDate);
      return data;
    } catch (error) {
      console.error('Erreur lors de la récupération des KPIs globaux:', error);
      return null;
    }
  };

  /**
   * FONCTION DE RÉCUPÉRATION DE L'ANALYSE D'ACTIVITÉ
   * 
   * Cette fonction calcule :
   * 1. Taux de conversion global
   * 2. Délai de traitement moyen
   * 3. Nombre de dossiers soumis vs finalisés
   * 
   * Query Supabase suggérée :
   * ```sql
   * SELECT 
   *   COUNT(*) as nb_dossiers_soumis,
   *   COUNT(CASE WHEN statut = 'finalise' THEN 1 END) as nb_dossiers_finalises,
   *   ROUND(
   *     (COUNT(CASE WHEN statut = 'finalise' THEN 1 END)::float / COUNT(*)::float) * 100, 2
   *   ) as taux_conversion_global,
   *   ROUND(
   *     AVG(CASE 
   *       WHEN statut = 'finalise' THEN 
   *         EXTRACT(days FROM (date_finalisation - created_at))
   *       END
   *     ), 1
   *   ) as delai_traitement_moyen
   * FROM dossiers 
   * WHERE created_at >= $1 AND created_at <= $2
   *   AND is_draft = false
   * ```
   */
  const fetchActivityAnalysis = async (startDate: string, endDate: string) => {
    try {
      // ✅ SUPABASE CONNECTED - Récupération de l'analyse d'activité réelle
      const data = await DossiersService.getAnalyseActivite(startDate, endDate);
      return data;
    } catch (error) {
      console.error('Erreur lors de la récupération de l\'analyse d\'activité:', error);
      return null;
    }
  };

  /**
   * FONCTION DE RÉCUPÉRATION DES MOTIFS DE REFUS
   * 
   * Cette fonction analyse les motifs de refus saisis par les apporteurs
   * 
   * Query Supabase suggérée :
   * ```sql
   * SELECT 
   *   motif_refus,
   *   COUNT(*) as nombre,
   *   ROUND((COUNT(*)::float / SUM(COUNT(*)) OVER ()) * 100, 1) as pourcentage
   * FROM dossiers 
   * WHERE created_at >= $1 AND created_at <= $2
   *   AND statut = 'refuse'
   *   AND motif_refus IS NOT NULL
   *   AND is_draft = false
   * GROUP BY motif_refus
   * ORDER BY nombre DESC
   * ```
   */
  const fetchRefusalReasons = async (startDate: string, endDate: string) => {
    try {
      // ✅ SUPABASE CONNECTED - Récupération des motifs de refus réels
      const data = await DossiersService.getMotifsRefus(startDate, endDate);
      return data;
    } catch (error) {
      console.error('Erreur lors de la récupération des motifs de refus:', error);
      return [];
    }
  };

  /**
   * FONCTION DE RÉCUPÉRATION DE L'ANALYSE PAR COMPAGNIE
   * 
   * Cette fonction analyse la performance de chaque compagnie d'assurance
   * 
   * Query Supabase suggérée :
   * ```sql
   * SELECT 
   *   c.nom as nom_compagnie,
   *   COALESCE(SUM(d.frais_gestion_nets), 0) as ca_montant,
   *   ROUND(
   *     (COALESCE(SUM(d.frais_gestion_nets), 0)::float / 
   *      NULLIF(SUM(SUM(d.frais_gestion_nets)) OVER (), 0)::float) * 100, 1
   *   ) as ca_pourcentage,
   *   COUNT(CASE WHEN d.statut IN ('devis_envoye', 'valide', 'finalise') THEN 1 END) as nb_devis_envoyes,
   *   COUNT(CASE WHEN d.statut IN ('valide', 'finalise') THEN 1 END) as nb_devis_acceptes,
   *   ROUND(
   *     (COUNT(CASE WHEN d.statut IN ('valide', 'finalise') THEN 1 END)::float /
   *      NULLIF(COUNT(CASE WHEN d.statut IN ('devis_envoye', 'valide', 'finalise') THEN 1 END), 0)::float) * 100, 1
   *   ) as taux_acceptation
   * FROM compagnies_assurance c
   * LEFT JOIN devis dv ON c.id = dv.compagnie_id
   * LEFT JOIN dossiers d ON dv.dossier_id = d.id
   * WHERE d.created_at >= $1 AND d.created_at <= $2
   *   AND d.is_draft = false
   * GROUP BY c.id, c.nom
   * HAVING COUNT(d.id) > 0
   * ORDER BY ca_montant DESC
   * ```
   */
  const fetchCompanyAnalysis = async (startDate: string, endDate: string) => {
    try {
      // ✅ SUPABASE CONNECTED - Récupération de l'analyse par compagnie réelle
      const data = await DevisService.getAnalyseCompagnies(startDate, endDate);
      return data;
    } catch (error) {
      console.error('Erreur lors de la récupération de l\'analyse par compagnie:', error);
      return [];
    }
  };

  /**
   * FONCTION DE RÉCUPÉRATION DE L'ÉVOLUTION TEMPORELLE
   * 
   * Cette fonction récupère l'évolution des indicateurs dans le temps
   * 
   * Query Supabase suggérée :
   * ```sql
   * SELECT 
   *   DATE_TRUNC('month', created_at) as periode,
   *   COUNT(CASE WHEN statut = 'finalise' THEN 1 END) as nb_dossiers,
   *   COALESCE(SUM(CASE WHEN statut = 'finalise' THEN frais_gestion_nets END), 0) as ca_total,
   *   COALESCE(SUM(CASE WHEN statut = 'finalise' THEN economie_generee END), 0) as economies_generees
   * FROM dossiers 
   * WHERE created_at >= $1 AND created_at <= $2
   *   AND is_draft = false
   * GROUP BY DATE_TRUNC('month', created_at)
   * ORDER BY periode ASC
   * ```
   */
  const fetchTemporalEvolution = async (startDate: string, endDate: string) => {
    try {
      // ✅ SUPABASE CONNECTED - Récupération de l'évolution temporelle réelle
      const data = await DossiersService.getEvolutionTemporelle(startDate, endDate);
      return data;
    } catch (error) {
      console.error('Erreur lors de la récupération de l\'évolution temporelle:', error);
      return [];
    }
  };

  // ============================================================================
  // FONCTIONS UTILITAIRES POUR LES DATES
  // ============================================================================

  /**
   * Calcule les dates de début et fin selon le filtre sélectionné
   */
  const getDateRange = (): { startDate: string; endDate: string } => {
    const now = new Date();
    let startDate: Date;
    let endDate: Date = now;

    switch (periodFilter) {
      case 'semaine':
        // Début de la semaine (lundi)
        startDate = new Date(now);
        startDate.setDate(now.getDate() - now.getDay() + 1);
        startDate.setHours(0, 0, 0, 0);
        break;

      case 'mois':
        // Début du mois
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        break;

      case 'trimestre':
        // Début du trimestre
        const quarter = Math.floor(now.getMonth() / 3);
        startDate = new Date(now.getFullYear(), quarter * 3, 1);
        break;

      case 'annee':
        // Début de l'année
        startDate = new Date(now.getFullYear(), 0, 1);
        break;

      case 'personnalise':
        if (customDateRange.debut && customDateRange.fin) {
          startDate = new Date(customDateRange.debut);
          endDate = new Date(customDateRange.fin);
        } else {
          // Par défaut, mois en cours
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        }
        break;

      default:
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
    }

    return {
      startDate: startDate.toISOString(),
      endDate: endDate.toISOString()
    };
  };

  // ============================================================================
  // FONCTION PRINCIPALE DE CHARGEMENT DES DONNÉES
  // ============================================================================

  /**
   * Charge toutes les données statistiques en fonction du filtre de période
   */
  const loadStatistics = async () => {
    setIsLoading(true);
    
    try {
      const { startDate, endDate } = getDateRange();

      // Chargement parallèle de toutes les données
      const [
        kpis,
        activity,
        refusals,
        companies,
        evolution
      ] = await Promise.all([
        fetchGlobalKPIs(startDate, endDate),
        fetchActivityAnalysis(startDate, endDate),
        fetchRefusalReasons(startDate, endDate),
        fetchCompanyAnalysis(startDate, endDate),
        fetchTemporalEvolution(startDate, endDate)
      ]);

      setGlobalKPIs(kpis);
      setActivityAnalysis(activity);
      setRefusalReasons(refusals);
      setCompanyAnalysis(companies);
      setTemporalEvolution(evolution);

    } catch (error) {
      console.error('Erreur lors du chargement des statistiques:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // ✅ Le dark mode est géré par le hook useTheme

  // Chargement initial et rechargement lors du changement de période
  useEffect(() => {
    if (isInitialized) {
      loadStatistics();
    }
  }, [isInitialized, periodFilter, customDateRange]);

  // Fonction pour appliquer la plage de dates personnalisée
  const handleCustomDateApply = () => {
    if (customDateRange.debut && customDateRange.fin) {
      setShowCustomDatePicker(false);
      // Le useEffect se chargera de recharger les données
    }
  };

  // ✅ Utilisation des formatters centralisés depuis lib/utils/formatters.ts

  // Configuration des couleurs pour les graphiques
  const chartColors = [
    '#6366f1', // Indigo
    '#f59e0b', // Amber
    '#10b981', // Emerald
    '#ef4444', // Red
    '#8b5cf6', // Violet
    '#06b6d4', // Cyan
    '#84cc16', // Lime
    '#f97316'  // Orange
  ];

  if (!isInitialized) {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      <AdminHeader 
        darkMode={darkMode} 
        setDarkMode={toggleDarkMode}
        adminData={adminData}
      />
      
      {/* Hero section avec filtre de période global */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="px-4 sm:px-8 py-6 max-w-7xl mx-auto">
          <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
              <h1 className="text-2xl sm:text-3xl font-light text-gray-900 dark:text-white mb-2">
                Statistiques et Analytics
              </h1>
              <p className="text-gray-600 dark:text-gray-400">
                Analyse complète des performances et indicateurs clés
              </p>
            </div>
            
            {/* Filtre de période global */}
            <div className="flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-3">
              <div className="flex gap-1 bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                {(['semaine', 'mois', 'trimestre', 'annee'] as const).map((period) => (
                  <button
                    key={period}
                    onClick={() => setPeriodFilter(period)}
                    className={`px-3 py-1.5 text-xs font-medium rounded-md transition-colors cursor-pointer whitespace-nowrap ${
                      periodFilter === period
                        ? 'bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm'
                        : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
                    }`}
                  >
                    {period === 'semaine' ? 'Semaine' : 
                     period === 'mois' ? 'Mois' : 
                     period === 'trimestre' ? 'Trimestre' : 'Année'}
                  </button>
                ))}
              </div>
              
              <button
                onClick={() => {
                  setPeriodFilter('personnalise');
                  setShowCustomDatePicker(true);
                }}
                className={`px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-medium transition-colors cursor-pointer whitespace-nowrap ${
                  periodFilter === 'personnalise'
                    ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-300 dark:border-indigo-600 text-indigo-700 dark:text-indigo-400'
                    : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600'
                }`}
              >
                <i className="ri-calendar-line mr-2"></i>
                Période personnalisée
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Modal de sélection de dates personnalisées */}
      {showCustomDatePicker && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                  Sélectionner une période
                </h3>
                <button
                  onClick={() => setShowCustomDatePicker(false)}
                  className="w-8 h-8 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full flex items-center justify-center transition-colors cursor-pointer"
                >
                  <i className="ri-close-line text-gray-600 dark:text-gray-300"></i>
                </button>
              </div>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Date de début
                  </label>
                  <DatePicker
                    value={customDateRange.debut}
                    onChange={(value) => setCustomDateRange(prev => ({ ...prev, debut: value }))}
                    placeholder="Sélectionner une date de début"
                    className="w-full"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Date de fin
                  </label>
                  <DatePicker
                    value={customDateRange.fin}
                    onChange={(value) => setCustomDateRange(prev => ({ ...prev, fin: value }))}
                    placeholder="Sélectionner une date de fin"
                    className="w-full"
                  />
                </div>
              </div>

              <div className="flex space-x-3 mt-6">
                <button
                  onClick={() => setShowCustomDatePicker(false)}
                  className="flex-1 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer"
                >
                  Annuler
                </button>
                <button
                  onClick={handleCustomDateApply}
                  disabled={!customDateRange.debut || !customDateRange.fin}
                  className="flex-1 bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Appliquer
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      <main className="px-4 sm:px-8 py-6 max-w-7xl mx-auto">
        {isLoading ? (
          <div className="text-center py-12">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p className="text-gray-600 dark:text-gray-400">Chargement des statistiques...</p>
          </div>
        ) : (
          <div className="space-y-8">
            {/* Indicateurs de Performance Globale (KPIs) */}
            {globalKPIs && (
              <div>
                <h2 className="text-xl font-medium text-gray-900 dark:text-white mb-6">
                  Indicateurs de Performance Globale
                </h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                  <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Dossiers Traités</p>
                        <p className="text-2xl font-light text-gray-900 dark:text-white">{formatNumber(globalKPIs.nb_dossiers_traites)}</p>
                      </div>
                      <div className="w-12 h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 rounded-lg flex items-center justify-center">
                        <i className="ri-file-check-line text-[#335FAD] dark:text-[#335FAD] text-xl"></i>
                      </div>
                    </div>
                  </div>

                  <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Chiffre d'Affaires</p>
                        <p className="text-2xl font-light text-gray-900 dark:text-white">
                          {globalKPIs.chiffre_affaires_total > 0 ? formatCurrency(globalKPIs.chiffre_affaires_total) : 'À venir'}
                        </p>
                        {globalKPIs.chiffre_affaires_total === 0 && (
                          <p className="text-xs text-orange-600 dark:text-orange-400 mt-1">
                            Fonctionnalité en développement
                          </p>
                        )}
                      </div>
                      <div className="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                        <i className="ri-money-euro-circle-line text-green-600 dark:text-green-400 text-xl"></i>
                      </div>
                    </div>
                  </div>

                  <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Économie Moyenne</p>
                        <p className="text-2xl font-light text-gray-900 dark:text-white">{formatCurrency(globalKPIs.economie_moyenne_generee)}</p>
                        <p className="text-xs text-green-600 dark:text-green-400 mt-1">
                          Par dossier traité
                        </p>
                      </div>
                      <div className="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center">
                        <i className="ri-medal-line text-purple-600 dark:text-purple-400 text-xl"></i>
                      </div>
                    </div>
                  </div>

                  <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Capital Total Assuré</p>
                        <p className="text-xl font-light text-gray-900 dark:text-white">{formatCurrency(globalKPIs.capital_total_assure)}</p>
                      </div>
                      <div className="w-12 h-12 bg-orange-100 dark:bg-orange-900/30 rounded-lg flex items-center justify-center">
                        <i className="ri-safe-line text-orange-600 dark:text-orange-400 text-xl"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Analyse de l'Activité */}
            {activityAnalysis && (
              <div>
                <h2 className="text-xl font-medium text-gray-900 dark:text-white mb-6">
                  Analyse de l'Activité (Efficacité Opérationnelle)
                </h2>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                      Taux de Conversion Global
                    </h3>
                    <div className="flex items-center space-x-4">
                      <div className="flex-1">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-3xl font-light text-gray-900 dark:text-white">
                            {formatPercentage(activityAnalysis.taux_conversion_global)}
                          </span>
                          <div className={`flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                            activityAnalysis.taux_conversion_global >= 75 
                              ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400'
                              : activityAnalysis.taux_conversion_global >= 60
                              ? 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400'
                              : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'
                          }`}>
                            {activityAnalysis.taux_conversion_global >= 75 ? 'Excellent' :
                             activityAnalysis.taux_conversion_global >= 60 ? 'Correct' : 'À améliorer'}
                          </div>
                        </div>
                        <p className="text-sm text-gray-500 dark:text-gray-400">
                          {formatNumber(activityAnalysis.nb_dossiers_finalises)} finalisés sur {formatNumber(activityAnalysis.nb_dossiers_soumis)} soumis
                        </p>
                      </div>
                    </div>
                  </div>

                  <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                      Délai de Traitement Moyen
                    </h3>
                    <div className="flex items-center space-x-4">
                      <div className="flex-1">
                        {activityAnalysis.delai_traitement_moyen > 0 ? (
                          <>
                            <div className="flex items-center justify-between mb-2">
                              <span className="text-3xl font-light text-gray-900 dark:text-white">
                                {activityAnalysis.delai_traitement_moyen.toFixed(1)} jours
                              </span>
                              <div className={`flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                activityAnalysis.delai_traitement_moyen <= 10 
                                  ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400'
                                  : activityAnalysis.delai_traitement_moyen <= 15
                                  ? 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400'
                                  : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'
                              }`}>
                                {activityAnalysis.delai_traitement_moyen <= 10 ? 'Rapide' :
                                 activityAnalysis.delai_traitement_moyen <= 15 ? 'Correct' : 'Lent'}
                              </div>
                            </div>
                            <p className="text-sm text-gray-500 dark:text-gray-400">
                              De la soumission à la finalisation
                            </p>
                          </>
                        ) : (
                          <>
                            <div className="flex items-center justify-between mb-2">
                              <span className="text-2xl font-light text-gray-400 dark:text-gray-500">
                                N/A
                              </span>
                              <div className="flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">
                                Données insuffisantes
                              </div>
                            </div>
                            <p className="text-sm text-gray-500 dark:text-gray-400">
                              Applicable aux nouveaux dossiers finalisés
                            </p>
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Analyse des Motifs de Refus */}
            <div>
              <h2 className="text-xl font-medium text-gray-900 dark:text-white mb-6">
                Analyse des Motifs de Refus
              </h2>
              {refusalReasons.length > 0 ? (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    {/* Graphique en barres */}
                    <div>
                      <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        Répartition des motifs
                      </h3>
                      <div className="space-y-4">
                        {refusalReasons.map((reason, index) => (
                          <div key={index} className="flex items-center">
                            <div className="flex-1">
                              <div className="flex items-center justify-between mb-1">
                                <span className="text-sm font-medium text-gray-900 dark:text-white">
                                  {reason.motif}
                                </span>
                                <span className="text-sm text-gray-500 dark:text-gray-400">
                                  {reason.nombre} ({formatPercentage(reason.pourcentage)})
                                </span>
                              </div>
                              <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div
                                  className="h-2 rounded-full transition-all duration-300"
                                  style={{
                                    width: `${reason.pourcentage}%`,
                                    backgroundColor: chartColors[index % chartColors.length]
                                  }}
                                ></div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Graphique en camembert (représentation visuelle) */}
                    <div>
                      <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        Vue d'ensemble
                      </h3>
                      <div className="relative w-48 h-48 mx-auto">
                        {/* Cercle représentant le camembert */}
                        <div className="absolute inset-0 rounded-full border-8 border-gray-200 dark:border-gray-700"></div>
                        
                        {/* Légende */}
                        <div className="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-center">
                          <p className="text-sm font-medium text-gray-900 dark:text-white">
                            {refusalReasons.reduce((acc, curr) => acc + curr.nombre, 0)} refus analysés
                          </p>
                        </div>
                      </div>
                      
                      {/* Légende détaillée */}
                      <div className="mt-8 space-y-2">
                        {refusalReasons.slice(0, 3).map((reason, index) => (
                          <div key={index} className="flex items-center space-x-2">
                            <div
                              className="w-3 h-3 rounded-full"
                              style={{ backgroundColor: chartColors[index] }}
                            ></div>
                            <span className="text-xs text-gray-600 dark:text-gray-400">
                              {reason.motif} ({formatPercentage(reason.pourcentage)})
                            </span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-12 text-center">
                  <div className="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i className="ri-bar-chart-line text-gray-400 text-2xl"></i>
                  </div>
                  <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
                    Aucun refus pour cette période
                  </h3>
                  <p className="text-gray-600 dark:text-gray-400">
                    Les motifs de refus apparaîtront ici lorsque des devis seront refusés
                  </p>
                </div>
              )}
            </div>

            {/* Analyse des Produits (Compagnies d'Assurance) */}
            <div>
              <h2 className="text-xl font-medium text-gray-900 dark:text-white mb-6">
                Analyse des Produits (Compagnies d'Assurance)
              </h2>
              {companyAnalysis.length > 0 ? (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Répartition du CA par Compagnie */}
                  <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                      Répartition du CA par Compagnie
                    </h3>
                    <div className="space-y-4">
                      {companyAnalysis.map((company, index) => (
                        <div key={index} className="flex items-center">
                          <div className="flex-1">
                            <div className="flex items-center justify-between mb-1">
                              <span className="text-sm font-medium text-gray-900 dark:text-white">
                                {company.nom_compagnie}
                              </span>
                              <span className="text-sm text-gray-500 dark:text-gray-400">
                                {formatCurrency(company.ca_montant)} ({formatPercentage(company.ca_pourcentage)})
                              </span>
                            </div>
                            <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                              <div
                                className="h-3 rounded-full transition-all duration-300"
                                style={{
                                  width: `${company.ca_pourcentage}%`,
                                  backgroundColor: chartColors[index % chartColors.length]
                                }}
                              ></div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                    
                    <div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                      <p className="text-xs text-gray-500 dark:text-gray-400">
                        Essentiel pour les négociations avec les compagnies
                      </p>
                    </div>
                  </div>

                  {/* Taux d'Acceptation par Compagnie */}
                  <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                      Taux d'Acceptation par Compagnie
                    </h3>
                    <div className="space-y-4">
                      {companyAnalysis.map((company, index) => (
                        <div key={index} className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                          <div>
                            <p className="font-medium text-gray-900 dark:text-white">
                              {company.nom_compagnie}
                            </p>
                            <p className="text-xs text-gray-500 dark:text-gray-400">
                              {company.nb_devis_acceptes}/{company.nb_devis_envoyes} devis
                            </p>
                          </div>
                          <div className="text-right">
                            <p className={`text-lg font-medium ${
                              company.taux_acceptation >= 80 
                                ? 'text-green-600 dark:text-green-400'
                                : company.taux_acceptation >= 70
                                ? 'text-orange-600 dark:text-orange-400'
                                : 'text-red-600 dark:text-red-400'
                            }`}>
                              {formatPercentage(company.taux_acceptation)}
                            </p>
                            <div className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                              company.taux_acceptation >= 80 
                                ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400'
                                : company.taux_acceptation >= 70
                                ? 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400'
                                : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'
                            }`}>
                              {company.taux_acceptation >= 80 ? 'Excellent' :
                               company.taux_acceptation >= 70 ? 'Bon' : 'À améliorer'}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                    
                    <div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                      <p className="text-xs text-gray-500 dark:text-gray-400">
                        Mesure l'attractivité des offres de chaque assureur
                      </p>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-12 text-center">
                  <div className="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i className="ri-shield-check-line text-gray-400 text-2xl"></i>
                  </div>
                  <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
                    Aucune donnée disponible
                  </h3>
                  <p className="text-gray-600 dark:text-gray-400">
                    Les analyses par compagnie apparaîtront ici lorsque des devis seront générés
                  </p>
                </div>
              )}
            </div>

            {/* Évolution Temporelle */}
            <div>
              <h2 className="text-xl font-medium text-gray-900 dark:text-white mb-6">
                Évolution Temporelle
              </h2>
              {temporalEvolution.length > 0 ? (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50 dark:bg-gray-700/50">
                        <tr>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Période
                          </th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Dossiers
                          </th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            CA Total
                          </th>
                          <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Économies Générées
                          </th>
                        </tr>
                      </thead>
                      <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        {temporalEvolution.map((period, index) => (
                          <tr key={index} className="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                            <td className="px-4 py-4 text-sm font-medium text-gray-900 dark:text-white">
                              {new Date(period.periode).toLocaleDateString('fr-FR', { 
                                year: 'numeric', 
                                month: 'long' 
                              })}
                            </td>
                            <td className="px-4 py-4 text-sm text-gray-900 dark:text-white">
                              {formatNumber(period.nb_dossiers)}
                            </td>
                            <td className="px-4 py-4 text-sm font-medium text-gray-900 dark:text-white">
                              {formatCurrency(period.ca_total)}
                            </td>
                            <td className="px-4 py-4 text-sm font-medium text-green-600 dark:text-green-400">
                              {formatCurrency(period.economies_generees)}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              ) : (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-12 text-center">
                  <div className="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i className="ri-line-chart-line text-gray-400 text-2xl"></i>
                  </div>
                  <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
                    Aucune donnée temporelle disponible
                  </h3>
                  <p className="text-gray-600 dark:text-gray-400">
                    L'évolution temporelle apparaîtra ici lorsque des dossiers seront finalisés
                  </p>
                </div>
              )}
            </div>
          </div>
        )}
      </main>
    </div>
  );
}

================
File: app/api/admin/devis/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import { supabase } from '@/lib/supabase'

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const { dossierId, devis, selectedDevisId } = body

    if (!dossierId || !devis || !Array.isArray(devis)) {
      return NextResponse.json(
        { error: 'Paramètres manquants ou invalides' },
        { status: 400 }
      )
    }

    // Créer les devis en base
    const devisToInsert = devis.map((devisItem: any) => ({
      dossier_id: dossierId,
      numero_devis: `DEV-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      statut: selectedDevisId === devisItem.id ? 'envoye' : 'en_attente',
      donnees_devis: {
        compagnie: devisItem.compagnie,
        produit: devisItem.produit,
        cout_mensuel: devisItem.cout_mensuel,
        cout_total: devisItem.cout_total,
        economie_estimee: devisItem.economie_estimee,
        formalites_medicales: devisItem.formalites_medicales,
        couverture: devisItem.couverture,
        exclusions: devisItem.exclusions,
        avantages: devisItem.avantages,
        taux_assurance: devisItem.taux_assurance,
        frais_adhesion: devisItem.frais_adhesion,
        frais_frac: devisItem.frais_frac
      },
      selected: selectedDevisId === devisItem.id
    }))

    const { data: insertedDevis, error: insertError } = await supabase
      .from('devis')
      .insert(devisToInsert)
      .select()

    if (insertError) {
      console.error('Erreur insertion devis:', insertError)
      return NextResponse.json(
        { error: 'Erreur lors de la création des devis' },
        { status: 500 }
      )
    }

    // Si un devis est sélectionné, mettre à jour le dossier
    if (selectedDevisId) {
      const selectedDevis = insertedDevis?.find(d => d.donnees_devis?.compagnie === devis.find((d: any) => d.id === selectedDevisId)?.compagnie)
      
      if (selectedDevis) {
        const { error: updateError } = await supabase
          .from('dossiers')
          .update({
            devis_selectionne_id: selectedDevis.id,
            statut_canon: 'devis_disponible'
          })
          .eq('id', dossierId)

        if (updateError) {
          console.error('Erreur mise à jour dossier:', updateError)
          // Ne pas échouer si on ne peut pas mettre à jour le dossier
        }
      }
    }

    return NextResponse.json({
      success: true,
      devis: insertedDevis,
      message: `${insertedDevis?.length || 0} devis créés avec succès`
    })

  } catch (error) {
    console.error('Erreur API admin devis:', error)
    return NextResponse.json(
      { error: 'Erreur interne du serveur' },
      { status: 500 }
    )
  }
}

================
File: app/api/devis/manage/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@supabase/supabase-js'

type DevisAction = 'validate' | 'refuse'

export async function POST(req: NextRequest) {
  try {
    const supabaseClient = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    )

    // Auth utilisateur via header Authorization
    const { data: { user }, error: userError } = await supabaseClient.auth.getUser()
    if (userError || !user) {
      return NextResponse.json({ error: 'Non authentifié' }, { status: 401 })
    }

    const body = await req.json()
    const action: DevisAction = body?.action
    const devisId: string = body?.devisId
    const dossierId: string = body?.dossierId
    const reason: string | undefined = body?.reason

    if (!action || !devisId || !dossierId) {
      return NextResponse.json({ error: 'Paramètres manquants' }, { status: 400 })
    }

    // Vérifier que l'utilisateur est bien rattaché au dossier via son profil apporteur
    const { data: ownership, error: ownErr } = await supabaseClient
      .from('dossiers')
      .select('id')
      .eq('id', dossierId)
      .in('apporteur_id', (
        await supabaseClient
          .from('apporteur_profiles')
          .select('id')
          .eq('user_id', user.id)
      ).data?.map((r: any) => r.id) || [] )
      .maybeSingle()

    if (ownErr || !ownership) {
      return NextResponse.json({ error: 'Accès non autorisé au dossier' }, { status: 403 })
    }

    if (action === 'validate') {
      const { error: devisError } = await supabaseClient
        .from('devis')
        .update({
          statut: 'accepte',
          validated_at: new Date().toISOString(),
          validated_by: user.id
        })
        .eq('id', devisId)

      if (devisError) throw devisError

      await supabaseClient
        .from('dossiers')
        .update({
          statut_canon: 'valide',
          updated_at: new Date().toISOString()
        })
        .eq('id', dossierId)

      await supabaseClient
        .from('process_steps')
        .update({ status: 'completed', completed_at: new Date().toISOString() })
        .eq('dossier_id', dossierId)
        .eq('step_order', 5)

      await supabaseClient
        .from('process_steps')
        .update({ status: 'current' })
        .eq('dossier_id', dossierId)
        .eq('step_order', 6)

      // Récupérer les informations du dossier et du devis pour l'activité
      const { data: dossierInfo } = await supabaseClient
        .from('dossiers')
        .select('numero_dossier, apporteur_id')
        .eq('id', dossierId)
        .single()

      const { data: devisInfo } = await supabaseClient
        .from('devis')
        .select('numero_devis')
        .eq('id', devisId)
        .single()

      // Créer une activité pour l'apporteur
      if (dossierInfo?.apporteur_id) {
        await supabaseClient
          .from('activities')
          .insert({
            user_id: dossierInfo.apporteur_id,
            dossier_id: dossierId,
            activity_type: 'devis_accepte',
            activity_title: 'Devis accepté',
            activity_description: `Le devis ${devisInfo?.numero_devis || devisId} du dossier ${dossierInfo?.numero_dossier || dossierId} a été accepté par le client.`,
            activity_data: {
              dossier_id: dossierId,
              devis_id: devisId,
              numero_dossier: dossierInfo?.numero_dossier,
              numero_devis: devisInfo?.numero_devis,
              action: 'devis_accepte'
            }
          })
      }

      await supabaseClient
        .from('notifications')
        .insert({
          type: 'devis_accepte',
          dossier_id: dossierId,
          user_id: user.id,
          title: 'Devis accepté',
          message: 'Le devis a été accepté'
        })

      return NextResponse.json({ success: true, action, message: 'Devis validé avec succès' })
    }

    if (action === 'refuse') {
      if (!reason) {
        return NextResponse.json({ error: 'Raison du refus obligatoire' }, { status: 400 })
      }

      // Récupérer les données actuelles du devis
      const { data: currentDevis, error: fetchError } = await supabaseClient
        .from('devis')
        .select('donnees_devis')
        .eq('id', devisId)
        .single()

      if (fetchError) throw fetchError

      // Mettre à jour le devis avec le motif de refus dans donnees_devis
      const { error: devisError } = await supabaseClient
        .from('devis')
        .update({
          statut: 'refuse',
          refused_at: new Date().toISOString(),
          donnees_devis: {
            ...currentDevis?.donnees_devis,
            motif_refus: reason
          }
        })
        .eq('id', devisId)

      if (devisError) throw devisError

      await supabaseClient
        .from('dossiers')
        .update({
          statut_canon: 'refuse',
          commentaire: reason,
          updated_at: new Date().toISOString()
        })
        .eq('id', dossierId)

      await supabaseClient
        .from('process_steps')
        .update({ status: 'error', completed_at: new Date().toISOString() })
        .eq('dossier_id', dossierId)
        .eq('step_order', 5)

      // Récupérer les informations du dossier et du devis pour l'activité
      const { data: dossierInfo } = await supabaseClient
        .from('dossiers')
        .select('numero_dossier, apporteur_id')
        .eq('id', dossierId)
        .single()

      const { data: devisInfo } = await supabaseClient
        .from('devis')
        .select('numero_devis')
        .eq('id', devisId)
        .single()

      // Créer une activité pour l'apporteur
      if (dossierInfo?.apporteur_id) {
        await supabaseClient
          .from('activities')
          .insert({
            user_id: dossierInfo.apporteur_id,
            dossier_id: dossierId,
            activity_type: 'devis_refuse',
            activity_title: 'Devis refusé',
            activity_description: `Le devis ${devisInfo?.numero_devis || devisId} du dossier ${dossierInfo?.numero_dossier || dossierId} a été refusé par le client. Motif: ${reason}`,
            activity_data: {
              dossier_id: dossierId,
              devis_id: devisId,
              numero_dossier: dossierInfo?.numero_dossier,
              numero_devis: devisInfo?.numero_devis,
              motif_refus: reason,
              action: 'devis_refuse'
            }
          })
      }

      await supabaseClient
        .from('notifications')
        .insert({
          type: 'devis_refuse',
          dossier_id: dossierId,
          user_id: user.id,
          title: 'Devis refusé',
          message: 'Le devis a été refusé',
          details: { reason }
        })

      return NextResponse.json({ success: true, action, message: 'Devis refusé' })
    }

    return NextResponse.json({ error: 'Action non reconnue' }, { status: 400 })
  } catch (error: any) {
    console.error('[API] /api/devis/manage error', error)
    return NextResponse.json({ error: error?.message || 'Erreur interne' }, { status: 400 })
  }
}

================
File: app/api/dossiers/[id]/client/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@supabase/supabase-js'

export async function PUT(_req: NextRequest, { params }: { params: Promise<{ id: string }> }) {
  try {
    const { id: dossierId } = await params;
    
    const supabaseClient = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    )

    const { data: { user }, error: userError } = await supabaseClient.auth.getUser()
    if (userError || !user) {
      return NextResponse.json({ error: 'Non authentifié' }, { status: 401 })
    }

    // Vérifier admin
    const { data: profile, error: profileError } = await supabaseClient
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single()
    if (profileError || profile?.role !== 'admin') {
      return NextResponse.json({ error: 'Accès non autorisé - Admin seulement' }, { status: 403 })
    }
    const body = await _req.json()
    const clientData = body?.clientData || {}

    const { error: updateClientError } = await supabaseClient
      .from('client_infos')
      .update({
        client_nom: clientData.client_nom,
        client_prenom: clientData.client_prenom,
        client_email: clientData.client_email,
        client_telephone: clientData.client_telephone,
        client_date_naissance: clientData.client_date_naissance,
        client_adresse: clientData.client_adresse,
        client_profession: clientData.client_profession,
        client_fumeur: clientData.client_fumeur,
        updated_at: new Date().toISOString()
      })
      .eq('dossier_id', dossierId)

    if (updateClientError) throw updateClientError

    await supabaseClient
      .from('dossiers')
      .update({ updated_at: new Date().toISOString() })
      .eq('id', dossierId)

    await supabaseClient
      .from('admin_logs')
      .insert({
        admin_id: user.id,
        action: 'update_client_data',
        dossier_id: dossierId,
        details: { updated_fields: Object.keys(clientData) }
      })

    return NextResponse.json({ success: true })
  } catch (error: any) {
    console.error('[API] PUT /api/dossiers/[id]/client error', error)
    return NextResponse.json({ error: error?.message || 'Erreur interne' }, { status: 400 })
  }
}

================
File: app/api/dossiers/[id]/pret/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@supabase/supabase-js'

export async function PUT(req: NextRequest, { params }: { params: Promise<{ id: string }> }) {
  try {
    const { id: dossierId } = await params;
    
    const supabaseClient = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    )

    const { data: { user }, error: userError } = await supabaseClient.auth.getUser()
    if (userError || !user) {
      return NextResponse.json({ error: 'Non authentifié' }, { status: 401 })
    }

    // Vérifier admin
    const { data: profile, error: profileError } = await supabaseClient
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single()
    if (profileError || profile?.role !== 'admin') {
      return NextResponse.json({ error: 'Accès non autorisé - Admin seulement' }, { status: 403 })
    }
    const body = await req.json()
    const pretData = body?.pretData || {}

    const { error: upsertPretError } = await supabaseClient
      .from('pret_data')
      .upsert({
        dossier_id: dossierId,
        banque_preteuse: pretData.banque_preteuse,
        montant_capital: pretData.montant_capital,
        duree_mois: pretData.duree_mois,
        type_pret: pretData.type_pret,
        cout_assurance_banque: pretData.cout_assurance_banque,
        updated_at: new Date().toISOString()
      })

    if (upsertPretError) throw upsertPretError

    const { error: updateDossierError } = await supabaseClient
      .from('dossiers')
      .update({
        montant_capital: pretData.montant_capital,
        updated_at: new Date().toISOString()
      })
      .eq('id', dossierId)

    if (updateDossierError) throw updateDossierError

    await supabaseClient
      .from('devis')
      .update({ needs_recalculation: true })
      .eq('dossier_id', dossierId)

    await supabaseClient
      .from('admin_logs')
      .insert({
        admin_id: user.id,
        action: 'update_pret_data',
        dossier_id: dossierId,
        details: { updated_fields: Object.keys(pretData) }
      })

    return NextResponse.json({ success: true, recalculation_needed: true })
  } catch (error: any) {
    console.error('[API] PUT /api/dossiers/[id]/pret error', error)
    return NextResponse.json({ error: error?.message || 'Erreur interne' }, { status: 400 })
  }
}

================
File: app/api/dossiers/create/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@supabase/supabase-js'
import { supabase } from '@/lib/supabase'

export const runtime = 'nodejs'

export async function POST(request: NextRequest) {
  console.log('[API] POST /api/dossiers/create - Début')
  console.log('[API] NODE_ENV:', process.env.NODE_ENV)
  console.log('[API] SUPABASE_URL:', process.env.NEXT_PUBLIC_SUPABASE_URL ? 'Défini' : 'Non défini')
  console.log('[API] SUPABASE_ANON_KEY:', process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ? 'Défini' : 'Non défini')
  console.log('[API] SERVICE_ROLE_KEY:', process.env.SUPABASE_SERVICE_ROLE_KEY ? 'Défini' : 'Non défini')
  try {
    const isUuid = (v: any) => typeof v === 'string' && /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(v)
    // Initialize Supabase client avec l'auth du client
    console.log('[API] Initialisation du client Supabase...')
    const supabaseClient = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    )
    
    // Client Supabase avec service role pour l'upload de fichiers
    const supabaseServiceClient = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!,
      {
        auth: {
          persistSession: false,
          autoRefreshToken: false
        },
        global: {
          headers: {
            Authorization: `Bearer ${process.env.SUPABASE_SERVICE_ROLE_KEY!}`
          }
        }
      }
    )
    console.log('[API] Client Supabase initialisé')

    // Vérifier l'authentification
    console.log('[API] Vérification de l\'authentification...')
    const { data: { user: authUser }, error: userError } = await supabaseClient.auth.getUser()
    let user = authUser
    
    if (userError || !user) {
      console.log('[API] Erreur auth ou pas d\'utilisateur:', userError)
      
      // En développement, permettre la création sans authentification
      if (process.env.NODE_ENV === 'development') {
        console.log('[API] Mode développement - création utilisateur fictif')
        user = { 
          id: 'dev-user-123', 
          email: 'dev@example.com',
          app_metadata: {},
          user_metadata: {},
          aud: 'authenticated',
          created_at: new Date().toISOString()
        } as any;
      } else {
        console.log('[API] Pas d\'utilisateur - retour 401')
        return NextResponse.json(
          { error: 'Non authentifié' },
          { status: 401 }
        )
      }
    }
    
    console.log('[API] Authentification OK, utilisateur:', user?.id)

    console.log('[API] Parsing du FormData...')
    const formData = await request.formData()
    
    // Extraire les données de base
    const dossierData = {
      type: formData.get('type') as string,
      clientInfo: JSON.parse(formData.get('clientInfo') as string),
      commentaire: formData.get('commentaire') as string,
      isComplete: formData.get('isComplete') === 'true',
      createdByAdmin: formData.get('createdByAdmin') === 'true',
      documents: {
        offrePret: formData.get('documents.offrePret') as File | null,
        tableauAmortissement: formData.get('documents.tableauAmortissement') as File | null,
        carteIdentite: formData.get('documents.carteIdentite') as File | null,
        carteIdentiteConjoint: formData.get('documents.carteIdentiteConjoint') as File | null
      }
    }
    
    console.log('[API] Dossier data reçu:', {
      type: dossierData.type,
      clientInfo: dossierData.clientInfo,
      commentaire: dossierData.commentaire,
      isComplete: dossierData.isComplete,
      createdByAdmin: dossierData.createdByAdmin,
      documents: {
        offrePret: dossierData.documents.offrePret?.name,
        tableauAmortissement: dossierData.documents.tableauAmortissement?.name,
        carteIdentite: dossierData.documents.carteIdentite?.name,
        carteIdentiteConjoint: dossierData.documents.carteIdentiteConjoint?.name
      }
    })
    
    // Validation des données obligatoires
    console.log('[API] Validation des données...')
    if (!dossierData.clientInfo) {
      console.error('[API] clientInfo manquant')
      return NextResponse.json({ error: 'Informations client manquantes' }, { status: 400 })
    }
    
    if (!dossierData.clientInfo.nom || !dossierData.clientInfo.prenom || !dossierData.clientInfo.email) {
      console.error('[API] Champs obligatoires manquants dans clientInfo')
      return NextResponse.json({ error: 'Nom, prénom et email sont obligatoires' }, { status: 400 })
    }
    
    console.log('[API] Validation OK')

    // TODO: Gérer les brouillons si nécessaire
    // if (dossierData.isDraft && dossierData.draftId) {
    //   await supabaseClient
    //     .from('dossiers')
    //     .delete()
    //     .eq('id', dossierData.draftId)
    // }

    // Création manuelle du dossier (sans RPC pour debug)
    console.log('[API] Création manuelle du dossier...')
    
    // Mapper le type de dossier frontend vers les types DB valides
    const typeDossierMapping: { [key: string]: string } = {
      'seul': 'pret_immobilier', // Par défaut pour les dossiers individuels
      'couple': 'pret_immobilier' // Par défaut pour les dossiers de couple
    }
    
    const mappedTypeDossier = typeDossierMapping[dossierData.type] || 'pret_immobilier'
    console.log('[API] Type dossier mappé:', mappedTypeDossier)
    
    // Générer un numéro de dossier simple
    const numeroDossier = `DOS-${new Date().getFullYear()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`
    console.log('[API] Numéro de dossier généré:', numeroDossier)
    
    // Créer le dossier principal
    console.log('[API] Création du dossier principal...')
    
    // En développement, utiliser un apporteur fictif
    let apporteurId = null
    if (process.env.NODE_ENV === 'development') {
      // Récupérer le premier apporteur ou créer un fictif
      const { data: apporteurs } = await supabaseClient
        .from('apporteur_profiles')
        .select('id')
        .limit(1)
      
      if (apporteurs && apporteurs.length > 0) {
        apporteurId = apporteurs[0].id
      } else {
        // Créer un apporteur fictif pour les tests
        const { data: fictifApporteur } = await supabaseClient
          .from('apporteur_profiles')
          .insert({
            user_id: user?.id || 'dev-user-123',
            nom: 'Dev',
            prenom: 'Apporteur',
            email: 'dev@apporteur.com'
          })
          .select('id')
          .single()
        apporteurId = fictifApporteur?.id
      }
    }
    
    const { data: createdDossier, error: dossierError } = await supabaseClient
      .from('dossiers')
      .insert({
        numero_dossier: numeroDossier,
        type_dossier: mappedTypeDossier,
        commentaire: dossierData.commentaire || null,
        statut_canon: 'en_attente',
        // Ajouter un champ pour distinguer couple/seul
        is_couple: dossierData.type === 'couple',
        // Ajouter apporteur_id pour les permissions
        apporteur_id: apporteurId
      })
      .select()
      .single()

    if (dossierError) {
      console.error('[API] Erreur création dossier:', dossierError)
      throw dossierError
    }
    
    const dossierId = createdDossier.id
    console.log('[API] Dossier créé avec ID:', dossierId)
    
    // Créer les informations client
    console.log('[API] Création des informations client...')
    const { error: clientError } = await supabaseClient
      .from('client_infos')
      .insert({
        dossier_id: dossierId,
        client_nom: dossierData.clientInfo?.nom,
        client_prenom: dossierData.clientInfo?.prenom,
        client_date_naissance: dossierData.clientInfo?.dateNaissance,
        client_profession: dossierData.clientInfo?.profession || null,
        client_fumeur: dossierData.clientInfo?.fumeur ?? false,
        client_email: dossierData.clientInfo?.email,
        client_telephone: dossierData.clientInfo?.telephone || null,
        client_adresse: dossierData.clientInfo?.adresse || null,
        conjoint_nom: dossierData.clientInfo?.conjoint?.nom || null,
        conjoint_prenom: dossierData.clientInfo?.conjoint?.prenom || null,
        conjoint_date_naissance: dossierData.clientInfo?.conjoint?.dateNaissance || null,
        conjoint_profession: dossierData.clientInfo?.conjoint?.profession || null,
        conjoint_fumeur: dossierData.clientInfo?.conjoint?.fumeur ?? null
      })

    if (clientError) {
      console.error('[API] Erreur création client info:', clientError)
      // Nettoyer le dossier créé
      await supabaseClient.from('dossiers').delete().eq('id', dossierId)
      throw clientError
    }
    
    console.log('[API] Informations client créées avec succès')

    // Upload des documents si fournis (all-or-nothing)
    console.log('[API] Documents à uploader:', dossierData.documents)
    const uploadedFiles: string[] = []
    let documentUploadFailed = false
    let documentFailureReason: string | null = null
    if (dossierData.documents) {
      for (const [documentType, file] of Object.entries(dossierData.documents)) {
        if (!file) {
          console.log(`[API] Document ${documentType} non fourni`)
          continue
        }
        if (!(file instanceof File)) {
          console.warn(`[API] Document ${documentType} non valide (pas un File)`)
          continue
        }
        if (file.size <= 0) {
          console.log(`[API] Document ${documentType} ignoré (fichier vide)`)
          continue
        }
        try {
          console.log(`[API] Upload du document ${documentType}:`, file.name, `(${file.size} bytes)`)
          const arrayBuffer = await file.arrayBuffer()
          const buffer = Buffer.from(new Uint8Array(arrayBuffer))
          const fileExtension = file.name.split('.').pop() || 'pdf'
          const fileName = `${dossierId}/${documentType}_${Date.now()}.${fileExtension}`
          const { error: uploadError } = await supabaseServiceClient.storage
            .from('documents')
            .upload(fileName, buffer, {
              contentType: file.type || 'application/octet-stream',
              cacheControl: '3600',
              upsert: false
            })
          if (uploadError) {
            console.error(`[API] Erreur upload document ${documentType}:`, uploadError)
            documentUploadFailed = true
            documentFailureReason = `upload_failed_${documentType}`
            break
          }
          uploadedFiles.push(fileName)
          console.log(`[API] Document ${documentType} uploadé avec succès:`, fileName)

          const uploadedBy = isUuid(user?.id) ? (user?.id as string) : null
          console.log(`[API] Insertion document ${documentType} en base avec uploaded_by:`, uploadedBy ? 'UUID valide' : 'NULL')
          const { error: insertError } = await supabaseServiceClient
            .from('documents')
            .insert({
              dossier_id: dossierId,
              document_name: file.name,
              document_type: documentType,
              file_size: file.size,
              mime_type: file.type,
              storage_path: fileName,
              storage_bucket: 'documents',
              uploaded_by: uploadedBy
            })
          if (insertError) {
            console.error(`[API] Erreur insertion document ${documentType} en base:`, insertError)
            documentUploadFailed = true
            documentFailureReason = `db_insert_failed_${documentType}`
            break
          }

          // Activité document uploaded
          const targetUserId = dossierData.createdByAdmin ? (dossierData as any).apporteurId || user?.id : user?.id
          await supabaseServiceClient
            .from('activities')
            .insert({
              user_id: targetUserId,
              dossier_id: dossierId,
              activity_type: 'document_uploaded',
              activity_title: 'Document uploadé',
              activity_description: `Le document ${documentType} a été uploadé pour le dossier ${numeroDossier}.`,
              activity_data: {
                dossier_numero: numeroDossier,
                document_type: documentType,
                document_name: file.name,
                file_size: file.size,
                action: 'document_uploaded'
              }
            })
        } catch (error) {
          console.error(`[API] Erreur upload ${documentType}:`, error)
          documentUploadFailed = true
          documentFailureReason = `exception_${documentType}`
          break
        }
      }
    }

    if (documentUploadFailed) {
      console.warn('[API] Échec d\'upload de documents — rollback du dossier')
      // Supprimer fichiers déjà uploadés
      if (uploadedFiles.length > 0) {
        try {
          const { error: rmErr } = await supabaseServiceClient.storage
            .from('documents')
            .remove(uploadedFiles)
          if (rmErr) console.warn('[API] Erreur lors du cleanup Storage:', rmErr)
        } catch (e) {
          console.warn('[API] Exception cleanup Storage:', e)
        }
      }
      // Cleanup DB: documents, client_infos, dossier
      try { await supabaseServiceClient.from('documents').delete().eq('dossier_id', dossierId) } catch {}
      try { await supabaseServiceClient.from('client_infos').delete().eq('dossier_id', dossierId) } catch {}
      try { await supabaseServiceClient.from('dossiers').delete().eq('id', dossierId) } catch {}
      return NextResponse.json({ error: 'Upload des documents incomplet', reason: documentFailureReason }, { status: 400 })
    }

    // Si un devis est sélectionné (admin), l'enregistrer
    if ((dossierData as any).devisSelectionne && dossierData.createdByAdmin) {
      // TODO: Créer le devis sélectionné en base
      // Pour l'instant, on peut juste marquer qu'un devis est sélectionné
    }

    // Créer une activité
    try {
      console.log('[API] Création de l\'activité...')
      const targetUserId = dossierData.createdByAdmin ? (dossierData as any).apporteurId || user?.id : user?.id
      
      await supabaseClient
        .from('activities')
        .insert({
          user_id: targetUserId,
          dossier_id: dossierId,
          activity_type: 'dossier_created',
          activity_title: dossierData.createdByAdmin ? 'Dossier assigné' : 'Nouveau dossier créé',
          activity_description: dossierData.createdByAdmin 
            ? `Un nouveau dossier ${numeroDossier} vous a été assigné par l'administrateur.`
            : `Vous avez créé un nouveau dossier ${numeroDossier}.`,
          activity_data: {
            dossier_numero: numeroDossier,
            dossier_type: dossierData.type,
            created_by_admin: dossierData.createdByAdmin || false,
            action: 'dossier_created'
          }
        })
      console.log('[API] Activité créée avec succès')
    } catch (error) {
      console.warn('[API] Erreur non critique avec activité:', error)
    }

    // Créer une notification
    try {
      console.log('[API] Création de la notification...')
      await supabaseClient
        .from('notifications')
        .insert({
          title: dossierData.createdByAdmin ? 'Nouveau dossier assigné' : 'Nouveau dossier créé',
          message: dossierData.createdByAdmin 
            ? `Un nouveau dossier ${numeroDossier} vous a été assigné.`
            : `Votre dossier ${numeroDossier} a été créé avec succès et est en cours de traitement.`,
          type: 'info',
          user_id: dossierData.createdByAdmin ? (dossierData as any).apporteurId || user?.id : user?.id,
          data: { dossier_id: dossierId }
        })
      console.log('[API] Notification créée avec succès')
    } catch (error) {
      console.warn('[API] Erreur non critique avec notification:', error)
    }

    return NextResponse.json({
      success: true,
      dossier: {
        id: dossierId,
        numeroDossier: numeroDossier,
        statut: dossierData.createdByAdmin ? 'nouveau' : 'en_attente',
        commentaire: dossierData.commentaire
      }
    })

  } catch (error) {
    console.error('[API] Erreur création dossier:', error)
    console.error('[API] Stack trace:', error instanceof Error ? error.stack : 'No stack')
    return NextResponse.json(
      {
        error: error instanceof Error ? error.message : 'Erreur interne',
        details: error instanceof Error ? error.stack : undefined
      },
      { status: 400 }
    )
  }
}

================
File: app/api/exade/tarifs/route.ts
================
import { NextResponse } from 'next/server'
import { getExadeTarifs } from '@/lib/services/exade'

export async function POST(req: Request) {
  try {
    const body = await req.json()

    // Mapping des données reçues du frontend vers la structure attendue par le service Exade
    // Le frontend envoie { clientInfo, pretData }
    const { clientInfo, pretData } = body

    if (!clientInfo || !pretData) {
      return NextResponse.json(
        { error: 'Données manquantes (clientInfo ou pretData)' },
        { status: 400 }
      )
    }

    // Construction du payload pour le service
    // On mappe clientInfo vers assure et pretData vers pret

    // Si c'est un couple, construire l'objet conjoint à partir des champs conjoint_*
    let conjoint = null
    if (clientInfo.is_couple && clientInfo.conjoint_nom && clientInfo.conjoint_prenom) {
      conjoint = {
        nom: clientInfo.conjoint_nom,
        prenom: clientInfo.conjoint_prenom,
        client_date_naissance: clientInfo.conjoint_date_naissance,
        client_fumeur: clientInfo.conjoint_fumeur || false,
        client_categorie_professionnelle: clientInfo.conjoint_categorie_professionnelle || 1,
        client_profession: clientInfo.conjoint_profession || '',
      }
    }

    const payload = {
      assure: {
        ...clientInfo,
        conjoint: conjoint
      },
      pret: pretData,
      garanties: {
        code: 2, // Par défaut DC/PTIA/ITT/IPT
        quotite: 100 // Par défaut 100%
      }
    }

    console.log('[API] Appel Exade avec payload:', JSON.stringify(payload, null, 2))

    const tarifs = await getExadeTarifs(payload)

    return NextResponse.json({ tarifs })
  } catch (error: any) {
    console.error('[API] Erreur Exade:', error)

    // Gestion fine des erreurs
    if (error.message.includes('EXADE_CONFIG')) {
      return NextResponse.json(
        { error: 'Configuration Exade manquante' },
        { status: 500 }
      )
    }

    return NextResponse.json(
      { error: error.message || 'Erreur lors de la récupération des tarifs' },
      { status: 502 }
    )
  }
}

================
File: app/api/extraction/extract/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import { DocumentExtractionService } from '@/lib/services/document-extraction'

export const runtime = 'nodejs'

export async function POST(request: NextRequest) {
  try {
    const { dossierId } = await request.json()
    
    if (!dossierId) {
      return NextResponse.json(
        { error: 'dossierId requis' },
        { status: 400 }
      )
    }

    console.log('[API] POST /api/extraction/extract - Début')
    console.log('[API] Variables OpenRouter:', {
      apiKey: process.env.OPENROUTER_API_KEY ? '✅ Définie' : '❌ Non définie',
      model: process.env.OPENROUTER_MODEL || '❌ Non défini'
    })

    // Vérifier que les variables d'environnement sont configurées
    if (!process.env.OPENROUTER_API_KEY) {
      return NextResponse.json(
        { error: 'OPENROUTER_API_KEY non configurée' },
        { status: 500 }
      )
    }

    if (!process.env.OPENROUTER_MODEL) {
      return NextResponse.json(
        { error: 'OPENROUTER_MODEL non configuré' },
        { status: 500 }
      )
    }

    // Appel au service d'extraction avec les variables d'environnement
    console.log('[API] Appel au service d\'extraction...')
    const extractedData = await DocumentExtractionService.extractFromDossier(dossierId, {
      apiKey: process.env.OPENROUTER_API_KEY,
      model: process.env.OPENROUTER_MODEL
    })

    console.log('[API] Résultat extraction:', extractedData ? 'Succès' : 'Échec')

    if (!extractedData) {
      console.log('[API] ❌ Aucune donnée extraite')
      return NextResponse.json(
        { error: 'Échec de l\'extraction des documents' },
        { status: 500 }
      )
    }

    // Sauvegarder les données extraites
    console.log('[API] Sauvegarde des données extraites...')
    const saveSuccess = await DocumentExtractionService.saveExtractedData(dossierId, extractedData)
    console.log('[API] Sauvegarde:', saveSuccess ? 'Succès' : 'Échec')

    return NextResponse.json({
      success: true,
      data: extractedData,
      saved: saveSuccess,
      message: 'Extraction réussie'
    })

  } catch (error: any) {
    console.error('[API] Erreur extraction:', error)
    
    return NextResponse.json(
      { 
        error: error.message || 'Erreur lors de l\'extraction',
        success: false 
      },
      { status: 500 }
    )
  }
}

================
File: app/api/pdf/generate/route.ts
================
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@supabase/supabase-js'

export async function POST(req: NextRequest) {
  try {
    const supabaseClient = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    )

    const { data: { user }, error: userError } = await supabaseClient.auth.getUser()
    if (userError || !user) {
      return NextResponse.json({ error: 'Non authentifié' }, { status: 401 })
    }

    const { dossierId, devisId } = await req.json()
    if (!dossierId || !devisId) {
      return NextResponse.json({ error: 'Paramètres manquants' }, { status: 400 })
    }

    const { data: dossierData, error: dossierError } = await supabaseClient
      .from('dossiers')
      .select(`
        *,
        client_info:client_infos(*),
        devis:devis(*)
      `)
      .eq('id', dossierId)
      .single()

    if (dossierError || !dossierData) {
      return NextResponse.json({ error: 'Dossier non trouvé' }, { status: 404 })
    }

    // HTML simple de démonstration (remplacer par moteur PDF réel en prod)
    const htmlContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Devis ${dossierData.numero_dossier}</title></head><body><h1>Devis ${dossierData.numero_dossier}</h1></body></html>`
    const pdfFileName = `devis_${dossierData.numero_dossier}_${Date.now()}.pdf`

    // Simuler sauvegarde (à remplacer par upload Storage + URL signée)
    await supabaseClient
      .from('devis')
      .update({ pdf_url: `/storage/pdfs/${pdfFileName}`, updated_at: new Date().toISOString() })
      .eq('id', devisId)

    return NextResponse.json({ success: true, pdfUrl: `/storage/pdfs/${pdfFileName}`, htmlContent })
  } catch (error: any) {
    console.error('[API] /api/pdf/generate error', error)
    return NextResponse.json({ error: error?.message || 'Erreur génération PDF' }, { status: 400 })
  }
}

================
File: app/connexion/page.tsx
================
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useSearchParams } from 'next/navigation';
import { supabase } from '../../lib/supabase';
import { useRouter } from 'next/navigation';
import { api } from '@/services/api';

type UserType = 'courtier' | 'apporteur' | null;

// Wrapper component to handle useSearchParams with Suspense
function ConnexionContent() {
  // Mode selection
  const [userType, setUserType] = useState<UserType>(null);
  const [isLogin, setIsLogin] = useState(true);
  
  // Common fields
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [nom, setNom] = useState('');
  const [prenom, setPrenom] = useState('');
  const [telephone, setTelephone] = useState('');
  
  // Courtier-specific fields
  const [nomCabinet, setNomCabinet] = useState('');
  const [numeroOrias, setNumeroOrias] = useState('');
  const [numeroSiret, setNumeroSiret] = useState('');
  
  // State
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [resetEmail, setResetEmail] = useState('');
  const [showResetForm, setShowResetForm] = useState(false);
  const [resetMessage, setResetMessage] = useState('');
  const [darkMode, setDarkMode] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);

  const router = useRouter();
  const searchParams = useSearchParams();
  
  // Check for invite token in URL
  const inviteToken = searchParams.get('invite');
  const redirectPath = searchParams.get('redirect');

  // Auto-select apporteur mode if coming from invite link
  useEffect(() => {
    if (inviteToken || redirectPath?.includes('/invite/')) {
      setUserType('apporteur');
    }
  }, [inviteToken, redirectPath]);

  useEffect(() => {
    if (typeof window !== 'undefined' && !isInitialized) {
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      setDarkMode(savedDarkMode);
      
      if (savedDarkMode) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      
      setIsInitialized(true);
    }
  }, [isInitialized]);

  const handleDarkModeToggle = () => {
    const newDarkMode = !darkMode;
    setDarkMode(newDarkMode);
    
    if (typeof window !== 'undefined') {
      if (newDarkMode) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('darkMode', 'true');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('darkMode', 'false');
      }
    }
  };

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (error) throw error;

      // If there's a redirect path (e.g., from invite), go there first
      if (redirectPath) {
        router.push(redirectPath);
        return;
      }

      // Check if user is a broker_user
      const { data: brokerUser } = await supabase
        .from('broker_users')
        .select('id')
        .eq('user_id', data.user.id)
        .single();

      if (brokerUser) {
        // User is a courtier, redirect to admin
        router.push('/admin');
        return;
      }

      // Check if user is an apporteur
      const { data: profile } = await supabase
        .from('apporteur_profiles')
        .select('cgu_accepted_at')
        .eq('user_id', data.user.id)
        .single();

      if (profile && !profile.cgu_accepted_at) {
        router.push('/onboarding');
      } else if (profile?.cgu_accepted_at) {
        router.push('/');
      } else {
        // User exists but has no profile - edge case
        router.push('/');
      }
    } catch (error: any) {
      setError(error.message === 'Invalid login credentials' 
        ? 'Email ou mot de passe incorrect' 
        : error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleResetPassword = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const { error } = await supabase.auth.resetPasswordForEmail(resetEmail, {
        redirectTo: `${window.location.origin}/reset-password`,
      });

      if (error) throw error;

      setResetMessage('Un email de réinitialisation a été envoyé à votre adresse');
      setShowResetForm(false);
    } catch (error: any) {
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleSignupCourtier = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    if (password !== confirmPassword) {
      setError('Les mots de passe ne correspondent pas');
      setLoading(false);
      return;
    }

    if (password.length < 6) {
      setError('Le mot de passe doit contenir au moins 6 caractères');
      setLoading(false);
      return;
    }

    if (!nomCabinet.trim()) {
      setError('Le nom du cabinet est obligatoire');
      setLoading(false);
      return;
    }

    if (!numeroOrias.trim()) {
      setError('Le numéro ORIAS est obligatoire');
      setLoading(false);
      return;
    }

    try {
      // 1. Create Supabase auth user
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            nom,
            prenom,
            telephone,
            user_type: 'courtier',
            numero_orias: numeroOrias,
            numero_siret: numeroSiret,
          }
        }
      });

      if (authError) throw authError;

      if (!authData.user) {
        throw new Error('Erreur lors de la création du compte');
      }

      // 2. Create broker via RPC (this also creates broker_users link and wallet)
      const { data: brokerResult, error: brokerError } = await supabase.rpc('create_broker_for_current_user', {
        p_broker_name: nomCabinet,
        p_orias_number: numeroOrias,
        p_siret_number: numeroSiret || null
      });

      if (brokerError) {
        console.error('Error creating broker:', brokerError);
        // Even if broker creation fails, user is created - they can retry later
        throw new Error('Compte créé mais erreur lors de la création du cabinet. Contactez le support.');
      }

      // 3. Redirect to admin onboarding
      router.push('/admin/onboarding');
      
    } catch (error: any) {
      console.error('Signup error:', error);
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleSignupApporteur = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    // Apporteur MUST have an invite token
    const tokenToUse = inviteToken || (redirectPath?.includes('/invite/') ? redirectPath.split('/invite/')[1] : null);
    
    if (!tokenToUse) {
      setError('Vous devez avoir reçu un lien d\'invitation de votre courtier pour créer un compte apporteur.');
      setLoading(false);
      return;
    }

    if (password !== confirmPassword) {
      setError('Les mots de passe ne correspondent pas');
      setLoading(false);
      return;
    }

    if (password.length < 6) {
      setError('Le mot de passe doit contenir au moins 6 caractères');
      setLoading(false);
      return;
    }

    try {
      // 1. Validate invite first
      const validation = await api.validateBrokerInvite(tokenToUse);
      if (!validation.is_valid) {
        throw new Error(validation.reason || 'Lien d\'invitation invalide ou expiré');
      }

      // 2. Create Supabase auth user
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            nom,
            prenom,
            telephone,
            user_type: 'apporteur'
          }
        }
      });

      if (authError) throw authError;

      if (!authData.user) {
        throw new Error('Erreur lors de la création du compte');
      }

      // 3. Create apporteur profile
      const { error: profileError } = await supabase
        .from('apporteur_profiles')
        .insert({
          user_id: authData.user.id,
          nom,
          prenom,
          email,
          telephone,
          statut: 'actif'
        });

      if (profileError) throw profileError;

      // 4. Consume the invite to link apporteur to broker
      const consumeResult = await api.consumeBrokerInvite(tokenToUse);
      if (!consumeResult.success) {
        console.error('Failed to consume invite:', consumeResult.error);
        // Profile created but not linked - they'll need to use invite link again
      }

      // 5. Redirect to onboarding (CGU)
      router.push('/onboarding');
      
    } catch (error: any) {
      console.error('Signup error:', error);
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  // User type selection screen
  if (!userType && !isLogin) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
        <Header darkMode={darkMode} onToggleDarkMode={handleDarkModeToggle} />
        
        <div className="bg-white dark:bg-gray-800">
          <div className="px-4 sm:px-8 py-8 sm:py-12 max-w-7xl mx-auto">
            <div className="text-center">
              <h1 className="text-3xl sm:text-4xl lg:text-5xl font-light text-gray-900 dark:text-white mb-4">
                <span className="font-medium text-[#335FAD] dark:text-[#335FAD]/80">Créer</span> votre compte
              </h1>
              <p className="text-lg text-gray-600 dark:text-gray-400">
                Choisissez votre type de compte
              </p>
            </div>
          </div>
        </div>

        <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-4xl mx-auto">
          <div className="grid md:grid-cols-2 gap-6">
            {/* Courtier Card */}
            <button
              onClick={() => setUserType('courtier')}
              className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border-2 border-gray-200 dark:border-gray-700 p-8 text-left hover:border-[#335FAD] dark:hover:border-[#335FAD] transition-all group"
            >
              <div className="w-16 h-16 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-[#335FAD]/20 transition-colors">
                <i className="ri-building-2-line text-[#335FAD] text-3xl"></i>
              </div>
              <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-3">
                Je suis Courtier
              </h2>
              <p className="text-gray-600 dark:text-gray-400 text-sm mb-4">
                Créez votre cabinet de courtage et gérez vos apporteurs d'affaires.
              </p>
              <ul className="space-y-2 text-sm text-gray-500 dark:text-gray-400">
                <li className="flex items-center">
                  <i className="ri-check-line text-green-500 mr-2"></i>
                  Gestion des dossiers clients
                </li>
                <li className="flex items-center">
                  <i className="ri-check-line text-green-500 mr-2"></i>
                  Intégration API Exade
                </li>
                <li className="flex items-center">
                  <i className="ri-check-line text-green-500 mr-2"></i>
                  Inviter des apporteurs
                </li>
              </ul>
              <div className="mt-6 flex items-center text-[#335FAD] font-medium">
                <span>Créer mon cabinet</span>
                <i className="ri-arrow-right-line ml-2"></i>
              </div>
            </button>

            {/* Apporteur Card */}
            <div
              className={`bg-white dark:bg-gray-800 rounded-2xl shadow-sm border-2 p-8 text-left transition-all ${
                inviteToken || redirectPath?.includes('/invite/')
                  ? 'border-[#335FAD] dark:border-[#335FAD]'
                  : 'border-gray-200 dark:border-gray-700'
              }`}
            >
              <div className="w-16 h-16 bg-emerald-100 dark:bg-emerald-900/20 rounded-2xl flex items-center justify-center mb-6">
                <i className="ri-user-star-line text-emerald-600 dark:text-emerald-400 text-3xl"></i>
              </div>
              <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-3">
                Je suis Apporteur
              </h2>
              <p className="text-gray-600 dark:text-gray-400 text-sm mb-4">
                Envoyez des dossiers à votre courtier et suivez vos commissions.
              </p>
              
              {inviteToken || redirectPath?.includes('/invite/') ? (
                <>
                  <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-xl p-4 mb-4">
                    <div className="flex items-center text-green-700 dark:text-green-400 text-sm">
                      <i className="ri-checkbox-circle-line mr-2"></i>
                      <span>Invitation détectée</span>
                    </div>
                  </div>
                  <button
                    onClick={() => setUserType('apporteur')}
                    className="w-full mt-2 flex items-center justify-center text-[#335FAD] font-medium bg-[#335FAD]/10 hover:bg-[#335FAD]/20 py-3 rounded-xl transition-colors"
                  >
                    <span>Créer mon compte apporteur</span>
                    <i className="ri-arrow-right-line ml-2"></i>
                  </button>
                </>
              ) : (
                <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-xl p-4">
                  <div className="flex items-start">
                    <i className="ri-information-line text-amber-600 dark:text-amber-400 mr-3 mt-0.5"></i>
                    <div className="text-sm text-amber-700 dark:text-amber-300">
                      <p className="font-medium mb-1">Invitation requise</p>
                      <p>Pour créer un compte apporteur, vous devez avoir reçu un lien d'invitation de votre courtier.</p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Back to login */}
          <div className="text-center mt-8">
            <button
              onClick={() => setIsLogin(true)}
              className="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white text-sm transition-colors"
            >
              <i className="ri-arrow-left-line mr-2"></i>
              Déjà un compte ? Se connecter
            </button>
          </div>
        </main>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      <Header darkMode={darkMode} onToggleDarkMode={handleDarkModeToggle} />

      <div className="bg-white dark:bg-gray-800">
        <div className="px-4 sm:px-8 py-8 sm:py-12 max-w-7xl mx-auto">
          <div className="text-center">
            <h1 className="text-3xl sm:text-4xl lg:text-5xl font-light text-gray-900 dark:text-white mb-4">
              <span className="font-medium text-[#335FAD] dark:text-[#335FAD]/80">
                {isLogin ? 'Accédez' : userType === 'courtier' ? 'Créez votre cabinet' : 'Rejoignez'}
              </span> {isLogin ? 'à votre espace' : userType === 'courtier' ? 'de courtage' : 'votre courtier'}
            </h1>
            <p className="text-lg text-gray-600 dark:text-gray-400">
              {isLogin 
                ? 'Connectez-vous à votre compte' 
                : userType === 'courtier' 
                  ? 'Renseignez les informations de votre cabinet'
                  : 'Créez votre compte apporteur'
              }
            </p>
          </div>
        </div>
      </div>

      <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-2xl mx-auto">
        <div className="bg-white dark:bg-gray-800 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 sm:p-8">
          
          {!showResetForm ? (
            <>
              {/* Tab Switcher - Only show for login mode or when userType is selected */}
              {(isLogin || userType) && (
                <div className="flex justify-center mb-8">
                  <div className="flex bg-gray-100 dark:bg-gray-700 rounded-2xl p-1.5 border border-gray-200 dark:border-gray-600">
                    <button
                      type="button"
                      onClick={() => { setIsLogin(true); setUserType(null); }}
                      className={`px-6 py-3 text-sm font-medium rounded-xl transition-all duration-300 whitespace-nowrap ${
                        isLogin 
                          ? 'bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow border border-gray-200 dark:border-gray-600' 
                          : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
                      }`}
                    >
                      <i className="ri-login-box-line mr-2"></i>
                      Connexion
                    </button>
                    <button
                      type="button"
                      onClick={() => setIsLogin(false)}
                      className={`px-6 py-3 text-sm font-medium rounded-xl transition-all duration-300 whitespace-nowrap ${
                        !isLogin 
                          ? 'bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow border border-gray-200 dark:border-gray-600' 
                          : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
                      }`}
                    >
                      <i className="ri-user-add-line mr-2"></i>
                      Inscription
                    </button>
                  </div>
                </div>
              )}

              {/* User type indicator for signup */}
              {!isLogin && userType && (
                <div className="flex items-center justify-between mb-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                  <div className="flex items-center">
                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center mr-3 ${
                      userType === 'courtier' 
                        ? 'bg-[#335FAD]/10 dark:bg-[#335FAD]/20' 
                        : 'bg-emerald-100 dark:bg-emerald-900/20'
                    }`}>
                      <i className={`text-xl ${
                        userType === 'courtier' 
                          ? 'ri-building-2-line text-[#335FAD]' 
                          : 'ri-user-star-line text-emerald-600 dark:text-emerald-400'
                      }`}></i>
                    </div>
                    <div>
                      <p className="font-medium text-gray-900 dark:text-white text-sm">
                        {userType === 'courtier' ? 'Compte Courtier' : 'Compte Apporteur'}
                      </p>
                      <p className="text-xs text-gray-500 dark:text-gray-400">
                        {userType === 'courtier' ? 'Créez votre cabinet' : 'Rejoignez un cabinet'}
                      </p>
                    </div>
                  </div>
                  <button
                    type="button"
                    onClick={() => setUserType(null)}
                    className="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                  >
                    Changer
                  </button>
                </div>
              )}

              {/* Status Messages */}
              {error && (
                <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-xl">
                  <div className="flex items-center">
                    <i className="ri-error-warning-line text-red-600 dark:text-red-400 mr-3"></i>
                    <p className="text-red-700 dark:text-red-400 text-sm">{error}</p>
                  </div>
                </div>
              )}

              {resetMessage && (
                <div className="mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-xl">
                  <div className="flex items-center">
                    <i className="ri-check-line text-green-600 dark:text-green-400 mr-3"></i>
                    <p className="text-green-700 dark:text-green-400 text-sm">{resetMessage}</p>
                  </div>
                </div>
              )}

              {/* Form */}
              <form 
                onSubmit={isLogin ? handleLogin : userType === 'courtier' ? handleSignupCourtier : handleSignupApporteur} 
                className="space-y-6"
              >
                {/* Signup fields */}
                {!isLogin && (
                  <>
                    {/* Courtier-specific: Cabinet info */}
                    {userType === 'courtier' && (
                      <div className="space-y-4 pb-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 className="text-sm font-medium text-gray-900 dark:text-white flex items-center">
                          <i className="ri-building-2-line mr-2 text-[#335FAD]"></i>
                          Informations du cabinet
                        </h3>
                        
                        <div>
                          <label htmlFor="nomCabinet" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Nom du cabinet *
                          </label>
                          <input
                            id="nomCabinet"
                            type="text"
                            required
                            value={nomCabinet}
                            onChange={(e) => setNomCabinet(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 focus:border-transparent text-sm transition-colors"
                            placeholder="Ex: Cabinet Dupont Courtage"
                          />
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                            <label htmlFor="numeroOrias" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                              Numéro ORIAS *
                            </label>
                            <input
                              id="numeroOrias"
                              type="text"
                              required
                              value={numeroOrias}
                              onChange={(e) => setNumeroOrias(e.target.value)}
                              className="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 focus:border-transparent text-sm transition-colors"
                              placeholder="Ex: 12345678"
                            />
                          </div>
                          <div>
                            <label htmlFor="numeroSiret" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                              Numéro SIRET
                            </label>
                            <input
                              id="numeroSiret"
                              type="text"
                              value={numeroSiret}
                              onChange={(e) => setNumeroSiret(e.target.value)}
                              className="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 focus:border-transparent text-sm transition-colors"
                              placeholder="Ex: 12345678901234"
                            />
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Personal info */}
                    <div className="space-y-4">
                      {userType === 'courtier' && (
                        <h3 className="text-sm font-medium text-gray-900 dark:text-white flex items-center">
                          <i className="ri-user-line mr-2 text-[#335FAD]"></i>
                          Vos informations
                        </h3>
                      )}
                      
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label htmlFor="nom" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Nom *
                          </label>
                          <input
                            id="nom"
                            type="text"
                            required
                            value={nom}
                            onChange={(e) => setNom(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 focus:border-transparent text-sm transition-colors"
                            placeholder="Votre nom"
                          />
                        </div>
                        <div>
                          <label htmlFor="prenom" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Prénom *
                          </label>
                          <input
                            id="prenom"
                            type="text"
                            required
                            value={prenom}
                            onChange={(e) => setPrenom(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 focus:border-transparent text-sm transition-colors"
                            placeholder="Votre prénom"
                          />
                        </div>
                      </div>

                      <div>
                        <label htmlFor="telephone" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                          Téléphone *
                        </label>
                        <div className="relative">
                          <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <i className="ri-phone-line text-gray-400 dark:text-gray-500 text-sm"></i>
                          </div>
                          <input
                            id="telephone"
                            type="tel"
                            required
                            value={telephone}
                            onChange={(e) => setTelephone(e.target.value)}
                            className="w-full pl-12 pr-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 focus:border-transparent text-sm transition-colors"
                            placeholder="06 12 34 56 78"
                          />
                        </div>
                      </div>
                    </div>
                  </>
                )}

                {/* Email */}
                <div>
                  <label htmlFor="email" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Email *
                  </label>
                  <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                      <i className="ri-mail-line text-gray-400 dark:text-gray-500 text-sm"></i>
                    </div>
                    <input
                      id="email"
                      type="email"
                      autoComplete="email"
                      required
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      className="w-full pl-12 pr-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 focus:border-transparent text-sm transition-colors"
                      placeholder="votre@email.com"
                    />
                  </div>
                </div>

                {/* Password */}
                <div>
                  <label htmlFor="password" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Mot de passe *
                  </label>
                  <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                      <i className="ri-lock-line text-gray-400 dark:text-gray-500 text-sm"></i>
                    </div>
                    <input
                      id="password"
                      type="password"
                      autoComplete={isLogin ? "current-password" : "new-password"}
                      required
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      className="w-full pl-12 pr-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 focus:border-transparent text-sm transition-colors"
                      placeholder={isLogin ? "Votre mot de passe" : "Minimum 6 caractères"}
                    />
                  </div>
                </div>

                {/* Confirm password for signup */}
                {!isLogin && (
                  <div>
                    <label htmlFor="confirmPassword" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      Confirmer le mot de passe *
                    </label>
                    <div className="relative">
                      <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i className="ri-lock-line text-gray-400 dark:text-gray-500 text-sm"></i>
                      </div>
                      <input
                        id="confirmPassword"
                        type="password"
                        autoComplete="new-password"
                        required
                        value={confirmPassword}
                        onChange={(e) => setConfirmPassword(e.target.value)}
                        className="w-full pl-12 pr-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 focus:border-transparent text-sm transition-colors"
                        placeholder="Confirmez votre mot de passe"
                      />
                    </div>
                  </div>
                )}

                {/* Forgot password link */}
                {isLogin && (
                  <div className="flex items-center justify-end">
                    <button
                      type="button"
                      onClick={() => setShowResetForm(true)}
                      className="text-sm text-[#335FAD] dark:text-[#335FAD]/80 hover:text-[#335FAD]/70 dark:hover:text-[#335FAD]/90 transition-colors cursor-pointer"
                    >
                      <i className="ri-key-line mr-1"></i>
                      Mot de passe oublié ?
                    </button>
                  </div>
                )}

                {/* Info boxes */}
                {!isLogin && userType === 'courtier' && (
                  <div className="bg-[#335FAD]/5 dark:bg-[#335FAD]/10 rounded-xl p-4 border border-[#335FAD]/20 dark:border-[#335FAD]/30">
                    <div className="flex items-start space-x-3">
                      <div className="w-8 h-8 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i className="ri-shield-check-line text-[#335FAD] dark:text-[#335FAD]/80 text-sm"></i>
                      </div>
                      <div>
                        <p className="text-sm text-[#335FAD] dark:text-[#335FAD]/80 font-medium mb-1">
                          Création de cabinet sécurisée
                        </p>
                        <p className="text-xs text-[#335FAD] dark:text-[#335FAD]/80">
                          Votre numéro ORIAS sera vérifié. Après inscription, vous pourrez configurer votre intégration Exade.
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {!isLogin && userType === 'apporteur' && (
                  <div className="bg-emerald-50 dark:bg-emerald-900/20 rounded-xl p-4 border border-emerald-200 dark:border-emerald-700">
                    <div className="flex items-start space-x-3">
                      <div className="w-8 h-8 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i className="ri-user-star-line text-emerald-600 dark:text-emerald-400 text-sm"></i>
                      </div>
                      <div>
                        <p className="text-sm text-emerald-700 dark:text-emerald-300 font-medium mb-1">
                          Compte apporteur
                        </p>
                        <p className="text-xs text-emerald-600 dark:text-emerald-400">
                          Vous serez automatiquement rattaché au cabinet qui vous a invité. Après inscription, vous devrez accepter les CGU.
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {/* Submit button */}
                <div>
                  <button
                    type="submit"
                    disabled={loading}
                    className="w-full bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-4 rounded-xl font-medium transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap shadow-sm hover:shadow-md flex items-center justify-center space-x-2"
                  >
                    {loading ? (
                      <>
                        <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        <span>Chargement...</span>
                      </>
                    ) : (
                      <>
                        <i className={`${isLogin ? 'ri-login-box-line' : userType === 'courtier' ? 'ri-building-2-line' : 'ri-user-add-line'}`}></i>
                        <span>
                          {isLogin 
                            ? 'Se connecter' 
                            : userType === 'courtier' 
                              ? 'Créer mon cabinet' 
                              : 'Créer mon compte'
                          }
                        </span>
                      </>
                    )}
                  </button>
                </div>
              </form>
            </>
          ) : (
            <>
              {/* Reset Password Form */}
              <div className="mb-6">
                <button
                  onClick={() => setShowResetForm(false)}
                  className="flex items-center text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors cursor-pointer"
                >
                  <i className="ri-arrow-left-line mr-2"></i>
                  Retour à la connexion
                </button>
              </div>

              <div className="text-center mb-8">
                <div className="w-16 h-16 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-2xl flex items-center justify-center mx-auto mb-4">
                  <i className="ri-key-line text-[#335FAD] dark:text-[#335FAD]/80 text-2xl"></i>
                </div>
                <h2 className="text-xl font-medium text-gray-900 dark:text-white mb-2">Réinitialiser le mot de passe</h2>
                <p className="text-sm text-gray-600 dark:text-gray-400">
                  Saisissez votre email pour recevoir un lien de réinitialisation
                </p>
              </div>

              {error && (
                <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-xl">
                  <div className="flex items-center">
                    <i className="ri-error-warning-line text-red-600 dark:text-red-400 mr-3"></i>
                    <p className="text-red-700 dark:text-red-400 text-sm">{error}</p>
                  </div>
                </div>
              )}

              <form onSubmit={handleResetPassword} className="space-y-6">
                <div>
                  <label htmlFor="resetEmail" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Adresse email
                  </label>
                  <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                      <i className="ri-mail-line text-gray-400 dark:text-gray-500 text-sm"></i>
                    </div>
                    <input
                      id="resetEmail"
                      type="email"
                      required
                      value={resetEmail}
                      onChange={(e) => setResetEmail(e.target.value)}
                      className="w-full pl-12 pr-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 focus:border-transparent text-sm transition-colors"
                      placeholder="votre@email.com"
                    />
                  </div>
                </div>

                <button
                  type="submit"
                  disabled={loading}
                  className="w-full bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-4 rounded-xl font-medium transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap shadow-sm hover:shadow-md flex items-center justify-center space-x-2"
                >
                  {loading ? (
                    <>
                      <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                      <span>Envoi en cours...</span>
                    </>
                  ) : (
                    <>
                      <i className="ri-mail-send-line"></i>
                      <span>Envoyer le lien de réinitialisation</span>
                    </>
                  )}
                </button>
              </form>
            </>
          )}
        </div>
      </main>
    </div>
  );
}

// Header component extracted for reuse
function Header({ darkMode, onToggleDarkMode }: { darkMode: boolean; onToggleDarkMode: () => void }) {
  return (
    <header className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50 transition-colors duration-300">
      <div className="px-4 sm:px-8 py-4 sm:py-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-4">
            <div className="w-10 h-10 sm:w-12 sm:h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-xl flex items-center justify-center">
              <i className="ri-handshake-line text-[#335FAD] dark:text-[#335FAD]/80 text-lg sm:text-xl"></i>
            </div>
            <div>
              <h1 className="font-['Pacifico'] text-lg sm:text-xl text-gray-900 dark:text-white">GMB Courtage</h1>
              <p className="text-xs text-gray-500 dark:text-gray-400 font-normal">Plateforme Courtiers & Apporteurs</p>
            </div>
          </div>

          <button 
            onClick={onToggleDarkMode}
            className="w-10 h-10 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 border border-gray-200 dark:border-gray-600 rounded-lg flex items-center justify-center transition-colors cursor-pointer"
          >
            <i className={`${darkMode ? 'ri-sun-line' : 'ri-moon-line'} text-gray-600 dark:text-gray-300 text-sm`}></i>
          </button>
        </div>
      </div>
    </header>
  );
}

// Main page component with Suspense boundary
export default function ConnexionPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#335FAD]"></div>
      </div>
    }>
      <ConnexionContent />
    </Suspense>
  );
}

================
File: app/dossier-confirme/[id]/DossierConfirmeContent.tsx
================
'use client';

import { useRouter } from 'next/navigation';
import { useState, useEffect } from 'react';
import { DossiersService } from '@/lib/services/dossiers';
import { getStatutBadgeConfig, mapStatutForDisplay } from '@/lib/utils/statut-mapping';

// Interface pour les données du dossier
interface DossierData {
  id: string;
  numero_dossier: string;
  statut: string;
  computed_statut?: string;
  created_at: string;
  type_dossier?: string;
  is_couple?: boolean;
  commentaire?: string;
  client_infos?: Array<{
    client_nom: string;
    client_prenom: string;
    client_email: string;
    client_telephone?: string;
    client_date_naissance?: string;
    conjoint_nom?: string;
    conjoint_prenom?: string;
  }>;
  pret_data?: Array<{
    montant_capital: number;
    banque_preteuse: string;
    duree_mois: number;
    type_pret: string;
  }>;
  documents?: Array<{
    id: string;
    document_name: string;
    document_type: string;
    file_size: number;
    created_at: string;
  }>;
  [key: string]: any;
}

interface DossierConfirmeContentProps {
  dossierId: string;
}

export default function DossierConfirmeContent({ dossierId }: DossierConfirmeContentProps) {
  const router = useRouter();
  const [dossier, setDossier] = useState<DossierData | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Fonction pour récupérer les données du dossier depuis Supabase
  const fetchDossierData = async (id: string) => {
    setIsLoading(true);
    setError(null);
    try {
      const dossierData = await DossiersService.getDossierById(id);
      console.log('[DossierConfirme] Données récupérées:', dossierData);
      setDossier(dossierData);
    } catch (error) {
      console.error('[DossierConfirme] Erreur lors du chargement du dossier:', error);
      setError('Le dossier n\'a pas pu être chargé. Veuillez réessayer.');
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    if (dossierId) {
      fetchDossierData(dossierId);
    }
  }, [dossierId]);

  const handleBackToDashboard = () => {
    router.push('/');
  };

  const handleNewDossier = () => {
    router.push('/nouveau-dossier');
  };

  const handleViewDossier = () => {
    router.push(`/dossier/${dossierId}`);
  };

  // ✅ MIGRATION COMPLÈTE - Utilisation de la source de vérité unique depuis lib/utils/statut-mapping.ts

  if (isLoading) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#335FAD]"></div>
      </div>
    );
  }

  if (error || !dossier) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <i className="ri-error-warning-line text-4xl text-red-500 mb-4"></i>
          <h1 className="text-xl font-medium text-gray-900 dark:text-white mb-2">
            {error ? 'Erreur de chargement' : 'Dossier non trouvé'}
          </h1>
          <p className="text-gray-500 dark:text-gray-400 mb-4">
            {error || 'Le dossier demandé n\'existe pas ou n\'est pas accessible.'}
          </p>
          <div className="flex gap-3 justify-center">
            <button
              onClick={() => fetchDossierData(dossierId)}
              className="bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 px-6 py-2 rounded-lg font-medium transition-colors"
            >
              Réessayer
            </button>
            <button
              onClick={handleBackToDashboard}
              className="bg-[#335FAD] hover:bg-[#335FAD]/90 text-white px-6 py-2 rounded-lg font-medium transition-colors"
            >
              Retour au tableau de bord
            </button>
          </div>
        </div>
      </div>
    );
  }

  // ✅ Utiliser computed_statut si disponible (statut canonique), sinon fallback sur statut
  const currentStatut = dossier.computed_statut || dossier.statut || 'en_attente';
  const statutInfo = getStatutBadgeConfig(currentStatut);
  
  // Extraire les informations principales
  const clientInfo = dossier.client_infos && dossier.client_infos.length > 0 ? dossier.client_infos[0] : null;
  const pretInfo = dossier.pret_data && dossier.pret_data.length > 0 ? dossier.pret_data[0] : null;
  const hasDocuments = dossier.documents && dossier.documents.length > 0;
  const isCouple = dossier.is_couple || (clientInfo?.conjoint_nom && clientInfo?.conjoint_prenom);

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      {/* Main Content */}
      <main className="px-4 sm:px-8 py-12 max-w-4xl mx-auto">
        <div className="text-center">
          {/* Success Icon */}
          <div className="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-8">
            <i className="ri-checkbox-circle-line text-green-600 dark:text-green-400 text-4xl"></i>
          </div>

          {/* Title */}
          <h1 className="text-3xl sm:text-4xl font-light text-gray-900 dark:text-white mb-4">
            Dossier créé avec succès !
          </h1>
          
          <p className="text-lg text-gray-500 dark:text-gray-400 mb-8 max-w-2xl mx-auto">
            Votre dossier a été transmis avec succès. Nos équipes GMB Courtage l'étudient actuellement et vous contacteront dans les plus brefs délais.
          </p>

          {/* Dossier Info Card */}
          <div className="bg-white dark:bg-gray-800 rounded-2xl sm:rounded-3xl p-6 sm:p-8 border-2 border-gray-100 dark:border-gray-700 mb-8">
            {/* Header avec numéro de dossier */}
            <div className="flex items-center justify-center mb-6 pb-6 border-b border-gray-100 dark:border-gray-700">
              <div className="w-12 h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 rounded-xl flex items-center justify-center mr-4">
                <i className="ri-file-text-line text-[#335FAD] dark:text-[#335FAD]/80 text-xl"></i>
              </div>
              <div>
                <h3 className="text-sm text-gray-500 dark:text-gray-400">Numéro de dossier</h3>
                <p className="text-2xl font-mono font-bold text-[#335FAD] dark:text-[#335FAD]/80">{dossier.numero_dossier}</p>
              </div>
            </div>
            
            <div className="space-y-4 text-sm">
              {/* Statut */}
              <div className="flex items-center justify-between py-2">
                <span className="text-gray-600 dark:text-gray-400">Statut</span>
                <span className={`px-3 py-1.5 rounded-full font-medium flex items-center ${statutInfo?.color || 'bg-gray-100 text-gray-800'}`}>
                  <i className={`${statutInfo?.icon || 'ri-question-line'} mr-1.5 text-sm`}></i>
                  {statutInfo?.text || 'Inconnu'}
                </span>
              </div>

              {/* Type de dossier */}
              {isCouple && (
                <div className="flex items-center justify-between py-2">
                  <span className="text-gray-600 dark:text-gray-400">Type</span>
                  <span className="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-pink-100 dark:bg-pink-900/30 text-pink-700 dark:text-pink-400 border border-pink-200 dark:border-pink-700">
                    <i className="ri-heart-line mr-1.5"></i>
                    Dossier Couple
                  </span>
                </div>
              )}

              {/* Date de création */}
              <div className="flex items-center justify-between py-2">
                <span className="text-gray-600 dark:text-gray-400">Date de création</span>
                <span className="text-gray-900 dark:text-white font-medium">
                  {new Date(dossier.created_at).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                  })}
                </span>
              </div>

              {/* Informations Client */}
              {clientInfo && (
                <>
                  <div className="pt-4 border-t border-gray-100 dark:border-gray-700">
                    <h4 className="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">
                      Informations Client
                    </h4>
                  </div>
                  
                  <div className="flex items-center justify-between py-2">
                    <span className="text-gray-600 dark:text-gray-400">Nom complet</span>
                    <span className="text-gray-900 dark:text-white font-medium">
                      {clientInfo.client_prenom} {clientInfo.client_nom}
                    </span>
                  </div>

                  {clientInfo.client_email && (
                    <div className="flex items-center justify-between py-2">
                      <span className="text-gray-600 dark:text-gray-400">Email</span>
                      <span className="text-gray-900 dark:text-white font-medium text-right max-w-xs truncate">
                        {clientInfo.client_email}
                      </span>
                    </div>
                  )}

                  {clientInfo.client_telephone && (
                    <div className="flex items-center justify-between py-2">
                      <span className="text-gray-600 dark:text-gray-400">Téléphone</span>
                      <span className="text-gray-900 dark:text-white font-medium">
                        {clientInfo.client_telephone}
                      </span>
                    </div>
                  )}

                  {/* Conjoint si couple */}
                  {isCouple && clientInfo.conjoint_nom && (
                    <div className="flex items-center justify-between py-2">
                      <span className="text-gray-600 dark:text-gray-400">Conjoint</span>
                      <span className="text-gray-900 dark:text-white font-medium">
                        {clientInfo.conjoint_prenom} {clientInfo.conjoint_nom}
                      </span>
                    </div>
                  )}
                </>
              )}

              {/* Informations Prêt */}
              {pretInfo && (
                <>
                  <div className="pt-4 border-t border-gray-100 dark:border-gray-700">
                    <h4 className="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">
                      Informations du Prêt
                    </h4>
                  </div>

                  <div className="flex items-center justify-between py-2">
                    <span className="text-gray-600 dark:text-gray-400">Montant</span>
                    <span className="text-gray-900 dark:text-white font-bold text-lg">
                      {pretInfo.montant_capital.toLocaleString('fr-FR')} €
                    </span>
                  </div>

                  {pretInfo.banque_preteuse && (
                    <div className="flex items-center justify-between py-2">
                      <span className="text-gray-600 dark:text-gray-400">Banque</span>
                      <span className="text-gray-900 dark:text-white font-medium">
                        {pretInfo.banque_preteuse}
                      </span>
                    </div>
                  )}

                  <div className="flex items-center justify-between py-2">
                    <span className="text-gray-600 dark:text-gray-400">Durée</span>
                    <span className="text-gray-900 dark:text-white font-medium">
                      {pretInfo.duree_mois} mois ({Math.round(pretInfo.duree_mois / 12)} ans)
                    </span>
                  </div>

                  {pretInfo.type_pret && (
                    <div className="flex items-center justify-between py-2">
                      <span className="text-gray-600 dark:text-gray-400">Type de prêt</span>
                      <span className="text-gray-900 dark:text-white font-medium">
                        {pretInfo.type_pret}
                      </span>
                    </div>
                  )}
                </>
              )}

              {/* Documents */}
              {hasDocuments && (
                <>
                  <div className="pt-4 border-t border-gray-100 dark:border-gray-700">
                    <h4 className="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">
                      Documents
                    </h4>
                  </div>

                  <div className="flex items-center justify-between py-2">
                    <span className="text-gray-600 dark:text-gray-400">Documents uploadés</span>
                    <span className="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400">
                      <i className="ri-check-line mr-1.5"></i>
                      {dossier.documents!.length} document{dossier.documents!.length > 1 ? 's' : ''}
                    </span>
                  </div>
                </>
              )}

              {/* Statut du traitement */}
              <div className="pt-4 border-t border-gray-100 dark:border-gray-700">
                <div className="bg-[#335FAD]/5 dark:bg-[#335FAD]/10 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-lg p-4">
                  <div className="flex items-start">
                    <div className="w-10 h-10 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                      <i className="ri-team-line text-[#335FAD] dark:text-[#335FAD]/80 text-lg"></i>
                    </div>
                    <div className="flex-1">
                      <h5 className="text-sm font-semibold text-[#335FAD] dark:text-[#335FAD]/90 mb-1">
                        Dossier en cours d'étude
                      </h5>
                      <p className="text-xs text-gray-700 dark:text-gray-400">
                        Nos équipes GMB Courtage analysent votre dossier et recherchent les meilleures solutions d'assurance pour votre prêt. Vous serez contacté prochainement.
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Commentaire */}
              {dossier.commentaire && (
                <>
                  <div className="pt-4 border-t border-gray-100 dark:border-gray-700">
                    <h4 className="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">
                      Commentaire
                    </h4>
                    <p className="text-gray-900 dark:text-white text-sm leading-relaxed">
                      {dossier.commentaire}
                    </p>
                  </div>
                </>
              )}
            </div>
          </div>

          {/* Action Buttons */}
          <div className="flex flex-col sm:flex-row gap-4 justify-center items-center">
            <button
              onClick={handleBackToDashboard}
              className="w-full sm:w-auto bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 px-8 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 border border-gray-200 dark:border-gray-600"
            >
              <i className="ri-dashboard-line"></i>
              <span>Retour au tableau de bord</span>
            </button>
            
            <button
              onClick={handleViewDossier}
              className="w-full sm:w-auto bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 px-8 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 border border-gray-200 dark:border-gray-600"
            >
              <i className="ri-eye-line"></i>
              <span>Voir le dossier</span>
            </button>
            
            <button
              onClick={handleNewDossier}
              className="w-full sm:w-auto bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-8 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 whitespace-nowrap"
            >
              <i className="ri-add-line"></i>
              <span>Créer un autre dossier</span>
            </button>
          </div>

          {/* Contact Info */}
          <div className="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
            <p className="text-gray-500 dark:text-gray-400 text-sm mb-4">
              Une question sur votre dossier ?
            </p>
            <div className="flex flex-col sm:flex-row items-center justify-center gap-4 text-sm">
              <a href="mailto:support@gmbcourtage.fr" className="text-[#335FAD] dark:text-[#335FAD]/80 hover:text-[#335FAD]/70 dark:hover:text-[#335FAD]/90 flex items-center cursor-pointer">
                <i className="ri-mail-line mr-2"></i>
                support@gmbcourtage.fr
              </a>
              <span className="hidden sm:block text-gray-300 dark:text-gray-600">|</span>
              <a href="tel:+33123456789" className="text-[#335FAD] dark:text-[#335FAD]/80 hover:text-[#335FAD]/70 dark:hover:text-[#335FAD]/90 flex items-center cursor-pointer">
                <i className="ri-phone-line mr-2"></i>
                01 23 45 67 89
              </a>
            </div>
          </div>
        </div>
      </main>
    </div>
  );
}

================
File: app/dossier-confirme/[id]/page.tsx
================
import { Suspense } from 'react';
import DossierConfirmeContent from './DossierConfirmeContent';
import { createClient } from '@supabase/supabase-js';

// FONCTION REQUISE POUR L'EXPORT STATIQUE
export async function generateStaticParams() {
  try {
    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL as string;
    const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY as string;
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const { data, error } = await supabase
      .from('dossiers')
      .select('id')
      .limit(500);

    if (error || !data) return [];
    return data.map((d: { id: string }) => ({ id: d.id }));
  } catch (_e) {
    return [];
  }
}

export default async function DossierConfirmePage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  
    return (
    <Suspense fallback={
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#335FAD] mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Chargement du dossier...</p>
        </div>
      </div>
    }>
      <DossierConfirmeContent dossierId={id} />
    </Suspense>
  );
}

================
File: app/dossier/[id]/DossierDetailContent.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
} from '@/components/ui/dropdown-menu';
import { DossiersService } from '@/lib/services/dossiers';
import { DevisService } from '@/lib/services/devis';
import { formatDate } from '@/lib/utils/formatters';

// TODO: SUPABASE INTEGRATION - INTERFACES COMPLÈTES
interface DossierClient {
  nom: string;
  prenom: string;
  dateNaissance: string;
  profession: string;
  revenus: string;
  fumeur: boolean;
  email: string;
  telephone: string;
  adresse: string;
  conjoint?: {
    nom: string;
    prenom: string;
    dateNaissance: string;
    profession: string;
    revenus: string;
    fumeur: boolean;
  };
}

interface DossierDocument {
  name: string;
  uploaded: boolean;
  url?: string;
  file_path?: string; // Chemin dans Supabase Storage
  file_size?: number;
  file_type?: string;
  uploaded_at?: string;
}

interface ProcessStep {
  id: string;
  label: string;
  description: string;
  status: 'completed' | 'current' | 'pending' | 'error';
  date?: string;
  icon: string;
}

interface DevisInfo {
  id: string;
  compagnie: string;
  logo_compagnie?: string;
  cout_assurance: number;
  economies_estimees: number;
  duree_contrat: number;
  type_couverture: string;
  details_couverture: string[];
  date_creation: string;
  date_expiration: string;
  statut: 'disponible' | 'accepte' | 'refuse' | 'expire';
  motif_refus?: string;
  pdf_url?: string;
  // TODO: SUPABASE - Champs additionnels
  created_at: string;
  updated_at: string;
}

interface DossierComplet {
  id: string;
  numeroDossier: string;
  type: 'seul' | 'couple';
  clientInfo: DossierClient;
  documents: {
    offrePret: DossierDocument | null;
    tableauAmortissement: DossierDocument | null;
    carteIdentite: DossierDocument | null;
    carteIdentiteConjoint?: DossierDocument | null;
  };
  statut: 'brouillon' | 'en_attente' | 'en_cours' | 'analyse' | 'devis_pret' | 'valide' | 'refuse';
  dateCreation: string;
  dateModification: string;
  completude: number;
  isDraft: boolean;
  processSteps: ProcessStep[];
  devis?: DevisInfo;
  devisList?: DevisInfo[]; // Liste de tous les devis
  commentaire?: string;
  // TODO: SUPABASE - Champs pour la base de données
  user_id: string;
  created_at: string;
  updated_at: string;
}

interface DossierDetailContentProps {
  dossierId: string;
}

export default function DossierDetailContent({ dossierId }: DossierDetailContentProps) {
  const router = useRouter();

  const [dossier, setDossier] = useState<DossierComplet | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isGeneratingPDF, setIsGeneratingPDF] = useState(false);
  const [isValidating, setIsValidating] = useState(false);
  const [isRefusing, setIsRefusing] = useState(false);
  const [showRefuseModal, setShowRefuseModal] = useState(false);
  const [refuseReason, setRefuseReason] = useState('');
  const [error, setError] = useState<string | null>(null);
  const REFUS_MOTIFS = [
    'Tarif trop élevé',
    'Couverture insuffisante',
    'Conditions contractuelles inadaptées',
    'Délai trop long',
    'Documents manquants',
    'Autre'
  ] as const;
  const [selectedRefusMotif, setSelectedRefusMotif] = useState<typeof REFUS_MOTIFS[number]>('Tarif trop élevé');
  // Nouvel état pour le suivi collapsible
  const [isProcessExpanded, setIsProcessExpanded] = useState(false);

  // Fonction principale pour récupérer le dossier complet depuis Supabase
  // État pour l'historique complet des devis
  const [devisHistory, setDevisHistory] = useState<any[]>([]);

  // Charger l'historique complet des devis
  useEffect(() => {
    (async () => {
      if (!dossier?.id) return;
      try {
        const history = await DossiersService.getDevisApporteurHistory(dossier.id);
        setDevisHistory(history);
      } catch (e) {
        console.error('[ApporteurDetail] Erreur chargement historique devis:', e);
      }
    })();
  }, [dossier?.id]);

  const fetchDossier = async () => {
    setIsLoading(true);
    setError(null);

    try {
      const data: any = await DossiersService.getDossierById(dossierId);

      if (!data) {
        setError('Dossier introuvable');
        setDossier(null);
        return;
      }

      // Mapping DB -> UI
      const ci = Array.isArray(data.client_infos) ? data.client_infos[0] : null;
      const pd = Array.isArray(data.pret_data) ? data.pret_data[0] : null;
      const allDevis = Array.isArray(data.devis) ? data.devis : [];
      // Filtrer seulement les devis envoyés, acceptés ou refusés (pas les devis en attente)
      const devisList = allDevis.filter((d: any) => 
        d.statut === 'envoye' || d.statut === 'accepte' || d.statut === 'refuse'
      );
      const devis = devisList.length > 0 ? devisList[0] : null; // Premier devis pour compatibilité
      const steps = Array.isArray(data.process_steps) ? data.process_steps : [];
      const docs = Array.isArray(data.documents) ? data.documents : [];

      const mappedBase: DossierComplet = {
        id: data.id,
        numeroDossier: data.numero_dossier,
        type: (data.type_dossier === 'couple' ? 'couple' : 'seul'),
        user_id: data.apporteur_id || '',
        created_at: data.created_at || data.date_creation || '',
        updated_at: data.updated_at || '',
        clientInfo: {
          nom: ci?.client_nom || '',
          prenom: ci?.client_prenom || '',
          dateNaissance: ci?.client_date_naissance || '',
          profession: ci?.client_profession || '',
          revenus: pd?.montant_capital ? String(pd?.montant_capital) : '',
          fumeur: !!ci?.client_fumeur,
          email: ci?.client_email || '',
          telephone: ci?.client_telephone || '',
          adresse: ci?.client_adresse || '',
          conjoint: ci?.conjoint_nom
            ? {
                nom: ci.conjoint_nom,
                prenom: ci.conjoint_prenom || '',
                dateNaissance: ci.conjoint_date_naissance || '',
                profession: ci.conjoint_profession || '',
                revenus: ci?.conjoint_revenus || '',
                fumeur: !!ci.conjoint_fumeur,
              }
            : undefined,
        },
        documents: mapDocsApporteur(docs),
        statut: (data.statut as any) || 'en_attente',
        dateCreation: data.date_creation || data.created_at || '',
        dateModification: data.updated_at || '',
        completude: 0,
        isDraft: false,
        processSteps: [],
        devis: devis
          ? {
              id: devis.id,
              compagnie: 'Assureur',
              cout_assurance: 0,
              economies_estimees: Number(data.economie_generee) || 0,
              duree_contrat: 0,
              type_couverture: 'Devis',
              details_couverture: [],
              date_creation: devis.date_generation || devis.created_at || '',
              date_expiration: devis.date_expiration || '',
              statut: devis.statut === 'accepte' ? 'accepte' : devis.statut === 'refuse' ? 'refuse' : devis.statut === 'envoye' ? 'disponible' : 'disponible',
              motif_refus: (devis.donnees_devis as any)?.motif_refus || devis.motif_refus,
              pdf_url: devis.pdf_url || undefined,
              created_at: devis.created_at || '',
              updated_at: devis.updated_at || '',
            }
          : undefined,
        devisList: devisList.map((d: any) => ({
          id: d.id,
          compagnie: (d.donnees_devis as any)?.compagnie || 'Assureur',
          cout_assurance: (d.donnees_devis as any)?.mensualite || 0,
          economies_estimees: (d.donnees_devis as any)?.economie_estimee || Number(data.economie_generee) || 0,
          duree_contrat: 0,
          type_couverture: 'Devis',
          details_couverture: [],
          date_creation: d.date_generation || d.created_at || '',
          date_expiration: d.date_expiration || '',
          statut: d.statut === 'accepte' ? 'accepte' : d.statut === 'refuse' ? 'refuse' : d.statut === 'envoye' ? 'disponible' : 'disponible',
          motif_refus: (d.donnees_devis as any)?.motif_refus || d.motif_refus,
          pdf_url: d.pdf_url || undefined,
          created_at: d.created_at || '',
          updated_at: d.updated_at || '',
        })),
        // Motif de refus (depuis la DB ou depuis le JSON du devis refusé)
        commentaire: (data as any)?.commentaire || ((devis as any)?.donnees_devis && typeof (devis as any).donnees_devis === 'object' ? (devis as any).donnees_devis.motif_refus : undefined),
      };

      // Construire les étapes canoniques: toujours visibles
      const canonicalSteps = [
        { key: 'received', label: 'Dossier reçu', icon: 'ri-file-check-line', description: 'Votre dossier a été reçu et vérifié' },
        { key: 'analysis', label: 'Analyse IA', icon: 'ri-robot-line', description: 'Extraction automatique des informations' },
        { key: 'gmb', label: 'Traitement GMB', icon: 'ri-user-search-line', description: 'Analyse par nos experts courtiers' },
        { key: 'quote', label: 'Devis disponible', icon: 'ri-file-text-line', description: 'Votre devis personnalisé apparaîtra ici' },
        { key: 'validation', label: 'Validation client', icon: 'ri-checkbox-circle-line', description: 'En attente de votre validation' },
        { key: 'final', label: 'Finalisation', icon: 'ri-award-line', description: 'Mise en place du contrat' },
      ];

      // Déterminer l'étape courante selon la DB
      const dbStatut: string = (data.statut || '').toLowerCase();
      let currentIdx = 0;
      let errorIdx: number | null = null;
      if (dbStatut === 'finalisé' || dbStatut === 'finalise' || dbStatut === 'finalise') currentIdx = 5;
      else if (dbStatut === 'devis_accepte' || dbStatut === 'valide') currentIdx = 4;
      else if (dbStatut === 'devis_envoye' || devis) currentIdx = 3;
      else if (dbStatut === 'en_attente' || !dbStatut) currentIdx = 0;
      else if (dbStatut === 'refusé' || dbStatut === 'refuse') { currentIdx = 4; errorIdx = 4; }

      // Si la table process_steps existe, injecter dates si disponibles
      const datesByKey: Record<string, string | undefined> = {};
      if (Array.isArray(steps)) {
        steps.forEach((s: any) => {
          const name = (s.step_name || '').toLowerCase();
          const completedAt = s.completed_at || s.started_at || undefined;
          if (name.includes('reçu')) datesByKey.received = completedAt;
          else if (name.includes('analyse')) datesByKey.analysis = completedAt;
          else if (name.includes('gmb') || name.includes('traitement')) datesByKey.gmb = completedAt;
          else if (name.includes('devis')) datesByKey.quote = completedAt;
          else if (name.includes('validation')) datesByKey.validation = completedAt;
          else if (name.includes('final')) datesByKey.final = completedAt;
        });
      }

      const mappedSteps: ProcessStep[] = canonicalSteps.map((s, idx) => {
        const status: ProcessStep['status'] = errorIdx === idx
          ? 'error'
          : (idx < currentIdx ? 'completed' : idx === currentIdx ? 'current' : 'pending');
        return {
          id: s.key,
          label: s.label,
          description: s.description,
          status,
          date: datesByKey[s.key],
          icon: s.icon,
        };
      });

      // Rétro-compat: si un devis existant est déjà refusé/accepté/envoyé, refléter sur le statut dossier
      let effectiveStatut: string = mappedBase.statut as any;
      if (devis && typeof devis.statut === 'string' && effectiveStatut !== 'finalise') {
        const ds = devis.statut.toLowerCase();
        if (ds === 'refuse') {
          effectiveStatut = 'refuse';
        } else if (ds === 'accepte') {
          effectiveStatut = 'valide';
        } else if (ds === 'envoye') {
          // utiliser 'devis_pret' (alias typé) pour afficher "Devis disponible"
          effectiveStatut = 'devis_pret';
        } else if (ds === 'en_attente' || ds === 'lu') {
          effectiveStatut = 'devis_pret';
        }
      }

      const mapped: DossierComplet = { ...mappedBase, statut: effectiveStatut as any, processSteps: mappedSteps };

      setDossier(mapped);
    } catch (e) {
      console.error('Erreur lors du chargement du dossier:', e);
      setError(e instanceof Error ? e.message : 'Erreur de chargement');
    } finally {
      setIsLoading(false);
    }
  };

  function mapDocsApporteur(rows: any[]) {
    const findAny = (types: string[]) => rows.find((d: any) => types.includes(d.document_type));
    const toDoc = (row?: any): DossierDocument | null => row ? {
      name: row.document_name,
      uploaded: true,
      url: row.storage_path,
      file_path: row.storage_path,
      file_size: row.file_size,
      file_type: row.mime_type,
      uploaded_at: row.created_at,
    } : null;
    return {
      offrePret: toDoc(findAny(['offre_pret','offrePret'])),
      tableauAmortissement: toDoc(findAny(['tableau_amortissement','tableauAmortissement'])),
      carteIdentite: toDoc(findAny(['carte_identite','carteIdentite','cni'])),
      carteIdentiteConjoint: toDoc(findAny(['carte_identite_conjoint','carteIdentiteConjoint','cni_conjoint'])),
    };
  }

  // Fonction pour valider le devis
  const handleValidateDevis = async () => {
    if (!dossier?.devis || !dossier?.id) return;

    setIsValidating(true);
    try {
      console.log('[handleValidateDevis] start', { devisId: dossier.devis.id, dossierId: dossier.id })
      await DevisService.markDevisAsAccepted(dossier.devis.id);
      await DossiersService.updateDossier(dossier.id, { statut: 'devis_accepte' as any });
      console.log('[handleValidateDevis] success persist, refetch dossier')

      // Rafraîchir depuis la DB pour refléter le statut exact
      const fresh: any = await DossiersService.getDossierById(dossier.id);
      if (fresh) {
        setDossier(prev => prev ? { ...prev, statut: fresh.statut, devis: prev.devis ? { ...prev.devis, statut: 'accepte' } : undefined } : prev);
      } else {
        // fallback local
        setDossier(prev => prev ? { ...prev, statut: 'valide', devis: prev.devis ? { ...prev.devis, statut: 'accepte' } : undefined } : prev);
      }
      alert('Devis validé avec succès !');
    } catch (e) {
      console.error('[handleValidateDevis] error', e);
      alert('Erreur lors de la validation du devis');
    } finally {
      setIsValidating(false);
    }
  };

  // Fonction pour refuser le devis
  const handleRefuseDevis = async () => {
    if (!dossier?.devis || !dossier?.id) return;

    const finalReason = selectedRefusMotif !== 'Autre' ? selectedRefusMotif : refuseReason.trim();
    if (!finalReason) return;

    setIsRefusing(true);
    try {
      console.log('[handleRefuseDevis] start', { devisId: dossier.devis.id, dossierId: dossier.id, selectedRefusMotif, finalReason })
      await DevisService.markDevisAsRejected(dossier.devis.id, finalReason);
      await DossiersService.updateDossier(dossier.id, { statut: 'refuse' as any, commentaire: finalReason as any });
      console.log('[handleRefuseDevis] success persist, refetch dossier')

      // Rafraîchir depuis la DB pour refléter le statut exact
      const fresh: any = await DossiersService.getDossierById(dossier.id);
      if (fresh) {
        setDossier(prev => prev ? { ...prev, statut: fresh.statut, commentaire: finalReason, devis: prev.devis ? { ...prev.devis, statut: 'refuse' } : undefined } : prev);
      } else {
        // fallback local
        setDossier(prev => prev ? { ...prev, statut: 'refuse', commentaire: finalReason, devis: prev.devis ? { ...prev.devis, statut: 'refuse' } : undefined } : prev);
      }

      setShowRefuseModal(false);
      setRefuseReason('');
      setSelectedRefusMotif('Tarif trop élevé');
      alert('Devis refusé. Votre motif a été enregistré.');
    } catch (e) {
      console.error('[handleRefuseDevis] error', e);
      alert('Erreur lors du refus du devis');
    } finally {
      setIsRefusing(false);
    }
  };

  // Fonction pour générer et télécharger le PDF
  const handleDownloadPDF = async () => {
    if (!dossier?.devis) return;

    setIsGeneratingPDF(true);
    try {
      await new Promise(resolve => setTimeout(resolve, 2000));
      alert('Le PDF sera téléchargé une fois Supabase intégré');
    } catch (e) {
      console.error('Erreur lors de la génération du PDF:', e);
      alert('Erreur lors de la génération du PDF');
    } finally {
      setIsGeneratingPDF(false);
    }
  };

  // Fonction pour partager le devis par email
  const handleShareDevis = () => {
    if (!dossier) return;

    const subject = encodeURIComponent('Devis assurance emprunteur - ' + dossier.numeroDossier);
    const bodyLines = [
      'Bonjour,',
      '',
      "Voici votre devis d'assurance emprunteur personnalisé :",
      '',
      'Dossier : ' + dossier.numeroDossier,
      'Compagnie : ' + (dossier.devis?.compagnie ?? ''),
      'Coût mensuel : ' + (dossier.devis?.cout_assurance ?? '') + '€',
      'Économies estimées : ' + (dossier.devis?.economies_estimees ?? '') + '€',
      '',
      'Le devis détaillé est disponible en pièce jointe.',
      '',
      'Cordialement,',
      'GMB Courtage',
    ];
    const body = encodeURIComponent(bodyLines.join('\n'));
    window.location.href = 'mailto:' + dossier.clientInfo.email + '?subject=' + subject + '&body=' + body;
  };

  const buildPublicUrl = (key: string) => {
    const base = (process.env.NEXT_PUBLIC_SUPABASE_URL || '').replace(/\/+$/, '')
    return `${base}/storage/v1/object/public/documents/${key}`
  }

  useEffect(() => {
    if (dossierId) {
      fetchDossier();
    }
  }, [dossierId]);

  // ✅ Utilisation du formatter centralisé depuis lib/utils/formatters.ts

  // Formatage des montants
  const formatAmount = (amount: number) => {
    return new Intl.NumberFormat('fr-FR', {
      style: 'currency',
      currency: 'EUR',
    }).format(amount);
  };

  // Configuration des statuts (normalisée, cohérente avec la liste)
  const getStatutConfig = (statut: string) => {
    const key = (statut || '')
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/\s+/g, '_');
    switch (key) {
      case 'en_attente':
      case 'nouveau':
      case 'dossier_envoye':
        return {
          label: 'Dossier envoyé',
          icon: 'ri-send-plane-line',
          bgColor: 'bg-blue-100 dark:bg-blue-900/30',
          textColor: 'text-blue-700 dark:text-blue-400',
          borderColor: 'border-blue-200 dark:border-blue-700',
        };
      case 'devis_genere':
      case 'devis_disponible':
      case 'devis_pret':
        return {
          label: 'Devis disponible',
          icon: 'ri-file-text-line',
          bgColor: 'bg-indigo-100 dark:bg-indigo-900/30',
          textColor: 'text-indigo-700 dark:text-indigo-400',
          borderColor: 'border-indigo-200 dark:border-indigo-700',
        };
      case 'devis_envoye':
        return {
          label: 'Devis envoyé',
          icon: 'ri-mail-line',
          bgColor: 'bg-orange-100 dark:bg-orange-900/30',
          textColor: 'text-orange-700 dark:text-orange-400',
          borderColor: 'border-orange-200 dark:border-orange-700',
        };
      case 'devis_accepte':
      case 'valide':
        return {
          label: 'Devis accepté',
          icon: 'ri-check-line',
          bgColor: 'bg-green-100 dark:bg-green-900/30',
          textColor: 'text-green-700 dark:text-green-400',
          borderColor: 'border-green-200 dark:border-green-700',
        };
      case 'finalise':
      case 'finalisee':
      case 'finalises':
      case 'finalisees':
        return {
          label: 'Finalisé',
          icon: 'ri-check-double-line',
          bgColor: 'bg-purple-100 dark:bg-purple-900/30',
          textColor: 'text-purple-700 dark:text-purple-400',
          borderColor: 'border-purple-200 dark:border-purple-700',
        };
      case 'refuse':
      case 'refusee':
      case 'refuses':
      case 'refusees':
        return {
          label: 'Refusé',
          icon: 'ri-close-line',
          bgColor: 'bg-red-100 dark:bg-red-900/30',
          textColor: 'text-red-700 dark:text-red-400',
          borderColor: 'border-red-200 dark:border-red-700',
        };
      default:
        return {
          label: 'Inconnu',
          icon: 'ri-question-line',
          bgColor: 'bg-gray-100 dark:bg-gray-700',
          textColor: 'text-gray-700 dark:text-gray-300',
          borderColor: 'border-gray-200 dark:border-gray-600',
        };
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Chargement du dossier...</p>
        </div>
      </div>
    );
  }

  if (error || !dossier) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center max-w-md mx-auto p-8">
          <div className="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
            <i className="ri-error-warning-line text-red-600 dark:text-red-400 text-2xl"></i>
          </div>
          <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
            Dossier introuvable
          </h3>
          <p className="text-gray-500 dark:text-gray-400 mb-6">
            {error || "Ce dossier n'existe pas ou vous n'avez pas les droits pour y accéder."}
          </p>
          <Link
            href="/mes-dossiers"
            className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer inline-flex items-center space-x-2"
          >
            <i className="ri-arrow-left-line"></i>
            <span>Retour aux dossiers</span>
          </Link>
        </div>
      </div>
    );
  }

  const statutConfig = getStatutConfig(dossier.statut);

  // Classes pour le badge de statut du devis (extraites pour simplifier le JSX)
  const devisStatusBadgeClasses = (() => {
    if ((dossier.statut as any) === 'finalise') {
      return 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400';
    }
    if (!dossier.devis) return 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300';
    if (dossier.devis.statut === 'disponible') return 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400';
    if (dossier.devis.statut === 'accepte') return 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD]';
    return 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400';
  })();

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      {/* Header */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40">
        <div className="px-4 sm:px-8 py-4 sm:py-6">
          <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div className="flex items-center space-x-4">
              <Link
                href="/mes-dossiers"
                className="w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg flex items-center justify-center transition-colors cursor-pointer"
              >
                <i className="ri-arrow-left-line text-gray-600 dark:text-gray-300"></i>
              </Link>
              <div>
                <div className="flex items-center space-x-3 mb-1">
                  <h1 className="text-xl sm:text-2xl font-medium text-gray-900 dark:text-white">
                    {dossier.numeroDossier}
                  </h1>
                  <span
                    className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${statutConfig.bgColor} ${statutConfig.textColor} ${statutConfig.borderColor}`}
                  >
                    <i className={`${statutConfig.icon} mr-1`}></i>
                    {statutConfig.label}
                  </span>
                </div>
                <p className="text-sm text-gray-500 dark:text-gray-400">
                  {dossier.clientInfo.prenom} {dossier.clientInfo.nom}
                  {dossier.type === 'couple' && dossier.clientInfo.conjoint && (
                    <span>
                      {' '}&amp; {dossier.clientInfo.conjoint.prenom} {dossier.clientInfo.conjoint.nom}
                    </span>
                  )}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-7xl mx-auto">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Colonne principale */}
          <div className="lg:col-span-2 space-y-8">
            {/* Barre de progression du processus - Version collapsible */}
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-xl font-medium text-gray-900 dark:text-white flex items-center">
                  <i className="ri-roadmap-line mr-3 text-[#335FAD] dark:text-[#335FAD]/80"></i>
                  Suivi du dossier
                </h2>
                <button
                  onClick={() => setIsProcessExpanded(!isProcessExpanded)}
                  className="text-[#335FAD] dark:text-[#335FAD]/80 hover:text-indigo-700 dark:hover:text-indigo-300 text-sm font-medium cursor-pointer flex items-center space-x-1"
                >
                  <span>{isProcessExpanded ? 'Masquer' : 'Afficher tout'}</span>
                  <i className={`ri-arrow-${isProcessExpanded ? 'up' : 'down'}-s-line`}></i>
                </button>
              </div>

              <div className="space-y-4">
                {dossier.processSteps.map((step, index) => {
                  const currentStepIndex = dossier.processSteps.findIndex(s => s.status === 'current');
                  const isCurrentStep = step.status === 'current';
                  const shouldShow =
                    isProcessExpanded ||
                    isCurrentStep ||
                    (currentStepIndex === -1 && index === dossier.processSteps.length - 1);
                  if (!shouldShow) return null;

                  return (
                    <div key={step.id} className="flex items-start space-x-4">
                      {/* Icône et ligne */}
                      <div className="flex flex-col items-center">
                        <div
                          className={`w-10 h-10 rounded-full flex items-center justify-center ${
                            step.status === 'completed'
                              ? 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400'
                              : step.status === 'current'
                              ? 'bg-indigo-100 dark:bg-indigo-900/30 text-[#335FAD] dark:text-[#335FAD]/80'
                              : step.status === 'error'
                              ? 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400'
                              : 'bg-gray-100 dark:bg-gray-700 text-gray-400 dark:text-gray-500'
                          }`}
                        >
                          <i className={`${step.icon} text-sm`}></i>
                        </div>
                        {isProcessExpanded && index < dossier.processSteps.length - 1 && (
                          <div
                            className={`w-0.5 h-8 mt-2 ${
                              step.status === 'completed' ? 'bg-green-200 dark:bg-green-700' : 'bg-gray-200 dark:bg-gray-600'
                            }`}
                          ></div>
                        )}
                      </div>

                      {/* Contenu */}
                      <div className="flex-1 pb-8">
                        <div className="flex items-center justify-between">
                          <h3
                            className={`font-medium ${
                              step.status === 'completed' || step.status === 'current'
                                ? 'text-gray-900 dark:text-white'
                                : 'text-gray-500 dark:text-gray-400'
                            }`}
                          >
                            {step.label}
                          </h3>
                          {step.date && (
                            <span className="text-xs text-gray-500 dark:text-gray-400">
                              {formatDate(step.date, true)}
                            </span>
                          )}
                        </div>
                        <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                          {step.description}
                        </p>
                        {step.status === 'current' && (
                          <div className="mt-2">
                            <div className="flex items-center space-x-2">
                              <div className="w-2 h-2 bg-indigo-600 rounded-full animate-pulse"></div>
                              <span className="text-xs text-[#335FAD] dark:text-[#335FAD]/80 font-medium">
                                En cours
                              </span>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Section Devis */}
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
                <div className="flex items-center justify-between mb-6">
                  <h2 className="text-xl font-medium text-gray-900 dark:text-white flex items-center">
                    <i className="ri-file-text-line mr-3 text-[#335FAD] dark:text-[#335FAD]/80"></i>
                    Devis personnalisé
                  </h2>
                <span
                  className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${devisStatusBadgeClasses}`}
                >
                    {dossier.devis
                      ? dossier.devis.statut === 'disponible'
                        ? 'Disponible'
                        : dossier.devis.statut === 'accepte'
                        ? 'Accepté'
                        : 'Refusé'
                      : 'En préparation'}
                  </span>
                </div>

                {!dossier.devis ? (
                  <div className="rounded-xl border border-dashed border-gray-300 dark:border-gray-600 p-6 bg-gray-50 dark:bg-gray-700/30">
                    <div className="flex items-start space-x-4">
                      <div className="w-12 h-12 rounded-full bg-[#335FAD]/10 dark:bg-[#335FAD]/20 flex items-center justify-center flex-shrink-0">
                        <i className="ri-time-line text-[#335FAD] dark:text-[#335FAD]"></i>
                      </div>
                      <div>
                        <h4 className="text-base font-medium text-gray-900 dark:text-white mb-1">Votre devis sera affiché ici</h4>
                        <p className="text-sm text-gray-600 dark:text-gray-400">
                          Nos agents GMB Courtage travaillent actuellement sur votre dossier. Vous serez notifié dès que votre devis personnalisé sera disponible.
                        </p>
                      </div>
                    </div>
                  </div>
                ) : (
                  <>
                {/* Infos du devis */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                  {/* Compagnie */}
                  <div className="flex items-center space-x-4 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                        {dossier.devis.logo_compagnie && (
                    <img
                      src={dossier.devis.logo_compagnie}
                      alt={dossier.devis.compagnie}
                      className="w-16 h-8 object-contain"
                            onError={e => { (e.target as HTMLImageElement).style.display = 'none'; }}
                    />
                        )}
                    <div>
                      <p className="text-sm text-gray-500 dark:text-gray-400">Compagnie</p>
                      <p className="font-medium text-gray-900 dark:text-white">
                        {dossier.devis.compagnie}
                      </p>
                    </div>
                  </div>

                  {/* Coût mensuel */}
                  <div className="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                    <p className="text-sm text-gray-500 dark:text-gray-400">Coût mensuel</p>
                    <p className="text-2xl font-light text-gray-900 dark:text-white">
                      {formatAmount(dossier.devis.cout_assurance)}
                    </p>
                  </div>

                  {/* Économies */}
                  <div className="md:col-span-2 p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-700">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-green-600 dark:text-green-400">
                          Économies estimées sur la durée
                        </p>
                        <p className="text-3xl font-light text-green-700 dark:text-green-400">
                          {formatAmount(dossier.devis.economies_estimees)}
                        </p>
                      </div>
                      <div className="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                        <i className="ri-money-euro-circle-line text-green-600 dark:text-green-400 text-2xl"></i>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Détails de couverture */}
                    {dossier.devis.details_couverture?.length ? (
                <div className="mb-6">
                  <h3 className="font-medium text-gray-900 dark:text-white mb-3">
                    {dossier.devis.type_couverture}
                  </h3>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    {dossier.devis.details_couverture.map((garantie, idx) => (
                      <div key={idx} className="flex items-center space-x-2">
                        <i className="ri-check-line text-green-600 dark:text-green-400 text-sm"></i>
                        <span className="text-sm text-gray-700 dark:text-gray-300">{garantie}</span>
                      </div>
                    ))}
                  </div>
                </div>
                    ) : null}
                  </>
                )}
              </div>


                {/* Actions du devis - Couleurs ajustées */}
                {dossier.devis && dossier.devis.statut === 'disponible' && dossier.statut !== 'refuse' && (
                  <div className="space-y-4">
                    {/* Partage et téléchargement - Couleurs moins prononcées */}
                    <div className="flex flex-col sm:flex-row gap-3">
                      <button
                        onClick={handleDownloadPDF}
                        disabled={isGeneratingPDF}
                        className="flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {isGeneratingPDF ? (
                          <>
                            <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-600"></div>
                            <span>Génération...</span>
                          </>
                        ) : (
                          <>
                            <i className="ri-download-line"></i>
                            <span>Télécharger PDF</span>
                          </>
                        )}
                      </button>

                      <button
                        onClick={handleShareDevis}
                        className="flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2"
                      >
                        <i className="ri-share-line"></i>
                        <span>Partager</span>
                      </button>
                    </div>

                    {/* Validation / Refus - Couleurs éclaircies */}
                    <div className="flex flex-col sm:flex-row gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                      <button
                        onClick={handleValidateDevis}
                        disabled={isValidating}
                        className="flex-1 bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 text-white px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {isValidating ? (
                          <>
                            <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                            <span>Validation...</span>
                          </>
                        ) : (
                          <>
                            <i className="ri-check-line"></i>
                            <span>Valider la proposition</span>
                          </>
                        )}
                      </button>

                      <button
                        onClick={() => setShowRefuseModal(true)}
                        className="flex-1 bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700 text-white px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2"
                      >
                        <i className="ri-close-line"></i>
                        <span>Refuser la proposition</span>
                      </button>
                    </div>
                  </div>
                )}

                {/* Affichage après validation/refus */}
                {dossier.devis && (dossier.devis.statut !== 'disponible' || dossier.statut === 'refuse') && (
                  <div
                    className={`p-4 rounded-xl ${
                      dossier.devis.statut === 'accepte'
                        ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700'
                        : 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700'
                    }`}
                  >
                    <div className="flex items-center space-x-3">
                      <i
                        className={`${
                          dossier.devis.statut === 'accepte'
                            ? 'ri-check-circle-line text-green-600 dark:text-green-400'
                            : 'ri-close-circle-line text-red-600 dark:text-red-400'
                        } text-xl`}
                      ></i>
                      <div>
                        <p
                          className={`font-medium ${
                            dossier.devis.statut === 'accepte'
                              ? 'text-green-700 dark:text-green-400'
                              : 'text-red-700 dark:text-red-400'
                          }`}
                        >
                          {dossier.devis.statut === 'accepte' ? 'Devis accepté' : 'Devis refusé'}
                        </p>
                        <p
                          className={`text-sm ${
                            dossier.devis.statut === 'accepte'
                              ? 'text-green-600 dark:text-green-400'
                              : 'text-red-600 dark:text-red-400'
                          }`}
                        >
                          {dossier.devis.statut === 'accepte'
                            ? 'GMB Courtage procède à la finalisation de votre contrat'
                            : 'Votre retour a été transmis à GMB Courtage'}
                        </p>
                      </div>
                    </div>
                    {dossier.commentaire && dossier.devis.statut === 'refuse' && (
                      <div className="mt-3 p-3 bg-red-100 dark:bg-red-900/30 rounded-lg">
                        <p className="text-sm text-red-700 dark:text-red-400">
                          <strong>Raison du refus :</strong> {dossier.commentaire}
                        </p>
                      </div>
                    )}
                  </div>
                )}
              </div>
          
          
          {/* Colonne latérale */}
          <div className="space-y-8">
            {/* Informations client */}
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
              <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
                <i className="ri-user-line mr-3 text-[#335FAD] dark:text-[#335FAD]/80"></i>
                Informations client
              </h3>

              <div className="space-y-4">
                {/* Emprunteur principal */}
                <div>
                  <h4 className="font-medium text-gray-900 dark:text-white mb-2">
                    {dossier.type === 'couple' ? 'Emprunteur principal' : 'Emprunteur'}
                  </h4>
                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span className="text-gray-500 dark:text-gray-400">Nom :</span>
                      <span className="text-gray-900 dark:text-white">
                        {dossier.clientInfo.prenom} {dossier.clientInfo.nom}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-500 dark:text-gray-400">Naissance :</span>
                      <span className="text-gray-900 dark:text-white">
                        {new Date(dossier.clientInfo.dateNaissance).toLocaleDateString('fr-FR')}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-500 dark:text-gray-400">Profession :</span>
                      <span className="text-gray-900 dark:text-white">{dossier.clientInfo.profession}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-500 dark:text-gray-400">Revenus :</span>
                      <span className="text-gray-900 dark:text-white">
                        {dossier.clientInfo.revenus}€/mois
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-500 dark:text-gray-400">Fumeur :</span>
                      <span className="text-gray-900 dark:text-white">
                        {dossier.clientInfo.fumeur ? 'Oui' : 'Non'}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-500 dark:text-gray-400">Email :</span>
                      <span className="text-gray-900 dark:text-white">{dossier.clientInfo.email}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-500 dark:text-gray-400">Téléphone :</span>
                      <span className="text-gray-900 dark:text-white">{dossier.clientInfo.telephone}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-500 dark:text-gray-400">Adresse :</span>
                      <span className="text-gray-900 dark:text-white">{dossier.clientInfo.adresse}</span>
                    </div>
                  </div>
                </div>

                {/* Conjoint (si présent) */}
                {dossier.type === 'couple' && dossier.clientInfo.conjoint && (
                  <div className="mt-6">
                    <h4 className="font-medium text-gray-900 dark:text-white mb-2">Conjoint</h4>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-500 dark:text-gray-400">Nom :</span>
                        <span className="text-gray-900 dark:text-white">
                          {dossier.clientInfo.conjoint.prenom} {dossier.clientInfo.conjoint.nom}
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-500 dark:text-gray-400">Naissance :</span>
                        <span className="text-gray-900 dark:text-white">
                          {new Date(dossier.clientInfo.conjoint.dateNaissance).toLocaleDateString('fr-FR')}
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-500 dark:text-gray-400">Profession :</span>
                        <span className="text-gray-900 dark:text-white">{dossier.clientInfo.conjoint.profession}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-500 dark:text-gray-400">Revenus :</span>
                        <span className="text-gray-900 dark:text-white">
                          {dossier.clientInfo.conjoint.revenus}€/mois
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-500 dark:text-gray-400">Fumeur :</span>
                        <span className="text-gray-900 dark:text-white">
                          {dossier.clientInfo.conjoint.fumeur ? 'Oui' : 'Non'}
                        </span>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Nouvelle card : Documents joints */}
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
              <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
                <i className="ri-file-list-line mr-3 text-[#335FAD] dark:text-[#335FAD]/80"></i>
                Documents joints
              </h3>

              <div className="space-y-3">
                {/* Offre de prêt */}
                <div className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                  <div className="flex items-center space-x-3 min-w-0 flex-1">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${
                      dossier.documents.offrePret 
                        ? 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400'
                        : 'bg-gray-200 dark:bg-gray-600 text-gray-400 dark:text-gray-500'
                    }`}>
                      <i className="ri-file-text-line text-sm"></i>
                    </div>
                    <div className="min-w-0 flex-1">
                      <p className="text-sm font-medium text-gray-900 dark:text-white">Offre de Prêt</p>
                      {dossier.documents.offrePret ? (
                        <p className="text-xs text-gray-500 dark:text-gray-400 truncate" title={dossier.documents.offrePret.name}>
                          {dossier.documents.offrePret.name}
                        </p>
                      ) : (
                        <p className="text-xs text-red-500 dark:text-red-400">Non fourni</p>
                      )}
                    </div>
                  </div>
                  {dossier.documents.offrePret && (
                    <button
                      onClick={() => window.open(buildPublicUrl(dossier.documents.offrePret!.url!), '_blank')}
                      className="text-[#335FAD] dark:text-[#335FAD]/80 hover:text-indigo-700 dark:hover:text-indigo-300 cursor-pointer flex-shrink-0 ml-2"
                      title="Consulter le document"
                    >
                      <i className="ri-eye-line text-sm"></i>
                    </button>
                  )}
                </div>

                {/* Tableau d'amortissement */}
                <div className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                  <div className="flex items-center space-x-3 min-w-0 flex-1">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${
                      dossier.documents.tableauAmortissement 
                        ? 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400'
                        : 'bg-gray-200 dark:bg-gray-600 text-gray-400 dark:text-gray-500'
                    }`}>
                      <i className="ri-table-line text-sm"></i>
                    </div>
                    <div className="min-w-0 flex-1">
                      <p className="text-sm font-medium text-gray-900 dark:text-white">Tableau d'Amortissement</p>
                      {dossier.documents.tableauAmortissement ? (
                        <p className="text-xs text-gray-500 dark:text-gray-400 truncate" title={dossier.documents.tableauAmortissement.name}>
                          {dossier.documents.tableauAmortissement.name}
                        </p>
                      ) : (
                        <p className="text-xs text-red-500 dark:text-red-400">Non fourni</p>
                      )}
                    </div>
                  </div>
                  {dossier.documents.tableauAmortissement && (
                    <button
                      onClick={() => window.open(buildPublicUrl(dossier.documents.tableauAmortissement!.url!), '_blank')}
                      className="text-[#335FAD] dark:text-[#335FAD]/80 hover:text-indigo-700 dark:hover:text-indigo-300 cursor-pointer flex-shrink-0 ml-2"
                      title="Consulter le document"
                    >
                      <i className="ri-eye-line text-sm"></i>
                    </button>
                  )}
                </div>

                {/* Carte d'identité emprunteur */}
                <div className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                  <div className="flex items-center space-x-3 min-w-0 flex-1">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${
                      dossier.documents.carteIdentite 
                        ? 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400'
                        : 'bg-gray-200 dark:bg-gray-600 text-gray-400 dark:text-gray-500'
                    }`}>
                      <i className="ri-id-card-line text-sm"></i>
                    </div>
                    <div className="min-w-0 flex-1">
                      <p className="text-sm font-medium text-gray-900 dark:text-white">Carte d'Identité</p>
                      {dossier.documents.carteIdentite ? (
                        <p className="text-xs text-gray-500 dark:text-gray-400 truncate" title={dossier.documents.carteIdentite.name}>
                          {dossier.documents.carteIdentite.name}
                        </p>
                      ) : (
                        <p className="text-xs text-red-500 dark:text-red-400">Non fourni</p>
                      )}
                    </div>
                  </div>
                  {dossier.documents.carteIdentite && (
                    <button
                      onClick={() => window.open(buildPublicUrl(dossier.documents.carteIdentite!.url!), '_blank')}
                      className="text-[#335FAD] dark:text-[#335FAD]/80 hover:text-indigo-700 dark:hover:text-indigo-300 cursor-pointer flex-shrink-0 ml-2"
                      title="Consulter le document"
                    >
                      <i className="ri-eye-line text-sm"></i>
                    </button>
                  )}
                </div>

                {/* Carte d'identité conjoint (si présente) */}
                {dossier.type === 'couple' && (
                  <div className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                    <div className="flex items-center space-x-3 min-w-0 flex-1">
                      <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${
                        dossier.documents.carteIdentiteConjoint 
                          ? 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400'
                          : 'bg-gray-200 dark:bg-gray-600 text-gray-400 dark:text-gray-500'
                      }`}>
                        <i className="ri-id-card-line text-sm"></i>
                      </div>
                      <div className="min-w-0 flex-1">
                        <p className="text-sm font-medium text-gray-900 dark:text-white">Carte d'Identité (Conjoint)</p>
                        {dossier.documents.carteIdentiteConjoint ? (
                          <p className="text-xs text-gray-500 dark:text-gray-400 truncate" title={dossier.documents.carteIdentiteConjoint.name}>
                            {dossier.documents.carteIdentiteConjoint.name}
                          </p>
                        ) : (
                          <p className="text-xs text-red-500 dark:text-red-400">Non fourni</p>
                        )}
                      </div>
                    </div>
                    {dossier.documents.carteIdentiteConjoint && (
                      <button
                        onClick={() => window.open(buildPublicUrl(dossier.documents.carteIdentiteConjoint!.url!), '_blank')}
                        className="text-[#335FAD] dark:text-[#335FAD]/80 hover:text-indigo-700 dark:hover:text-indigo-300 cursor-pointer flex-shrink-0 ml-2"
                        title="Consulter le document"
                      >
                        <i className="ri-eye-line text-sm"></i>
                      </button>
                    )}
                  </div>
                )}
              </div>

              {/* Résumé des documents */}
              <div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <div className="flex items-center justify-between text-sm">
                  <span className="text-gray-500 dark:text-gray-400">Documents fournis :</span>
                  <span className="font-medium text-gray-900 dark:text-white">
                    {[
                      dossier.documents.offrePret,
                      dossier.documents.tableauAmortissement,
                      dossier.documents.carteIdentite,
                      dossier.documents.carteIdentiteConjoint
                    ].filter(Boolean).length}{' '}
                    / {dossier.type === 'couple' ? 4 : 3}
                  </span>
                </div>
              </div>
            </div>

            {/* Historique des devis */}
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
              <h2 className="text-xl font-medium text-gray-900 dark:text-white mb-6 flex items-center">
                <i className="ri-history-line mr-3 text-[#335FAD] dark:text-[#335FAD]/80"></i>
                Historique des devis
              </h2>
              
              {devisHistory && devisHistory.length > 0 ? (
                <div className="space-y-3">
                  {devisHistory.map((devisItem, index) => (
                    <div 
                      key={`${devisItem.devis_id}-${devisItem.action_type}-${index}`}
                      className={`p-4 rounded-xl border transition-colors ${
                        devisItem.action_type === 'accepte'
                          ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-700'
                          : devisItem.action_type === 'refuse'
                          ? 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-700'
                          : 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-700'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-3">
                          <div className={`w-3 h-3 rounded-full ${
                            devisItem.action_type === 'accepte'
                              ? 'bg-green-500'
                              : devisItem.action_type === 'refuse'
                              ? 'bg-red-500'
                              : 'bg-blue-500'
                          }`}></div>
                          <div>
                            <p className="font-medium text-gray-900 dark:text-white">
                              {devisItem.compagnie} - {devisItem.numero_devis}
                            </p>
                            <p className="text-sm text-gray-500 dark:text-gray-400">
                              {formatAmount(devisItem.cout_mensuel)}/mois • Économies: {formatAmount(devisItem.economie_estimee || 0)}
                            </p>
                            {devisItem.action_date && (
                              <p className="text-xs text-gray-400 dark:text-gray-500">
                                {devisItem.action_type === 'refuse' ? 'Refusé le' :
                                 devisItem.action_type === 'accepte' ? 'Accepté le' : 'Le'} {formatDate(devisItem.action_date)}
                              </p>
                            )}
                          </div>
                        </div>
                        
                        <div className="flex items-center space-x-2">
                          {devisItem.action_type === 'accepte' && (
                            <span className="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-2 py-1 rounded-full text-xs font-medium">
                              Accepté
                            </span>
                          )}
                          {devisItem.action_type === 'refuse' && (
                            <span className="bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 px-2 py-1 rounded-full text-xs font-medium">
                              Refusé
                            </span>
                          )}
                        </div>
                      </div>
                      
                      {/* Affichage du motif de refus si le devis est refusé */}
                      {devisItem.action_type === 'refuse' && devisItem.motif_refus && (
                        <div className="mt-3 pt-3 border-t border-red-200 dark:border-red-700">
                          <p className="text-sm text-red-700 dark:text-red-300">
                            <span className="font-medium">motif :</span> {devisItem.motif_refus}
                          </p>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8">
                  <i className="ri-file-list-3-line text-gray-400 text-3xl mb-3"></i>
                  <p className="text-gray-500 dark:text-gray-400">Aucun devis généré pour ce dossier</p>
                </div>
              )}
            </div>
          </div>
        </div>
      </main>

      {/* Modal de refus */}
      {showRefuseModal && (
        <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
          <div className="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4">
            <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
              Refuser le devis
            </h3>
            <div className="space-y-3 mb-3">
              <label className="block text-sm text-gray-700 dark:text-gray-300">Motif</label>
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <button className="w-full flex items-center justify-between p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white">
                    <span>{selectedRefusMotif}</span>
                    <i className="ri-arrow-down-s-line"></i>
                  </button>
                </DropdownMenuTrigger>
                <DropdownMenuContent className="w-full">
                  <DropdownMenuLabel>Choisir un motif</DropdownMenuLabel>
                  <DropdownMenuSeparator />
                  {REFUS_MOTIFS.map(m => (
                    <DropdownMenuItem key={m} onClick={() => setSelectedRefusMotif(m)}>
                      {m}
                    </DropdownMenuItem>
                  ))}
                </DropdownMenuContent>
              </DropdownMenu>
            </div>
            {selectedRefusMotif === 'Autre' && (
              <textarea
                value={refuseReason}
                onChange={e => setRefuseReason(e.target.value)}
                placeholder="Préciser le motif..."
                className="w-full h-24 p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
            )}
            <div className="flex justify-end space-x-3 mt-4">
              <button
                onClick={() => setShowRefuseModal(false)}
                className="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500"
              >
                Annuler
              </button>
              <button
                onClick={handleRefuseDevis}
                disabled={isRefusing}
                className="px-4 py-2 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isRefusing ? 'Envoi...' : 'Valider le refus'}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

================
File: app/dossier/[id]/page.tsx
================
import { Suspense } from 'react';
import DossierDetailContent from './DossierDetailContent';
import { createClient } from '@supabase/supabase-js';

// FONCTION REQUISE POUR L'EXPORT STATIQUE
export async function generateStaticParams() {
  try {
    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL as string;
    const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY as string;
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const { data, error } = await supabase
      .from('dossiers')
      .select('id')
      .limit(500);

    if (error || !data) return [];
    return data.map((d: { id: string }) => ({ id: d.id }));
  } catch (_e) {
    return [];
  }
}

export default async function DossierPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Chargement du dossier...</p>
        </div>
      </div>
    }>
      <DossierDetailContent dossierId={id} />
    </Suspense>
  );
}

================
File: app/globals.css
================
@import url('https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.5.0/remixicon.min.css');
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 0 0% 3.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 0 0% 3.9%;
    --primary: 0 0% 9%;
    --primary-foreground: 0 0% 98%;
    --secondary: 0 0% 96.1%;
    --secondary-foreground: 0 0% 9%;
    --muted: 0 0% 96.1%;
    --muted-foreground: 0 0% 45.1%;
    --accent: 0 0% 96.1%;
    --accent-foreground: 0 0% 9%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 89.8%;
    --input: 0 0% 89.8%;
    --ring: 0 0% 3.9%;
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;
    --radius: 0.5rem
  }
  .dark {
    --background: 0 0% 3.9%;
    --foreground: 0 0% 98%;
    --card: 0 0% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 0 0% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 0 0% 9%;
    --secondary: 0 0% 14.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 0 0% 14.9%;
    --muted-foreground: 0 0% 63.9%;
    --accent: 0 0% 14.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 14.9%;
    --input: 0 0% 14.9%;
    --ring: 0 0% 83.1%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}

================
File: app/invite/[token]/page.tsx
================
'use client';

import { useEffect, useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { api } from '@/services/api';
import { useAuth } from '@/components/AuthProvider';

type InviteState = 'loading' | 'valid' | 'invalid' | 'expired' | 'consumed' | 'error' | 'success';

export default function InvitePage() {
    const params = useParams();
    const router = useRouter();
    const { user, loading: authLoading } = useAuth();
    const token = params.token as string;

    const [state, setState] = useState<InviteState>('loading');
    const [error, setError] = useState<string | null>(null);
    const [inviteInfo, setInviteInfo] = useState<{
        broker_id?: string;
        broker_name?: string;
        owner_name?: string;
        invite_type?: string;
        expires_at?: string;
    } | null>(null);
    const [consuming, setConsuming] = useState(false);

    // Valider le token au chargement
    useEffect(() => {
        if (!token) {
            setState('invalid');
            return;
        }

        const validateToken = async () => {
            try {
                // Décoder le token car il peut être URL-encodé (ex: = devient %3D)
                const decodedToken = decodeURIComponent(token);
                const result = await api.validateBrokerInvite(decodedToken);

                if (result.is_valid) {
                    setState('valid');
                    setInviteInfo({
                        broker_id: result.broker_id,
                        broker_name: result.broker_name,
                        owner_name: result.owner_name,
                        invite_type: result.invite_type,
                        expires_at: result.expires_at
                    });
                } else {
                    // Déterminer le type d'erreur
                    if (result.reason?.includes('expired')) {
                        setState('expired');
                    } else if (result.reason?.includes('maximum uses') || result.reason?.includes('revoked')) {
                        setState('consumed');
                    } else {
                        setState('invalid');
                    }
                    setError(result.reason || 'Token invalide');
                }
            } catch (err) {
                console.error('Error validating invite:', err);
                setState('error');
                setError('Une erreur est survenue lors de la validation');
            }
        };

        validateToken();
    }, [token]);

    // Handler pour accepter l'invitation
    const handleAcceptInvite = async () => {
        // Décoder le token car il peut être URL-encodé
        const decodedToken = decodeURIComponent(token);
        
        if (!user) {
            // Rediriger vers la connexion avec le token en query param
            // Le token est passé directement pour que /connexion puisse valider et consommer
            router.push(`/connexion?invite=${encodeURIComponent(decodedToken)}`);
            return;
        }

        setConsuming(true);
        setError(null);

        try {
            const result = await api.consumeBrokerInvite(decodedToken);

            if (result.success) {
                setState('success');
                // Rediriger vers l'accueil après 2 secondes
                setTimeout(() => {
                    router.push('/');
                }, 2000);
            } else {
                setError(result.error || 'Erreur lors de l\'acceptation');
                setState('error');
            }
        } catch (err) {
            console.error('Error consuming invite:', err);
            setError('Une erreur est survenue');
            setState('error');
        } finally {
            setConsuming(false);
        }
    };

    // Loading state
    if (state === 'loading' || authLoading) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#335FAD] mx-auto mb-4"></div>
                    <p className="text-gray-600 dark:text-gray-400">Vérification de l'invitation...</p>
                </div>
            </div>
        );
    }

    // Success state
    if (state === 'success') {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 p-4">
                <div className="max-w-md w-full bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 text-center">
                    <div className="w-16 h-16 bg-green-100 dark:bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i className="ri-check-line text-3xl text-green-600 dark:text-green-400"></i>
                    </div>
                    <h1 className="text-2xl font-semibold text-gray-900 dark:text-white mb-2">
                        Invitation acceptée !
                    </h1>
                    <p className="text-gray-600 dark:text-gray-400 mb-4">
                        Vous avez été rattaché au cabinet avec succès.
                    </p>
                    <p className="text-sm text-gray-500 dark:text-gray-500">
                        Redirection vers l'accueil...
                    </p>
                </div>
            </div>
        );
    }

    // Valid state - show accept button
    if (state === 'valid') {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 p-4">
                <div className="max-w-md w-full bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8">
                    <div className="text-center">
                        <div className="w-16 h-16 bg-blue-100 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i className="ri-mail-open-line text-3xl text-[#335FAD]"></i>
                        </div>
                        <h1 className="text-2xl font-semibold text-gray-900 dark:text-white mb-2">
                            Invitation valide
                        </h1>
                        <p className="text-gray-600 dark:text-gray-400 mb-6">
                            Vous avez été invité à rejoindre le cabinet{' '}
                            <span className="font-semibold text-gray-900 dark:text-white">
                                {inviteInfo?.broker_name || 'un cabinet'}
                            </span>
                            {inviteInfo?.owner_name && (
                                <>
                                    {' '}de{' '}
                                    <span className="font-semibold text-gray-900 dark:text-white">
                                        {inviteInfo.owner_name}
                                    </span>
                                </>
                            )}
                            {' '}en tant qu'
                            <span className="font-medium text-[#335FAD]">
                                {inviteInfo?.invite_type === 'apporteur' ? 'apporteur d\'affaires' : 'collaborateur'}
                            </span>.
                        </p>

                        {!user && (
                            <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-lg p-4 mb-6">
                                <p className="text-sm text-amber-800 dark:text-amber-200">
                                    <i className="ri-information-line mr-2"></i>
                                    Vous devez vous connecter ou créer un compte pour accepter cette invitation.
                                </p>
                            </div>
                        )}

                        {error && (
                            <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-lg p-4 mb-6">
                                <p className="text-sm text-red-700 dark:text-red-300">{error}</p>
                            </div>
                        )}

                        <button
                            onClick={handleAcceptInvite}
                            disabled={consuming}
                            className="w-full px-6 py-3 bg-[#335FAD] text-white rounded-lg font-medium hover:bg-[#2a4e8f] disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2"
                        >
                            {consuming ? (
                                <>
                                    <i className="ri-loader-4-line animate-spin"></i>
                                    Acceptation en cours...
                                </>
                            ) : user ? (
                                <>
                                    <i className="ri-check-line"></i>
                                    Accepter l'invitation
                                </>
                            ) : (
                                <>
                                    <i className="ri-login-box-line"></i>
                                    Se connecter pour accepter
                                </>
                            )}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // Error states (invalid, expired, consumed, error)
    const errorConfig = {
        invalid: {
            icon: 'ri-close-circle-line',
            iconBg: 'bg-red-100 dark:bg-red-900/20',
            iconColor: 'text-red-600 dark:text-red-400',
            title: 'Invitation invalide',
            description: 'Ce lien d\'invitation n\'est pas valide ou n\'existe pas.'
        },
        expired: {
            icon: 'ri-time-line',
            iconBg: 'bg-orange-100 dark:bg-orange-900/20',
            iconColor: 'text-orange-600 dark:text-orange-400',
            title: 'Invitation expirée',
            description: 'Ce lien d\'invitation a expiré. Demandez un nouveau lien au courtier.'
        },
        consumed: {
            icon: 'ri-checkbox-circle-line',
            iconBg: 'bg-gray-100 dark:bg-gray-700',
            iconColor: 'text-gray-600 dark:text-gray-400',
            title: 'Invitation déjà utilisée',
            description: 'Ce lien d\'invitation a atteint son nombre maximum d\'utilisations.'
        },
        error: {
            icon: 'ri-error-warning-line',
            iconBg: 'bg-red-100 dark:bg-red-900/20',
            iconColor: 'text-red-600 dark:text-red-400',
            title: 'Erreur',
            description: error || 'Une erreur est survenue lors de la validation de l\'invitation.'
        }
    };

    const config = errorConfig[state as keyof typeof errorConfig] || errorConfig.error;

    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 p-4">
            <div className="max-w-md w-full bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 text-center">
                <div className={`w-16 h-16 ${config.iconBg} rounded-full flex items-center justify-center mx-auto mb-4`}>
                    <i className={`${config.icon} text-3xl ${config.iconColor}`}></i>
                </div>
                <h1 className="text-2xl font-semibold text-gray-900 dark:text-white mb-2">
                    {config.title}
                </h1>
                <p className="text-gray-600 dark:text-gray-400 mb-6">
                    {config.description}
                </p>
                <button
                    onClick={() => router.push('/')}
                    className="px-6 py-2.5 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
                >
                    Retour à l'accueil
                </button>
            </div>
        </div>
    );
}

================
File: app/layout.tsx
================
import type { Metadata } from "next";
import { Geist, Geist_Mono, Pacifico } from "next/font/google";
import "./globals.css";
import AuthProvider from "../components/AuthProvider";
import { BrokerContextProvider } from "@/components/features/broker/BrokerContextProvider";

const pacifico = Pacifico({
  weight: '400',
  subsets: ['latin'],
  display: 'swap',
  variable: '--font-pacifico',
});

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "GMB Courtage - Espace Apporteur",
  description: "Plateforme d'apporteurs GMB Courtage",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="fr">
      <body className={`${geistSans.variable} ${geistMono.variable} ${pacifico.variable} font-sans`}>
        <AuthProvider>
          <BrokerContextProvider>
            {children}
          </BrokerContextProvider>
        </AuthProvider>
      </body>
    </html>
  )
}

================
File: app/mes-dossiers/page.tsx
================
'use client';

import { useState, useEffect, useMemo } from 'react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import ApporteurHeader from '../../components/ApporteurHeader';
import { DossiersService } from '@/lib/services/dossiers';
import { getStatutBadgeConfig, mapStatutForDisplay } from '@/lib/utils/statut-mapping';
import { formatDate } from '@/lib/utils/formatters';
import { useTheme } from '@/lib/hooks/useTheme';
import { useAuth } from '@/components/AuthProvider';
import { api } from '@/services/api';
import { EmptyState } from '@/components/ui/empty-state';

// Interfaces et types
interface DossierClient {
  nom: string;
  prenom: string;
  dateNaissance: string;
  profession: string;
  revenus: string;
  fumeur: boolean;
  email: string;
  telephone: string;
  adresse: string;
  conjoint?: {
    nom: string;
    prenom: string;
    dateNaissance: string;
    profession: string;
    revenus: string;
    fumeur: boolean;
  };
}

interface DossierDocument {
  name: string;
  uploaded: boolean;
  url?: string;
  file_path?: string;
  file_size?: number;
  file_type?: string;
  uploaded_at?: string;
}

interface Dossier {
  id: string;
  numero_dossier: string;
  apporteur_id: string | null;
  client_infos: Array<{
    client_nom: string;
    client_prenom: string;
    client_email: string;
    client_telephone: string | null;
  }>;
  pret_data: Array<{
    montant_capital: number;
    banque_preteuse: string;
    duree_mois: number;
    type_pret: string;
  }>;
  statut: string | null;
  type_dossier: string;
  date_creation: string | null;
  created_at: string | null;
  updated_at: string | null;
}

type SortField = 'date_creation' | 'updated_at' | 'statut' | 'numero_dossier' | 'clientNom';
type SortOrder = 'asc' | 'desc';
type FilterStatut = 'tous' | 'en_attente' | 'en_cours' | 'finalise' | 'refuse';

const DOSSIERS_PER_PAGE = 6; // Nombre de dossiers par page

export default function MesDossiersPage() {
  const router = useRouter();
  const { user, loading: authLoading } = useAuth();
  const [searchTerm, setSearchTerm] = useState('');
  const [filterStatut, setFilterStatut] = useState<FilterStatut>('tous');
  const [sortField, setSortField] = useState<SortField>('updated_at');
  const [sortOrder, setSortOrder] = useState<SortOrder>('desc');
  const [selectedDossiers, setSelectedDossiers] = useState<string[]>([]);
  const [showFilters, setShowFilters] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // ✅ Utilisation du hook centralisé pour le dark mode
  const { darkMode, isInitialized, toggleDarkMode } = useTheme();
  
  // États pour la pagination
  const [currentPage, setCurrentPage] = useState(1);

  // Données utilisateur et dossiers
  const [userData, setUserData] = useState({
    id: '',
    firstName: '',
    lastName: '',
    initials: '',
    role: 'Apporteur'
  });

  const [dossiers, setDossiers] = useState<Dossier[]>([]);

  // Fonction pour récupérer tous les dossiers de l'utilisateur connecté
  const fetchDossiers = async () => {
    setIsLoading(true);
    setError(null);
    try {
      // Récupérer le profil apporteur de l'utilisateur connecté
      const apporteur = await api.getCurrentApporteurProfile();
      if (apporteur) {
        setUserData({
          id: apporteur.id,
          firstName: apporteur.prenom,
          lastName: apporteur.nom,
          initials: `${apporteur.prenom.charAt(0)}${apporteur.nom.charAt(0)}`,
          role: 'Apporteur'
        });
        
        // Récupérer les dossiers de cet apporteur
        const dossiersData = await DossiersService.getDossiersByApporteur(apporteur.id);
        const normalized = (dossiersData || []).map((d: any) => ({
          ...d,
          statut: d.statut,
        }));
        setDossiers(normalized);
      } else {
        setError('Profil apporteur non trouvé');
      }
    } catch (error) {
      console.error('Erreur lors du chargement des dossiers:', error);
      setError('Erreur lors du chargement des dossiers');
    } finally {
      setIsLoading(false);
    }
  };

  // Chargement initial quand l'auth est prête
  useEffect(() => {
    if (isInitialized && !authLoading && user) {
      fetchDossiers();
    }
  }, [isInitialized, authLoading, user]);

  // Rafraîchir les dossiers quand la fenêtre reprend le focus
  useEffect(() => {
    const onFocus = () => {
      if (isInitialized && !authLoading && user) {
        fetchDossiers();
      }
    };
    window.addEventListener('focus', onFocus);
    return () => window.removeEventListener('focus', onFocus);
  }, [isInitialized, authLoading, user]);

  // Utiliser le computed_statut fourni par la vue côté DB (via service)
  const withComputedStatut = useMemo(() => {
    return dossiers.map((d) => {
      const src = (d as any).computed_statut || d.statut || 'en_attente'
      const mapped = src === 'devis_envoye' ? 'devis_disponible' : src
      return { ...d, computed_statut: mapped }
    })
  }, [dossiers]);

  // Filtrage et tri des dossiers
  const filteredAndSortedDossiers = useMemo(() => {
    let filtered = withComputedStatut;

    if (searchTerm) {
      const searchLower = searchTerm.toLowerCase();
      filtered = filtered.filter(dossier => 
        dossier.numero_dossier.toLowerCase().includes(searchLower) ||
        (dossier.client_infos && dossier.client_infos.length > 0 && (
          dossier.client_infos[0].client_nom.toLowerCase().includes(searchLower) ||
          dossier.client_infos[0].client_prenom.toLowerCase().includes(searchLower) ||
          dossier.client_infos[0].client_email.toLowerCase().includes(searchLower)
        ))
      );
    }

    if (filterStatut !== 'tous') {
      if (filterStatut === 'en_cours') {
        // En cours = tout sauf Finalisé
        filtered = filtered.filter(dossier => dossier.computed_statut !== 'finalise');
      } else {
        filtered = filtered.filter(dossier => dossier.computed_statut === filterStatut);
      }
    }

    filtered.sort((a, b) => {
      let aValue: any, bValue: any;

      switch (sortField) {
        case 'date_creation':
          aValue = new Date(a.date_creation || '');
          bValue = new Date(b.date_creation || '');
          break;
        case 'updated_at':
          aValue = new Date(a.updated_at || '');
          bValue = new Date(b.updated_at || '');
          break;
        case 'statut':
          aValue = (a as any).computed_statut || '';
          bValue = (b as any).computed_statut || '';
          break;
        case 'numero_dossier':
          aValue = a.numero_dossier;
          bValue = b.numero_dossier;
          break;
        case 'clientNom':
          aValue = a.client_infos && a.client_infos.length > 0 
            ? `${a.client_infos[0].client_nom} ${a.client_infos[0].client_prenom}`
            : '';
          bValue = b.client_infos && b.client_infos.length > 0 
            ? `${b.client_infos[0].client_nom} ${b.client_infos[0].client_prenom}`
            : '';
          break;
        default:
          return 0;
      }

      if (aValue < bValue) return sortOrder === 'asc' ? -1 : 1;
      if (aValue > bValue) return sortOrder === 'asc' ? 1 : -1;
      return 0;
    });

    return filtered;
  }, [dossiers, searchTerm, filterStatut, sortField, sortOrder]);

  // Pagination
  const totalPages = Math.ceil(filteredAndSortedDossiers.length / DOSSIERS_PER_PAGE);
  const startIndex = (currentPage - 1) * DOSSIERS_PER_PAGE;
  const endIndex = startIndex + DOSSIERS_PER_PAGE;
  const currentDossiers = filteredAndSortedDossiers.slice(startIndex, endIndex);

  // Réinitialiser la page quand les filtres changent
  useEffect(() => {
    setCurrentPage(1);
  }, [searchTerm, filterStatut, sortField, sortOrder]);

  // Fonction pour changer de page
  const handlePageChange = (page: number) => {
    setCurrentPage(page);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // Générer les numéros de pages à afficher
  const getPageNumbers = () => {
    const pages = [];
    const maxVisiblePages = 5;
    
    if (totalPages <= maxVisiblePages) {
      for (let i = 1; i <= totalPages; i++) {
        pages.push(i);
      }
    } else {
      if (currentPage <= 3) {
        for (let i = 1; i <= 4; i++) {
          pages.push(i);
        }
        pages.push('...');
        pages.push(totalPages);
      } else if (currentPage >= totalPages - 2) {
        pages.push(1);
        pages.push('...');
        for (let i = totalPages - 3; i <= totalPages; i++) {
          pages.push(i);
        }
      } else {
        pages.push(1);
        pages.push('...');
        for (let i = currentPage - 1; i <= currentPage + 1; i++) {
          pages.push(i);
        }
        pages.push('...');
        pages.push(totalPages);
      }
    }
    
    return pages;
  };

  // Statistiques
  const stats = useMemo(() => {
    const total = dossiers.length;
    const enCours = dossiers.filter(d => d.statut !== 'finalise').length;
    const finalises = dossiers.filter(d => d.statut === 'finalise').length;
    return { total, enCours, finalises };
  }, [dossiers]);

  // Gestionnaires d'événements
  const handleSort = (field: SortField) => {
    if (sortField === field) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortOrder('desc');
    }
  };

  const handleSelectDossier = (dossierId: string) => {
    setSelectedDossiers(prev => 
      prev.includes(dossierId) 
        ? prev.filter(id => id !== dossierId)
        : [...prev, dossierId]
    );
  };

  const handleSelectAll = () => {
    if (selectedDossiers.length === filteredAndSortedDossiers.length) {
      setSelectedDossiers([]);
    } else {
      setSelectedDossiers(filteredAndSortedDossiers.map(d => d.id));
    }
  };

  // NOUVELLE FONCTION: Gestion des clics sur les badges statistiques
  const handleStatBadgeClick = (statType: string) => {
    switch (statType) {
      case 'enCours':
        setFilterStatut('en_cours');
        break;
      case 'finalises':
        setFilterStatut('finalise');
        break;
      case 'total':
      default:
        setFilterStatut('tous');
        break;
    }
  };

  // ✅ MIGRATION COMPLÈTE - Utilisation des utilitaires centralisés

  // Charger les dossiers après initialisation du dark mode
  useEffect(() => {
    if (isInitialized) {
      fetchDossiers();
    }
  }, [isInitialized]);

  if (isLoading && !isInitialized) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#335FAD] mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Chargement de vos dossiers...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="text-red-500 text-4xl mb-4">⚠️</div>
          <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-2">Erreur de chargement</h2>
          <p className="text-gray-600 dark:text-gray-400 mb-4">{error}</p>
          <button 
            onClick={() => fetchDossiers()}
            className="bg-[#335FAD] text-white px-4 py-2 rounded-lg hover:bg-[#335FAD]/90"
          >
            Réessayer
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      {/* Header Général */}
      <ApporteurHeader 
        darkMode={darkMode} 
        setDarkMode={toggleDarkMode}
        userData={userData}
      />

      {/* Hero Section */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="px-4 sm:px-8 py-8 sm:py-12 max-w-7xl mx-auto">
          <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
            <div className="flex-1">
              <h1 className="text-3xl sm:text-4xl lg:text-5xl font-light text-gray-900 dark:text-white mb-4">
                Mes <span className="font-medium text-[#335FAD] dark:text-[#335FAD]/80">Dossiers</span>
              </h1>
              <p className="text-lg text-gray-600 dark:text-gray-400">
                Gérez et consultez tous vos dossiers clients
              </p>
            </div>
            <div className="flex justify-center lg:justify-end">
              <Link href="/nouveau-dossier" className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-8 py-4 rounded-2xl font-medium transition-all duration-200 hover:shadow-lg cursor-pointer flex items-center space-x-3 whitespace-nowrap">
                <i className="ri-add-line text-xl"></i>
                <span>Nouveau Dossier</span>
              </Link>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-7xl mx-auto">
        {/* Statistiques - BADGES CLIQUABLES */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-8">
          <div 
            onClick={() => handleStatBadgeClick('total')}
            className={`bg-white dark:bg-gray-800 rounded-2xl p-4 sm:p-6 border border-gray-200 dark:border-gray-700 cursor-pointer transition-all duration-200 hover:shadow-md dark:hover:shadow-gray-900/20 ${
              filterStatut === 'tous' ? 'ring-2 ring-[#335FAD] bg-[#335FAD]/5 dark:bg-[#335FAD]/10' : ''
            }`}
          >
            <div className="flex items-center justify-between">
              <div>
                <p className="text-2xl sm:text-3xl font-light text-gray-900 dark:text-white">{stats.total}</p>
                <p className="text-sm text-gray-500 dark:text-gray-400">Total</p>
              </div>
              <div className="w-10 h-10 bg-indigo-100 dark:bg-indigo-900/30 rounded-xl flex items-center justify-center">
                <i className="ri-file-list-line text-[#335FAD] dark:text-[#335FAD]/80"></i>
              </div>
            </div>
          </div>

          <div 
            onClick={() => handleStatBadgeClick('enCours')}
            className={`bg-white dark:bg-gray-800 rounded-2xl p-4 sm:p-6 border border-gray-200 dark:border-gray-700 cursor-pointer transition-all duration-200 hover:shadow-md dark:hover:shadow-gray-900/20 ${
              filterStatut === 'en_cours' ? 'ring-2 ring-yellow-500 bg-yellow-50 dark:bg-yellow-900/20' : ''
            }`}
          >
            <div className="flex items-center justify-between">
              <div>
                <p className="text-2xl sm:text-3xl font-light text-gray-900 dark:text-white">{stats.enCours}</p>
                <p className="text-sm text-gray-500 dark:text-gray-400">En cours</p>
              </div>
              <div className="w-10 h-10 bg-yellow-100 dark:bg-yellow-900/30 rounded-xl flex items-center justify-center">
                <i className="ri-loader-2-line text-yellow-600 dark:text-yellow-400"></i>
              </div>
            </div>
          </div>

          <div 
            onClick={() => handleStatBadgeClick('finalises')}
            className={`bg-white dark:bg-gray-800 rounded-2xl p-4 sm:p-6 border border-gray-200 dark:border-gray-700 cursor-pointer transition-all duration-200 hover:shadow-md dark:hover:shadow-gray-900/20 ${
              filterStatut === 'finalise' ? 'ring-2 ring-purple-500 bg-purple-50 dark:bg-purple-900/20' : ''
            }`}
          >
            <div className="flex items-center justify-between">
              <div>
                <p className="text-2xl sm:text-3xl font-light text-gray-900 dark:text-white">{stats.finalises}</p>
                <p className="text-sm text-gray-500 dark:text-gray-400">Finalisés</p>
              </div>
              <div className="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-xl flex items-center justify-center">
                <i className="ri-check-double-line text-purple-600 dark:text-purple-400"></i>
              </div>
            </div>
          </div>
        </div>

        {/* Filtres et Recherche */}
        <div className="bg-white dark:bg-gray-800 rounded-2xl p-4 sm:p-6 border border-gray-200 dark:border-gray-700 mb-8">
          <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            {/* Recherche */}
            <div className="flex-1 max-w-md">
              <div className="relative">
                <i className="ri-search-line absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500"></i>
                <input
                  type="text"
                  placeholder="Rechercher par nom, email, adresse..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full pl-10 pr-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 text-sm"
                />
              </div>
            </div>

            {/* Bouton Filtres Mobile */}
            <button
              onClick={() => setShowFilters(!showFilters)}
              className="lg:hidden w-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2"
            >
              <i className="ri-filter-line"></i>
              <span>Filtres et Tri</span>
            </button>

            {/* Filtres Desktop */}
            <div className="hidden lg:flex items-center space-x-4">
              {/* Filtre par statut */}
              <Select value={filterStatut} onValueChange={(v) => setFilterStatut(v as FilterStatut)}>
                <SelectTrigger className="w-[200px]">
                  <SelectValue placeholder="Tous les statuts" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="tous">Tous les statuts</SelectItem>
                  <SelectItem value="en_attente">En attente</SelectItem>
                  <SelectItem value="en_cours">En cours</SelectItem>
                  <SelectItem value="finalise">Finalisés</SelectItem>
                  <SelectItem value="refuse">Refusés</SelectItem>
                </SelectContent>
              </Select>

              {/* Tri */}
              <Select
                value={`${sortField}-${sortOrder}`}
                onValueChange={(v) => {
                  const [field, order] = v.split('-');
                  setSortField(field as SortField);
                  setSortOrder(order as SortOrder);
                }}
              >
                <SelectTrigger className="w-[220px]">
                  <SelectValue placeholder="Trier par" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="updated_at-desc">Plus récents</SelectItem>
                  <SelectItem value="updated_at-asc">Plus anciens</SelectItem>
                  <SelectItem value="date_creation-desc">Date création ↓</SelectItem>
                  <SelectItem value="date_creation-asc">Date création ↑</SelectItem>
                  <SelectItem value="statut-asc">Statut A-Z</SelectItem>
                  <SelectItem value="statut-desc">Statut Z-A</SelectItem>
                  <SelectItem value="clientNom-asc">Client A-Z</SelectItem>
                  <SelectItem value="clientNom-desc">Client Z-A</SelectItem>
                  <SelectItem value="numero_dossier-asc">N° Dossier ↑</SelectItem>
                  <SelectItem value="numero_dossier-desc">N° Dossier ↓</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>

          {/* Filtres Mobile (Repliable) */}
          {showFilters && (
            <div className="lg:hidden mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Filtrer par statut
                </label>
                <Select value={filterStatut} onValueChange={(v) => setFilterStatut(v as FilterStatut)}>
                  <SelectTrigger className="w-full">
                    <SelectValue placeholder="Tous les statuts" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="tous">Tous les statuts</SelectItem>
                    <SelectItem value="en_attente">En attente</SelectItem>
                    <SelectItem value="en_cours">En cours</SelectItem>
                    <SelectItem value="finalise">Finalisés</SelectItem>
                    <SelectItem value="refuse">Refusés</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Trier par
                </label>
                <Select
                  value={`${sortField}-${sortOrder}`}
                  onValueChange={(v) => {
                    const [field, order] = v.split('-');
                    setSortField(field as SortField);
                    setSortOrder(order as SortOrder);
                  }}
                >
                  <SelectTrigger className="w-full">
                    <SelectValue placeholder="Trier par" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="updated_at-desc">Plus récents</SelectItem>
                    <SelectItem value="updated_at-asc">Plus anciens</SelectItem>
                    <SelectItem value="date_creation-desc">Date création ↓</SelectItem>
                    <SelectItem value="date_creation-asc">Date création ↑</SelectItem>
                    <SelectItem value="statut-asc">Statut A-Z</SelectItem>
                    <SelectItem value="statut-desc">Statut Z-A</SelectItem>
                    <SelectItem value="clientNom-asc">Client A-Z</SelectItem>
                    <SelectItem value="clientNom-desc">Client Z-A</SelectItem>
                    <SelectItem value="numero_dossier-asc">N° Dossier ↑</SelectItem>
                    <SelectItem value="numero_dossier-desc">N° Dossier ↓</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          )}
        </div>

        {/* Liste des Dossiers */}
        {filteredAndSortedDossiers.length === 0 ? (
          <div className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700">
            {searchTerm || filterStatut !== 'tous' ? (
              <EmptyState
                icon="ri-search-line"
                title="Aucun résultat"
                description="Aucun dossier ne correspond à vos critères de recherche. Essayez de modifier vos filtres ou votre recherche."
                secondaryAction={{
                  label: "Réinitialiser les filtres",
                  onClick: () => {
                    setSearchTerm('');
                    setFilterStatut('tous');
                  }
                }}
              />
            ) : (
              <EmptyState
                icon="ri-folder-add-line"
                title="Commencez votre premier dossier"
                description="Vous n'avez pas encore de dossier. Créez-en un pour démarrer et suivre vos demandes d'assurance."
                action={{
                  label: "Créer mon premier dossier",
                  href: "/nouveau-dossier"
                }}
              />
            )}
          </div>
        ) : (
          <>
            <div className="space-y-4">
              {currentDossiers.map((dossier) => {
                // ✅ Utilisation de la source de vérité unique
                const statutCanonique = (dossier as any).computed_statut || dossier.statut || 'en_attente';
                const statutConfig = getStatutBadgeConfig(statutCanonique);
                const clientInfo = dossier.client_infos && dossier.client_infos.length > 0 ? dossier.client_infos[0] : null;
                const pretInfo = dossier.pret_data && dossier.pret_data.length > 0 ? dossier.pret_data[0] : null;
                
                return (
                  <div key={dossier.id} className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 hover:shadow-md dark:hover:shadow-gray-900/20 transition-all duration-200">
                    <div className="p-4 sm:p-6">
                      <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        {/* Informations principales */}
                        <div className="flex-1 min-w-0">
                          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
                            <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3">
                              <h3 className="text-2xl font-medium text-gray-900 dark:text-white">
                                {clientInfo ? `${clientInfo.client_prenom} ${clientInfo.client_nom}` : 'Client inconnu'}
                              </h3>
                              <span className="text-sm text-gray-500 dark:text-gray-400">
                                {dossier.numero_dossier}
                              </span>
                            </div>
                            
                            <div className="text-sm text-gray-500 dark:text-gray-400">
                              Modifié le {dossier.updated_at ? formatDate(dossier.updated_at, true) : 'N/A'}
                            </div>
                          </div>

                          <div className="flex flex-wrap items-center gap-2 mb-4">
                            <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${statutConfig?.color || 'bg-gray-100 text-gray-800'}`}>
                              <i className={`${statutConfig?.icon || 'ri-question-line'} mr-1`}></i>
                              {statutConfig?.text || 'Inconnu'}
                            </span>
                            {dossier.type_dossier === 'couple' && (
                              <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-[#335FAD]/10 dark:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD] border border-[#335FAD]/20 dark:border-[#335FAD]/70">
                                <i className="ri-heart-line mr-1"></i>
                                Couple
                              </span>
                            )}
                          </div>

                          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                            <div>
                              <span className="text-gray-500 dark:text-gray-400">Email :</span>
                              <p className="font-medium text-gray-900 dark:text-white truncate">
                                {clientInfo?.client_email || 'N/A'}
                              </p>
                            </div>
                            
                            <div>
                              <span className="text-gray-500 dark:text-gray-400">Montant :</span>
                              <p className="font-medium text-gray-900 dark:text-white">
                                {pretInfo ? `${pretInfo.montant_capital.toLocaleString()}€` : 'N/A'}
                              </p>
                            </div>
                          </div>
                        </div>

                        {/* Actions */}
                        <div className="flex items-center justify-end space-x-2">
                          <Link
                            href={`/dossier/${dossier.id}`}
                            className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer flex items-center space-x-2"
                          >
                            <i className="ri-eye-line text-sm"></i>
                            <span className="hidden sm:inline">Voir</span>
                          </Link>
                          
                          <button className="bg-[#335FAD]/10 dark:bg-[#335FAD]/20 hover:bg-[#335FAD]/20 dark:hover:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD]/80 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer flex items-center space-x-2">
                            <i className="ri-download-line text-sm"></i>
                            <span className="hidden sm:inline">Export</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Pagination */}
            {totalPages > 1 && (
              <div className="mt-8 flex flex-col sm:flex-row items-center justify-between gap-4">
                {/* Info pagination */}
                <div className="text-sm text-gray-500 dark:text-gray-400">
                  Affichage de {startIndex + 1} à {Math.min(endIndex, filteredAndSortedDossiers.length)} sur {filteredAndSortedDossiers.length} dossiers
                </div>

                {/* Contrôles pagination */}
                <div className="flex items-center space-x-2">
                  {/* Bouton Précédent */}
                  <button
                    onClick={() => handlePageChange(currentPage - 1)}
                    disabled={currentPage === 1}
                    className="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
                  >
                    <i className="ri-arrow-left-line"></i>
                  </button>

                  {/* Numéros de page */}
                  {getPageNumbers().map((page, index) => (
                    <button
                      key={index}
                      onClick={() => typeof page === 'number' ? handlePageChange(page) : null}
                      disabled={page === '...'}
                      className={`px-3 py-2 text-sm border rounded-lg cursor-pointer ${
                        page === currentPage
                          ? 'bg-[#335FAD] border-[#335FAD] text-white'
                          : page === '...'
                          ? 'border-transparent text-gray-400 dark:text-gray-500 cursor-default'
                          : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'
                      }`}
                    >
                      {page}
                    </button>
                  ))}

                  {/* Bouton Suivant */}
                  <button
                    onClick={() => handlePageChange(currentPage + 1)}
                    disabled={currentPage === totalPages}
                    className="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
                  >
                    <i className="ri-arrow-right-line"></i>
                  </button>
                </div>
              </div>
            )}
          </>
        )}

        {/* Stats en bas (si pas de pagination) */}
        {totalPages <= 1 && filteredAndSortedDossiers.length > 0 && (
          <div className="mt-8 text-center">
            <p className="text-sm text-gray-500 dark:text-gray-400">
              Affichage de {filteredAndSortedDossiers.length} dossier{filteredAndSortedDossiers.length > 1 ? 's' : ''} sur {dossiers.length} au total
            </p>
          </div>
        )}
      </main>
    </div>
  );
}

================
File: app/not-found.tsx
================
'use client';

import Link from 'next/link';
import { useState, useEffect } from 'react';
import { usePathname } from 'next/navigation';
import ApporteurHeader from '../components/ApporteurHeader';
import AdminHeader from '../components/AdminHeader';

export default function NotFound() {
  const [darkMode, setDarkMode] = useState(false);
  const pathname = usePathname();

  // Déterminer si c'est un utilisateur admin ou apporteur basé sur l'URL
  const isAdmin = pathname?.startsWith('/admin');

  // Données mock pour les utilisateurs
  const apporteurData = {
    id: 'mock-apporteur-id',
    firstName: 'Jean',
    lastName: 'Dupont',
    initials: 'JD',
    role: 'Apporteur'
  };

  const adminData = {
    id: 'mock-admin-id',
    firstName: 'Marie',
    lastName: 'Martin',
    initials: 'MM',
    role: 'Administrateur'
  };

  // Détection du mode sombre
  useEffect(() => {
    const isDark = document.documentElement.classList.contains('dark');
    setDarkMode(isDark);
    
    // Appliquer le mode sombre au document
    if (darkMode) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, [darkMode]);

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      {/* Header adaptatif */}
      {isAdmin ? (
        <AdminHeader 
          darkMode={darkMode}
          setDarkMode={setDarkMode}
          adminData={adminData}
        />
      ) : (
        <ApporteurHeader 
          darkMode={darkMode}
          setDarkMode={setDarkMode}
          userData={apporteurData}
        />
      )}

      {/* Contenu 404 */}
      <div className="flex items-center justify-center px-4 sm:px-6 lg:px-8 py-12">
        <div className="max-w-lg w-full text-center">
          {/* Illustration d'erreur */}
          <div className="mb-8">
            <div className="relative mx-auto w-64 h-64 mb-8">
              {/* Image générée par Stable Diffusion pour illustration 404 */}
              <img 
                src="https://readdy.ai/api/search-image?query=Modern%20minimalist%20illustration%20of%20a%20confused%20person%20looking%20at%20a%20map%20or%20searching%20with%20magnifying%20glass%2C%20clean%20geometric%20shapes%2C%20soft%20blue%20and%20gray%20color%20palette%2C%20professional%20business%20style%2C%20simple%20background%20with%20subtle%20gradients&width=400&height=400&seq=404error&orientation=squarish"
                alt="Page non trouvée"
                className="w-full h-full object-cover rounded-2xl shadow-lg"
              />
              
              {/* Badge 404 superposé */}
              <div className="absolute -top-4 -right-4 w-20 h-20 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg transform rotate-12">
                <span className="text-2xl font-bold">404</span>
              </div>
            </div>
          </div>

          {/* Contenu principal */}
          <div className="space-y-6">
            {/* Titre principal */}
            <div className="space-y-2">
              <h1 className="text-4xl sm:text-5xl font-bold text-gray-900 dark:text-white">
                Oops !
              </h1>
              <h2 className="text-xl sm:text-2xl font-semibold text-gray-700 dark:text-gray-300">
                Page non trouvée
              </h2>
            </div>

            {/* Message d'erreur */}
            <div className="space-y-4">
              <p className="text-lg text-gray-600 dark:text-gray-400 leading-relaxed">
                La page que vous recherchez n'existe pas ou vous n'avez pas les autorisations nécessaires pour y accéder.
              </p>
              
              <div className="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <div className="flex items-start space-x-3">
                  <div className="w-8 h-8 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i className="ri-information-line text-amber-600 dark:text-amber-400"></i>
                  </div>
                  <div className="text-left">
                    <p className="text-sm font-medium text-gray-900 dark:text-white mb-1">
                      Causes possibles
                    </p>
                    <ul className="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                      <li>• L'URL a été mal saisie ou est obsolète</li>
                      <li>• Vous n'avez pas les droits d'accès requis</li>
                      <li>• La page a été déplacée ou supprimée</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Footer */}
          <div className="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
            <div className="flex items-center justify-center space-x-2 text-sm text-gray-500 dark:text-gray-400">
              <div className="w-6 h-6 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg flex items-center justify-center">
                <i className="ri-handshake-line text-[#335FAD] dark:text-[#335FAD]/80 text-xs"></i>
              </div>
              <span className="font-['Pacifico'] text-[#335FAD] dark:text-[#335FAD]/80">GMB Courtage</span>
              <span>•</span>
              <span>{isAdmin ? 'Espace Admin' : 'Espace Apporteur'}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

================
File: app/nouveau-dossier/page.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { Suspense } from 'react';
import DossierTypeSelection from '../../components/DossierTypeSelection';
import ClientInfoForm from '../../components/ClientInfoForm';
import DocumentUpload from '../../components/DocumentUpload';
import DossierProgress from '../../components/DossierProgress';

// Types pour le dossier
export type DossierType = 'seul' | 'couple';

export interface ClientInfo {
  // Client principal
  civilite: string;
  nom: string;
  prenom: string;
  nom_naissance: string;
  dateNaissance: string;
  categorie_professionnelle: number;
  revenus: string;
  fumeur: boolean;
  email: string;
  telephone: string;
  adresse: string;
  
  // Client conjoint (si couple)
  conjoint?: {
    civilite: string;
    nom: string;
    prenom: string;
    nom_naissance: string;
    dateNaissance: string;
    categorie_professionnelle: number;
    fumeur: boolean;
  };
}

export interface DocumentsInfo {
  offrePret: File | null;
  tableauAmortissement: File | null;
  carteIdentite: File | null;
  carteIdentiteConjoint?: File | null;
}

// Interface DossierData mise à jour
export interface DossierData {
  type: DossierType;
  clientInfo: ClientInfo | null;
  documents: DocumentsInfo;
  commentaire?: string;
  numeroDossier?: string;
}

// Composant principal avec gestion des paramètres URL
function NouveauDossierContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [currentStep, setCurrentStep] = useState(1);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showIncompleteWarning, setShowIncompleteWarning] = useState(false);
  
  const [dossierData, setDossierData] = useState<DossierData>({
    type: 'seul',
    clientInfo: null,
    documents: {
      offrePret: null,
      tableauAmortissement: null,
      carteIdentite: null
    },
    commentaire: ''
  });

  // EFFET: Vérifier les paramètres URL pour l'étape
  useEffect(() => {
    const step = searchParams.get('step');
    if (step) {
      const stepNumber = parseInt(step, 10);
      if (stepNumber >= 1 && stepNumber <= 3) {
        setCurrentStep(stepNumber);
      }
    }
  }, [searchParams]);

  // Navigation intelligente vers la page précédente
  const handleGoBack = () => {
    if (window.history.length > 1) {
      router.back();
    } else {
      router.push('/');
    }
  };

  // Navigation entre les étapes
  const nextStep = () => {
    if (currentStep < 3) {
      setCurrentStep(currentStep + 1);
    }
  };

  const prevStep = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
    }
  };

  // Mise à jour du type de dossier
  const handleTypeSelection = (type: DossierType) => {
    setDossierData(prev => ({
      ...prev,
      type,
      documents: {
        ...prev.documents,
        carteIdentiteConjoint: type === 'couple' ? null : undefined
      }
    }));
    nextStep();
  };

  // Mise à jour des informations client
  const handleClientInfoUpdate = (clientInfo: ClientInfo) => {
    setDossierData(prev => ({
      ...prev,
      clientInfo
    }));
    nextStep();
  };

  // Mise à jour des documents
  const handleDocumentsUpdate = (documents: DocumentsInfo) => {
    setDossierData(prev => ({
      ...prev,
      documents
    }));
  };

  // Mise à jour du commentaire
  const handleCommentaireUpdate = (commentaire: string) => {
    setDossierData(prev => ({
      ...prev,
      commentaire
    }));
  };

  // Vérifier si le dossier est complet
  const isDossierComplete = () => {
    // Vérifier les informations client
    if (!dossierData.clientInfo) return false;
    
    const clientInfo = dossierData.clientInfo;
    const requiredClientFields = ['civilite', 'nom', 'prenom', 'nom_naissance', 'dateNaissance', 'email', 'telephone'];
    
    for (const field of requiredClientFields) {
      if (!clientInfo[field as keyof ClientInfo] || String(clientInfo[field as keyof ClientInfo]).trim() === '') {
        return false;
      }
    }
    
    // Vérifier categorie_professionnelle séparément (c'est un number)
    if (!clientInfo.categorie_professionnelle || clientInfo.categorie_professionnelle === 0) {
      return false;
    }

    // Vérifier les informations conjoint si couple
    if (dossierData.type === 'couple' && clientInfo.conjoint) {
      const requiredConjointFields = ['civilite', 'nom', 'prenom', 'nom_naissance', 'dateNaissance'];
      for (const field of requiredConjointFields) {
        if (!clientInfo.conjoint[field as keyof typeof clientInfo.conjoint] || 
            String(clientInfo.conjoint[field as keyof typeof clientInfo.conjoint]).trim() === '') {
          return false;
        }
      }
      
      // Vérifier categorie_professionnelle du conjoint
      if (!clientInfo.conjoint.categorie_professionnelle || clientInfo.conjoint.categorie_professionnelle === 0) {
        return false;
      }
    }

    // Vérifier les documents obligatoires
    const requiredDocs = ['offrePret', 'tableauAmortissement', 'carteIdentite'];
    if (dossierData.type === 'couple') {
      requiredDocs.push('carteIdentiteConjoint');
    }

    for (const doc of requiredDocs) {
      if (!dossierData.documents[doc as keyof DocumentsInfo]) {
        return false;
      }
    }

    return true;
  };

  // Obtenir la liste des éléments manquants
  const getMissingElements = () => {
    const missing: string[] = [];

    // Vérifier les informations client
    if (!dossierData.clientInfo) {
      missing.push('Informations client');
    } else {
      const clientInfo = dossierData.clientInfo;
      const requiredClientFields = [
        { key: 'civilite', label: 'Civilité' },
        { key: 'nom', label: 'Nom' },
        { key: 'prenom', label: 'Prénom' },
        { key: 'nom_naissance', label: 'Nom de naissance' },
        { key: 'dateNaissance', label: 'Date de naissance' },
        { key: 'email', label: 'Email' },
        { key: 'telephone', label: 'Téléphone' }
      ];
      
      for (const field of requiredClientFields) {
        if (!clientInfo[field.key as keyof ClientInfo] || String(clientInfo[field.key as keyof ClientInfo]).trim() === '') {
          missing.push(field.label);
        }
      }
      
      // Vérifier catégorie professionnelle
      if (!clientInfo.categorie_professionnelle || clientInfo.categorie_professionnelle === 0) {
        missing.push('Catégorie professionnelle');
      }

      // Vérifier les informations conjoint si couple
      if (dossierData.type === 'couple') {
        if (!clientInfo.conjoint) {
          missing.push('Informations conjoint');
        } else {
          const requiredConjointFields = [
            { key: 'civilite', label: 'Civilité conjoint' },
            { key: 'nom', label: 'Nom conjoint' },
            { key: 'prenom', label: 'Prénom conjoint' },
            { key: 'nom_naissance', label: 'Nom de naissance conjoint' },
            { key: 'dateNaissance', label: 'Date de naissance conjoint' }
          ];
          for (const field of requiredConjointFields) {
            const value = clientInfo.conjoint[field.key as keyof typeof clientInfo.conjoint];
            if (!value || String(value).trim() === '') {
              missing.push(field.label);
            }
          }
          
          // Vérifier catégorie professionnelle du conjoint
          if (!clientInfo.conjoint.categorie_professionnelle || clientInfo.conjoint.categorie_professionnelle === 0) {
            missing.push('Catégorie professionnelle conjoint');
          }
        }
      }
    }

    // Vérifier les documents obligatoires
    const requiredDocs = [
      { key: 'offrePret', label: 'Offre de Prêt' },
      { key: 'tableauAmortissement', label: "Tableau d'Amortissement" },
      { key: 'carteIdentite', label: "Carte d'Identité (Emprunteur)" }
    ];

    if (dossierData.type === 'couple') {
      requiredDocs.push({ key: 'carteIdentiteConjoint', label: "Carte d'Identité (Conjoint)" });
    }

    for (const doc of requiredDocs) {
      if (!dossierData.documents[doc.key as keyof DocumentsInfo]) {
        missing.push(doc.label);
      }
    }

    return missing;
  };

  // Déclencher la soumission du dossier
  const handleSubmitAttempt = () => {
    if (isDossierComplete()) {
      handleFinalSubmit();
    } else {
      setShowIncompleteWarning(true);
    }
  };

  // Fermer l'avertissement
  const handleCloseWarning = () => {
    setShowIncompleteWarning(false);
  };

  // Confirmer la soumission d'un dossier incomplet
  const handleConfirmIncompleteSubmit = () => {
    setShowIncompleteWarning(false);
    handleFinalSubmit();
  };

  // Soumission finale du dossier
  const handleFinalSubmit = async () => {
    setIsSubmitting(true);
    
    try {
      const isComplete = isDossierComplete();
      
      // Préparer les données pour l'envoi
      const formData = new FormData();
      
      // Ajouter les données de base
      formData.append('type', dossierData.type);
      formData.append('clientInfo', JSON.stringify(dossierData.clientInfo));
      formData.append('commentaire', dossierData.commentaire || '');
      formData.append('isComplete', isComplete.toString());
      formData.append('createdByAdmin', 'false');
      
      // Ajouter les fichiers
      if (dossierData.documents.offrePret) {
        formData.append('documents.offrePret', dossierData.documents.offrePret);
      }
      if (dossierData.documents.tableauAmortissement) {
        formData.append('documents.tableauAmortissement', dossierData.documents.tableauAmortissement);
      }
      if (dossierData.documents.carteIdentite) {
        formData.append('documents.carteIdentite', dossierData.documents.carteIdentite);
      }
      if (dossierData.documents.carteIdentiteConjoint) {
        formData.append('documents.carteIdentiteConjoint', dossierData.documents.carteIdentiteConjoint);
      }
      
      console.log('[Client] Envoi des données dossier avec FormData');
      console.log('[Client] Fichiers:', {
        offrePret: dossierData.documents.offrePret?.name,
        tableauAmortissement: dossierData.documents.tableauAmortissement?.name,
        carteIdentite: dossierData.documents.carteIdentite?.name,
        carteIdentiteConjoint: dossierData.documents.carteIdentiteConjoint?.name
      });
      
      const response = await fetch('/api/dossiers/create', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error('[Client] Erreur API:', errorData);
        throw new Error(errorData.error || 'Erreur lors de la création du dossier');
      }

      const result = await response.json();
      
      // Redirection vers la page de confirmation avec l'ID du dossier
      router.push(`/dossier-confirme/${result.dossier.id}`);
      
    } catch (error) {
      console.error('Erreur lors de la création du dossier:', error);
      alert(`Erreur lors de la création du dossier: ${error instanceof Error ? error.message : 'Erreur inconnue'}`);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      {/* Header */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40">
        <div className="px-4 sm:px-8 py-4 sm:py-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <button 
                onClick={handleGoBack}
                className="w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg flex items-center justify-center transition-colors cursor-pointer"
                title="Retour à la page précédente"
              >
                <i className="ri-arrow-left-line text-gray-600 dark:text-gray-300"></i>
              </button>
              <div>
                <h1 className="text-xl font-medium text-gray-900 dark:text-white">
                  Nouveau Dossier Client
                </h1>
                <p className="text-sm text-gray-500 dark:text-gray-400">
                  Processus guidé en 3 étapes
                </p>
              </div>
            </div>
            
            {/* Progress indicator */}
            <div className="hidden sm:block">
              <DossierProgress currentStep={currentStep} />
            </div>
          </div>
        </div>
      </div>

      {/* Mobile Progress - Centré */}
      <div className="sm:hidden px-4 py-4 bg-gray-50 dark:bg-gray-800/50">
        <DossierProgress currentStep={currentStep} />
      </div>

      {/* Main Content */}
      <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-4xl mx-auto">
        {currentStep === 1 && (
          <DossierTypeSelection 
            selectedType={dossierData.type}
            onTypeSelect={handleTypeSelection}
          />
        )}
        
        {currentStep === 2 && (
          <ClientInfoForm 
            dossierType={dossierData.type}
            initialData={dossierData.clientInfo}
            onSubmit={handleClientInfoUpdate}
            onBack={prevStep}
          />
        )}
        
        {currentStep === 3 && (
          <DocumentUpload 
            dossierType={dossierData.type}
            documents={dossierData.documents}
            onDocumentsUpdate={handleDocumentsUpdate}
            onBack={prevStep}
            onSubmit={handleSubmitAttempt}
            isSubmitting={isSubmitting}
            commentaire={dossierData.commentaire}
            onCommentaireChange={handleCommentaireUpdate}
          />
        )}
      </main>

      {/* Modal d'avertissement pour dossier incomplet */}
      {showIncompleteWarning && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            {/* Contenu entièrement scrollable */}
            <div className="p-6">
              <div className="text-center mb-6">
                <div className="w-16 h-16 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                  <i className="ri-alert-line text-amber-600 dark:text-amber-400 text-2xl"></i>
                </div>
                <h3 className="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                  Dossier incomplet
                </h3>
                <p className="text-gray-600 dark:text-gray-400">
                  Votre dossier ne contient pas toutes les informations obligatoires. 
                  Voulez-vous quand même l'envoyer ?
                </p>
              </div>

              {/* Liste des éléments manquants */}
              <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-xl p-4 mb-6">
                <h4 className="font-medium text-amber-800 dark:text-amber-400 mb-3">
                  Éléments manquants :
                </h4>
                <div className="max-h-32 overflow-y-auto">
                  <ul className="text-sm text-amber-700 dark:text-amber-300 space-y-1">
                    {getMissingElements().map((element, index) => (
                      <li key={index} className="flex items-start">
                        <i className="ri-close-circle-line mr-2 text-amber-600 dark:text-amber-400 mt-0.5 flex-shrink-0"></i>
                        <span>{element}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>

              <div className="bg-[#335FAD]/5 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/70 rounded-xl p-4 mb-6">
                <div className="flex items-start">
                  <i className="ri-information-line text-[#335FAD] dark:text-[#335FAD] mr-3 mt-0.5 flex-shrink-0"></i>
                  <div className="text-sm text-[#335FAD] dark:text-[#335FAD]/80">
                    <p className="font-medium mb-1">À noter :</p>
                    <p>
                      Les dossiers incomplets peuvent prendre plus de temps à traiter. 
                      Nos équipes vous recontacteront pour obtenir les informations manquantes.
                    </p>
                  </div>
                </div>
              </div>

              {/* Actions */}
              <div className="flex flex-col gap-3">
                <button
                  onClick={handleCloseWarning}
                  className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-3 rounded-xl font-medium transition-colors whitespace-nowrap"
                >
                  Compléter le dossier
                </button>
                <button
                  onClick={handleConfirmIncompleteSubmit}
                  disabled={isSubmitting}
                  className="bg-amber-600 hover:bg-amber-700 text-white px-4 py-3 rounded-xl font-medium transition-colors disabled:opacity-50 whitespace-nowrap"
                >
                  {isSubmitting ? (
                    <>
                      <i className="ri-loader-4-line mr-2 animate-spin inline"></i>
                      Envoi...
                    </>
                  ) : (
                    'Envoyer quand même'
                  )}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

    </div>
  );
}

// Composant wrapper avec Suspense pour useSearchParams
export default function NouveauDossierPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Initialisation...</p>
        </div>
      </div>
    }>
      <NouveauDossierContent />
    </Suspense>
  );
}

================
File: app/onboarding/page.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { supabase } from '../../lib/supabase';
import { useRouter } from 'next/navigation';

export default function OnboardingPage() {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [user, setUser] = useState<any>(null);
  const [cguAccepted, setCguAccepted] = useState(false);
  const [darkMode, setDarkMode] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);

  const router = useRouter();

  useEffect(() => {
    // Initialiser le mode sombre
    if (typeof window !== 'undefined' && !isInitialized) {
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      setDarkMode(savedDarkMode);
      
      if (savedDarkMode) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      
      setIsInitialized(true);
    }

    const getUser = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        router.push('/connexion');
        return;
      }
      setUser(user);

      // Vérifier si les CGU ont déjà été acceptées
      const { data: profile } = await supabase
        .from('apporteur_profiles')
        .select('cgu_accepted_at')
        .eq('user_id', user.id)
        .single();

      if (profile?.cgu_accepted_at) {
        router.push('/');
      }
    };

    getUser();
  }, [isInitialized]);

  // Gestionnaire du mode sombre
  const handleDarkModeToggle = () => {
    const newDarkMode = !darkMode;
    setDarkMode(newDarkMode);
    
    if (typeof window !== 'undefined') {
      if (newDarkMode) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('darkMode', 'true');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('darkMode', 'false');
      }
    }
  };

  const handleAcceptCGU = async () => {
    if (!cguAccepted) {
      setError('Vous devez accepter les Conditions Générales d\'Utilisation pour continuer');
      return;
    }

    setLoading(true);
    setError('');

    try {
      const { error } = await supabase
        .from('apporteur_profiles')
        .update({
          cgu_accepted_at: new Date().toISOString()
        })
        .eq('user_id', user.id);

      if (error) throw error;

      router.push('/');
    } catch (error: any) {
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  if (!user || !isInitialized) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      {/* Header similaire à ApporteurHeader */}
      <header className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50 transition-colors duration-300">
        <div className="px-4 sm:px-8 py-4 sm:py-6">
          <div className="flex items-center justify-between">
            {/* Logo */}
            <div className="flex items-center space-x-4">
              <div className="w-10 h-10 sm:w-12 sm:h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-xl flex items-center justify-center">
                <i className="ri-handshake-line text-[#335FAD] dark:text-[#335FAD]/80 text-lg sm:text-xl"></i>
              </div>
              <div>
                <h1 className="font-['Pacifico'] text-lg sm:text-xl text-gray-900 dark:text-white">GMB Courtage</h1>
                <p className="text-xs text-gray-500 dark:text-gray-400 font-normal">Espace Apporteur</p>
              </div>
            </div>

            {/* Dark Mode Toggle */}
            <button 
              onClick={handleDarkModeToggle}
              className="w-10 h-10 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 border border-gray-200 dark:border-gray-600 rounded-lg flex items-center justify-center transition-colors cursor-pointer"
            >
              <i className={`${darkMode ? 'ri-sun-line' : 'ri-moon-line'} text-gray-600 dark:text-gray-300 text-sm`}></i>
            </button>
          </div>
        </div>
      </header>

      {/* Hero Section similaire à la page principale */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="px-4 sm:px-8 py-8 sm:py-12 max-w-7xl mx-auto">
          <div className="text-center">
            <h1 className="text-3xl sm:text-4xl lg:text-5xl font-light text-gray-900 dark:text-white mb-4">
              <span className="font-medium text-[#335FAD] dark:text-[#335FAD]/80">Bienvenue</span> sur votre plateforme
            </h1>
            <p className="text-lg text-gray-600 dark:text-gray-400">
              Finalisation de votre compte apporteur
            </p>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-4xl mx-auto">
        <div className="bg-white dark:bg-gray-800 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 sm:p-8">
          {/* Progress Steps */}
          <div className="mb-8">
            <div className="flex items-center justify-center space-x-4">
              <div className="flex items-center">
                <div className="w-8 h-8 bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-full flex items-center justify-center">
                  <i className="ri-check-line text-green-600 dark:text-green-400 text-sm"></i>
                </div>
                <span className="ml-3 text-sm font-medium text-green-600 dark:text-green-400">Compte créé</span>
              </div>
              
              <div className="w-16 h-px bg-gray-200 dark:bg-gray-600"></div>
              
              <div className="flex items-center">
                <div className="w-8 h-8 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border-2 border-[#335FAD] dark:border-[#335FAD]/80 rounded-full flex items-center justify-center">
                  <span className="text-[#335FAD] dark:text-[#335FAD]/80 font-bold text-sm">2</span>
                </div>
                <span className="ml-3 text-sm font-medium text-[#335FAD] dark:text-[#335FAD]/80">CGU</span>
              </div>
              
              <div className="w-16 h-px bg-gray-200 dark:bg-gray-600"></div>
              
              <div className="flex items-center">
                <div className="w-8 h-8 bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-full flex items-center justify-center">
                  <span className="text-gray-400 dark:text-gray-500 font-bold text-sm">3</span>
                </div>
                <span className="ml-3 text-sm text-gray-400 dark:text-gray-500">Accès</span>
              </div>
            </div>
          </div>

          {/* Info Card */}
          <div className="bg-gradient-to-r from-[#335FAD]/5 to-[#335FAD]/5 dark:from-[#335FAD]/20 dark:to-[#335FAD]/20 rounded-2xl p-6 border border-[#335FAD]/20 dark:border-[#335FAD]/30 mb-8">
            <div className="flex items-start space-x-4">
              <div className="w-12 h-12 bg-indigo-100 dark:bg-indigo-900/30 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-xl flex items-center justify-center flex-shrink-0">
                <i className="ri-shield-check-line text-[#335FAD] dark:text-[#335FAD]/80 text-xl"></i>
              </div>
              <div>
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
                  Acceptation des Conditions Générales
                </h3>
                <p className="text-gray-600 dark:text-gray-400 text-sm">
                  Pour accéder à votre espace apporteur, vous devez accepter nos Conditions Générales d'Utilisation qui définissent le cadre de notre partenariat.
                </p>
              </div>
            </div>
          </div>

          {error && (
            <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-xl">
              <div className="flex items-center">
                <i className="ri-error-warning-line text-red-600 dark:text-red-400 mr-3"></i>
                <p className="text-red-700 dark:text-red-400 text-sm">{error}</p>
              </div>
            </div>
          )}

          {/* CGU Content */}
          <div className="border border-gray-200 dark:border-gray-700 rounded-2xl p-6 mb-6 max-h-96 overflow-y-auto bg-gray-50 dark:bg-gray-800/50">
            <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
              <i className="ri-file-text-line mr-3 text-[#335FAD] dark:text-[#335FAD]/80"></i>
              Conditions Générales d'Utilisation
            </h3>
            
            <div className="space-y-6 text-sm text-gray-700 dark:text-gray-300">
              <section>
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                  <span className="w-6 h-6 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mr-3 text-xs text-[#335FAD] dark:text-[#335FAD]/80 font-bold">1</span>
                  Objet et Définitions
                </h4>
                <p className="mb-3">
                  Les présentes Conditions Générales d'Utilisation (CGU) régissent l'utilisation de la plateforme 
                  de mise en relation développée par GMB Courtage pour l'assurance emprunteur.
                </p>
                <div className="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                  <p className="font-medium text-gray-900 dark:text-white mb-2">Définitions :</p>
                  <ul className="list-disc ml-4 space-y-1">
                    <li><strong>Apporteur :</strong> Professionnel utilisateur de la plateforme</li>
                    <li><strong>Plateforme :</strong> Solution digitale de GMB Courtage</li>
                    <li><strong>Client :</strong> Personne pour laquelle un dossier est constitué</li>
                  </ul>
                </div>
              </section>

              <section>
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                  <span className="w-6 h-6 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mr-3 text-xs text-[#335FAD] dark:text-[#335FAD]/80 font-bold">2</span>
                  Rôle de la Plateforme
                </h4>
                <p>
                  La plateforme constitue un outil de transmission et de suivi des dossiers d'assurance emprunteur. 
                  GMB Courtage agit en qualité d'intermédiaire et n'est pas l'assureur final.
                </p>
              </section>

              <section>
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                  <span className="w-6 h-6 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mr-3 text-xs text-[#335FAD] dark:text-[#335FAD]/80 font-bold">3</span>
                  Gestion du Compte
                </h4>
                <p>
                  L'Apporteur est seul responsable de la sécurité de ses identifiants de connexion et de 
                  l'utilisation de son compte. Toute utilisation du compte engage sa responsabilité.
                </p>
              </section>

              <section>
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                  <span className="w-6 h-6 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mr-3 text-xs text-red-600 dark:text-red-400 font-bold">!</span>
                  Responsabilités de l'Apporteur (Important)
                </h4>
                <div className="space-y-4">
                  <div className="bg-red-50 dark:bg-red-900/20 rounded-lg p-4 border border-red-200 dark:border-red-700">
                    <p className="font-medium text-red-800 dark:text-red-400 mb-2">4.1 Exactitude des données :</p>
                    <p>L'Apporteur garantit l'exactitude et la véracité de toutes les informations transmises via la plateforme.</p>
                  </div>
                  
                  <div className="bg-[#335FAD]/5 dark:bg-[#335FAD]/20 rounded-lg p-4 border border-[#335FAD]/20 dark:border-[#335FAD]/70">
                    <p className="font-medium text-[#335FAD] dark:text-[#335FAD] mb-2">4.2 Consentement du Client (RGPD) :</p>
                    <p>L'Apporteur certifie avoir obtenu l'accord explicite de son client pour le partage et le traitement de ses données personnelles.</p>
                  </div>
                  
                  <div className="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 border border-green-200 dark:border-green-700">
                    <p className="font-medium text-green-800 dark:text-green-400 mb-2">4.3 Conformité Professionnelle :</p>
                    <p className="mb-2">L'Apporteur certifie être en règle avec l'ensemble de ses obligations légales et réglementaires :</p>
                    <ul className="list-disc ml-4 space-y-1">
                      <li>Immatriculation ORIAS en cours de validité</li>
                      <li>Assurance Responsabilité Civile Professionnelle</li>
                      <li>Formation réglementaire à jour</li>
                    </ul>
                  </div>
                </div>
              </section>

              <section>
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                  <span className="w-6 h-6 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mr-3 text-xs text-[#335FAD] dark:text-[#335FAD]/80 font-bold">5</span>
                  Engagements de GMB Courtage
                </h4>
                <div className="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                  <p className="mb-2">GMB Courtage s'engage à :</p>
                  <ul className="list-disc ml-4 space-y-1">
                    <li>Assurer la disponibilité et la sécurité de la plateforme</li>
                    <li>Protéger les données conformément au RGPD</li>
                    <li>Traiter les dossiers avec diligence</li>
                    <li>Informer l'Apporteur du suivi de ses dossiers</li>
                  </ul>
                </div>
              </section>

              <section>
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                  <span className="w-6 h-6 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mr-3 text-xs text-[#335FAD] dark:text-[#335FAD]/80 font-bold">6</span>
                  Propriété Intellectuelle
                </h4>
                <p>
                  La plateforme et tous ses éléments demeurent la propriété exclusive de GMB Courtage. 
                  Les données clients transmises restent la propriété de l'Apporteur.
                </p>
              </section>

              <section>
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                  <span className="w-6 h-6 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center mr-3 text-xs text-yellow-600 dark:text-yellow-400 font-bold">7</span>
                  Limitation de Responsabilité
                </h4>
                <div className="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4 border border-yellow-200 dark:border-yellow-700">
                  <p className="mb-2">GMB Courtage ne saurait être tenu responsable :</p>
                  <ul className="list-disc ml-4 space-y-1">
                    <li>Des erreurs de saisie commises par l'Apporteur</li>
                    <li>Des décisions de refus ou d'acceptation des assureurs</li>
                    <li>De l'inexactitude des informations fournies par l'Apporteur</li>
                    <li>Du non-respect par l'Apporteur de ses obligations réglementaires</li>
                  </ul>
                </div>
              </section>

              <section>
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                  <span className="w-6 h-6 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mr-3 text-xs text-[#335FAD] dark:text-[#335FAD]/80 font-bold">8</span>
                  Durée et Fin du Contrat
                </h4>
                <p>
                  Le présent contrat est conclu pour une durée indéterminée. Chaque partie peut y mettre fin 
                  à tout moment moyennant un préavis de 30 jours par lettre recommandée avec accusé de réception.
                </p>
              </section>

              <section>
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                  <span className="w-6 h-6 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mr-3 text-xs text-[#335FAD] dark:text-[#335FAD]/80 font-bold">9</span>
                  Loi Applicable et Juridictions
                </h4>
                <p>
                  Les présentes CGU sont soumises au droit français. En cas de litige, les tribunaux de 
                  Paris seront seuls compétents.
                </p>
              </section>

              <section>
                <h4 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                  <span className="w-6 h-6 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mr-3 text-xs text-[#335FAD] dark:text-[#335FAD]/80 font-bold">10</span>
                  Modifications
                </h4>
                <p className="text-gray-700 dark:text-gray-300">
                  GMB Courtage se réserve le droit de modifier les présentes CGU à tout moment. 
                  L'Apporteur sera informé par email de toute modification.
                </p>
              </section>
            </div>
          </div>

          {/* Checkbox Agreement */}
          <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 border-2 border-[#335FAD]/20 dark:border-[#335FAD]/30 mb-8">
            <div className="flex items-start space-x-4">
              <div className="flex-shrink-0 mt-1">
                <input
                  id="cgu-acceptance"
                  type="checkbox"
                  checked={cguAccepted}
                  onChange={(e) => setCguAccepted(e.target.checked)}
                  className="w-5 h-5 text-[#335FAD] focus:ring-[#335FAD]

00 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700"
                />
              </div>
              <div>
                <label htmlFor="cgu-acceptance" className="text-gray-700 dark:text-gray-300 text-sm leading-relaxed cursor-pointer">
                  <strong>Je déclare avoir lu et accepter les Conditions Générales d'Utilisation</strong> de GMB Courtage. 
                  Je certifie être en règle avec mes obligations professionnelles et avoir obtenu le 
                  consentement de mes clients pour le traitement de leurs données.
                </label>
                
                <div className="mt-3 flex items-center space-x-6 text-xs text-gray-500 dark:text-gray-400">
                  <div className="flex items-center">
                    <i className="ri-shield-check-line mr-2 text-green-500"></i>
                    <span>Conformité RGPD</span>
                  </div>
                  <div className="flex items-center">
                    <i className="ri-award-line mr-2 text-[#335FAD]"></i>
                    <span>Certification ORIAS</span>
                  </div>
                  <div className="flex items-center">
                    <i className="ri-secure-payment-line mr-2 text-purple-500"></i>
                    <span>RC Professionnelle</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Action Buttons */}
          <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
            <button
              onClick={() => supabase.auth.signOut()}
              className="w-full sm:w-auto bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 border border-gray-200 dark:border-gray-600 whitespace-nowrap"
            >
              <i className="ri-logout-box-line"></i>
              <span>Annuler</span>
            </button>
            
            <button
              onClick={handleAcceptCGU}
              disabled={!cguAccepted || loading}
              className="w-full sm:w-auto bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-8 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
            >
              {loading ? (
                <>
                  <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                  <span>Activation en cours...</span>
                </>
              ) : (
                <>
                  <span>Activer mon compte</span>
                  <i className="ri-arrow-right-line"></i>
                </>
              )}
            </button>
          </div>
        </div>
      </main>
    </div>
  );
}

================
File: app/page.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import ApporteurHeader from '../components/ApporteurHeader';
import ApporteurStatsCards from '../components/ApporteurStatsCards';
import ApporteurActivity from '../components/ApporteurActivity';
import { useTheme } from '@/lib/hooks/useTheme';
import { useAuth } from '@/components/AuthProvider';
import { api } from '@/services/api';
import { ApporteursService } from '@/lib/services/apporteurs';

// Interface pour les données utilisateur
interface UserData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
}

// Interface pour les statistiques
interface UserStats {
  dossiersEnvoyes: number;
  economiesGenerees: number;
  totalApporteurs: number;
  progressionDossiers: number;
  progressionEconomies: number;
}

// Fonction pour obtenir le message de salutation en fonction de l'heure locale
const getGreeting = (date: Date): string => {
  const hour = date.getHours();
  if (hour >= 5 && hour < 12) return 'Bonjour';
  if (hour >= 12 && hour < 18) return 'Bon après-midi';
  return 'Bonsoir';
};

export default function ApporteurDashboard() {
  const router = useRouter();
  const { user, loading: authLoading } = useAuth();
  const [currentTime, setCurrentTime] = useState(new Date());
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // ✅ Utilisation du hook centralisé pour le dark mode
  const { darkMode, isInitialized, toggleDarkMode } = useTheme();
  
  // États pour les données utilisateur et statistiques
  const [userData, setUserData] = useState<UserData>({
    id: '',
    firstName: '',
    lastName: '',
    initials: '',
    role: 'Apporteur'
  });

  const [userStats, setUserStats] = useState<UserStats>({
    dossiersEnvoyes: 0,
    economiesGenerees: 0,
    totalApporteurs: 0,
    progressionDossiers: 0,
    progressionEconomies: 0
  });

  // Fonction pour récupérer les données utilisateur connecté
  const fetchUserData = async () => {
    try {
      setLoading(true);
      setError(null);
      
      // Récupérer le profil apporteur de l'utilisateur connecté
      const apporteur = await api.getCurrentApporteurProfile();
      
      if (apporteur) {
        setUserData({
          id: apporteur.id,
          firstName: apporteur.prenom,
          lastName: apporteur.nom,
          initials: `${apporteur.prenom.charAt(0)}${apporteur.nom.charAt(0)}`,
          role: 'Apporteur'
        });
        
        // Récupérer les statistiques
        const stats = await ApporteursService.getApporteurStats(apporteur.id);
        
        setUserStats({
          dossiersEnvoyes: stats.totalDossiers,
          economiesGenerees: stats.economiesGenerees,
          totalApporteurs: stats.totalApporteurs || 0,
          progressionDossiers: stats.progressionDossiers,
          progressionEconomies: stats.progressionEconomies
        });
      } else {
        setError('Profil apporteur non trouvé. Contactez votre administrateur.');
      }
    } catch (error) {
      console.error('Erreur lors du chargement des données:', error);
      setError(`Erreur lors du chargement des données: ${error instanceof Error ? error.message : 'Erreur inconnue'}`);
    } finally {
      setLoading(false);
    }
  };

  // Timer pour l'heure
  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 1000);
    return () => clearInterval(timer);
  }, []);

  // ✅ Le dark mode est géré par le hook useTheme
  // Chargement initial des données quand l'auth est terminée
  useEffect(() => {
    if (isInitialized && !authLoading && user) {
      fetchUserData();
    }
  }, [isInitialized, authLoading, user]);

  // Gestionnaire pour le bouton Nouveau Dossier
  const handleNouveauDossier = () => {
    router.push('/nouveau-dossier');
  };

  if (!isInitialized || authLoading || loading) {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#335FAD] mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Chargement du tableau de bord...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center">
        <div className="text-center">
          <div className="text-red-500 text-4xl mb-4">⚠️</div>
          <h2 className="text-xl font-semibold text-gray-900 mb-2">Erreur de chargement</h2>
          <p className="text-gray-600 mb-4">{error}</p>
          <button 
            onClick={() => fetchUserData()}
            className="bg-[#335FAD] text-white px-4 py-2 rounded-lg hover:bg-[#335FAD]/90"
          >
            Réessayer
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      <ApporteurHeader 
        darkMode={darkMode} 
        setDarkMode={toggleDarkMode}
        userData={userData}
      />
      
      {/* Hero Section */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="px-4 sm:px-8 py-8 sm:py-12 max-w-7xl mx-auto">
          <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
            <div className="flex-1">
              {/* Date - Mobile au-dessus de Bonjour */}
              <div className="mb-4 lg:hidden text-center" suppressHydrationWarning={true}>
                <p className="text-base font-light text-gray-600 dark:text-gray-400" suppressHydrationWarning={true}>
                  {currentTime.toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    day: 'numeric',
                    month: 'long'
                  })}
                </p>
              </div>

              <h1 className="text-3xl sm:text-4xl lg:text-5xl font-light text-gray-900 dark:text-white mb-4 text-center lg:text-left" suppressHydrationWarning>
                {getGreeting(currentTime)}, <span className="font-medium text-[#335FAD] dark:text-[#335FAD]">{userData.firstName}</span>
              </h1>
              <p className="text-lg text-gray-600 dark:text-gray-400 text-center lg:text-left">
                Voici votre tableau de bord
              </p>
            </div>

            {/* Right Side - Desktop only */}
            <div className="hidden lg:flex flex-col items-end space-y-6">
              {/* Date - Desktop à droite */}
              <div className="text-right" suppressHydrationWarning={true}>
                <p className="text-base font-light text-gray-600 dark:text-gray-400" suppressHydrationWarning={true}>
                  {currentTime.toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    day: 'numeric',
                    month: 'long'
                  })}
                </p>
              </div>

              {/* Nouveau Dossier Button - Desktop à droite */}
              <button 
                onClick={handleNouveauDossier}
                className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-8 py-4 rounded-2xl font-medium transition-all duration-200 hover:shadow-lg flex items-center space-x-3 whitespace-nowrap cursor-pointer"
              >
                <i className="ri-add-line text-xl"></i>
                <span>Nouveau Dossier</span>
              </button>
            </div>

            {/* Mobile Button */}
            <div className="lg:hidden flex justify-center">
              <button 
                onClick={handleNouveauDossier}
                className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-8 py-4 rounded-2xl font-medium transition-all duration-200 hover:shadow-lg flex items-center space-x-3 whitespace-nowrap cursor-pointer"
              >
                <i className="ri-add-line text-xl"></i>
                <span>Nouveau Dossier</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-7xl mx-auto">
        {/* Performance Section Title */}
        <div className="mb-6">
          <p className="text-gray-500 dark:text-gray-400 text-xl font-light">
            Votre performance ce mois-ci
          </p>
        </div>

        <ApporteurStatsCards userStats={userStats} />

        {/* Main Content Grid */}
        <div className="grid grid-cols-1 gap-8 mt-8">
          {/* Activité Récente */}
          <div>
            <ApporteurActivity userId={userData.id} />
          </div>
        </div>
      </main>
    </div>
  );
}

================
File: app/profil/CabinetSection.tsx
================
'use client';

import { useState } from 'react';

interface CabinetInfo {
  broker_id: string;
  broker_name: string;
  owner_name?: string;
  joined_at?: string;
}

interface CabinetSectionProps {
  cabinetInfo: CabinetInfo | null;
  loading: boolean;
  onLeaveCabinet: () => Promise<{ success: boolean; error?: string }>;
}

export default function CabinetSection({ cabinetInfo, loading, onLeaveCabinet }: CabinetSectionProps) {
  const [showLeaveModal, setShowLeaveModal] = useState(false);
  const [isLeaving, setIsLeaving] = useState(false);
  const [confirmText, setConfirmText] = useState('');
  const [error, setError] = useState('');

  const handleLeave = async () => {
    if (confirmText !== 'QUITTER') {
      setError('Veuillez taper QUITTER pour confirmer');
      return;
    }

    setIsLeaving(true);
    setError('');

    try {
      const result = await onLeaveCabinet();
      if (!result.success) {
        setError(result.error || 'Une erreur est survenue');
      } else {
        // Redirection vers la page de connexion ou confirmation
        window.location.href = '/connexion';
      }
    } catch (err) {
      setError('Une erreur est survenue');
    } finally {
      setIsLeaving(false);
    }
  };

  if (loading) {
    return (
      <div className="space-y-6">
        <div className="animate-pulse">
          <div className="h-6 bg-gray-200 dark:bg-gray-700 rounded w-1/3 mb-4"></div>
          <div className="h-24 bg-gray-200 dark:bg-gray-700 rounded"></div>
        </div>
      </div>
    );
  }

  if (!cabinetInfo) {
    return (
      <div className="space-y-6">
        <h2 className="text-xl font-semibold text-gray-900 dark:text-white">
          Mon Cabinet
        </h2>
        
        <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-xl p-6">
          <div className="flex items-start">
            <div className="w-12 h-12 bg-amber-100 dark:bg-amber-900/30 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
              <i className="ri-building-line text-amber-600 dark:text-amber-400 text-xl"></i>
            </div>
            <div>
              <h3 className="font-medium text-amber-800 dark:text-amber-300 mb-1">
                Aucun cabinet associé
              </h3>
              <p className="text-amber-700 dark:text-amber-400 text-sm">
                Vous n'êtes actuellement rattaché à aucun cabinet de courtage. 
                Demandez un lien d'invitation à votre courtier pour rejoindre son cabinet.
              </p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <h2 className="text-xl font-semibold text-gray-900 dark:text-white">
        Mon Cabinet
      </h2>

      {/* Cabinet Info Card */}
      <div className="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6">
        <div className="flex items-start justify-between">
          <div className="flex items-start">
            <div className="w-14 h-14 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
              <i className="ri-building-2-line text-[#335FAD] text-2xl"></i>
            </div>
            <div>
              <h3 className="font-semibold text-gray-900 dark:text-white text-lg">
                {cabinetInfo.broker_name}
              </h3>
              {cabinetInfo.owner_name && (
                <p className="text-gray-600 dark:text-gray-400 text-sm mt-1">
                  Dirigé par {cabinetInfo.owner_name}
                </p>
              )}
              {cabinetInfo.joined_at && (
                <p className="text-gray-500 dark:text-gray-500 text-sm mt-2">
                  <i className="ri-calendar-line mr-1"></i>
                  Membre depuis le {new Date(cabinetInfo.joined_at).toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                  })}
                </p>
              )}
            </div>
          </div>
          
          <div className="flex items-center px-3 py-1.5 bg-green-100 dark:bg-green-900/30 rounded-lg">
            <div className="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
            <span className="text-green-700 dark:text-green-400 text-sm font-medium">Actif</span>
          </div>
        </div>
      </div>

      {/* Leave Cabinet Section */}
      <div className="bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-800/50 rounded-xl p-6">
        <div className="flex items-start">
          <div className="w-10 h-10 bg-red-100 dark:bg-red-900/30 rounded-lg flex items-center justify-center mr-4 flex-shrink-0">
            <i className="ri-logout-box-r-line text-red-600 dark:text-red-400 text-lg"></i>
          </div>
          <div className="flex-1">
            <h3 className="font-medium text-red-800 dark:text-red-300 mb-1">
              Quitter le cabinet
            </h3>
            <p className="text-red-700 dark:text-red-400 text-sm mb-4">
              En quittant ce cabinet, votre compte sera désactivé et vous ne pourrez plus accéder 
              à vos dossiers. Cette action est irréversible.
            </p>
            <button
              onClick={() => setShowLeaveModal(true)}
              className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors"
            >
              Quitter le cabinet
            </button>
          </div>
        </div>
      </div>

      {/* Leave Confirmation Modal */}
      {showLeaveModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md">
            <div className="p-6">
              <div className="text-center mb-6">
                <div className="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                  <i className="ri-alert-line text-red-600 dark:text-red-400 text-3xl"></i>
                </div>
                <h3 className="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                  Confirmer le départ
                </h3>
                <p className="text-gray-600 dark:text-gray-400 text-sm">
                  Vous êtes sur le point de quitter le cabinet <strong>{cabinetInfo.broker_name}</strong>.
                </p>
              </div>

              <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-xl p-4 mb-6">
                <h4 className="font-medium text-red-800 dark:text-red-300 mb-2">
                  <i className="ri-error-warning-line mr-2"></i>
                  Conséquences :
                </h4>
                <ul className="text-sm text-red-700 dark:text-red-400 space-y-1">
                  <li>• Votre compte sera désactivé immédiatement</li>
                  <li>• Vous perdrez l'accès à tous vos dossiers</li>
                  <li>• Vos commissions en attente seront perdues</li>
                  <li>• Cette action est irréversible</li>
                </ul>
              </div>

              <div className="mb-6">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Tapez <strong>QUITTER</strong> pour confirmer
                </label>
                <input
                  type="text"
                  value={confirmText}
                  onChange={(e) => setConfirmText(e.target.value.toUpperCase())}
                  className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-red-500 focus:border-transparent"
                  placeholder="QUITTER"
                />
              </div>

              {error && (
                <div className="mb-4 p-3 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 text-sm rounded-lg">
                  {error}
                </div>
              )}

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowLeaveModal(false);
                    setConfirmText('');
                    setError('');
                  }}
                  disabled={isLeaving}
                  className="flex-1 px-4 py-3 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-xl transition-colors disabled:opacity-50"
                >
                  Annuler
                </button>
                <button
                  onClick={handleLeave}
                  disabled={isLeaving || confirmText !== 'QUITTER'}
                  className="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {isLeaving ? (
                    <>
                      <i className="ri-loader-4-line animate-spin mr-2"></i>
                      Départ en cours...
                    </>
                  ) : (
                    'Confirmer le départ'
                  )}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

================
File: app/profil/NotificationSettings.tsx
================
'use client';

import { useState } from 'react';

interface NotificationPreferences {
  devisAvailable: {
    email: boolean;
    app: boolean;
  };
  dossierFinalized: {
    email: boolean;
    app: boolean;
  };
  rankingChanged: {
    email: boolean;
    app: boolean;
  };
  newsUpdates: {
    email: boolean;
    app: boolean;
  };
}

interface NotificationSettingsProps {
  preferences: NotificationPreferences;
  onSave: (preferences: NotificationPreferences) => Promise<{ success: boolean; error?: string }>;
}

export default function NotificationSettings({ preferences, onSave }: NotificationSettingsProps) {
  const [localPreferences, setLocalPreferences] = useState<NotificationPreferences>(preferences);
  const [isSaving, setIsSaving] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);

  // Configuration des types de notifications
  const notificationTypes = [
    {
      key: 'devisAvailable' as keyof NotificationPreferences,
      title: 'Un devis est disponible pour l\'un de mes dossiers',
      description: 'Soyez immédiatement informé quand un devis est prêt',
      category: 'Essentiel',
      categoryColor: 'text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900/30',
      icon: 'ri-file-check-line',
      iconColor: 'text-green-600 dark:text-green-400'
    },
    {
      key: 'dossierFinalized' as keyof NotificationPreferences,
      title: 'Un de mes dossiers a été finalisé ou refusé',
      description: 'Restez au courant du statut de vos dossiers',
      category: 'Recommandé',
      categoryColor: 'text-[#335FAD] dark:text-[#335FAD] bg-[#335FAD]/10 dark:bg-[#335FAD]/30',
      icon: 'ri-checkbox-circle-line',
      iconColor: 'text-[#335FAD] dark:text-[#335FAD]'
    },
    {
      key: 'rankingChanged' as keyof NotificationPreferences,
      title: 'Mon classement a changé',
      description: 'Suivez votre progression dans le classement',
      category: 'Optionnel',
      categoryColor: 'text-amber-600 dark:text-amber-400 bg-amber-100 dark:bg-amber-900/30',
      icon: 'ri-trophy-line',
      iconColor: 'text-amber-600 dark:text-amber-400'
    },
    {
      key: 'newsUpdates' as keyof NotificationPreferences,
      title: 'Actualités et informations de la part de GMB Courtage',
      description: 'Recevez nos dernières nouvelles et mises à jour',
      category: 'Marketing',
      categoryColor: 'text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700',
      icon: 'ri-newspaper-line',
      iconColor: 'text-gray-600 dark:text-gray-400'
    }
  ];

  // Mettre à jour une préférence
  const updatePreference = (key: keyof NotificationPreferences, channel: 'email' | 'app', value: boolean) => {
    setLocalPreferences(prev => ({
      ...prev,
      [key]: {
        ...prev[key],
        [channel]: value
      }
    }));
  };

  // Sauvegarder les préférences
  const handleSave = async () => {
    setIsSaving(true);
    setMessage(null);

    try {
      const result = await onSave(localPreferences);
      
      if (result.success) {
        setMessage({ type: 'success', text: 'Préférences de notification mises à jour avec succès' });
      } else {
        setMessage({ type: 'error', text: result.error || 'Erreur lors de la sauvegarde' });
      }
    } catch (error) {
      setMessage({ type: 'error', text: 'Erreur lors de la sauvegarde des préférences' });
    } finally {
      setIsSaving(false);
    }
  };

  // Vérifier s'il y a des changements
  const hasChanges = JSON.stringify(preferences) !== JSON.stringify(localPreferences);

  // Masquer le message après 5 secondes
  useState(() => {
    if (message) {
      const timer = setTimeout(() => setMessage(null), 5000);
      return () => clearTimeout(timer);
    }
  });

  return (
    <div className="space-y-6">
      {/* Message de notification */}
      {message && (
        <div className={`p-4 rounded-xl border flex items-center space-x-3 ${
          message.type === 'success'
            ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-700 text-green-800 dark:text-green-400'
            : 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-700 text-red-800 dark:text-red-400'
        }`}>
          <i className={`${message.type === 'success' ? 'ri-check-circle-line' : 'ri-error-warning-line'} text-lg`}></i>
          <span className="font-medium">{message.text}</span>
          <button
            onClick={() => setMessage(null)}
            className="ml-auto text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
          >
            <i className="ri-close-line"></i>
          </button>
        </div>
      )}

      {/* Section principale */}
      <div className="bg-white dark:bg-gray-800 rounded-2xl border-2 border-gray-100 dark:border-gray-700 p-6">
        <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 space-y-4 sm:space-y-0">
          <div className="flex items-start space-x-4">
            <div className="w-12 h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-xl flex items-center justify-center flex-shrink-0">
              <i className="ri-notification-3-line text-[#335FAD] dark:text-[#335FAD]/80 text-xl"></i>
            </div>
            <div className="flex-1 min-w-0">
              <h3 className="text-xl font-medium text-gray-900 dark:text-white">
                Préférences de notification
              </h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Choisissez comment et quand vous souhaitez être notifié
              </p>
            </div>
          </div>
        </div>

        {/* Alerte d'information */}
        <div className="bg-[#335FAD]/5 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/70 rounded-xl p-4 mb-6">
          <div className="flex items-start space-x-3">
            <div className="w-6 h-6 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 rounded-lg flex items-center justify-center mt-0.5">
              <i className="ri-information-line text-[#335FAD] dark:text-[#335FAD] text-sm"></i>
            </div>
            <div>
              <h4 className="font-medium text-[#335FAD] dark:text-[#335FAD] mb-1">
                Contrôlez vos notifications
              </h4>
              <p className="text-[#335FAD]/80 dark:text-[#335FAD]/80 text-sm">
                Pour chaque type de notification, vous pouvez choisir de recevoir les alertes par <strong>email</strong> et/ou directement dans <strong>l'application</strong>. 
                Cela vous permet de ne pas être submergé tout en restant informé des événements importants.
              </p>
            </div>
          </div>
        </div>

        {/* Liste des notifications */}
        <div className="space-y-6">
          {notificationTypes.map((notif) => {
            const pref = localPreferences[notif.key];
            
            return (
              <div key={notif.key} className="border border-gray-200 dark:border-gray-700 rounded-xl p-6 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                <div className="flex items-start space-x-4">
                  {/* Icône */}
                  <div className="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-xl flex items-center justify-center flex-shrink-0">
                    <i className={`${notif.icon} ${notif.iconColor} text-lg`}></i>
                  </div>
                  
                  {/* Contenu */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center space-x-3 mb-2">
                      <h4 className="font-medium text-gray-900 dark:text-white text-sm">
                        {notif.title}
                      </h4>
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${notif.categoryColor}`}>
                        {notif.category}
                      </span>
                    </div>
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
                      {notif.description}
                    </p>
                    
                    {/* Options de notification */}
                    <div className="flex flex-col sm:flex-row gap-4">
                      {/* Email */}
                      <label className="flex items-center space-x-3 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={pref.email}
                          onChange={(e) => updatePreference(notif.key, 'email', e.target.checked)}
                          className="w-4 h-4 text-[#335FAD] bg-gray-100 border-gray-300 rounded focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                        />
                        <div className="flex items-center space-x-2">
                          <i className="ri-mail-line text-gray-500 dark:text-gray-400"></i>
                          <span className="text-sm font-medium text-gray-700 dark:text-gray-300">Par email</span>
                        </div>
                      </label>
                      
                      {/* Application */}
                      <label className="flex items-center space-x-3 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={pref.app}
                          onChange={(e) => updatePreference(notif.key, 'app', e.target.checked)}
                          className="w-4 h-4 text-[#335FAD] bg-gray-100 border-gray-300 rounded focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                        />
                        <div className="flex items-center space-x-2">
                          <i className="ri-smartphone-line text-gray-500 dark:text-gray-400"></i>
                          <span className="text-sm font-medium text-gray-700 dark:text-gray-300">Dans l'app</span>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        {/* Actions */}
        {hasChanges && (
          <div className="flex justify-end pt-6 border-t border-gray-200 dark:border-gray-700 mt-6">
            <button
              onClick={handleSave}
              disabled={isSaving}
              className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
            >
              {isSaving ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                  <span>Sauvegarde...</span>
                </>
              ) : (
                <>
                  <i className="ri-save-line"></i>
                  <span>Sauvegarder les préférences</span>
                </>
              )}
            </button>
          </div>
        )}
      </div>

      {/* Résumé des notifications activées */}
      <div className="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
        <h4 className="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
          <i className="ri-list-check-line mr-2 text-[#335FAD] dark:text-[#335FAD]/80"></i>
          Résumé de vos notifications
        </h4>
        
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
          {/* Notifications par email */}
          <div>
            <p className="font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center">
              <i className="ri-mail-line mr-2"></i>
              Par email ({Object.values(localPreferences).filter(p => p.email).length})
            </p>
            <ul className="space-y-1 text-gray-600 dark:text-gray-400">
              {notificationTypes.filter(notif => localPreferences[notif.key].email).map(notif => (
                <li key={`${notif.key}-email`} className="flex items-center">
                  <i className="ri-check-line mr-2 text-green-500 text-xs"></i>
                  <span className="truncate">{notif.title}</span>
                </li>
              ))}
              {Object.values(localPreferences).filter(p => p.email).length === 0 && (
                <li className="text-gray-500 dark:text-gray-500 italic">Aucune notification par email</li>
              )}
            </ul>
          </div>
          
          {/* Notifications dans l'app */}
          <div>
            <p className="font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center">
              <i className="ri-smartphone-line mr-2"></i>
              Dans l'app ({Object.values(localPreferences).filter(p => p.app).length})
            </p>
            <ul className="space-y-1 text-gray-600 dark:text-gray-400">
              {notificationTypes.filter(notif => localPreferences[notif.key].app).map(notif => (
                <li key={`${notif.key}-app`} className="flex items-center">
                  <i className="ri-check-line mr-2 text-green-500 text-xs"></i>
                  <span className="truncate">{notif.title}</span>
                </li>
              ))}
              {Object.values(localPreferences).filter(p => p.app).length === 0 && (
                <li className="text-gray-500 dark:text-gray-500 italic">Aucune notification dans l'app</li>
              )}
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
}

================
File: app/profil/page.tsx
================
'use client';

import { useState, useEffect, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import ApporteurHeader from '../../components/ApporteurHeader';
import ProfileInfo from './ProfileInfo';
import NotificationSettings from './NotificationSettings';
import ResourcesSection from './ResourcesSection';
import CabinetSection from './CabinetSection';
import { supabase } from '@/lib/supabase';

// Interface pour les données utilisateur depuis Supabase
interface UserData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
  companyName?: string;
  email: string;
  phone: string;
}

// Interface pour les infos du cabinet
interface CabinetInfo {
  broker_id: string;
  broker_name: string;
  owner_name?: string;
  joined_at?: string;
}

// Interface pour les préférences de notification
interface NotificationPreferences {
  devisAvailable: {
    email: boolean;
    app: boolean;
  };
  dossierFinalized: {
    email: boolean;
    app: boolean;
  };
  rankingChanged: {
    email: boolean;
    app: boolean;
  };
  newsUpdates: {
    email: boolean;
    app: boolean;
  };
}

export default function ProfilPage() {
  const router = useRouter();
  const [darkMode, setDarkMode] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);
  const [activeSection, setActiveSection] = useState<'profile' | 'cabinet' | 'notifications' | 'resources'>('profile');

  // État pour les données utilisateur
  const [userData, setUserData] = useState<UserData>({
    id: '1',
    firstName: '',
    lastName: '',
    initials: '',
    role: 'Apporteur',
    email: '',
    phone: ''
  });

  // État pour les infos du cabinet
  const [cabinetInfo, setCabinetInfo] = useState<CabinetInfo | null>(null);
  const [cabinetLoading, setCabinetLoading] = useState(true);

  // État pour les préférences de notification
  const [notificationPreferences, setNotificationPreferences] = useState<NotificationPreferences>({
    devisAvailable: { email: true, app: true },
    dossierFinalized: { email: true, app: true },
    rankingChanged: { email: false, app: true },
    newsUpdates: { email: false, app: false }
  });

  // Fonction pour récupérer les données utilisateur et du cabinet
  const fetchUserDataAndCabinet = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      // Récupérer le profil apporteur
      const { data: profile } = await supabase
        .from('apporteur_profiles')
        .select('id, nom, prenom, email, telephone, statut')
        .eq('user_id', user.id)
        .single();

      if (profile) {
        setUserData({
          id: profile.id,
          firstName: profile.prenom || '',
          lastName: profile.nom || '',
          initials: `${(profile.prenom || '')[0] || ''}${(profile.nom || '')[0] || ''}`.toUpperCase(),
          role: 'Apporteur',
          email: profile.email || '',
          phone: profile.telephone || ''
        });

        // Récupérer le cabinet lié
        const { data: brokerLink } = await supabase
          .from('broker_apporteurs')
          .select('broker_id, created_at')
          .eq('apporteur_profile_id', profile.id)
          .single();

        if (brokerLink) {
          // Récupérer les infos du broker via broker_apporteurs avec jointure
          const { data: linkWithBroker } = await supabase
            .from('broker_apporteurs')
            .select(`
              broker_id,
              created_at,
              brokers (
                id,
                name
              )
            `)
            .eq('apporteur_profile_id', profile.id)
            .single();

          if (linkWithBroker?.brokers) {
            const broker = linkWithBroker.brokers as any;
            setCabinetInfo({
              broker_id: broker.id,
              broker_name: broker.name,
              joined_at: linkWithBroker.created_at
            });
          }
        }
      }
    } catch (error: any) {
      console.error('Erreur lors du chargement des données:', error);
    } finally {
      setCabinetLoading(false);
    }
  };

  // Fonction pour quitter le cabinet
  const handleLeaveCabinet = async (): Promise<{ success: boolean; error?: string }> => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        return { success: false, error: 'Utilisateur non connecté' };
      }

      // Récupérer le profil apporteur
      const { data: profile } = await supabase
        .from('apporteur_profiles')
        .select('id')
        .eq('user_id', user.id)
        .single();

      if (!profile) {
        return { success: false, error: 'Profil non trouvé' };
      }

      // Supprimer le lien avec le cabinet
      const { error: deleteError } = await supabase
        .from('broker_apporteurs')
        .delete()
        .eq('apporteur_profile_id', profile.id);

      if (deleteError) {
        return { success: false, error: deleteError.message };
      }

      // Désactiver le profil apporteur
      const { error: updateError } = await supabase
        .from('apporteur_profiles')
        .update({ statut: 'inactif' })
        .eq('id', profile.id);

      if (updateError) {
        return { success: false, error: updateError.message };
      }

      // Déconnexion
      await supabase.auth.signOut();

      return { success: true };
    } catch (error: any) {
      return { success: false, error: error.message || 'Erreur inconnue' };
    }
  };

  // Charger les données au montage
  useEffect(() => {
    fetchUserDataAndCabinet();
  }, []);

  // Fonction pour sauvegarder les données utilisateur
  const saveUserData = async (updatedData: Partial<UserData>) => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return { success: false, error: 'Non connecté' };

      const { error } = await supabase
        .from('apporteur_profiles')
        .update({
          email: updatedData.email,
          telephone: updatedData.phone,
        })
        .eq('user_id', user.id);
      
      if (error) throw error;
      
      setUserData(prev => ({ ...prev, ...updatedData }));
      return { success: true };
    } catch (error: any) {
      console.error('Erreur lors de la sauvegarde:', error);
      return { success: false, error: error?.message || 'Erreur inconnue' };
    }
  };

  // Fonction pour sauvegarder les préférences de notification
  const saveNotificationPreferences = async (preferences: NotificationPreferences) => {
    try {
      setNotificationPreferences(preferences);
      return { success: true };
    } catch (error: any) {
      console.error('Erreur lors de la sauvegarde des préférences:', error);
      return { success: false, error: error?.message || 'Erreur inconnue' };
    }
  };

  // Fonction pour changer le mot de passe
  const changePassword = async (currentPassword: string, newPassword: string) => {
    try {
      const { error } = await supabase.auth.updateUser({
        password: newPassword
      });
      
      if (error) throw error;
      return { success: true };
    } catch (error: any) {
      console.error('Erreur lors du changement de mot de passe:', error);
      return { success: false, error: error?.message || 'Erreur inconnue' };
    }
  };

  // Initialisation unique du mode sombre
  useEffect(() => {
    if (typeof window !== 'undefined' && !isInitialized) {
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      setDarkMode(savedDarkMode);
      
      if (savedDarkMode) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      
      setIsInitialized(true);
    }
  }, [isInitialized]);

  // Gestionnaire du mode sombre
  const handleDarkModeToggle = (newDarkMode: boolean) => {
    setDarkMode(newDarkMode);
    
    if (typeof window !== 'undefined') {
      if (newDarkMode) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('darkMode', 'true');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('darkMode', 'false');
      }
    }
  };

  // Sections de navigation
  const sections = [
    {
      id: 'profile' as const,
      label: 'Informations du Profil',
      icon: 'ri-user-line',
      description: 'Gérez vos informations personnelles'
    },
    {
      id: 'cabinet' as const,
      label: 'Mon Cabinet',
      icon: 'ri-building-2-line',
      description: 'Votre cabinet de courtage'
    },
    {
      id: 'notifications' as const,
      label: 'Préférences de notification',
      icon: 'ri-notification-3-line',
      description: 'Contrôlez comment vous êtes contacté'
    },
    {
      id: 'resources' as const,
      label: 'Ressources et Support',
      icon: 'ri-customer-service-line',
      description: 'Accédez aux documents et à l\'aide'
    }
  ];

  if (!isInitialized) {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      <ApporteurHeader 
        darkMode={darkMode} 
        setDarkMode={handleDarkModeToggle}
        userData={userData}
      />
      
      {/* Hero Section */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="px-4 sm:px-8 py-8 sm:py-12 max-w-7xl mx-auto">
          <div>
            <h1 className="text-3xl sm:text-4xl font-light text-gray-900 dark:text-white mb-4">
              Profil & Paramètres
            </h1>
            <p className="text-lg text-gray-600 dark:text-gray-400">
              Gérez vos informations personnelles et vos préférences
            </p>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-7xl mx-auto">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
          {/* Navigation Sidebar */}
          <div className="lg:col-span-1">
            <div className="bg-white dark:bg-gray-800 rounded-2xl border-2 border-gray-100 dark:border-gray-700 p-6 sticky top-8">
              <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-6">
                Navigation
              </h3>
              
              <nav className="space-y-2">
                {sections.map((section) => (
                  <button
                    key={section.id}
                    onClick={() => setActiveSection(section.id)}
                    className={`w-full text-left p-3 rounded-xl transition-colors cursor-pointer ${
                      activeSection === section.id
                        ? 'bg-indigo-50 dark:bg-indigo-900/30 text-[#335FAD] dark:text-[#335FAD]/80 border border-indigo-200 dark:border-indigo-700'
                        : 'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'
                    }`}
                  >
                    <div className="flex items-center space-x-3">
                      <i className={`${section.icon} text-lg`}></i>
                      <div className="flex-1 min-w-0">
                        <p className="font-medium text-sm truncate">{section.label}</p>
                        <p className="text-xs text-gray-500 dark:text-gray-400 truncate">
                          {section.description}
                        </p>
                      </div>
                    </div>
                  </button>
                ))}
              </nav>
            </div>
          </div>

          {/* Content Area */}
          <div className="lg:col-span-3">
            {activeSection === 'profile' && (
              <ProfileInfo
                userData={userData}
                onSave={saveUserData}
                onChangePassword={changePassword}
              />
            )}

            {activeSection === 'cabinet' && (
              <CabinetSection
                cabinetInfo={cabinetInfo}
                loading={cabinetLoading}
                onLeaveCabinet={handleLeaveCabinet}
              />
            )}
            
            {activeSection === 'notifications' && (
              <NotificationSettings
                preferences={notificationPreferences}
                onSave={saveNotificationPreferences}
              />
            )}
            
            {activeSection === 'resources' && (
              <ResourcesSection />
            )}
          </div>
        </div>
      </main>
    </div>
  );
}

================
File: app/profil/ProfileInfo.tsx
================
'use client';

import { useState } from 'react';

interface UserData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
  companyName?: string;
  email: string;
  phone: string;
}

interface ProfileInfoProps {
  userData: UserData;
  onSave: (data: Partial<UserData>) => Promise<{ success: boolean; error?: string }>;
  onChangePassword: (currentPassword: string, newPassword: string) => Promise<{ success: boolean; error?: string }>;
}

export default function ProfileInfo({ userData, onSave, onChangePassword }: ProfileInfoProps) {
  const [isEditing, setIsEditing] = useState(false);
  const [isSaving, setSaving] = useState(false);
  const [isChangingPassword, setIsChangingPassword] = useState(false);
  const [showPasswordForm, setShowPasswordForm] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);

  // Formulaire des informations de base
  const [formData, setFormData] = useState({
    companyName: userData.companyName || '',
    email: userData.email,
    phone: userData.phone
  });

  // Formulaire de changement de mot de passe
  const [passwordData, setPasswordData] = useState({
    currentPassword: '',
    newPassword: '',
    confirmPassword: ''
  });

  const [formErrors, setFormErrors] = useState<Record<string, string>>({});
  const [passwordErrors, setPasswordErrors] = useState<Record<string, string>>({});

  // Validation du formulaire principal
  const validateForm = (): boolean => {
    const errors: Record<string, string> = {};

    if (!formData.email.trim()) {
      errors.email = 'L\'email est obligatoire';
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      errors.email = 'Format d\'email invalide';
    }

    if (!formData.phone.trim()) {
      errors.phone = 'Le téléphone est obligatoire';
    }

    setFormErrors(errors);
    return Object.keys(errors).length === 0;
  };

  // Validation du formulaire de mot de passe
  const validatePasswordForm = (): boolean => {
    const errors: Record<string, string> = {};

    if (!passwordData.currentPassword) {
      errors.currentPassword = 'Le mot de passe actuel est obligatoire';
    }

    if (!passwordData.newPassword) {
      errors.newPassword = 'Le nouveau mot de passe est obligatoire';
    } else if (passwordData.newPassword.length < 8) {
      errors.newPassword = 'Le mot de passe doit contenir au moins 8 caractères';
    }

    if (!passwordData.confirmPassword) {
      errors.confirmPassword = 'Veuillez confirmer le nouveau mot de passe';
    } else if (passwordData.newPassword !== passwordData.confirmPassword) {
      errors.confirmPassword = 'Les mots de passe ne correspondent pas';
    }

    setPasswordErrors(errors);
    return Object.keys(errors).length === 0;
  };

  // Sauvegarder les informations
  const handleSave = async () => {
    if (!validateForm()) return;

    setSaving(true);
    setMessage(null);

    try {
      const result = await onSave(formData);
      
      if (result.success) {
        setMessage({ type: 'success', text: 'Informations mises à jour avec succès' });
        setIsEditing(false);
      } else {
        setMessage({ type: 'error', text: result.error || 'Erreur lors de la sauvegarde' });
      }
    } catch (error) {
      setMessage({ type: 'error', text: 'Erreur lors de la sauvegarde' });
    } finally {
      setSaving(false);
    }
  };

  // Changer le mot de passe
  const handlePasswordChange = async () => {
    if (!validatePasswordForm()) return;

    setIsChangingPassword(true);
    setMessage(null);

    try {
      const result = await onChangePassword(passwordData.currentPassword, passwordData.newPassword);
      
      if (result.success) {
        setMessage({ type: 'success', text: 'Mot de passe modifié avec succès' });
        setShowPasswordForm(false);
        setPasswordData({ currentPassword: '', newPassword: '', confirmPassword: '' });
      } else {
        setMessage({ type: 'error', text: result.error || 'Erreur lors du changement de mot de passe' });
      }
    } catch (error) {
      setMessage({ type: 'error', text: 'Erreur lors du changement de mot de passe' });
    } finally {
      setIsChangingPassword(false);
    }
  };

  // Annuler l'édition
  const handleCancel = () => {
    setFormData({
      companyName: userData.companyName || '',
      email: userData.email,
      phone: userData.phone
    });
    setFormErrors({});
    setIsEditing(false);
    setMessage(null);
  };

  // Masquer le message après 5 secondes
  useState(() => {
    if (message) {
      const timer = setTimeout(() => setMessage(null), 5000);
      return () => clearTimeout(timer);
    }
  });

  return (
    <div className="space-y-6">
      {/* Message de notification */}
      {message && (
        <div className={`p-4 rounded-xl border flex items-center space-x-3 ${
          message.type === 'success'
            ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-700 text-green-800 dark:text-green-400'
            : 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-700 text-red-800 dark:text-red-400'
        }`}>
          <i className={`${message.type === 'success' ? 'ri-check-circle-line' : 'ri-error-warning-line'} text-lg`}></i>
          <span className="font-medium">{message.text}</span>
          <button
            onClick={() => setMessage(null)}
            className="ml-auto text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
          >
            <i className="ri-close-line"></i>
          </button>
        </div>
      )}

      {/* Informations principales */}
      <div className="bg-white dark:bg-gray-800 rounded-2xl border-2 border-gray-100 dark:border-gray-700 p-6">
        <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 space-y-4 sm:space-y-0">
          <div className="flex items-start space-x-4">
            <div className="w-12 h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-xl flex items-center justify-center flex-shrink-0">
              <i className="ri-user-line text-[#335FAD] dark:text-[#335FAD]/80 text-xl"></i>
            </div>
            <div className="flex-1 min-w-0">
              <h3 className="text-xl font-medium text-gray-900 dark:text-white">
                Informations du Profil
              </h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Gérez vos informations personnelles et professionnelles
              </p>
            </div>
          </div>
          
          {!isEditing && (
            <div className="flex justify-end sm:justify-start">
              <button
                onClick={() => setIsEditing(true)}
                className="bg-[#335FAD]/10 dark:bg-[#335FAD]/20 hover:bg-[#335FAD]/20 dark:hover:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD]/80 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer flex items-center space-x-2 whitespace-nowrap"
              >
                <i className="ri-edit-line"></i>
                <span>Modifier</span>
              </button>
            </div>
          )}
        </div>

        <div className="space-y-6">
          {/* Nom et Prénom - Non modifiables */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Prénom
              </label>
              <div className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 rounded-xl text-sm text-gray-900 dark:text-white">
                {userData.firstName}
              </div>
              <p className="text-xs text-gray-500 dark:text-gray-400">
                Non modifiable
              </p>
            </div>
            
            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Nom
              </label>
              <div className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 rounded-xl text-sm text-gray-900 dark:text-white">
                {userData.lastName}
              </div>
              <p className="text-xs text-gray-500 dark:text-gray-400">
                Non modifiable
              </p>
            </div>
          </div>

          {/* Nom de la société - Modifiable */}
          <div className="space-y-2">
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
              Nom de la Société
            </label>
            {isEditing ? (
              <input
                type="text"
                value={formData.companyName}
                onChange={(e) => setFormData(prev => ({ ...prev, companyName: e.target.value }))}
                placeholder="Nom de votre entreprise"
                className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                  formErrors.companyName 
                    ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                    : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
                } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
              />
            ) : (
              <div className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 rounded-xl text-sm text-gray-900 dark:text-white">
                {userData.companyName || 'Non renseigné'}
              </div>
            )}
            {formErrors.companyName && (
              <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                <i className="ri-error-warning-line mr-1"></i>
                {formErrors.companyName}
              </p>
            )}
          </div>

          {/* Email - Modifiable avec confirmation */}
          <div className="space-y-2">
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
              Adresse Email <span className="text-red-500">*</span>
            </label>
            {isEditing ? (
              <input
                type="email"
                value={formData.email}
                onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                placeholder="votre@email.com"
                className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                  formErrors.email 
                    ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                    : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
                } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
              />
            ) : (
              <div className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 rounded-xl text-sm text-gray-900 dark:text-white">
                {userData.email}
              </div>
            )}
            {formErrors.email && (
              <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                <i className="ri-error-warning-line mr-1"></i>
                {formErrors.email}
              </p>
            )}
            {isEditing && (
              <p className="text-xs text-amber-600 dark:text-amber-400 flex items-center">
                <i className="ri-information-line mr-1"></i>
                Un email de confirmation sera envoyé en cas de modification
              </p>
            )}
          </div>

          {/* Téléphone - Modifiable */}
          <div className="space-y-2">
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
              Numéro de Téléphone <span className="text-red-500">*</span>
            </label>
            {isEditing ? (
              <input
                type="tel"
                value={formData.phone}
                onChange={(e) => setFormData(prev => ({ ...prev, phone: e.target.value }))}
                placeholder="06 12 34 56 78"
                className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                  formErrors.phone 
                    ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                    : 'border-gray-3 00 dark:border-gray-600 bg-white dark:bg-gray-800'
                } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
              />
            ) : (
              <div className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 rounded-xl text-sm text-gray-900 dark:text-white">
                {userData.phone}
              </div>
            )}
            {formErrors.phone && (
              <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                <i className="ri-error-warning-line mr-1"></i>
                {formErrors.phone}
              </p>
            )}
          </div>

          {/* Actions d'édition */}
          {isEditing && (
            <div className="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
              <button
                onClick={handleCancel}
                className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer"
              >
                Annuler
              </button>
              <button
                onClick={handleSave}
                disabled={isSaving}
                className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
              >
                {isSaving ? (
                  <>
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    <span>Sauvegarde...</span>
                  </>
                ) : (
                  <>
                    <i className="ri-save-line"></i>
                    <span>Sauvegarder</span>
                  </>
                )}
              </button>
            </div>
          )}
        </div>
      </div>

      {/* Changement de mot de passe */}
      <div className="bg-white dark:bg-gray-800 rounded-2xl border-2 border-gray-100 dark:border-gray-700 p-6">
        <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 space-y-4 sm:space-y-0">
          <div className="flex items-start space-x-4">
            <div className="w-12 h-12 bg-amber-100 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 rounded-xl flex items-center justify-center flex-shrink-0">
              <i className="ri-lock-line text-amber-600 dark:text-amber-400 text-xl"></i>
            </div>
            <div className="flex-1 min-w-0">
              <h3 className="text-xl font-medium text-gray-900 dark:text-white">
                Sécurité du Compte
              </h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Modifiez votre mot de passe pour sécuriser votre compte
              </p>
            </div>
          </div>
          
          {!showPasswordForm && (
            <div className="flex justify-end sm:justify-start">
              <button
                onClick={() => setShowPasswordForm(true)}
                className="bg-amber-100 dark:bg-amber-900/30 hover:bg-amber-200 dark:hover:bg-amber-900/50 text-amber-700 dark:text-amber-400 px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer flex items-center space-x-2 whitespace-nowrap"
              >
                <i className="ri-key-line"></i>
                <span>Changer</span>
              </button>
            </div>
          )}
        </div>

        {showPasswordForm && (
          <div className="space-y-4">
            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Mot de passe actuel <span className="text-red-500">*</span>
              </label>
              <input
                type="password"
                value={passwordData.currentPassword}
                onChange={(e) => setPasswordData(prev => ({ ...prev, currentPassword: e.target.value }))}
                placeholder="Votre mot de passe actuel"
                className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                  passwordErrors.currentPassword 
                    ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                    : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
                } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
              />
              {passwordErrors.currentPassword && (
                <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                  <i className="ri-error-warning-line mr-1"></i>
                  {passwordErrors.currentPassword}
                </p>
              )}
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Nouveau mot de passe <span className="text-red-500">*</span>
              </label>
              <input
                type="password"
                value={passwordData.newPassword}
                onChange={(e) => setPasswordData(prev => ({ ...prev, newPassword: e.target.value }))}
                placeholder="Nouveau mot de passe (min. 8 caractères)"
                className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                  passwordErrors.newPassword 
                    ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                    : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
                } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
              />
              {passwordErrors.newPassword && (
                <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                  <i className="ri-error-warning-line mr-1"></i>
                  {passwordErrors.newPassword}
                </p>
              )}
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Confirmer le nouveau mot de passe <span className="text-red-500">*</span>
              </label>
              <input
                type="password"
                value={passwordData.confirmPassword}
                onChange={(e) => setPasswordData(prev => ({ ...prev, confirmPassword: e.target.value }))}
                placeholder="Confirmez le nouveau mot de passe"
                className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
                  passwordErrors.confirmPassword 
                    ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
                    : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
                } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
              />
              {passwordErrors.confirmPassword && (
                <p className="text-red-600 dark:text-red-400 text-xs flex items-center">
                  <i className="ri-error-warning-line mr-1"></i>
                  {passwordErrors.confirmPassword}
                </p>
              )}
            </div>

            <div className="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
              <button
                onClick={() => {
                  setShowPasswordForm(false);
                  setPasswordData({ currentPassword: '', newPassword: '', confirmPassword: '' });
                  setPasswordErrors({});
                }}
                className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-7 00 dark:text-gray-300 px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer"
              >
                Annuler
              </button>
              <button
                onClick={handlePasswordChange}
                disabled={isChangingPassword}
                className="bg-amber-600 hover:bg-amber-700 dark:bg-amber-500 dark:hover:bg-amber-600 text-white px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
              >
                {isChangingPassword ? (
                  <>
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    <span>Modification...</span>
                  </>
                ) : (
                  <>
                    <i className="ri-check-line"></i>
                    <span>Changer le mot de passe</span>
                  </>
                )}
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

================
File: app/profil/ResourcesSection.tsx
================
'use client';

import { useState } from 'react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';

export default function ResourcesSection() {
  const [showContactForm, setShowContactForm] = useState(false);
  const [contactForm, setContactForm] = useState({
    subject: '',
    message: '',
    priority: 'normal'
  });
  const [isSending, setIsSending] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);

  // Types de sujets pour le support
  const supportTopics = [
    { value: 'technical', label: 'Problème technique', icon: 'ri-tools-line' },
    { value: 'dossier', label: 'Question sur un dossier', icon: 'ri-folder-line' },
    { value: 'commission', label: 'Question sur les commissions', icon: 'ri-money-euro-circle-line' },
    { value: 'account', label: 'Problème de compte', icon: 'ri-user-line' },
    { value: 'feature', label: 'Demande de fonctionnalité', icon: 'ri-lightbulb-line' },
    { value: 'other', label: 'Autre', icon: 'ri-question-line' }
  ];

  // Envoyer le message de contact
  const handleContactSubmit = async () => {
    if (!contactForm.subject || !contactForm.message.trim()) {
      setMessage({ type: 'error', text: 'Veuillez remplir tous les champs obligatoires' });
      return;
    }

    setIsSending(true);
    setMessage(null);

    try {
      // TODO: SUPABASE - Envoyer le message via Edge Function ou API
      // const { error } = await supabase.functions.invoke('send-support-message', {
      //   body: {
      //     subject: contactForm.subject,
      //     message: contactForm.message,
      //     priority: contactForm.priority,
      //     user_id: userData.id
      //   }
      // });
      // 
      // if (error) throw error;

      // Simulation de l'envoi
      await new Promise(resolve => setTimeout(resolve, 1500));

      setMessage({ type: 'success', text: 'Votre message a été envoyé avec succès. Notre équipe vous répondra dans les plus brefs délais.' });
      setContactForm({ subject: '', message: '', priority: 'normal' });
      setShowContactForm(false);
    } catch (error) {
      console.error('Erreur lors de l\'envoi du message:', error);
      setMessage({ type: 'error', text: 'Erreur lors de l\'envoi du message. Veuillez réessayer.' });
    } finally {
      setIsSending(false);
    }
  };

  // Masquer le message après 5 secondes
  useState(() => {
    if (message) {
      const timer = setTimeout(() => setMessage(null), 5000);
      return () => clearTimeout(timer);
    }
  });

  return (
    <div className="space-y-6">
      {/* Message de notification */}
      {message && (
        <div className={`p-4 rounded-xl border flex items-center space-x-3 ${
          message.type === 'success'
            ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-700 text-green-800 dark:text-green-400'
            : 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-700 text-red-800 dark:text-red-400'
        }`}>
          <i className={`${message.type === 'success' ? 'ri-check-circle-line' : 'ri-error-warning-line'} text-lg`}></i>
          <span className="font-medium">{message.text}</span>
          <button
            onClick={() => setMessage(null)}
            className="ml-auto text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
          >
            <i className="ri-close-line"></i>
          </button>
        </div>
      )}

      {/* Support et Contact */}
      <div className="bg-white dark:bg-gray-800 rounded-2xl border-2 border-gray-100 dark:border-gray-700 p-6">
        <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 space-y-4 sm:space-y-0">
          <div className="flex items-start space-x-4">
            <div className="w-12 h-12 bg-bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-xl flex items-center justify-center flex-shrink-0">
              <i className="ri-customer-service-line text-[#335FAD] dark:text-[#335FAD]/80 text-xl"></i>
            </div>
            <div className="flex-1 min-w-0">
              <h3 className="text-xl font-medium text-gray-900 dark:text-white">
                Support et Contact
              </h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Besoin d'aide ? Notre équipe est là pour vous accompagner
              </p>
            </div>
          </div>
          
          {!showContactForm && (
            <div className="flex justify-end sm:justify-start">
              <button
                onClick={() => setShowContactForm(true)}
                className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer flex items-center space-x-2 whitespace-nowrap"
              >
                <i className="ri-mail-line"></i>
                <span>Contacter le support</span>
              </button>
            </div>
          )}
        </div>

        {/* Informations de contact rapide */}
        {!showContactForm && (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div className="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4 text-center">
              <div className="w-8 h-8 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center mx-auto mb-2">
                <i className="ri-phone-line text-green-600 dark:text-green-400"></i>
              </div>
              <p className="text-sm font-medium text-gray-900 dark:text-white">Téléphone</p>
              <p className="text-xs text-gray-600 dark:text-gray-400">01 23 45 67 89</p>
              <p className="text-xs text-gray-500 dark:text-gray-500">Lun-Ven 9h-18h</p>
            </div>
            
            <div className="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4 text-center">
              <div className="w-8 h-8 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 rounded-lg flex items-center justify-center mx-auto mb-2">
                <i className="ri-mail-line text-[#335FAD] dark:text-[#335FAD]"></i>
              </div>
              <p className="text-sm font-medium text-gray-900 dark:text-white">Email</p>
              <p className="text-xs text-gray-600 dark:text-gray-400">support@gmb-courtage.fr</p>
              <p className="text-xs text-gray-500 dark:text-gray-500">Réponse sous 24h</p>
            </div>
            
            <div className="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4 text-center">
              <div className="w-8 h-8 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center mx-auto mb-2">
                <i className="ri-chat-3-line text-purple-600 dark:text-purple-400"></i>
              </div>
              <p className="text-sm font-medium text-gray-900 dark:text-white">Chat en ligne</p>
              <p className="text-xs text-gray-600 dark:text-gray-400">Disponible</p>
              <p className="text-xs text-gray-500 dark:text-gray-500">Lun-Ven 9h-17h</p>
            </div>
          </div>
        )}

        {/* Formulaire de contact */}
        {showContactForm && (
          <div className="space-y-4">
            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Sujet de votre demande <span className="text-red-500">*</span>
              </label>
              <Select
                value={contactForm.subject}
                onValueChange={(v) => setContactForm(prev => ({ ...prev, subject: v }))}
              >
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="Sélectionnez un sujet" />
                </SelectTrigger>
                <SelectContent>
                  {supportTopics.map(topic => (
                    <SelectItem key={topic.value} value={topic.value}>
                      {topic.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Priorité
              </label>
              <div className="flex space-x-4">
                {[
                  { value: 'low', label: 'Faible', color: 'text-green-600 dark:text-green-400' },
                  { value: 'normal', label: 'Normale', color: 'text-[#335FAD] dark:text-[#335FAD]' },
                  { value: 'high', label: 'Élevée', color: 'text-orange-600 dark:text-orange-400' },
                  { value: 'urgent', label: 'Urgente', color: 'text-red-600 dark:text-red-400' }
                ].map(priority => (
                  <label key={priority.value} className="flex items-center cursor-pointer">
                    <input
                      type="radio"
                      name="priority"
                      value={priority.value}
                      checked={contactForm.priority === priority.value}
                      onChange={(e) => setContactForm(prev => ({ ...prev, priority: e.target.value }))}
                      className="mr-2 text-indigo-600 focus:ring-indigo-500"
                    />
                    <span className={`text-sm font-medium ${priority.color}`}>
                      {priority.label}
                    </span>
                  </label>
                ))}
              </div>
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Votre message <span className="text-red-500">*</span>
              </label>
              <textarea
                value={contactForm.message}
                onChange={(e) => setContactForm(prev => ({ ...prev, message: e.target.value }))}
                placeholder="Décrivez votre demande en détail..."
                rows={5}
                className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 resize-none"
              />
              <p className="text-xs text-gray-500 dark:text-gray-400">
                Minimum 10 caractères - {contactForm.message.length}/500
              </p>
            </div>

            <div className="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
              <button
                onClick={() => {
                  setShowContactForm(false);
                  setContactForm({ subject: '', message: '', priority: 'normal' });
                }}
                className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer"
              >
                Annuler
              </button>
              <button
                onClick={handleContactSubmit}
                disabled={isSending || !contactForm.subject || contactForm.message.trim().length < 10}
                className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
              >
                {isSending ? (
                  <>
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    <span>Envoi en cours...</span>
                  </>
                ) : (
                  <>
                    <i className="ri-send-plane-line"></i>
                    <span>Envoyer le message</span>
                  </>
                )}
              </button>
            </div>
          </div>
        )}
      </div>

      {/* Informations légales rapides */}
      <div className="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
        <h4 className="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
          <i className="ri-shield-check-line mr-2 text-gray-600 dark:text-gray-400"></i>
          Informations légales
        </h4>
        
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
          <div>
            <p className="font-medium text-gray-700 dark:text-gray-300 mb-1">GMB Courtage</p>
            <p className="text-gray-600 dark:text-gray-400">
              Société de courtage en assurance<br />
              ORIAS N° 12345678<br />
              Capital social : 50 000 €
            </p>
          </div>
          
          <div>
            <p className="font-medium text-gray-700 dark:text-gray-300 mb-1">Siège social</p>
            <p className="text-gray-600 dark:text-gray-400">
              123 Avenue de la République<br />
              75001 Paris, France<br />
              SIRET : 123 456 789 00012
            </p>
          </div>
          
          <div>
            <p className="font-medium text-gray-700 dark:text-gray-300 mb-1">Liens utiles</p>
            <div className="space-y-1">
              <button className="block text-[#335FAD] dark:text-[#335FAD]/80 hover:text-[#335FAD]/70 dark:hover:text-[#335FAD]/90 cursor-pointer">
                Mentions légales
              </button>
              <button className="block text-[#335FAD] dark:text-[#335FAD]/80 hover:text-[#335FAD]/70 dark:hover:text-[#335FAD]/90 cursor-pointer">
                Politique de confidentialité
              </button>
              <button className="block text-[#335FAD] dark:text-[#335FAD]/80 hover:text-[#335FAD]/70 dark:hover:text-[#335FAD]/90 cursor-pointer">
                Politique des cookies
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

================
File: app/reset-password/page.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { supabase } from '../../lib/supabase';
import { useRouter, useSearchParams } from 'next/navigation';
import { Suspense } from 'react';

function ResetPasswordContent() {
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState(false);
  const [darkMode, setDarkMode] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);

  const router = useRouter();
  const searchParams = useSearchParams();

  useEffect(() => {
    // Initialiser le mode sombre
    if (typeof window !== 'undefined' && !isInitialized) {
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      setDarkMode(savedDarkMode);
      
      if (savedDarkMode) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      
      setIsInitialized(true);
    }
  }, [isInitialized]);

  useEffect(() => {
    // Vérifier si nous avons les paramètres nécessaires pour la réinitialisation
    const code = searchParams.get('code');
    if (!code) {
      setError('Lien de réinitialisation invalide');
    }
  }, [searchParams]);

  // Gestionnaire du mode sombre
  const handleDarkModeToggle = () => {
    const newDarkMode = !darkMode;
    setDarkMode(newDarkMode);
    
    if (typeof window !== 'undefined') {
      if (newDarkMode) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('darkMode', 'true');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('darkMode', 'false');
      }
    }
  };

  const handleResetPassword = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    if (password !== confirmPassword) {
      setError('Les mots de passe ne correspondent pas');
      setLoading(false);
      return;
    }

    if (password.length < 6) {
      setError('Le mot de passe doit contenir au moins 6 caractères');
      setLoading(false);
      return;
    }

    try {
      const { error } = await supabase.auth.updateUser({
        password: password
      });

      if (error) throw error;

      setSuccess(true);
      setTimeout(() => {
        router.push('/connexion');
      }, 3000);
    } catch (error: any) {
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  if (!isInitialized) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
      </div>
    );
  }

  if (success) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
        {/* Header similaire à la page de connexion */}
        <header className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50 transition-colors duration-300">
          <div className="px-4 sm:px-8 py-4 sm:py-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-4">
                <div className="w-10 h-10 sm:w-12 sm:h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-xl flex items-center justify-center">
                  <i className="ri-handshake-line text-[#335FAD] dark:text-[#335FAD]/80 text-lg sm:text-xl"></i>
                </div>
                <div>
                  <h1 className="font-['Pacifico'] text-lg sm:text-xl text-gray-900 dark:text-white">GMB Courtage</h1>
                  <p className="text-xs text-gray-500 dark:text-gray-400 font-normal">Espace Apporteur</p>
                </div>
              </div>

              <button 
                onClick={handleDarkModeToggle}
                className="w-10 h-10 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 border border-gray-200 dark:border-gray-600 rounded-lg flex items-center justify-center transition-colors cursor-pointer"
              >
                <i className={`${darkMode ? 'ri-sun-line' : 'ri-moon-line'} text-gray-600 dark:text-gray-300 text-sm`}></i>
              </button>
            </div>
          </div>
        </header>

        {/* Hero Section */}
        <div className="bg-white dark:bg-gray-800">
          <div className="px-4 sm:px-8 py-8 sm:py-12 max-w-7xl mx-auto">
            <div className="text-center">
              <h1 className="text-3xl sm:text-4xl lg:text-5xl font-light text-gray-900 dark:text-white mb-4">
                <span className="font-medium text-green-600 dark:text-green-400">Mot de passe</span> modifié
              </h1>
              <p className="text-lg text-gray-600 dark:text-gray-400">
                Votre mot de passe a été mis à jour avec succès
              </p>
            </div>
          </div>
        </div>

        {/* Success Content */}
        <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-2xl mx-auto">
          <div className="bg-white dark:bg-gray-800 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 sm:p-8">
            <div className="text-center">
              <div className="w-20 h-20 bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i className="ri-check-line text-3xl text-green-600 dark:text-green-400"></i>
              </div>
              
              <h2 className="text-xl font-medium text-gray-900 dark:text-white mb-3">
                Mot de passe modifié avec succès
              </h2>
              
              <p className="text-gray-600 dark:text-gray-400 mb-6">
                Votre mot de passe a été mis à jour. Vous allez être redirigé vers la page de connexion dans quelques secondes.
              </p>
              
              <div className="flex items-center justify-center space-x-2 mb-6">
                <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-indigo-600 dark:border-indigo-400"></div>
                <span className="text-sm text-gray-500 dark:text-gray-400">Redirection en cours...</span>
              </div>

              <button
                onClick={() => router.push('/connexion')}
                className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 whitespace-nowrap shadow-sm hover:shadow-md flex items-center justify-center space-x-2 mx-auto"
              >
                <i className="ri-login-box-line"></i>
                <span>Aller à la connexion</span>
              </button>
            </div>
          </div>
        </main>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-300">
      {/* Header similaire à ApporteurHeader */}
      <header className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50 transition-colors duration-300">
        <div className="px-4 sm:px-8 py-4 sm:py-6">
          <div className="flex items-center justify-between">
            {/* Logo */}
            <div className="flex items-center space-x-4">
              <div className="w-10 h-10 sm:w-12 sm:h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-xl flex items-center justify-center">
                <i className="ri-handshake-line text-[#335FAD] dark:text-[#335FAD]/80 text-lg sm:text-xl"></i>
              </div>
              <div>
                <h1 className="font-['Pacifico'] text-lg sm:text-xl text-gray-900 dark:text-white">GMB Courtage</h1>
                <p className="text-xs text-gray-500 dark:text-gray-400 font-normal">Espace Apporteur</p>
              </div>
            </div>

            {/* Dark Mode Toggle */}
            <button 
              onClick={handleDarkModeToggle}
              className="w-10 h-10 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 border border-gray-200 dark:border-gray-600 rounded-lg flex items-center justify-center transition-colors cursor-pointer"
            >
              <i className={`${darkMode ? 'ri-sun-line' : 'ri-moon-line'} text-gray-600 dark:text-gray-300 text-sm`}></i>
            </button>
          </div>
        </div>
      </header>

      {/* Hero Section similaire à la page principale */}
      <div className="bg-white dark:bg-gray-800">
        <div className="px-4 sm:px-8 py-8 sm:py-12 max-w-7xl mx-auto">
          <div className="text-center">
            <h1 className="text-3xl sm:text-4xl lg:text-5xl font-light text-gray-900 dark:text-white mb-4">
              <span className="font-medium text-[#335FAD] dark:text-[#335FAD]/80">Nouveau</span> mot de passe
            </h1>
            <p className="text-lg text-gray-600 dark:text-gray-400">
              Définissez votre nouveau mot de passe sécurisé
            </p>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <main className="px-4 sm:px-8 py-6 sm:py-8 max-w-2xl mx-auto">
        <div className="bg-white dark:bg-gray-800 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 sm:p-8">
          
          {/* Back Button */}
          <div className="mb-6">
            <button
              onClick={() => router.push('/connexion')}
              className="flex items-center text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors cursor-pointer"
            >
              <i className="ri-arrow-left-line mr-2"></i>
              Retour à la connexion
            </button>
          </div>

          {/* Icon & Title */}
          <div className="text-center mb-8">
            <div className="w-16 h-16 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-2xl flex items-center justify-center mx-auto mb-4">
              <i className="ri-key-line text-[#335FAD] dark:text-[#335FAD]/80 text-2xl"></i>
            </div>
            <h2 className="text-xl font-medium text-gray-900 dark:text-white mb-2">Réinitialiser le mot de passe</h2>
            <p className="text-sm text-gray-600 dark:text-gray-400">
              Saisissez votre nouveau mot de passe sécurisé
            </p>
          </div>

          {/* Status Messages */}
          {error && (
            <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-xl">
              <div className="flex items-center">
                <i className="ri-error-warning-line text-red-600 dark:text-red-400 mr-3"></i>
                <p className="text-red-700 dark:text-red-400 text-sm">{error}</p>
              </div>
            </div>
          )}

          {/* Form */}
          <form onSubmit={handleResetPassword} className="space-y-6">
            <div>
              <label htmlFor="password" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Nouveau mot de passe *
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                  <i className="ri-lock-line text-gray-400 dark:text-gray-500 text-sm"></i>
                </div>
                <input
                  id="password"
                  name="password"
                  type="password"
                  required
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full pl-12 pr-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 focus:border-transparent text-sm transition-colors"
                  placeholder="Minimum 6 caractères"
                />
              </div>
            </div>

            <div>
              <label htmlFor="confirmPassword" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Confirmer le nouveau mot de passe *
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                  <i className="ri-lock-line text-gray-400 dark:text-gray-500 text-sm"></i>
                </div>
                <input
                  id="confirmPassword"
                  name="confirmPassword"
                  type="password"
                  required
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  className="w-full pl-12 pr-4 py-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#335FAD] dark:focus:ring-[#335FAD]/80 focus:border-transparent text-sm transition-colors"
                  placeholder="Confirmez votre mot de passe"
                />
              </div>
            </div>

            {/* Security Info */}
            <div className="bg-[#335FAD]/5 dark:bg-[#335FAD]/10 rounded-xl p-4 border border-[#335FAD]/20 dark:border-[#335FAD]/30">
              <div className="flex items-start space-x-3">
                <div className="w-8 h-8 bg-[#335FAD]/10 dark:bg-[#335FAD]/20 border border-[#335FAD]/20 dark:border-[#335FAD]/30 rounded-lg flex items-center justify-center flex-shrink-0">
                  <i className="ri-shield-check-line text-[#335FAD] dark:text-[#335FAD]/80 text-sm"></i>
                </div>
                <div>
                  <p className="text-sm text-[#335FAD] dark:text-[#335FAD]/80 font-medium mb-1">
                    Sécurité du mot de passe
                  </p>
                  <p className="text-xs text-[#335FAD] dark:text-[#335FAD]/80">
                    Utilisez au moins 6 caractères avec une combinaison de lettres, chiffres et symboles
                  </p>
                </div>
              </div>
            </div>

            <div>
              <button
                type="submit"
                disabled={loading}
                className="w-full bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-4 rounded-xl font-medium transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap shadow-sm hover:shadow-md flex items-center justify-center space-x-2"
              >
                {loading ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    <span>Mise à jour...</span>
                  </>
                ) : (
                  <>
                    <i className="ri-save-line"></i>
                    <span>Mettre à jour le mot de passe</span>
                  </>
                )}
              </button>
            </div>
          </form>
        </div>
      </main>
    </div>
  );
}

export default function ResetPasswordPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
      </div>
    }>
      <ResetPasswordContent />
    </Suspense>
  );
}

================
File: components.json
================
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}

================
File: components/ActivityCard.tsx
================
'use client'

import React from 'react'
import { useIntersectionObserver } from '@/lib/hooks/useIntersectionObserver'
import { useOptimisticActivityReadStatus } from '@/lib/hooks/useOptimisticActivityReadStatus'

interface ActivityCardProps {
  children: React.ReactNode
  activityId: string
  isRead: boolean
  onMarkAsRead: (id: string) => void
  isResponsive?: boolean
}

export default function ActivityCard({ 
  children, 
  activityId, 
  isRead: initialIsRead, 
  onMarkAsRead,
  isResponsive = false 
}: ActivityCardProps) {
  const { elementRef, isIntersecting } = useIntersectionObserver({
    threshold: 0.8, // 80% de l'élément visible
    freezeOnceVisible: true
  })

  const { isRead, markAsRead, hasPendingUpdate } = useOptimisticActivityReadStatus(
    activityId,
    initialIsRead
  )

  // Marquer comme lu quand visible (uniquement en responsive)
  React.useEffect(() => {
    if (isResponsive && isIntersecting && !isRead) {
      markAsRead()
      onMarkAsRead(activityId) // Pour la compatibilité avec l'ancien système
    }
  }, [isIntersecting, isRead, activityId, onMarkAsRead, isResponsive, markAsRead])

  // Cloner les enfants et ajouter les props optimistes
  const childrenWithOptimisticProps = React.cloneElement(children as React.ReactElement<any>, {
    'data-is-read': isRead,
    'data-has-pending': hasPendingUpdate,
    'data-original-is-read': initialIsRead
  })

  return (
    <div ref={elementRef}>
      {childrenWithOptimisticProps}
    </div>
  )
}

================
File: components/AdminActivity.tsx
================
'use client';

import { useState, useEffect, useMemo } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { ActivitiesService } from '@/lib/services/activities';
import { ActivityReadStatusCache } from '@/lib/services/activity-read-status-cache';
import ActivityCard from './ActivityCard';
import { getActivityConfig } from '@/lib/utils/activity-config';

interface ActivityItem {
  id: string;
  type: 'nouveau_dossier' | 'validation_devis' | 'refus_devis' | 'finalisation' | 'nouveau_apporteur' | 'modification_dossier';
  apporteurNom: string;
  apporteurPrenom: string;
  clientNom?: string;
  clientPrenom?: string;
  numeroDossier?: string;
  date: string;
  statut?: string;
  montant?: number;
}

interface AdminActivityProps {
  // Props pour filtrer les activités si nécessaire
  limit?: number;
}

export default function AdminActivity({ limit = 10 }: AdminActivityProps) {
  const router = useRouter();
  const [activities, setActivities] = useState<ActivityItem[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [filter, setFilter] = useState<string>('tous');

  // TODO: SUPABASE INTEGRATION - Récupérer les activités depuis la base de données
  // Cette fonction devra être remplacée par une vraie requête Supabase qui récupère :
  // 1. Les nouveaux dossiers créés (table: dossiers) avec jointure sur client_infos et apporteur_profiles
  // 2. Les validations/refus de devis (table: devis_history ou process_steps)
  // 3. Les finalisations de dossiers (table: dossiers avec statut 'finalise')
  // 4. Les nouveaux apporteurs inscrits (table: apporteur_profiles)
  // 5. Les modifications de dossiers (table: dossier_history ou audit_log)
  //
  // Query suggérée :
  // const { data: activitiesData, error } = await supabase
  //   .from('activities_view') // Vue SQL combinant toutes les activités
  //   .select(`
  //     id,
  //     type,
  //     created_at,
  //     apporteur_profiles!inner(nom, prenom),
  //     client_infos(nom, prenom),
  //     dossiers(numero_dossier, statut),
  //     montant,
  //     metadata
  //   `)
  //   .order('created_at', { ascending: false })
  //   .limit(limit || 50);
  const fetchActivities = async () => {
    setIsLoading(true);
    try {
      // Simulation temporaire - À remplacer par l'appel Supabase
      await new Promise(resolve => setTimeout(resolve, 1000));

      // TODO: SUPABASE - Ces données mockées représentent tous les types d'activités
      // que la base de données devra pouvoir fournir :
      const mockActivities: ActivityItem[] = [
        // ACTIVITÉ TYPE 1: nouveau_dossier
        // Source DB: table 'dossiers' avec created_at récent + jointures
        // Trigger: INSERT sur table dossiers avec is_draft = false
        {
          id: '1',
          type: 'nouveau_dossier',
          apporteurNom: 'Dubois',
          apporteurPrenom: 'Marie',
          clientNom: 'Martin',
          clientPrenom: 'Pierre',
          numeroDossier: 'DOS123456',
          date: '2024-01-22T10:30:00Z',
          statut: 'en_attente'
        },
        // ACTIVITÉ TYPE 2: validation_devis
        // Source DB: table 'process_steps' ou 'devis_history' avec action = 'validated'
        // Trigger: UPDATE sur process_steps avec step_name = 'devis' et status = 'completed'
        {
          id: '2',
          type: 'validation_devis',
          apporteurNom: 'Lambert',
          apporteurPrenom: 'Thomas',
          clientNom: 'Durand',
          clientPrenom: 'Sophie',
          numeroDossier: 'DOS789012',
          date: '2024-01-22T09:45:00Z',
          montant: 4250 // économies réalisées ou montant du prêt
        },
        // ACTIVITÉ TYPE 3: refus_devis
        // Source DB: table 'process_steps' ou 'devis_history' avec action = 'rejected'
        // Trigger: UPDATE sur process_steps avec step_name = 'devis' et status = 'rejected'
        {
          id: '3',
          type: 'refus_devis',
          apporteurNom: 'Bernard',
          apporteurPrenom: 'Claire',
          clientNom: 'Leroy',
          clientPrenom: 'Antoine',
          numeroDossier: 'DOS345678',
          date: '2024-01-22T08:20:00Z'
        },
        // ACTIVITÉ TYPE 4: nouveau_apporteur
        // Source DB: table 'apporteur_profiles' avec created_at récent
        // Trigger: INSERT sur table apporteur_profiles
        {
          id: '4',
          type: 'nouveau_apporteur',
          apporteurNom: 'Moreau',
          apporteurPrenom: 'Julien',
          date: '2024-01-22T07:15:00Z'
        },
        // ACTIVITÉ TYPE 5: finalisation
        // Source DB: table 'dossiers' avec statut = 'finalise' et updated_at récent
        // Trigger: UPDATE sur dossiers avec statut changé vers 'finalise'
        {
          id: '5',
          type: 'finalisation',
          apporteurNom: 'Roux',
          apporteurPrenom: 'Emma',
          clientNom: 'Garcia',
          clientPrenom: 'Luis',
          numeroDossier: 'DOS567890',
          date: '2024-01-21T16:30:00Z',
          montant: 6780 // montant de la commission ou économies
        },
        // ACTIVITÉ TYPE 6: modification_dossier
        // Source DB: table 'dossier_history' ou audit trail
        // Trigger: UPDATE significatif sur dossiers ou client_infos
        {
          id: '6',
          type: 'modification_dossier',
          apporteurNom: 'Petit',
          apporteurPrenom: 'Lucas',
          clientNom: 'Robert',
          clientPrenom: 'Marie',
          numeroDossier: 'DOS234567',
          date: '2024-01-21T14:45:00Z'
        },
        {
          id: '7',
          type: 'nouveau_dossier',
          apporteurNom: 'Girard',
          apporteurPrenom: 'Alice',
          clientNom: 'Bonnet',
          clientPrenom: 'Jean',
          numeroDossier: 'DOS678901',
          date: '2024-01-21T11:20:00Z',
          statut: 'en_cours'
        },
        {
          id: '8',
          type: 'validation_devis',
          apporteurNom: 'Rousseau',
          apporteurPrenom: 'Paul',
          clientNom: 'Vincent',
          clientPrenom: 'Laura',
          numeroDossier: 'DOS789123',
          date: '2024-01-21T09:10:00Z',
          montant: 3890
        }
      ];

      setActivities(mockActivities);
    } catch (error) {
      console.error('Erreur lors du chargement des activités:', error);
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    fetchActivities();
  }, []);

  // Filtrer les activités selon le filtre sélectionné
  const filteredActivities = useMemo(() => {
    let filtered = activities;
    
    if (filter !== 'tous') {
      filtered = activities.filter(activity => activity.type === filter);
    }
    
    return filtered.slice(0, limit);
  }, [activities, filter, limit]);

  // ✅ Utilisation de la configuration centralisée depuis lib/utils/activity-config.ts

  // Générer le message d'activité
  const getActivityMessage = (activity: ActivityItem) => {
    const config = getActivityConfig(activity.type);
    
    switch (activity.type) {
      case 'nouveau_dossier':
        return (
          <div>
            <span className="font-medium">{activity.apporteurPrenom} {activity.apporteurNom}</span>
            <span className="text-gray-600 dark:text-gray-400"> a soumis un nouveau dossier pour </span>
            <span className="font-medium">{activity.clientPrenom} {activity.clientNom}</span>
          </div>
        );
      case 'validation_devis':
        return (
          <div>
            <span className="font-medium">{activity.apporteurPrenom} {activity.apporteurNom}</span>
            <span className="text-gray-600 dark:text-gray-400"> a validé le devis pour </span>
            <span className="font-medium">{activity.clientPrenom} {activity.clientNom}</span>
            {activity.montant && (
              <span className="text-green-600 dark:text-green-400 font-medium">
                {' '}({formatAmount(activity.montant)})
              </span>
            )}
          </div>
        );
      case 'refus_devis':
        return (
          <div>
            <span className="font-medium">{activity.apporteurPrenom} {activity.apporteurNom}</span>
            <span className="text-gray-600 dark:text-gray-400"> a refusé le devis pour </span>
            <span className="font-medium">{activity.clientPrenom} {activity.clientNom}</span>
          </div>
        );
      case 'finalisation':
        return (
          <div>
            <span className="text-gray-600 dark:text-gray-400">Dossier finalisé pour </span>
            <span className="font-medium">{activity.clientPrenom} {activity.clientNom}</span>
            <span className="text-gray-600 dark:text-gray-400"> par </span>
            <span className="font-medium">{activity.apporteurPrenom} {activity.apporteurNom}</span>
            {activity.montant && (
              <span className="text-purple-600 dark:text-purple-400 font-medium">
                {' '}({formatAmount(activity.montant)})
              </span>
            )}
          </div>
        );
      case 'nouveau_apporteur':
        return (
          <div>
            <span className="font-medium">{activity.apporteurPrenom} {activity.apporteurNom}</span>
            <span className="text-gray-600 dark:text-gray-400"> a rejoint la plateforme</span>
          </div>
        );
      case 'modification_dossier':
        return (
          <div>
            <span className="font-medium">{activity.apporteurPrenom} {activity.apporteurNom}</span>
            <span className="text-gray-600 dark:text-gray-400"> a modifié le dossier de </span>
            <span className="font-medium">{activity.clientPrenom} {activity.clientNom}</span>
          </div>
        );
      default:
        return <span>Activité inconnue</span>;
    }
  };

  // Formatage des dates (même format que ApporteurActivity)
  const formatTimeAgo = (dateString: string): string => {
    const now = new Date();
    const date = new Date(dateString);
    const diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));

    if (diffInMinutes < 60) {
      return `Il y a ${diffInMinutes}min`;
    } else if (diffInMinutes < 1440) { // 24 heures
      const hours = Math.floor(diffInMinutes / 60);
      return `Il y a ${hours}h`;
    } else if (diffInMinutes < 2880) { // 48 heures
      return 'Hier';
    } else {
      const days = Math.floor(diffInMinutes / 1440);
      return `${days} jours`;
    }
  };

  // Formatage des montants
  const formatAmount = (amount: number) => {
    return new Intl.NumberFormat('fr-FR', {
      style: 'currency',
      currency: 'EUR',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(amount);
  };

  // Navigation vers le détail d'un dossier
  const handleActivityClick = (activity: ActivityItem) => {
    if (activity.numeroDossier) {
      // TODO: SUPABASE - Vérifier que l'admin a accès à ce dossier
      router.push(`/admin/dossiers/${activity.numeroDossier}`);
    }
  };

  if (isLoading) {
    return (
      <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
        <div className="animate-pulse">
          <div className="h-6 bg-gray-200 dark:bg-gray-700 rounded w-1/3 mb-6"></div>
          <div className="space-y-4">
            {[...Array(5)].map((_, i) => (
              <div key={i} className="flex items-center space-x-4">
                <div className="w-10 h-10 bg-gray-200 dark:bg-gray-700 rounded-xl"></div>
                <div className="flex-1">
                  <div className="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2"></div>
                  <div className="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl sm:text-2xl font-light text-gray-900 dark:text-white flex items-center">
          <i className="ri-pulse-line mr-3 text-[#335FAD] dark:text-[#335FAD]"></i>
          Activité récente
        </h2>
        <Link
          href="/admin/activites"
          className="text-[#335FAD] dark:text-[#335FAD] hover:text-[#335FAD]/80 dark:hover:text-[#335FAD]/80 text-sm font-medium cursor-pointer"
        >
          Tout voir
        </Link>
      </div>

      {/* Filtres sur une ligne scrollable */}
      <div className="mb-6">
        <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
          <button
            onClick={() => setFilter('tous')}
            className={`px-3 py-1.5 text-xs font-medium rounded-lg transition-colors cursor-pointer whitespace-nowrap flex-shrink-0 ${
              filter === 'tous'
                ? 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD]'
                : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600'
            }`}
          >
            Tous
          </button>
          <button
            onClick={() => setFilter('nouveau_dossier')}
            className={`px-3 py-1.5 text-xs font-medium rounded-lg transition-colors cursor-pointer whitespace-nowrap flex-shrink-0 ${
              filter === 'nouveau_dossier'
                ? 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD]'
                : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600'
            }`}
          >
            Nouveaux
          </button>
          <button
            onClick={() => setFilter('validation_devis')}
            className={`px-3 py-1.5 text-xs font-medium rounded-lg transition-colors cursor-pointer whitespace-nowrap flex-shrink-0 ${
              filter === 'validation_devis'
                ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400'
                : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600'
            }`}
          >
            Validations
          </button>
          <button
            onClick={() => setFilter('refus_devis')}
            className={`px-3 py-1.5 text-xs font-medium rounded-lg transition-colors cursor-pointer whitespace-nowrap flex-shrink-0 ${
              filter === 'refus_devis'
                ? 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'
                : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600'
            }`}
          >
            Refus
          </button>
          <button
            onClick={() => setFilter('finalisation')}
            className={`px-3 py-1.5 text-xs font-medium rounded-lg transition-colors cursor-pointer whitespace-nowrap flex-shrink-0 ${
              filter === 'finalisation'
                ? 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400'
                : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600'
            }`}
          >
            Finalisés
          </button>
          <button
            onClick={() => setFilter('nouveau_apporteur')}
            className={`px-3 py-1.5 text-xs font-medium rounded-lg transition-colors cursor-pointer whitespace-nowrap flex-shrink-0 ${
              filter === 'nouveau_apporteur'
                ? 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD]'
                : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600'
            }`}
          >
            Apporteurs
          </button>
          <button
            onClick={() => setFilter('modification_dossier')}
            className={`px-3 py-1.5 text-xs font-medium rounded-lg transition-colors cursor-pointer whitespace-nowrap flex-shrink-0 ${
              filter === 'modification_dossier'
                ? 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400'
                : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600'
            }`}
          >
            Modifications
          </button>
        </div>
      </div>

      {/* Liste des activités */}
      <div className="space-y-3 sm:space-y-4">
        {filteredActivities.length === 0 ? (
          <div className="text-center py-8">
            <div className="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
              <i className="ri-pulse-line text-gray-400 dark:text-gray-500 text-2xl"></i>
            </div>
            <p className="text-gray-500 dark:text-gray-400">Aucune activité récente</p>
          </div>
        ) : (
          filteredActivities.map((activity) => {
            const config = getActivityConfig(activity.type);
            
            return (
              <div key={activity.id} className="group">
                <div 
                  className={`flex items-start space-x-3 sm:space-x-4 p-3 sm:p-4 rounded-xl sm:rounded-2xl hover:bg-gray-50/50 dark:hover:bg-gray-700/50 transition-colors duration-200 border border-gray-100 dark:border-gray-700 ${activity.numeroDossier ? 'cursor-pointer' : ''}`}
                  onClick={() => handleActivityClick(activity)}
                >
                  {/* Icon */}
                  <div className={`w-10 h-10 sm:w-12 sm:h-12 ${config.bgColor} border border-gray-200 dark:border-gray-600 rounded-xl sm:rounded-2xl flex items-center justify-center flex-shrink-0`}>
                    <i className={`${config.icon} ${config.color} text-base sm:text-lg`}></i>
                  </div>

                  {/* Content */}
                  <div className="flex-1 min-w-0">
                    <div className="flex flex-col sm:flex-row sm:items-start justify-between gap-2 sm:gap-4">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-start justify-between gap-2 lg:block">
                          <p className="font-medium text-gray-900 dark:text-white text-sm sm:text-base flex-1">
                            {getActivityMessage(activity)}
                          </p>
                          {/* Date - Mobile: à côté du titre, Desktop: au-dessus du badge */}
                          <p className="text-gray-400 dark:text-gray-500 text-xs font-medium flex-shrink-0 lg:hidden">
                            {formatTimeAgo(activity.date)}
                          </p>
                        </div>
                        {activity.numeroDossier && (
                          <p className="text-gray-500 dark:text-gray-400 text-xs sm:text-sm mt-1 break-words">
                            {activity.numeroDossier}
                          </p>
                        )}
                      </div>
                      
                      {/* Status/Amount et Date - Desktop: colonne droite */}
                      <div className="flex-shrink-0 w-full sm:w-auto flex flex-col sm:items-end gap-2">
                        {/* Date - Desktop: au-dessus du badge */}
                        <p className="text-gray-400 dark:text-gray-500 text-xs font-medium hidden lg:block text-right">
                          {formatTimeAgo(activity.date)}
                        </p>
                        
                        {activity.montant && (
                          <span className="inline-flex items-center px-2 sm:px-3 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-700 w-full sm:w-auto justify-center sm:justify-start">
                            {formatAmount(activity.montant)}
                          </span>
                        )}
                        {activity.statut && (
                          <span className="inline-flex items-center px-2 sm:px-3 py-1 rounded-full text-xs font-medium bg-[#335FAD]/10 dark:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD] border border-[#335FAD]/20 dark:border-[#335FAD]/70 w-full sm:w-auto justify-center sm:justify-start">
                            {activity.statut}
                          </span>
                        )}
                        
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          })
        )}
      </div>

    </div>
  );
}

// TODO: SUPABASE INTEGRATION - Structure de base de données recommandée
// 
// 1. TABLE: activities_log
//    - id (uuid, primary key)
//    - type (enum: 'nouveau_dossier', 'validation_devis', 'refus_devis', 'finalisation', 'nouveau_apporteur', 'modification_dossier')
//    - user_id (uuid, référence vers apporteur_profiles ou admin_users)
//    - dossier_id (uuid, référence vers dossiers, nullable pour nouveau_apporteur)
//    - client_id (uuid, référence vers client_infos, nullable)
//    - metadata (jsonb, pour stocker des infos supplémentaires comme montant, ancien_statut, etc.)
//    - created_at (timestamp)
//
// 2. TRIGGERS SQL à créer :
//    - ON INSERT dossiers (is_draft = false) -> INSERT activities_log (type = 'nouveau_dossier')
//    - ON UPDATE dossiers (statut vers 'finalise') -> INSERT activities_log (type = 'finalisation')
//    - ON INSERT apporteur_profiles -> INSERT activities_log (type = 'nouveau_apporteur')
//    - ON UPDATE process_steps (devis validé/refusé) -> INSERT activities_log (type = 'validation_devis'/'refus_devis')
//    - ON UPDATE dossiers/client_infos (modifications significatives) -> INSERT activities_log (type = 'modification_dossier')
//
// 3. VUE SQL recommandée : activities_view
//    SELECT 
//      al.id,
//      al.type,
//      al.created_at,
//      ap.nom as apporteur_nom,
//      ap.prenom as apporteur_prenom,
//      ci.nom as client_nom,
//      ci.prenom as client_prenom,
//      d.numero_dossier,
//      d.statut,
//      al.metadata->>'montant' as montant
//    FROM activities_log al
//    LEFT JOIN apporteur_profiles ap ON al.user_id = ap.user_id
//    LEFT JOIN dossiers d ON al.dossier_id = d.id
//    LEFT JOIN client_infos ci ON al.client_id = ci.id
//    ORDER BY al.created_at DESC;

================
File: components/AdminActivityConnected.tsx
================
'use client';

import { useState, useEffect, useMemo } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { supabase } from '@/lib/supabase';
import { ActivityReadStatusCache } from '@/lib/services/activity-read-status-cache';
import { getActivityConfig as getCentralizedActivityConfig } from '@/lib/utils/activity-config';
import { EmptyState } from '@/components/ui/empty-state';

interface ActivityItem {
  id: string;
  type: 'nouveau_dossier' | 'validation_devis' | 'finalisation' | 'devis_envoye' | 'devis_refuse' | 'modification_dossier';
  apporteurNom: string;
  apporteurPrenom: string;
  clientNom?: string;
  clientPrenom?: string;
  numeroDossier?: string;
  date: string;
  statut?: string;
  montant?: number;
  isRead?: boolean;
}

interface AdminActivityProps {
  limit?: number;
}

export default function AdminActivityConnected({ limit = 6 }: AdminActivityProps) {
  const router = useRouter();
  const [activities, setActivities] = useState<ActivityItem[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [filter, setFilter] = useState<string>('tous');

  const fetchActivities = async () => {
    setIsLoading(true);
    try {
      // Récupérer les activités depuis la vue activities_view
      const { data: activitiesData, error } = await supabase
        .from('activities_view')
        .select(`
          id,
          activity_type,
          activity_title,
          activity_description,
          created_at,
          apporteur_nom,
          apporteur_prenom,
          client_nom,
          client_prenom,
          numero_dossier,
          dossier_statut,
          economie_generee,
          montant_capital,
          numero_devis,
          devis_statut
        `)
        .order('created_at', { ascending: false })
        .limit(limit || 50);

      if (error) {
        console.error('Erreur lors de la récupération des activités:', error);
        throw error;
      }

      // Transformer les données de la DB en format ActivityItem et fusionner avec cache
      const transformedActivities: ActivityItem[] = (activitiesData || []).map((activity: any) => {
        // Mapper les types d'activités de la DB vers les types du composant
        let type: ActivityItem['type'] = 'modification_dossier';
        
        switch (activity.activity_type) {
          case 'dossier_created':
            type = 'nouveau_dossier';
            break;
          case 'devis_envoye':
            type = 'devis_envoye';
            break;
          case 'devis_accepte':
            type = 'validation_devis';
            break;
          case 'devis_refuse':
            type = 'devis_refuse';
            break;
          case 'dossier_finalise':
            type = 'finalisation';
            break;
          // Types non affichés pour l'admin mais gérés pour éviter les erreurs
          case 'dossier_attribue':
          case 'dossier_supprime':
          case 'classement_updated':
            type = 'modification_dossier';
            break;
          default:
            type = 'modification_dossier';
        }

        // Fusionner avec le cache local
        const cachedStatus = ActivityReadStatusCache.getReadStatus(activity.id);
        const finalIsRead = cachedStatus !== null ? cachedStatus : (activity.is_read || false);

        return {
          id: activity.id,
          type,
          apporteurNom: activity.apporteur_nom || 'N/A',
          apporteurPrenom: activity.apporteur_prenom || 'N/A',
          clientNom: activity.client_nom,
          clientPrenom: activity.client_prenom,
          numeroDossier: activity.numero_dossier,
          date: activity.created_at,
          statut: activity.dossier_statut,
          montant: activity.economie_generee || activity.montant_capital,
          isRead: finalIsRead
        };
      });

      setActivities(transformedActivities);
    } catch (error) {
      console.error('Erreur lors du chargement des activités:', error);
      // En cas d'erreur, utiliser des données vides plutôt que de planter
      setActivities([]);
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    fetchActivities();
  }, []);

  // Filtrer les activités selon le filtre sélectionné
  const filteredActivities = useMemo(() => {
    let filtered = activities;
    
    if (filter !== 'tous') {
      filtered = activities.filter(activity => activity.type === filter);
    }
    
    return filtered.slice(0, limit);
  }, [activities, filter, limit]);

  // Configuration des types d'activité
  const getActivityConfig = (type: string) => {
    switch (type) {
      case 'nouveau_dossier':
        return {
          icon: 'ri-file-add-line',
          color: 'text-[#335FAD] dark:text-[#335FAD]',
          bgColor: 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30',
          label: 'Nouveau dossier'
        };
      case 'devis_envoye':
        return {
          icon: 'ri-send-plane-line',
          color: 'text-orange-600 dark:text-orange-400',
          bgColor: 'bg-orange-100 dark:bg-orange-900/30',
          label: 'Devis envoyé'
        };
      case 'validation_devis':
        return {
          icon: 'ri-checkbox-circle-line',
          color: 'text-green-600 dark:text-green-400',
          bgColor: 'bg-green-100 dark:bg-green-900/30',
          label: 'Devis accepté'
        };
      case 'devis_refuse':
        return {
          icon: 'ri-close-circle-line',
          color: 'text-red-600 dark:text-red-400',
          bgColor: 'bg-red-100 dark:bg-red-900/30',
          label: 'Devis refusé'
        };
      case 'finalisation':
        return {
          icon: 'ri-award-line',
          color: 'text-purple-600 dark:text-purple-400',
          bgColor: 'bg-purple-100 dark:bg-purple-900/30',
          label: 'Dossier finalisé'
        };
      default:
        return {
          icon: 'ri-edit-line',
          color: 'text-gray-600 dark:text-gray-400',
          bgColor: 'bg-gray-100 dark:bg-gray-900/30',
          label: 'Modification'
        };
    }
  };

  // Formatage de date relative (spécifique aux activités)
  const formatRelativeDate = (dateString: string) => {
    const date = new Date(dateString);
    const now = new Date();
    const diffInHours = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60));
    
    if (diffInHours < 1) {
      return 'Il y a moins d\'une heure';
    } else if (diffInHours < 24) {
      return `Il y a ${diffInHours}h`;
    } else {
      const diffInDays = Math.floor(diffInHours / 24);
      return `Il y a ${diffInDays} jour${diffInDays > 1 ? 's' : ''}`;
    }
  };

  const formatMontant = (montant?: number) => {
    if (!montant) return '';
    return new Intl.NumberFormat('fr-FR', {
      style: 'currency',
      currency: 'EUR',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(montant);
  };

  // Fonction pour marquer une activité comme lue (optimiste)
  const markActivityAsRead = (activityId: string) => {
    // Mise à jour optimiste immédiate
    setActivities(prev => prev.map(activity => 
      activity.id === activityId ? { ...activity, isRead: true } : activity
    ));
    
    // Ajouter au cache pour synchronisation en arrière-plan
    ActivityReadStatusCache.markAsReadOptimistic(activityId);
  };

  const handleActivityClick = async (activity: ActivityItem) => {
    // Naviguer vers le dossier
    if (activity.numeroDossier) {
      router.push(`/admin/dossiers/${activity.numeroDossier}`);
    }
  };

  if (isLoading) {
    return (
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div className="flex items-center justify-between mb-6">
          <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
            Activité récente
          </h3>
        </div>
        <div className="space-y-4">
          {[...Array(5)].map((_, i) => (
            <div key={i} className="flex items-center space-x-3 animate-pulse">
              <div className="w-10 h-10 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
              <div className="flex-1 space-y-2">
                <div className="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                <div className="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
      <div className="flex items-center justify-between mb-6">
        <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
          Activité récente
        </h3>
        <div className="flex space-x-2">
          <select
            value={filter}
            onChange={(e) => setFilter(e.target.value)}
            className="text-sm border border-gray-300 dark:border-gray-600 rounded-md px-3 py-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
          >
            <option value="tous">Tous</option>
            <option value="nouveau_dossier">Nouveaux dossiers</option>
            <option value="devis_envoye">Devis envoyés</option>
            <option value="validation_devis">Devis acceptés</option>
            <option value="devis_refuse">Devis refusés</option>
            <option value="finalisation">Finalisations</option>
          </select>
        </div>
      </div>

      {filteredActivities.length === 0 ? (
        <EmptyState
          icon={filter !== 'tous' ? 'ri-filter-off-line' : 'ri-history-line'}
          title={filter !== 'tous' ? 'Aucun résultat' : 'Pas encore d\'activité'}
          description={
            filter !== 'tous'
              ? 'Aucune activité ne correspond à ce filtre.'
              : 'Les actions de vos apporteurs apparaîtront ici.'
          }
          variant="compact"
        />
      ) : (
        <div className="space-y-4">
          {filteredActivities.map((activity) => {
            const config = getActivityConfig(activity.type);
            return (
              <div
                key={activity.id}
                onClick={() => handleActivityClick(activity)}
                onMouseEnter={() => !activity.isRead && markActivityAsRead(activity.id)}
                className="flex items-start space-x-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer transition-colors"
              >
                <div className={`flex-shrink-0 w-10 h-10 rounded-full ${config.bgColor} flex items-center justify-center`}>
                  <i className={`${config.icon} ${config.color} text-lg`}></i>
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center justify-between">
                    <p className="text-sm font-medium text-gray-900 dark:text-white">
                      {config.label}
                    </p>
                    <p className="text-xs text-gray-500 dark:text-gray-400">
                      {formatRelativeDate(activity.date)}
                    </p>
                  </div>
                  <div className="mt-1">
                    <p className="text-sm text-gray-600 dark:text-gray-300">
                      <span className="font-medium">
                        {activity.apporteurPrenom} {activity.apporteurNom}
                      </span>
                      {activity.clientNom && activity.clientPrenom && (
                        <>
                          {' '}pour{' '}
                          <span className="font-medium">
                            {activity.clientPrenom} {activity.clientNom}
                          </span>
                        </>
                      )}
                    </p>
                    {activity.numeroDossier && (
                      <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        Dossier {activity.numeroDossier}
                      </p>
                    )}
                    {activity.montant && (
                      <p className="text-xs text-green-600 dark:text-green-400 mt-1 font-medium">
                        {formatMontant(activity.montant)}
                      </p>
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}

      <div className="mt-4 text-center">
        <Link
          href="/admin/activites"
          className="text-sm text-[#335FAD] hover:text-[#2a4d8a] dark:text-[#335FAD] dark:hover:text-[#2a4d8a] font-medium"
        >
          Tout voir
        </Link>
      </div>
    </div>
  );
}

================
File: components/AdminHeader.tsx
================
'use client';

import { useEffect, useRef, useState, useMemo } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { usePathname } from 'next/navigation';
import { useBrokerContext } from '@/hooks/useBrokerContext';
import { ActivitiesService } from '@/lib/services/activities';
import { ActivityReadStatusCache } from '@/lib/services/activity-read-status-cache';

interface AdminData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
}

interface AdminHeaderProps {
  darkMode: boolean;
  setDarkMode: (darkMode: boolean) => void;
  adminData: AdminData;
}

interface Notification {
  id: string;
  type: 'success' | 'info' | 'warning' | 'error';
  title: string;
  description: string;
  time: string;
  isRead: boolean;
  apporteurName?: string;
  clientName?: string;
  dossierNumber?: string;
  dossierId?: string;
}

export default function AdminHeader({ darkMode, setDarkMode, adminData }: AdminHeaderProps) {
  const [showUserMenu, setShowUserMenu] = useState(false);
  const [showNotificationsMenu, setShowNotificationsMenu] = useState(false);
  const [showMobileMenu, setShowMobileMenu] = useState(false);
  const menuRef = useRef<HTMLDivElement>(null);
  const notificationsRef = useRef<HTMLDivElement>(null);
  const pathname = usePathname();
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const { brokers, currentBrokerId, selectBroker } = useBrokerContext();

  // Compter les notifications non lues
  const unreadCount = useMemo(() =>
    notifications.filter(n => !n.isRead).length,
    [notifications]
  );

  // Fermer les menus au clic extérieur
  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (menuRef.current && !menuRef.current.contains(e.target as Node)) {
        setShowUserMenu(false);
        setShowMobileMenu(false);
      }
      if (notificationsRef.current && !notificationsRef.current.contains(e.target as Node)) {
        setShowNotificationsMenu(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // Charger les notifications filtrées depuis la DB
  useEffect(() => {
    fetchNotifications();

    // Actualisation automatique toutes les 30 secondes
    const interval = setInterval(() => {
      fetchNotifications();
    }, 30000);

    // Écouter les changements du cache pour rafraîchir l'UI
    const unsubscribe = ActivityReadStatusCache.onSync(() => {
      // Recalculer le compteur basé sur le cache local
      setNotifications(prev => prev.map(n => {
        const cachedStatus = ActivityReadStatusCache.getReadStatus(n.id);
        return cachedStatus !== null ? { ...n, isRead: cachedStatus } : n;
      }));
    });

    return () => {
      clearInterval(interval);
      unsubscribe();
    };
  }, []);

  // Fonction pour récupérer les notifications filtrées (actions des apporteurs uniquement)
  const fetchNotifications = async () => {
    try {
      const data = await ActivitiesService.getNotificationsForAdmin(10);

      // Formater les activités en notifications et fusionner avec cache
      const formatted = data?.map((activity: any) => {
        const activityData = activity.activity_data || {};
        let type: 'success' | 'info' | 'warning' | 'error' = 'info';

        switch (activity.activity_type) {
          case 'dossier_created':
            type = 'info';
            break;
          case 'devis_accepte':
            type = 'success';
            break;
          case 'devis_refuse':
            type = 'error';
            break;
          case 'dossier_finalise':
            type = 'success';
            break;
        }

        // Fusionner avec le cache local
        const cachedStatus = ActivityReadStatusCache.getReadStatus(activity.id);
        const finalIsRead = cachedStatus !== null ? cachedStatus : (activity.is_read || false);

        return {
          id: activity.id,
          type,
          title: activity.activity_title,
          description: activity.activity_description,
          time: formatTimeAgo(activity.created_at),
          isRead: finalIsRead,
          apporteurName: activity.apporteur_nom && activity.apporteur_prenom
            ? `${activity.apporteur_prenom} ${activity.apporteur_nom}`
            : undefined,
          clientName: activity.client_nom && activity.client_prenom
            ? `${activity.client_prenom} ${activity.client_nom}`
            : undefined,
          dossierNumber: activity.numero_dossier,
          dossierId: activity.dossier_id
        };
      }) || [];

      setNotifications(formatted);
    } catch (error) {
      console.error('Erreur lors du chargement des notifications:', error);
    }
  };

  // Fonction pour gérer le clic sur une notification
  const handleNotificationClick = async (notification: Notification) => {
    // Marquer comme lu
    await markAsRead(notification.id);
    // Fermer le panneau
    setShowNotificationsMenu(false);
    // Naviguer vers le dossier si disponible
    if (notification.dossierId) {
      window.location.href = `/admin/dossiers/${notification.dossierId}`;
    }
  };

  // Fonction pour marquer une notification comme lue (optimiste)
  const markAsRead = (notificationId: string) => {
    // Mise à jour optimiste immédiate
    setNotifications(prev => prev.map(n =>
      n.id === notificationId ? { ...n, isRead: true } : n
    ));

    // Ajouter au cache pour synchronisation en arrière-plan
    ActivityReadStatusCache.markAsReadOptimistic(notificationId);
  };

  // Fonction pour formater le temps écoulé
  const formatTimeAgo = (dateString: string): string => {
    const now = new Date();
    const date = new Date(dateString);
    const diff = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));
    if (diff < 60) return `Il y a ${diff}min`;
    if (diff < 1440) return `Il y a ${Math.floor(diff / 60)}h`;
    if (diff < 2880) return 'Hier';
    return `${Math.floor(diff / 1440)} jours`;
  };

  const handleDarkModeToggle = () => {
    setDarkMode(!darkMode);
  };

  return (
    <>
      <header className="fixed top-0 left-0 right-0 z-50 bg-gray-100/95 backdrop-blur-md shadow-lg border-b border-gray-200 transition-colors duration-300 dark:bg-gray-900/80 dark:border-gray-700">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-50">
          <nav className="flex items-center justify-between h-16 lg:h-20">
            <Link href="/admin" className="flex items-center space-x-2 cursor-pointer transition-transform hover:scale-105">
              <Image
                className="h-10 w-auto drop-shadow-sm transition-all"
                src="/assets/svgs/gmb-courtagegrand.svg"
                alt="GMB Courtage logo"
                width={175}
                height={34}
                style={{
                  filter: darkMode ? 'brightness(0) invert(1)' : 'brightness(0) saturate(100%) invert(8%) sepia(40%) saturate(6266%) hue-rotate(223deg) brightness(95%) contrast(98%)'
                }}
              />
              <div className="hidden sm:block">
                <p className="text-[11px] text-gray-600 dark:text-gray-400 -mt-1">Espace Admin</p>
              </div>
            </Link>

            {/* Navigation Desktop */}
            <div className="hidden xl:flex items-center space-x-4">
              <Link
                href="/admin"
                className={`relative px-5 py-2.5 text-sm lg:text-base font-medium transition-colors rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 ${pathname === '/admin' ? 'text-[#335FAD] dark:text-white bg-gray-100 dark:bg-gray-700' : 'text-gray-600 dark:text-white hover:text-black dark:hover:text-white'
                  }`}
              >
                Accueil
              </Link>

              {/* Broker Selector (Feature 1) */}
              {brokers.length > 1 && (
                <div className="relative">
                  <select
                    value={currentBrokerId || ''}
                    onChange={(e) => selectBroker(e.target.value)}
                    className="appearance-none bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-[#335FAD] focus:border-[#335FAD] block w-full px-3 py-2.5 pr-8 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
                    style={{ minWidth: '150px' }}
                  >
                    {brokers.map((broker) => (
                      <option key={broker.id} value={broker.id}>
                        {broker.name}
                      </option>
                    ))}
                  </select>
                  <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                    <i className="ri-arrow-down-s-line text-xs"></i>
                  </div>
                </div>
              )}

              <Link
                href="/admin/dossiers"
                className={`relative px-5 py-2.5 text-sm lg:text-base font-medium transition-colors rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 ${pathname.startsWith('/admin/dossiers') ? 'text-[#335FAD] dark:text-white bg-gray-100 dark:bg-gray-700' : 'text-gray-600 dark:text-white hover:text-black dark:hover:text-white'
                  }`}
              >
                Gestion des dossiers
              </Link>
              <Link
                href="/admin/apporteurs"
                className={`relative px-5 py-2.5 text-sm lg:text-base font-medium transition-colors rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 ${pathname.startsWith('/admin/apporteurs') ? 'text-[#335FAD] dark:text-white bg-gray-100 dark:bg-gray-700' : 'text-gray-600 dark:text-white hover:text-black dark:hover:text-white'
                  }`}
              >
                Apporteurs
              </Link>
              <Link
                href="/admin/statistiques"
                className={`relative px-5 py-2.5 text-sm lg:text-base font-medium transition-colors rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 ${pathname.startsWith('/admin/statistiques') ? 'text-[#335FAD] dark:text-white bg-gray-100 dark:bg-gray-700' : 'text-gray-600 dark:text-white hover:text-black dark:hover:text-white'
                  }`}
              >
                Statistiques
              </Link>

              {/* Notifications */}
              <div className="relative group" ref={notificationsRef}>
                <button
                  onClick={() => setShowNotificationsMenu(!showNotificationsMenu)}
                  className="relative w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 border border-gray-200 dark:border-gray-600 rounded-lg flex items-center justify-center transition-colors cursor-pointer"
                >
                  <i className="ri-notification-line text-gray-700 dark:text-gray-300"></i>
                  {unreadCount > 0 && (
                    <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
                      {unreadCount}
                    </span>
                  )}
                </button>

                <div className="absolute right-0 mt-4 w-80 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                  <div className="relative pt-2">
                    <div className="relative bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-xl py-2 max-h-96 overflow-y-auto">
                      <div className="px-4 py-2 border-b border-gray-200 dark:border-gray-700">
                        <div className="flex items-center justify-between">
                          <h3 className="text-sm font-medium text-gray-900 dark:text-white">Notifications</h3>
                          <button className="text-xs text-[#335FAD] dark:text-[#335FAD] hover:text-[#335FAD]/80 cursor-pointer">
                            Tout marquer comme lu
                          </button>
                        </div>
                      </div>

                      <div className="py-2">
                        {notifications.length === 0 ? (
                          <div className="px-4 py-8 text-center">
                            <p className="text-sm text-gray-500 dark:text-gray-400">Aucune notification</p>
                          </div>
                        ) : (
                          notifications.map((notification) => {
                            const getNotificationStyles = () => {
                              switch (notification.type) {
                                case 'success':
                                  return { bg: 'bg-green-100 dark:bg-green-900/30', icon: 'ri-checkbox-circle-line text-green-600 dark:text-green-400' };
                                case 'error':
                                  return { bg: 'bg-red-100 dark:bg-red-900/30', icon: 'ri-close-circle-line text-red-600 dark:text-red-400' };
                                case 'warning':
                                  return { bg: 'bg-amber-100 dark:bg-amber-900/30', icon: 'ri-alert-line text-amber-600 dark:text-amber-400' };
                                default:
                                  return { bg: 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30', icon: 'ri-information-line text-[#335FAD] dark:text-[#335FAD]' };
                              }
                            };
                            const styles = getNotificationStyles();

                            return (
                              <div
                                key={notification.id}
                                onClick={() => handleNotificationClick(notification)}
                                onMouseEnter={() => !notification.isRead && markAsRead(notification.id)}
                                className="px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer"
                              >
                                <div className="flex items-start space-x-3">
                                  <div className={`w-8 h-8 ${styles.bg} rounded-lg flex items-center justify-center flex-shrink-0`}>
                                    <i className={`${styles.icon} text-sm`}></i>
                                  </div>
                                  <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium text-gray-900 dark:text-white">{notification.title}</p>
                                    <p className="text-xs text-gray-500 dark:text-gray-400">
                                      {notification.description}
                                      {notification.apporteurName && ` - ${notification.apporteurName}`}
                                    </p>
                                    <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">{notification.time}</p>
                                  </div>
                                  {!notification.isRead && <div className="w-2 h-2 bg-red-500 rounded-full flex-shrink-0"></div>}
                                </div>
                              </div>
                            );
                          })
                        )}
                      </div>

                      <div className="px-4 py-2 border-t border-gray-200 dark:border-gray-700">
                        <Link href="/admin/activites?tab=notifications" className="block w-full text-center text-sm text-[#335FAD] dark:text-[#335FAD] hover:text-[#335FAD]/80 cursor-pointer" onClick={() => setShowNotificationsMenu(false)}>
                          Voir toutes les notifications
                        </Link>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Profil desktop */}
              <div className="relative hidden xl:block group" ref={menuRef}>
                <button
                  onClick={() => setShowUserMenu(!showUserMenu)}
                  className="flex items-center gap-3 p-1.5 rounded-lg hover:bg-gray-200 border border-transparent hover:border-gray-300 dark:hover:border-gray-600 transition-colors cursor-pointer"
                >
                  <div className="w-9 h-9 bg-[#335FAD] rounded-lg flex items-center justify-center">
                    <span className="text-white text-sm font-medium">{adminData.initials}</span>
                  </div>
                  <div className="text-left">
                    <p className="text-sm font-medium text-gray-900 dark:text-white">{adminData.firstName} {adminData.lastName}</p>
                    <p className="text-xs text-gray-500 dark:text-gray-400">{adminData.role}</p>
                  </div>
                </button>
                <div className="absolute right-0 mt-4 w-56 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                  <div className="relative pt-2">
                    <div className="relative bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-xl py-2">
                      <Link href="/admin/profil" className="flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-50 dark:border-gray-700 cursor-pointer">
                        <i className="ri-user-line mr-3 text-gray-500 dark:text-gray-400 text-sm"></i>
                        Profil et paramètres
                      </Link>
                      <button className="w-full flex items-center px-4 py-2.5 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 cursor-pointer">
                        <i className="ri-logout-box-line mr-3 text-sm"></i>
                        Déconnexion
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              {/* Toggle dark mode */}
              <button
                onClick={handleDarkModeToggle}
                className="hidden md:flex w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg items-center justify-center transition-colors cursor-pointer"
                title={darkMode ? 'Mode clair' : 'Mode sombre'}
              >
                <i className={`${darkMode ? 'ri-sun-line' : 'ri-moon-line'} text-gray-700 dark:text-gray-300`}></i>
              </button>
            </div>

            {/* Mobile */}
            <div className="xl:hidden flex items-center space-x-2">
              {/* Bouton Notifications Mobile */}
              <div className="relative" ref={notificationsRef}>
                <button
                  onClick={() => setShowNotificationsMenu(!showNotificationsMenu)}
                  className="relative p-2.5 text-gray-700 dark:text-gray-200 hover:text-black rounded-xl bg-gray-100 hover:bg-gray-200 border border-gray-200 transition-all duration-200 active:scale-95"
                  aria-label="Notifications"
                >
                  <i className="ri-notification-line text-lg"></i>
                  {unreadCount > 0 && (
                    <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
                      {unreadCount}
                    </span>
                  )}
                </button>
              </div>

              {/* Bouton Burger */}
              <div ref={menuRef}>
                <button
                  onClick={() => setShowMobileMenu(!showMobileMenu)}
                  className="relative p-2.5 text-gray-700 dark:text-gray-200 hover:text-black rounded-xl bg-gray-100 hover:bg-gray-200 border border-gray-200 transition-all duration-200 active:scale-95"
                  aria-label="Toggle menu"
                >
                  <div className="w-5 h-5 relative">
                    <span className={`absolute left-0 block h-0.5 w-5 bg-current transform transition-all duration-300 ease-in-out ${showMobileMenu ? 'rotate-45 top-2' : 'top-0.5'}`}></span>
                    <span className={`absolute left-0 block h-0.5 w-5 bg-current transform transition-all duration-300 ease-in-out ${showMobileMenu ? 'opacity-0' : 'top-2'}`}></span>
                    <span className={`absolute left-0 block h-0.5 w-5 bg-current transform transition-all duration-300 ease-in-out ${showMobileMenu ? '-rotate-45 top-2' : 'top-3.5'}`}></span>
                  </div>
                </button>
              </div>

              {showMobileMenu && (
                <div className="absolute top-full right-0 w-screen mt-2 pb-4">
                  <div className="relative mx-4">
                    <div className="relative bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-xl overflow-hidden">
                      <div className="grid grid-cols-1 gap-2 p-4">
                        <Link href="/admin" className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${pathname === '/admin' ? 'bg-gray-100 text-[#335FAD]' : 'text-gray-700 dark:text-gray-200 hover:bg-gray-50 hover:text-black'}`} onClick={() => setShowMobileMenu(false)}><i className="ri-dashboard-line"></i>Accueil</Link>
                        <Link href="/admin/dossiers" className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${pathname.startsWith('/admin/dossiers') ? 'bg-gray-100 text-[#335FAD]' : 'text-gray-700 dark:text-gray-200 hover:bg-gray-50 hover:text-black'}`} onClick={() => setShowMobileMenu(false)}><i className="ri-folder-line"></i>Gestion des dossiers</Link>
                        <Link href="/admin/apporteurs" className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${pathname.startsWith('/admin/apporteurs') ? 'bg-gray-100 text-[#335FAD]' : 'text-gray-700 dark:text-gray-200 hover:bg-gray-50 hover:text-black'}`} onClick={() => setShowMobileMenu(false)}><i className="ri-team-line"></i>Apporteurs</Link>
                        <Link href="/admin/stats" className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${pathname.startsWith('/admin/stats') ? 'bg-gray-100 text-[#335FAD]' : 'text-gray-700 dark:text-gray-200 hover:bg-gray-50 hover:text-black'}`} onClick={() => setShowMobileMenu(false)}><i className="ri-line-chart-line"></i>Statistiques</Link>

                        {/* Profil (parité avec burger apporteur) */}
                        <div className="pt-2 border-t border-gray-200 dark:border-gray-700">
                          <div className="flex items-center space-x-3 mb-3 px-4">
                            <div className="w-10 h-10 bg-[#335FAD] rounded-lg flex items-center justify-center">
                              <span className="text-white text-sm font-medium">{adminData.initials}</span>
                            </div>
                            <div>
                              <p className="text-sm font-medium text-gray-900 dark:text-white">{adminData.firstName} {adminData.lastName}</p>
                              <p className="text-xs text-gray-500 dark:text-gray-400">{adminData.role}</p>
                            </div>
                          </div>
                          <div className="space-y-2 px-4 pb-2">
                            <Link href="/admin/profil" className="flex items-center gap-3 text-gray-700 dark:text-gray-200 hover:text-black hover:bg-gray-50 px-4 py-2 rounded-lg" onClick={() => setShowMobileMenu(false)}>
                              <i className="ri-user-line"></i>
                              Mon profil
                            </Link>
                            <Link href="/admin/parametres" className="flex items-center gap-3 text-gray-700 dark:text-gray-200 hover:text-black hover:bg-gray-50 px-4 py-2 rounded-lg" onClick={() => setShowMobileMenu(false)}>
                              <i className="ri-settings-line"></i>
                              Paramètres
                            </Link>
                            <button className="flex items-center gap-3 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 px-4 py-2 rounded-lg" onClick={() => setShowMobileMenu(false)}>
                              <i className="ri-logout-box-line"></i>
                              Déconnexion
                            </button>
                          </div>
                        </div>

                        <button onClick={() => { setShowMobileMenu(false); handleDarkModeToggle(); }} className="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-50 transition-colors text-left">
                          <i className={`ri-${darkMode ? 'sun' : 'moon'}-line`}></i>
                          <span>{darkMode ? 'Mode clair' : 'Mode sombre'}</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {showNotificationsMenu && (
                <div className="absolute top-full right-0 w-screen mt-2 pb-4">
                  <div className="relative mx-4">
                    <div className="relative bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-xl overflow-hidden">
                      <div className="px-4 py-2 border-b border-gray-200 dark:border-gray-700">
                        <div className="flex items-center justify-between">
                          <h3 className="text-sm font-medium text-gray-900 dark:text-white">Notifications</h3>
                          <button className="text-xs text-[#335FAD] dark:text-[#335FAD] hover:text-[#335FAD]/80 cursor-pointer">
                            Tout marquer comme lu
                          </button>
                        </div>
                      </div>

                      <div className="py-2 max-h-64 overflow-y-auto">
                        {notifications.length === 0 ? (
                          <div className="px-4 py-8 text-center">
                            <p className="text-sm text-gray-500 dark:text-gray-400">Aucune notification</p>
                          </div>
                        ) : (
                          notifications.map((notification) => {
                            const getNotificationStyles = () => {
                              switch (notification.type) {
                                case 'success':
                                  return { bg: 'bg-green-100 dark:bg-green-900/30', icon: 'ri-checkbox-circle-line text-green-600 dark:text-green-400' };
                                case 'error':
                                  return { bg: 'bg-red-100 dark:bg-red-900/30', icon: 'ri-close-circle-line text-red-600 dark:text-red-400' };
                                case 'warning':
                                  return { bg: 'bg-amber-100 dark:bg-amber-900/30', icon: 'ri-alert-line text-amber-600 dark:text-amber-400' };
                                default:
                                  return { bg: 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30', icon: 'ri-information-line text-[#335FAD] dark:text-[#335FAD]' };
                              }
                            };
                            const styles = getNotificationStyles();

                            return (
                              <div
                                key={notification.id}
                                onClick={() => handleNotificationClick(notification)}
                                onMouseEnter={() => !notification.isRead && markAsRead(notification.id)}
                                className="px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer"
                              >
                                <div className="flex items-start space-x-3">
                                  <div className={`w-8 h-8 ${styles.bg} rounded-lg flex items-center justify-center flex-shrink-0`}>
                                    <i className={`${styles.icon} text-sm`}></i>
                                  </div>
                                  <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium text-gray-900 dark:text-white">{notification.title}</p>
                                    <p className="text-xs text-gray-500 dark:text-gray-400">
                                      {notification.description}
                                      {notification.apporteurName && ` - ${notification.apporteurName}`}
                                    </p>
                                    <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">{notification.time}</p>
                                  </div>
                                  {!notification.isRead && <div className="w-2 h-2 bg-red-500 rounded-full flex-shrink-0"></div>}
                                </div>
                              </div>
                            );
                          })
                        )}
                      </div>

                      <div className="px-4 py-2 border-t border-gray-200 dark:border-gray-700">
                        <Link href="/admin/activites?tab=notifications" className="block w-full text-center text-sm text-[#335FAD] dark:text-[#335FAD] hover:text-[#335FAD]/80 cursor-pointer" onClick={() => setShowNotificationsMenu(false)}>
                          Voir toutes les notifications
                        </Link>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </nav>
        </div>
      </header>
      <div className="h-16 lg:h-20" aria-hidden></div>
    </>
  );
}

================
File: components/AdminStatsCards.tsx
================
'use client';

import { useMemo } from 'react';

interface AdminStats {
  dossiersEnAttente: number;
  dossiersValidationApporteur: number;
  dossiersFinalises: number;
  totalDossiers: number;
  nouveauxApporteurs: number;
  chiffreAffairesMois: number;
  progressionDossiers: number;
  progressionChiffre: number;
}

interface AdminStatsCardsProps {
  adminStats: AdminStats;
}

export default function AdminStatsCards({ adminStats }: AdminStatsCardsProps) {
  // Formatage des montants
  const formatAmount = (amount: number): string => {
    return new Intl.NumberFormat('fr-FR', {
      style: 'currency',
      currency: 'EUR',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(amount);
  };

  // Configuration des cartes de statistiques
  const statsCards = useMemo(() => [
    {
      title: 'En attente de traitement',
      value: adminStats.dossiersEnAttente,
      icon: 'ri-time-line',
      color: 'orange',
      bgColor: 'bg-orange-100 dark:bg-orange-900/30',
      textColor: 'text-orange-700 dark:text-orange-400',
      iconBg: 'bg-orange-100 dark:bg-orange-900/30',
      iconColor: 'text-orange-600 dark:text-orange-400',
      description: 'Dossiers à traiter',
      trend: null
    },
    {
      title: 'Validation apporteur',
      value: adminStats.dossiersValidationApporteur,
      icon: 'ri-user-check-line',
      color: 'blue',
      bgColor: 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30',
      textColor: 'text-[#335FAD] dark:text-[#335FAD]',
      iconBg: 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30',
      iconColor: 'text-[#335FAD] dark:text-[#335FAD]',
      description: 'En attente de validation',
      trend: null
    },
    {
      title: 'Finalisés ce mois',
      value: adminStats.dossiersFinalises,
      icon: 'ri-check-double-line',
      color: 'green',
      bgColor: 'bg-green-100 dark:bg-green-900/30',
      textColor: 'text-green-700 dark:text-green-400',
      iconBg: 'bg-green-100 dark:bg-green-900/30',
      iconColor: 'text-green-600 dark:text-green-400',
      description: 'Dossiers terminés',
      trend: `+${adminStats.progressionDossiers}%`,
      trendPositive: adminStats.progressionDossiers > 0
    },
    {
      title: 'Chiffre d\'affaires',
      value: formatAmount(adminStats.chiffreAffairesMois),
      icon: 'ri-money-euro-circle-line',
      color: 'indigo',
      bgColor: 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30',
      textColor: 'text-[#335FAD] dark:text-[#335FAD]',
      iconBg: 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30',
      iconColor: 'text-[#335FAD] dark:text-[#335FAD]',
      description: 'Ce mois-ci',
      trend: `+${adminStats.progressionChiffre}%`,
      trendPositive: adminStats.progressionChiffre > 0,
      isAmount: true
    },
    {
      title: 'Total dossiers',
      value: adminStats.totalDossiers,
      icon: 'ri-file-list-line',
      color: 'purple',
      bgColor: 'bg-purple-100 dark:bg-purple-900/30',
      textColor: 'text-purple-700 dark:text-purple-400',
      iconBg: 'bg-purple-100 dark:bg-purple-900/30',
      iconColor: 'text-purple-600 dark:text-purple-400',
      description: 'Tous les dossiers',
      trend: null
    },
    {
      title: 'Nouveaux apporteurs',
      value: adminStats.nouveauxApporteurs,
      icon: 'ri-user-add-line',
      color: 'teal',
      bgColor: 'bg-teal-100 dark:bg-teal-900/30',
      textColor: 'text-teal-700 dark:text-teal-400',
      iconBg: 'bg-teal-100 dark:bg-teal-900/30',
      iconColor: 'text-teal-600 dark:text-teal-400',
      description: 'Ce mois-ci',
      trend: null
    }
  ], [adminStats, formatAmount]);

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
      {statsCards.map((card, index) => (
        <div
          key={index}
          className="bg-white dark:bg-gray-800 rounded-2xl p-4 sm:p-6 border border-gray-200 dark:border-gray-700 hover:shadow-lg dark:hover:shadow-gray-900/20 transition-all duration-200"
        >
          <div className="flex items-center justify-between">
            <div className="flex-1 min-w-0">
              <div className="flex items-center space-x-3 mb-3">
                <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${card.iconBg}`}>
                  <i className={`${card.icon} ${card.iconColor} text-lg`}></i>
                </div>
                <div className="min-w-0 flex-1">
                  <p className="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">
                    {card.title}
                  </p>
                </div>
              </div>
              
              <div className="mb-2">
                <p className={`text-2xl sm:text-3xl font-light text-gray-900 dark:text-white ${card.isAmount ? 'text-xl sm:text-2xl' : ''}`}>
                  {card.value}
                </p>
              </div>
              
              <div className="flex items-center justify-between">
                <p className="text-xs text-gray-500 dark:text-gray-400">
                  {card.description}
                </p>
                
                {card.trend && (
                  <div className={`flex items-center space-x-1 ${
                    card.trendPositive 
                      ? 'text-green-600 dark:text-green-400' 
                      : 'text-red-600 dark:text-red-400'
                  }`}>
                    <i className={`${
                      card.trendPositive 
                        ? 'ri-arrow-up-line' 
                        : 'ri-arrow-down-line'
                    } text-xs`}></i>
                    <span className="text-xs font-medium">{card.trend}</span>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}

================
File: components/ApporteurActivity.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { ActivitiesService } from '@/lib/services/activities';
import { ActivityReadStatusCache } from '@/lib/services/activity-read-status-cache';
import { EmptyState } from '@/components/ui/empty-state';

// Interface pour les activités depuis Supabase
interface Activity {
  id: string;
  activity_type: string;
  activity_title: string;
  activity_description: string;
  activity_data?: any;
  created_at: string;
  is_read: boolean;
  dossier_id?: string;
  user_id?: string;
  // Données formatées pour l'affichage
  type?: 'success' | 'info' | 'warning' | 'error';
  amount?: string;
  status?: string;
  time?: string;
  icon?: string;
  client_name?: string;
  dossier_number?: string;
}

interface ApporteurActivityProps {
  userId: string;
}

export default function ApporteurActivity({ userId }: ApporteurActivityProps) {
  const router = useRouter();

  const [activities, setActivities] = useState<Activity[]>([]);

  const [isLoading, setIsLoading] = useState(false);

  // Navigation vers la page activités complète
  const handleViewAll = () => {
    router.push('/activites');
  };

  // Fonction pour marquer une activité comme lue (optimiste)
  const markActivityAsRead = (activityId: string) => {
    // Mise à jour optimiste immédiate
    setActivities(prev => prev.map(activity => 
      activity.id === activityId ? { ...activity, is_read: true } : activity
    ));
    
    // Ajouter au cache pour synchronisation en arrière-plan
    ActivityReadStatusCache.markAsReadOptimistic(activityId);
  };

  // Navigation vers le détail d'un dossier
  const handleActivityClick = (activity: Activity) => {
    // Naviguer vers le dossier
    if (activity.dossier_id) {
      router.push(`/dossier/${activity.dossier_id}`);
    }
  };

  // Fonction pour récupérer les activités depuis Supabase
  const fetchActivities = async () => {
    setIsLoading(true);
    try {
      console.log('🔍 fetchActivities - User ID:', userId);
      
      const data = await ActivitiesService.getActivitiesByUserId(userId);
      console.log('📊 fetchActivities - Données récupérées:', data?.length);
      
      // Formater les données et fusionner avec le cache local
      const formattedActivities = data?.map(activity => {
        const formatted = formatActivityForDisplay(activity);
        // Priorité au cache local
        const cachedStatus = ActivityReadStatusCache.getReadStatus(activity.id);
        const finalIsRead = cachedStatus !== null ? cachedStatus : activity.is_read;
        
        return {
          ...formatted,
          is_read: finalIsRead
        };
      }).slice(0, 6) || [];
      
      setActivities(formattedActivities);
    } catch (error) {
      console.error('❌ Erreur lors du chargement des activités:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // Fonction pour actualiser les activités
  const refreshActivities = async () => {
    await fetchActivities();
  };

  // Fonction pour formater une activité pour l'affichage
  const formatActivityForDisplay = (activity: any): Activity => {
    const activityData = activity.activity_data || {};
    
    // Déterminer le type et l'icône selon le type d'activité
    let type: 'success' | 'info' | 'warning' | 'error' = 'info';
    let icon = 'ri-file-line';
    let amount = '';
    let status = '';
    
    switch (activity.activity_type) {
      case 'dossier_created':
        type = 'info';
        icon = 'ri-file-add-line';
        status = 'Nouveau dossier';
        break;
        
      case 'dossier_attribue':
        type = 'info';
        icon = 'ri-user-received-line';
        status = 'Attribué par l\'admin';
        break;
        
      case 'devis_envoye':
        type = 'info';
        icon = 'ri-send-plane-line';
        status = 'Devis envoyé au client';
        break;
        
      case 'devis_accepte':
        type = 'success';
        icon = 'ri-check-double-line';
        amount = activityData.economie_generee ? `Économie : ${Number(activityData.economie_generee).toLocaleString()}€` : '';
        status = 'Devis accepté';
        break;
        
      case 'dossier_finalise':
        type = 'success';
        icon = 'ri-checkbox-circle-line';
        amount = activityData.economie_generee ? `Économie : ${Number(activityData.economie_generee).toLocaleString()}€` : '';
        status = 'Dossier finalisé';
        break;
        
      case 'dossier_supprime':
        type = 'error';
        icon = 'ri-delete-bin-line';
        status = 'Supprimé par l\'admin';
        break;
        
      case 'classement_updated':
        type = 'warning';
        icon = 'ri-trophy-line';
        status = 'Classement mis à jour';
        break;
        
      default:
        type = 'info';
        icon = 'ri-file-line';
        status = 'Activité';
    }

    return {
      ...activity,
      type,
      icon,
      amount,
      status,
      time: formatTimeAgo(activity.created_at),
      client_name: activityData.client_nom && activityData.client_prenom 
        ? `${activityData.client_prenom} ${activityData.client_nom}`
        : undefined,
      dossier_number: activityData.numero_dossier
    };
  };

  // Fonction utilitaire pour formater le temps écoulé
  const formatTimeAgo = (dateString: string): string => {
    const now = new Date();
    const date = new Date(dateString);
    const diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));

    if (diffInMinutes < 60) {
      return `Il y a ${diffInMinutes}min`;
    } else if (diffInMinutes < 1440) { // 24 heures
      const hours = Math.floor(diffInMinutes / 60);
      return `Il y a ${hours}h`;
    } else if (diffInMinutes < 2880) { // 48 heures
      return 'Hier';
    } else {
      const days = Math.floor(diffInMinutes / 1440);
      return `${days} jours`;
    }
  };

  useEffect(() => {
    // Charger les activités au montage du composant
    fetchActivities();

    // TODO: Configurer l'écoute en temps réel des nouvelles activités
    // const subscription = ActivitiesService.subscribeToActivities(userId, (payload) => {
    //   const newActivity = formatActivityForDisplay(payload.new);
    //   setActivities(prev => [newActivity, ...prev]);
    // });
    // 
    // return () => {
    //   ActivitiesService.unsubscribeFromActivities(subscription);
    // };
  }, [userId]);

  const getActivityStyles = (type: string) => {
    switch (type) {
      case 'success':
        return {
          bg: 'bg-green-50 dark:bg-green-900/20',
          icon: 'text-green-600 dark:text-green-400',
          border: 'border-green-200 dark:border-green-700'
        };
      case 'warning':
        return {
          bg: 'bg-amber-50 dark:bg-amber-900/20',
          icon: 'text-amber-600 dark:text-amber-400',
          border: 'border-amber-200 dark:border-amber-700'
        };
      case 'info':
        return {
          bg: 'bg-[#335FAD]/5 dark:bg-[#335FAD]/20',
          icon: 'text-[#335FAD] dark:text-[#335FAD]',
          border: 'border-[#335FAD]/20 dark:border-[#335FAD]/70'
        };
      case 'error':
        return {
          bg: 'bg-red-50 dark:bg-red-900/20',
          icon: 'text-red-600 dark:text-red-400',
          border: 'border-red-200 dark:border-red-700'
        };
      default:
        return {
          bg: 'bg-gray-50 dark:bg-gray-700',
          icon: 'text-gray-600 dark:text-gray-400',
          border: 'border-gray-200 dark:border-gray-600'
        };
    }
  };

  return (
    <div className="bg-white dark:bg-gray-800 rounded-2xl sm:rounded-3xl p-4 sm:p-6 lg:p-8 border-2 border-gray-100 dark:border-gray-700 transition-colors duration-300">
      <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 sm:mb-8 gap-3 sm:gap-0">
        <div>
          <h2 className="text-xl sm:text-2xl font-light text-gray-900 dark:text-white">Activité récente</h2>
          <p className="text-gray-400 dark:text-gray-500 text-xs sm:text-sm font-medium mt-1">Suivi de vos dossiers</p>
        </div>
        <button 
          onClick={handleViewAll}
          className="text-[#335FAD] dark:text-[#335FAD] hover:text-[#335FAD]/80 dark:hover:text-[#335FAD]/80 text-sm font-medium cursor-pointer self-start sm:self-auto whitespace-nowrap"
        >
          Tout voir
        </button>
      </div>

      {isLoading ? (
        <div className="flex items-center justify-center py-8">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#335FAD] dark:border-[#335FAD]"></div>
        </div>
      ) : activities.length === 0 ? (
        <EmptyState
          icon="ri-time-line"
          title="Pas encore d'activité"
          description="Votre historique est vide. Les actions sur vos dossiers apparaîtront ici."
          variant="compact"
        />
      ) : (
        <div className="space-y-3 sm:space-y-4">
          {activities.map((activity) => {
            const styles = getActivityStyles(activity.type || 'info');
            
            return (
              <div key={activity.id} className="group">
                <div 
                  className={`flex items-start space-x-3 sm:space-x-4 p-3 sm:p-4 rounded-xl sm:rounded-2xl hover:bg-gray-50/50 dark:hover:bg-gray-700/50 transition-colors duration-200 border border-gray-100 dark:border-gray-700 ${activity.dossier_number ? 'cursor-pointer' : ''}`}
                  onClick={() => handleActivityClick(activity)}
                  onMouseEnter={() => !activity.is_read && markActivityAsRead(activity.id)}
                >
                  {/* Icon */}
                  <div className={`w-10 h-10 sm:w-12 sm:h-12 ${styles.bg} ${styles.border} border rounded-xl sm:rounded-2xl flex items-center justify-center flex-shrink-0`}>
                    <i className={`${activity.icon} ${styles.icon} text-base sm:text-lg`}></i>
                  </div>

                  {/* Content */}
                  <div className="flex-1 min-w-0">
                        <div className="flex flex-col sm:flex-row sm:items-start justify-between gap-2 sm:gap-4">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-start justify-between gap-2 lg:block">
                          <p className="font-medium text-gray-900 dark:text-white text-sm sm:text-base flex-1">
                            {activity.activity_title}
                          </p>
                          {/* Date - Mobile: à côté du titre, Desktop: au-dessus du badge */}
                          <p className="text-gray-400 dark:text-gray-500 text-xs font-medium flex-shrink-0 lg:hidden">
                            {activity.time}
                          </p>
                        </div>
                        <p className="text-gray-500 dark:text-gray-400 text-xs sm:text-sm mt-1 break-words">
                          {activity.activity_description}
                        </p>
                      </div>
                      
                      {/* Status/Amount et Date - Desktop: colonne droite */}
                      <div className="flex-shrink-0 w-full sm:w-auto flex flex-col sm:items-end gap-2">
                        {/* Date - Desktop: au-dessus du badge */}
                        <p className="text-gray-400 dark:text-gray-500 text-xs font-medium hidden lg:block text-right">
                          {activity.time}
                        </p>
                        
                        {activity.amount && (
                          <span className="inline-flex items-center px-2 sm:px-3 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-700 w-full sm:w-auto justify-center sm:justify-start">
                            {activity.amount}
                          </span>
                        )}
                        {activity.status && (
                          <span className="inline-flex items-center px-2 sm:px-3 py-1 rounded-full text-xs font-medium bg-[#335FAD]/10 dark:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD] border border-[#335FAD]/20 dark:border-[#335FAD]/70 w-full sm:w-auto justify-center sm:justify-start">
                            {activity.status}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}

      <div className="mt-6 sm:mt-8 pt-4 sm:pt-6 border-t border-gray-200 dark:border-gray-700">
        <div className="flex items-center justify-center">
          <button 
            onClick={refreshActivities}
            disabled={isLoading}
            className="flex items-center text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 text-sm font-medium cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
          >
            <i className={`ri-refresh-line mr-2 ${isLoading ? 'animate-spin' : ''}`}></i>
            {isLoading ? 'Actualisation...' : 'Actualiser'}
          </button>
        </div>
      </div>
    </div>
  );
}

================
File: components/ApporteurHeader.tsx
================
'use client';

import { useEffect, useRef, useState } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { usePathname } from 'next/navigation';
import { ActivitiesService } from '@/lib/services/activities';
import { ActivityReadStatusCache } from '@/lib/services/activity-read-status-cache';

// Interface pour les données utilisateur
interface UserData {
  id: string;
  firstName: string;
  lastName: string;
  initials: string;
  role: string;
}

// Interface pour les notifications depuis Supabase
interface Notification {
  id: string;
  type: 'success' | 'info' | 'warning';
  title: string;
  description: string;
  amount?: string;
  time: string;
  isRead: boolean;
  dossierId?: string;
}

interface ApporteurHeaderProps {
  darkMode: boolean;
  setDarkMode: (value: boolean) => void;
  userData: UserData;
}

export default function ApporteurHeader({ darkMode, setDarkMode, userData }: ApporteurHeaderProps) {
  const pathname = usePathname();
  const [showNotifications, setShowNotifications] = useState(false);
  const [showProfile, setShowProfile] = useState(false);
  const [showMobileMenu, setShowMobileMenu] = useState(false);
  const menuRef = useRef<HTMLDivElement>(null);
  const notificationsRef = useRef<HTMLDivElement>(null);
  const [notifications, setNotifications] = useState<Notification[]>([]);

  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (menuRef.current && !menuRef.current.contains(e.target as Node)) {
        setShowMobileMenu(false);
      }
      if (notificationsRef.current && !notificationsRef.current.contains(e.target as Node)) {
        setShowNotifications(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // Charger les notifications filtrées depuis la DB
  useEffect(() => {
    fetchNotifications();
    
    // Actualisation automatique toutes les 30 secondes
    const interval = setInterval(() => {
      fetchNotifications();
    }, 30000);
    
    // Écouter les changements du cache pour rafraîchir l'UI
    const unsubscribe = ActivityReadStatusCache.onSync(() => {
      // Recalculer le compteur basé sur le cache local
      setNotifications(prev => prev.map(n => {
        const cachedStatus = ActivityReadStatusCache.getReadStatus(n.id);
        return cachedStatus !== null ? { ...n, isRead: cachedStatus } : n;
      }));
    });
    
    return () => {
      clearInterval(interval);
      unsubscribe();
    };
  }, [userData.id]);

  // Fonction pour récupérer les notifications filtrées (actions de l'admin uniquement)
  const fetchNotifications = async () => {
    try {
      const data = await ActivitiesService.getNotificationsForApporteur(userData.id, 10);
      
      // Formater les activités en notifications et fusionner avec cache
      const formatted = data?.map((activity: any) => {
        const activityData = activity.activity_data || {};
        let type: 'success' | 'info' | 'warning' = 'info';
        let amount = '';
        
        switch (activity.activity_type) {
          case 'dossier_attribue':
            type = 'info';
            break;
          case 'dossier_supprime':
            type = 'warning';
            break;
          case 'classement_updated':
            type = 'success';
            amount = activityData.nouveau_classement ? `Classement: ${activityData.nouveau_classement}` : '';
            break;
        }
        
        // Fusionner avec le cache local
        const cachedStatus = ActivityReadStatusCache.getReadStatus(activity.id);
        const finalIsRead = cachedStatus !== null ? cachedStatus : (activity.is_read || false);
        
        return {
          id: activity.id,
          type,
          title: activity.activity_title,
          description: activity.activity_description,
          amount,
          time: formatTimeAgo(activity.created_at),
          isRead: finalIsRead,
          dossierId: activity.dossier_id
        };
      }) || [];
      
      setNotifications(formatted);
    } catch (error) {
      console.error('Erreur lors du chargement des notifications:', error);
    }
  };

  // Fonction pour gérer le clic sur une notification
  const handleNotificationClick = async (notification: Notification) => {
    // Marquer comme lu
    await markAsRead(notification.id);
    // Fermer le panneau
    setShowNotifications(false);
    // Naviguer vers le dossier si disponible
    if (notification.dossierId) {
      window.location.href = `/dossier/${notification.dossierId}`;
    }
  };

  // Fonction pour marquer une notification comme lue (optimiste)
  const markAsRead = (notificationId: string) => {
    // Mise à jour optimiste immédiate
    setNotifications(prev => prev.map(n => 
      n.id === notificationId ? { ...n, isRead: true } : n
    ));
    
    // Ajouter au cache pour synchronisation en arrière-plan
    ActivityReadStatusCache.markAsReadOptimistic(notificationId);
  };

  // Fonction pour formater le temps écoulé
  const formatTimeAgo = (dateString: string): string => {
    const now = new Date();
    const date = new Date(dateString);
    const diff = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));
    if (diff < 60) return `Il y a ${diff}min`;
    if (diff < 1440) return `Il y a ${Math.floor(diff / 60)}h`;
    if (diff < 2880) return 'Hier';
    return `${Math.floor(diff / 1440)} jours`;
  };

  // Fonction pour déterminer si un lien est actif
  const isActiveLink = (href: string) => {
    if (href === '/') {
      return pathname === '/';
    }
    return pathname.startsWith(href);
  };

  // Compter les notifications non lues
  const unreadCount = notifications.filter(n => !n.isRead).length;

  return (
    <>
    <header className="fixed top-0 left-0 right-0 z-50 bg-gray-100/95 backdrop-blur-md shadow-lg border-b border-gray-200 transition-colors duration-300 dark:bg-gray-900/80 dark:border-gray-700">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-50">
        <nav className="flex items-center justify-between h-16 lg:h-20">
          <Link href="/" className="flex items-center space-x-2 cursor-pointer transition-transform hover:scale-105">
            <Image
              className="h-10 w-auto drop-shadow-sm transition-all"
              src="/assets/svgs/gmb-courtagegrand.svg"
              alt="GMB Courtage logo"
              width={175}
              height={34}
              style={{ 
                filter: darkMode ? 'brightness(0) invert(1)' : 'brightness(0) saturate(100%) invert(8%) sepia(40%) saturate(6266%) hue-rotate(223deg) brightness(95%) contrast(98%)'
              }}
            />
            <div className="hidden sm:block">
              <p className="text-[11px] text-gray-600 dark:text-gray-400 -mt-1">Espace Apporteur</p>
            </div>
          </Link>

          {/* Navigation Desktop - visible uniquement sur xl+ */}
          <div className="hidden xl:flex items-center space-x-4">
            <Link 
              href="/" 
              className={`relative px-5 py-2.5 text-sm lg:text-base font-medium transition-colors rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 ${
                isActiveLink('/') ? 'text-[#335FAD] dark:text-white bg-gray-100 dark:bg-gray-700' : 'text-gray-600 dark:text-white hover:text-black dark:hover:text-white'
              }`}
            >
              Accueil
            </Link>
            <Link 
              href="/mes-dossiers" 
              className={`relative px-5 py-2.5 text-sm lg:text-base font-medium transition-colors rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 ${
                isActiveLink('/mes-dossiers') ? 'text-[#335FAD] dark:text-white bg-gray-100 dark:bg-gray-700' : 'text-gray-600 dark:text-white hover:text-black dark:hover:text-white'
              }`}
            >
              Mes Dossiers
            </Link>

            {/* Notifications */}
            <div className="relative group" ref={notificationsRef}>
              <button 
                onClick={() => setShowNotifications(!showNotifications)}
                className="w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 border border-gray-200 dark:border-gray-600 rounded-lg flex items-center justify-center transition-colors cursor-pointer"
              >
                <i className="ri-notification-line text-gray-700 dark:text-gray-300"></i>
                {unreadCount > 0 && (
                  <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-[10px] rounded-full flex items-center justify-center border border-white dark:border-gray-800">
                    {unreadCount}
                  </span>
                )}
              </button>

              <div className="absolute right-0 mt-4 w-80 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                <div className="relative pt-2">
                  <div className="relative bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-xl py-2 max-h-96 overflow-y-auto">
                  <div className="px-4 py-2 border-b border-gray-200 dark:border-gray-700">
                    <div className="flex items-center justify-between">
                      <h3 className="text-sm font-medium text-gray-900 dark:text-white">Notifications</h3>
                      <button className="text-xs text-[#335FAD] dark:text-[#335FAD] hover:text-[#335FAD]/80 cursor-pointer">
                        Tout marquer comme lu
                      </button>
                    </div>
                  </div>
                  
                  {/* TODO: SUPABASE - Remplacer par les vraies notifications apporteur */}
                  <div className="py-2">
                    {notifications.map((notification) => (
                      <div 
                        key={notification.id} 
                        onClick={() => handleNotificationClick(notification)}
                        onMouseEnter={() => !notification.isRead && markAsRead(notification.id)}
                        className="px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer"
                      >
                        <div className="flex items-start space-x-3">
                          <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${
                            notification.type === 'success' 
                              ? 'bg-green-100 dark:bg-green-900/30' 
                              : notification.type === 'warning'
                              ? 'bg-amber-100 dark:bg-amber-900/30'
                              : 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30'
                          }`}>
                            <i className={`${
                              notification.type === 'success' 
                                ? 'ri-checkbox-circle-line text-green-600 dark:text-green-400' 
                                : notification.type === 'warning'
                                ? 'ri-alert-line text-amber-600 dark:text-amber-400'
                                : 'ri-information-line text-[#335FAD] dark:text-[#335FAD]'
                            } text-sm`}></i>
                          </div>
                          <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium text-gray-900 dark:text-white">{notification.title}</p>
                            <p className="text-xs text-gray-500 dark:text-gray-400">{notification.description}</p>
                        {notification.amount && (
                              <p className="text-xs text-green-600 dark:text-green-400 mt-1">{notification.amount}</p>
                        )}
                        <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">{notification.time}</p>
                          </div>
                          {!notification.isRead && <div className="w-2 h-2 bg-red-500 rounded-full flex-shrink-0"></div>}
                        </div>
                      </div>
                    ))}
                  </div>
                  
                    <div className="px-4 py-2 border-t border-gray-200 dark:border-gray-700">
                      <Link href="/activites?tab=notifications" className="block w-full text-center text-sm text-[#335FAD] dark:text-[#335FAD] hover:text-[#335FAD]/80 cursor-pointer" onClick={() => setShowNotifications(false)}>
                        Voir toutes les notifications
                      </Link>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Profile - Desktop */}
            <div className="relative hidden xl:block group">
              <button 
                onClick={() => setShowProfile(!showProfile)}
                className="flex items-center gap-3 p-1.5 rounded-lg hover:bg-gray-200 border border-transparent hover:border-gray-300 dark:hover:border-gray-600 transition-colors cursor-pointer"
              >
                <div className="w-10 h-10 bg-[#335FAD] rounded-lg flex items-center justify-center">
                  <span className="text-white font-medium text-sm">{userData.initials}</span>
                </div>
                <div className="text-left">
                  <p className="text-sm font-medium text-gray-900 dark:text-white">{userData.firstName} {userData.lastName}</p>
                  <p className="text-xs text-gray-500 dark:text-gray-400">{userData.role}</p>
                </div>
              </button>
              <div className="absolute right-0 mt-4 w-48 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                <div className="relative pt-2">
                  <div className="relative bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-xl py-2">
                    <Link href="/profil" className="flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-50 dark:border-gray-700">
                      <i className="ri-user-line mr-3 text-gray-500 dark:text-gray-400 text-sm"></i>
                      Profil et paramètres
                    </Link>
                    <div className="flex items-center px-4 py-2.5 text-sm text-gray-400 dark:text-gray-500 border-b border-gray-50 dark:border-gray-700 cursor-not-allowed relative group">
                      <i className="ri-wallet-line mr-3 text-gray-400 dark:text-gray-500 text-sm"></i>
                      Mes Gains
                      <div className="absolute left-full ml-2 px-2 py-1 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10">
                        Bientôt disponible
                      </div>
                    </div>
                    <Link href="#" className="flex items-center px-4 py-2.5 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
                      <i className="ri-logout-box-line mr-3 text-sm"></i>
                      Déconnexion
                    </Link>
                  </div>
                </div>
              </div>
            </div>

            {/* Toggle dark mode (desktop only) */}
            <button
              onClick={() => setDarkMode(!darkMode)}
              className="w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg items-center justify-center transition-colors cursor-pointer flex"
              title={darkMode ? 'Mode clair' : 'Mode sombre'}
            >
              <i className={`${darkMode ? 'ri-sun-line' : 'ri-moon-line'} text-gray-700 dark:text-gray-300`}></i>
            </button>
          </div>

          {/* Menu Mobile - visible jusqu'à xl (inclut tablette) */}
          <div className="xl:hidden flex items-center space-x-2">
            {/* Bouton Notifications Mobile */}
            <div className="relative" ref={notificationsRef}>
              <button 
                onClick={() => setShowNotifications(!showNotifications)}
                className="relative p-2.5 text-gray-700 dark:text-gray-200 hover:text-black rounded-xl bg-gray-100 hover:bg-gray-200 border border-gray-200 transition-all duration-200 active:scale-95"
                aria-label="Notifications"
              >
                <i className="ri-notification-line text-lg"></i>
                {unreadCount > 0 && (
                  <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
                    {unreadCount}
                  </span>
                )}
              </button>
            </div>

            {/* Bouton Burger */}
            <div ref={menuRef}>
              <button
                onClick={() => setShowMobileMenu(!showMobileMenu)}
                className="relative p-2.5 text-gray-700 dark:text-gray-200 hover:text-black rounded-xl bg-gray-100 hover:bg-gray-200 border border-gray-200 transition-all duration-200 active:scale-95"
                aria-label="Toggle menu"
              >
                <div className="w-5 h-5 relative">
                  <span className={`absolute left-0 block h-0.5 w-5 bg-current transform transition-all duration-300 ease-in-out ${showMobileMenu ? 'rotate-45 top-2' : 'top-0.5'}`}></span>
                  <span className={`absolute left-0 block h-0.5 w-5 bg-current transform transition-all duration-300 ease-in-out ${showMobileMenu ? 'opacity-0' : 'top-2'}`}></span>
                  <span className={`absolute left-0 block h-0.5 w-5 bg-current transform transition-all duration-300 ease-in-out ${showMobileMenu ? '-rotate-45 top-2' : 'top-3.5'}`}></span>
                </div>
              </button>
        </div>

        {showMobileMenu && (
              <div className="absolute top-full right-0 w-screen mt-2 pb-4">
                <div className="relative mx-4">
                  <div className="relative bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-xl overflow-hidden">
                    <div className="grid grid-cols-1 gap-2 p-4">
              <Link 
                href="/" 
                        className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${isActiveLink('/') ? 'bg-gray-100 text-[#335FAD]' : 'text-gray-700 dark:text-gray-200 hover:bg-gray-50 hover:text-black'}`}
                        onClick={() => setShowMobileMenu(false)}
                      >
                        <i className="ri-dashboard-line text-lg"></i>
                        <span>Accueil</span>
              </Link>
              <Link 
                href="/mes-dossiers" 
                        className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${isActiveLink('/mes-dossiers') ? 'bg-gray-100 text-[#335FAD]' : 'text-gray-700 dark:text-gray-200 hover:bg-gray-50 hover:text-black'}`}
                        onClick={() => setShowMobileMenu(false)}
                      >
                        <i className="ri-folder-line text-lg"></i>
                        <span>Mes Dossiers</span>
              </Link>
              
              <button 
                        onClick={() => { setDarkMode(!darkMode); setShowMobileMenu(false); }}
                        className="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-50 transition-colors text-left"
              >
                        <i className={`ri-${darkMode ? 'sun' : 'moon'}-line text-lg`}></i>
                        <span>{darkMode ? 'Mode clair' : 'Mode sombre'}</span>
              </button>
              
                      <div className="pt-2 border-t border-gray-200 dark:border-gray-700">
                        <div className="flex items-center space-x-3 mb-3 px-4">
                          <div className="w-10 h-10 bg-[#335FAD] rounded-lg flex items-center justify-center">
                            <span className="text-white font-medium text-sm">{userData.initials}</span>
                  </div>
                  <div>
                    <p className="text-sm font-medium text-gray-900 dark:text-white">{userData.firstName} {userData.lastName}</p>
                            <p className="text-xs text-gray-500 dark:text-gray-400">{userData.role}</p>
                  </div>
                </div>
                        <div className="space-y-2 px-4 pb-2">
                          <Link href="/profil" className="flex items-center gap-3 text-gray-700 dark:text-gray-200 hover:text-black hover:bg-gray-50 px-4 py-2 rounded-lg" onClick={() => setShowMobileMenu(false)}>
                            <i className="ri-user-line"></i>
                    Mon Profil
                  </Link>
                          <Link href="#" className="flex items-center gap-3 text-gray-700 dark:text-gray-200 hover:text-black hover:bg-gray-50 px-4 py-2 rounded-lg" onClick={() => setShowMobileMenu(false)}>
                            <i className="ri-wallet-line"></i>
                    Mes Gains
                  </Link>
                          <Link href="#" className="flex items-center gap-3 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 px-4 py-2 rounded-lg" onClick={() => setShowMobileMenu(false)}>
                            <i className="ri-logout-box-line"></i>
                    Déconnexion
                  </Link>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {showNotifications && (
              <div className="absolute top-full right-0 w-screen mt-2 pb-4">
                <div className="relative mx-4">
                  <div className="relative bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-xl overflow-hidden">
                    <div className="px-4 py-2 border-b border-gray-200 dark:border-gray-700">
                      <div className="flex items-center justify-between">
                        <h3 className="text-sm font-medium text-gray-900 dark:text-white">Notifications</h3>
                        <button className="text-xs text-[#335FAD] dark:text-[#335FAD] hover:text-[#335FAD]/80 cursor-pointer">
                          Tout marquer comme lu
                        </button>
                      </div>
                    </div>
                    
                    <div className="py-2 max-h-64 overflow-y-auto">
                      {notifications.map((notification) => (
                        <div 
                          key={notification.id} 
                          onClick={() => handleNotificationClick(notification)}
                          onMouseEnter={() => !notification.isRead && markAsRead(notification.id)}
                          className="px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer"
                        >
                          <div className="flex items-start space-x-3">
                            <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${
                              notification.type === 'success' 
                                ? 'bg-green-100 dark:bg-green-900/30' 
                                : notification.type === 'warning'
                                ? 'bg-amber-100 dark:bg-amber-900/30'
                                : 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30'
                            }`}>
                              <i className={`${
                                notification.type === 'success' 
                                  ? 'ri-checkbox-circle-line text-green-600 dark:text-green-400' 
                                  : notification.type === 'warning'
                                  ? 'ri-alert-line text-amber-600 dark:text-amber-400'
                                  : 'ri-information-line text-[#335FAD] dark:text-[#335FAD]'
                              } text-sm`}></i>
                            </div>
                            <div className="flex-1 min-w-0">
                              <p className="text-sm font-medium text-gray-900 dark:text-white">{notification.title}</p>
                              <p className="text-xs text-gray-500 dark:text-gray-400">{notification.description}</p>
                              {notification.amount && (
                                <p className="text-xs text-green-600 dark:text-green-400 mt-1">{notification.amount}</p>
                              )}
                              <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">{notification.time}</p>
                            </div>
                            {!notification.isRead && <div className="w-2 h-2 bg-red-500 rounded-full flex-shrink-0"></div>}
                          </div>
                        </div>
                      ))}
                    </div>
                    
                    <div className="px-4 py-2 border-t border-gray-200 dark:border-gray-700">
                      <Link href="/activites?tab=notifications" className="block w-full text-center text-sm text-[#335FAD] dark:text-[#335FAD] hover:text-[#335FAD]/80 cursor-pointer" onClick={() => setShowNotifications(false)}>
                        Voir toutes les notifications
                      </Link>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </nav>
      </div>
    </header>
    <div className="h-16 lg:h-20" aria-hidden></div>
    </>
  );
}

================
File: components/ApporteurStatsCards.tsx
================
'use client';

import { useState, useEffect } from 'react';

// Interface pour les statistiques utilisateur
interface UserStats {
  dossiersEnvoyes: number;
  economiesGenerees: number;
  totalApporteurs: number;
  progressionDossiers: number;
  progressionEconomies: number;
}

// Fonction pour déterminer si on peut afficher la progression
const canShowProgression = (progression: number): boolean => {
  return progression > 0 && progression < 1000 && progression !== 0;
};

// Interface pour les données historiques des graphiques
interface ChartData {
  dossiers: number[];
  economies: number[];
}

interface ApporteurStatsCardsProps {
  userStats: UserStats;
}

export default function ApporteurStatsCards({ userStats }: ApporteurStatsCardsProps) {
  const [currentSlide, setCurrentSlide] = useState(0);
  const totalSlides = 2;

  const [chartData, setChartData] = useState<ChartData>({
    dossiers: [20, 35, 28, 42, 38, 45, 42],
    economies: [3200, 3800, 4100, 4350, 4200, 4400, 4350]
  });

  // Défilement automatique pour mobile
  useEffect(() => {
    const interval = setInterval(() => {
      setCurrentSlide((prev) => (prev + 1) % totalSlides);
    }, 4000);

    return () => clearInterval(interval);
  }, []);

  return (
    <div className="mb-12">
      {/* Desktop Grid - 2 colonnes */}
      <div className="hidden md:grid grid-cols-1 md:grid-cols-2 gap-8">
        {/* Dossiers Envoyés */}
        <div className="relative group">
          <div className="bg-white dark:bg-gray-800 rounded-3xl p-8 border-2 border-gray-100 dark:border-gray-700 hover:border-[#335FAD]/20 dark:hover:border-[#335FAD]/60 transition-all duration-300 hover:shadow-xl">
            <div className="absolute inset-0 bg-gradient-to-br from-[#335FAD]/5 dark:from-[#335FAD]/20 to-transparent rounded-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            
            <div className="relative z-10">
              <div className="flex items-center justify-between mb-6">
                <div className="w-14 h-14 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 rounded-2xl flex items-center justify-center border border-[#335FAD]/20 dark:border-[#335FAD]/70">
                  <i className="ri-file-text-line text-[#335FAD] dark:text-[#335FAD] text-2xl"></i>
                </div>
                <div className="text-right">
                  {canShowProgression(userStats.progressionDossiers) && (
                    <div className="flex flex-col items-end">
                      <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-700">
                        +{userStats.progressionDossiers}%
                      </span>
                      <span className="mt-1 text-[10px] text-gray-400 dark:text-gray-500">vs mois dernier</span>
                    </div>
                  )}
                </div>
              </div>
              
              <div className="mb-4">
                <h3 className="text-4xl font-light text-gray-900 dark:text-white mb-2">{userStats.dossiersEnvoyes}</h3>
                <p className="text-gray-500 dark:text-gray-400 font-medium">Dossiers envoyés</p>
                <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">Ce mois-ci</p>
              </div>

              <div className="flex items-end space-x-1 h-8">
                {chartData.dossiers.map((height, index) => (
                  <div
                    key={index}
                    className="bg-[#335FAD]/20 dark:bg-[#335FAD]/70 rounded-sm flex-1 transition-all duration-300 group-hover:bg-[#335FAD]/30 dark:group-hover:bg-[#335FAD]/60"
                    style={{ height: `${(height / Math.max(...chartData.dossiers)) * 100}%` }}
                  ></div>
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* Économies Clients */}
        <div className="relative group">
          <div className="bg-white dark:bg-gray-800 rounded-3xl p-8 border-2 border-gray-100 dark:border-gray-700 hover:border-emerald-200 dark:hover:border-emerald-600 transition-all duration-300 hover:shadow-xl">
            <div className="absolute inset-0 bg-gradient-to-br from-emerald-50/30 dark:from-emerald-900/20 to-transparent rounded-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            
            <div className="relative z-10">
              <div className="flex items-center justify-between mb-6">
                <div className="w-14 h-14 bg-emerald-100 dark:bg-emerald-900/30 rounded-2xl flex items-center justify-center border border-emerald-200 dark:border-emerald-700">
                  <i className="ri-money-euro-circle-line text-emerald-600 dark:text-emerald-400 text-2xl"></i>
                </div>
                <div className="text-right">
                  {canShowProgression(userStats.progressionEconomies) && (
                    <div className="flex flex-col items-end">
                      <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-[#335FAD]/10 dark:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD] border border-[#335FAD]/20 dark:border-[#335FAD]/70">
                        +{userStats.progressionEconomies}%
                      </span>
                      <span className="mt-1 text-[10px] text-gray-400 dark:text-gray-500">vs mois dernier</span>
                    </div>
                  )}
                </div>
              </div>
              
              <div className="mb-4">
                <h3 className="text-4xl font-light text-gray-900 dark:text-white mb-2">€{userStats.economiesGenerees.toLocaleString()}</h3>
                <p className="text-gray-500 dark:text-gray-400 font-medium">Économies générées</p>
                <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">Pour vos clients</p>
              </div>

              <div className="flex items-end space-x-1 h-8">
                {chartData.economies.map((value, index) => {
                  const minValue = Math.min(...chartData.economies);
                  const maxValue = Math.max(...chartData.economies);
                  return (
                    <div
                      key={index}
                      className="bg-emerald-200 dark:bg-emerald-700 rounded-sm flex-1 transition-all duration-300 group-hover:bg-emerald-300 dark:group-hover:bg-emerald-600"
                      style={{ height: `${((value - minValue) / (maxValue - minValue)) * 100}%` }}
                    ></div>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Mobile Carousel - 2 slides */}
      <div className="md:hidden">
        <div className="relative overflow-hidden">
          <div 
            className="flex transition-transform duration-500 ease-in-out"
            style={{ transform: `translateX(-${currentSlide * 100}%)` }}
          >
            {/* Dossiers Envoyés - Mobile */}
            <div className="w-full flex-shrink-0 px-4">
              <div className="bg-white dark:bg-gray-800 rounded-3xl p-6 border-2 border-gray-100 dark:border-gray-700 h-full">
                <div className="flex items-center justify-between mb-4">
                  <div className="w-12 h-12 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 rounded-2xl flex items-center justify-center border border-[#335FAD]/20 dark:border-[#335FAD]/70">
                    <i className="ri-file-text-line text-[#335FAD] dark:text-[#335FAD] text-xl"></i>
                  </div>
                  {canShowProgression(userStats.progressionDossiers) && (
                    <div className="flex flex-col items-end">
                      <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-700">
                        +{userStats.progressionDossiers}%
                      </span>
                      <span className="mt-1 text-[10px] text-gray-400 dark:text-gray-500">vs mois dernier</span>
                    </div>
                  )}
                </div>
                
                <div className="mb-4">
                  <h3 className="text-3xl font-light text-gray-900 dark:text-white mb-1">{userStats.dossiersEnvoyes}</h3>
                  <p className="text-gray-500 dark:text-gray-400 font-medium text-sm">Dossiers envoyés</p>
                  <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">Ce mois-ci</p>
                </div>

                <div className="flex items-end space-x-1 h-6">
                  {chartData.dossiers.map((height, index) => (
                    <div
                      key={index}
                      className="bg-[#335FAD]/20 dark:bg-[#335FAD]/70 rounded-sm flex-1"
                      style={{ height: `${(height / Math.max(...chartData.dossiers)) * 100}%` }}
                    ></div>
                  ))}
                </div>
              </div>
            </div>

            {/* Économies Clients - Mobile */}
            <div className="w-full flex-shrink-0 px-4">
              <div className="bg-white dark:bg-gray-800 rounded-3xl p-6 border-2 border-gray-100 dark:border-gray-700 h-full">
                <div className="flex items-center justify-between mb-4">
                  <div className="w-12 h-12 bg-emerald-100 dark:bg-emerald-900/30 rounded-2xl flex items-center justify-center border border-emerald-200 dark:border-emerald-700">
                    <i className="ri-money-euro-circle-line text-emerald-600 dark:text-emerald-400 text-xl"></i>
                  </div>
                  {canShowProgression(userStats.progressionEconomies) && (
                    <div className="flex flex-col items-end">
                      <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-[#335FAD]/10 dark:bg-[#335FAD]/30 text-[#335FAD] dark:text-[#335FAD] border border-[#335FAD]/20 dark:border-[#335FAD]/70">
                        +{userStats.progressionEconomies}%
                      </span>
                      <span className="mt-1 text-[10px] text-gray-400 dark:text-gray-500">vs mois dernier</span>
                    </div>
                  )}
                </div>
                
                <div className="mb-4">
                  <h3 className="text-3xl font-light text-gray-900 dark:text-white mb-1">€{userStats.economiesGenerees.toLocaleString()}</h3>
                  <p className="text-gray-500 dark:text-gray-400 font-medium text-sm">Économies générées</p>
                  <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">Pour vos clients</p>
                </div>

                <div className="flex items-end space-x-1 h-6">
                  {chartData.economies.map((value, index) => {
                    const minValue = Math.min(...chartData.economies);
                    const maxValue = Math.max(...chartData.economies);
                    return (
                      <div
                        key={index}
                        className="bg-emerald-200 dark:bg-emerald-700 rounded-sm flex-1"
                        style={{ height: `${((value - minValue) / (maxValue - minValue)) * 100}%` }}
                      ></div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Dots Indicator - 2 dots */}
        <div className="flex justify-center space-x-2 mt-6">
          {[0, 1].map((index) => (
            <button
              key={index}
              onClick={() => setCurrentSlide(index)}
              className={`w-2 h-2 rounded-full transition-colors duration-300 ${
                currentSlide === index 
                  ? 'bg-[#335FAD] dark:bg-[#335FAD]' 
                  : 'bg-gray-300 dark:bg-gray-600'
              }`}
            />
          ))}
        </div>
      </div>
    </div>
  );
}

================
File: components/AuthProvider.tsx
================
'use client';

import { createContext, useContext, useEffect, useState } from 'react';
import { supabase } from '../lib/supabase';
import { useRouter, usePathname } from 'next/navigation';

const AuthContext = createContext<{
  user: any;
  loading: boolean;
  userType: 'courtier' | 'apporteur' | null;
}>({
  user: null,
  loading: true,
  userType: null,
});

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

export default function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [userType, setUserType] = useState<'courtier' | 'apporteur' | null>(null);
  const router = useRouter();
  const pathname = usePathname();

  // Public routes that don't require auth
  const publicRoutes = ['/connexion', '/reset-password'];
  // Routes that are public but have special handling
  const specialRoutes = ['/onboarding', '/admin/onboarding'];
  // Routes that start with /invite are always public
  const isInviteRoute = pathname?.startsWith('/invite/');
  // Dev routes are always public (only exist in development)
  const isDevRoute = pathname?.startsWith('/dev/');

  useEffect(() => {
    const getUser = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (user) {
        // 1. Check if user is a broker_user (courtier)
        const { data: brokerUser } = await supabase
          .from('broker_users')
          .select('id, broker_id, role')
          .eq('user_id', user.id)
          .single();

        if (brokerUser) {
          // User is a courtier
          setUserType('courtier');
          
          // Check broker onboarding status
          const { data: broker } = await supabase
            .from('brokers')
            .select('onboarding_status')
            .eq('id', brokerUser.broker_id)
            .single();

          // Skip redirects for dev routes
          if (isDevRoute) {
            // Stay on dev page
          }
          // If on connexion page, redirect appropriately
          else if (pathname === '/connexion') {
            if (broker?.onboarding_status !== 'ready') {
              router.push('/admin/onboarding');
            } else {
              router.push('/admin');
            }
          }
          // If on apporteur routes, redirect to admin
          else if (pathname === '/' || pathname === '/onboarding' || pathname === '/mes-dossiers' || pathname === '/nouveau-dossier' || pathname === '/activites') {
            router.push('/admin');
          }
        } else {
          // 2. Check if user is an apporteur
          const { data: profile } = await supabase
            .from('apporteur_profiles')
            .select('id, cgu_accepted_at')
            .eq('user_id', user.id)
            .single();

          if (profile) {
            setUserType('apporteur');
            
            // Check if linked to any broker
            const { data: brokerLink } = await supabase
              .from('broker_apporteurs')
              .select('id')
              .eq('apporteur_profile_id', profile.id)
              .limit(1)
              .single();

            // Apporteur without broker link - unusual state, let them use invite link
            if (!brokerLink && !isInviteRoute && pathname !== '/connexion') {
              // They need to accept an invite
              setUser(user);
              setLoading(false);
              return;
            }

            // Skip redirects for dev routes
            if (isDevRoute) {
              // Stay on dev page
            }
            // Si CGU non acceptées, rediriger vers onboarding
            else if (!profile.cgu_accepted_at && pathname !== '/onboarding') {
              router.push('/onboarding');
            } 
            // Si CGU acceptées et sur page connexion/onboarding, aller à l'accueil
            else if (profile.cgu_accepted_at && (pathname === '/connexion' || pathname === '/onboarding')) {
              router.push('/');
            }
            // Si sur admin routes, rediriger vers apporteur
            else if (pathname?.startsWith('/admin')) {
              router.push('/');
            }
          } else {
            // User has no profile at all - edge case (shouldn't happen normally)
            setUserType(null);
            if (pathname === '/connexion') {
              // Stay on connexion, they might need to complete signup
            }
          }
        }
      } else {
        // Not authenticated
        setUserType(null);
        
        // Allow invite routes and dev routes without auth
        if (isInviteRoute || isDevRoute) {
          // OK, stay on page
        }
        // Redirect to connexion if on protected route
        else if (!publicRoutes.includes(pathname || '') && !specialRoutes.includes(pathname || '')) {
          router.push('/connexion');
        }
      }

      setUser(user);
      setLoading(false);
    };

    getUser();

    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        const currentUser = session?.user ?? null;
        setUser(currentUser);

        if (event === 'SIGNED_OUT') {
          setUserType(null);
          router.push('/connexion');
        }
        // Note: SIGNED_IN is handled by the individual signup handlers in /connexion
        // to properly route based on user type
      }
    );

    return () => subscription.unsubscribe();
  }, [pathname, router]);

  return (
    <AuthContext.Provider value={{ user, loading, userType }}>
      {children}
    </AuthContext.Provider>
  );
}

================
File: components/ClientInfoForm.tsx
================
'use client';

import { useState, useEffect } from 'react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { DatePicker } from '@/components/ui/date-picker';
import { CATEGORY_OPTIONS } from '@/lib/constants/exade';

type DossierType = 'seul' | 'couple';

interface ClientInfo {
  // Client principal
  civilite: string;
  nom: string;
  prenom: string;
  nom_naissance: string;  // OBLIGATOIRE pour API Exade
  dateNaissance: string;
  categorie_professionnelle: number;  // Code Exade 1-11 (remplace profession)
  revenus: string;  // Conservé pour usage interne (pas envoyé à Exade)
  fumeur: boolean;
  email: string;
  telephone: string;
  adresse: string;
  
  // Client conjoint (si couple)
  conjoint?: {
    civilite: string;
    nom: string;
    prenom: string;
    nom_naissance: string;  // OBLIGATOIRE pour API Exade
    dateNaissance: string;
    categorie_professionnelle: number;  // Code Exade 1-11
    fumeur: boolean;
    // Note: revenus du conjoint NON requis par Exade
  };
}

interface ClientInfoFormProps {
  dossierType: DossierType;
  initialData: ClientInfo | null;
  onSubmit: (data: ClientInfo) => void;
  onBack: () => void;
}

export default function ClientInfoForm({ dossierType, initialData, onSubmit, onBack }: ClientInfoFormProps) {
  const [formData, setFormData] = useState<ClientInfo>({
    civilite: '',
    nom: '',
    prenom: '',
    nom_naissance: '',
    dateNaissance: '',
    categorie_professionnelle: 0,  // 0 = non sélectionné
    revenus: '',
    fumeur: false,
    email: '',
    telephone: '',
    adresse: '',
    ...(dossierType === 'couple' && {
      conjoint: {
        civilite: '',
        nom: '',
        prenom: '',
        nom_naissance: '',
        dateNaissance: '',
        categorie_professionnelle: 0,
        fumeur: false
      }
    })
  });

  const [errors, setErrors] = useState<Record<string, string>>({});
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Charger les données initiales
  useEffect(() => {
    if (initialData) {
      setFormData(initialData);
    }
  }, [initialData]);

  // Validation des champs
  const validateForm = (): boolean => {
    const newErrors: Record<string, string> = {};

    // Validation client principal
    if (!formData.civilite) newErrors.civilite = 'La civilité est obligatoire';
    if (!formData.nom.trim()) newErrors.nom = 'Le nom est obligatoire';
    if (!formData.prenom.trim()) newErrors.prenom = 'Le prénom est obligatoire';
    if (!formData.nom_naissance.trim()) newErrors.nom_naissance = 'Le nom de naissance est obligatoire';
    if (!formData.dateNaissance) newErrors.dateNaissance = 'La date de naissance est obligatoire';
    if (!formData.categorie_professionnelle || formData.categorie_professionnelle === 0) {
      newErrors.categorie_professionnelle = 'La catégorie professionnelle est obligatoire';
    }
    if (!formData.revenus.trim()) newErrors.revenus = 'Les revenus sont obligatoires';
    if (!formData.email.trim()) newErrors.email = 'L\'email est obligatoire';
    else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      newErrors.email = 'Format d\'email invalide';
    }
    if (!formData.telephone.trim()) newErrors.telephone = 'Le téléphone est obligatoire';
    if (!formData.adresse.trim()) newErrors.adresse = 'L\'adresse est obligatoire';

    // Validation conjoint si couple
    if (dossierType === 'couple' && formData.conjoint) {
      if (!formData.conjoint.civilite) newErrors['conjoint.civilite'] = 'La civilité du conjoint est obligatoire';
      if (!formData.conjoint.nom.trim()) newErrors['conjoint.nom'] = 'Le nom du conjoint est obligatoire';
      if (!formData.conjoint.prenom.trim()) newErrors['conjoint.prenom'] = 'Le prénom du conjoint est obligatoire';
      if (!formData.conjoint.nom_naissance.trim()) newErrors['conjoint.nom_naissance'] = 'Le nom de naissance du conjoint est obligatoire';
      if (!formData.conjoint.dateNaissance) newErrors['conjoint.dateNaissance'] = 'La date de naissance du conjoint est obligatoire';
      if (!formData.conjoint.categorie_professionnelle || formData.conjoint.categorie_professionnelle === 0) {
        newErrors['conjoint.categorie_professionnelle'] = 'La catégorie professionnelle du conjoint est obligatoire';
      }
      // Note: revenus du conjoint NON requis par Exade, donc pas de validation
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  // Mise à jour des champs
  const updateField = (field: string, value: any) => {
    // Convertir en number pour les catégories professionnelles
    let processedValue = value;
    if (field === 'categorie_professionnelle' || field === 'conjoint.categorie_professionnelle') {
      processedValue = value ? parseInt(value, 10) : 0;
    }
    
    if (field.startsWith('conjoint.')) {
      const conjointField = field.replace('conjoint.', '');
      setFormData(prev => ({
        ...prev,
        conjoint: {
          ...prev.conjoint!,
          [conjointField]: processedValue
        }
      }));
    } else {
      setFormData(prev => ({
        ...prev,
        [field]: processedValue
      }));
    }

    // Supprimer l'erreur du champ modifié
    if (errors[field]) {
      setErrors(prev => {
        const newErrors = { ...prev };
        delete newErrors[field];
        return newErrors;
      });
    }
  };

  // Soumission du formulaire
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!validateForm()) {
      return;
    }

    setIsSubmitting(true);
    
    try {
      // Simuler le traitement
      await new Promise(resolve => setTimeout(resolve, 500));
      onSubmit(formData);
    } catch (error) {
      console.error('Erreur lors de la sauvegarde:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  // Composant champ de saisie - Défini en dehors du rendu principal
  const renderInputField = (
    label: string,
    name: string,
    type: string = 'text',
    value: any,
    required: boolean = true,
    placeholder?: string,
    options?: { value: string; label: string }[]
  ) => (
    <div className="space-y-2" key={name}>
      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
        {label} {required && <span className="text-red-500">*</span>}
      </label>
      
      {type === 'select' ? (
        <Select
          value={value}
          onValueChange={(v) => updateField(name, v)}
        >
          <SelectTrigger className={`w-full ${
            errors[name] 
              ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
              : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
          }`}>
            <SelectValue placeholder={placeholder} />
          </SelectTrigger>
          <SelectContent>
            {options?.map(option => (
              <SelectItem key={option.value} value={option.value}>
                {option.label}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      ) : type === 'textarea' ? (
        <textarea
          value={value}
          onChange={(e) => updateField(name, e.target.value)}
          placeholder={placeholder}
          rows={3}
          className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm resize-none ${
            errors[name] 
              ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
              : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
          } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
        />
      ) : type === 'date' ? (
        <DatePicker
          value={value}
          onChange={(v) => updateField(name, v)}
          placeholder={placeholder || "Sélectionnez une date"}
          className={`w-full ${
            errors[name] 
              ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
              : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
          }`}
        />
      ) : (
        <input
          type={type}
          value={value}
          onChange={(e) => updateField(name, type === 'checkbox' ? e.target.checked : e.target.value)}
          placeholder={placeholder}
          className={`w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-[#335FAD] focus:border-[#335FAD] transition-colors text-sm ${
            errors[name] 
              ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20' 
              : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800'
          } text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500`}
        />
      )}
      
      {errors[name] && (
        <p className="text-red-600 dark:text-red-400 text-xs mt-1 flex items-center">
          <i className="ri-error-warning-line mr-1"></i>
          {errors[name]}
        </p>
      )}
    </div>
  );

  return (
    <div className="max-w-4xl mx-auto">
      {/* Header */}
      <div className="text-center mb-8 sm:mb-12">
        <h2 className="text-2xl sm:text-3xl font-light text-gray-900 dark:text-white mb-4">
          Informations {dossierType === 'couple' ? 'des clients' : 'du client'}
        </h2>
        <p className="text-gray-500 dark:text-gray-400 text-lg">
          Renseignez les informations personnelles et professionnelles
        </p>
      </div>

      <form onSubmit={handleSubmit} className="space-y-8">
        {/* Client Principal */}
        <div className="bg-white dark:bg-gray-800 rounded-2xl sm:rounded-3xl p-6 sm:p-8 border-2 border-gray-100 dark:border-gray-700">
          <div className="flex items-center mb-6">
            <div className="w-10 h-10 bg-[#335FAD]/10 dark:bg-[#335FAD]/30 rounded-xl flex items-center justify-center mr-4">
              <i className="ri-user-line text-[#335FAD] dark:text-indigo-400"></i>
            </div>
            <h3 className="text-xl font-medium text-gray-900 dark:text-white">
              {dossierType === 'couple' ? 'Emprunteur principal' : 'Informations personnelles'}
            </h3>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {renderInputField(
              "Civilité",
              "civilite",
              "select",
              formData.civilite,
              true,
              "Sélectionnez",
              [
                { value: 'M', label: 'M.' },
                { value: 'Mme', label: 'Mme' },
                { value: 'Mlle', label: 'Mlle' }
              ]
            )}
            
            {renderInputField(
              "Nom",
              "nom",
              "text",
              formData.nom,
              true,
              "Nom de famille"
            )}
            
            {renderInputField(
              "Prénom",
              "prenom",
              "text",
              formData.prenom,
              true,
              "Prénom"
            )}
            
            {renderInputField(
              "Nom de naissance",
              "nom_naissance",
              "text",
              formData.nom_naissance,
              true,
              "Nom de jeune fille si différent"
            )}
            
            {renderInputField(
              "Date de naissance",
              "dateNaissance",
              "date",
              formData.dateNaissance,
              true
            )}
            
            {renderInputField(
              "Catégorie professionnelle",
              "categorie_professionnelle",
              "select",
              String(formData.categorie_professionnelle),
              true,
              "Sélectionnez votre catégorie",
              CATEGORY_OPTIONS
            )}
            
            {renderInputField(
              "Revenus mensuels nets",
              "revenus",
              "number",
              formData.revenus,
              true,
              "Montant en euros"
            )}
            
            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Statut fumeur
              </label>
              <div className="flex items-center space-x-6 pt-2">
                <label className="flex items-center cursor-pointer">
                  <input
                    type="radio"
                    name="fumeur"
                    checked={!formData.fumeur}
                    onChange={() => updateField('fumeur', false)}
                    className="mr-2 text-[#335FAD] focus:ring-indigo-500"
                  />
                  <span className="text-sm text-gray-700 dark:text-gray-300">Non-fumeur</span>
                </label>
                <label className="flex items-center cursor-pointer">
                  <input
                    type="radio"
                    name="fumeur"
                    checked={formData.fumeur}
                    onChange={() => updateField('fumeur', true)}
                    className="mr-2 text-[#335FAD] focus:ring-indigo-500"
                  />
                  <span className="text-sm text-gray-700 dark:text-gray-300">Fumeur</span>
                </label>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            {renderInputField(
              "Email",
              "email",
              "email",
              formData.email,
              true,
              "adresse@email.com"
            )}
            
            {renderInputField(
              "Téléphone",
              "telephone",
              "tel",
              formData.telephone,
              true,
              "06 12 34 56 78"
            )}
          </div>

          <div className="mt-6">
            {renderInputField(
              "Adresse complète",
              "adresse",
              "textarea",
              formData.adresse,
              true,
              "Adresse, code postal, ville"
            )}
          </div>
        </div>

        {/* Conjoint si couple */}
        {dossierType === 'couple' && formData.conjoint && (
          <div className="bg-white dark:bg-gray-800 rounded-2xl sm:rounded-3xl p-6 sm:p-8 border-2 border-gray-100 dark:border-gray-700">
            <div className="flex items-center mb-6">
              <div className="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/30 rounded-xl flex items-center justify-center mr-4">
                <i className="ri-user-heart-line text-emerald-600 dark:text-emerald-400"></i>
              </div>
              <h3 className="text-xl font-medium text-gray-900 dark:text-white">
                Co-emprunteur / Conjoint
              </h3>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {renderInputField(
                "Civilité",
                "conjoint.civilite",
                "select",
                formData.conjoint.civilite,
                true,
                "Sélectionnez",
                [
                  { value: 'M', label: 'M.' },
                  { value: 'Mme', label: 'Mme' },
                  { value: 'Mlle', label: 'Mlle' }
                ]
              )}
              
              {renderInputField(
                "Nom",
                "conjoint.nom",
                "text",
                formData.conjoint.nom,
                true,
                "Nom de famille"
              )}
              
              {renderInputField(
                "Prénom",
                "conjoint.prenom",
                "text",
                formData.conjoint.prenom,
                true,
                "Prénom"
              )}
              
              {renderInputField(
                "Nom de naissance",
                "conjoint.nom_naissance",
                "text",
                formData.conjoint.nom_naissance,
                true,
                "Nom de jeune fille si différent"
              )}
              
              {renderInputField(
                "Date de naissance",
                "conjoint.dateNaissance",
                "date",
                formData.conjoint.dateNaissance,
                true
              )}
              
              {renderInputField(
                "Catégorie professionnelle",
                "conjoint.categorie_professionnelle",
                "select",
                String(formData.conjoint.categorie_professionnelle),
                true,
                "Sélectionnez la catégorie",
                CATEGORY_OPTIONS
              )}
              
              <div className="space-y-2">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                  Statut fumeur
                </label>
                <div className="flex items-center space-x-6 pt-2">
                  <label className="flex items-center cursor-pointer">
                    <input
                      type="radio"
                      name="conjoint.fumeur"
                      checked={!formData.conjoint.fumeur}
                      onChange={() => updateField('conjoint.fumeur', false)}
                      className="mr-2 text-[#335FAD] focus:ring-indigo-500"
                    />
                    <span className="text-sm text-gray-700 dark:text-gray-300">Non-fumeur</span>
                  </label>
                  <label className="flex items-center cursor-pointer">
                    <input
                      type="radio"
                      name="conjoint.fumeur"
                      checked={formData.conjoint.fumeur}
                      onChange={() => updateField('conjoint.fumeur', true)}
                      className="mr-2 text-[#335FAD] focus:ring-indigo-500"
                    />
                    <span className="text-sm text-gray-700 dark:text-gray-300">Fumeur</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Actions */}
        <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
          <button
            type="button"
            onClick={onBack}
            className="w-full sm:w-auto bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2"
          >
            <i className="ri-arrow-left-line"></i>
            <span>Retour</span>
          </button>
          
          <button
            type="submit"
            disabled={isSubmitting}
            className="w-full sm:w-auto bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-8 py-3 rounded-xl font-medium transition-colors cursor-pointer flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
          >
            {isSubmitting ? (
              <>
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                <span>Sauvegarde...</span>
              </>
            ) : (
              <>
                <span>Continuer</span>
                <i className="ri-arrow-right-line"></i>
              </>
            )}
          </button>
        </div>
      </form>
    </div>
  );
}

================
File: components/DataComparisonModal.tsx
================
'use client'

import { useState, useMemo } from 'react'
import { DiffReport, FieldDifference } from '@/types/data-comparison'
import { DataComparisonService } from '@/lib/services/data-comparison'

interface DataComparisonModalProps {
  isOpen: boolean
  onClose: () => void
  diffReport: DiffReport
  onApplyChanges: (selectedFields: string[], updateType: boolean) => Promise<void>
}

export default function DataComparisonModal({
  isOpen,
  onClose,
  diffReport,
  onApplyChanges
}: DataComparisonModalProps) {
  const [selectedFields, setSelectedFields] = useState<Set<string>>(new Set())
  const [updateType, setUpdateType] = useState(false)
  const [isApplying, setIsApplying] = useState(false)

  // Calcul : tous les champs sélectionnables
  const allFields = useMemo(() => {
    return [
      ...diffReport.principalDiffs.map(d => `principal.${d.field}`),
      ...diffReport.conjointDiffs.map(d => `conjoint.${d.field}`)
    ]
  }, [diffReport])

  // Toggle un champ individuel
  const toggleField = (fieldKey: string) => {
    setSelectedFields(prev => {
      const newSet = new Set(prev)
      if (newSet.has(fieldKey)) {
        newSet.delete(fieldKey)
      } else {
        newSet.add(fieldKey)
      }
      return newSet
    })
  }

  // Tout sélectionner / Tout désélectionner
  const toggleSelectAll = () => {
    if (selectedFields.size === allFields.length) {
      setSelectedFields(new Set())
    } else {
      setSelectedFields(new Set(allFields))
    }
  }

  // Appliquer les changements
  const handleApply = async () => {
    try {
      setIsApplying(true)
      await onApplyChanges(Array.from(selectedFields), updateType)
      onClose()
    } catch (error) {
      console.error('Erreur lors de l\'application des changements:', error)
      alert('Une erreur est survenue lors de l\'application des changements')
    } finally {
      setIsApplying(false)
    }
  }

  // Rendu d'une différence individuelle
  const renderDifference = (diff: FieldDifference, category: 'principal' | 'conjoint') => {
    const fieldKey = `${category}.${diff.field}`
    const isSelected = selectedFields.has(fieldKey)

    return (
      <div
        key={fieldKey}
        className="flex items-start gap-3 p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors"
      >
        <input
          type="checkbox"
          checked={isSelected}
          onChange={() => toggleField(fieldKey)}
          className="mt-1 w-4 h-4 text-[#335FAD] rounded focus:ring-[#335FAD]"
        />
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 mb-1">
            <h5 className="text-sm font-medium text-gray-900 dark:text-white">
              {diff.label}
            </h5>
            {diff.isNew && (
              <span className="px-2 py-0.5 text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400 rounded">
                Nouveau
              </span>
            )}
          </div>
          <div className="grid grid-cols-2 gap-2 text-xs">
            <div className="space-y-1">
              <p className="text-gray-500 dark:text-gray-400 font-medium">Actuel :</p>
              <p className="text-gray-700 dark:text-gray-300 break-words">
                {DataComparisonService.formatValue(diff.currentValue, diff.field)}
              </p>
            </div>
            <div className="space-y-1">
              <p className="text-[#335FAD] dark:text-[#335FAD]/90 font-medium">Extrait :</p>
              <p className="text-gray-900 dark:text-white font-medium break-words">
                {DataComparisonService.formatValue(diff.extractedValue, diff.field)}
              </p>
            </div>
          </div>
        </div>
      </div>
    )
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
      <div className="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        {/* Header */}
        <div className="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-800">
          <div>
            <h2 className="text-2xl font-light text-gray-900 dark:text-white">
              Différences détectées
            </h2>
            <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
              {diffReport.totalDifferences} différence{diffReport.totalDifferences > 1 ? 's' : ''} trouvée{diffReport.totalDifferences > 1 ? 's' : ''} dans les données extraites
            </p>
          </div>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
          >
            <i className="ri-close-line text-2xl"></i>
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6 space-y-6">
          {/* Contrôles de sélection */}
          <div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
            <button
              onClick={toggleSelectAll}
              className="text-sm font-medium text-[#335FAD] hover:text-[#335FAD]/80 transition-colors flex items-center gap-2"
            >
              <i className={`ri-${selectedFields.size === allFields.length ? 'checkbox' : 'checkbox-blank'}-line`}></i>
              {selectedFields.size === allFields.length ? 'Tout désélectionner' : 'Tout sélectionner'}
            </button>
            <p className="text-sm text-gray-600 dark:text-gray-400">
              {selectedFields.size} / {allFields.length} sélectionné{selectedFields.size > 1 ? 's' : ''}
            </p>
          </div>

          {/* Conflit de type de dossier */}
          {diffReport.hasTypeMismatch && (
            <div className="p-4 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg">
              <div className="flex items-start gap-3">
                <i className="ri-alert-line text-orange-600 dark:text-orange-400 text-xl mt-0.5"></i>
                <div className="flex-1">
                  <h4 className="text-sm font-semibold text-orange-900 dark:text-orange-300 mb-2">
                    Conflit de type de dossier détecté
                  </h4>
                  <p className="text-sm text-orange-800 dark:text-orange-400 mb-3">
                    Le type actuel est <strong>{diffReport.currentType === 'seul' ? 'Emprunteur seul' : 'Couple'}</strong>, 
                    mais l'extraction détecte <strong>{diffReport.detectedType === 'seul' ? 'Emprunteur seul' : 'Couple'}</strong>.
                  </p>
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={updateType}
                      onChange={(e) => setUpdateType(e.target.checked)}
                      className="w-4 h-4 text-orange-600 rounded focus:ring-orange-500"
                    />
                    <span className="text-sm font-medium text-orange-900 dark:text-orange-300">
                      Mettre à jour le type de dossier vers "{diffReport.detectedType === 'seul' ? 'Emprunteur seul' : 'Couple'}"
                    </span>
                  </label>
                </div>
              </div>
            </div>
          )}

          {/* Emprunteur principal */}
          {diffReport.principalDiffs.length > 0 && (
            <div className="space-y-3">
              <h3 className="text-lg font-medium text-gray-900 dark:text-white flex items-center gap-2">
                <i className="ri-user-line text-[#335FAD]"></i>
                Emprunteur principal ({diffReport.principalDiffs.length})
              </h3>
              {diffReport.principalDiffs.map(diff => renderDifference(diff, 'principal'))}
            </div>
          )}

          {/* Conjoint */}
          {diffReport.conjointDiffs.length > 0 && (
            <div className="space-y-3">
              <h3 className="text-lg font-medium text-gray-900 dark:text-white flex items-center gap-2">
                <i className="ri-user-heart-line text-[#335FAD]"></i>
                Conjoint ({diffReport.conjointDiffs.length})
              </h3>
              {diffReport.conjointDiffs.map(diff => renderDifference(diff, 'conjoint'))}
            </div>
          )}

          {/* Champs manquants (non bloquant) */}
          {diffReport.champsManquants.length > 0 && (
            <div className="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
              <div className="flex items-start gap-3">
                <i className="ri-information-line text-blue-600 dark:text-blue-400 text-xl mt-0.5"></i>
                <div className="flex-1">
                  <h4 className="text-sm font-semibold text-blue-900 dark:text-blue-300 mb-2">
                    Informations non trouvées
                  </h4>
                  <p className="text-sm text-blue-800 dark:text-blue-400 mb-2">
                    Les champs suivants n'ont pas pu être extraits des documents :
                  </p>
                  <div className="flex flex-wrap gap-2">
                    {diffReport.champsManquants.map(champ => (
                      <span
                        key={champ}
                        className="px-2 py-1 text-xs bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-300 rounded"
                      >
                        {champ}
                      </span>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="flex items-center justify-between gap-3 p-6 border-t border-gray-200 dark:border-gray-800">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors"
            disabled={isApplying}
          >
            Annuler
          </button>
          <button
            onClick={handleApply}
            disabled={selectedFields.size === 0 && !updateType || isApplying}
            className="px-6 py-2 bg-[#335FAD] text-white rounded-lg hover:bg-[#2a4d8f] transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
          >
            {isApplying ? (
              <>
                <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                Application...
              </>
            ) : (
              <>
                <i className="ri-check-line"></i>
                Appliquer les changements ({selectedFields.size + (updateType ? 1 : 0)})
              </>
            )}
          </button>
        </div>
      </div>
    </div>
  )
}

================
File: components/DocumentUpload.tsx
================
'use client';

import { useState, useRef } from 'react';

type DossierType = 'seul' | 'couple';

interface DocumentsInfo {
  offrePret: File | null;
  tableauAmortissement: File | null;
  carteIdentite: File | null;
  carteIdentiteConjoint?: File | null;
}

interface DocumentUploadProps {
  dossierType: DossierType;
  documents: DocumentsInfo;
  onDocumentsUpdate: (documents: DocumentsInfo) => void;
  onBack: () => void;
  onSubmit: () => void;
  isSubmitting: boolean;
  commentaire?: string;
  onCommentaireChange?: (commentaire: string) => void;
  submitButtonText?: string;
}

export default function DocumentUpload({ 
  dossierType, 
  documents, 
  onDocumentsUpdate, 
  onBack, 
  onSubmit, 
  isSubmitting,
  commentaire = '',
  onCommentaireChange,
  submitButtonText = "Soumettre le dossier"
}: DocumentUploadProps) {
  const [draggedOver, setDraggedOver] = useState<string | null>(null);
  const [uploadErrors, setUploadErrors] = useState<Record<string, string>>({});
  
  const fileInputRefs = {
    offrePret: useRef<HTMLInputElement>(null),
    tableauAmortissement: useRef<HTMLInputElement>(null),
    carteIdentite: useRef<HTMLInputElement>(null),
    carteIdentiteConjoint: useRef<HTMLInputElement>(null)
  };

  // Documents obligatoires selon le type
  const requiredDocuments = [
    {
      key: 'offrePret',
      title: 'Offre de Prêt',
      description: 'Document officiel de la banque avec les conditions du prêt',
      icon: 'ri-file-text-line',
      accept: '.pdf,.jpg,.jpeg,.png',
      required: true
    },
    {
      key: 'tableauAmortissement',
      title: "Tableau d'Amortissement",
      description: 'Détail des échéances et du capital restant dû',
      icon: 'ri-table-line',
      accept: '.pdf,.jpg,.jpeg,.png,.xlsx,.xls',
      required: true
    },
    {
      key: 'carteIdentite',
      title: "Carte d'Identité (Emprunteur)",
      description: 'Pièce d\'identité valide recto-verso',
      icon: 'ri-id-card-line',
      accept: '.pdf,.jpg,.jpeg,.png',
      required: true
    },
    ...(dossierType === 'couple' ? [{
      key: 'carteIdentiteConjoint',
      title: "Carte d'Identité (Conjoint)",
      description: 'Pièce d\'identité du co-emprunteur recto-verso',
      icon: 'ri-id-card-line',
      accept: '.pdf,.jpg,.jpeg,.png',
      required: true
    }] : [])
  ];

  // Validation des fichiers
  const validateFile = (file: File, documentKey: string): string | null => {
    // Taille maximum : 50MB (configurable via env)
    const maxSize = process.env.NEXT_PUBLIC_MAX_FILE_SIZE ? 
      parseInt(process.env.NEXT_PUBLIC_MAX_FILE_SIZE) : 
      50 * 1024 * 1024; // 50MB par défaut
    
    if (file.size > maxSize) {
      const maxSizeMB = Math.round(maxSize / (1024 * 1024));
      return `Le fichier ne peut pas dépasser ${maxSizeMB}MB`;
    }

    // Types de fichiers acceptés
    const acceptedTypes = requiredDocuments.find(doc => doc.key === documentKey)?.accept || '';
    const fileExtension = '.' + file.name.split('.').pop()?.toLowerCase();
    
    if (!acceptedTypes.includes(fileExtension)) {
      return 'Type de fichier non supporté';
    }

    return null;
  };

  // Gestion des fichiers
  const handleFileSelect = (documentKey: string, file: File) => {
    const error = validateFile(file, documentKey);
    
    if (error) {
      setUploadErrors(prev => ({
        ...prev,
        [documentKey]: error
      }));
      return;
    }

    // Supprimer l'erreur s'il y en avait une
    setUploadErrors(prev => {
      const newErrors = { ...prev };
      delete newErrors[documentKey];
      return newErrors;
    });

    // Mettre à jour les documents
    const updatedDocuments = {
      ...documents,
      [documentKey]: file
    };
    
    onDocumentsUpdate(updatedDocuments);
  };

  // Gestion du drag & drop
  const handleDragOver = (e: React.DragEvent, documentKey: string) => {
    e.preventDefault();
    setDraggedOver(documentKey);
  };

  const handleDragLeave = (e: React.DragEvent) => {
    e.preventDefault();
    setDraggedOver(null);
  };

  const handleDrop = (e: React.DragEvent, documentKey: string) => {
    e.preventDefault();
    setDraggedOver(null);
    
    const files = Array.from(e.dataTransfer.files);
    if (files.length > 0) {
      handleFileSelect(documentKey, files[0]);
    }
  };

  // Supprimer un document
  const removeDocument = (documentKey: string) => {
    const updatedDocuments = {
      ...documents,
      [documentKey]: null
    };
    onDocumentsUpdate(updatedDocuments);

    // Supprimer l'erreur s'il y en avait une
    setUploadErrors(prev => {
      const newErrors = { ...prev };
      delete newErrors[documentKey];
      return newErrors;
    });
  };

  // Consulter un document
  const viewDocument = (file: File) => {
    const url = URL.createObjectURL(file);
    window.open(url, '_blank');
    
    // Nettoyer l'URL après un délai pour libérer la mémoire
    setTimeout(() => {
      URL.revokeObjectURL(url);
    }, 1000);
  };

  // Formatage de la taille de fichier
  const formatFileSize = (bytes: number): string => {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  // Tronquer le nom de fichier s'il est trop long
  const truncateFileName = (fileName: string, maxLength: number = 25): string => {
    if (fileName.length <= maxLength) return fileName;
    
    const extension = fileName.split('.').pop();
    const nameWithoutExt = fileName.substring(0, fileName.lastIndexOf('.'));
    const truncatedName = nameWithoutExt.substring(0, maxLength - (extension?.length || 0) - 4) + '...';
    
    return `${truncatedName}.${extension}`;
  };

  // Composant de zone d'upload
  const UploadZone = ({ document }: { document: any }) => {
    const file = documents[document.key as keyof DocumentsInfo];
    const isDragged = draggedOver === document.key;
    const hasError = uploadErrors[document.key];

    return (
      <div className={`relative border-2 border-dashed rounded-2xl p-6 transition-all duration-300 ${
        hasError 
          ? 'border-red-300 dark:border-red-600 bg-red-50 dark:bg-red-900/20'
          : isDragged 
          ? 'border-[#335FAD]/40 dark:border-[#335FAD]/50 bg-[#335FAD]/5 dark:bg-[#335FAD]/20'
          : file 
          ? 'border-green-300 dark:border-green-600 bg-green-50 dark:bg-green-900/20'
          : 'border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/50 hover:border-[#335FAD]/30 dark:hover:border-[#335FAD]/60 hover:bg-[#335FAD]/5 dark:hover:bg-[#335FAD]/10'
      }`}
      onDragOver={(e) => handleDragOver(e, document.key)}
      onDragLeave={handleDragLeave}
      onDrop={(e) => handleDrop(e, document.key)}
      >
        {file ? (
          // Fichier uploadé
          <div className="text-center">
            <div className="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-xl flex items-center justify-center mx-auto mb-4">
              <i className="ri-file-check-line text-green-600 dark:text-green-400 text-xl"></i>
            </div>
            
            {/* Nom du fichier avec gestion du débordement */}
            <div className="mb-1">
              <p className="font-medium text-gray-900 dark:text-white text-sm break-words" title={file.name}>
                {truncateFileName(file.name)}
              </p>
            </div>
            
            <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">{formatFileSize(file.size)}</p>
            
            {/* Actions en ligne avec espacement optimisé */}
            <div className="flex flex-wrap items-center justify-center gap-2 text-sm">
              <button
                type="button"
                onClick={() => viewDocument(file)}
                className="bg-[#335FAD]/10 dark:bg-[#335FAD]/30 hover:bg-[#335FAD]/20 dark:hover:bg-[#335FAD]/50 text-[#335FAD] dark:text-[#335FAD] px-3 py-1.5 rounded-lg font-medium transition-colors cursor-pointer flex items-center space-x-1 whitespace-nowrap"
              >
                <i className="ri-eye-line text-xs"></i>
                <span>Consulter</span>
              </button>
              
              <button
                type="button"
                onClick={() => fileInputRefs[document.key as keyof typeof fileInputRefs].current?.click()}
                className="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-1.5 rounded-lg font-medium transition-colors cursor-pointer flex items-center space-x-1 whitespace-nowrap"
              >
                <i className="ri-refresh-line text-xs"></i>
                <span>Remplacer</span>
              </button>
              
              <button
                type="button"
                onClick={() => removeDocument(document.key)}
                className="bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-700 dark:text-red-400 px-3 py-1.5 rounded-lg font-medium transition-colors cursor-pointer flex items-center space-x-1 whitespace-nowrap"
              >
                <i className="ri-delete-bin-line text-xs"></i>
                <span>Supprimer</span>
              </button>
            </div>
          </div>
        ) : (
          // Zone d'upload vide
          <div className="text-center">
            <div className={`w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-4 ${
              hasError 
                ? 'bg-red-100 dark:bg-red-900/30'
                : 'bg-gray-100 dark:bg-gray-700'
            }`}>
              <i className={`${document.icon} text-xl ${
                hasError 
                  ? 'text-red-600 dark:text-red-400'
                  : 'text-gray-600 dark:text-gray-400'
              }`}></i>
            </div>
            
            <p className="font-medium text-gray-900 dark:text-white mb-1">
              {document.title}
              {document.required && <span className="text-red-500 ml-1">*</span>}
            </p>
            <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">{document.description}</p>
            
            <button
              type="button"
              onClick={() => fileInputRefs[document.key as keyof typeof fileInputRefs].current?.click()}
              className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer whitespace-nowrap"
            >
              Choisir un fichier
            </button>
            
            <p className="text-xs text-gray-400 dark:text-gray-500 mt-3">
              Ou glissez-déposez votre fichier ici
            </p>
            <p className="text-xs text-gray-400 dark:text-gray-500">
              Formats acceptés : {document.accept} • Max 10MB
            </p>
          </div>
        )}

        {hasError && (
          <div className="mt-4 p-3 bg-red-100 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-lg">
            <p className="text-red-600 dark:text-red-400 text-sm flex items-center">
              <i className="ri-error-warning-line mr-2"></i>
              {hasError}
            </p>
          </div>
        )}

        {/* Input fichier caché */}
        <input
          ref={fileInputRefs[document.key as keyof typeof fileInputRefs]}
          type="file"
          accept={document.accept}
          onChange={(e) => {
            const file = e.target.files?.[0];
            if (file) {
              handleFileSelect(document.key, file);
            }
          }}
          className="hidden"
        />
      </div>
    );
  };

  return (
    <div className="max-w-4xl mx-auto">
      {/* Header */}
      <div className="text-center mb-8 sm:mb-12">
        <h2 className="text-2xl sm:text-3xl font-light text-gray-900 dark:text-white mb-4">
          Documents obligatoires
        </h2>
        <p className="text-gray-500 dark:text-gray-400 text-lg">
          Téléchargez les pièces justificatives nécessaires au traitement de votre dossier
        </p>
      </div>

      {/* Zones d'upload */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        {requiredDocuments.map((document) => (
          <UploadZone key={document.key} document={document} />
        ))}
      </div>

      {/* Champ commentaire pour l'apporteur */}
      {onCommentaireChange && (
        <div className="mt-6">
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Commentaire pour l'admin (optionnel)
          </label>
          <textarea
            value={commentaire}
            onChange={(e) => onCommentaireChange(e.target.value)}
            placeholder="Ajoutez un commentaire pour l'admin concernant ce dossier..."
            rows={3}
            className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:ring-2 focus:ring-[#335FAD] focus:border-transparent resize-none"
          />
        </div>
      )}

      {/* Actions */}
      <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
        <button
          type="button"
          onClick={onBack}
          className="w-full sm:w-auto bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-xl font-medium transition-colors flex items-center justify-center"
        >
          <i className="ri-arrow-left-line mr-2"></i>
          <span>Retour</span>
        </button>

        <button
          type="button"
          onClick={onSubmit}
          disabled={isSubmitting}
          className="w-full sm:w-auto bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-6 py-3 rounded-xl font-medium transition-colors flex items-center justify-center disabled:opacity-50"
        >
          {isSubmitting ? (
            <>
              <i className="ri-loader-4-line mr-2 animate-spin"></i>
              <span>Traitement...</span>
            </>
          ) : (
            <>
              <i className="ri-send-plane-line mr-2"></i>
              <span>{submitButtonText}</span>
            </>
          )}
        </button>
      </div>
    </div>
  );
}

================
File: components/DossierCard.tsx
================
'use client'

import React from 'react'
import { useIntersectionObserver } from '@/lib/hooks/useIntersectionObserver'
import { useOptimisticReadStatus } from '@/lib/hooks/useOptimisticReadStatus'

interface DossierCardProps {
  children: React.ReactNode
  dossierId: string
  isRead: boolean
  onMarkAsRead: (id: string) => void
  isResponsive?: boolean
}

export default function DossierCard({ 
  children, 
  dossierId, 
  isRead: initialIsRead, 
  onMarkAsRead,
  isResponsive = false 
}: DossierCardProps) {
  const { elementRef, isIntersecting } = useIntersectionObserver({
    threshold: 0.8, // 80% de l'élément visible
    freezeOnceVisible: true
  })

  const { isRead, markAsRead, hasPendingUpdate } = useOptimisticReadStatus(
    dossierId,
    initialIsRead
  )

  // Marquer comme lu quand visible (uniquement en responsive)
  React.useEffect(() => {
    if (isResponsive && isIntersecting && !isRead) {
      markAsRead()
      onMarkAsRead(dossierId) // Pour la compatibilité avec l'ancien système
    }
  }, [isIntersecting, isRead, dossierId, onMarkAsRead, isResponsive, markAsRead])

  // Cloner les enfants et ajouter les props optimistes
  const childrenWithOptimisticProps = React.cloneElement(children as React.ReactElement<any>, {
    'data-is-read': isRead,
    'data-has-pending': hasPendingUpdate,
    'data-original-is-read': initialIsRead
  })

  return (
    <div ref={elementRef}>
      {childrenWithOptimisticProps}
    </div>
  )
}

================
File: components/DossierProgress.tsx
================
'use client';

interface DossierProgressProps {
  currentStep: number;
}

export default function DossierProgress({ currentStep }: DossierProgressProps) {
  const steps = [
    { number: 1, title: 'Type de dossier', subtitle: 'Seul ou couple' },
    { number: 2, title: 'Informations client', subtitle: 'Données personnelles' },
    { number: 3, title: 'Documents', subtitle: 'Pièces justificatives' }
  ];

  return (
    // Centrage de la progress bar en responsive
    <div className="flex items-center justify-center">
      <div className="flex items-center space-x-2 sm:space-x-4">
        {steps.map((step, index) => (
          <div key={step.number} className="flex items-center">
            {/* Step Circle */}
            <div className="flex flex-col items-center">
              <div className={`w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm sm:text-base font-medium border-2 transition-all duration-300 ${
                currentStep > step.number
                  ? 'bg-green-500 border-green-500 text-white'
                  : currentStep === step.number
                  ? 'bg-[#335FAD] border-[#335FAD] text-white'
                  : 'bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-400 dark:text-gray-500'
              }`}>
                {currentStep > step.number ? (
                  <i className="ri-check-line"></i>
                ) : (
                  step.number
                )}
              </div>
              
              {/* Step Labels - Hidden on very small screens */}
              <div className="hidden sm:block text-center mt-2">
                <p className={`text-xs font-medium ${
                  currentStep >= step.number 
                    ? 'text-gray-900 dark:text-white' 
                    : 'text-gray-400 dark:text-gray-500'
                }`}>
                  {step.title}
                </p>
                <p className="text-xs text-gray-400 dark:text-gray-500">
                  {step.subtitle}
                </p>
              </div>
            </div>

            {/* Connector Line */}
            {index < steps.length - 1 && (
              <div className={`w-8 sm:w-12 h-0.5 mx-2 sm:mx-4 transition-colors duration-300 ${
                currentStep > step.number 
                  ? 'bg-green-500' 
                  : 'bg-gray-300 dark:bg-gray-600'
              }`}></div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}

================
File: components/DossierTypeSelection.tsx
================
'use client';

import { useState } from 'react';

type DossierType = 'seul' | 'couple';

interface DossierTypeSelectionProps {
  selectedType: DossierType;
  onTypeSelect: (type: DossierType) => void;
}

export default function DossierTypeSelection({ selectedType, onTypeSelect }: DossierTypeSelectionProps) {
  const [hoveredType, setHoveredType] = useState<DossierType | null>(null);

  const dossierTypes = [
    {
      type: 'seul' as DossierType,
      title: 'Emprunteur seul',
      subtitle: 'Personne célibataire ou dossier individuel',
      icon: 'ri-user-line',
      description: 'Idéal pour une personne seule souhaitant souscrire une assurance emprunteur',
      features: [
        'Formulaire simplifié',
        'Documents personnels uniquement',
        'Traitement accéléré'
      ],
      color: 'indigo'
    },
    {
      type: 'couple' as DossierType,
      title: 'Couple',
      subtitle: 'Deux emprunteurs (mariés, pacsés ou concubins)',
      icon: 'ri-team-line',
      description: 'Pour un couple souhaitant une couverture commune ou séparée',
      features: [
        'Informations des deux conjoints',
        'Documents pour chaque emprunteur',
        'Optimisation des garanties'
      ],
      color: 'emerald'
    }
  ];

  const getColorClasses = (color: string, isSelected: boolean, isHovered: boolean) => {
    const colors = {
      indigo: {
        bg: isSelected ? 'bg-[#335FAD]/10 dark:bg-[#335FAD]/20' : isHovered ? 'bg-[#335FAD]/5 dark:bg-[#335FAD]/10' : 'bg-white dark:bg-gray-800',
        border: isSelected ? 'border-[#335FAD]/30 dark:border-[#335FAD]/60' : isHovered ? 'border-[#335FAD]/20 dark:border-[#335FAD]/70' : 'border-gray-200 dark:border-gray-700',
        icon: isSelected ? 'text-[#335FAD] dark:text-[#335FAD] bg-[#335FAD]/10 dark:bg-[#335FAD]/30' : 'text-[#335FAD]/80 dark:text-[#335FAD] bg-[#335FAD]/5 dark:bg-[#335FAD]/20',
        title: isSelected ? 'text-[#335FAD] dark:text-[#335FAD]' : 'text-gray-900 dark:text-white',
        check: 'text-[#335FAD] dark:text-[#335FAD] bg-[#335FAD]/10 dark:bg-[#335FAD]/30'
      },
      emerald: {
        bg: isSelected ? 'bg-emerald-50 dark:bg-emerald-900/20' : isHovered ? 'bg-emerald-25 dark:bg-emerald-900/10' : 'bg-white dark:bg-gray-800',
        border: isSelected ? 'border-emerald-300 dark:border-emerald-600' : isHovered ? 'border-emerald-200 dark:border-emerald-700' : 'border-gray-200 dark:border-gray-700',
        icon: isSelected ? 'text-emerald-600 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900/30' : 'text-emerald-500 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20',
        title: isSelected ? 'text-emerald-700 dark:text-emerald-400' : 'text-gray-900 dark:text-white',
        check: 'text-emerald-600 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900/30'
      }
    };
    return colors[color as keyof typeof colors];
  };

  return (
    <div className="max-w-4xl mx-auto">
      {/* Header */}
      <div className="text-center mb-8 sm:mb-12">
        <h2 className="text-2xl sm:text-3xl font-light text-gray-900 dark:text-white mb-4">
          Choisissez le type de dossier
        </h2>
        <p className="text-gray-500 dark:text-gray-400 text-lg max-w-2xl mx-auto">
          Sélectionnez le type d'emprunteur pour adapter le formulaire à votre situation
        </p>
      </div>

      {/* Type Selection Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 sm:gap-8 mb-8">
        {dossierTypes.map((type) => {
          const isSelected = selectedType === type.type;
          const isHovered = hoveredType === type.type;
          const colorClasses = getColorClasses(type.color, isSelected, isHovered);

          return (
            <div
              key={type.type}
              className={`relative p-6 sm:p-8 rounded-2xl sm:rounded-3xl border-2 transition-all duration-300 cursor-pointer hover:shadow-lg group ${colorClasses.bg} ${colorClasses.border}`}
              onClick={() => onTypeSelect(type.type)}
              onMouseEnter={() => setHoveredType(type.type)}
              onMouseLeave={() => setHoveredType(null)}
            >
              {/* Selection Indicator */}
              {isSelected && (
                <div className={`absolute top-4 right-4 w-6 h-6 rounded-full flex items-center justify-center ${colorClasses.check} border-2 border-white dark:border-gray-800`}>
                  <i className="ri-check-line text-sm font-bold"></i>
                </div>
              )}

              {/* Icon */}
              <div className={`w-14 h-14 sm:w-16 sm:h-16 rounded-2xl flex items-center justify-center mb-6 border transition-all duration-300 ${colorClasses.icon}`}>
                <i className={`${type.icon} text-2xl sm:text-3xl`}></i>
              </div>

              {/* Content */}
              <div className="mb-6">
                <h3 className={`text-xl sm:text-2xl font-medium mb-2 transition-colors duration-300 ${colorClasses.title}`}>
                  {type.title}
                </h3>
                <p className="text-gray-500 dark:text-gray-400 text-sm sm:text-base mb-4">
                  {type.subtitle}
                </p>
                <p className="text-gray-600 dark:text-gray-300 text-sm">
                  {type.description}
                </p>
              </div>

              {/* Features */}
              <div className="space-y-2">
                {type.features.map((feature, index) => (
                  <div key={index} className="flex items-center text-sm text-gray-600 dark:text-gray-300">
                    <div className={`w-4 h-4 rounded-full flex items-center justify-center mr-3 ${
                      type.color === 'indigo' 
                        ? 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30' 
                        : 'bg-emerald-100 dark:bg-emerald-900/30'
                    }`}>
                      <i className={`ri-check-line text-xs ${
                        type.color === 'indigo' 
                          ? 'text-[#335FAD] dark:text-[#335FAD]' 
                          : 'text-emerald-600 dark:text-emerald-400'
                      }`}></i>
                    </div>
                    {feature}
                  </div>
                ))}
              </div>

              {/* Hover Effect */}
              <div className="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent rounded-2xl sm:rounded-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
            </div>
          );
        })}
      </div>

      {/* Continue Button */}
      <div className="text-center">
        <button
          onClick={() => onTypeSelect(selectedType)}
          className="bg-[#335FAD] hover:bg-[#335FAD]/90 dark:bg-[#335FAD] dark:hover:bg-[#335FAD]/90 text-white px-8 py-4 rounded-2xl font-medium transition-all duration-200 hover:shadow-lg flex items-center space-x-3 mx-auto whitespace-nowrap cursor-pointer"
        >
          <span>Continuer</span>
          <i className="ri-arrow-right-line text-lg"></i>
        </button>
      </div>
    </div>
  );
}

================
File: components/ExtractionResult.tsx
================
'use client'

import React from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { AlertCircle, CheckCircle, Clock, FileText, User, Euro, Calendar } from 'lucide-react'

interface ExtractionResultProps {
  extractionData: {
    success: boolean
    error?: string
    message: string
    confidence?: number
    warnings?: string[]
    sourcesUtilisees?: string[]
  }
}

export function ExtractionResult({ extractionData }: ExtractionResultProps) {
  if (!extractionData.success && !extractionData.error) {
    return null // Pas d'extraction tentée
  }

  return (
    <Card className="mt-4">
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          {extractionData.success ? (
            <CheckCircle className="h-5 w-5 text-green-500" />
          ) : (
            <AlertCircle className="h-5 w-5 text-red-500" />
          )}
          Extraction Automatique des Documents
        </CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {/* Statut principal */}
          <div className="flex items-center gap-2">
            <Badge variant={extractionData.success ? "default" : "destructive"}>
              {extractionData.success ? "Réussie" : "Échouée"}
            </Badge>
            {extractionData.confidence && (
              <Badge variant="outline">
                Confiance: {Math.round(extractionData.confidence * 100)}%
              </Badge>
            )}
          </div>

          {/* Message */}
          <p className="text-sm text-muted-foreground">
            {extractionData.message}
          </p>

          {/* Sources utilisées */}
          {extractionData.sourcesUtilisees && extractionData.sourcesUtilisees.length > 0 && (
            <div>
              <h4 className="text-sm font-medium mb-2 flex items-center gap-1">
                <FileText className="h-4 w-4" />
                Sources utilisées:
              </h4>
              <div className="flex flex-wrap gap-1">
                {extractionData.sourcesUtilisees.map((source, index) => (
                  <Badge key={index} variant="secondary" className="text-xs">
                    {source}
                  </Badge>
                ))}
              </div>
            </div>
          )}

          {/* Warnings */}
          {extractionData.warnings && extractionData.warnings.length > 0 && (
            <div>
              <h4 className="text-sm font-medium mb-2 flex items-center gap-1 text-yellow-600">
                <AlertCircle className="h-4 w-4" />
                Avertissements:
              </h4>
              <ul className="text-sm text-yellow-700 space-y-1">
                {extractionData.warnings.map((warning, index) => (
                  <li key={index} className="flex items-start gap-1">
                    <span className="text-yellow-500 mt-0.5">•</span>
                    {warning}
                  </li>
                ))}
              </ul>
            </div>
          )}

          {/* Erreur détaillée */}
          {extractionData.error && (
            <div className="p-3 bg-red-50 border border-red-200 rounded-md">
              <h4 className="text-sm font-medium text-red-800 mb-1">
                Détails de l'erreur:
              </h4>
              <p className="text-sm text-red-700">
                {extractionData.error}
              </p>
            </div>
          )}

          {/* Actions suggérées */}
          {!extractionData.success && (
            <div className="p-3 bg-blue-50 border border-blue-200 rounded-md">
              <h4 className="text-sm font-medium text-blue-800 mb-1">
                Prochaines étapes:
              </h4>
              <p className="text-sm text-blue-700">
                Les données du prêt devront être saisies manuellement dans l'onglet "Infos du prêt".
              </p>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  )
}

// Composant pour afficher les données extraites dans l'interface admin
interface ExtractedDataDisplayProps {
  extractedData: {
    emprunteurs: {
      principal: any
      conjoint: any
    }
    pret: any
    calculs: any
    metadata: any
  }
}

export function ExtractedDataDisplay({ extractedData }: ExtractedDataDisplayProps) {
  return (
    <div className="space-y-4">
      {/* Emprunteurs */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <User className="h-5 w-5" />
            Emprunteurs
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* Emprunteur principal */}
            <div>
              <h4 className="font-medium mb-2">Emprunteur principal</h4>
              <div className="space-y-1 text-sm">
                <p><strong>Nom:</strong> {extractedData.emprunteurs.principal?.nom || 'Non trouvé'}</p>
                <p><strong>Prénom:</strong> {extractedData.emprunteurs.principal?.prenom || 'Non trouvé'}</p>
                <p><strong>Date de naissance:</strong> {extractedData.emprunteurs.principal?.dateNaissance || 'Non trouvée'}</p>
              </div>
            </div>

            {/* Conjoint */}
            {extractedData.emprunteurs.conjoint && (
              <div>
                <h4 className="font-medium mb-2">Conjoint</h4>
                <div className="space-y-1 text-sm">
                  <p><strong>Nom:</strong> {extractedData.emprunteurs.conjoint.nom || 'Non trouvé'}</p>
                  <p><strong>Prénom:</strong> {extractedData.emprunteurs.conjoint.prenom || 'Non trouvé'}</p>
                  <p><strong>Date de naissance:</strong> {extractedData.emprunteurs.conjoint.dateNaissance || 'Non trouvée'}</p>
                </div>
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Prêt */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Euro className="h-5 w-5" />
            Informations du Prêt
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="space-y-1 text-sm">
              <p><strong>Montant:</strong> {extractedData.pret?.montantInitial?.toLocaleString() || 'Non trouvé'} €</p>
              <p><strong>Durée initiale:</strong> {extractedData.pret?.dureeInitialeMois || 'Non trouvée'} mois</p>
              <p><strong>Taux nominal:</strong> {extractedData.pret?.tauxNominal || 'Non trouvé'} %</p>
            </div>
            <div className="space-y-1 text-sm">
              <p><strong>Banque:</strong> {extractedData.pret?.banquePreteuse || 'Non trouvée'}</p>
              <p><strong>Type:</strong> {extractedData.pret?.typePret || 'Non trouvé'}</p>
              <p><strong>Date début:</strong> {extractedData.pret?.dateDebut || 'Non trouvée'}</p>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Calculs métier */}
      {extractedData.calculs && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Calendar className="h-5 w-5" />
              Calculs Métier
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="text-center p-3 bg-blue-50 rounded-lg">
                <p className="text-sm text-blue-600 font-medium">Date de début effective</p>
                <p className="text-lg font-bold text-blue-800">{extractedData.calculs.dateDebutEffective}</p>
              </div>
              <div className="text-center p-3 bg-green-50 rounded-lg">
                <p className="text-sm text-green-600 font-medium">Durée restante</p>
                <p className="text-lg font-bold text-green-800">{extractedData.calculs.dureeRestanteMois} mois</p>
              </div>
              <div className="text-center p-3 bg-purple-50 rounded-lg">
                <p className="text-sm text-purple-600 font-medium">Capital restant dû</p>
                <p className="text-lg font-bold text-purple-800">{extractedData.calculs.capitalRestantDu?.toLocaleString()} €</p>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Métadonnées */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Clock className="h-5 w-5" />
            Métadonnées d'Extraction
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-2 text-sm">
            <p><strong>Confiance:</strong> {Math.round((extractedData.metadata?.confidence || 0) * 100)}%</p>
            {extractedData.metadata?.warnings && extractedData.metadata.warnings.length > 0 && (
              <div>
                <p><strong>Avertissements:</strong></p>
                <ul className="list-disc list-inside text-yellow-700">
                  {extractedData.metadata.warnings.map((warning: string, index: number) => (
                    <li key={index}>{warning}</li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  )
}

================
File: components/features/broker/BrokerContextProvider.tsx
================
"use client";

import React, { createContext, useState, useEffect, ReactNode } from 'react';
import { Broker } from '@/types/model';
import { api } from '@/services/api';

interface BrokerContextProps {
    brokers: Broker[];
    currentBroker: Broker | null;
    currentBrokerId: string | null;
    selectBroker: (brokerId: string) => void;
    isLoading: boolean;
}

export const BrokerContext = createContext<BrokerContextProps | undefined>(undefined);

const BROKER_STORAGE_KEY = 'currentBrokerId';

export const BrokerContextProvider = ({ children }: { children: ReactNode }) => {
    const [brokers, setBrokers] = useState<Broker[]>([]);
    const [currentBrokerId, setCurrentBrokerId] = useState<string | null>(null);
    const [isLoading, setIsLoading] = useState(true);

    // Fetch brokers on mount
    useEffect(() => {
        const fetchBrokers = async () => {
            try {
                const data = await api.getMyBrokers();
                setBrokers(data);
            } catch (err) {
                console.error("Failed to fetch brokers", err);
            } finally {
                setIsLoading(false);
            }
        };
        fetchBrokers();
    }, []);

    // Handle selection logic / persistence
    useEffect(() => {
        if (isLoading) return;

        const storedId = localStorage.getItem(BROKER_STORAGE_KEY);

        // 1. Auto-select if only one broker
        if (brokers.length === 1) {
            const singleBroker = brokers[0];
            if (currentBrokerId !== singleBroker.id) {
                selectBroker(singleBroker.id);
            }
        }
        // 2. Load from storage if matches an available broker
        else if (storedId && brokers.find(b => b.id === storedId)) {
            if (currentBrokerId !== storedId) {
                setCurrentBrokerId(storedId);
            }
        }
        // 3. Fallback: If current Id is invalid or null but we have brokers, select first? 
        // (User req: "Si 1 broker -> auto-select". "Si plusieurs -> afficher une sélection". 
        // So if multiple and no valid storage, maybe leave null to force selection or defaulting to first is fine for now but safer to valid storage)

    }, [brokers, isLoading, currentBrokerId]);

    const selectBroker = (brokerId: string) => {
        const broker = brokers.find(b => b.id === brokerId);
        if (broker) {
            setCurrentBrokerId(brokerId);
            localStorage.setItem(BROKER_STORAGE_KEY, brokerId);
        }
    };

    const currentBroker = brokers.find(b => b.id === currentBrokerId) || null;

    return (
        <BrokerContext.Provider value={{ brokers, currentBroker, currentBrokerId, selectBroker, isLoading }}>
            {children}
        </BrokerContext.Provider>
    );
};

================
File: components/features/document-viewer/DocumentViewerModal.tsx
================
'use client';

import React, { useState, useEffect } from 'react';
import { api } from '@/services/api';

interface DocumentViewerModalProps {
    isOpen: boolean;
    onClose: () => void;
    documentUrl?: string | null;
    documentId?: string | null; // Added ID for fetching URL via service
    documentTitle?: string;
    documentType?: string; // e.g., 'application/pdf', 'image/jpeg' or extension
}

export const DocumentViewerModal = ({
    isOpen,
    onClose,
    documentUrl,
    documentId,
    documentTitle = 'Document',
    documentType
}: DocumentViewerModalProps) => {
    const [loading, setLoading] = useState(true);
    const [fetchedUrl, setFetchedUrl] = useState<string | null>(null);

    useEffect(() => {
        if (isOpen) {
            setLoading(true);
            setFetchedUrl(null);

            const loadDoc = async () => {
                if (documentId) {
                    try {
                        const url = await api.getDocumentViewUrl(documentId);
                        setFetchedUrl(url);
                    } catch (err) {
                        console.error("Failed to fetch document URL", err);
                    } finally {
                        setLoading(false);
                    }
                } else if (documentUrl) {
                    setFetchedUrl(documentUrl);
                    // Simulate generic loading for UX consistency if just URL
                    setTimeout(() => setLoading(false), 500);
                } else {
                    setLoading(false);
                }
            };
            loadDoc();
        }
    }, [isOpen, documentUrl, documentId]);

    const activeUrl = fetchedUrl || documentUrl;

    // Determine if we can preview
    const isPdf = documentType?.includes('pdf') || activeUrl?.endsWith('.pdf');
    const isImage = documentType?.includes('image') || /\.(jpg|jpeg|png|webp|gif)$/i.test(activeUrl || '');

    // Stub behavior
    const isMock = !activeUrl || activeUrl.includes('mock');

    return (
        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />

            <div className="relative w-full max-w-5xl h-[85vh] bg-white dark:bg-gray-800 rounded-xl shadow-2xl overflow-hidden flex flex-col animate-in fade-in zoom-in-95 duration-200">
                {/* Header */}
                <div className="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-white dark:bg-gray-800 z-10">
                    <div className="flex items-center gap-3">
                        <div className="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <i className="ri-file-text-line text-gray-600 dark:text-gray-300"></i>
                        </div>
                        <div>
                            <h2 className="text-lg font-semibold text-gray-900 dark:text-white leading-tight">
                                {documentTitle}
                            </h2>
                            {documentUrl && (
                                <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5 font-mono truncate max-w-[300px]">
                                    {activeUrl?.split('/').pop()}
                                </p>
                            )}
                        </div>
                    </div>
                    <div className="flex items-center gap-2">
                        {activeUrl && (
                            <a
                                href={activeUrl}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="p-2 text-gray-500 hover:text-[#335FAD] dark:text-gray-400 dark:hover:text-[#335FAD] transition-colors"
                                title="Ouvrir dans un nouvel onglet"
                            >
                                <i className="ri-external-link-line text-xl"></i>
                            </a>
                        )}
                        <button
                            onClick={onClose}
                            className="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"
                        >
                            <i className="ri-close-line text-2xl" />
                        </button>
                    </div>
                </div>

                {/* Content */}
                <div className="flex-1 bg-gray-50 dark:bg-gray-900 relative overflow-hidden flex items-center justify-center">
                    {loading ? (
                        <div className="flex flex-col items-center gap-3">
                            <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-[#335FAD]"></div>
                            <p className="text-sm text-gray-500">Chargement du document...</p>
                        </div>
                    ) : !activeUrl ? (
                        <div className="text-center p-8 max-w-md">
                            <div className="w-16 h-16 bg-gray-200 dark:bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i className="ri-file-search-line text-3xl text-gray-400"></i>
                            </div>
                            <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">Document introuvable</h3>
                            <p className="text-gray-500 dark:text-gray-400 mb-6">
                                L'URL du document n'est pas disponible ou le fichier a été supprimé.
                            </p>
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                Fermer
                            </button>
                        </div>
                    ) : isImage ? (
                        <img
                            src={activeUrl}
                            alt={documentTitle}
                            className="max-w-full max-h-full object-contain"
                        />
                    ) : isPdf ? (
                        <iframe
                            src={`${activeUrl}#toolbar=0`}
                            className="w-full h-full"
                            title={documentTitle}
                        />
                    ) : (
                        <div className="text-center p-8">
                            <div className="w-16 h-16 bg-blue-50 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i className="ri-file-download-line text-3xl text-[#335FAD]"></i>
                            </div>
                            <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">Aperçu non disponible</h3>
                            <p className="text-gray-500 dark:text-gray-400 mb-6">
                                Ce type de fichier ne peut pas être prévisualisé directement ({documentType || 'Type inconnu'}).
                            </p>
                            <a
                                href={activeUrl}
                                download
                                className="px-6 py-2.5 bg-[#335FAD] text-white rounded-lg hover:bg-[#335FAD]/90 transition-colors inline-flex items-center gap-2"
                            >
                                <i className="ri-download-line"></i>
                                Télécharger le fichier
                            </a>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

================
File: components/features/exade/ExadeConfiguration.tsx
================
"use client";

import React, { useState, useEffect } from 'react';
import { api } from '@/services/api';
import { useBrokerContext } from '@/hooks/useBrokerContext';

export const ExadeConfiguration = () => {
    const { currentBrokerId } = useBrokerContext();
    const [loading, setLoading] = useState(false);
    const [loadingConfig, setLoadingConfig] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [success, setSuccess] = useState<string | null>(null);
    const [testResult, setTestResult] = useState<'success' | 'error' | null>(null);

    // Configuration State
    const [config, setConfig] = useState({
        codeCourtier: '',
        environment: 'stage',
        isEnabled: false
    });

    // Load existing config on mount
    useEffect(() => {
        const loadConfig = async () => {
            if (!currentBrokerId) {
                setLoadingConfig(false);
                return;
            }

            try {
                const existingConfig = await api.getExadeConfig(currentBrokerId);
                if (existingConfig) {
                    setConfig({
                        codeCourtier: existingConfig.code_courtier || '',
                        environment: existingConfig.environment || 'stage',
                        isEnabled: existingConfig.is_enabled ?? false
                    });
                }
            } catch (err) {
                console.error('Error loading Exade config:', err);
            } finally {
                setLoadingConfig(false);
            }
        };

        loadConfig();
    }, [currentBrokerId]);

    const handleTestConnection = async () => {
        if (!currentBrokerId) return;
        setLoading(true);
        setTestResult(null);
        setError(null);
        setSuccess(null);

        try {
            await api.testExadeConfig(currentBrokerId);
            setTestResult('success');
        } catch (err: any) {
            setTestResult('error');
            setError(err.message || "Échec de la connexion test.");
        } finally {
            setLoading(false);
        }
    };

    const handleSave = async () => {
        if (!currentBrokerId) return;
        setLoading(true);
        setError(null);
        setSuccess(null);
        try {
            await api.saveExadeConfig(currentBrokerId, {
                code_courtier: config.codeCourtier,
                environment: config.environment as 'stage' | 'prod',
                is_enabled: config.isEnabled
            });
            setSuccess("Configuration enregistrée avec succès !");
        } catch (err: any) {
            setError(err.message || "Erreur lors de la sauvegarde.");
        } finally {
            setLoading(false);
        }
    };

    // Mock "Generate Email" action
    const handleGenerateEmail = () => {
        const subject = "Configuration Exade - Demande de codes";
        const body = `Bonjour,\n\nNous souhaitons configurer le connecteur Exade.\nCode Courtier: ${config.codeCourtier}\nEnv: ${config.environment}`;
        window.open(`mailto:support@exade.fr?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
    };

    return (
        <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
            <div className="p-6 border-b border-gray-200 dark:border-gray-700">
                <h2 className="text-lg font-medium text-gray-900 dark:text-white flex items-center">
                    <i className="ri-settings-5-line mr-2 text-[#335FAD]" />
                    Configuration Exade
                </h2>
                <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                    Gérez la connexion avec le tarificateur Exade.
                </p>
            </div>

            <div className="p-6 space-y-6">
                {loadingConfig ? (
                    <div className="flex items-center justify-center py-8">
                        <i className="ri-loader-4-line animate-spin text-2xl text-gray-400" />
                    </div>
                ) : (
                <>
                {/* Status Banner - shows info about test availability */}
                <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-4 flex items-start gap-3">
                    <i className="ri-information-line text-blue-600 dark:text-blue-400 mt-0.5" />
                    <div>
                        <h4 className="text-sm font-medium text-blue-800 dark:text-blue-300">Configuration Exade</h4>
                        <p className="text-xs text-blue-700 dark:text-blue-400 mt-1">
                            Les configurations sont sauvegardées. La fonction de test n'est pas encore disponible.
                        </p>
                    </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Code Courtier Exade
                            </label>
                            <input
                                type="text"
                                value={config.codeCourtier}
                                onChange={e => setConfig({ ...config, codeCourtier: e.target.value })}
                                className="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm p-2.5 focus:ring-[#335FAD] focus:border-[#335FAD]"
                                placeholder="EX-12345"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Environnement
                            </label>
                            <select
                                value={config.environment}
                                onChange={e => setConfig({ ...config, environment: e.target.value })}
                                className="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm p-2.5 focus:ring-[#335FAD] focus:border-[#335FAD]"
                            >
                                <option value="stage">Recette (Stage)</option>
                                <option value="prod">Production</option>
                            </select>
                        </div>

                        <div className="flex items-center gap-3 pt-2">
                            <input
                                type="checkbox"
                                id="enable-exade"
                                checked={config.isEnabled}
                                onChange={e => setConfig({ ...config, isEnabled: e.target.checked })}
                                className="rounded border-gray-300 text-[#335FAD] focus:ring-[#335FAD]"
                            />
                            <label htmlFor="enable-exade" className="text-sm text-gray-700 dark:text-gray-300">
                                Activer l'intégration
                            </label>
                        </div>
                    </div>

                    <div className="flex flex-col justify-end space-y-3">
                        <button
                            onClick={handleGenerateEmail}
                            className="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 font-medium text-sm flex items-center justify-center gap-2"
                        >
                            <i className="ri-mail-send-line" />
                            Générer email de demande
                        </button>

                        <button
                            onClick={handleTestConnection}
                            disabled={loading}
                            className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 font-medium text-sm flex items-center justify-center gap-2"
                        >
                            {loading ? <i className="ri-loader-4-line animate-spin" /> : <i className="ri-plug-line" />}
                            Tester la connexion
                        </button>
                    </div>
                </div>

                {error && (
                    <div className="p-3 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 rounded-lg text-sm flex gap-2 items-start animate-in fade-in">
                        <i className="ri-error-warning-line mt-0.5" />
                        {error}
                    </div>
                )}

                {success && (
                    <div className="p-3 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-lg text-sm flex gap-2 items-center animate-in fade-in">
                        <i className="ri-checkbox-circle-line" />
                        {success}
                    </div>
                )}

                {testResult === 'success' && (
                    <div className="p-3 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-lg text-sm flex gap-2 items-center animate-in fade-in">
                        <i className="ri-checkbox-circle-line" />
                        Connexion établie avec succès !
                    </div>
                )}
                </>
                )}
            </div>

            <div className="px-6 py-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                <button
                    onClick={handleSave}
                    disabled={loading}
                    className="px-6 py-2.5 bg-[#335FAD] text-white rounded-lg hover:bg-[#2a4e8f] font-medium text-sm flex items-center gap-2 transition-colors disabled:opacity-50"
                >
                    {loading && <i className="ri-loader-4-line animate-spin" />}
                    Enregistrer la configuration
                </button>
            </div>
        </div>
    );
};

================
File: components/features/invites/InviteModal.tsx
================
"use client";

import React, { useState, useEffect } from 'react';
import { api } from '@/services/api';
import { useBrokerContext } from '@/hooks/useBrokerContext';

interface InviteModalProps {
    isOpen: boolean;
    onClose: () => void;
    inviteType?: 'apporteur' | 'broker_user';
}

export const InviteModal = ({ isOpen, onClose, inviteType = 'apporteur' }: InviteModalProps) => {
    const { currentBrokerId } = useBrokerContext();
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [generatedLink, setGeneratedLink] = useState<string | null>(null);
    const [config, setConfig] = useState({
        expiresInHours: 168, // 7 days
        maxUses: 1
    });

    // Reset state on open
    useEffect(() => {
        if (isOpen) {
            setGeneratedLink(null);
            setError(null);
            setLoading(false);
        }
    }, [isOpen]);

    const handleGenerate = async () => {
        if (!currentBrokerId) return;

        setLoading(true);
        setError(null);
        setGeneratedLink(null);

        try {
            const invite = await api.createBrokerInvite({
                brokerId: currentBrokerId,
                type: inviteType,
                expiresInHours: config.expiresInHours,
                maxUses: config.maxUses
            });
            setGeneratedLink(invite.link_url || '');
        } catch (err: any) {
            setError(err.message || "Une erreur est survenue lors de la génération du lien.");
        } finally {
            setLoading(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={onClose} />

            <div className="relative w-full max-w-md bg-white dark:bg-gray-800 rounded-xl shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-200">
                <div className="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                    <h2 className="text-xl font-semibold text-gray-900 dark:text-white">
                        Inviter un {inviteType === 'apporteur' ? 'Apporteur' : 'Collaborateur'}
                    </h2>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i className="ri-close-line text-2xl" />
                    </button>
                </div>

                <div className="p-6 space-y-4">
                    {/* Config Inputs */}
                    <div className="space-y-3">
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Expiration
                        </label>
                        <select
                            className="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 py-2 px-3 text-sm focus:border-[#335FAD] focus:ring-[#335FAD]"
                            value={config.expiresInHours}
                            onChange={e => setConfig({ ...config, expiresInHours: Number(e.target.value) })}
                            disabled={!!generatedLink}
                        >
                            <option value={24}>24 heures</option>
                            <option value={168}>7 jours (Défaut)</option>
                            <option value={720}>30 jours</option>
                        </select>

                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Nombre d'utilisations max
                        </label>
                        <input
                            type="number"
                            min="1"
                            max="100"
                            className="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 py-2 px-3 text-sm focus:border-[#335FAD] focus:ring-[#335FAD]"
                            value={config.maxUses}
                            onChange={e => setConfig({ ...config, maxUses: Number(e.target.value) })}
                            disabled={!!generatedLink}
                        />
                    </div>

                    {/* Feedback Area */}
                    {error && (
                        <div className="p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-lg flex gap-3 text-amber-800 dark:text-amber-200 text-sm">
                            <i className="ri-error-warning-line mt-0.5" />
                            <p>{error}</p>
                        </div>
                    )}

                    {generatedLink && (
                        <div className="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-lg animate-in fade-in slide-in-from-top-2">
                            <p className="text-xs text-green-800 dark:text-green-300 mb-1 font-medium">Lien généré !</p>
                            <div className="flex gap-2">
                                <input
                                    readOnly
                                    value={generatedLink}
                                    className="flex-1 text-xs bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded px-2 text-gray-600"
                                />
                                <button
                                    onClick={() => navigator.clipboard.writeText(generatedLink)}
                                    className="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"
                                >
                                    Copier
                                </button>
                            </div>
                        </div>
                    )}

                </div>

                <div className="p-4 bg-gray-50 dark:bg-gray-800/50 flex justify-end gap-3 text-sm">
                    <button
                        onClick={onClose}
                        className="px-4 py-2 text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white"
                    >
                        Annuler
                    </button>
                    <button
                        onClick={handleGenerate}
                        disabled={loading || !!generatedLink}
                        className="flex items-center gap-2 px-4 py-2 bg-[#335FAD] text-white rounded-lg hover:bg-[#2a4e8f] disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                        {loading && <i className="ri-loader-4-line animate-spin" />}
                        {generatedLink ? 'Généré' : 'Générer le lien'}
                    </button>
                </div>
            </div>
        </div>
    );
};

================
File: components/features/invites/InvitesBanner.tsx
================
"use client";

import React, { useState } from 'react';
import { InviteModal } from './InviteModal';

export const InvitesBanner = () => {
    const [showModal, setShowModal] = useState(false);

    return (
        <>
            <div className="bg-gradient-to-r from-[#335FAD] to-[#1e3a6e] rounded-xl shadow-lg overflow-hidden relative mb-8">
                {/* Decorative elements */}
                <div className="absolute top-0 right-0 p-8 opacity-10">
                    <i className="ri-team-line text-9xl text-white"></i>
                </div>

                <div className="relative z-10 px-8 py-6 sm:px-10 sm:py-8 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6">
                    <div className="max-w-xl text-white">
                        <h2 className="text-2xl font-bold mb-2">Développez votre réseau d'apporteurs</h2>
                        <p className="text-blue-100/90 text-sm sm:text-base leading-relaxed">
                            Invitez facilement de nouveaux apporteurs à rejoindre votre cabinet.
                            Générez des liens d'invitation uniques et suivez leur inscription.
                        </p>
                    </div>

                    <button
                        onClick={() => setShowModal(true)}
                        className="whitespace-nowrap flex items-center gap-2 px-6 py-3 bg-white text-[#335FAD] font-semibold rounded-lg hover:bg-blue-50 transition-colors shadow-sm"
                    >
                        <i className="ri-user-add-line text-lg"></i>
                        Inviter un apporteur
                    </button>
                </div>
            </div>

            <InviteModal
                isOpen={showModal}
                onClose={() => setShowModal(false)}
                inviteType="apporteur"
            />
        </>
    );
};

================
File: components/features/wallet/WalletSummaryCard.tsx
================
"use client";

import React, { useState, useEffect } from 'react';
import { api } from '@/services/api';
import { useBrokerContext } from '@/hooks/useBrokerContext';
import { WalletSummary } from '@/types/model';
import { formatCurrency } from '@/lib/utils/formatters';

export const WalletSummaryCard = () => {
    const { currentBrokerId } = useBrokerContext();
    const [wallet, setWallet] = useState<WalletSummary | null>(null);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (currentBrokerId) {
            loadWallet();
        }
    }, [currentBrokerId]);

    const loadWallet = async () => {
        setLoading(true);
        try {
            const data = await api.getWalletSummary(currentBrokerId!);
            setWallet(data);
        } catch (err) {
            console.error("Failed to load wallet", err);
        } finally {
            setLoading(false);
        }
    };

    if (loading) return (
        <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 animate-pulse">
            <div className="h-6 bg-gray-200 dark:bg-gray-700 rounded w-1/3 mb-4" />
            <div className="flex gap-4">
                <div className="h-16 bg-gray-200 dark:bg-gray-700 rounded w-1/2" />
                <div className="h-16 bg-gray-200 dark:bg-gray-700 rounded w-1/2" />
            </div>
        </div>
    );

    if (!currentBrokerId || !wallet) {
        return (
            <div className="bg-white dark:bg-gray-800 rounded-xl border border-dashed border-gray-300 dark:border-gray-700 p-8 text-center">
                <div className="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i className="ri-wallet-3-line text-gray-400 dark:text-gray-500 text-xl" />
                </div>
                <h3 className="text-sm font-medium text-gray-900 dark:text-white mb-1">
                    {!currentBrokerId ? "Aucun courtier sélectionné" : "Portefeuille non disponible"}
                </h3>
                <p className="text-xs text-gray-500 dark:text-gray-400">
                    {!currentBrokerId ? "Veuillez sélectionner un cabinet." : "Les données financières n'ont pas pu être chargées."}
                </p>
            </div>
        );
    }

    return (
        <div className="bg-gradient-to-br from-[#335FAD] to-[#2a4e8f] rounded-xl text-white p-6 shadow-lg relative overflow-hidden">
            {/* Background Decoration */}
            <div className="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                <i className="ri-wallet-3-line text-9xl" />
            </div>

            <div className="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div>
                    <h3 className="text-blue-100 font-medium text-sm uppercase tracking-wider mb-1">Solde Disponible</h3>
                    <p className="text-3xl font-bold">{formatCurrency(wallet.balance_available)}</p>

                    <div className="flex items-center gap-4 mt-4">
                        <div className="bg-white/10 rounded-lg px-3 py-1.5 backdrop-blur-sm">
                            <span className="text-blue-100 text-xs block">En attente</span>
                            <span className="font-semibold">{formatCurrency(wallet.balance_pending)}</span>
                        </div>
                        <div className="bg-white/10 rounded-lg px-3 py-1.5 backdrop-blur-sm">
                            <span className="text-blue-100 text-xs block">Total Généré</span>
                            <span className="font-semibold">{formatCurrency(wallet.total_earnings)}</span>
                        </div>
                    </div>
                </div>

                <div className="flex flex-col gap-2">
                    <button className="px-4 py-2 bg-white text-[#335FAD] rounded-lg font-medium text-sm hover:bg-blue-50 transition-colors shadow-sm cursor-pointer whitespace-nowrap">
                        <i className="ri-bank-card-line mr-2" />
                        Demander un virement
                    </button>
                    <button className="px-4 py-2 bg-[#335FAD]/50 text-white border border-white/20 rounded-lg font-medium text-sm hover:bg-[#335FAD]/70 transition-colors cursor-pointer whitespace-nowrap">
                        <i className="ri-history-line mr-2" />
                        Historique
                    </button>
                </div>
            </div>
        </div>
    );
};

================
File: components/ui/badge.tsx
================
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }

================
File: components/ui/button.tsx
================
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",
        outline:
          "border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2",
        sm: "h-8 rounded-md px-3 text-xs",
        lg: "h-10 rounded-md px-8",
        icon: "h-9 w-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }

================
File: components/ui/calendar.tsx
================
"use client"

import * as React from "react"
import {
  ChevronDownIcon,
  ChevronLeftIcon,
  ChevronRightIcon,
} from "lucide-react"
import { DayButton, DayPicker, getDefaultClassNames } from "react-day-picker"

import { cn } from "@/lib/utils"
import { Button, buttonVariants } from "@/components/ui/button"

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  captionLayout = "label",
  buttonVariant = "ghost",
  formatters,
  components,
  ...props
}: React.ComponentProps<typeof DayPicker> & {
  buttonVariant?: React.ComponentProps<typeof Button>["variant"]
}) {
  const defaultClassNames = getDefaultClassNames()

  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn(
        "bg-background group/calendar p-3 [--cell-size:2rem] [[data-slot=card-content]_&]:bg-transparent [[data-slot=popover-content]_&]:bg-transparent",
        String.raw`rtl:**:[.rdp-button\_next>svg]:rotate-180`,
        String.raw`rtl:**:[.rdp-button\_previous>svg]:rotate-180`,
        className
      )}
      captionLayout={captionLayout}
      formatters={{
        formatMonthDropdown: (date) =>
          date.toLocaleString("default", { month: "short" }),
        ...formatters,
      }}
      classNames={{
        root: cn("w-fit", defaultClassNames.root),
        months: cn(
          "relative flex flex-col gap-4 md:flex-row",
          defaultClassNames.months
        ),
        month: cn("flex w-full flex-col gap-4", defaultClassNames.month),
        nav: cn(
          "absolute inset-x-0 top-0 flex w-full items-center justify-between gap-1",
          defaultClassNames.nav
        ),
        button_previous: cn(
          buttonVariants({ variant: buttonVariant }),
          "h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50",
          defaultClassNames.button_previous
        ),
        button_next: cn(
          buttonVariants({ variant: buttonVariant }),
          "h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50",
          defaultClassNames.button_next
        ),
        month_caption: cn(
          "flex h-[--cell-size] w-full items-center justify-center px-[--cell-size]",
          defaultClassNames.month_caption
        ),
        dropdowns: cn(
          "flex h-[--cell-size] w-full items-center justify-center gap-1.5 text-sm font-medium",
          defaultClassNames.dropdowns
        ),
        dropdown_root: cn(
          "has-focus:border-ring border-input shadow-xs has-focus:ring-ring/50 has-focus:ring-[3px] relative rounded-md border",
          defaultClassNames.dropdown_root
        ),
        dropdown: cn(
          "bg-popover absolute inset-0 opacity-0",
          defaultClassNames.dropdown
        ),
        caption_label: cn(
          "select-none font-medium",
          captionLayout === "label"
            ? "text-sm"
            : "[&>svg]:text-muted-foreground flex h-8 items-center gap-1 rounded-md pl-2 pr-1 text-sm [&>svg]:size-3.5",
          defaultClassNames.caption_label
        ),
        table: "w-full border-collapse",
        weekdays: cn("flex", defaultClassNames.weekdays),
        weekday: cn(
          "text-muted-foreground flex-1 select-none rounded-md text-[0.8rem] font-normal",
          defaultClassNames.weekday
        ),
        week: cn("mt-2 flex w-full", defaultClassNames.week),
        week_number_header: cn(
          "w-[--cell-size] select-none",
          defaultClassNames.week_number_header
        ),
        week_number: cn(
          "text-muted-foreground select-none text-[0.8rem]",
          defaultClassNames.week_number
        ),
        day: cn(
          "group/day relative aspect-square h-full w-full select-none p-0 text-center [&:first-child[data-selected=true]_button]:rounded-l-md [&:last-child[data-selected=true]_button]:rounded-r-md",
          defaultClassNames.day
        ),
        range_start: cn(
          "bg-accent rounded-l-md",
          defaultClassNames.range_start
        ),
        range_middle: cn("rounded-none", defaultClassNames.range_middle),
        range_end: cn("bg-accent rounded-r-md", defaultClassNames.range_end),
        today: cn(
          "bg-accent text-accent-foreground rounded-md data-[selected=true]:rounded-none",
          defaultClassNames.today
        ),
        outside: cn(
          "text-muted-foreground aria-selected:text-muted-foreground",
          defaultClassNames.outside
        ),
        disabled: cn(
          "text-muted-foreground opacity-50",
          defaultClassNames.disabled
        ),
        hidden: cn("invisible", defaultClassNames.hidden),
        ...classNames,
      }}
      components={{
        Root: ({ className, rootRef, ...props }) => {
          return (
            <div
              data-slot="calendar"
              ref={rootRef}
              className={cn(className)}
              {...props}
            />
          )
        },
        Chevron: ({ className, orientation, ...props }) => {
          if (orientation === "left") {
            return (
              <ChevronLeftIcon className={cn("size-4", className)} {...props} />
            )
          }

          if (orientation === "right") {
            return (
              <ChevronRightIcon
                className={cn("size-4", className)}
                {...props}
              />
            )
          }

          return (
            <ChevronDownIcon className={cn("size-4", className)} {...props} />
          )
        },
        DayButton: CalendarDayButton,
        WeekNumber: ({ children, ...props }) => {
          return (
            <td {...props}>
              <div className="flex size-[--cell-size] items-center justify-center text-center">
                {children}
              </div>
            </td>
          )
        },
        ...components,
      }}
      {...props}
    />
  )
}

function CalendarDayButton({
  className,
  day,
  modifiers,
  ...props
}: React.ComponentProps<typeof DayButton>) {
  const defaultClassNames = getDefaultClassNames()

  const ref = React.useRef<HTMLButtonElement>(null)
  React.useEffect(() => {
    if (modifiers.focused) ref.current?.focus()
  }, [modifiers.focused])

  return (
    <Button
      ref={ref}
      variant="ghost"
      size="icon"
      data-day={day.date.toLocaleDateString()}
      data-selected-single={
        modifiers.selected &&
        !modifiers.range_start &&
        !modifiers.range_end &&
        !modifiers.range_middle
      }
      data-range-start={modifiers.range_start}
      data-range-end={modifiers.range_end}
      data-range-middle={modifiers.range_middle}
      className={cn(
        "data-[selected-single=true]:bg-primary data-[selected-single=true]:text-primary-foreground data-[range-middle=true]:bg-accent data-[range-middle=true]:text-accent-foreground data-[range-start=true]:bg-primary data-[range-start=true]:text-primary-foreground data-[range-end=true]:bg-primary data-[range-end=true]:text-primary-foreground group-data-[focused=true]/day:border-ring group-data-[focused=true]/day:ring-ring/50 flex aspect-square h-auto w-full min-w-[--cell-size] flex-col gap-1 font-normal leading-none data-[range-end=true]:rounded-md data-[range-middle=true]:rounded-none data-[range-start=true]:rounded-md group-data-[focused=true]/day:relative group-data-[focused=true]/day:z-10 group-data-[focused=true]/day:ring-[3px] [&>span]:text-xs [&>span]:opacity-70",
        defaultClassNames.day,
        className
      )}
      {...props}
    />
  )
}

export { Calendar, CalendarDayButton }

================
File: components/ui/card.tsx
================
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-xl border bg-card text-card-foreground shadow",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("font-semibold leading-none tracking-tight", className)}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }

================
File: components/ui/date-picker.tsx
================
"use client"

import * as React from "react"
import { format } from "date-fns"
import { fr } from "date-fns/locale"
import { CalendarIcon } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Calendar } from "@/components/ui/calendar"
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover"

interface DatePickerProps {
  value?: string
  onChange: (value: string) => void
  placeholder?: string
  className?: string
  disabled?: boolean
  fromYear?: number
  toYear?: number
}

export function DatePicker({
  value,
  onChange,
  placeholder = "Sélectionner une date",
  className,
  disabled = false,
  fromYear = 1900,
  toYear = new Date().getFullYear()
}: DatePickerProps) {
  const [date, setDate] = React.useState<Date | undefined>(
    value ? new Date(value) : undefined
  )

  React.useEffect(() => {
    if (value) {
      setDate(new Date(value))
    } else {
      setDate(undefined)
    }
  }, [value])

  const handleSelect = (selectedDate: Date | undefined) => {
    setDate(selectedDate)
    if (selectedDate) {
      // Format as YYYY-MM-DD for input compatibility
      const formattedDate = format(selectedDate, "yyyy-MM-dd")
      onChange(formattedDate)
    } else {
      onChange("")
    }
  }

  return (
    <Popover>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          className={cn(
            "w-full justify-start text-left font-normal",
            !date && "text-muted-foreground",
            className
          )}
          disabled={disabled}
        >
          <CalendarIcon className="mr-2 h-4 w-4" />
          {date ? format(date, "PPP", { locale: fr }) : <span>{placeholder}</span>}
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-auto p-0" align="start">
        <Calendar
          mode="single"
          selected={date}
          onSelect={handleSelect}
          captionLayout="dropdown"
          fromYear={fromYear}
          toYear={toYear}
          initialFocus
          locale={fr}
        />
      </PopoverContent>
    </Popover>
  )
}

================
File: components/ui/dropdown-menu.tsx
================
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md",
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}

================
File: components/ui/empty-state.tsx
================
'use client';

import Link from 'next/link';

interface EmptyStateProps {
  icon: string;
  title: string;
  description: string;
  action?: {
    label: string;
    href?: string;
    onClick?: () => void;
  };
  secondaryAction?: {
    label: string;
    href?: string;
    onClick?: () => void;
  };
  variant?: 'default' | 'compact' | 'card';
}

export function EmptyState({
  icon,
  title,
  description,
  action,
  secondaryAction,
  variant = 'default'
}: EmptyStateProps) {
  const isCompact = variant === 'compact';
  const isCard = variant === 'card';

  const content = (
    <div className={`flex flex-col items-center justify-center text-center ${
      isCompact ? 'py-8' : isCard ? 'py-12' : 'py-16'
    }`}>
      {/* Icône avec fond décoratif */}
      <div className={`relative ${isCompact ? 'mb-4' : 'mb-6'}`}>
        <div className={`${
          isCompact ? 'w-16 h-16' : 'w-20 h-20'
        } bg-gradient-to-br from-gray-100 to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-2xl flex items-center justify-center shadow-sm`}>
          <i className={`${icon} ${isCompact ? 'text-2xl' : 'text-3xl'} text-gray-400 dark:text-gray-500`}></i>
        </div>
        {/* Décoration subtile */}
        <div className="absolute -top-1 -right-1 w-3 h-3 bg-[#335FAD]/20 rounded-full"></div>
        <div className="absolute -bottom-1 -left-1 w-2 h-2 bg-[#335FAD]/10 rounded-full"></div>
      </div>

      {/* Titre */}
      <h3 className={`${
        isCompact ? 'text-base' : 'text-lg'
      } font-medium text-gray-900 dark:text-white mb-2`}>
        {title}
      </h3>

      {/* Description */}
      <p className={`${
        isCompact ? 'text-sm max-w-xs' : 'text-base max-w-md'
      } text-gray-500 dark:text-gray-400 mb-6`}>
        {description}
      </p>

      {/* Actions */}
      {(action || secondaryAction) && (
        <div className="flex flex-col sm:flex-row items-center gap-3">
          {action && (
            action.href ? (
              <Link
                href={action.href}
                className={`${
                  isCompact ? 'px-4 py-2 text-sm' : 'px-6 py-3 text-base'
                } bg-[#335FAD] hover:bg-[#335FAD]/90 text-white font-medium rounded-xl transition-all duration-200 hover:shadow-lg flex items-center gap-2`}
              >
                <i className="ri-add-line"></i>
                {action.label}
              </Link>
            ) : (
              <button
                onClick={action.onClick}
                className={`${
                  isCompact ? 'px-4 py-2 text-sm' : 'px-6 py-3 text-base'
                } bg-[#335FAD] hover:bg-[#335FAD]/90 text-white font-medium rounded-xl transition-all duration-200 hover:shadow-lg flex items-center gap-2`}
              >
                <i className="ri-add-line"></i>
                {action.label}
              </button>
            )
          )}
          {secondaryAction && (
            secondaryAction.href ? (
              <Link
                href={secondaryAction.href}
                className={`${
                  isCompact ? 'px-4 py-2 text-sm' : 'px-5 py-2.5 text-sm'
                } text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white font-medium transition-colors`}
              >
                {secondaryAction.label}
              </Link>
            ) : (
              <button
                onClick={secondaryAction.onClick}
                className={`${
                  isCompact ? 'px-4 py-2 text-sm' : 'px-5 py-2.5 text-sm'
                } text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white font-medium transition-colors`}
              >
                {secondaryAction.label}
              </button>
            )
          )}
        </div>
      )}
    </div>
  );

  if (isCard) {
    return (
      <div className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm">
        {content}
      </div>
    );
  }

  return content;
}

// Variantes prédéfinies pour les cas courants
export function EmptyDossiers({ onCreateNew }: { onCreateNew?: () => void }) {
  return (
    <EmptyState
      icon="ri-folder-open-line"
      title="Aucun dossier"
      description="Vous n'avez pas encore de dossier. Créez votre premier dossier pour commencer."
      action={onCreateNew ? {
        label: "Nouveau dossier",
        onClick: onCreateNew
      } : {
        label: "Nouveau dossier",
        href: "/nouveau-dossier"
      }}
    />
  );
}

export function EmptyDossiersFiltered() {
  return (
    <EmptyState
      icon="ri-search-line"
      title="Aucun résultat"
      description="Aucun dossier ne correspond à vos critères de recherche. Essayez de modifier vos filtres."
      variant="compact"
    />
  );
}

export function EmptyActivities() {
  return (
    <EmptyState
      icon="ri-time-line"
      title="Aucune activité récente"
      description="Il n'y a pas encore d'activité à afficher. Les nouvelles actions apparaîtront ici."
      variant="compact"
    />
  );
}

export function EmptyNotifications() {
  return (
    <EmptyState
      icon="ri-notification-off-line"
      title="Pas de notification"
      description="Vous êtes à jour ! Aucune nouvelle notification pour le moment."
      variant="compact"
    />
  );
}

export function EmptyApporteurs({ onInvite }: { onInvite?: () => void }) {
  return (
    <EmptyState
      icon="ri-user-add-line"
      title="Aucun apporteur"
      description="Vous n'avez pas encore d'apporteur dans votre équipe. Invitez-en un pour commencer à collaborer."
      action={onInvite ? {
        label: "Inviter un apporteur",
        onClick: onInvite
      } : undefined}
    />
  );
}

export function EmptyDevis() {
  return (
    <EmptyState
      icon="ri-file-text-line"
      title="Aucun devis disponible"
      description="Les devis seront générés automatiquement une fois les informations complètes."
      variant="compact"
    />
  );
}

export function EmptyDocuments({ onUpload }: { onUpload?: () => void }) {
  return (
    <EmptyState
      icon="ri-upload-cloud-line"
      title="Aucun document"
      description="Ajoutez vos documents pour compléter le dossier."
      action={onUpload ? {
        label: "Ajouter un document",
        onClick: onUpload
      } : undefined}
      variant="compact"
    />
  );
}

================
File: components/ui/popover.tsx
================
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverAnchor = PopoverPrimitive.Anchor

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }

================
File: components/ui/select.tsx
================
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute right-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>
    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}

================
File: db.md
================
# Documentation Complète de la Base de Données

## Vue d'ensemble

Cette base de données Supabase contient plusieurs schémas organisant les données
de l'application GMB Apporteur.

**Architecture multi-courtiers** : La base de données a été conçue pour
supporter plusieurs courtiers/cabinets, avec un système de wallet/commissions et
la possibilité d'ajouter différents types de produits d'assurance au-delà de
l'assurance emprunteur.

---

## Extensions Installées

Les extensions PostgreSQL suivantes sont installées :

- **uuid-ossp** (v1.1) - Génération d'identifiants UUID
- **pgcrypto** (v1.3) - Fonctions cryptographiques
- **pg_stat_statements** (v1.11) - Statistiques d'exécution SQL
- **pg_graphql** (v1.5.11) - Support GraphQL
- **supabase_vault** (v0.3.1) - Extension Vault Supabase
- **unaccent** (v1.1) - Recherche de texte sans accents
- **plpgsql** (v1.0) - Langage procédural PL/pgSQL

---

## Schémas et Tables

### Schéma `public`

Tables métier de l'application.

#### Table `brokers`

Courtiers/cabinets - entités business propriétaires des dossiers.

**Colonnes :**

| Nom                           | Type                     | Nullable | Défaut              | Description                                                           |
| ----------------------------- | ------------------------ | -------- | ------------------- | --------------------------------------------------------------------- |
| `id`                          | uuid                     | Non      | `gen_random_uuid()` | Identifiant unique                                                    |
| `name`                        | text                     | Non      | -                   | Nom du courtier/cabinet                                               |
| `status`                      | broker_status            | Non      | `'actif'`           | Statut : `actif`, `suspendu`, `inactif`                               |
| `exade_default_environment`   | exade_environment        | Non      | `'prod'`            | Environnement Exade par défaut                                        |
| `onboarding_status`           | broker_onboarding_status | Non      | `'created'`         | **NOUVEAU** - Statut onboarding : `created`, `exade_pending`, `ready` |
| `onboarding_completed_at`     | timestamptz              | Oui      | -                   | **NOUVEAU** - Date de complétion onboarding                           |
| `exade_request_email_sent_at` | timestamptz              | Oui      | -                   | **NOUVEAU** - Date d'envoi email Exade                                |
| `billing_email`               | text                     | Oui      | -                   | Email de facturation                                                  |
| `billing_address`             | text                     | Oui      | -                   | Adresse de facturation                                                |
| `created_at`                  | timestamptz              | Non      | `now()`             | Date de création                                                      |
| `updated_at`                  | timestamptz              | Non      | `now()`             | Date de mise à jour                                                   |

**Contraintes :**

- **PRIMARY KEY** : `id`

**Index :**

- `brokers_pkey` (PRIMARY KEY sur `id`)
- `idx_brokers_status` (sur `status`)
- `idx_brokers_onboarding_status` (sur `onboarding_status`)

**RLS :** Activé

---

#### Table `broker_users`

Liaison entre utilisateurs Supabase et brokers avec rôle.

**Colonnes :**

| Nom          | Type             | Nullable | Défaut              | Description                       |
| ------------ | ---------------- | -------- | ------------------- | --------------------------------- |
| `id`         | uuid             | Non      | `gen_random_uuid()` | Identifiant unique                |
| `broker_id`  | uuid             | Non      | -                   | Référence vers `brokers.id`       |
| `user_id`    | uuid             | Non      | -                   | Référence vers `auth.users.id`    |
| `role`       | broker_user_role | Non      | `'member'`          | Rôle : `owner`, `admin`, `member` |
| `created_at` | timestamptz      | Non      | `now()`             | Date de création                  |
| `updated_at` | timestamptz      | Non      | `now()`             | Date de mise à jour               |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **UNIQUE** : `broker_id, user_id`
- **FOREIGN KEY** :
  - `broker_id` → `brokers.id` (ON DELETE CASCADE)
  - `user_id` → `auth.users.id` (ON DELETE CASCADE)

**Index :**

- `broker_users_pkey` (PRIMARY KEY sur `id`)
- `idx_broker_users_broker_id` (sur `broker_id`)
- `idx_broker_users_user_id` (sur `user_id`)

**RLS :** Activé

---

#### Table `broker_apporteurs`

Liaison entre apporteurs et brokers (un apporteur peut être lié à plusieurs
brokers).

**Colonnes :**

| Nom                          | Type                    | Nullable | Défaut              | Description                                             |
| ---------------------------- | ----------------------- | -------- | ------------------- | ------------------------------------------------------- |
| `id`                         | uuid                    | Non      | `gen_random_uuid()` | Identifiant unique                                      |
| `broker_id`                  | uuid                    | Non      | -                   | Référence vers `brokers.id`                             |
| `apporteur_profile_id`       | uuid                    | Non      | -                   | Référence vers `apporteur_profiles.id`                  |
| `status`                     | broker_apporteur_status | Non      | `'actif'`           | Statut : `actif`, `inactif`, `suspendu`                 |
| `default_commission_rule_id` | uuid                    | Oui      | -                   | Référence vers `commission_rules.id` (règle par défaut) |
| `created_at`                 | timestamptz             | Non      | `now()`             | Date de création                                        |
| `updated_at`                 | timestamptz             | Non      | `now()`             | Date de mise à jour                                     |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **UNIQUE** : `broker_id, apporteur_profile_id`
- **FOREIGN KEY** :
  - `broker_id` → `brokers.id` (ON DELETE CASCADE)
  - `apporteur_profile_id` → `apporteur_profiles.id` (ON DELETE CASCADE)
  - `default_commission_rule_id` → `commission_rules.id` (ON DELETE SET NULL)

**Index :**

- `broker_apporteurs_pkey` (PRIMARY KEY sur `id`)
- `idx_broker_apporteurs_broker_id` (sur `broker_id`)
- `idx_broker_apporteurs_apporteur_id` (sur `apporteur_profile_id`)

**RLS :** Activé

---

#### Table `broker_invites`

Système d'invitations pour apporteurs et broker_users. Permet aux courtiers de
créer des liens d'invitation sécurisés avec expiration et limitation d'usage.

**Colonnes :**

| Nom                  | Type               | Nullable | Défaut              | Description                                                       |
| -------------------- | ------------------ | -------- | ------------------- | ----------------------------------------------------------------- |
| `id`                 | uuid               | Non      | `gen_random_uuid()` | Identifiant unique                                                |
| `broker_id`          | uuid               | Non      | -                   | Référence vers `brokers.id`                                       |
| `created_by_user_id` | uuid               | Non      | -                   | Référence vers `auth.users.id` (courtier qui génère l'invitation) |
| `invite_type`        | broker_invite_type | Non      | `'apporteur'`       | Type : `apporteur`, `broker_user`                                 |
| `token`              | text               | Non      | -                   | Token unique (64 caractères, base64)                              |
| `expires_at`         | timestamptz        | Non      | -                   | Date d'expiration de l'invitation                                 |
| `max_uses`           | int                | Non      | `1`                 | Nombre maximum d'utilisations                                     |
| `uses`               | int                | Non      | `0`                 | Nombre d'utilisations actuelles                                   |
| `revoked_at`         | timestamptz        | Oui      | -                   | Date de révocation (si révoquée)                                  |
| `created_at`         | timestamptz        | Non      | `now()`             | Date de création                                                  |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **UNIQUE** : `token`
- **FOREIGN KEY** :
  - `broker_id` → `brokers.id` (ON DELETE CASCADE)
  - `created_by_user_id` → `auth.users.id` (ON DELETE CASCADE)
- **CHECK** :
  - `max_uses > 0`
  - `uses >= 0`
  - `uses <= max_uses`

**Index :**

- `broker_invites_pkey` (PRIMARY KEY sur `id`)
- `idx_broker_invites_broker_id` (sur `broker_id`)
- `idx_broker_invites_token` (sur `token`)
- `idx_broker_invites_created_by` (sur `created_by_user_id`)
- `idx_broker_invites_expires_at` (sur `expires_at` WHERE `revoked_at IS NULL`)

**RLS :** Activé

**Policies RLS :**

- **ALL** : `Broker owners and admins can manage invites`
  - Seuls les owner/admin du broker peuvent créer/voir/modifier les invitations
  - Les apporteurs ne peuvent PAS lister les invitations (ils n'en ont pas
    besoin)

---

#### Table `broker_exade_configs`

Configuration Exade par broker. Les secrets (licence WS, password, token) sont
stockés dans Supabase Vault, référencés via `vault_secret_name` ou
`vault_secret_id`.

**Colonnes :**

| Nom                   | Type              | Nullable | Défaut              | Description                                                     |
| --------------------- | ----------------- | -------- | ------------------- | --------------------------------------------------------------- |
| `id`                  | uuid              | Non      | `gen_random_uuid()` | Identifiant unique                                              |
| `broker_id`           | uuid              | Non      | -                   | Référence vers `brokers.id`                                     |
| `environment`         | exade_environment | Non      | `'prod'`            | Environnement : `stage`, `prod`                                 |
| `endpoint_url`        | text              | Oui      | -                   | URL de l'endpoint Exade                                         |
| `code_courtier`       | text              | Non      | -                   | Code courtier Exade                                             |
| `point_de_vente_code` | text              | Oui      | -                   | Code point de vente (si nécessaire)                             |
| `is_enabled`          | boolean           | Non      | `true`              | Indique si la config est active                                 |
| `vault_secret_name`   | text              | Oui      | -                   | Nom du secret dans Supabase Vault                               |
| `vault_secret_id`     | uuid              | Oui      | -                   | ID du secret dans `vault.secrets`                               |
| `configured_at`       | timestamptz       | Oui      | -                   | **NOUVEAU** - Date de configuration Exade                       |
| `last_tested_at`      | timestamptz       | Oui      | -                   | **NOUVEAU** - Date du dernier test Exade                        |
| `last_test_status`    | text              | Oui      | -                   | **NOUVEAU** - Statut du dernier test (`success`, `error`, etc.) |
| `created_at`          | timestamptz       | Non      | `now()`             | Date de création                                                |
| `updated_at`          | timestamptz       | Non      | `now()`             | Date de mise à jour                                             |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **UNIQUE** : `broker_id, environment`
- **FOREIGN KEY** : `broker_id` → `brokers.id` (ON DELETE CASCADE)

**Index :**

- `broker_exade_configs_pkey` (PRIMARY KEY sur `id`)
- `idx_broker_exade_configs_broker_id` (sur `broker_id`)
- `idx_broker_exade_configs_enabled` (sur `is_enabled` WHERE
  `is_enabled = true`)

**RLS :** Activé

---

#### Table `insurance_products`

Produits d'assurance supportés (emprunteur, auto, santé, etc.).

**Colonnes :**

| Nom          | Type        | Nullable | Défaut              | Description                                                                    |
| ------------ | ----------- | -------- | ------------------- | ------------------------------------------------------------------------------ |
| `id`         | uuid        | Non      | `gen_random_uuid()` | Identifiant unique                                                             |
| `code`       | text        | Non      | -                   | Code unique du produit (ex: `loan_insurance`, `auto`, `home`, `health`, `pro`) |
| `label`      | text        | Non      | -                   | Libellé du produit                                                             |
| `is_enabled` | boolean     | Non      | `true`              | Indique si le produit est activé                                               |
| `created_at` | timestamptz | Non      | `now()`             | Date de création                                                               |
| `updated_at` | timestamptz | Non      | `now()`             | Date de mise à jour                                                            |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **UNIQUE** : `code`

**Index :**

- `insurance_products_pkey` (PRIMARY KEY sur `id`)
- `idx_insurance_products_code` (sur `code`)
- `idx_insurance_products_enabled` (sur `is_enabled` WHERE `is_enabled = true`)

**RLS :** Activé

**Produits initiaux :**

- `loan_insurance` - Assurance Emprunteur (activé)
- `auto` - Assurance Auto (désactivé)
- `home` - Assurance Habitation (désactivé)
- `health` - Assurance Santé (désactivé)
- `pro` - Assurance Professionnelle (désactivé)

---

#### Table `apporteur_profiles`

Profil des apporteurs d'affaires.

**Colonnes :**

| Nom               | Type             | Nullable | Défaut              | Description                             |
| ----------------- | ---------------- | -------- | ------------------- | --------------------------------------- |
| `id`              | uuid             | Non      | `gen_random_uuid()` | Identifiant unique                      |
| `user_id`         | uuid             | Oui      | -                   | Référence vers `auth.users.id` (UNIQUE) |
| `nom`             | varchar          | Non      | -                   | Nom de l'apporteur                      |
| `prenom`          | varchar          | Non      | -                   | Prénom de l'apporteur                   |
| `email`           | varchar          | Non      | -                   | Email de l'apporteur                    |
| `telephone`       | varchar          | Oui      | -                   | Téléphone de l'apporteur                |
| `cgu_accepted_at` | timestamptz      | Oui      | -                   | Date d'acceptation des CGU              |
| `statut`          | apporteur_statut | Non      | `'actif'`           | Statut de l'apporteur (enum)            |
| `last_login_at`   | timestamptz      | Oui      | -                   | Date de dernière connexion              |
| `created_at`      | timestamptz      | Oui      | `now()`             | Date de création                        |
| `updated_at`      | timestamptz      | Oui      | `now()`             | Date de mise à jour                     |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **UNIQUE** : `user_id`
- **FOREIGN KEY** : `user_id` → `auth.users.id` (ON DELETE CASCADE)

**Index :**

- `apporteur_profiles_pkey` (PRIMARY KEY sur `id`)
- `apporteur_profiles_user_id_key` (UNIQUE sur `user_id`)
- `idx_apporteur_profiles_email` (sur `email`)
- `idx_apporteur_profiles_last_login_at` (sur `last_login_at DESC`)

**RLS :** Activé

---

#### Table `dossiers`

Dossiers de prêts gérés par l'application.

**Colonnes :**

| Nom                     | Type           | Nullable | Défaut              | Description                                                                                                  |
| ----------------------- | -------------- | -------- | ------------------- | ------------------------------------------------------------------------------------------------------------ |
| `id`                    | uuid           | Non      | `gen_random_uuid()` | Identifiant unique                                                                                           |
| `numero_dossier`        | varchar        | Non      | -                   | Numéro unique du dossier (UNIQUE)                                                                            |
| `broker_id`             | uuid           | Non      | -                   | **NOUVEAU** - Référence vers `brokers.id` (pivot principal multi-courtiers)                                  |
| `apporteur_id`          | uuid           | Oui      | -                   | Référence vers `apporteur_profiles.id`                                                                       |
| `admin_id`              | uuid           | Oui      | -                   | Référence vers `auth.users.id` (admin assigné)                                                               |
| `insurance_product_id`  | uuid           | Non      | -                   | **NOUVEAU** - Référence vers `insurance_products.id` (remplace progressivement type_dossier)                 |
| `type_dossier`          | varchar        | Non      | -                   | Type : `pret_immobilier`, `rachat_credit`, `pret_travaux`, `pret_consommation` (maintenu pour compatibilité) |
| `statut`                | varchar        | Oui      | `'en_attente'`      | **LEGACY** - Statut avec accents (utiliser `statut_canon` en logique métier)                                 |
| `statut_canon`          | dossier_statut | Non      | `'en_attente'`      | Statut canonique (enum) - **À utiliser en logique métier**                                                   |
| `montant_capital`       | numeric        | Oui      | -                   | Montant du capital                                                                                           |
| `economie_generee`      | numeric        | Oui      | `0`                 | Économie générée                                                                                             |
| `is_read`               | boolean        | Oui      | `false`             | Indique si le dossier a été lu                                                                               |
| `is_couple`             | boolean        | Oui      | `false`             | Indique si le dossier concerne un couple                                                                     |
| `commentaire`           | text           | Oui      | -                   | Commentaire général                                                                                          |
| `notes_interne`         | text           | Oui      | -                   | Notes internes                                                                                               |
| `devis_selectionne_id`  | uuid           | Oui      | -                   | Référence vers `devis.id` (devis sélectionné)                                                                |
| `commentaire_refus`     | text           | Oui      | -                   | Commentaire en cas de refus                                                                                  |
| `date_finalisation`     | timestamptz    | Oui      | -                   | Date de finalisation du dossier                                                                              |
| `extracted_client_data` | jsonb          | Oui      | -                   | Données client extraites par l'IA                                                                            |
| `comparison_modal_seen` | boolean        | Oui      | `false`             | Si l'admin a vu la modale de comparaison                                                                     |
| `last_extraction_at`    | timestamptz    | Oui      | -                   | Date de dernière extraction automatique                                                                      |
| `date_creation`         | timestamptz    | Oui      | `now()`             | Date de création                                                                                             |
| `created_at`            | timestamptz    | Oui      | `now()`             | Date de création                                                                                             |
| `updated_at`            | timestamptz    | Oui      | `now()`             | Date de mise à jour                                                                                          |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **UNIQUE** : `numero_dossier`
- **FOREIGN KEY** :
  - `broker_id` → `brokers.id` (ON DELETE RESTRICT)
  - `insurance_product_id` → `insurance_products.id` (ON DELETE RESTRICT)
  - `apporteur_id` → `apporteur_profiles.id` (ON DELETE SET NULL)
  - `admin_id` → `auth.users.id` (ON DELETE SET NULL)
  - `devis_selectionne_id` → `devis.id` (ON DELETE SET NULL)
- **CHECK** :
  - `statut` doit être dans
    `['en_attente', 'devis_envoye', 'devis_accepte', 'finalisé', 'refusé']`
  - `type_dossier` doit être dans
    `['pret_immobilier', 'rachat_credit', 'pret_travaux', 'pret_consommation']`

**Index :**

- `dossiers_pkey` (PRIMARY KEY sur `id`)
- `dossiers_numero_dossier_key` (UNIQUE sur `numero_dossier`)
- `idx_dossiers_broker_id` (sur `broker_id`)
- `idx_dossiers_insurance_product_id` (sur `insurance_product_id`)
- `idx_dossiers_broker_statut_date` (sur
  `broker_id, statut_canon, date_creation`) - **NOUVEAU** - Index composite pour
  requêtes multi-courtiers
- `idx_dossiers_apporteur_id` (sur `apporteur_id`)
- `idx_dossiers_admin_id` (sur `admin_id`)
- `idx_dossiers_statut` (sur `statut`)
- `idx_dossiers_statut_canon` (sur `statut_canon`)
- `idx_dossiers_type` (sur `type_dossier`)
- `idx_dossiers_numero_dossier` (sur `numero_dossier`)
- `idx_dossiers_date_creation` (sur `date_creation`)
- `idx_dossiers_devis_selectionne_id` (sur `devis_selectionne_id`)
- `idx_dossiers_is_read` (sur `is_read`)
- `idx_dossiers_apporteur_statut` (sur `apporteur_id, statut_canon`)

**RLS :** Activé

---

#### Table `client_infos`

Informations sur les clients (emprunteurs).

**Colonnes :**

| Nom                                  | Type        | Nullable | Défaut              | Description                                  |
| ------------------------------------ | ----------- | -------- | ------------------- | -------------------------------------------- |
| `id`                                 | uuid        | Non      | `gen_random_uuid()` | Identifiant unique                           |
| `dossier_id`                         | uuid        | Oui      | -                   | Référence vers `dossiers.id`                 |
| `client_civilite`                    | varchar     | Oui      | -                   | Civilité : M, Mme, Mlle                      |
| `client_nom`                         | varchar     | Non      | -                   | Nom de l'emprunteur                          |
| `client_prenom`                      | varchar     | Non      | -                   | Prénom de l'emprunteur                       |
| `client_nom_naissance`               | varchar     | Oui      | -                   | Nom de jeune fille                           |
| `client_email`                       | varchar     | Non      | -                   | Email de l'emprunteur                        |
| `client_telephone`                   | varchar     | Oui      | -                   | Téléphone de l'emprunteur                    |
| `client_date_naissance`              | date        | Non      | -                   | Date de naissance                            |
| `client_adresse`                     | text        | Oui      | -                   | Adresse                                      |
| `client_profession`                  | varchar     | Oui      | -                   | Profession                                   |
| `client_fumeur`                      | boolean     | Oui      | `false`             | Indique si le client fume                    |
| `categorie_professionnelle`          | integer     | Oui      | -                   | Code catégorie Exade (1-11)                  |
| `conjoint_nom`                       | varchar     | Oui      | -                   | Nom du conjoint                              |
| `conjoint_prenom`                    | varchar     | Oui      | -                   | Prénom du conjoint                           |
| `conjoint_civilite`                  | varchar     | Oui      | -                   | Civilité du conjoint                         |
| `conjoint_nom_naissance`             | varchar     | Oui      | -                   | Nom de jeune fille du conjoint               |
| `conjoint_email`                     | varchar     | Oui      | -                   | Email du conjoint                            |
| `conjoint_telephone`                 | varchar     | Oui      | -                   | Téléphone du conjoint                        |
| `conjoint_date_naissance`            | date        | Oui      | -                   | Date de naissance du conjoint                |
| `conjoint_profession`                | varchar     | Oui      | -                   | Profession du conjoint                       |
| `conjoint_fumeur`                    | boolean     | Oui      | `false`             | Indique si le conjoint fume                  |
| `conjoint_categorie_professionnelle` | integer     | Oui      | -                   | Code catégorie Exade pour le conjoint (1-11) |
| `created_at`                         | timestamptz | Oui      | `now()`             | Date de création                             |
| `updated_at`                         | timestamptz | Oui      | `now()`             | Date de mise à jour                          |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **FOREIGN KEY** : `dossier_id` → `dossiers.id` (ON DELETE CASCADE)
- **CHECK** :
  - `categorie_professionnelle` doit être NULL ou entre 1 et 11
  - `conjoint_categorie_professionnelle` doit être NULL ou entre 1 et 11

**Index :**

- `client_infos_pkey` (PRIMARY KEY sur `id`)
- `idx_client_infos_dossier_id` (sur `dossier_id`)
- `idx_client_infos_client_email` (sur `client_email`)
- `idx_client_infos_email` (sur `client_email`)

**RLS :** Activé

**Codes catégories professionnelles Exade :**

1. Salarié cadre
2. Salarié non cadre
3. Profession libérale
4. Chirurgien
5. Chirurgien-dentiste
6. Médecin spécialiste
7. Vétérinaire
8. Artisan
9. Commerçant
10. Retraité
11. Sans activité

---

#### Table `pret_data`

Données du prêt existant.

**Colonnes :**

| Nom                     | Type        | Nullable | Défaut              | Description                          |
| ----------------------- | ----------- | -------- | ------------------- | ------------------------------------ |
| `id`                    | uuid        | Non      | `gen_random_uuid()` | Identifiant unique                   |
| `dossier_id`            | uuid        | Oui      | -                   | Référence vers `dossiers.id`         |
| `banque_preteuse`       | varchar     | Non      | -                   | Nom de la banque prêteuse            |
| `montant_capital`       | numeric     | Non      | -                   | Montant du capital (doit être > 0)   |
| `duree_mois`            | integer     | Non      | -                   | Durée en mois (doit être > 0)        |
| `type_pret`             | varchar     | Non      | -                   | Type de prêt                         |
| `taux_nominal`          | numeric     | Oui      | -                   | Taux nominal                         |
| `taux_effectif`         | numeric     | Oui      | -                   | Taux effectif                        |
| `taux_assurance`        | numeric     | Oui      | -                   | Taux d'assurance                     |
| `cout_assurance_banque` | numeric     | Oui      | -                   | Coût de l'assurance banque           |
| `type_garantie`         | varchar     | Oui      | -                   | Type de garantie                     |
| `apport_personnel`      | numeric     | Oui      | `0`                 | Apport personnel                     |
| `date_debut`            | date        | Oui      | -                   | Date de début extraite des documents |
| `date_fin`              | date        | Oui      | -                   | Date de fin extraite des documents   |
| `date_debut_effective`  | date        | Oui      | -                   | Date de début effective calculée     |
| `duree_restante_mois`   | integer     | Oui      | -                   | Durée restante en mois calculée      |
| `capital_restant_du`    | numeric     | Oui      | -                   | Capital restant dû calculé           |
| `created_at`            | timestamptz | Oui      | `now()`             | Date de création                     |
| `updated_at`            | timestamptz | Oui      | `now()`             | Date de mise à jour                  |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **FOREIGN KEY** : `dossier_id` → `dossiers.id` (ON DELETE CASCADE)
- **CHECK** :
  - `montant_capital > 0`
  - `duree_mois > 0`

**Index :**

- `pret_data_pkey` (PRIMARY KEY sur `id`)
- `idx_pret_data_dossier_id` (sur `dossier_id`)
- `idx_pret_data_banque` (sur `banque_preteuse`)

**RLS :** Activé

---

#### Table `devis`

Devis générés pour les dossiers.

**Colonnes :**

| Nom                | Type        | Nullable | Défaut              | Description                                                          |
| ------------------ | ----------- | -------- | ------------------- | -------------------------------------------------------------------- |
| `id`               | uuid        | Non      | `gen_random_uuid()` | Identifiant unique                                                   |
| `dossier_id`       | uuid        | Oui      | -                   | Référence vers `dossiers.id`                                         |
| `numero_devis`     | varchar     | Non      | -                   | Numéro unique du devis (UNIQUE)                                      |
| `compagnie`        | varchar     | Oui      | -                   | Nom de la compagnie d'assurance                                      |
| `produit`          | varchar     | Oui      | -                   | Nom du produit                                                       |
| `reference`        | varchar     | Oui      | -                   | Référence du devis                                                   |
| `cout_total`       | numeric     | Oui      | -                   | Coût total                                                           |
| `cout_mensuel`     | numeric     | Oui      | -                   | Coût mensuel                                                         |
| `economie_estimee` | numeric     | Oui      | -                   | Économie estimée                                                     |
| `statut`           | varchar     | Non      | `'en_attente'`      | Statut : `en_attente`, `envoye`, `lu`, `accepte`, `refuse`, `expire` |
| `donnees_devis`    | jsonb       | Non      | -                   | Données complètes du devis (JSON)                                    |
| `pdf_url`          | text        | Oui      | -                   | URL du PDF du devis                                                  |
| `pdf_created_at`   | timestamptz | Oui      | -                   | Date de création du PDF                                              |
| `date_generation`  | timestamptz | Oui      | `now()`             | Date de génération                                                   |
| `date_envoi`       | timestamptz | Oui      | -                   | Date d'envoi au client                                               |
| `date_acceptation` | timestamptz | Oui      | -                   | Date d'acceptation                                                   |
| `date_expiration`  | timestamptz | Oui      | -                   | Date d'expiration                                                    |
| `date_refus`       | timestamptz | Oui      | -                   | Date de refus                                                        |
| `motif_refus`      | text        | Oui      | -                   | Motif du refus                                                       |
| `created_at`       | timestamptz | Oui      | `now()`             | Date de création                                                     |
| `updated_at`       | timestamptz | Oui      | `now()`             | Date de mise à jour                                                  |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **UNIQUE** : `numero_devis`
- **FOREIGN KEY** : `dossier_id` → `dossiers.id` (ON DELETE CASCADE)
- **CHECK** : `statut` doit être dans
  `['en_attente', 'envoye', 'lu', 'accepte', 'refuse', 'expire']`

**Index :**

- `devis_pkey` (PRIMARY KEY sur `id`)
- `devis_numero_devis_key` (UNIQUE sur `numero_devis`)
- `idx_devis_dossier_id` (sur `dossier_id`)
- `idx_devis_statut` (sur `statut`)
- `idx_devis_numero_devis` (sur `numero_devis`)
- `idx_devis_compagnie` (sur `compagnie`)
- `idx_devis_reference` (sur `reference`)
- `idx_devis_cout_total` (sur `cout_total`)
- `idx_devis_date_generation` (sur `date_generation`)
- `idx_devis_date_refus` (sur `date_refus` WHERE `date_refus IS NOT NULL`)
- `idx_devis_motif_refus` (sur `motif_refus` WHERE `motif_refus IS NOT NULL`)
- `idx_devis_donnees_gin` (GIN sur `donnees_devis`)

**RLS :** Activé

---

#### Table `devis_history`

Historique des actions effectuées sur les devis.

**Colonnes :**

| Nom                | Type        | Nullable | Défaut              | Description                                              |
| ------------------ | ----------- | -------- | ------------------- | -------------------------------------------------------- |
| `id`               | uuid        | Non      | `gen_random_uuid()` | Identifiant unique                                       |
| `devis_id`         | uuid        | Non      | -                   | Référence vers `devis.id`                                |
| `dossier_id`       | uuid        | Non      | -                   | Référence vers `dossiers.id`                             |
| `action`           | varchar     | Non      | -                   | Type d'action : `envoye`, `refuse`, `accepte`, `renvoye` |
| `statut_precedent` | varchar     | Oui      | -                   | Statut précédent                                         |
| `statut_nouveau`   | varchar     | Oui      | -                   | Nouveau statut                                           |
| `motif_refus`      | text        | Oui      | -                   | Motif de refus (si applicable)                           |
| `user_id`          | uuid        | Oui      | -                   | ID de l'utilisateur ayant effectué l'action              |
| `user_type`        | varchar     | Oui      | -                   | Type d'utilisateur : `admin` ou `apporteur`              |
| `commentaire`      | text        | Oui      | -                   | Commentaire                                              |
| `created_at`       | timestamptz | Oui      | `now()`             | Date de création                                         |
| `updated_at`       | timestamptz | Oui      | `now()`             | Date de mise à jour                                      |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **FOREIGN KEY** :
  - `devis_id` → `devis.id` (ON DELETE CASCADE)
  - `dossier_id` → `dossiers.id` (ON DELETE CASCADE)

**Index :**

- `devis_history_pkey` (PRIMARY KEY sur `id`)
- `idx_devis_history_devis_id` (sur `devis_id`)
- `idx_devis_history_dossier_id` (sur `dossier_id`)
- `idx_devis_history_created_at` (sur `created_at`)

**RLS :** Activé

**Policies RLS :**

- **SELECT** : `Users can view devis_history for accessible devis`
  - Un user peut voir l'historique d'un devis s'il peut voir le devis lui-même
  - Vérifie l'accès via `devis_id` → `dossier_id` → `broker_id`
  - Même logique que les policies sur `devis` (apporteur actif du broker,
    broker_user, ou super_admin)

---

#### Table `documents`

Documents associés aux dossiers.

**Colonnes :**

| Nom              | Type                | Nullable | Défaut              | Description                                                             |
| ---------------- | ------------------- | -------- | ------------------- | ----------------------------------------------------------------------- |
| `id`             | uuid                | Non      | `gen_random_uuid()` | Identifiant unique                                                      |
| `dossier_id`     | uuid                | Oui      | -                   | Référence vers `dossiers.id`                                            |
| `document_name`  | varchar             | Non      | -                   | Nom du document                                                         |
| `document_type`  | varchar             | Non      | -                   | Type de document                                                        |
| `file_size`      | bigint              | Oui      | -                   | Taille du fichier en octets                                             |
| `mime_type`      | varchar             | Oui      | -                   | Type MIME                                                               |
| `storage_path`   | text                | Non      | -                   | Chemin de stockage                                                      |
| `storage_bucket` | varchar             | Oui      | `'documents'`       | Nom du bucket de stockage                                               |
| `uploaded_by`    | uuid                | Oui      | -                   | Référence vers `auth.users.id`                                          |
| `source`         | document_source     | Oui      | `'uploaded'`        | **NOUVEAU** - Source : `uploaded`, `exade_generated`, `system`          |
| `external_ref`   | text                | Oui      | -                   | **NOUVEAU** - Référence externe (ex: exade_document_id, exade_doc_type) |
| `visibility`     | document_visibility | Oui      | `'apporteur'`       | **NOUVEAU** - Visibilité : `apporteur`, `broker_only`, `admin_only`     |
| `created_at`     | timestamptz         | Oui      | `now()`             | Date de création                                                        |
| `updated_at`     | timestamptz         | Oui      | `now()`             | Date de mise à jour                                                     |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **FOREIGN KEY** :
  - `dossier_id` → `dossiers.id` (ON DELETE CASCADE)
  - `uploaded_by` → `auth.users.id`

**Index :**

- `documents_pkey` (PRIMARY KEY sur `id`)
- `idx_documents_dossier_id` (sur `dossier_id`)
- `idx_documents_type` (sur `document_type`)
- `idx_documents_uploaded_by` (sur `uploaded_by`)
- `idx_documents_source` (sur `source`)
- `idx_documents_external_ref` (sur `external_ref` WHERE
  `external_ref IS NOT NULL`)
- `idx_documents_visibility` (sur `visibility`)

**RLS :** Activé

---

#### Table `process_steps`

Étapes du processus de traitement des dossiers.

**Colonnes :**

| Nom                | Type        | Nullable | Défaut              | Description                                                         |
| ------------------ | ----------- | -------- | ------------------- | ------------------------------------------------------------------- |
| `id`               | uuid        | Non      | `gen_random_uuid()` | Identifiant unique                                                  |
| `dossier_id`       | uuid        | Oui      | -                   | Référence vers `dossiers.id`                                        |
| `step_name`        | varchar     | Non      | -                   | Nom de l'étape                                                      |
| `step_description` | text        | Oui      | -                   | Description de l'étape                                              |
| `step_order`       | integer     | Non      | -                   | Ordre de l'étape                                                    |
| `status`           | varchar     | Non      | `'pending'`         | Statut : `pending`, `in_progress`, `completed`, `failed`, `skipped` |
| `started_at`       | timestamptz | Oui      | -                   | Date de début                                                       |
| `completed_at`     | timestamptz | Oui      | -                   | Date de complétion                                                  |
| `created_at`       | timestamptz | Oui      | `now()`             | Date de création                                                    |
| `updated_at`       | timestamptz | Oui      | `now()`             | Date de mise à jour                                                 |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **FOREIGN KEY** : `dossier_id` → `dossiers.id` (ON DELETE CASCADE)
- **CHECK** : `status` doit être dans
  `['pending', 'in_progress', 'completed', 'failed', 'skipped']`

**Index :**

- `process_steps_pkey` (PRIMARY KEY sur `id`)
- `idx_process_steps_dossier_id` (sur `dossier_id`)
- `idx_process_steps_order` (sur `dossier_id, step_order`)
- `idx_process_steps_status` (sur `status`)
- `idx_process_steps_step_order` (sur `step_order`)

**RLS :** Activé

---

#### Table `activities`

Activités et événements liés aux dossiers et apporteurs.

**Colonnes :**

| Nom                    | Type        | Nullable | Défaut              | Description                            |
| ---------------------- | ----------- | -------- | ------------------- | -------------------------------------- |
| `id`                   | uuid        | Non      | `gen_random_uuid()` | Identifiant unique                     |
| `user_id`              | uuid        | Oui      | -                   | Référence vers `apporteur_profiles.id` |
| `dossier_id`           | uuid        | Oui      | -                   | Référence vers `dossiers.id`           |
| `activity_type`        | varchar     | Non      | -                   | Type d'activité                        |
| `activity_title`       | varchar     | Non      | -                   | Titre de l'activité                    |
| `activity_description` | text        | Oui      | -                   | Description de l'activité              |
| `activity_data`        | jsonb       | Oui      | -                   | Données supplémentaires (JSON)         |
| `is_read`              | boolean     | Oui      | `false`             | Indique si l'activité a été lue        |
| `created_at`           | timestamptz | Oui      | `now()`             | Date de création                       |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **FOREIGN KEY** :
  - `user_id` → `apporteur_profiles.id` (ON DELETE CASCADE)
  - `dossier_id` → `dossiers.id` (ON DELETE CASCADE)

**Index :**

- `activities_pkey` (PRIMARY KEY sur `id`)
- `idx_activities_user_id` (sur `user_id`)
- `idx_activities_dossier_id` (sur `dossier_id`)
- `idx_activities_type` (sur `activity_type`)
- `idx_activities_created_at` (sur `created_at DESC`)
- `idx_activities_user_created` (sur `user_id, created_at DESC`)
- `idx_activities_unread` (sur `user_id, is_read` WHERE `is_read = false`)
- `idx_activities_data_gin` (GIN sur `activity_data`)

**RLS :** Activé

---

#### Table `notifications`

Notifications pour les apporteurs.

**Colonnes :**

| Nom          | Type        | Nullable | Défaut              | Description                            |
| ------------ | ----------- | -------- | ------------------- | -------------------------------------- |
| `id`         | uuid        | Non      | `gen_random_uuid()` | Identifiant unique                     |
| `user_id`    | uuid        | Non      | -                   | Référence vers `apporteur_profiles.id` |
| `title`      | text        | Non      | -                   | Titre de la notification               |
| `message`    | text        | Non      | -                   | Message de la notification             |
| `type`       | text        | Non      | `'info'`            | Type de notification                   |
| `data`       | jsonb       | Oui      | -                   | Données supplémentaires (JSON)         |
| `is_read`    | boolean     | Oui      | `false`             | Indique si la notification a été lue   |
| `created_at` | timestamptz | Oui      | `now()`             | Date de création                       |
| `updated_at` | timestamptz | Oui      | `now()`             | Date de mise à jour                    |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **FOREIGN KEY** : `user_id` → `apporteur_profiles.id` (ON DELETE CASCADE)

**Index :**

- `notifications_pkey` (PRIMARY KEY sur `id`)
- `idx_notifications_user_id` (sur `user_id`)
- `idx_notifications_is_read` (sur `is_read`)
- `idx_notifications_created_at` (sur `created_at DESC`)
- `idx_notifications_user_read` (sur `user_id, is_read, created_at DESC`)
- `idx_notifications_user_type` (sur `user_id, type, created_at DESC`)

**RLS :** Activé

---

#### Table `monthly_stats`

Statistiques mensuelles par apporteur.

**Colonnes :**

| Nom                   | Type        | Nullable | Défaut              | Description                            |
| --------------------- | ----------- | -------- | ------------------- | -------------------------------------- |
| `id`                  | uuid        | Non      | `gen_random_uuid()` | Identifiant unique                     |
| `apporteur_id`        | uuid        | Non      | -                   | Référence vers `apporteur_profiles.id` |
| `month_year`          | varchar     | Non      | -                   | Mois/année (format : `YYYY-MM`)        |
| `total_dossiers`      | integer     | Oui      | `0`                 | Nombre total de dossiers               |
| `total_economies`     | numeric     | Oui      | `0`                 | Total des économies générées           |
| `classement_position` | integer     | Oui      | -                   | Position dans le classement            |
| `created_at`          | timestamptz | Oui      | `now()`             | Date de création                       |
| `updated_at`          | timestamptz | Oui      | `now()`             | Date de mise à jour                    |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **UNIQUE** : `apporteur_id, month_year`
- **FOREIGN KEY** : `apporteur_id` → `apporteur_profiles.id` (ON DELETE CASCADE)

**Index :**

- `monthly_stats_pkey` (PRIMARY KEY sur `id`)
- `monthly_stats_apporteur_id_month_year_key` (UNIQUE sur
  `apporteur_id, month_year`)
- `idx_monthly_stats_apporteur_id` (sur `apporteur_id`)
- `idx_monthly_stats_month_year` (sur `month_year`)
- `idx_monthly_stats_apporteur_month` (sur `apporteur_id, month_year`)

**RLS :** Activé

---

#### Table `wallet_accounts`

Comptes wallet pour apporteurs, brokers et plateforme.

**Colonnes :**

| Nom                 | Type              | Nullable | Défaut              | Description                                                                                                    |
| ------------------- | ----------------- | -------- | ------------------- | -------------------------------------------------------------------------------------------------------------- |
| `id`                | uuid              | Non      | `gen_random_uuid()` | Identifiant unique                                                                                             |
| `broker_id`         | uuid              | Non      | -                   | Référence vers `brokers.id`                                                                                    |
| `owner_type`        | wallet_owner_type | Non      | -                   | Type de propriétaire : `apporteur`, `broker`, `platform`                                                       |
| `owner_id`          | uuid              | Oui      | -                   | ID du propriétaire (si apporteur => `apporteur_profiles.id` ; si broker => `brokers.id` ; si platform => NULL) |
| `currency`          | text              | Non      | `'EUR'`             | Devise                                                                                                         |
| `balance_available` | numeric           | Non      | `0`                 | Solde disponible (doit être >= 0)                                                                              |
| `balance_pending`   | numeric           | Non      | `0`                 | Solde en attente (doit être >= 0)                                                                              |
| `created_at`        | timestamptz       | Non      | `now()`             | Date de création                                                                                               |
| `updated_at`        | timestamptz       | Non      | `now()`             | Date de mise à jour                                                                                            |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **UNIQUE** : `broker_id, owner_type, owner_id, currency`
- **FOREIGN KEY** : `broker_id` → `brokers.id` (ON DELETE CASCADE)
- **CHECK** :
  - `balance_available >= 0`
  - `balance_pending >= 0`

**Index :**

- `wallet_accounts_pkey` (PRIMARY KEY sur `id`)
- `idx_wallet_accounts_broker_id` (sur `broker_id`)
- `idx_wallet_accounts_owner` (sur `owner_type, owner_id`)

**RLS :** Activé

---

#### Table `wallet_transactions`

Ledger immuable de toutes les transactions wallet.

**Colonnes :**

| Nom                 | Type                      | Nullable | Défaut              | Description                                               |
| ------------------- | ------------------------- | -------- | ------------------- | --------------------------------------------------------- |
| `id`                | uuid                      | Non      | `gen_random_uuid()` | Identifiant unique                                        |
| `broker_id`         | uuid                      | Non      | -                   | Référence vers `brokers.id`                               |
| `wallet_account_id` | uuid                      | Non      | -                   | Référence vers `wallet_accounts.id`                       |
| `dossier_id`        | uuid                      | Oui      | -                   | Référence vers `dossiers.id` (si lié à un dossier)        |
| `devis_id`          | uuid                      | Oui      | -                   | Référence vers `devis.id` (si lié à un devis)             |
| `type`              | wallet_transaction_type   | Non      | -                   | Type : `credit`, `debit`, `fee`, `payout`, `adjustment`   |
| `status`            | wallet_transaction_status | Non      | `'pending'`         | Statut : `pending`, `available`, `cancelled`              |
| `amount`            | numeric                   | Non      | -                   | Montant (toujours positif, le signe est porté par `type`) |
| `label`             | text                      | Non      | -                   | Libellé de la transaction                                 |
| `meta`              | jsonb                     | Oui      | -                   | Métadonnées (commission_rule_id, calcul, etc.)            |
| `created_at`        | timestamptz               | Non      | `now()`             | Date de création                                          |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **FOREIGN KEY** :
  - `broker_id` → `brokers.id` (ON DELETE CASCADE)
  - `wallet_account_id` → `wallet_accounts.id` (ON DELETE CASCADE)
  - `dossier_id` → `dossiers.id` (ON DELETE SET NULL)
  - `devis_id` → `devis.id` (ON DELETE SET NULL)
- **CHECK** : `amount > 0`

**Index :**

- `wallet_transactions_pkey` (PRIMARY KEY sur `id`)
- `idx_wallet_transactions_wallet_account_id` (sur `wallet_account_id`)
- `idx_wallet_transactions_broker_id` (sur `broker_id`)
- `idx_wallet_transactions_dossier_id` (sur `dossier_id`)
- `idx_wallet_transactions_devis_id` (sur `devis_id`)
- `idx_wallet_transactions_status` (sur `status`)
- `idx_wallet_transactions_created_at` (sur `created_at DESC`)

**RLS :** Activé

---

#### Table `commission_rules`

Règles de commission paramétrables par broker, apporteur ou produit.

**Colonnes :**

| Nom                    | Type                  | Nullable | Défaut              | Description                                                              |
| ---------------------- | --------------------- | -------- | ------------------- | ------------------------------------------------------------------------ |
| `id`                   | uuid                  | Non      | `gen_random_uuid()` | Identifiant unique                                                       |
| `broker_id`            | uuid                  | Non      | -                   | Référence vers `brokers.id`                                              |
| `scope`                | commission_rule_scope | Non      | `'default'`         | Portée : `default`, `apporteur_specific`, `product_specific`             |
| `apporteur_profile_id` | uuid                  | Oui      | -                   | Référence vers `apporteur_profiles.id` (si scope = `apporteur_specific`) |
| `insurance_product_id` | uuid                  | Oui      | -                   | Référence vers `insurance_products.id` (si scope = `product_specific`)   |
| `apporteur_share_pct`  | numeric               | Non      | `0`                 | Part vers l'apporteur (0-100%)                                           |
| `platform_fee_pct`     | numeric               | Non      | `0`                 | Part plateforme (0-100%)                                                 |
| `fixed_fee`            | numeric               | Oui      | `0`                 | Frais fixe                                                               |
| `min_fee`              | numeric               | Oui      | -                   | Frais minimum                                                            |
| `max_fee`              | numeric               | Oui      | -                   | Frais maximum                                                            |
| `effective_from`       | timestamptz           | Non      | `now()`             | Date d'effet                                                             |
| `effective_to`         | timestamptz           | Oui      | -                   | Date de fin d'effet                                                      |
| `created_at`           | timestamptz           | Non      | `now()`             | Date de création                                                         |
| `updated_at`           | timestamptz           | Non      | `now()`             | Date de mise à jour                                                      |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **FOREIGN KEY** :
  - `broker_id` → `brokers.id` (ON DELETE CASCADE)
  - `apporteur_profile_id` → `apporteur_profiles.id` (ON DELETE CASCADE)
  - `insurance_product_id` → `insurance_products.id` (ON DELETE CASCADE)
- **CHECK** :
  - `apporteur_share_pct >= 0 AND apporteur_share_pct <= 100`
  - `platform_fee_pct >= 0 AND platform_fee_pct <= 100`
  - `fixed_fee >= 0`
  - `min_fee >= 0` (si non NULL)
  - `max_fee >= 0` (si non NULL)
  - Logique de scope :
    `(scope = 'default' AND apporteur_profile_id IS NULL AND insurance_product_id IS NULL) OR (scope = 'apporteur_specific' AND apporteur_profile_id IS NOT NULL) OR (scope = 'product_specific' AND insurance_product_id IS NOT NULL)`

**Index :**

- `commission_rules_pkey` (PRIMARY KEY sur `id`)
- `idx_commission_rules_broker_id` (sur `broker_id`)
- `idx_commission_rules_apporteur` (sur `apporteur_profile_id` WHERE
  `apporteur_profile_id IS NOT NULL`)
- `idx_commission_rules_product` (sur `insurance_product_id` WHERE
  `insurance_product_id IS NOT NULL`)
- `idx_commission_rules_effective` (sur `effective_from, effective_to`)

**RLS :** Activé

---

#### Table `payout_requests`

Demandes de retrait des fonds wallet.

**Colonnes :**

| Nom                 | Type                  | Nullable | Défaut              | Description                                          |
| ------------------- | --------------------- | -------- | ------------------- | ---------------------------------------------------- |
| `id`                | uuid                  | Non      | `gen_random_uuid()` | Identifiant unique                                   |
| `wallet_account_id` | uuid                  | Non      | -                   | Référence vers `wallet_accounts.id`                  |
| `amount`            | numeric               | Non      | -                   | Montant demandé (doit être > 0)                      |
| `status`            | payout_request_status | Non      | `'requested'`       | Statut : `requested`, `approved`, `rejected`, `paid` |
| `iban_hash`         | text                  | Oui      | -                   | Hash de l'IBAN (pas en clair)                        |
| `payout_method_id`  | uuid                  | Oui      | -                   | ID de la méthode de paiement (pour plus tard)        |
| `created_at`        | timestamptz           | Non      | `now()`             | Date de création                                     |
| `updated_at`        | timestamptz           | Non      | `now()`             | Date de mise à jour                                  |

**Contraintes :**

- **PRIMARY KEY** : `id`
- **FOREIGN KEY** : `wallet_account_id` → `wallet_accounts.id` (ON DELETE
  CASCADE)
- **CHECK** : `amount > 0`

**Index :**

- `payout_requests_pkey` (PRIMARY KEY sur `id`)
- `idx_payout_requests_wallet_account_id` (sur `wallet_account_id`)
- `idx_payout_requests_status` (sur `status`)

**RLS :** Activé

---

### Schéma `auth`

Tables d'authentification Supabase (gérées par Supabase).

#### Table `users`

Utilisateurs du système d'authentification.

**Colonnes principales :**

- `id` (uuid, PRIMARY KEY)
- `email` (varchar, UNIQUE si `is_sso_user = false`)
- `phone` (text, UNIQUE)
- `encrypted_password` (varchar)
- `email_confirmed_at` (timestamptz)
- `phone_confirmed_at` (timestamptz)
- `confirmed_at` (timestamptz, généré)
- `last_sign_in_at` (timestamptz)
- `raw_app_meta_data` (jsonb)
- `raw_user_meta_data` (jsonb)
- `is_super_admin` (boolean)
- `is_sso_user` (boolean, défaut: `false`)
- `is_anonymous` (boolean, défaut: `false`)
- `created_at` (timestamptz)
- `updated_at` (timestamptz)
- Et de nombreuses autres colonnes pour la gestion des tokens et
  authentification

**RLS :** Activé

#### Table `sessions`

Sessions utilisateur.

**Colonnes principales :**

- `id` (uuid, PRIMARY KEY)
- `user_id` (uuid, FOREIGN KEY vers `users.id`)
- `created_at` (timestamptz)
- `updated_at` (timestamptz)
- `aal` (aal_level enum)
- `not_after` (timestamptz)
- `ip` (inet)
- `user_agent` (text)

**RLS :** Activé

#### Table `identities`

Identités associées aux utilisateurs (OAuth, etc.).

**Colonnes principales :**

- `id` (uuid, PRIMARY KEY)
- `user_id` (uuid, FOREIGN KEY vers `users.id`)
- `provider` (text)
- `provider_id` (text)
- `identity_data` (jsonb)
- `email` (text, généré)

**RLS :** Activé

#### Autres tables `auth` :

- `refresh_tokens` - Tokens de rafraîchissement
- `mfa_factors` - Facteurs d'authentification multi-facteurs
- `mfa_challenges` - Défis MFA
- `mfa_amr_claims` - Claims d'authentification MFA
- `oauth_clients` - Clients OAuth
- `oauth_authorizations` - Autorisations OAuth
- `oauth_consents` - Consentements OAuth
- `one_time_tokens` - Tokens à usage unique
- `flow_state` - État des flux d'authentification
- `sso_providers` - Fournisseurs SSO
- `sso_domains` - Domaines SSO
- `saml_providers` - Fournisseurs SAML
- `saml_relay_states` - États de relais SAML
- `instances` - Instances d'authentification
- `audit_log_entries` - Entrées d'audit
- `schema_migrations` - Migrations du schéma auth

---

### Schéma `storage`

Tables de stockage de fichiers Supabase.

#### Table `buckets`

Buckets de stockage.

**Colonnes principales :**

- `id` (text, PRIMARY KEY)
- `name` (text, UNIQUE)
- `public` (boolean)
- `file_size_limit` (bigint)
- `allowed_mime_types` (text[])
- `type` (buckettype enum: `STANDARD`, `ANALYTICS`, `VECTOR`)

**RLS :** Activé

#### Table `objects`

Objets (fichiers) stockés.

**Colonnes principales :**

- `id` (uuid, PRIMARY KEY)
- `bucket_id` (text, FOREIGN KEY vers `buckets.id`)
- `name` (text)
- `owner_id` (text)
- `metadata` (jsonb)
- `user_metadata` (jsonb)
- `path_tokens` (text[], généré)
- `level` (integer)

**RLS :** Activé

#### Autres tables `storage` :

- `migrations` - Migrations du schéma storage
- `prefixes` - Préfixes de stockage
- `s3_multipart_uploads` - Uploads multipart S3
- `s3_multipart_uploads_parts` - Parties d'uploads multipart
- `buckets_analytics` - Buckets analytiques
- `buckets_vectors` - Buckets vectoriels
- `vector_indexes` - Index vectoriels

---

### Schéma `vault`

Tables de gestion des secrets.

#### Table `secrets`

Secrets chiffrés.

**Colonnes principales :**

- `id` (uuid, PRIMARY KEY)
- `name` (text, UNIQUE si non NULL)
- `secret` (text, chiffré)
- `description` (text)
- `key_id` (uuid)
- `nonce` (bytea)
- `created_at` (timestamptz)
- `updated_at` (timestamptz)

**RLS :** Désactivé

---

### Schéma `realtime`

Tables pour les fonctionnalités temps réel.

#### Table `messages`

Messages temps réel.

**Colonnes principales :**

- `id` (uuid)
- `inserted_at` (timestamp)
- `topic` (text)
- `extension` (text)
- `payload` (jsonb)
- `event` (text)
- `private` (boolean)

**PRIMARY KEY :** `(id, inserted_at)`

**RLS :** Activé

#### Autres tables `realtime` :

- `subscription` - Abonnements temps réel
- `schema_migrations` - Migrations du schéma realtime
- `messages_2025_09_17` à `messages_2025_09_21` - Tables partitionnées de
  messages

---

## Types Énumérés (Enums)

### `apporteur_statut`

- `actif`
- `inactif`
- `suspendu`

### `broker_status`

- `actif`
- `suspendu`
- `inactif`

### `broker_user_role`

- `owner`
- `admin`
- `member`

### `broker_apporteur_status`

- `actif`
- `inactif`
- `suspendu`

### `exade_environment`

- `stage`
- `prod`

### `document_source`

- `uploaded`
- `exade_generated`
- `system`

### `document_visibility`

- `apporteur`
- `broker_only`
- `admin_only`

### `wallet_owner_type`

- `apporteur`
- `broker`
- `platform`

### `wallet_transaction_type`

- `credit`
- `debit`
- `fee`
- `payout`
- `adjustment`

### `wallet_transaction_status`

- `pending`
- `available`
- `cancelled`

### `commission_rule_scope`

- `default`
- `apporteur_specific`
- `product_specific`

### `payout_request_status`

- `requested`
- `approved`
- `rejected`
- `paid`

### `dossier_statut`

- `en_attente`
- `devis_disponible`
- `devis_accepte`
- `refuse`
- `finalise`

### `buckettype`

- `STANDARD`
- `ANALYTICS`
- `VECTOR`

### `aal_level` (Authentication Assurance Level)

- `aal1`
- `aal2`
- `aal3`

### `factor_type`

- `totp`
- `webauthn`
- `phone`

### `factor_status`

- `unverified`
- `verified`

### `oauth_authorization_status`

- `pending`
- `approved`
- `denied`
- `expired`

### `oauth_client_type`

- `public`
- `confidential`

### `oauth_registration_type`

- `dynamic`
- `manual`

### `oauth_response_type`

- `code`

### `code_challenge_method`

- `s256`
- `plain`

### `one_time_token_type`

- `confirmation_token`
- `reauthentication_token`
- `recovery_token`
- `email_change_token_new`
- `email_change_token_current`
- `phone_change_token`

---

## Relations Principales

### Graphe des relations (schéma `public`)

```
brokers (courtiers/cabinets)
  ├── broker_users (1:N via broker_id) ← auth.users
  ├── broker_apporteurs (1:N via broker_id) ← apporteur_profiles
  ├── broker_invites (1:N via broker_id) ← auth.users (created_by_user_id)
  ├── broker_exade_configs (1:1 via broker_id)
  ├── dossiers (1:N via broker_id) ← PIVOT PRINCIPAL
  ├── wallet_accounts (1:N via broker_id)
  ├── wallet_transactions (1:N via broker_id)
  ├── commission_rules (1:N via broker_id)
  └── payout_requests (via wallet_accounts)

auth.users
  ├── apporteur_profiles (1:1 via user_id)
  │     ├── broker_apporteurs (1:N via apporteur_profile_id) ← brokers
  │     ├── dossiers (1:N via apporteur_id)
  │     ├── activities (1:N via user_id)
  │     ├── notifications (1:N via user_id)
  │     ├── monthly_stats (1:N via apporteur_id)
  │     └── wallet_accounts (1:N via owner_id, owner_type='apporteur')
  │
  └── broker_users (1:N via user_id) ← brokers
        └── dossiers (via broker_id)

dossiers (PIVOT PRINCIPAL - broker_id)
  ├── broker_id → brokers (NOT NULL)
  ├── insurance_product_id → insurance_products (NOT NULL)
  ├── client_infos (1:1 via dossier_id)
  ├── pret_data (1:1 via dossier_id)
  ├── devis (1:N via dossier_id)
  │     ├── devis_history (1:N via devis_id)
  │     └── wallet_transactions (1:N via devis_id)
  ├── documents (1:N via dossier_id)
  ├── process_steps (1:N via dossier_id)
  ├── activities (1:N via dossier_id)
  └── wallet_transactions (1:N via dossier_id)

insurance_products
  ├── dossiers (1:N via insurance_product_id)
  └── commission_rules (1:N via insurance_product_id)

wallet_accounts
  ├── wallet_transactions (1:N via wallet_account_id)
  └── payout_requests (1:N via wallet_account_id)
```

---

## Migrations

La base de données contient **100+ migrations** au total, organisées
chronologiquement :

### Migrations principales :

1. **Création des tables de base** (2025-09-25)
   - `create_dossiers_table`
   - `create_client_infos_table`
   - `create_pret_data_table`
   - `create_devis_table`
   - `create_process_steps_table`
   - `create_activities_table`
   - `create_documents_table`

2. **Configuration RLS** (2025-09-25)
   - `setup_rls_policies`

3. **Ajout de fonctionnalités** (2025-09-26)
   - `add_canonical_enum_statut_column`
   - `add_stats_columns_to_dossiers`
   - `create_notifications_table`
   - `create_monthly_stats_table`

4. **Améliorations et optimisations** (2025-09-27)
   - `add_performance_indexes`
   - `create_devis_history_table`
   - `add_is_couple_to_dossiers`
   - `create_activity_triggers`
   - `create_date_sync_triggers`

5. **Fonctionnalités récentes** (2025-10-23)
   - `add_extracted_fields_to_pret_data`
   - `add_client_enriched_fields`
   - `add_extraction_tracking_fields`
   - `add_last_login_at_to_apporteur_profiles`
   - `add_date_finalisation_to_dossiers`

6. **Architecture multi-courtiers et wallet** (2025-12-13)
   - `create_brokers_tables` - Création des tables brokers, broker_users,
     broker_apporteurs
   - `create_broker_exade_configs` - Configuration Exade par broker avec
     référence Vault
   - `create_insurance_products_and_modify_dossiers_fixed` - Produits
     d'assurance et modification dossiers
   - `create_wallet_system_complete` - Système wallet complet (accounts,
     transactions, rules, payouts)
   - `enhance_documents_table` - Amélioration documents (source, external_ref,
     visibility)
   - `create_rls_policies_multi_broker` - RLS policies pour multi-courtiers
   - `backfill_broker_data_safe` - Backfill des données existantes (broker GMB)

7. **Corrections critiques et améliorations** (2025-12-13)
   - `create_wallet_rpc_functions` - Fonctions RPC utiles (get_my_brokers,
     get_wallet_summary, get_applicable_commission_rule,
     recompute_wallet_balances)
   - `add_broker_exade_default_environment` - Environnement Exade par défaut +
     contrainte single enabled
   - `create_wallet_triggers_minimal` - Triggers wallet automatiques (devis
     accepté, dossier finalisé)
   - `fix_rls_policies_multi_broker` - Correction des policies RLS pour
     protection multi-courtiers
   - `fix_storage_policies_multi_broker` - Alignement des policies
     storage.objects avec documents
   - `add_statut_legacy_warning` - Gestion legacy statut vs statut_canon

8. **Corrections critiques de sécurité** (2025-12-13)
   - `fix_critical_security_issues` - Corrections des 6 vérifications critiques
     :
     - Rendre le bucket "documents" privé (était public)
     - Ajouter idempotence aux triggers wallet (éviter doublons)
     - Créer règles de commission par défaut 80/20 pour tous les brokers
     - Activer RLS sur devis_history avec policy appropriée

9. **Système d'invitations et onboarding** (2025-12-13)
   - `create_broker_invites_system` - Système d'invitations apporteurs :
     - Table `broker_invites` avec enum `broker_invite_type`
     - RPC `create_broker_invite`, `validate_broker_invite`,
       `consume_broker_invite`
     - RLS policies pour limiter l'accès aux owner/admin
   - `create_broker_onboarding_system` - Système d'onboarding courtiers :
     - Enum `broker_onboarding_status` (`created`, `exade_pending`, `ready`)
     - Champs onboarding dans `brokers` et `broker_exade_configs`
     - RPC `create_broker_for_current_user` pour création automatique
     - RPC `update_broker_onboarding_status` pour suivi onboarding
     - Trigger automatique pour mettre à jour onboarding_status quand Exade est
       configuré

---

## Notes Importantes

### Row Level Security (RLS)

La plupart des tables du schéma `public` ont RLS activé. Les politiques RLS
contrôlent l'accès aux données en fonction du rôle de l'utilisateur et de son
appartenance aux brokers.

**Architecture multi-courtiers :**

- Un utilisateur peut voir un dossier si :
  1. Il est **apporteur** lié au broker ET le dossier appartient à ce broker
  2. OU il est **broker_user** de ce broker
  3. OU il est **admin plateforme** (super_admin)

**Policies RLS détaillées :**

#### Table `dossiers`

- **SELECT** : `Multi-broker dossier access`
  - Vérifie l'accès via `broker_id` (apporteur actif du broker, broker_user, ou
    super_admin)
- **INSERT** : `Apporteurs can create dossiers for their broker`
  - Apporteur actif du broker, broker_user (owner/admin), ou super_admin
- **UPDATE** : `Multi-broker dossier update`
  - Même logique que SELECT

#### Table `documents`

- **SELECT/UPDATE** : `Multi-broker document access`
  - Vérifie l'accès via `dossier_id` → `broker_id`
  - Même logique que `dossiers`
- **INSERT** : `Multi-broker document insert`
  - Vérifie l'accès au dossier avant insertion

#### Table `storage.objects`

- **SELECT/INSERT/UPDATE/DELETE** :
  `Multi-broker document view/upload/update/delete`
  - Utilise `can_access_document_via_dossier(name)` qui vérifie
    `documents.storage_path` → `dossier_id` → `broker_id`
  - **Aligné avec `documents` RLS** pour éviter les fuites de données

**Fonctions helper RLS :**

- `is_broker_member(broker_uuid, user_uuid)` - Vérifie si un user est membre
  d'un broker
- `is_broker_apporteur(broker_uuid, apporteur_uuid)` - Vérifie si un apporteur
  est lié à un broker
- `get_user_broker_ids(user_uuid)` - Retourne les IDs des brokers d'un user
- `get_apporteur_broker_ids(apporteur_uuid)` - Retourne les IDs des brokers d'un
  apporteur
- `can_access_document_via_dossier(storage_path)` - Vérifie l'accès à un
  document via son dossier et broker

### Triggers

Plusieurs triggers sont configurés pour :

- Mettre à jour automatiquement `updated_at`
- Synchroniser les dates entre `devis` et `process_steps`
- Créer des activités automatiquement lors d'événements
- Créer des profils apporteur automatiquement

**Triggers Wallet :**

- **`trigger_devis_accepte_wallet`** (sur `devis`)
  - **Déclenchement** : Quand `devis.statut` passe à `'accepte'`
  - **Action** :
    1. Récupère la règle de commission applicable
    2. Calcule la commission apporteur (basée sur `economie_generee`)
    3. Crée une transaction `credit` avec `status = 'pending'`
    4. Met à jour `wallet_accounts.balance_pending`

- **`trigger_dossier_finalise_wallet`** (sur `dossiers`)
  - **Déclenchement** : Quand `dossiers.statut_canon` passe à `'finalise'`
  - **Action** :
    1. Passe toutes les transactions `pending` → `available`
    2. Met à jour `balance_pending` et `balance_available`
    3. Prélève automatiquement la "platform fee"
    4. Crée une transaction `fee` pour le broker

**Triggers Utilitaires :**

- **`sync_statut_legacy`** (sur `dossiers`)
  - Synchronise automatiquement `statut_canon` → `statut` pour compatibilité
    affichage
  - **À désactiver** une fois que tous les clients utilisent `statut_canon`

- **`ensure_single_enabled_exade_config`** (sur `broker_exade_configs`)
  - Garantit qu'il n'y a qu'une seule config enabled par `broker_id` +
    `environment`
  - Désactive automatiquement les autres configs quand une nouvelle est activée

### Fonctions RPC

Plusieurs fonctions RPC sont disponibles pour :

- Générer des numéros de dossier et devis
- Calculer les classements des apporteurs
- Gérer l'historique des devis
- Synchroniser les données

**Fonctions RPC Multi-Courtiers :**

- **`get_my_brokers()`**
  - Retourne tous les brokers accessibles par l'utilisateur connecté
  - Via `broker_users` (avec rôle) ou `broker_apporteurs` (si apporteur actif)
  - **Usage** : `SELECT * FROM get_my_brokers();`

- **`get_wallet_summary(broker_id, owner_type, owner_id)`**
  - Retourne le résumé wallet (balance_available, balance_pending,
    transaction_count, last_transaction_at)
  - **Usage** :
    `SELECT * FROM get_wallet_summary('broker-uuid'::UUID, 'apporteur'::wallet_owner_type, 'apporteur-uuid'::UUID);`

- **`get_applicable_commission_rule(broker_id, apporteur_id, insurance_product_id, at_time)`**
  - Retourne la règle de commission applicable selon la priorité :
    1. **apporteur_specific** (si `apporteur_id` fourni)
    2. **product_specific** (si `insurance_product_id` fourni)
    3. **default**
  - **Usage** :
    `SELECT * FROM get_applicable_commission_rule('broker-uuid'::UUID, 'apporteur-uuid'::UUID, 'product-uuid'::UUID, now());`

- **`recompute_wallet_balances(broker_id, owner_type, owner_id)`**
  - Recalcule les balances wallet à partir du ledger (utile en cas de désync)
  - **Usage** : `SELECT * FROM recompute_wallet_balances('broker-uuid'::UUID);`

**Fonctions RPC Invitations :**

- **`create_broker_invite(broker_id, invite_type, expires_in_hours, max_uses)`**
  - Crée une invitation pour un apporteur ou broker_user
  - Vérifie que l'utilisateur est owner/admin du broker
  - Retourne un token unique et la date d'expiration
  - **Usage** :
    `SELECT * FROM create_broker_invite('broker-uuid'::UUID, 'apporteur'::broker_invite_type, 168, 1);`

- **`validate_broker_invite(token)`**
  - Valide un token d'invitation
  - Vérifie expiration, révocation, nombre d'utilisations
  - Retourne `is_valid`, `broker_id`, `invite_type`, `reason` si invalide
  - **Usage** : `SELECT * FROM validate_broker_invite('token-string');`

- **`consume_broker_invite(token, user_id)`**
  - Consomme une invitation (incrémente `uses`)
  - Crée automatiquement le lien `broker_apporteurs` si
    `invite_type = 'apporteur'`
  - Crée le wallet account pour l'apporteur si nécessaire
  - **Usage** :
    `SELECT * FROM consume_broker_invite('token-string', auth.uid());`

**Fonctions RPC Onboarding :**

- **`create_broker_for_current_user(broker_name)`**
  - Crée un broker et lie l'utilisateur connecté comme owner
  - Crée automatiquement :
    - Le broker avec `onboarding_status = 'created'`
    - Le lien `broker_users` (role = 'owner')
    - La règle de commission par défaut (80/20)
    - Le wallet account du broker
  - Vérifie que l'utilisateur n'a pas déjà un broker
  - **Usage** : `SELECT * FROM create_broker_for_current_user('Mon Cabinet');`

- **`update_broker_onboarding_status(broker_id, status)`**
  - Met à jour le statut d'onboarding d'un broker
  - Met automatiquement `onboarding_completed_at` si status = 'ready'
  - **Usage** :
    `SELECT update_broker_onboarding_status('broker-uuid'::UUID, 'ready'::broker_onboarding_status);`

### Index de Performance

De nombreux index ont été créés pour optimiser les requêtes fréquentes :

- Index sur les clés étrangères
- Index sur les colonnes de recherche (email, statut, etc.)
- Index GIN sur les colonnes JSONB
- Index composites pour les requêtes complexes
- **Index multi-courtiers** : `idx_dossiers_broker_statut_date` pour requêtes
  filtrées par broker

### Gestion Legacy : `statut` vs `statut_canon`

**Problème identifié :**

- `statut` (varchar) : valeurs avec accents (`finalisé`, `refusé`)
- `statut_canon` (enum) : valeurs sans accents (`finalise`, `refuse`)
- **Risque de bugs subtils** (filtres, conditions)

**Solution appliquée :**

- ✅ **Commentaire** sur `dossiers.statut` : "LEGACY - Utiliser `statut_canon`"
- ✅ **Trigger `sync_statut_legacy`** : Synchronise automatiquement
  `statut_canon` → `statut` pour compatibilité affichage
- ✅ **Recommandation** : Utiliser uniquement `statut_canon` en logique métier

**À faire plus tard :**

- Désactiver le trigger une fois que tous les clients utilisent `statut_canon`
- Supprimer `statut` à terme (ou le garder en "display only")

### Architecture Multi-Courtiers

**Pivot principal :** `dossiers.broker_id` (NOT NULL)

**Principe fondamental :**

> **Tout est filtré par `broker_id`.**

Le "contexte broker" doit être :

- Soit choisi par l'utilisateur (dropdown)
- Soit déduit automatiquement (si un seul broker)

**Avantages :**

- Isolation des données par courtier
- Configuration Exade par courtier (avec secrets dans Vault)
- Wallet et commissions par courtier
- Export/import facile par courtier
- Scalabilité horizontale

**Backfill :**

- Un broker "GMB" a été créé automatiquement
- Tous les dossiers existants ont été assignés au broker GMB
- Les apporteurs existants ont été liés au broker GMB
- Des comptes wallet ont été créés pour les apporteurs et le broker
- Une règle de commission par défaut (80% apporteur, 20% plateforme) a été créée

**Améliorations Contraintes :**

- **`brokers.exade_default_environment`** : Environnement Exade par défaut
  (`stage` ou `prod`)
- **Trigger `ensure_single_enabled_exade_config`** : Garantit une seule config
  enabled par broker/environment

### Système Wallet

**Workflow automatique (implémenté) :**

1. **Quand `devis.statut = 'accepte'`** →
   - Crédit `pending` dans wallet de l'apporteur
   - Calcul automatique de la commission selon la règle applicable
   - Mise à jour de `balance_pending`

2. **Quand `dossiers.statut_canon = 'finalise'`** →
   - Move `pending` → `available`
   - Mise à jour de `balance_pending` et `balance_available`
   - Prélèvement automatique de la "platform fee"
   - Création d'une transaction `fee` pour le broker

**Double vérité : Ledger + Balances**

- **Ledger immuable** : `wallet_transactions` (source de vérité)
- **Balances calculées** : `wallet_accounts.balance_available/pending` (pour
  performance)
- **Fonction de recalcul** : `recompute_wallet_balances()` disponible en cas de
  désync

**À implémenter (côté application) :**

- Edge functions pour gérer les payouts
- Interface de gestion des règles de commission
- Dashboard wallet pour apporteurs et brokers

---

## Vérifications Critiques de Sécurité

### ✅ 1. Storage Bucket "documents" - PRIVÉ

**Status** : ✅ **CORRIGÉ**

- Le bucket `documents` est maintenant **privé** (`public = false`)
- Les accès doivent passer par les policies RLS `storage.objects`
- **CRITIQUE** : Si le bucket était public, les policies RLS ne servaient à rien

### ✅ 2. Test Fuite Inter-Brokers

**Status** : ✅ **Script de test créé**

Un script de test est disponible dans
`supabase/migrations/test_inter_broker_leak.sql` pour vérifier :

- Un courtier de Broker A ne voit aucun dossier de Broker B
- Un apporteur de Broker B ne voit aucun dossier de Broker A
- Impossible d'ouvrir un PDF de l'autre broker via URL (storage.objects RLS)

**Comment tester :**

1. Créer 2 brokers A et B
2. Créer un user courtier dans A, un apporteur dans B
3. Exécuter les requêtes du script avec chaque user
4. Vérifier que les résultats sont 0 (isolation complète)

### ✅ 3. Trigger Wallet : Idempotence

**Status** : ✅ **CORRIGÉ**

- Le trigger `create_wallet_transaction_on_devis_accepte()` vérifie maintenant
  qu'il n'existe pas déjà une transaction pour le même `devis_id`
- Si un devis repasse "accepte" deux fois (ou update multiple), **une seule
  transaction** est créée
- **Protection** : Vérification
  `WHERE devis_id = NEW.id AND type = 'credit' AND status IN ('pending', 'available')`

### ✅ 4. Règles de Commission : Cohérence 80/20

**Status** : ✅ **CORRIGÉ**

- Une règle de commission par défaut **80% apporteur / 20% plateforme** est
  créée automatiquement pour chaque broker actif
- Vérification lors d'un devis accepté + dossier finalisé :
  - `wallet_transactions` crée bien :
    - Un crédit pour l'apporteur (80% de l'économie générée)
    - Une fee pour la plateforme (20% de l'économie générée)
    - Les montants sont stockés dans `meta` pour traçabilité

### ✅ 5. Legacy Statut

**Status** : ✅ **DOCUMENTÉ**

- Le trigger `sync_statut_legacy` synchronise automatiquement `statut_canon` →
  `statut` pour compatibilité affichage
- **Recommandation** : Utiliser uniquement `statut_canon` en logique métier pour
  éviter les problèmes d'accents (`finalisé` vs `finalise`) et d'incohérences

### ✅ 6. devis_history RLS

**Status** : ✅ **CORRIGÉ**

- RLS activé sur `devis_history`
- Policy créée : Un user peut voir l'historique d'un devis s'il peut voir le
  devis lui-même (même logique que `devis`)

---

## Dev Switch : Impersonation Sécurisée (Documentation)

### Objectif

Permettre en développement de basculer rapidement entre rôles (broker_user vs
apporteur) **sans désactiver RLS** ni exposer la service role key au frontend.

### Principe

**Mode DEV uniquement** : Variable d'environnement
`DEV_IMPERSONATION_ENABLED=true` (dev only)

### Architecture Recommandée

#### Option A : Impersonation côté serveur (Recommandé)

1. **Table `dev_impersonation_tokens`** (optionnel, pour audit)
   - `id uuid pk`
   - `created_by_user_id uuid` (super_admin qui crée le token)
   - `target_user_id uuid` (user Supabase à impersonate)
   - `expires_at timestamptz` (5-15 minutes)
   - `created_at timestamptz`
   - **RLS** : Personne ne la lit directement côté client (utilisée uniquement
     via API route serveur)

2. **Page `/dev/switch`** (visible seulement si
   `DEV_IMPERSONATION_ENABLED=true` + super_admin)
   - Appelle RPC `get_my_brokers()` pour lister les brokers accessibles
   - Liste les users liés :
     - `broker_users` (courtiers) du broker choisi
     - `broker_apporteurs` (apporteurs) du broker choisi

3. **API Route serveur `/api/dev/impersonate`** (service role)
   - Génère une session pour `target_user_id`
   - Renvoie un URL de login (ou set-cookie)
   - Le navigateur ouvre ce lien → connecté en target user

#### Option B : Comptes test (Plus simple)

- Créer des comptes "test" (admin test, apporteur test)
- Le switch fait juste un logout/login programmatique (toujours auth normale)

### Broker Context Switch (Indépendant de l'utilisateur)

Même avec l'impersonation, l'app doit gérer un **broker courant**.

**Règle :**

- Si user a 1 broker → auto-select
- Si plusieurs → dropdown

**Stockage :**

- `localStorage: currentBrokerId`
- Éventuellement sync dans `user_metadata` plus tard

**Filtrage :**

- Toutes les queries côté app filtrent sur ce broker (et RLS protège en plus)

### Sécurité

**À éviter absolument :**

- ❌ Désactiver RLS pour aller vite
- ❌ Mettre la service role key côté frontend
- ❌ Faire un "impersonation" côté client sans contrôle

**Bonnes pratiques :**

- ✅ Impersonation uniquement côté serveur (API route avec service role)
- ✅ Vérifier `DEV_IMPERSONATION_ENABLED` avant d'exposer les endpoints
- ✅ Limiter l'accès à `/dev/switch` aux super_admins uniquement
- ✅ Tokens d'impersonation avec expiration courte (5-15 minutes)

### Utilisation

1. Se connecter en tant que super_admin
2. Accéder à `/dev/switch`
3. Choisir un broker
4. Choisir un user (broker_user ou apporteur lié au broker)
5. Cliquer sur "Switch" → redirection vers la session du target user

### Tests Automatisés

Un script de test peut être créé pour valider 90% de la sécurité multi-broker :

- Crée broker A et B
- Crée user courtier A, apporteur B
- Crée un dossier + doc dans B
- Vérifie que user A ne peut pas `select` ni obtenir un signed URL

---

_Document généré automatiquement à partir de la structure actuelle de la base de
données Supabase._

================
File: eslint.config.mjs
================
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
  {
    rules: {
      "@typescript-eslint/no-explicit-any": "off"
    }
  }
];

export default eslintConfig;

================
File: hooks/useBrokerContext.ts
================
"use client";

import { useContext } from 'react';
import { BrokerContext } from '@/components/features/broker/BrokerContextProvider';

// Default values for SSR/prerendering when context is not available
const defaultContextValue = {
    brokers: [],
    currentBroker: null,
    currentBrokerId: null,
    selectBroker: () => {},
    isLoading: true,
};

export const useBrokerContext = () => {
    const context = useContext(BrokerContext);
    // During SSR/prerendering, context may be undefined - return defaults
    if (!context) {
        return defaultContextValue;
    }
    return context;
};

================
File: lib/config/exade.ts
================
/**
 * Configuration centralisée pour l'API Exade
 * Documentation : WebService_Exade_ASSUREA_Avec_commissionnement_-_3.8.pdf
 */

export const EXADE_CONFIG = {
  licenceKey: process.env.EXADE_LICENCE_KEY || '',
  partnerCode: process.env.EXADE_PARTNER_CODE || '815178',
  soapUrl: process.env.EXADE_SOAP_URL || 'https://stage-product.exade.fr/4DSOAP',
  useMock: process.env.EXADE_USE_MOCK === 'true',
}

// Log configuration on module load (only in development)
if (process.env.NODE_ENV === 'development') {
  console.log('[EXADE CONFIG] Loaded configuration:', {
    hasLicenceKey: !!EXADE_CONFIG.licenceKey,
    licenceKeyLength: EXADE_CONFIG.licenceKey?.length || 0,
    licenceKeyPreview: EXADE_CONFIG.licenceKey ? EXADE_CONFIG.licenceKey.substring(0, 8) + '...' : 'MISSING',
    partnerCode: EXADE_CONFIG.partnerCode,
    soapUrl: EXADE_CONFIG.soapUrl,
    useMock: EXADE_CONFIG.useMock
  })
}

/**
 * Valide que la configuration Exade est complète
 * @throws Error si les variables obligatoires sont manquantes
 */
export function validateExadeConfig(): void {
  if (!EXADE_CONFIG.licenceKey) {
    throw new Error(
      'EXADE_LICENCE_KEY manquante dans les variables d\'environnement. ' +
      'Veuillez configurer EXADE_LICENCE_KEY dans votre fichier .env'
    )
  }

  if (!EXADE_CONFIG.soapUrl) {
    throw new Error(
      'EXADE_SOAP_URL manquante dans les variables d\'environnement. ' +
      'Veuillez configurer EXADE_SOAP_URL dans votre fichier .env'
    )
  }
}

================
File: lib/constants/exade.ts
================
/**
 * Constantes et utilitaires pour l'API Exade
 * Documentation : WebService_Exade_ASSUREA_Avec_commissionnement_-_3.8-1
 */

// Catégories professionnelles Exade (page 16 de la documentation)
export const EXADE_CATEGORIES = {
  1: 'Salarié cadre',
  2: 'Salarié non cadre',
  3: 'Profession libérale',
  4: 'Chirurgien',
  5: 'Chirurgien-dentiste',
  6: 'Médecin spécialiste',
  7: 'Vétérinaire',
  8: 'Artisan',
  9: 'Commerçant',
  10: 'Retraité, pré-retraité',
  11: 'Sans activité professionnelle'
} as const;

export type ExadeCategoryCode = keyof typeof EXADE_CATEGORIES;

// Civilité Exade : M, Mme, Mlle (Alphanumérique selon exemple XML Part 2)
export const EXADE_CIVILITE = {
  'M': 'M',
  'Mme': 'Mme',
  'Mlle': 'Mlle'
} as const;

// Sexe Exade : H, F
export const EXADE_SEXE = {
  'H': 'H',
  'F': 'F'
} as const;

// Type de prêt (Part 3B)
export const EXADE_TYPE_PRET = {
  1: 'Amortissable',
  2: 'In fine',
  3: 'Relais',
  4: 'Crédit-bail',
  5: 'LOA',
  6: 'Taux 0%',
  7: 'Palier',
  8: 'Prêt d’honneur',
  9: 'Restructuration',
  10: 'Amortissable professionnel'
} as const;

// Objet du financement (Part 3D)
export const EXADE_OBJET_FINANCEMENT = {
  1: 'Résidence principale',
  2: 'Résidence secondaire',
  3: 'Travaux',
  4: 'Investissement locatif',
  5: 'Crédit professionnel',
  6: 'Autre projet',
  7: 'Construction',
  8: 'Restructuration'
} as const;

// Garanties (Part 3C)
export const EXADE_GARANTIES = {
  1: 'Décès / PTIA',
  2: 'Décès / PTIA / ITT / IPT',
  3: 'Décès / PTIA / ITT / IPT / ITP / IPP',
  4: 'Décès / PTIA / ITT / IPT (rachat dos/psy)',
  5: 'Décès / PTIA / ITT / IPT / ITP / IPP (rachat dos/psy)',
  6: 'Décès / PTIA / ITT / IPT / PE',
  7: 'Décès / PTIA / ITT / IPT / ITP / IPP / PE',
  8: 'Décès / PTIA / ITT / IPT (rachat) / PE',
  9: 'Décès / PTIA / ITT / IPT / ITP / IPP (rachat) / PE',
  10: 'Décès / PTIA / IPPRO (SwissLife)',
  11: 'Décès / PTIA / IPT',
  12: 'Décès / PTIA / IPT / IPP',
  13: 'Décès / PTIA / IPT / IPP (rachat)'
} as const;

// Type d'adhésion (Part 3A)
export const EXADE_TYPE_ADHESION = {
  0: 'Nouveau prêt',
  3: 'Résiliation Banque',
  4: 'Résiliation délégation'
} as const;

/**
 * Obtenir le libellé d'une catégorie professionnelle
 */
export function getCategoryLabel(code: number | null | undefined): string {
  if (!code) return 'Non renseignée';
  return EXADE_CATEGORIES[code as ExadeCategoryCode] || 'Non renseignée';
}

/**
 * Formatter une date pour l'API Exade (AAAAMMJJ)
 */
export function formatDateForExade(dateString: string): string {
  if (!dateString) return '';
  const cleaned = dateString.replace(/\D/g, '');
  if (cleaned.length === 8) return cleaned;
  if (dateString.includes('-')) return dateString.replace(/-/g, '');
  return cleaned;
}

/**
 * Formatter le statut fumeur pour l'API Exade (O/N)
 */
export function formatFumeurForExade(fumeur: boolean): 'O' | 'N' {
  return fumeur ? 'O' : 'N';
}

/**
 * Obtenir le code civilité pour l'API Exade
 */
export function getCiviliteCodeExade(civilite: string | null | undefined): string {
  if (!civilite) return 'M'; // Par défaut
  // Normalisation
  if (civilite === 'Monsieur' || civilite === 'M.') return 'M';
  if (civilite === 'Madame' || civilite === 'Mme') return 'Mme';
  if (civilite === 'Mademoiselle' || civilite === 'Mlle') return 'Mlle';
  return (EXADE_CIVILITE as any)[civilite] || 'M';
}

/**
 * Options pour les selects de catégories professionnelles
 */
export const CATEGORY_OPTIONS = Object.entries(EXADE_CATEGORIES).map(([value, label]) => ({
  value,
  label
}));

================
File: lib/hooks/useIntersectionObserver.ts
================
import { useEffect, useRef, useState } from 'react'

interface UseIntersectionObserverOptions {
  threshold?: number
  rootMargin?: string
  freezeOnceVisible?: boolean
}

export function useIntersectionObserver({
  threshold = 0.5, // 50% de l'élément visible
  rootMargin = '0px',
  freezeOnceVisible = true
}: UseIntersectionObserverOptions = {}) {
  const elementRef = useRef<HTMLDivElement>(null)
  const [isIntersecting, setIsIntersecting] = useState(false)

  useEffect(() => {
    const element = elementRef.current
    if (!element) return

    const observer = new IntersectionObserver(
      ([entry]) => {
        const isElementIntersecting = entry.isIntersecting
        setIsIntersecting(isElementIntersecting)

        // Si on veut "geler" une fois visible (pour éviter de re-marquer)
        if (freezeOnceVisible && isElementIntersecting) {
          observer.disconnect()
        }
      },
      {
        threshold,
        rootMargin
      }
    )

    observer.observe(element)

    return () => {
      observer.disconnect()
    }
  }, [threshold, rootMargin, freezeOnceVisible])

  return { elementRef, isIntersecting }
}

================
File: lib/hooks/useOptimisticActivityReadStatus.ts
================
import { useState, useEffect, useCallback } from 'react'
import { ActivityReadStatusCache } from '@/lib/services/activity-read-status-cache'

interface UseOptimisticActivityReadStatusReturn {
  isRead: boolean
  markAsRead: () => void
  markAsUnread: () => void
  hasPendingUpdate: boolean
}

export function useOptimisticActivityReadStatus(
  activityId: string,
  initialIsRead: boolean
): UseOptimisticActivityReadStatusReturn {
  const [localIsRead, setLocalIsRead] = useState(initialIsRead)
  const [hasPendingUpdate, setHasPendingUpdate] = useState(false)

  // Vérifier le cache au montage et écouter les synchronisations
  useEffect(() => {
    const updateFromCache = () => {
      const cachedStatus = ActivityReadStatusCache.getReadStatus(activityId)
      const hasPending = ActivityReadStatusCache.hasPendingUpdates(activityId)
      
      if (cachedStatus !== null) {
        setLocalIsRead(cachedStatus)
      }
      setHasPendingUpdate(hasPending)
    }

    // Mise à jour initiale
    updateFromCache()

    // Écouter les synchronisations
    const unsubscribe = ActivityReadStatusCache.onSync(updateFromCache)

    return unsubscribe
  }, [activityId])

  // Mise à jour optimiste
  const markAsRead = useCallback(() => {
    setLocalIsRead(true)
    setHasPendingUpdate(true)
    ActivityReadStatusCache.markAsReadOptimistic(activityId)
  }, [activityId])

  const markAsUnread = useCallback(() => {
    setLocalIsRead(false)
    setHasPendingUpdate(true)
    ActivityReadStatusCache.markAsUnreadOptimistic(activityId)
  }, [activityId])

  // Mettre à jour quand l'état initial change
  useEffect(() => {
    const cachedStatus = ActivityReadStatusCache.getReadStatus(activityId)
    if (cachedStatus === null) {
      setLocalIsRead(initialIsRead)
      setHasPendingUpdate(false)
    }
  }, [activityId, initialIsRead])

  return {
    isRead: localIsRead,
    markAsRead,
    markAsUnread,
    hasPendingUpdate
  }
}

================
File: lib/hooks/useOptimisticReadStatus.ts
================
import { useState, useEffect, useCallback } from 'react'
import { ReadStatusCache } from '@/lib/services/read-status-cache'

interface UseOptimisticReadStatusReturn {
  isRead: boolean
  markAsRead: () => void
  markAsUnread: () => void
  hasPendingUpdate: boolean
}

export function useOptimisticReadStatus(
  dossierId: string,
  initialIsRead: boolean
): UseOptimisticReadStatusReturn {
  const [localIsRead, setLocalIsRead] = useState(initialIsRead)
  const [hasPendingUpdate, setHasPendingUpdate] = useState(false)

  // Vérifier le cache au montage et écouter les synchronisations
  useEffect(() => {
    const updateFromCache = () => {
      const cachedStatus = ReadStatusCache.getReadStatus(dossierId)
      const hasPending = ReadStatusCache.hasPendingUpdates(dossierId)
      
      if (cachedStatus !== null) {
        setLocalIsRead(cachedStatus)
      }
      setHasPendingUpdate(hasPending)
    }

    // Mise à jour initiale
    updateFromCache()

    // Écouter les synchronisations
    const unsubscribe = ReadStatusCache.onSync(updateFromCache)

    return unsubscribe
  }, [dossierId])

  // Mise à jour optimiste
  const markAsRead = useCallback(() => {
    setLocalIsRead(true)
    setHasPendingUpdate(true)
    ReadStatusCache.markAsReadOptimistic(dossierId)
  }, [dossierId])

  const markAsUnread = useCallback(() => {
    setLocalIsRead(false)
    setHasPendingUpdate(true)
    ReadStatusCache.markAsUnreadOptimistic(dossierId)
  }, [dossierId])

  // Mettre à jour quand l'état initial change
  useEffect(() => {
    const cachedStatus = ReadStatusCache.getReadStatus(dossierId)
    if (cachedStatus === null) {
      setLocalIsRead(initialIsRead)
      setHasPendingUpdate(false)
    }
  }, [dossierId, initialIsRead])

  return {
    isRead: localIsRead,
    markAsRead,
    markAsUnread,
    hasPendingUpdate
  }
}

================
File: lib/hooks/useTheme.ts
================
/**
 * 🎨 HOOK CUSTOM POUR LA GESTION DU DARK MODE
 * 
 * Ce hook centralise toute la logique de gestion du mode sombre (dark mode).
 * Il gère la persistance via localStorage et la synchronisation avec la classe CSS.
 * 
 * @module lib/hooks/useTheme
 */

'use client';

import { useState, useEffect } from 'react';

interface UseThemeReturn {
  darkMode: boolean;
  isInitialized: boolean;
  toggleDarkMode: (newMode: boolean) => void;
}

/**
 * Hook pour gérer le dark mode de façon centralisée
 * 
 * @returns {UseThemeReturn} État et fonctions du dark mode
 * 
 * @example
 * const { darkMode, isInitialized, toggleDarkMode } = useTheme();
 * 
 * // Pour activer le dark mode
 * toggleDarkMode(true);
 * 
 * // Pour désactiver le dark mode
 * toggleDarkMode(false);
 */
export function useTheme(): UseThemeReturn {
  const [darkMode, setDarkMode] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);

  // Initialisation : lecture du localStorage et application du mode
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      setDarkMode(savedDarkMode);
      
      // Applique la classe 'dark' au document
      document.documentElement.classList.toggle('dark', savedDarkMode);
      
      setIsInitialized(true);
    }
  }, []);

  /**
   * Toggle le dark mode
   * Synchronise l'état, le localStorage et la classe CSS
   */
  const toggleDarkMode = (newMode: boolean) => {
    setDarkMode(newMode);
    
    if (typeof window !== 'undefined') {
      // Met à jour la classe CSS
      document.documentElement.classList.toggle('dark', newMode);
      
      // Persiste dans localStorage
      localStorage.setItem('darkMode', String(newMode));
    }
  };

  return { darkMode, isInitialized, toggleDarkMode };
}

================
File: lib/services/activities.ts
================
import { supabase } from '@/lib/supabase'
import { Database } from '@/types/supabase'

type Activity = Database['public']['Tables']['activities']['Row']
type ActivityInsert = Database['public']['Tables']['activities']['Insert']
type ActivityUpdate = Database['public']['Tables']['activities']['Update']

export class ActivitiesService {
  /**
   * Récupère toutes les activités avec les informations jointes
   */
  static async getAllActivities(brokerId?: string) {
    const { data, error } = await supabase
      .from('activities_view')
      .select('*')
      .order('created_at', { ascending: false })

    if (error) {
      console.error('Erreur lors de la récupération des activités:', error)
      throw error
    }

    return data
  }

  /**
   * Récupère les activités d'un utilisateur spécifique
   */
  static async getActivitiesByUserId(userId: string) {
    const { data, error } = await supabase
      .from('activities_view')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('Erreur lors de la récupération des activités utilisateur:', error)
      throw error
    }

    return data
  }

  /**
   * Récupère les activités d'un dossier spécifique
   */
  static async getActivitiesByDossierId(dossierId: string) {
    const { data, error } = await supabase
      .from('activities_view')
      .select('*')
      .eq('dossier_id', dossierId)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('Erreur lors de la récupération des activités du dossier:', error)
      throw error
    }

    return data
  }

  /**
   * Récupère les activités non lues d'un utilisateur
   */
  static async getUnreadActivitiesByUserId(userId: string) {
    const { data, error } = await supabase
      .from('activities_view')
      .select('*')
      .eq('user_id', userId)
      .eq('is_read', false)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('Erreur lors de la récupération des activités non lues:', error)
      throw error
    }

    return data
  }

  /**
   * Crée une nouvelle activité
   */
  static async createActivity(activityData: ActivityInsert) {
    const { data, error } = await supabase
      .from('activities')
      .insert(activityData)
      .select()
      .single()

    if (error) {
      console.error('Erreur lors de la création de l\'activité:', error)
      throw error
    }

    return data
  }

  /**
   * Marque une activité comme lue
   */
  static async markActivityAsRead(activityId: string) {
    const { data, error } = await supabase
      .from('activities')
      .update({ is_read: true })
      .eq('id', activityId)
      .select()
      .single()

    if (error) {
      console.error('Erreur lors du marquage de l\'activité comme lue:', error)
      throw error
    }

    return data
  }

  /**
   * Marque toutes les activités d'un utilisateur comme lues
   */
  static async markAllActivitiesAsRead(userId: string) {
    const { error } = await supabase
      .from('activities')
      .update({ is_read: true })
      .eq('user_id', userId)
      .eq('is_read', false)

    if (error) {
      console.error('Erreur lors du marquage de toutes les activités comme lues:', error)
      throw error
    }

    return true
  }

  /**
   * Supprime une activité
   */
  static async deleteActivity(activityId: string) {
    const { error } = await supabase
      .from('activities')
      .delete()
      .eq('id', activityId)

    if (error) {
      console.error('Erreur lors de la suppression de l\'activité:', error)
      throw error
    }

    return true
  }

  /**
   * Crée une activité de type "dossier créé"
   */
  static async createDossierCreatedActivity(
    userId: string,
    dossierId: string,
    numeroDossier: string,
    typeDossier: string
  ) {
    return this.createActivity({
      user_id: userId,
      dossier_id: dossierId,
      activity_type: 'dossier_created',
      activity_title: 'Nouveau dossier créé',
      activity_description: `Le dossier ${numeroDossier} (${typeDossier}) a été créé avec succès.`,
      activity_data: {
        dossier_numero: numeroDossier,
        type_dossier: typeDossier,
        action: 'created'
      }
    })
  }

  /**
   * Crée une activité de type "dossier attribué"
   */
  static async createDossierAttribueActivity(
    userId: string,
    dossierId: string,
    numeroDossier: string
  ) {
    return this.createActivity({
      user_id: userId,
      dossier_id: dossierId,
      activity_type: 'dossier_attribue',
      activity_title: 'Dossier attribué',
      activity_description: `Un nouveau dossier ${numeroDossier} vous a été attribué par l'administrateur.`,
      activity_data: {
        dossier_numero: numeroDossier,
        created_by_admin: true,
        action: 'dossier_attribue'
      }
    })
  }

  /**
   * Crée une activité de type "devis envoyé" (VERSION FRANÇAISE)
   */
  static async createDevisEnvoyeActivity(
    userId: string,
    dossierId: string,
    numeroDossier: string,
    numeroDevis: string
  ) {
    return this.createActivity({
      user_id: userId,
      dossier_id: dossierId,
      activity_type: 'devis_envoye',
      activity_title: 'Devis envoyé',
      activity_description: `Le devis ${numeroDevis} du dossier ${numeroDossier} a été envoyé au client.`,
      activity_data: {
        dossier_numero: numeroDossier,
        devis_numero: numeroDevis,
        action: 'devis_envoye'
      }
    })
  }

  /**
   * Crée une activité de type "devis accepté" (VERSION FRANÇAISE)
   */
  static async createDevisAccepteActivity(
    userId: string,
    dossierId: string,
    numeroDossier: string,
    numeroDevis: string
  ) {
    return this.createActivity({
      user_id: userId,
      dossier_id: dossierId,
      activity_type: 'devis_accepte',
      activity_title: 'Devis accepté',
      activity_description: `Le devis ${numeroDevis} du dossier ${numeroDossier} a été accepté par le client.`,
      activity_data: {
        dossier_numero: numeroDossier,
        devis_numero: numeroDevis,
        action: 'devis_accepte'
      }
    })
  }

  /**
   * Crée une activité de type "dossier finalisé"
   */
  static async createDossierFinaliseActivity(
    userId: string,
    dossierId: string,
    numeroDossier: string
  ) {
    return this.createActivity({
      user_id: userId,
      dossier_id: dossierId,
      activity_type: 'dossier_finalise',
      activity_title: 'Dossier finalisé',
      activity_description: `Le dossier ${numeroDossier} a été finalisé avec succès.`,
      activity_data: {
        dossier_numero: numeroDossier,
        action: 'dossier_finalise'
      }
    })
  }

  /**
   * Crée une activité de type "dossier supprimé"
   */
  static async createDossierSupprimeActivity(
    userId: string,
    dossierId: string,
    numeroDossier: string
  ) {
    return this.createActivity({
      user_id: userId,
      dossier_id: dossierId,
      activity_type: 'dossier_supprime',
      activity_title: 'Dossier supprimé',
      activity_description: `Le dossier ${numeroDossier} a été supprimé par l'administrateur.`,
      activity_data: {
        dossier_numero: numeroDossier,
        deleted_by: 'admin',
        action: 'dossier_supprime'
      }
    })
  }

  /**
   * Crée une activité de type "statut mis à jour"
   */
  static async createStatusUpdatedActivity(
    userId: string,
    dossierId: string,
    numeroDossier: string,
    ancienStatut: string,
    nouveauStatut: string
  ) {
    return this.createActivity({
      user_id: userId,
      dossier_id: dossierId,
      activity_type: 'status_updated',
      activity_title: 'Statut mis à jour',
      activity_description: `Le statut du dossier ${numeroDossier} a été modifié de "${ancienStatut}" vers "${nouveauStatut}".`,
      activity_data: {
        dossier_numero: numeroDossier,
        ancien_statut: ancienStatut,
        nouveau_statut: nouveauStatut,
        action: 'status_updated'
      }
    })
  }

  /**
   * Récupère les statistiques des activités
   */
  static async getActivityStats(userId?: string, brokerId?: string) {
    let query = supabase
      .from('activities')
      .select('activity_type, is_read, created_at')

    if (userId) {
      query = query.eq('user_id', userId)
    }

    const { data, error } = await query

    if (error) {
      console.error('Erreur lors de la récupération des statistiques d\'activités:', error)
      throw error
    }

    const stats = {
      total: data.length,
      nonLues: 0,
      parType: {} as Record<string, number>,
      parMois: {} as Record<string, number>
    }

    data.forEach(activity => {
      // Compter les non lues
      if (!activity.is_read) {
        stats.nonLues++
      }

      // Compter par type
      stats.parType[activity.activity_type] = (stats.parType[activity.activity_type] || 0) + 1

      // Compter par mois
      if (activity.created_at) {
        const month = new Date(activity.created_at).toISOString().slice(0, 7)
        stats.parMois[month] = (stats.parMois[month] || 0) + 1
      }
    })

    return stats
  }

  /**
   * S'abonne aux nouvelles activités en temps réel
   */
  static subscribeToActivities(userId: string, callback: (payload: any) => void) {
    const channel = supabase
      .channel('activities_channel')
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'activities',
          filter: `user_id=eq.${userId}`
        },
        callback
      )
      .subscribe()

    return channel
  }

  /**
   * Se désabonne des activités en temps réel
   */
  static unsubscribeFromActivities(channel: any) {
    supabase.removeChannel(channel)
  }

  /**
   * Récupère les notifications filtrées pour un APPORTEUR
   * N'affiche QUE les actions faites par l'admin ou le système
   */
  static async getNotificationsForApporteur(userId: string, limit: number = 10) {
    const { data, error } = await supabase
      .from('activities_view')
      .select('*')
      .eq('user_id', userId)
      .in('activity_type', ['dossier_attribue', 'dossier_supprime', 'classement_updated'])
      .order('created_at', { ascending: false })
      .limit(limit)

    if (error) {
      console.error('Erreur lors de la récupération des notifications apporteur:', error)
      throw error
    }

    return data
  }

  /**
   * Récupère les notifications filtrées pour un ADMIN
   * N'affiche QUE les actions faites par les apporteurs
   */
  static async getNotificationsForAdmin(limit: number = 10, brokerId?: string) {
    const { data, error } = await supabase
      .from('activities_view')
      .select('*')
      .in('activity_type', ['dossier_created', 'devis_accepte', 'devis_refuse', 'dossier_finalise'])
      .order('created_at', { ascending: false })
      .limit(limit)

    if (error) {
      console.error('Erreur lors de la récupération des notifications admin:', error)
      throw error
    }

    return data
  }

  /**
   * Récupère les activités avec pagination
   */
  static async getActivitiesByUserIdPaginated(
    userId: string,
    limit: number = 20,
    offset: number = 0
  ) {
    const { data, error } = await supabase
      .from('activities_view')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .range(offset, offset + limit - 1)

    if (error) {
      console.error('Erreur lors de la récupération des activités paginées:', error)
      throw error
    }

    return data
  }

  /**
   * Récupère toutes les activités avec pagination (pour admin)
   */
  static async getAllActivitiesPaginated(
    limit: number = 20,
    offset: number = 0,
    brokerId?: string
  ) {
    const { data, error } = await supabase
      .from('activities_view')
      .select('*')
      .order('created_at', { ascending: false })
      .range(offset, offset + limit - 1)

    if (error) {
      console.error('Erreur lors de la récupération de toutes les activités paginées:', error)
      throw error
    }

    return data
  }

  /**
   * Compte le nombre total d'activités d'un utilisateur
   */
  static async countActivitiesByUserId(userId: string) {
    const { count, error } = await supabase
      .from('activities')
      .select('*', { count: 'exact', head: true })
      .eq('user_id', userId)

    if (error) {
      console.error('Erreur lors du comptage des activités:', error)
      throw error
    }

    return count || 0
  }

  /**
   * Compte le nombre total d'activités (pour admin)
   */
  static async countAllActivities(brokerId?: string) {
    const { count, error } = await supabase
      .from('activities')
      .select('*', { count: 'exact', head: true })

    if (error) {
      console.error('Erreur lors du comptage de toutes les activités:', error)
      throw error
    }

    return count || 0
  }
}

================
File: lib/services/activity-read-status-cache.ts
================
interface PendingUpdate {
  activityId: string;
  isRead: boolean;
  timestamp: number;
}

interface OverrideEntry {
  isRead: boolean;
  timestamp: number;
}

interface CacheData {
  pendingUpdates: PendingUpdate[];
  overrides: Record<string, OverrideEntry>;
  lastSync: number;
}

export class ActivityReadStatusCache {
  private static readonly STORAGE_KEY = 'activity_read_status_cache';
  private static readonly SYNC_INTERVAL = 2000; // 2 secondes
  private static readonly BATCH_SIZE = 10;
  private static readonly OVERRIDE_TTL_MS = 24 * 60 * 60 * 1000; // 24h
  private static syncTimeout: NodeJS.Timeout | null = null;
  private static syncCallbacks: Set<() => void> = new Set();

  /**
   * Marque une activité comme lue de manière optimiste
   */
  static markAsReadOptimistic(activityId: string): void {
    // Ajouter à la queue locale
    this.addPendingUpdate(activityId, true);
    this.setOverride(activityId, true);
    
    // Démarrer la synchronisation en arrière-plan
    this.scheduleSync();
  }

  /**
   * Marque une activité comme non lue de manière optimiste
   */
  static markAsUnreadOptimistic(activityId: string): void {
    this.addPendingUpdate(activityId, false);
    this.setOverride(activityId, false);
    this.scheduleSync();
  }

  /**
   * Récupère l'état de lecture depuis le cache local
   */
  static getReadStatus(activityId: string): boolean | null {
    const cache = this.getCache();
    // 1) Priorité aux overrides locaux (persiste même après refresh)
    const override = cache.overrides[activityId];
    if (override) {
      return override.isRead;
    }
    const pendingUpdate = cache.pendingUpdates.find(update => update.activityId === activityId);
    
    if (pendingUpdate) {
      return pendingUpdate.isRead;
    }
    
    return null; // Pas dans le cache, utiliser l'état de la DB
  }

  /**
   * Vérifie si une activité a des mises à jour en attente
   */
  static hasPendingUpdates(activityId: string): boolean {
    const cache = this.getCache();
    return cache.pendingUpdates.some(update => update.activityId === activityId);
  }

  /**
   * Ajoute une mise à jour à la queue
   */
  private static addPendingUpdate(activityId: string, isRead: boolean): void {
    const cache = this.getCache();
    
    // Supprimer les anciennes mises à jour pour cette activité
    cache.pendingUpdates = cache.pendingUpdates.filter(update => update.activityId !== activityId);
    
    // Ajouter la nouvelle mise à jour
    cache.pendingUpdates.push({
      activityId,
      isRead,
      timestamp: Date.now()
    });
    
    this.saveCache(cache);
  }

  /**
   * Définit/écrase un override local
   */
  private static setOverride(activityId: string, isRead: boolean): void {
    const cache = this.getCache();
    cache.overrides[activityId] = { isRead, timestamp: Date.now() };
    this.saveCache(cache);
  }

  /**
   * Planifie une synchronisation
   */
  private static scheduleSync(): void {
    if (this.syncTimeout) {
      clearTimeout(this.syncTimeout);
    }
    
    this.syncTimeout = setTimeout(() => {
      this.syncWithDatabase();
    }, this.SYNC_INTERVAL);
  }

  /**
   * Synchronise avec la base de données
   */
  private static async syncWithDatabase(): Promise<void> {
    const cache = this.getCache();
    
    if (cache.pendingUpdates.length === 0) {
      return;
    }

    try {
      // Traiter par batch
      const batches = this.chunkArray(cache.pendingUpdates, this.BATCH_SIZE);
      
      for (const batch of batches) {
        await this.processBatch(batch);
      }
      
      // Marquer comme synchronisé
      cache.lastSync = Date.now();
      cache.pendingUpdates = [];
      this.saveCache(cache);
      
      // Notifier les callbacks de synchronisation
      this.syncCallbacks.forEach(callback => callback());
      
    } catch (error) {
      console.error('Erreur lors de la synchronisation des activités:', error);
      // Garder les mises à jour en attente pour un retry
    }
  }

  /**
   * Traite un batch de mises à jour
   */
  private static async processBatch(batch: PendingUpdate[]): Promise<void> {
    const { supabase } = await import('@/lib/supabase');
    
    // Grouper par état
    const readIds = batch.filter(update => update.isRead).map(update => update.activityId);
    const unreadIds = batch.filter(update => !update.isRead).map(update => update.activityId);
    
    // Mettre à jour les lues
    if (readIds.length > 0) {
      const { error: readError } = await supabase
        .from('activities')
        .update({ is_read: true })
        .in('id', readIds);
        
      if (readError) throw readError;
    }
    
    // Mettre à jour les non lues
    if (unreadIds.length > 0) {
      const { error: unreadError } = await supabase
        .from('activities')
        .update({ is_read: false })
        .in('id', unreadIds);
        
      if (unreadError) throw unreadError;
    }
  }

  /**
   * Divise un tableau en chunks
   */
  private static chunkArray<T>(array: T[], size: number): T[][] {
    const chunks: T[][] = [];
    for (let i = 0; i < array.length; i += size) {
      chunks.push(array.slice(i, i + size));
    }
    return chunks;
  }

  /**
   * Récupère le cache depuis localStorage
   */
  private static getCache(): CacheData {
    try {
      const stored = localStorage.getItem(this.STORAGE_KEY);
      const cache: CacheData = stored ? JSON.parse(stored) : { pendingUpdates: [], overrides: {}, lastSync: 0 };
      // Nettoyer les overrides trop anciens
      const now = Date.now();
      const overrides: Record<string, OverrideEntry> = {};
      for (const [id, entry] of Object.entries(cache.overrides || {})) {
        if (now - entry.timestamp < this.OVERRIDE_TTL_MS) {
          overrides[id] = entry;
        }
      }
      cache.overrides = overrides;
      return cache;
    } catch {
      return { pendingUpdates: [], overrides: {}, lastSync: 0 };
    }
  }

  /**
   * Sauvegarde le cache dans localStorage
   */
  private static saveCache(cache: CacheData): void {
    try {
      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(cache));
    } catch (error) {
      console.error('Erreur lors de la sauvegarde du cache activités:', error);
    }
  }

  /**
   * Force la synchronisation immédiate
   */
  static async forceSync(): Promise<void> {
    if (this.syncTimeout) {
      clearTimeout(this.syncTimeout);
    }
    await this.syncWithDatabase();
  }

  /**
   * Nettoie le cache (pour les tests)
   */
  static clearCache(): void {
    localStorage.removeItem(this.STORAGE_KEY);
  }

  /**
   * Ajoute un callback de synchronisation
   */
  static onSync(callback: () => void): () => void {
    this.syncCallbacks.add(callback);
    return () => this.syncCallbacks.delete(callback);
  }
}

================
File: lib/services/apporteurs.ts
================
import { supabase } from '@/lib/supabase'
import { Database } from '@/types/supabase'

type ApporteurProfile = Database['public']['Tables']['apporteur_profiles']['Row']
type ApporteurProfileInsert = Database['public']['Tables']['apporteur_profiles']['Insert']
type ApporteurProfileUpdate = Database['public']['Tables']['apporteur_profiles']['Update']

export class ApporteursService {
  /**
   * Récupère tous les apporteurs liés au broker de l'utilisateur avec leurs statistiques
   * ✅ Utilise statut_canon (source de vérité unique)
   * ✅ Filtre via broker_apporteurs pour le broker_id
   */
  static async getAllApporteurs(brokerId?: string) {
    // Si pas de brokerId fourni, récupérer via le contexte de l'utilisateur
    if (!brokerId) {
      // Récupérer le broker de l'utilisateur connecté
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        console.error('Utilisateur non connecté')
        return []
      }
      
      // Vérifier si c'est un courtier
      const { data: brokerUser } = await supabase
        .from('broker_users')
        .select('broker_id')
        .eq('user_id', user.id)
        .single()
      
      if (brokerUser) {
        brokerId = brokerUser.broker_id
      }
    }
    
    if (!brokerId) {
      console.error('Aucun broker_id trouvé')
      return []
    }
    
    // Récupérer les apporteurs liés à ce broker
    const { data: brokerApporteurs, error: baError } = await supabase
      .from('broker_apporteurs')
      .select('apporteur_profile_id')
      .eq('broker_id', brokerId)
    
    if (baError) {
      console.error('Erreur lors de la récupération des liens broker-apporteurs:', baError)
      throw baError
    }
    
    const apporteurIds = brokerApporteurs?.map(ba => ba.apporteur_profile_id) || []
    
    if (apporteurIds.length === 0) {
      return []
    }
    
    // Récupérer les profils des apporteurs
    const { data, error } = await supabase
      .from('apporteur_profiles')
      .select(`
        *,
        dossiers (
          id,
          statut:statut_canon,
          date_creation,
          economie_generee
        )
      `)
      .in('id', apporteurIds)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('Erreur lors de la récupération des apporteurs:', error)
      throw error
    }

    return data
  }

  /**
   * Récupère un apporteur par son ID
   * ✅ Utilise statut_canon (source de vérité unique)
   */
  static async getApporteurById(id: string, brokerId?: string) {
    const { data, error } = await supabase
      .from('apporteur_profiles')
      .select(`
        *,
        dossiers (
          id,
          numero_dossier,
          statut:statut_canon,
          date_creation,
          is_couple,
          type_dossier,
          economie_generee,
          client_infos (
            client_prenom,
            client_nom
          ),
          pret_data (
            montant_capital,
            type_pret
          )
        )
      `)
      .eq('id', id)
      .single()

    if (error) {
      console.error('Erreur lors de la récupération de l\'apporteur:', error)
      throw error
    }

    return data
  }

  /**
   * Crée un nouveau profil apporteur
   */
  static async createApporteur(apporteur: ApporteurProfileInsert) {
    const { data, error } = await supabase
      .from('apporteur_profiles')
      .insert(apporteur)
      .select()
      .single()

    if (error) {
      console.error('Erreur lors de la création de l\'apporteur:', error)
      throw error
    }

    return data
  }

  /**
   * Met à jour un profil apporteur
   */
  static async updateApporteur(id: string, updates: ApporteurProfileUpdate) {
    const { data, error } = await supabase
      .from('apporteur_profiles')
      .update(updates)
      .eq('id', id)
      .select()
      .single()

    if (error) {
      console.error('Erreur lors de la mise à jour de l\'apporteur:', error)
      throw error
    }

    return data
  }

  /**
   * Supprime un profil apporteur (détache ses dossiers)
   */
  static async deleteApporteur(id: string) {
    try {
      // 1. Détacher les dossiers de l'apporteur (ils restent visibles admin)
      const { error: dossiersError } = await supabase
        .from('dossiers')
        .update({ apporteur_id: null })
        .eq('apporteur_id', id)

      if (dossiersError) throw dossiersError

      // 2. Supprimer le profil apporteur
      const { error: deleteError } = await supabase
        .from('apporteur_profiles')
        .delete()
        .eq('id', id)

      if (deleteError) throw deleteError

      // TODO: Une fois auth implémenté, supprimer aussi de auth.users
      // await supabase.auth.admin.deleteUser(user_id)
    } catch (error) {
      console.error('Erreur lors de la suppression de l\'apporteur:', error)
      throw error
    }
  }

  /**
   * DÉTERMINE SI UN APPORTEUR EST INACTIF
   * Un apporteur est considéré inactif si :
   * - Il ne s'est pas connecté depuis 2 mois OU
   * - Il n'a pas déposé de dossier depuis 2 mois
   * 
   * @param lastLoginAt - Date de dernière connexion
   * @param dossiers - Liste des dossiers de l'apporteur
   * @returns true si l'apporteur doit être marqué comme inactif
   */
  static isApporteurInactif(lastLoginAt: string | null, dossiers: any[]): boolean {
    const deuxMoisEnMs = 60 * 24 * 60 * 60 * 1000; // 60 jours en millisecondes
    const maintenant = new Date().getTime();

    // Vérifier la dernière connexion
    const derniereConnexion = lastLoginAt ? new Date(lastLoginAt).getTime() : 0;
    const inactifConnexion = maintenant - derniereConnexion > deuxMoisEnMs;

    // Vérifier le dernier dossier déposé
    let inactifDossier = true;
    if (dossiers.length > 0) {
      const dossiersTries = [...dossiers].sort((a, b) =>
        new Date(b.date_creation).getTime() - new Date(a.date_creation).getTime()
      );
      const dernierDossier = dossiersTries[0];
      const dateDernierDossier = new Date(dernierDossier.date_creation).getTime();
      inactifDossier = maintenant - dateDernierDossier > deuxMoisEnMs;
    }

    // Inactif si AUCUNE activité (connexion OU dépôt de dossier) depuis 2 mois
    return inactifConnexion && inactifDossier;
  }

  /**
   * MÉTHODE CENTRALISÉE DE CALCUL DES STATISTIQUES D'UN APPORTEUR
   * Cette méthode unique assure la cohérence entre la page liste et la page détail
   * 
   * ⚠️ IMPORTANT : Les dossiers doivent avoir le champ 'statut' provenant de 'statut_canon'
   * 
   * @param dossiers - Liste des dossiers de l'apporteur (avec statut = statut_canon)
   * @returns Statistiques calculées de manière standardisée
   */
  static calculateApporteurStats(dossiers: any[]) {
    const totalDossiers = dossiers.length;

    // ✅ Utilise les fonctions de validation de l'utilitaire centralisé
    // Dossiers validés = finalise OU devis_accepte
    const dossiersValides = dossiers.filter((d: any) =>
      d.statut === 'finalise' || d.statut === 'devis_accepte'
    );

    // Dossiers finalisés = uniquement ceux avec statut 'finalise'
    const dossiersFinalises = dossiers.filter((d: any) =>
      d.statut === 'finalise'
    );

    // Économies générées = somme des economie_generee des dossiers finalisés uniquement
    const economiesGenerees = dossiersFinalises.reduce(
      (sum: number, d: any) => sum + Number(d.economie_generee || 0),
      0
    );

    // Taux de conversion = (dossiers validés / total dossiers) * 100
    const tauxConversion = totalDossiers > 0
      ? Number(((dossiersValides.length / totalDossiers) * 100).toFixed(1))
      : 0;

    return {
      totalDossiers,
      dossiersValides: dossiersValides.length,
      dossiersFinalises: dossiersFinalises.length,
      economiesGenerees,
      tauxConversion
    };
  }

  /**
   * Récupère les statistiques d'un apporteur avec classement réel
   * ✅ Utilise statut_canon (source de vérité unique)
   */
  static async getApporteurStats(apporteurId: string, brokerId?: string) {
    console.log('🔍 getApporteurStats - Apporteur ID:', apporteurId);

    try {
      // Récupérer les dossiers de l'apporteur avec statut_canon
      const { data: apporteurData, error: apporteurError } = await supabase
        .from('apporteur_profiles')
        .select(`
          id,
          dossiers (
            id,
            statut:statut_canon,
            economie_generee
          )
        `)
        .eq('id', apporteurId)
        .single();

      if (apporteurError) {
        console.error('❌ Erreur lors de la récupération de l\'apporteur:', apporteurError);
        throw apporteurError;
      }

      const dossiers = apporteurData?.dossiers || [];

      // Utiliser la méthode centralisée de calcul
      const stats = this.calculateApporteurStats(dossiers);

      // Récupérer le classement via RPC
      const { data: rankingData, error: rankingError } = await supabase
        .rpc('get_apporteur_ranking');

      let classement = 0;
      let progressionClassement = 'Non classé';
      let totalApporteurs = 0;

      if (!rankingError && rankingData) {
        totalApporteurs = rankingData.length;
        const apporteurRank = rankingData.find((a: any) => a.apporteur_id === apporteurId);

        if (apporteurRank) {
          classement = Number(apporteurRank.classement);
          progressionClassement = classement <= 3
            ? `Top ${classement}`
            : `#${classement}`;
        }
      }

      console.log('✅ getApporteurStats - Stats calculées (méthode centralisée):', stats);

      return {
        totalDossiers: stats.totalDossiers,
        dossiersFinalises: stats.dossiersFinalises,
        dossiersValides: stats.dossiersValides,
        economiesGenerees: stats.economiesGenerees,
        tauxConversion: stats.tauxConversion,
        classement,
        progressionDossiers: 0, // À calculer si nécessaire
        progressionEconomies: 0, // À calculer si nécessaire
        progressionClassement,
        totalApporteurs
      };
    } catch (error) {
      console.error('❌ getApporteurStats - Erreur détaillée:', error);
      throw error;
    }
  }

  /**
   * Récupère le classement complet de tous les apporteurs
   */
  static async getFullRanking(brokerId?: string) {
    console.log('🏆 getFullRanking - Récupération du classement complet');

    try {
      const { data, error } = await supabase
        .rpc('get_apporteur_ranking');

      if (error) {
        console.error('❌ Erreur lors de la récupération du classement:', error);
        throw error;
      }

      console.log('📊 getFullRanking - Classement récupéré:', data?.length, 'apporteurs');

      return data || [];
    } catch (error) {
      console.error('❌ getFullRanking - Erreur détaillée:', error);
      throw error;
    }
  }

  /**
   * Récupère la performance mensuelle détaillée d'un apporteur
   * @param apporteurId - ID de l'apporteur
   * @param months - Nombre de mois à récupérer (par défaut 24)
   */
  static async getMonthlyPerformance(apporteurId: string, months: number = 24, brokerId?: string) {
    try {
      const { data, error } = await supabase
        .from('dossiers')
        .select(`
          id,
          date_creation,
          statut_canon,
          economie_generee,
          montant_capital
        `)
        .eq('apporteur_id', apporteurId)
        .order('date_creation', { ascending: false })

      if (error) throw error

      // Grouper par mois
      const monthlyData: Record<string, any> = {}

      data.forEach((dossier: any) => {
        const date = new Date(dossier.date_creation)
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`
        const monthDisplay = date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' })

        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = {
            month: monthDisplay,
            monthKey,
            dossiers_traites: 0,
            dossiers_valides: 0,
            economies_generees: 0
          }
        }

        monthlyData[monthKey].dossiers_traites++
        if (['finalise', 'devis_accepte'].includes(dossier.statut_canon)) {
          monthlyData[monthKey].dossiers_valides++
        }
        monthlyData[monthKey].economies_generees += Number(dossier.economie_generee || 0)
      })

      // Trier par date décroissante et limiter au nombre de mois demandé
      return Object.values(monthlyData)
        .sort((a: any, b: any) => b.monthKey.localeCompare(a.monthKey))
        .slice(0, months)
    } catch (error) {
      console.error('Erreur lors de la récupération de la performance mensuelle:', error)
      throw error
    }
  }

  /**
   * Suspend un apporteur
   * @param id - ID de l'apporteur
   * @param raison - Raison de la suspension
   */
  static async suspendApporteur(id: string, raison: string) {
    try {
      // 1. Mettre à jour le statut
      const { data, error } = await supabase
        .from('apporteur_profiles')
        .update({
          statut: 'suspendu',
          updated_at: new Date().toISOString()
        })
        .eq('id', id)
        .select()
        .single()

      if (error) throw error

      // 2. Créer une activité pour traçabilité
      await supabase.from('activities').insert({
        user_id: id,
        activity_type: 'compte_suspendu',
        activity_title: 'Compte suspendu',
        activity_description: `Votre compte a été suspendu. Raison: ${raison}`,
        activity_data: { raison, date_suspension: new Date().toISOString() }
      })

      // TODO: Une fois Resend intégré, envoyer un email de notification
      // await sendSuspensionEmail(data.email, data.prenom, data.nom, raison)

      return data
    } catch (error) {
      console.error('Erreur lors de la suspension de l\'apporteur:', error)
      throw error
    }
  }

  /**
   * Réactive un apporteur suspendu
   * @param id - ID de l'apporteur
   */
  static async reactivateApporteur(id: string) {
    try {
      // 1. Mettre à jour le statut
      const { data, error } = await supabase
        .from('apporteur_profiles')
        .update({
          statut: 'actif',
          updated_at: new Date().toISOString()
        })
        .eq('id', id)
        .select()
        .single()

      if (error) throw error

      // 2. Créer une activité pour traçabilité
      await supabase.from('activities').insert({
        user_id: id,
        activity_type: 'compte_reactive',
        activity_title: 'Compte réactivé',
        activity_description: 'Votre compte a été réactivé avec succès. Vous pouvez maintenant soumettre de nouveaux dossiers.',
        activity_data: { date_reactivation: new Date().toISOString() }
      })

      // TODO: Une fois Resend intégré, envoyer un email de notification
      // await sendReactivationEmail(data.email, data.prenom, data.nom)

      return data
    } catch (error) {
      console.error('Erreur lors de la réactivation de l\'apporteur:', error)
      throw error
    }
  }

  /**
   * Récupère les statistiques des apporteurs pour le dashboard admin
   * ✅ Calcule les nouveaux apporteurs du mois en cours
   */
  static async getApporteursDashboardStats(brokerId?: string) {
    const { data: apporteurs, error } = await supabase
      .from('apporteur_profiles')
      .select('id, statut, created_at')

    if (error) {
      console.error('Erreur lors de la récupération des stats apporteurs:', error)
      throw error
    }

    const now = new Date()
    const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1)

    const totalApporteurs = apporteurs.length
    const apporteursActifs = apporteurs.filter((a: any) => a.statut === 'actif').length
    const nouveauxApporteursCeMois = apporteurs.filter((a: any) => {
      const dateCreation = new Date(a.created_at)
      return dateCreation >= currentMonthStart
    }).length

    return {
      totalApporteurs,
      apporteursActifs,
      nouveauxApporteursCeMois
    }
  }
}

================
File: lib/services/client-infos.ts
================
import { supabase } from '@/lib/supabase'
import { Database } from '@/types/supabase'

type ClientInfo = Database['public']['Tables']['client_infos']['Row']
type ClientInfoInsert = Database['public']['Tables']['client_infos']['Insert']
type ClientInfoUpdate = Database['public']['Tables']['client_infos']['Update']

export class ClientInfosService {
  /**
   * Récupère les informations client d'un dossier
   */
  static async getClientInfoByDossierId(dossierId: string) {
    const { data, error } = await supabase
      .from('client_infos')
      .select('*')
      .eq('dossier_id', dossierId)
      .single()

    if (error) {
      console.error('Erreur lors de la récupération des infos client:', error)
      throw error
    }

    return data
  }

  /**
   * Crée ou met à jour les informations client
   */
  static async upsertClientInfo(clientData: ClientInfoInsert) {
    console.log('═══════════════════════════════════════════')
    console.log('[ClientInfosService.upsert] 🔄 DÉBUT UPSERT')
    
    // Logs de contexte
    const { data: authUser } = await supabase.auth.getUser()
    console.log('[ClientInfosService.upsert] User ID:', authUser?.user?.id)
    console.log('[ClientInfosService.upsert] Dossier ID:', clientData.dossier_id)
    console.log('[ClientInfosService.upsert] Payload:', JSON.stringify(clientData, null, 2))
    console.log('[ClientInfosService.upsert] Nombre de champs:', Object.keys(clientData).length)

    // Certains environnements n'ont pas de contrainte unique sur dossier_id.
    // Éviter .single()/maybeSingle() qui peuvent retourner 406 s'il y a des doublons.
    console.log('[ClientInfosService.upsert] 🔍 Vérification existence...')
    const { data: rows, error: selectError } = await supabase
      .from('client_infos')
      .select('id')
      .eq('dossier_id', clientData.dossier_id as string)
      .order('updated_at', { ascending: false })
      .limit(1)

    if (selectError) {
      console.error('[ClientInfosService.upsert] ❌ ERREUR select:', selectError)
      console.error('[ClientInfosService.upsert] Code:', selectError.code)
      console.error('[ClientInfosService.upsert] Message:', selectError.message)
      console.error('[ClientInfosService.upsert] Details:', selectError.details)
      throw selectError
    }

    const existing = Array.isArray(rows) && rows.length > 0 ? rows[0] : null
    console.log('[ClientInfosService.upsert] Enregistrement existant:', existing ? `Oui (ID: ${existing.id})` : 'Non')

    if (existing) {
      console.log('[ClientInfosService.upsert] 📝 MODE UPDATE')
      const { data, error } = await supabase
        .from('client_infos')
        .update({ ...(clientData as ClientInfoUpdate), updated_at: new Date().toISOString() })
        .eq('dossier_id', clientData.dossier_id as string)
        .select()
        .limit(1)

      if (error) {
        console.error('[ClientInfosService.upsert] ❌ ERREUR UPDATE:', error)
        console.error('[ClientInfosService.upsert] Code:', error.code)
        console.error('[ClientInfosService.upsert] Message:', error.message)
        console.error('[ClientInfosService.upsert] Details:', error.details)
        console.error('[ClientInfosService.upsert] Hint:', error.hint)
        throw error
      }

      if (!data || (Array.isArray(data) && data.length === 0)) {
        console.error('[ClientInfosService.upsert] ❌ Aucune ligne mise à jour (RLS bloqué?)')
        throw new Error('Aucune ligne mise à jour (RLS a probablement bloqué la requête)')
      }

      const updated = Array.isArray(data) ? data[0] : (data as any)
      console.log('[ClientInfosService.upsert] ✅ UPDATE réussi')
      console.log('[ClientInfosService.upsert] Données mises à jour:', updated)
      console.log('═══════════════════════════════════════════')
      return updated
    }

    console.log('[ClientInfosService.upsert] ➕ MODE INSERT')
    const { data, error } = await supabase
      .from('client_infos')
      .insert({ ...clientData, updated_at: new Date().toISOString() })
      .select()
      .limit(1)

    if (error) {
      console.error('[ClientInfosService.upsert] ❌ ERREUR INSERT:', error)
      console.error('[ClientInfosService.upsert] Code:', error.code)
      console.error('[ClientInfosService.upsert] Message:', error.message)
      console.error('[ClientInfosService.upsert] Details:', error.details)
      console.error('[ClientInfosService.upsert] Hint:', error.hint)
      throw error
    }

    if (!data || (Array.isArray(data) && data.length === 0)) {
      console.error('[ClientInfosService.upsert] ❌ Aucune ligne insérée (RLS bloqué?)')
      throw new Error('Aucune ligne insérée (RLS a probablement bloqué la requête)')
    }

    const inserted = Array.isArray(data) ? data[0] : (data as any)
    console.log('[ClientInfosService.upsert] ✅ INSERT réussi')
    console.log('[ClientInfosService.upsert] Données insérées:', inserted)
    console.log('═══════════════════════════════════════════')
    return inserted
  }

  /**
   * Met à jour les informations client
   */
  static async updateClientInfo(dossierId: string, updates: ClientInfoUpdate) {
    const { data, error } = await supabase
      .from('client_infos')
      .update(updates)
      .eq('dossier_id', dossierId)
      .select()
      .single()

    if (error) {
      console.error('Erreur lors de la mise à jour des infos client:', error)
      throw error
    }

    return data
  }

  /**
   * Supprime les informations client d'un dossier
   */
  static async deleteClientInfo(dossierId: string) {
    const { error } = await supabase
      .from('client_infos')
      .delete()
      .eq('dossier_id', dossierId)

    if (error) {
      console.error('Erreur lors de la suppression des infos client:', error)
      throw error
    }

    return true
  }

  /**
   * Recherche des clients par nom ou email
   */
  static async searchClients(searchTerm: string) {
    const { data, error } = await supabase
      .from('client_infos')
      .select(`
        *,
        dossiers (
          id,
          numero_dossier,
          statut:statut_canon,
          type_dossier
        )
      `)
      .or(`client_nom.ilike.%${searchTerm}%,client_prenom.ilike.%${searchTerm}%,client_email.ilike.%${searchTerm}%`)
      .order('created_at', { ascending: false })
      .limit(20)

    if (error) {
      console.error('Erreur lors de la recherche des clients:', error)
      throw error
    }

    return data
  }

  /**
   * Valide les données client avant sauvegarde (validation minimale, non bloquante)
   */
  static validateClientData(data: Partial<ClientInfoInsert>): string[] {
    const errors: string[] = []

    // Validation uniquement pour les champs critiques de l'emprunteur principal
    if (!data.client_nom?.trim()) {
      errors.push('Le nom du client est requis')
    }
    if (!data.client_prenom?.trim()) {
      errors.push('Le prénom du client est requis')
    }
    
    // Validation email uniquement si fourni
    if (data.client_email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.client_email)) {
      errors.push('L\'email du client n\'est pas valide')
    }

    // Validation email conjoint uniquement si fourni
    if (data.conjoint_email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.conjoint_email)) {
      errors.push('L\'email du conjoint n\'est pas valide')
    }

    // NOTE: Les autres champs sont optionnels pour permettre la modification partielle
    // L'admin peut modifier n'importe quel champ sans être bloqué

    return errors
  }
}

================
File: lib/services/data-comparison.ts
================
import {
  DiffReport,
  FieldDifference,
  ExtractedClientData,
  CurrentClientData
} from '@/types/data-comparison'
import { formatDate } from '@/lib/utils/formatters'

export class DataComparisonService {
  /**
   * Labels français pour les champs
   */
  private static FIELD_LABELS: Record<string, string> = {
    civilite: 'Civilité',
    nom: 'Nom',
    prenom: 'Prénom',
    nomNaissance: 'Nom de naissance',
    dateNaissance: 'Date de naissance',
    fumeur: 'Statut fumeur',
    categorieProfessionnelle: 'Catégorie professionnelle',
    email: 'Email',
    telephone: 'Téléphone',
  }

  /**
   * Détecte le type de dossier depuis les données extraites
   */
  static detectDossierType(extractedData: ExtractedClientData): 'seul' | 'couple' {
    // Si nombreAssures est explicitement fourni
    if (extractedData.nombreAssures === 2) {
      return 'couple'
    }
    if (extractedData.nombreAssures === 1) {
      return 'seul'
    }

    // Sinon, vérifier si des données conjoint existent
    const hasConjoint = extractedData.conjoint && (
      extractedData.conjoint.nom ||
      extractedData.conjoint.prenom ||
      extractedData.conjoint.dateNaissance
    )

    return hasConjoint ? 'couple' : 'seul'
  }

  /**
   * Compare une valeur actuelle avec une valeur extraite
   */
  private static compareValue(current: any, extracted: any): boolean {
    // Si les deux sont null/undefined, pas de différence
    if (!current && !extracted) return false
    
    // Si l'un est null et l'autre non, c'est différent
    if (!current || !extracted) return true
    
    // Comparaison de dates
    if (typeof current === 'string' && typeof extracted === 'string') {
      // Normaliser les dates pour comparaison
      if (current.match(/^\d{4}-\d{2}-\d{2}/) && extracted.match(/^\d{4}-\d{2}-\d{2}/)) {
        return current.slice(0, 10) !== extracted.slice(0, 10)
      }
    }
    
    // Comparaison booléenne
    if (typeof current === 'boolean' && typeof extracted === 'boolean') {
      return current !== extracted
    }
    
    // Comparaison standard (case-insensitive pour strings)
    const currentStr = String(current).toLowerCase().trim()
    const extractedStr = String(extracted).toLowerCase().trim()
    
    return currentStr !== extractedStr
  }

  /**
   * Crée un objet FieldDifference pour un champ
   */
  private static createFieldDiff(
    field: string,
    currentValue: any,
    extractedValue: any,
    category: 'principal' | 'conjoint' | 'pret'
  ): FieldDifference | null {
    // Ne pas créer de différence si la valeur extraite est null/undefined
    // (cela signifie que l'IA n'a pas trouvé ce champ)
    if (extractedValue === null || extractedValue === undefined || extractedValue === '') {
      return null
    }

    const isDifferent = this.compareValue(currentValue, extractedValue)
    const isNew = !currentValue && !!extractedValue

    return {
      field,
      label: this.FIELD_LABELS[field] || field,
      currentValue: currentValue || null,
      extractedValue: extractedValue || null,
      isDifferent,
      isNew,
      category
    }
  }

  /**
   * Compare les données de l'emprunteur principal
   */
  private static comparePrincipal(
    current: CurrentClientData,
    extracted: ExtractedClientData
  ): FieldDifference[] {
    const diffs: FieldDifference[] = []

    if (!extracted.principal) return diffs

    const fields = [
      { current: current.civilite, extracted: extracted.principal.civilite, field: 'civilite' },
      { current: current.client_nom, extracted: extracted.principal.nom, field: 'nom' },
      { current: current.client_prenom, extracted: extracted.principal.prenom, field: 'prenom' },
      { current: current.nom_naissance, extracted: extracted.principal.nomNaissance, field: 'nomNaissance' },
      { current: current.client_date_naissance, extracted: extracted.principal.dateNaissance, field: 'dateNaissance' },
      { current: current.client_fumeur, extracted: extracted.principal.fumeur, field: 'fumeur' },
      { current: current.categorie_professionnelle, extracted: extracted.principal.categorieProfessionnelle, field: 'categorieProfessionnelle' },
      { current: current.client_email, extracted: extracted.principal.email, field: 'email' },
      { current: current.client_telephone, extracted: extracted.principal.telephone, field: 'telephone' },
    ]

    for (const { current, extracted, field } of fields) {
      const diff = this.createFieldDiff(field, current, extracted, 'principal')
      // Filtrer les null (champs non extraits) ET ne garder que les différences/nouveautés
      if (diff && (diff.isDifferent || diff.isNew)) {
        diffs.push(diff)
      }
    }

    return diffs
  }

  /**
   * Compare les données du conjoint
   */
  private static compareConjoint(
    current: CurrentClientData,
    extracted: ExtractedClientData
  ): FieldDifference[] {
    const diffs: FieldDifference[] = []

    if (!extracted.conjoint) return diffs

    const fields = [
      { current: current.conjoint_civilite, extracted: extracted.conjoint.civilite, field: 'civilite' },
      { current: current.conjoint_nom, extracted: extracted.conjoint.nom, field: 'nom' },
      { current: current.conjoint_prenom, extracted: extracted.conjoint.prenom, field: 'prenom' },
      { current: current.conjoint_nom_naissance, extracted: extracted.conjoint.nomNaissance, field: 'nomNaissance' },
      { current: current.conjoint_date_naissance, extracted: extracted.conjoint.dateNaissance, field: 'dateNaissance' },
      { current: current.conjoint_fumeur, extracted: extracted.conjoint.fumeur, field: 'fumeur' },
      { current: current.conjoint_categorie_professionnelle, extracted: extracted.conjoint.categorieProfessionnelle, field: 'categorieProfessionnelle' },
      { current: current.conjoint_email, extracted: extracted.conjoint.email, field: 'email' },
      { current: current.conjoint_telephone, extracted: extracted.conjoint.telephone, field: 'telephone' },
    ]

    for (const { current, extracted, field } of fields) {
      const diff = this.createFieldDiff(field, current, extracted, 'conjoint')
      // Filtrer les null (champs non extraits) ET ne garder que les différences/nouveautés
      if (diff && (diff.isDifferent || diff.isNew)) {
        diffs.push(diff)
      }
    }

    return diffs
  }

  /**
   * Génère un rapport complet de comparaison
   */
  static generateDiffReport(
    current: CurrentClientData,
    extracted: ExtractedClientData,
    currentIsCouple: boolean
  ): DiffReport {
    // Déterminer le type détecté
    const detectedType = this.detectDossierType(extracted)
    const currentType: 'seul' | 'couple' = currentIsCouple ? 'couple' : 'seul'

    // Comparer les données
    const principalDiffs = this.comparePrincipal(current, extracted)
    const conjointDiffs = this.compareConjoint(current, extracted)

    // Calculer le total de différences
    const totalDifferences = principalDiffs.length + conjointDiffs.length

    // Vérifier s'il y a un conflit de type
    const hasTypeMismatch = currentType !== detectedType

    // Rapport final
    const report: DiffReport = {
      hasClientDifferences: totalDifferences > 0,
      hasTypeMismatch,
      principalDiffs,
      conjointDiffs,
      currentType,
      detectedType,
      champsManquants: extracted.champsManquants || [],
      totalDifferences,
      confidence: 0.9 // Confidence par défaut, peut être surchargée
    }

    return report
  }

  /**
   * Formatte une valeur pour l'affichage
   * ✅ Utilise le formatter centralisé pour les dates
   */
  static formatValue(value: any, field: string): string {
    if (value === null || value === undefined || value === '') {
      return '-'
    }

    // Formatage spécifique par type de champ
    if (field === 'dateNaissance' && typeof value === 'string') {
      try {
        return formatDate(value) // ✅ Utilisation du formatter centralisé
      } catch {
        return value
      }
    }

    if (field === 'fumeur') {
      return value ? 'Fumeur' : 'Non-fumeur'
    }

    if (field === 'civilite') {
      return value
    }

    return String(value)
  }

  /**
   * Applique les changements sélectionnés
   */
  static buildUpdatePayload(
    selectedFields: string[],
    extracted: ExtractedClientData,
    dossierId: string
  ): any {
    const payload: any = {
      dossier_id: dossierId
    }

    // Mapper les champs sélectionnés vers les colonnes DB
    for (const field of selectedFields) {
      const [category, fieldName] = field.split('.')
      
      if (category === 'principal') {
        switch (fieldName) {
          case 'civilite':
            payload.client_civilite = extracted.principal?.civilite
            break
          case 'nom':
            payload.client_nom = extracted.principal?.nom
            break
          case 'prenom':
            payload.client_prenom = extracted.principal?.prenom
            break
          case 'nomNaissance':
            payload.nom_naissance = extracted.principal?.nomNaissance
            break
          case 'dateNaissance':
            payload.client_date_naissance = extracted.principal?.dateNaissance
            break
          case 'fumeur':
            payload.client_fumeur = extracted.principal?.fumeur
            break
          case 'categorieProfessionnelle':
            payload.categorie_professionnelle = extracted.principal?.categorieProfessionnelle
            break
          case 'email':
            payload.client_email = extracted.principal?.email
            break
          case 'telephone':
            payload.client_telephone = extracted.principal?.telephone
            break
        }
      } else if (category === 'conjoint') {
        switch (fieldName) {
          case 'civilite':
            payload.conjoint_civilite = extracted.conjoint?.civilite
            break
          case 'nom':
            payload.conjoint_nom = extracted.conjoint?.nom
            break
          case 'prenom':
            payload.conjoint_prenom = extracted.conjoint?.prenom
            break
          case 'nomNaissance':
            payload.conjoint_nom_naissance = extracted.conjoint?.nomNaissance
            break
          case 'dateNaissance':
            payload.conjoint_date_naissance = extracted.conjoint?.dateNaissance
            break
          case 'fumeur':
            payload.conjoint_fumeur = extracted.conjoint?.fumeur
            break
          case 'categorieProfessionnelle':
            payload.conjoint_categorie_professionnelle = extracted.conjoint?.categorieProfessionnelle
            break
          case 'email':
            payload.conjoint_email = extracted.conjoint?.email
            break
          case 'telephone':
            payload.conjoint_telephone = extracted.conjoint?.telephone
            break
        }
      }
    }

    return payload
  }
}

================
File: lib/services/devis.ts
================
import { supabase } from '@/lib/supabase'
import { Database } from '@/types/supabase'

type Devis = Database['public']['Tables']['devis']['Row']
type DevisInsert = Database['public']['Tables']['devis']['Insert']
type DevisUpdate = Database['public']['Tables']['devis']['Update']

export class DevisService {
  /**
   * Récupère tous les devis avec les informations du dossier
   */
  static async getAllDevis() {
    const { data, error } = await supabase
      .from('devis')
      .select(`
        *,
        dossiers!inner (
          id,
          numero_dossier,
          statut:statut_canon,
          type_dossier,
          client_infos (
            client_nom,
            client_prenom,
            client_email
          ),
          pret_data (
            montant_capital,
            banque_preteuse,
            duree_mois
          )
        )
      `)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('Erreur lors de la récupération des devis:', error)
      throw error
    }

    return data
  }

  /**
   * Récupère un devis par son ID
   */
  static async getDevisById(id: string) {
    console.log('[DevisService.getDevisById] input', { id })
    // Pour éviter PGRST201 (relations multiples entre devis et dossiers),
    // on récupère UNIQUEMENT le devis ici. Les données dossier sont inutiles
    // pour un simple refus/validation et peuvent être récupérées ailleurs si besoin.
    const { data, error } = await supabase
      .from('devis')
      .select(`*`)
      .eq('id', id)
      .single()

    if (error) {
      console.error('[DevisService.getDevisById] supabase error', error)
      throw error
    }

    console.log('[DevisService.getDevisById] output', data)
    return data
  }

  /**
   * Récupère les devis d'un dossier spécifique
   */
  static async getDevisByDossierId(dossierId: string) {
    const { data, error } = await supabase
      .from('devis')
      .select('*')
      .eq('dossier_id', dossierId)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('Erreur lors de la récupération des devis du dossier:', error)
      throw error
    }

    return data
  }

  /**
   * Crée un nouveau devis
   */
  static async createDevis(devisData: DevisInsert) {
    const { data, error } = await supabase
      .from('devis')
      .insert(devisData)
      .select()
      .single()

    if (error) {
      console.error('Erreur lors de la création du devis:', error)
      throw error
    }

    return data
  }

  /**
   * Crée plusieurs devis en une seule requête
   */
  static async createMultipleDevis(devisArray: DevisInsert[]) {
    if (!Array.isArray(devisArray) || devisArray.length === 0) return []
    const { data, error } = await supabase
      .from('devis')
      .insert(devisArray)
      .select()

    if (error) {
      console.error('Erreur lors de la création multiple des devis:', error)
      throw error
    }

    return data
  }

  /**
   * Met à jour un devis
   */
  static async updateDevis(id: string, updates: DevisUpdate) {
    console.log('[DevisService.updateDevis] input', { id, updates })
    const { data, error } = await supabase
      .from('devis')
      .update(updates)
      .eq('id', id)
      .select()
      .maybeSingle()

    if (error) {
      const { code, message, details, hint } = error as any
      console.error('[DevisService.updateDevis] supabase error', { code, message, details, hint })
      throw error
    }

    if (!data) {
      console.warn('[DevisService.updateDevis] no row returned (possible RLS or id not found)', { id, updates })
      return null as unknown as Devis
    }

    console.log('[DevisService.updateDevis] output', data)
    return data
  }

  /**
   * Supprime un devis
   */
  static async deleteDevis(id: string) {
    const { error } = await supabase
      .from('devis')
      .delete()
      .eq('id', id)

    if (error) {
      console.error('Erreur lors de la suppression du devis:', error)
      throw error
    }

    return true
  }

  /**
   * Marque un devis comme envoyé
   */
  static async markDevisAsSent(id: string) {
    return this.updateDevis(id, {
      statut: 'envoye',
      date_envoi: new Date().toISOString()
    })
  }

  /**
   * Marque un devis comme lu
   */
  static async markDevisAsRead(id: string) {
    return this.updateDevis(id, {
      statut: 'lu'
    })
  }

  /**
   * Marque un devis comme accepté
   */
  static async markDevisAsAccepted(id: string) {
    return this.updateDevis(id, {
      statut: 'accepte',
      date_acceptation: new Date().toISOString()
    })
  }

  /**
   * Marque un devis comme refusé
   */
  static async markDevisAsRejected(id: string, motif?: string) {
    console.log('[DevisService.markDevisAsRejected] input', { id, motif })
    
    try {
      // 1. Récupérer le devis actuel
      const { data: currentDevis, error: fetchError } = await supabase
        .from('devis')
        .select('donnees_devis')
        .eq('id', id)
        .single()

      if (fetchError) throw fetchError

      // 2. Préparer les nouvelles données
      const currentData = currentDevis?.donnees_devis || {}
      const newData = {
        ...currentData,
        ...(motif ? { motif_refus: motif, date_refus: new Date().toISOString() } : {})
      }

      // 3. Mettre à jour le devis
      const { data, error } = await supabase
        .from('devis')
        .update({ 
          statut: 'refuse',
          donnees_devis: newData
        })
        .eq('id', id)
        .select()
        .single()

      if (error) throw error
      console.log('[DevisService.markDevisAsRejected] success', data)
      return data
    } catch (e) {
      console.error('[DevisService.markDevisAsRejected] error', e)
      throw e
    }
  }

  /**
   * Met à jour l'URL du PDF d'un devis
   */
  static async updatePdfUrl(id: string, pdfUrl: string) {
    return this.updateDevis(id, {
      pdf_url: pdfUrl,
      pdf_created_at: new Date().toISOString()
    })
  }

  /**
   * Génère un numéro de devis unique
   */
  static async generateNumeroDevis(): Promise<string> {
    const { data, error } = await supabase.rpc('generate_numero_devis')
    
    if (error) {
      console.error('Erreur lors de la génération du numéro de devis:', error)
      throw error
    }

    return data
  }

  /**
   * Récupère les statistiques des devis
   */
  static async getDevisStats() {
    const { data, error } = await supabase
      .from('devis')
      .select('statut, date_generation, donnees_devis')

    if (error) {
      console.error('Erreur lors de la récupération des statistiques devis:', error)
      throw error
    }

    const stats = {
      total: data.length,
      parStatut: {} as Record<string, number>,
      parMois: {} as Record<string, number>,
      montantTotal: 0,
      montantMoyen: 0
    }

    data.forEach(devis => {
      // Compter par statut
      stats.parStatut[devis.statut] = (stats.parStatut[devis.statut] || 0) + 1
      
      // Compter par mois
      if (devis.date_generation) {
        const month = new Date(devis.date_generation).toISOString().slice(0, 7)
        stats.parMois[month] = (stats.parMois[month] || 0) + 1
      }

      // Calculer montants si disponibles dans les données JSON
      if (devis.donnees_devis && typeof devis.donnees_devis === 'object') {
        const donnees = devis.donnees_devis as any
        if (donnees.montant && typeof donnees.montant === 'number') {
          stats.montantTotal += donnees.montant
        }
      }
    })

    stats.montantMoyen = stats.total > 0 ? stats.montantTotal / stats.total : 0

    return stats
  }

  /**
   * Recherche des devis par critères
   */
  static async searchDevis(criteria: {
    statut?: string
    numero_devis?: string
    date_debut?: string
    date_fin?: string
    dossier_id?: string
  }) {
    let query = supabase
      .from('devis')
      .select(`
        *,
        dossiers!inner (
          numero_dossier,
          client_infos (
            client_nom,
            client_prenom
          )
        )
      `)

    // Appliquer les filtres
    if (criteria.statut) {
      query = query.eq('statut', criteria.statut)
    }
    if (criteria.numero_devis) {
      query = query.ilike('numero_devis', `%${criteria.numero_devis}%`)
    }
    if (criteria.dossier_id) {
      query = query.eq('dossier_id', criteria.dossier_id)
    }
    if (criteria.date_debut) {
      query = query.gte('date_generation', criteria.date_debut)
    }
    if (criteria.date_fin) {
      query = query.lte('date_generation', criteria.date_fin)
    }

    const { data, error } = await query.order('created_at', { ascending: false })

    if (error) {
      console.error('Erreur lors de la recherche des devis:', error)
      throw error
    }

    return data
  }

  /**
   * ✅ STATISTIQUES PAGE - Analyse par compagnie d'assurance
   */
  static async getAnalyseCompagnies(startDate: string, endDate: string) {
    try {
      // ✅ Récupère tous les devis avec compagnie puis filtre en JS (pour gérer date_generation null)
      const { data: devis, error } = await supabase
        .from('devis')
        .select('id, compagnie, statut, created_at, date_generation')
        .not('compagnie', 'is', null)

      if (error) {
        console.error('[DevisService.getAnalyseCompagnies] Erreur:', error)
        throw error
      }

      // Filtrer par date (utilise date_generation ou fallback sur created_at)
      const start = new Date(startDate).getTime()
      const end = new Date(endDate).getTime()
      const devisFiltres = devis.filter((d: any) => {
        const date = new Date(d.date_generation || d.created_at).getTime()
        return date >= start && date <= end
      })

      // Grouper par compagnie
      const parCompagnie: Record<string, { envoyes: number; acceptes: number }> = {}

      devisFiltres.forEach((d: any) => {
        const compagnie = d.compagnie
        if (!parCompagnie[compagnie]) {
          parCompagnie[compagnie] = { envoyes: 0, acceptes: 0 }
        }

        // Compter les devis envoyés (statut envoye, accepte ou refuse)
        if (['envoye', 'accepte', 'refuse'].includes(d.statut)) {
          parCompagnie[compagnie].envoyes++
        }

        // Compter les devis acceptés
        if (d.statut === 'accepte') {
          parCompagnie[compagnie].acceptes++
        }
      })

      // Convertir en tableau et calculer taux d'acceptation
      return Object.entries(parCompagnie)
        .map(([nom_compagnie, stats]) => {
          const taux_acceptation = stats.envoyes > 0
            ? Math.round((stats.acceptes / stats.envoyes) * 100 * 10) / 10
            : 0

          return {
            nom_compagnie,
            ca_pourcentage: 0, // Placeholder - nécessite données de commission
            ca_montant: 0, // Placeholder - nécessite données de commission
            nb_devis_envoyes: stats.envoyes,
            nb_devis_acceptes: stats.acceptes,
            taux_acceptation
          }
        })
        .sort((a, b) => b.nb_devis_acceptes - a.nb_devis_acceptes) // Trier par nombre d'acceptations
    } catch (error) {
      console.error('[DevisService.getAnalyseCompagnies] Erreur:', error)
      return []
    }
  }
}

================
File: lib/services/document-extraction.ts
================
import { supabase } from '@/lib/supabase'
import { DocumentsService } from './documents'
import { PretDataService } from './pret-data'
import { GeminiExtractionService } from './gemini-extraction'
import { addMonths, differenceInMonths, differenceInDays, parseISO, format } from 'date-fns'

// Charger les variables d'environnement côté serveur
if (typeof window === 'undefined') {
  require('dotenv').config()
}

// Types pour l'extraction
interface EmprunteurInfo {
  nom: string | null
  prenom: string | null
  dateNaissance: string | null
}

interface PretInfo {
  montantInitial: number | null
  dureeInitialeMois: number | null
  dateDebut: string | null
  dateFin: string | null
  tauxNominal: number | null
  banquePreteuse: string | null
  typePret: string | null
  coutAssuranceMensuel: number | null
}

interface Echeance {
  numero: number
  date: string
  capitalRestantDu: number
  interets: number
  assurance: number
  capital: number
  mensualite: number
}

interface ExtractedData {
  emprunteurs: {
    principal: EmprunteurInfo | null
    conjoint: EmprunteurInfo | null
  }
  pret: PretInfo | null
  tableauAmortissement: Echeance[]
  metadata: {
    confidence: number
    warnings: string[]
    sourcesUtilisees: string[]
  }
}

interface CalculatedData {
  dateDebutEffective: string
  dureeRestanteMois: number
  capitalRestantDu: number
}

interface ExtractedDataCiblee {
  emprunteurs: {
    principal: EmprunteurInfo | null
    conjoint: EmprunteurInfo | null
  }
  pret: PretInfo | null
  lignesAmortissementCibles: {
    echeanceAvant: {
      date: string
      capitalRestantDu: number
    } | null
    echeanceApres: {
      date: string
      capitalRestantDu: number
    } | null
  }
  metadata: {
    confidence: number
    warnings: string[]
  }
}

interface ConsolidatedDataCiblee extends ExtractedDataCiblee {
  calculs: CalculatedData | null
}

interface ConsolidatedData extends ExtractedData {
  calculs: CalculatedData | null
}

interface DocumentSource {
  type: 'offrePret' | 'tableauAmortissement' | 'carteIdentite'
  content: string
  confidence: number
}

// Prompt système optimisé pour extraction ciblée
const SYSTEM_PROMPT = `
Tu es un expert en analyse de documents bancaires français.

CONTEXTE : Tu vas recevoir un ou plusieurs fichiers de prêt et une date clé appelée "date_effective".

MISSION : Ta mission est double :
1. Analyse l'ensemble des documents pour extraire les informations générales sur les emprunteurs et le prêt.
2. Localise le tableau d'amortissement et extrais UNIQUEMENT les deux lignes qui encadrent la "date_effective" fournie.

FORMAT DE SORTIE JSON STRICT :
Tu dois retourner UNIQUEMENT un objet JSON valide, sans aucun texte explicatif avant ou après.
Retourne directement l'objet JSON suivant :

{
  "emprunteurs": {
    "principal": {
      "civilite": "M | Mme | Mlle | null",
      "nom": "string | null",
      "prenom": "string | null",
      "nomNaissance": "string | null (nom de jeune fille)",
      "dateNaissance": "YYYY-MM-DD | null",
      "fumeur": boolean | null,
      "categorieProfessionnelle": "string | null (Cadre, Employé, etc.)",
      "profession": "string | null (intitulé du poste)",
      "email": "string | null",
      "telephone": "string | null"
    },
    "conjoint": null | {
      "civilite": "M | Mme | Mlle | null",
      "nom": "string | null",
      "prenom": "string | null",
      "nomNaissance": "string | null",
      "dateNaissance": "YYYY-MM-DD | null",
      "fumeur": boolean | null,
      "categorieProfessionnelle": "string | null",
      "profession": "string | null",
      "email": "string | null",
      "telephone": "string | null"
    }
  },
  "nombreAssures": number (1 ou 2 - nombre d'assurés détecté),
  "pret": {
    "montantInitial": number | null,
    "dureeInitialeMois": number | null,
    "dateDebut": "YYYY-MM-DD | null",
    "dateFin": "YYYY-MM-DD | null", 
    "tauxNominal": number | null,
    "banquePreteuse": "string | null",
    "typePret": "string | null",
    "coutAssuranceMensuel": number | null
  },
  "lignesAmortissementCibles": {
    "echeanceAvant": {
      "date": "YYYY-MM-DD",
      "capitalRestantDu": number
    } | null,
    "echeanceApres": {
      "date": "YYYY-MM-DD",
      "capitalRestantDu": number
    } | null
  },
  "metadata": {
    "confidence": number,
    "warnings": ["string"],
    "champsManquants": ["string (liste des champs non trouvés - NON BLOQUANT)"]
  }
}

RÈGLES D'EXTRACTION STRICTES :

POUR LES EMPRUNTEURS (Principal ET Conjoint si présent) :
- Civilité : Cherche M, Monsieur, Mme, Madame, Mlle, Mademoiselle
- Nom : Nom de famille actuel
- Nom de naissance : Nom de jeune fille (souvent entre parenthèses ou précédé de "née")
- Prénom : Prénom complet
- Date de naissance : Format YYYY-MM-DD
- Fumeur : Cherche "fumeur", "non-fumeur", "tabac" → retourne boolean
- Catégorie professionnelle : Cadre, Employé, Profession libérale, Artisan, etc.
- Profession : Intitulé exact du poste (ex: "Ingénieur informatique", "Infirmière")
- Email : Adresse email
- Téléphone : Numéro de portable

POUR LE NOMBRE D'ASSURÉS :
- Compte le nombre d'emprunteurs : 1 = emprunteur seul, 2 = couple
- Si un co-emprunteur/conjoint est mentionné, nombreAssures = 2

POUR LE TABLEAU D'AMORTISSEMENT :
- L'utilisateur te fournira la "date_effective". Trouve l'échéance la plus proche AVANT cette date et l'échéance la plus proche APRÈS cette date.
- Si la "date_effective" tombe exactement sur une échéance, retourne cette même échéance pour "echeanceAvant" ET "echeanceApres".
- Si tu ne trouves pas de tableau d'amortissement, retourne null pour "echeanceAvant" et "echeanceApres" et ajoute un warning.
- **IMPORTANT** : Pour "coutAssuranceMensuel", cherche dans le tableau d'amortissement la colonne "Assurance" ou "Prime d'assurance". Cette valeur apparaît généralement pour CHAQUE échéance. Si tu la trouves, retourne le montant mensuel de l'assurance.

CHAMPS MANQUANTS (NON BLOQUANT) :
- Si une donnée n'est pas trouvée, utilise null et ajoute le nom du champ dans "champsManquants"
- L'absence d'un champ ne doit JAMAIS bloquer l'extraction
- Exemple : si l'email n'est pas dans les documents, retourne null et ajoute "email" dans champsManquants

AUTRES RÈGLES :
- Dates : Convertis-les TOUJOURS au format YYYY-MM-DD
- Montants : Retourne des nombres
- Booleans : true/false pour fumeur

RÈGLE IMPÉRATIVE : N'invente JAMAIS une information. Si une donnée n'est pas explicitement écrite dans les documents fournis, tu DOIS retourner null et l'ajouter dans champsManquants. Toute information inventée rendra ta réponse invalide

DÉTECTION DU TABLEAU D'AMORTISSEMENT :
- Le tableau d'amortissement peut être dans N'IMPORTE QUEL document
- Cherche des patterns comme : "Tableau d'amortissement", "Échéances", "Plan de remboursement", "Amortissement"
- Les colonnes peuvent être nommées différemment : "CRD", "Capital Restant Dû", "Reste à payer", "Capital dû"
- Si tu vois des lignes avec des dates et des montants, c'est probablement le tableau d'amortissement
- Même si le tableau semble incomplet, extrais les deux lignes qui encadrent la date_effective
- Si aucun tableau n'est trouvé après analyse exhaustive, retourne null pour les échéances mais ajoute un warning explicite

GESTION DU CONJOINT :
- Si les documents ne mentionnent qu'un seul emprunteur, retourne null pour le champ "conjoint"
- Si les documents mentionnent un co-emprunteur/conjoint, remplis ses informations
- En cas de doute, privilégie null pour éviter les erreurs

CONSOLIDATION DES DONNÉES :
- Si une même information apparaît dans plusieurs documents avec des valeurs différentes, privilégie la source la plus récente ou la plus détaillée
- Ajoute un warning dans metadata.warnings pour signaler les incohérences détectées
`

export class DocumentExtractionService {
  /**
   * Méthode principale d'extraction depuis un dossier
   */
  static async extractFromDossier(dossierId: string, config?: { apiKey?: string, model?: string }): Promise<ConsolidatedDataCiblee | null> {
    try {
      console.log(`[DocumentExtractionService] Début extraction pour dossier ${dossierId}`)
      
      // 1. Récupérer tous les documents du dossier avec un client Supabase server-side
      const { createClient } = await import('@supabase/supabase-js')
      const supabaseServer = createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
      )
      
      const { data: documents, error: docsError } = await supabaseServer
        .from('documents')
        .select('*')
        .eq('dossier_id', dossierId)
        .order('created_at', { ascending: false })
      
      if (docsError) {
        console.error('[DocumentExtractionService] Erreur récupération documents:', docsError)
        throw new Error(`Impossible de récupérer les documents: ${docsError.message}`)
      }
      
      // 2. Utiliser TOUS les documents pour l'extraction (pas de filtrage)
      const relevantDocuments = documents || []
      
      if (relevantDocuments.length === 0) {
        throw new Error('Aucun document pertinent trouvé pour l\'extraction')
      }
      
      console.log(`[DocumentExtractionService] ${relevantDocuments.length} document(s) pertinent(s) trouvé(s)`)
      
      // 3. Calculer la date effective AVANT d'appeler l'IA
      const dateDemande = new Date()
      const dateDebutEffective = addMonths(dateDemande, 3)
      const dateEffectiveStr = format(dateDebutEffective, 'yyyy-MM-dd')
      console.log(`[DocumentExtractionService] Date effective calculée: ${dateEffectiveStr}`)
      
      // 4. Utiliser Google Gemini pour tous les fichiers (modèle principal)
      console.log('[DocumentExtractionService] Utilisation de Google Gemini 2.5 Pro')
      
      const userPrompt = `Voici les documents à analyser. La date effective pour laquelle je cherche les lignes du tableau d'amortissement est : ${dateEffectiveStr}.\n\nConsolide toutes ces informations dans un seul objet JSON.`
      
      const extractedData = await GeminiExtractionService.extractFromDocuments(
        relevantDocuments.map(doc => ({
          id: doc.id,
          storage_path: doc.storage_path,
          document_name: doc.document_name,
          mime_type: doc.mime_type || 'application/pdf'
        })),
        SYSTEM_PROMPT,
        userPrompt
      )
      
      // 7. Validation et calculs métier
      const validatedData = this.validateAndCalculate(extractedData, dateDebutEffective)
      
      console.log(`[DocumentExtractionService] Extraction réussie avec confidence ${validatedData.metadata.confidence}`)
      
      return validatedData
      
    } catch (error) {
      console.error('[DocumentExtractionService] Erreur extraction:', error)
      return null
    }
  }

  /**
   * Extraction du texte depuis un document Supabase Storage
   */
  private static async extractTextFromDocument(doc: any): Promise<string> {
    try {
      console.log(`[DocumentExtractionService] Extraction texte du document ${doc.document_name}`)
      
      // Télécharger le document depuis Supabase Storage
      const { supabase } = await import('@/lib/supabase')
      
      const { data, error } = await supabase.storage
        .from('documents')
        .download(doc.storage_path)
      
      if (error) {
        console.error(`[DocumentExtractionService] Erreur téléchargement ${doc.document_name}:`, error)
        throw new Error(`Impossible de télécharger le document: ${error.message}`)
      }
      
      // Pour les PDFs et images, retourner l'URL publique pour analyse multimodale
      if (doc.mime_type === 'application/pdf' || doc.mime_type?.startsWith('image/')) {
        const { data: urlData } = supabase.storage
          .from('documents')
          .getPublicUrl(doc.storage_path)
        
        console.log(`[DocumentExtractionService] URL publique générée pour ${doc.document_name}: ${urlData.publicUrl}`)
        return `[DOCUMENT_URL:${urlData.publicUrl}]`
      } else {
        // Pour les autres types, essayer de lire le contenu texte
        const arrayBuffer = await data.arrayBuffer()
        const text = Buffer.from(arrayBuffer).toString('utf-8')
        return text
      }
      
    } catch (error: any) {
      console.error(`[DocumentExtractionService] Erreur extraction ${doc.document_name}:`, error)
      throw new Error(`Erreur lors de l'extraction du document: ${error.message}`)
    }
  }

  /**
   * Calcul de la confiance basé sur les métadonnées du document
   */
  private static calculateDocumentConfidence(doc: any): number {
    let confidence = 0.8 // Base de confiance
    
    // Ajuster selon le type de document
    if (doc.type === 'offrePret') confidence += 0.1
    if (doc.type === 'tableauAmortissement') confidence += 0.1
    
    // Ajuster selon la taille du fichier
    if (doc.file_size && doc.file_size > 100000) confidence += 0.05
    
    return Math.min(confidence, 1.0)
  }

  /**
   * Appel à OpenRouter avec plusieurs documents
   */
  private static async callOpenRouterWithMultipleDocuments(sources: DocumentSource[], config?: { apiKey?: string, model?: string }): Promise<ExtractedData> {
    const openRouterApiKey = config?.apiKey || process.env.OPENROUTER_API_KEY || process.env.NEXT_PUBLIC_OPENROUTER_API_KEY
    const openRouterModel = config?.model || process.env.OPENROUTER_MODEL || process.env.NEXT_PUBLIC_OPENROUTER_MODEL
    
    if (!openRouterModel) {
      throw new Error('OPENROUTER_MODEL non configuré. Vérifiez votre fichier .env')
    }
    
    console.log('[DocumentExtractionService] Variables OpenRouter:', {
      apiKey: openRouterApiKey ? '✅ Définie' : '❌ Non définie',
      model: openRouterModel,
      fromConfig: !!config?.apiKey,
      fromEnv: !!process.env.OPENROUTER_API_KEY
    })
    
    if (!openRouterApiKey) {
      throw new Error('OPENROUTER_API_KEY non configurée. Vérifiez votre fichier .env')
    }
    
    const messages = [
      {
        role: 'system',
        content: SYSTEM_PROMPT
      },
      {
        role: 'user',
        content: `Voici ${sources.length} document(s) à analyser :\n\n${sources.map((source, index) => 
          `=== DOCUMENT ${index + 1} (${source.type}) ===\n${source.content}\n`
        ).join('\n')}\n\nConsolide toutes ces informations dans un seul objet JSON.`
      }
    ]

    console.log(`[DocumentExtractionService] Appel OpenRouter avec modèle ${openRouterModel}`)
    
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${openRouterApiKey}`,
        'Content-Type': 'application/json',
        'HTTP-Referer': process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000',
        'X-Title': 'GMB Apporteur - Extraction Documents'
      },
      body: JSON.stringify({
        model: openRouterModel,
        messages,
        temperature: 0.1, // Faible température pour plus de cohérence
        max_tokens: 4000
      })
    })

    if (!response.ok) {
      const errorText = await response.text()
      throw new Error(`OpenRouter API error ${response.status}: ${errorText}`)
    }

    const data = await response.json()
    
    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
      throw new Error('Réponse OpenRouter invalide')
    }

    const content = data.choices[0].message.content
    
    try {
      // Parser la réponse JSON en nettoyant les backticks
      let cleanContent = content.trim()
      
      // Supprimer les backticks markdown si présents
      if (cleanContent.startsWith('```json')) {
        cleanContent = cleanContent.replace(/^```json\s*/, '').replace(/\s*```$/, '')
      } else if (cleanContent.startsWith('```')) {
        cleanContent = cleanContent.replace(/^```\s*/, '').replace(/\s*```$/, '')
      }
      
      // Chercher le JSON dans le contenu (entre accolades) si le contenu commence par du texte
      const jsonMatch = cleanContent.match(/\{[\s\S]*\}/)
      if (jsonMatch) {
        cleanContent = jsonMatch[0]
      }
      
      console.log('[DocumentExtractionService] Contenu nettoyé:', cleanContent.substring(0, 200) + '...')
      
      const parsedData = JSON.parse(cleanContent)
      
      // Validation spécifique du conjoint
      return this.validateConjointData(parsedData)
      
    } catch (parseError) {
      console.error('[DocumentExtractionService] Erreur parsing JSON:', parseError)
      console.error('[DocumentExtractionService] Contenu reçu:', content)
      throw new Error('Impossible de parser la réponse JSON d\'OpenRouter')
    }
  }

  /**
   * Validation spécifique des données conjoint
   */
  private static validateConjointData(extractedData: any): ExtractedData {
    // Vérifier la cohérence des données conjoint
    if (extractedData.emprunteurs?.conjoint) {
      const conjoint = extractedData.emprunteurs.conjoint
      
      // Si le conjoint a des données partielles, vérifier la cohérence
      if (conjoint.nom && !conjoint.prenom) {
        extractedData.metadata.warnings.push('Données conjoint incomplètes - nom sans prénom')
      }
      
      if (conjoint.prenom && !conjoint.nom) {
        extractedData.metadata.warnings.push('Données conjoint incomplètes - prénom sans nom')
      }
      
      // Si les données sont trop incomplètes, considérer comme null
      if (!conjoint.nom && !conjoint.prenom && !conjoint.dateNaissance) {
        extractedData.emprunteurs.conjoint = null
        extractedData.metadata.warnings.push('Conjoint détecté mais données insuffisantes - ignoré')
      }
    }
    
    return extractedData
  }

  /**
   * Appel à OpenRouter avec extraction ciblée (date effective fournie)
   */
  private static async callOpenRouterWithData(sources: DocumentSource[], dateEffective: string, config?: { apiKey?: string, model?: string }): Promise<any> {
    const openRouterApiKey = config?.apiKey || process.env.OPENROUTER_API_KEY || process.env.NEXT_PUBLIC_OPENROUTER_API_KEY
    const openRouterModel = config?.model || process.env.OPENROUTER_MODEL || process.env.NEXT_PUBLIC_OPENROUTER_MODEL
    
    if (!openRouterModel) {
      throw new Error('OPENROUTER_MODEL non configuré. Vérifiez votre fichier .env')
    }
    
    console.log('[DocumentExtractionService] Variables OpenRouter:', {
      apiKey: openRouterApiKey ? '✅ Définie' : '❌ Non définie',
      model: openRouterModel,
      fromConfig: !!config?.apiKey,
      fromEnv: !!process.env.OPENROUTER_API_KEY
    })
    
    if (!openRouterApiKey) {
      throw new Error('OPENROUTER_API_KEY non configurée. Vérifiez votre fichier .env')
    }

    console.log(`[DocumentExtractionService] Appel OpenRouter avec modèle ${openRouterModel}`)

    // Construire le contenu du message utilisateur avec format structuré
    const userContent = [
      {
        type: 'text',
        text: `Analyse les documents suivants. La date effective pour laquelle je cherche les lignes du tableau d'amortissement est : ${dateEffective}.\n\nConsolide toutes ces informations dans un seul objet JSON.`
      }
    ]

    // Ajouter chaque document au format OpenRouter
    for (const source of sources) {
      // Extraire l'URL de la chaîne [DOCUMENT_URL:...]
      const urlMatch = source.content.match(/\[DOCUMENT_URL:(.*?)\]/)
      if (urlMatch && urlMatch[1]) {
        console.log(`[DocumentExtractionService] Ajout document OpenRouter: ${urlMatch[1]}`)
        userContent.push({
          type: 'file', // Format OpenRouter pour les documents
          file: {
            filename: `${source.type}.pdf`,
            file_data: urlMatch[1]
          }
        } as any) // Type assertion pour compatibilité avec différents formats d'API
      } else {
        // Si ce n'est pas une URL, traiter comme du texte
        userContent.push({
          type: 'text',
          text: `=== DOCUMENT (${source.type}) ===\n${source.content}\n`
        })
      }
    }

    const messages = [
      { role: 'system', content: SYSTEM_PROMPT },
      { role: 'user', content: userContent }
    ]

    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${openRouterApiKey}`,
        'Content-Type': 'application/json',
        'HTTP-Referer': 'https://gmb-apporteur.vercel.app',
        'X-Title': 'GMB Apporteur - Extraction Documents'
      },
      body: JSON.stringify({
        model: openRouterModel,
        messages,
        temperature: 0.1,
        max_tokens: 4000,
        plugins: [
          {
            id: "file-parser",
            pdf: {
              engine: "pdf-text" // Gratuit pour les PDF bien structurés
            }
          }
        ]
      })
    })

    if (!response.ok) {
      const errorText = await response.text()
      throw new Error(`Erreur OpenRouter ${response.status}: ${errorText}`)
    }

    const data = await response.json()
    const content = data.choices[0]?.message?.content

    if (!content) {
      throw new Error('Réponse vide d\'OpenRouter')
    }

    try {
      // Parser la réponse JSON en nettoyant les backticks
      let cleanContent = content.trim()
      
      // Supprimer les backticks markdown si présents
      if (cleanContent.startsWith('```json')) {
        cleanContent = cleanContent.replace(/^```json\s*/, '').replace(/\s*```$/, '')
      } else if (cleanContent.startsWith('```')) {
        cleanContent = cleanContent.replace(/^```\s*/, '').replace(/\s*```$/, '')
      }
      
      // Chercher le JSON dans le contenu (entre accolades) si le contenu commence par du texte
      const jsonMatch = cleanContent.match(/\{[\s\S]*\}/)
      if (jsonMatch) {
        cleanContent = jsonMatch[0]
      }
      
      console.log('[DocumentExtractionService] Contenu nettoyé:', cleanContent.substring(0, 200) + '...')
      
      const parsedData = JSON.parse(cleanContent)
      
      // Validation spécifique du conjoint
      return this.validateConjointData(parsedData)
      
    } catch (parseError) {
      console.error('[DocumentExtractionService] Erreur parsing JSON:', parseError)
      console.error('[DocumentExtractionService] Contenu reçu:', content)
      throw new Error('Impossible de parser la réponse JSON d\'OpenRouter')
    }
  }

  /**
   * Validation et calculs métier
   */
  private static validateAndCalculate(extractedData: any, dateEffective?: Date): ConsolidatedDataCiblee {
    const consolidated: ConsolidatedDataCiblee = {
      ...extractedData,
      calculs: null
    }

    try {
      // NOUVELLE LOGIQUE : Calculer avec la date effective fournie et les lignes ciblées
      if (dateEffective && extractedData.pret?.dateFin) {
        console.log('[DocumentExtractionService] Calculs métier avec extraction ciblée')
        
        const dureeRestanteMois = this.calculateDureeRestante(
          parseISO(extractedData.pret.dateFin),
          dateEffective
        )
        
        // Calcul du CRD avec les lignes ciblées
        const capitalRestantDu = this.calculateCRDEffective(
          extractedData.lignesAmortissementCibles?.echeanceAvant,
          extractedData.lignesAmortissementCibles?.echeanceApres,
          dateEffective
        )
        
        consolidated.calculs = {
          dateDebutEffective: format(dateEffective, 'yyyy-MM-dd'),
          dureeRestanteMois,
          capitalRestantDu
        }
      } else {
        consolidated.metadata.warnings.push('Données prêt ou date effective manquantes - calculs métier impossibles')
      }
      
    } catch (error: any) {
      console.error('[DocumentExtractionService] Erreur calculs métier:', error)
      consolidated.metadata.warnings.push(`Erreur calculs métier: ${error.message}`)
    }

    return consolidated
  }


  /**
   * Calcul de la durée restante en mois
   */
  private static calculateDureeRestante(dateFin: Date, dateEffective: Date): number {
    const dureeRestante = differenceInMonths(dateFin, dateEffective)
    
    if (dureeRestante <= 0) {
      throw new Error('La date de début effective est postérieure à la date de fin du prêt')
    }
    
    return dureeRestante
  }

  /**
   * Calcul du CRD par interpolation linéaire
   */
  private static calculateCRDEffective(
    echeanceAvant: any,
    echeanceApres: any,
    dateEffective: Date
  ): number {
    if (!echeanceAvant || !echeanceApres) {
      throw new Error('Lignes d\'amortissement cibles manquantes pour le calcul du CRD')
    }
    
    // Si la date effective correspond exactement à une échéance
    if (echeanceAvant.date === echeanceApres.date) {
      return echeanceAvant.capitalRestantDu
    }
    
    // Calculer l'amortissement journalier moyen
    const dateAvant = parseISO(echeanceAvant.date)
    const dateApres = parseISO(echeanceApres.date)
    const joursEntreEcheances = differenceInDays(dateApres, dateAvant)
    
    const amortissementEntreEcheances = echeanceAvant.capitalRestantDu - echeanceApres.capitalRestantDu
    const amortissementJournalier = amortissementEntreEcheances / joursEntreEcheances
    
    // Calculer le nombre de jours depuis l'échéance précédente
    const joursDepuisEcheanceAvant = differenceInDays(dateEffective, dateAvant)
    
    // Calculer le CRD à la date effective
    const crdEffective = echeanceAvant.capitalRestantDu - (amortissementJournalier * joursDepuisEcheanceAvant)
    
    console.log(`[DocumentExtractionService] Calcul CRD optimisé: ${echeanceAvant.capitalRestantDu} - (${amortissementJournalier} × ${joursDepuisEcheanceAvant}) = ${crdEffective}`)
    
    return Math.round(crdEffective)
  }

  /**
   * Trouve l'échéance juste avant la date effective
   */
  private static findEcheanceBefore(tableau: Echeance[], dateEffective: Date): Echeance | null {
    const dateEffectiveStr = format(dateEffective, 'yyyy-MM-dd')
    
    return tableau
      .filter(echeance => echeance.date <= dateEffectiveStr)
      .sort((a, b) => b.date.localeCompare(a.date))[0] || null
  }

  /**
   * Trouve l'échéance juste après la date effective
   */
  private static findEcheanceAfter(tableau: Echeance[], dateEffective: Date): Echeance | null {
    const dateEffectiveStr = format(dateEffective, 'yyyy-MM-dd')
    
    return tableau
      .filter(echeance => echeance.date >= dateEffectiveStr)
      .sort((a, b) => a.date.localeCompare(b.date))[0] || null
  }

  /**
   * Sauvegarde des données extraites dans pret_data ET dans dossiers (données client)
   */
  static async saveExtractedData(dossierId: string, extractedData: ConsolidatedDataCiblee): Promise<boolean> {
    try {
      if (!extractedData.pret) {
        throw new Error('Données prêt manquantes pour la sauvegarde')
      }
      
      // Les calculs peuvent être partiels si le tableau d'amortissement est manquant
      if (!extractedData.calculs) {
        console.warn('[DocumentExtractionService] Calculs métier manquants - sauvegarde partielle')
      }

      const pretData = {
        banque_preteuse: extractedData.pret.banquePreteuse || 'Non spécifiée',
        montant_capital: extractedData.pret.montantInitial || 0,
        duree_mois: extractedData.pret.dureeInitialeMois || 0, // Durée totale INITIALE du prêt
        type_pret: extractedData.pret.typePret || 'immobilier',
        taux_nominal: extractedData.pret.tauxNominal || 0,
        cout_assurance_banque: extractedData.pret.coutAssuranceMensuel || null, // Coût mensuel de l'assurance actuelle
        date_debut: extractedData.pret.dateDebut,
        date_fin: extractedData.pret.dateFin,
        date_debut_effective: extractedData.calculs?.dateDebutEffective || null,
        duree_restante_mois: extractedData.calculs?.dureeRestanteMois || null, // Durée RESTANTE calculée
        capital_restant_du: extractedData.calculs?.capitalRestantDu || null
      }

      await PretDataService.upsertByDossierId(dossierId, pretData)
      
      // Sauvegarder les données client extraites pour comparaison ultérieure
      if (extractedData.emprunteurs) {
        const { supabase } = await import('@/lib/supabase')
        
        const extractedClientData = {
          principal: extractedData.emprunteurs.principal || null,
          conjoint: extractedData.emprunteurs.conjoint || null,
          nombreAssures: (extractedData as any).nombreAssures || (extractedData.emprunteurs.conjoint ? 2 : 1),
          champsManquants: (extractedData.metadata as any).champsManquants || []
        }
        
        const { error: updateError } = await supabase
          .from('dossiers')
          .update({
            extracted_client_data: extractedClientData,
            last_extraction_at: new Date().toISOString(),
            comparison_modal_seen: false // Reset le flag pour afficher la modale
          })
          .eq('id', dossierId)
        
        if (updateError) {
          console.error('[DocumentExtractionService] Erreur sauvegarde données client:', updateError)
        } else {
          console.log('[DocumentExtractionService] Données client extraites sauvegardées pour comparaison future')
        }
      }
      
      console.log(`[DocumentExtractionService] Données sauvegardées pour dossier ${dossierId}`)
      return true
      
    } catch (error) {
      console.error('[DocumentExtractionService] Erreur sauvegarde:', error)
      return false
    }
  }
}

================
File: lib/services/documents.ts
================
import { supabase } from '@/lib/supabase'
import { Database } from '@/types/supabase'

type DocumentRow = Database['public']['Tables']['documents']['Row']
type DocumentInsert = Database['public']['Tables']['documents']['Insert']

export class DocumentsService {
  /**
   * Liste tous les documents d'un dossier
   */
  static async listByDossierId(dossierId: string) {
    const { data, error } = await supabase
      .from('documents')
      .select('*')
      .eq('dossier_id', dossierId)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('[DocumentsService.listByDossierId] error', error)
      throw error
    }
    return (data || []) as DocumentRow[]
  }

  /**
   * Upload un document vers Supabase Storage
   */
  static async uploadDocument(file: File, dossierId: string, documentType: string): Promise<string> {
    try {
      // Créer un nom de fichier unique
      const timestamp = Date.now()
      const fileExtension = file.name.split('.').pop()
      const fileName = `${dossierId}/${documentType}_${timestamp}.${fileExtension}`

      // Upload vers Supabase Storage
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('documents')
        .upload(fileName, file, {
          cacheControl: '3600',
          upsert: false
        })

      if (uploadError) {
        console.error('[DocumentsService.uploadDocument] upload error', uploadError)
        throw uploadError
      }

      // Retourner le chemin de stockage (storage_path) au lieu de l'URL publique
      return uploadData.path
    } catch (error) {
      console.error('[DocumentsService.uploadDocument] error', error)
      throw error
    }
  }

  /**
   * Enregistre un document dans la base de données
   */
  static async createDocument(documentData: DocumentInsert): Promise<DocumentRow> {
    const { data, error } = await supabase
      .from('documents')
      .insert(documentData)
      .select()
      .single()

    if (error) {
      console.error('[DocumentsService.createDocument] error', error)
      throw error
    }

    return data as DocumentRow
  }

  /**
   * Upload et enregistre un document complet
   */
  static async uploadAndCreateDocument(
    file: File,
    dossierId: string,
    documentType: string,
    _metadata?: Record<string, any> // Note: metadata not stored in documents table
  ): Promise<DocumentRow> {
    try {
      // Upload le fichier
      const fileUrl = await this.uploadDocument(file, dossierId, documentType)

      // Enregistrer en base
      const documentData: DocumentInsert = {
        dossier_id: dossierId,
        document_type: documentType,
        document_name: file.name,
        file_size: file.size,
        storage_path: fileUrl, // fileUrl est maintenant le chemin stocké
        mime_type: file.type || null,
        uploaded_by: (await supabase.auth.getUser()).data.user?.id || null
      }

      return await this.createDocument(documentData)
    } catch (error) {
      console.error('[DocumentsService.uploadAndCreateDocument] error', error)
      throw error
    }
  }

  /**
   * Upload multiple documents pour un dossier
   */
  static async uploadMultipleDocuments(
    documents: Record<string, File>,
    dossierId: string
  ): Promise<DocumentRow[]> {
    const uploadPromises = Object.entries(documents)
      .filter(([_, file]) => file !== null)
      .map(([documentType, file]) =>
        this.uploadAndCreateDocument(file, dossierId, documentType)
      )

    try {
      const results = await Promise.all(uploadPromises)
      console.log(`[DocumentsService.uploadMultipleDocuments] uploaded ${results.length} documents`)
      return results
    } catch (error) {
      console.error('[DocumentsService.uploadMultipleDocuments] error', error)
      throw error
    }
  }

  /**
   * Supprime un document
   */
  static async deleteDocument(documentId: string): Promise<void> {
    // Récupérer les infos du document
    const { data: document, error: fetchError } = await supabase
      .from('documents')
      .select('storage_path')
      .eq('id', documentId)
      .single()

    if (fetchError) {
      console.error('[DocumentsService.deleteDocument] fetch error', fetchError)
      throw fetchError
    }

    // Supprimer le fichier du storage
    if (document.storage_path) {
      const { error: storageError } = await supabase.storage
        .from('documents')
        .remove([document.storage_path])

      if (storageError) {
        console.error('[DocumentsService.deleteDocument] storage error', storageError)
        // Continue même si le storage échoue
      }
    }

    // Supprimer l'enregistrement de la base
    const { error: deleteError } = await supabase
      .from('documents')
      .delete()
      .eq('id', documentId)

    if (deleteError) {
      console.error('[DocumentsService.deleteDocument] delete error', deleteError)
      throw deleteError
    }
  }
}

================
File: lib/services/dossier-read-status.ts
================
import { supabase } from '@/lib/supabase'

export class DossierReadStatusService {
  /**
   * Marque un dossier comme lu
   */
  static async markAsRead(dossierId: string) {
    const { error } = await supabase
      .from('dossiers')
      .update({ is_read: true })
      .eq('id', dossierId)

    if (error) {
      console.error('Erreur lors du marquage du dossier comme lu:', error)
      throw error
    }
  }

  /**
   * Marque un dossier comme non lu
   */
  static async markAsUnread(dossierId: string) {
    const { error } = await supabase
      .from('dossiers')
      .update({ is_read: false })
      .eq('id', dossierId)

    if (error) {
      console.error('Erreur lors du marquage du dossier comme non lu:', error)
      throw error
    }
  }

  /**
   * Marque plusieurs dossiers comme lus
   */
  static async markMultipleAsRead(dossierIds: string[]) {
    if (dossierIds.length === 0) return

    const { error } = await supabase
      .from('dossiers')
      .update({ is_read: true })
      .in('id', dossierIds)

    if (error) {
      console.error('Erreur lors du marquage multiple des dossiers comme lus:', error)
      throw error
    }
  }

  /**
   * Récupère les statistiques de dossiers non lus par apporteur
   */
  static async getUnreadStatsByApporteur() {
    const { data, error } = await supabase
      .from('dossiers')
      .select(`
        apporteur_id,
        apporteur_profiles!inner(
          id,
          nom,
          prenom
        )
      `)
      .eq('is_read', false)

    if (error) {
      console.error('Erreur lors de la récupération des stats non lus:', error)
      throw error
    }

    // Compter par apporteur
    const stats: Record<string, number> = {}
    data?.forEach(dossier => {
      const apporteurId = dossier.apporteur_id
      if (apporteurId) {
        stats[apporteurId] = (stats[apporteurId] || 0) + 1
      }
    })

    return stats
  }
}

================
File: lib/services/dossiers.ts
================
import { supabase } from '@/lib/supabase'
import { Database } from '@/types/supabase'

type Dossier = Database['public']['Tables']['dossiers']['Row']
type DossierInsert = Database['public']['Tables']['dossiers']['Insert']
type DossierUpdate = Database['public']['Tables']['dossiers']['Update']

export class DossiersService {
  /**
   * Récupère tous les dossiers avec les informations jointes
   */
  static async getAllDossiers(brokerId?: string) {
    // Lire la vue pour centraliser le statut affiché
    const { data: viewRows, error: viewError } = await supabase
      .from('dossiers_with_computed_status')
      .select('*')
      .order('created_at', { ascending: false })

    if (viewError) {
      console.error('[DossiersService.getAllDossiers] view error', viewError)
      throw viewError
    }

    // Joindre les informations complémentaires depuis les tables sources
    const { data, error } = await supabase
      .from('dossiers')
      .select(`
        id,
        numero_dossier,
        apporteur_id,
        type_dossier,
        is_couple,
        date_creation,
        created_at,
        updated_at,
        statut:statut_canon,
        devis_selectionne_id,
        is_read,
        client_infos (
          client_nom,
          client_prenom,
          client_email,
          client_telephone
        ),
        pret_data (
          banque_preteuse,
          montant_capital,
          duree_mois,
          type_pret
        ),
        devis:devis!devis_dossier_id_fkey (
          id,
          numero_devis,
          statut,
          date_generation
        ),
        devis_selectionne:devis!dossiers_devis_selectionne_id_fkey (
          id,
          numero_devis,
          statut,
          date_generation
        ),
        apporteur_profiles (
          nom,
          prenom,
          email
        )
      `)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('Erreur lors de la récupération des dossiers:', error)
      throw error
    }

    // Fusionner computed_statut de la vue
    const computedById = new Map((viewRows || []).map((r: any) => [r.id, r.computed_statut]))
    return (data || []).map((row: any) => ({
      ...row,
      computed_statut: computedById.get(row.id) || row.statut
    }))
  }

  /**
   * Récupère un dossier par son ID avec toutes les informations
   */
  static async getDossierById(id: string) {
    const [{ data: viewRow }, { data, error }] = await Promise.all([
      supabase.from('dossiers_with_computed_status').select('*').eq('id', id).maybeSingle(),
      supabase
        .from('dossiers')
        .select(`
          id,
          numero_dossier,
          apporteur_id,
          type_dossier,
          is_couple,
          commentaire,
          date_creation,
          created_at,
          updated_at,
          statut:statut_canon,
          devis_selectionne_id,
          is_read,
          client_infos (*),
          pret_data (*),
          devis:devis!devis_dossier_id_fkey (
            id,
            numero_devis,
            statut,
            donnees_devis,
            motif_refus,
            date_generation,
            date_envoi,
            date_acceptation,
            date_expiration,
            pdf_url,
            created_at,
            updated_at
          ),
          devis_selectionne:devis!dossiers_devis_selectionne_id_fkey (*),
          process_steps (*),
          documents (*)
        `)
        .eq('id', id)
        .single()
    ])

    if (error) {
      console.error('Erreur lors de la récupération du dossier:', error)
      throw error
    }

    return { ...data, computed_statut: (viewRow as any)?.computed_statut }
  }

  /**
   * Récupère les dossiers d'un apporteur spécifique
   */
  static async getDossiersByApporteur(apporteurId: string) {
    const [{ data: viewRows }, { data, error }] = await Promise.all([
      supabase.from('dossiers_with_computed_status').select('*').in('apporteur_id', [apporteurId]),
      supabase
        .from('dossiers')
        .select(`
          id,
          numero_dossier,
          apporteur_id,
          type_dossier,
          date_creation,
          created_at,
          updated_at,
          statut:statut_canon,
          devis_selectionne_id,
          is_read,
          client_infos (
            client_nom,
            client_prenom,
            client_email,
            client_telephone
          ),
          pret_data (
            banque_preteuse,
            montant_capital,
            duree_mois,
            type_pret
          ),
          devis:devis!devis_dossier_id_fkey (
            id,
            numero_devis,
            statut
          )
        `)
        .eq('apporteur_id', apporteurId)
        .order('created_at', { ascending: false })
    ])

    if (error) {
      console.error('Erreur lors de la récupération des dossiers apporteur:', error)
      throw error
    }

    const computedById = new Map((viewRows || []).map((r: any) => [r.id, r.computed_statut]))
    return (data || []).map((row: any) => ({
      ...row,
      computed_statut: computedById.get(row.id) || row.statut
    }))
  }

  /**
   * Crée un nouveau dossier
   */
  static async createDossier(dossierData: DossierInsert) {
    const { data, error } = await supabase
      .from('dossiers')
      .insert(dossierData)
      .select()
      .single()

    if (error) {
      console.error('Erreur lors de la création du dossier:', error)
      throw error
    }

    return data
  }

  /**
   * Met à jour un dossier
   */
  static async updateDossier(id: string, updates: DossierUpdate) {
    console.log('[DossiersService.updateDossier] input', { id, updates })
    // Rediriger les mises à jour de statut vers la colonne canonique
    const payload: any = { ...updates }
    if ((updates as any)?.statut !== undefined) {
      payload.statut_canon = (updates as any).statut
      delete payload.statut
      console.log('[DossiersService.updateDossier] remapped statut -> statut_canon', { statut_canon: payload.statut_canon })
    }

    const { data, error } = await supabase
      .from('dossiers')
      .update(payload)
      .eq('id', id)
      .select()
      .maybeSingle()

    if (error) {
      console.error('[DossiersService.updateDossier] supabase error', error)
      throw error
    }

    if (!data) {
      console.warn('[DossiersService.updateDossier] no row returned (possible RLS or id not found)', { id, updates })
      return null as unknown as Dossier
    }

    console.log('[DossiersService.updateDossier] output', data)
    return data
  }

  /**
   * Supprime un dossier
   * Crée une activité dossier_supprime AVANT la suppression
   */
  static async deleteDossier(id: string) {
    console.log(`[DossiersService.deleteDossier] Début suppression dossier ${id}`)

    // 1. Récupérer les infos du dossier AVANT suppression
    const { data: dossierData, error: fetchError } = await supabase
      .from('dossiers')
      .select(`
        numero_dossier, 
        apporteur_id,
        client_infos(client_prenom, client_nom)
      `)
      .eq('id', id)
      .single()

    if (fetchError) {
      console.error('[DossiersService.deleteDossier] Erreur récupération dossier:', fetchError)
      throw fetchError
    }

    console.log(`[DossiersService.deleteDossier] Dossier trouvé: ${dossierData.numero_dossier}`)

    // 2. Créer l'activité de suppression pour l'apporteur (si existe)
    if (dossierData.apporteur_id) {
      try {
        console.log(`[DossiersService.deleteDossier] Création activité dossier_supprime pour apporteur ${dossierData.apporteur_id}`)

        // Extraire les infos client (peut être un array ou un objet)
        const clientInfo = Array.isArray(dossierData.client_infos)
          ? dossierData.client_infos[0]
          : dossierData.client_infos

        const clientPrenom = (clientInfo as any)?.client_prenom || ''
        const clientNom = (clientInfo as any)?.client_nom || ''

        const description = clientPrenom && clientNom
          ? `Le dossier de ${clientPrenom} ${clientNom} a été supprimé par l'administrateur.`
          : `Le dossier ${dossierData.numero_dossier} a été supprimé par l'administrateur.`

        await supabase
          .from('activities')
          .insert({
            user_id: dossierData.apporteur_id,
            dossier_id: id,
            activity_type: 'dossier_supprime',
            activity_title: 'Dossier supprimé',
            activity_description: description,
            activity_data: {
              dossier_numero: dossierData.numero_dossier,
              client_prenom: clientPrenom,
              client_nom: clientNom,
              deleted_by: 'admin',
              deleted_at: new Date().toISOString()
            }
          })

        console.log('[DossiersService.deleteDossier] Activité dossier_supprime créée')
      } catch (activityError) {
        console.warn('[DossiersService.deleteDossier] Erreur création activité (non bloquante):', activityError)
      }
    } else {
      console.log('[DossiersService.deleteDossier] Pas d\'apporteur associé, pas d\'activité créée')
    }

    // 3. Supprimer le dossier (cascade delete géré par la DB)
    console.log(`[DossiersService.deleteDossier] Suppression du dossier ${id}`)
    const { error } = await supabase
      .from('dossiers')
      .delete()
      .eq('id', id)

    if (error) {
      console.error('[DossiersService.deleteDossier] Erreur lors de la suppression du dossier:', error)
      throw error
    }

    console.log(`[DossiersService.deleteDossier] ✅ Dossier ${id} supprimé avec succès`)
    return true
  }

  /**
   * Récupère les statistiques des dossiers
   */
  static async getDossierStats(brokerId?: string) {
    const { data, error } = await supabase
      .from('dossiers')
      .select('statut:statut_canon, montant_capital')

    if (error) {
      console.error('Erreur lors de la récupération des statistiques:', error)
      throw error
    }

    // Calcul des statistiques
    const stats = {
      total: data.length,
      parStatut: {} as Record<string, number>,
      montantTotal: 0,
      montantMoyen: 0
    }

    data.forEach((dossier: any) => {
      // Compter par statut
      stats.parStatut[dossier.statut] = (stats.parStatut[dossier.statut] || 0) + 1

      // Calculer montants si disponibles
      if (dossier.montant_capital) {
        stats.montantTotal += Number(dossier.montant_capital)
      }
    })

    stats.montantMoyen = stats.total > 0 ? stats.montantTotal / stats.total : 0

    return stats
  }

  /**
   * Récupère les statistiques complètes pour le dashboard admin
   * ✅ Inclut les progressions mensuelles
   */
  static async getAdminDashboardStats(brokerId?: string) {
    const { data: dossiers, error } = await supabase
      .from('dossiers')
      .select('statut:statut_canon, economie_generee, date_creation, created_at')

    if (error) {
      console.error('Erreur lors de la récupération des stats dashboard:', error)
      throw error
    }

    const now = new Date()
    const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1)
    const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1)
    const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59)

    // Stats globales
    const totalDossiers = dossiers.length
    const dossiersEnAttente = dossiers.filter((d: any) => d.statut === 'en_attente').length
    const dossiersDevisDisponible = dossiers.filter((d: any) => d.statut === 'devis_disponible').length
    const dossiersFinalises = dossiers.filter((d: any) => d.statut === 'finalise').length

    // Stats du mois actuel
    const dossiersFinaliseCeMois = dossiers.filter((d: any) => {
      const dateCreation = new Date(d.date_creation || d.created_at)
      return d.statut === 'finalise' && dateCreation >= currentMonthStart
    }).length

    const economiesCeMois = dossiers
      .filter((d: any) => {
        const dateCreation = new Date(d.date_creation || d.created_at)
        return d.statut === 'finalise' && dateCreation >= currentMonthStart
      })
      .reduce((sum: number, d: any) => sum + Number(d.economie_generee || 0), 0)

    // Stats du mois précédent (pour progression)
    const dossiersFinaliseMoisPrecedent = dossiers.filter((d: any) => {
      const dateCreation = new Date(d.date_creation || d.created_at)
      return d.statut === 'finalise' && dateCreation >= lastMonthStart && dateCreation <= lastMonthEnd
    }).length

    const economiesMoisPrecedent = dossiers
      .filter((d: any) => {
        const dateCreation = new Date(d.date_creation || d.created_at)
        return d.statut === 'finalise' && dateCreation >= lastMonthStart && dateCreation <= lastMonthEnd
      })
      .reduce((sum: number, d: any) => sum + Number(d.economie_generee || 0), 0)

    // Calcul des progressions
    const progressionDossiers = dossiersFinaliseMoisPrecedent === 0
      ? 0
      : Math.round(((dossiersFinaliseCeMois - dossiersFinaliseMoisPrecedent) / dossiersFinaliseMoisPrecedent) * 100)

    const progressionEconomies = economiesMoisPrecedent === 0
      ? 0
      : Math.round(((economiesCeMois - economiesMoisPrecedent) / economiesMoisPrecedent) * 100)

    // Total des économies (tous les dossiers finalisés)
    const economiesTotal = dossiers
      .filter((d: any) => d.statut === 'finalise')
      .reduce((sum: number, d: any) => sum + Number(d.economie_generee || 0), 0)

    return {
      totalDossiers,
      dossiersEnAttente,
      dossiersDevisDisponible,
      dossiersFinalises,
      dossiersFinaliseCeMois,
      economiesCeMois,
      economiesTotal,
      progressionDossiers,
      progressionEconomies
    }
  }

  /**
   * ✅ STATISTIQUES PAGE - Récupère les KPIs globaux pour une période donnée
   */
  static async getStatistiquesPeriode(startDate: string, endDate: string, brokerId?: string) {
    try {
      // Récupérer tous les dossiers de la période avec les données de prêt
      // ✅ Utilise date_creation (date métier) au lieu de created_at (date d'insertion DB)
      const { data: dossiers, error } = await supabase
        .from('dossiers')
        .select(`
          id,
          statut:statut_canon,
          economie_generee,
          created_at,
          date_creation,
          pret_data (
            montant_capital
          )
        `)
        .gte('date_creation', startDate)
        .lte('date_creation', endDate)

      if (error) {
        console.error('[DossiersService.getStatistiquesPeriode] Erreur:', error)
        throw error
      }

      // Filtrer les dossiers finalisés
      const dossiersFinalises = dossiers.filter((d: any) => d.statut === 'finalise')

      // Calculer les KPIs
      const nb_dossiers_traites = dossiersFinalises.length

      const economie_moyenne_generee = dossiersFinalises.length > 0
        ? dossiersFinalises.reduce((sum: number, d: any) => sum + Number(d.economie_generee || 0), 0) / dossiersFinalises.length
        : 0

      const capital_total_assure = dossiersFinalises.reduce((sum: number, d: any) => {
        const capital = d.pret_data?.[0]?.montant_capital || 0
        return sum + Number(capital)
      }, 0)

      return {
        nb_dossiers_traites,
        chiffre_affaires_total: 0, // À implémenter plus tard avec système de commission
        economie_moyenne_generee: Math.round(economie_moyenne_generee),
        capital_total_assure: Math.round(capital_total_assure)
      }
    } catch (error) {
      console.error('[DossiersService.getStatistiquesPeriode] Erreur:', error)
      throw error
    }
  }

  /**
   * ✅ STATISTIQUES PAGE - Analyse de l'activité (taux de conversion, délai traitement)
   */
  static async getAnalyseActivite(startDate: string, endDate: string, brokerId?: string) {
    try {
      // ✅ Utilise date_creation (date métier) pour le filtre
      const { data: dossiers, error } = await supabase
        .from('dossiers')
        .select('id, statut:statut_canon, created_at, date_creation, date_finalisation')
        .gte('date_creation', startDate)
        .lte('date_creation', endDate)

      if (error) {
        console.error('[DossiersService.getAnalyseActivite] Erreur:', error)
        throw error
      }

      const nb_dossiers_soumis = dossiers.length
      const dossiersFinalises = dossiers.filter((d: any) => d.statut === 'finalise')
      const nb_dossiers_finalises = dossiersFinalises.length

      const taux_conversion_global = nb_dossiers_soumis > 0
        ? Math.round((nb_dossiers_finalises / nb_dossiers_soumis) * 100 * 10) / 10
        : 0

      // Calcul du délai moyen UNIQUEMENT pour les dossiers avec date_finalisation
      const dossiersAvecDelai = dossiersFinalises.filter((d: any) => d.date_finalisation)
      const delai_traitement_moyen = dossiersAvecDelai.length > 0
        ? dossiersAvecDelai.reduce((sum: number, d: any) => {
          const created = new Date(d.created_at).getTime()
          const finalized = new Date(d.date_finalisation).getTime()
          const delaiJours = (finalized - created) / (1000 * 60 * 60 * 24)
          return sum + delaiJours
        }, 0) / dossiersAvecDelai.length
        : 0

      return {
        taux_conversion_global,
        delai_traitement_moyen: Math.round(delai_traitement_moyen * 10) / 10,
        nb_dossiers_soumis,
        nb_dossiers_finalises
      }
    } catch (error) {
      console.error('[DossiersService.getAnalyseActivite] Erreur:', error)
      throw error
    }
  }

  /**
   * ✅ STATISTIQUES PAGE - Évolution temporelle (par mois)
   */
  static async getEvolutionTemporelle(startDate: string, endDate: string, brokerId?: string) {
    try {
      // ✅ Utilise date_creation (date métier) pour le filtre et le tri
      const { data: dossiers, error } = await supabase
        .from('dossiers')
        .select('id, statut:statut_canon, economie_generee, created_at, date_creation')
        .eq('statut_canon', 'finalise')
        .gte('date_creation', startDate)
        .lte('date_creation', endDate)
        .order('date_creation', { ascending: true })

      if (error) {
        console.error('[DossiersService.getEvolutionTemporelle] Erreur:', error)
        throw error
      }

      // Grouper par mois en utilisant date_creation (date métier)
      const parMois: Record<string, { nb_dossiers: number; economies_generees: number }> = {}

      dossiers.forEach((d: any) => {
        const date = new Date(d.date_creation || d.created_at)
        const moisKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`

        if (!parMois[moisKey]) {
          parMois[moisKey] = { nb_dossiers: 0, economies_generees: 0 }
        }

        parMois[moisKey].nb_dossiers++
        parMois[moisKey].economies_generees += Number(d.economie_generee || 0)
      })

      // Convertir en tableau
      return Object.entries(parMois).map(([periode, stats]) => ({
        periode: `${periode}-01`, // Format YYYY-MM-DD pour compatibilité
        nb_dossiers: stats.nb_dossiers,
        ca_total: 0, // Placeholder
        economies_generees: Math.round(stats.economies_generees)
      }))
    } catch (error) {
      console.error('[DossiersService.getEvolutionTemporelle] Erreur:', error)
      throw error
    }
  }

  /**
   * ✅ STATISTIQUES PAGE - Motifs de refus agrégés
   */
  static async getMotifsRefus(startDate: string, endDate: string, brokerId?: string) {
    try {
      // ✅ Récupère tous les devis refusés puis filtre en JS (pour gérer date_generation null)
      const { data: devis, error } = await supabase
        .from('devis')
        .select('id, donnees_devis, motif_refus, statut, created_at, date_generation')
        .eq('statut', 'refuse')

      if (error) {
        console.error('[DossiersService.getMotifsRefus] Erreur:', error)
        throw error
      }

      // Filtrer par date (utilise date_generation ou fallback sur created_at)
      const start = new Date(startDate).getTime()
      const end = new Date(endDate).getTime()
      const devisFiltres = devis.filter((d: any) => {
        const date = new Date(d.date_generation || d.created_at).getTime()
        return date >= start && date <= end
      })

      // Agréger les motifs
      const compteurMotifs: Record<string, number> = {}

      devisFiltres.forEach((d: any) => {
        // Chercher le motif dans donnees_devis (JSONB) ou motif_refus (colonne directe)
        const motif = d.donnees_devis?.motif_refus || d.motif_refus || 'Non spécifié'
        compteurMotifs[motif] = (compteurMotifs[motif] || 0) + 1
      })

      const totalRefus = devisFiltres.length

      // Convertir en tableau et calculer pourcentages
      return Object.entries(compteurMotifs)
        .map(([motif, nombre]) => ({
          motif,
          nombre,
          pourcentage: totalRefus > 0 ? Math.round((nombre / totalRefus) * 100 * 10) / 10 : 0
        }))
        .sort((a, b) => b.nombre - a.nombre) // Trier par nombre décroissant
    } catch (error) {
      console.error('[DossiersService.getMotifsRefus] Erreur:', error)
      return []
    }
  }

  /**
   * Récupère l'historique complet des devis pour un dossier
   */
  static async getDevisHistory(dossierId: string) {
    const { data, error } = await supabase.rpc('get_devis_complete_history', {
      p_dossier_id: dossierId
    })

    if (error) {
      console.error('Erreur lors de la récupération de l\'historique des devis:', error)
      throw error
    }

    return data || []
  }

  /**
   * Récupère l'historique des devis pour un dossier (version apporteur - sans renvoi)
   */
  static async getDevisApporteurHistory(dossierId: string) {
    const { data, error } = await supabase.rpc('get_devis_apporteur_history', {
      p_dossier_id: dossierId
    })

    if (error) {
      console.error('Erreur lors de la récupération de l\'historique des devis apporteur:', error)
      throw error
    }

    return data || []
  }

  /**
   * Recherche des dossiers par critères
   */
  static async searchDossiers(criteria: {
    statut?: string
    type_dossier?: string
    numero_dossier?: string
    client_nom?: string
    date_debut?: string
    date_fin?: string
  }, brokerId?: string) {
    let query = supabase
      .from('dossiers')
      .select(`
        id,
        numero_dossier,
        apporteur_id,
        type_dossier,
        date_creation,
        created_at,
        updated_at,
        statut:statut_canon,
        client_infos (
          client_nom,
          client_prenom,
          client_email
        ),
        pret_data (
          montant_capital,
          banque_preteuse
        )
      `)

    // Appliquer les filtres
    if (criteria.statut) {
      query = query.eq('statut_canon', criteria.statut)
    }
    if (criteria.type_dossier) {
      query = query.eq('type_dossier', criteria.type_dossier)
    }
    if (criteria.numero_dossier) {
      query = query.ilike('numero_dossier', `%${criteria.numero_dossier}%`)
    }
    if (criteria.date_debut) {
      query = query.gte('created_at', criteria.date_debut)
    }
    if (criteria.date_fin) {
      query = query.lte('created_at', criteria.date_fin)
    }

    const { data, error } = await query.order('created_at', { ascending: false })

    if (error) {
      console.error('Erreur lors de la recherche des dossiers:', error)
      throw error
    }

    // Filtrer par nom client côté client si nécessaire
    let filteredData = data
    if (criteria.client_nom && data) {
      filteredData = data.filter((dossier: any) =>
        dossier.client_infos?.client_nom?.toLowerCase().includes(criteria.client_nom!.toLowerCase())
      )
    }

    return filteredData
  }

  /**
   * Change le type de dossier (seul <-> couple)
   */
  static async changeDossierType(dossierId: string, newType: 'seul' | 'couple'): Promise<void> {
    console.log('═══════════════════════════════════════════')
    console.log(`[DossiersService.changeDossierType] 🔄 DÉBUT Changement type dossier`)
    console.log(`[DossiersService.changeDossierType] Dossier ID: ${dossierId}`)
    console.log(`[DossiersService.changeDossierType] Nouveau type: ${newType}`)

    // Convertir le type en boolean pour is_couple
    const isCouple = newType === 'couple'

    // 1. Mettre à jour is_couple dans la table dossiers
    console.log(`[DossiersService.changeDossierType] 📝 UPDATE dossiers SET is_couple = ${isCouple} WHERE id = '${dossierId}'`)

    const { data: updateData, error: dossierError } = await supabase
      .from('dossiers')
      .update({ is_couple: isCouple })
      .eq('id', dossierId)
      .select()

    if (dossierError) {
      console.error('[DossiersService.changeDossierType] ❌ ERREUR mise à jour dossier:', dossierError)
      console.error('[DossiersService.changeDossierType] Code erreur:', dossierError.code)
      console.error('[DossiersService.changeDossierType] Message:', dossierError.message)
      console.error('[DossiersService.changeDossierType] Détails:', dossierError.details)
      console.error('[DossiersService.changeDossierType] Hint:', dossierError.hint)
      throw dossierError
    }

    console.log('[DossiersService.changeDossierType] ✅ is_couple mis à jour')
    console.log('[DossiersService.changeDossierType] Données retournées:', updateData)

    // 2. Si passage vers "seul", supprimer les données du conjoint dans client_infos
    if (newType === 'seul') {
      console.log('[DossiersService.changeDossierType] 🧹 Nettoyage données conjoint...')

      const { data: clientData, error: clientError } = await supabase
        .from('client_infos')
        .update({
          conjoint_civilite: null,
          conjoint_nom: null,
          conjoint_prenom: null,
          conjoint_nom_naissance: null,
          conjoint_date_naissance: null,
          conjoint_email: null,
          conjoint_telephone: null,
          conjoint_fumeur: null,
          conjoint_categorie_professionnelle: null,
          conjoint_profession: null,
        })
        .eq('dossier_id', dossierId)
        .select()

      if (clientError) {
        console.error('[DossiersService.changeDossierType] ❌ ERREUR nettoyage données conjoint:', clientError)
        console.error('[DossiersService.changeDossierType] Code erreur:', clientError.code)
        console.error('[DossiersService.changeDossierType] Message:', clientError.message)
        console.error('[DossiersService.changeDossierType] Détails:', clientError.details)
        throw clientError
      }

      console.log('[DossiersService.changeDossierType] ✅ Données conjoint nettoyées')
      console.log('[DossiersService.changeDossierType] Lignes affectées:', clientData)
    }

    console.log(`[DossiersService.changeDossierType] ✅ FIN Changement type vers ${newType}`)
    console.log('═══════════════════════════════════════════')
  }
}

================
File: lib/services/exade.ts
================
import { XMLParser } from 'fast-xml-parser'
import { EXADE_CONFIG, validateExadeConfig } from '@/lib/config/exade'
import {
  formatDateForExade,
  formatFumeurForExade,
  getCiviliteCodeExade,
  EXADE_SEXE
} from '@/lib/constants/exade'

export type ExadeTarif = {
  id_simulation: string
  id_tarif: string
  compagnie: string
  nom: string
  type_tarif: string
  mensualite: number
  cout_total: number
  frais_adhesion: number
  frais_adhesion_apporteur: number
  garanties: Array<{ code: string; libelle: string; cout: number }>
  erreurs?: string[]
  compatible_lemoine?: boolean
}

/**
 * Construit le XML interne (contenu du CDATA) pour la requête de tarification Exade
 * Documentation: WebService_Exade_ASSUREA_Avec_commissionnement_-_3.8.pdf
 */
function buildInnerTarifXml(payload: {
  assure: any
  pret: any
  garanties?: any
  idTarif?: number
}): string {
  const assure = payload.assure || {}
  const pret = payload.pret || {}
  const conjoint = assure.conjoint || null // Si structure { principal: ..., conjoint: ... } ou juste assure

  // 1. Dates
  const dateEffet = pret.date_effet
    ? formatDateForExade(pret.date_effet)
    : new Date().toISOString().slice(0, 10).replace(/-/g, '')

  // 2. Données Prêt
  const capitalCentimes = Math.round((pret.montant_capital || pret.montant || pret.montantInitial || 0) * 100)
  const tauxCentièmes = Math.round((pret.taux_nominal || pret.taux || pret.tauxNominal || 0) * 100)
  const dureeMois = pret.duree_mois || pret.duree || pret.dureeInitialeMois || 240
  const typePret = pret.type_pret_code || 1 // 1 = Amortissable par défaut
  const typeTaux = pret.type_taux_code || 1 // 1 = Fixe par défaut
  const amortissement = 12 // Mensuel par défaut

  // 3. Construction des blocs Assurés
  // On gère 1 ou 2 assurés
  const assuresList = []

  // Assuré 1 (Principal)
  assuresList.push(buildAssureBlock(assure, 1))

  // Assuré 2 (Conjoint) si présent
  if (conjoint) {
    assuresList.push(buildAssureBlock(conjoint, 2))
  }

  // 4. Construction du bloc Prêt
  const pretBlock = `
    <pret>
      <id_pret>1</id_pret>
      <numero>1</numero>
      <type_pret>${typePret}</type_pret>
      <capital>${capitalCentimes}</capital>
      <taux>${tauxCentièmes}</taux>
      <type_taux>${typeTaux}</type_taux>
      <duree>${dureeMois}</duree>
      <differe>${pret.differe || 0}</differe>
      <amortissement>${amortissement}</amortissement>
      <date_deblocage>${dateEffet}</date_deblocage>
    </pret>
  `

  // 5. Construction des blocs Garantie_Pret
  // Il faut lier chaque assuré au prêt avec une garantie et une quotité
  const garantieCode = payload.garanties?.code || 2 // Par défaut 2 (DC/PTIA/ITT/IPT)
  const quotite = payload.garanties?.quotite || 100 // Par défaut 100%

  let garantiePretBlocks = ''

  // Pour l'assuré 1
  garantiePretBlocks += `
    <garantie_pret>
      <id_assure>1</id_assure>
      <id_pret>1</id_pret>
      <garantie>${garantieCode}</garantie>
      <quotite>${conjoint ? (quotite / 2) : quotite}</quotite> 
    </garantie_pret>
  `

  // Pour l'assuré 2 (si présent, on divise la quotité par défaut ou on applique la règle)
  if (conjoint) {
    garantiePretBlocks += `
    <garantie_pret>
      <id_assure>2</id_assure>
      <id_pret>1</id_pret>
      <garantie>${garantieCode}</garantie>
      <quotite>${quotite / 2}</quotite>
    </garantie_pret>
    `
  }

  // XML Global - IMPORTANT: PAS de wrapper supplémentaire dans le CDATA (comme dans Postman)
  console.log('[EXADE] Using credentials:', {
    partnerCode: EXADE_CONFIG.partnerCode,
    licenceKeyLength: EXADE_CONFIG.licenceKey?.length || 0,
    licenceKeyPreview: EXADE_CONFIG.licenceKey?.substring(0, 10) + '...',
    soapUrl: EXADE_CONFIG.soapUrl
  })

  return `
<licence>${EXADE_CONFIG.licenceKey}</licence>
<code_courtier>${EXADE_CONFIG.partnerCode}</code_courtier>
<type_operation>1</type_operation>
${payload.idTarif ? `<id_tarif>${payload.idTarif}</id_tarif>` : ''}
<retournerLesErreurs>O</retournerLesErreurs>

<simulation>
  <date_effet>${dateEffet}</date_effet>
  <frac_assurance>12</frac_assurance>
  <type_credit>0</type_credit>
  <id_objetdufinancement>${pret.objet_financement_code || 1}</id_objetdufinancement>

  ${assuresList.join('\n')}

  ${pretBlock}

  ${garantiePretBlocks}
</simulation>
`.trim()
}

function buildAssureBlock(data: any, numero: number): string {
  const dateNaissance = formatDateForExade(data.client_date_naissance || data.date_naissance || data.dateNaissance || '19800101')
  const civilite = getCiviliteCodeExade(data.civilite || data.client_civilite)
  const sexe = data.sexe || (civilite === 'M' ? 'H' : 'F')
  const categPro = data.client_categorie_professionnelle || data.categorie_professionnelle || 1

  return `
  <assure>
    <numero>${numero}</numero>
    <statut>1</statut>
    <sexe>${sexe}</sexe>
    <nom>${data.nom || data.client_nom || 'CLIENT'}</nom>
    <nom_naissance>${data.nom_naissance || data.client_nom_naissance || data.nom || 'CLIENT'}</nom_naissance>
    <prenom>${data.prenom || data.client_prenom || 'Prenom'}</prenom>
    <date_naissance>${dateNaissance}</date_naissance>
    <code_postal>${data.code_postal || data.client_adresse?.match(/\d{5}/)?.[0] || '75001'}</code_postal>
    <ville>${data.ville || 'PARIS'}</ville>
    <portable>${data.portable || data.client_telephone || data.telephone || '+33600000000'}</portable>
    <email>${data.email || data.client_email || 'client@example.com'}</email>
    <fumeur>${formatFumeurForExade(data.fumeur || data.client_fumeur || false)}</fumeur>
    <deplacement_pro>${data.deplacement_pro ?? 1}</deplacement_pro>
    <travaux_manuels>${data.travaux_manuels ?? 0}</travaux_manuels>
    <categ_pro>${categPro}</categ_pro>
    <franchise>${data.franchise ?? 90}</franchise>
    <type_adhesion>${data.type_adhesion ?? 0}</type_adhesion>
    <encours_lemoine>${data.encours_lemoine ?? 0}</encours_lemoine>
  </assure>
  `
}

/**
 * Construit l'enveloppe SOAP conforme à la documentation Exade
 */
function buildSoapEnvelope(innerXml: string): string {
  return `<?xml version="1.0" encoding="utf-8"?>
<soapenv:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
                  xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
                  xmlns:def="http://www.4d.com/namespace/default">
  <soapenv:Header/>
  <soapenv:Body>
    <def:webservice_tarificateur soapenv:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
      <webservice_tarificateurRequest xsi:type="xsd:string">
        <![CDATA[
${innerXml}
        ]]>
      </webservice_tarificateurRequest>
    </def:webservice_tarificateur>
  </soapenv:Body>
</soapenv:Envelope>`
}

/**
 * Parse la réponse SOAP Exade
 */
function parseExadeResponse(xmlText: string): any {
  const parser = new XMLParser({
    ignoreAttributes: false,
    parseAttributeValue: false,
    trimValues: true,
  })

  const outer: any = parser.parse(xmlText)

  const body = outer['SOAP-ENV:Envelope']?.['SOAP-ENV:Body']
    || outer['soapenv:Envelope']?.['soapenv:Body']
    || outer['soap:Envelope']?.['soap:Body']
    || outer['Envelope']?.['Body']

  if (!body) {
    console.error('[EXADE] Available envelope keys:', Object.keys(outer))
    console.error('[EXADE] Outer structure:', JSON.stringify(outer, null, 2).substring(0, 1000))
    throw new Error('[EXADE] Réponse SOAP inattendue: pas de Body trouvé')
  }

  console.log('[EXADE] Body keys:', Object.keys(body))

  // Check for SOAP Fault first
  const fault = body['SOAP-ENV:Fault'] || body['soapenv:Fault'] || body['soap:Fault'] || body['Fault']
  if (fault) {
    const faultString = fault.faultstring || fault['faultstring'] || 'Erreur SOAP inconnue'
    const faultCode = fault.faultcode || fault['faultcode'] || 'Unknown'
    console.error('[EXADE] SOAP Fault detected:', { faultCode, faultString })
    throw new Error(`[EXADE] Erreur SOAP: ${faultString} (code: ${faultCode})`)
  }

  const responseNode =
    body['ns1:webservice_tarificateurResponse']
    || body['webservice_tarificateurResponse']
    || Object.values(body).find((v: any) => v && typeof v === 'object' && 'webservice_tarificateurResult' in v)

  if (!responseNode) {
    console.error('[EXADE] Available body keys:', Object.keys(body))
    console.error('[EXADE] Body structure:', JSON.stringify(body, null, 2).substring(0, 1000))
    throw new Error('[EXADE] Réponse SOAP inattendue: pas de webservice_tarificateurResponse')
  }

  const resultString: string = responseNode['webservice_tarificateurResult']
    || responseNode['#text']
    || (typeof responseNode === 'string' ? responseNode : null)

  if (!resultString || typeof resultString !== 'string') {
    throw new Error('[EXADE] Pas de webservice_tarificateurResult (string) dans la réponse')
  }

  const inner = parser.parse(resultString)
  const simulation = inner.simulation

  if (!simulation) {
    if (inner.listeErreurs) {
      const erreurs = Array.isArray(inner.listeErreurs.erreur)
        ? inner.listeErreurs.erreur
        : [inner.listeErreurs.erreur]
      throw new Error(`[EXADE] Erreurs retournées par l'API: ${erreurs.map((e: any) => e.libelle || e.message || e).join(', ')}`)
    }
    throw new Error('[EXADE] Pas de noeud <simulation> dans la réponse')
  }

  return simulation
}

/**
 * Convertit la structure <simulation> Exade en tableau de tarifs
 */
function mapSimulationToTarifs(simulation: any): ExadeTarif[] {
  const tarifs: ExadeTarif[] = []
  const idSimulation = simulation.id_simulation

  // On prend le premier assuré pour itérer sur les tarifs (car les tarifs sont dupliqués par assuré)
  // Dans une simulation multi-assurés, les tarifs sont généralement les mêmes produits
  const assures = Array.isArray(simulation.assure) ? simulation.assure : [simulation.assure].filter(Boolean)
  const assurePrincipal = assures[0]

  if (!assurePrincipal || !assurePrincipal.tarif) return []

  const tarifsRaw = Array.isArray(assurePrincipal.tarif) ? assurePrincipal.tarif : [assurePrincipal.tarif]

  for (const t of tarifsRaw) {
    // Calcul du coût total global (tous assurés confondus pour ce tarif)
    // Pour l'instant on prend celui de l'assuré principal, mais idéalement il faudrait sommer
    // Cependant, Exade renvoie souvent le coût total du dossier dans chaque bloc tarif ? A vérifier.
    // Selon doc Part 3E: cout_total_tarif = Coût total du tarif pour l'assuré.

    let coutTotalGlobal = 0
    let mensualiteGlobale = 0
    let fraisAdhesionGlobal = 0

    // Pour récupérer le coût total du dossier, il faut sommer les coûts de ce tarif pour CHAQUE assuré
    for (const ass of assures) {
      const tAss = Array.isArray(ass.tarif) ? ass.tarif.find((x: any) => x.id_tarif == t.id_tarif) : ass.tarif
      if (tAss) {
        coutTotalGlobal += Number(tAss.cout_total_tarif || 0)
        fraisAdhesionGlobal += Number(tAss.frais_adhesion || 0)

        // Calcul mensualité depuis garantie_pret
        const prets = Array.isArray(tAss.pret) ? tAss.pret : [tAss.pret].filter(Boolean)
        for (const p of prets) {
          const garanties = Array.isArray(p.garantie_pret) ? p.garantie_pret : [p.garantie_pret]
          // On prend la première période pour la mensualité (approximation)
          // Idéalement il faudrait un tableau d'échéances
          // Ici on somme les coûts de la première période de chaque garantie
          for (const g of garanties) {
            mensualiteGlobale += Number(g.cout || 0)
          }
        }
      }
    }

    // Extraction des garanties (libellés)
    const garantiesList: any[] = []
    // On peut parser t.formalite ou t.garanties si dispo, sinon on déduit du code garantie

    tarifs.push({
      id_simulation: idSimulation,
      id_tarif: t.id_tarif,
      compagnie: t.compagnie,
      nom: t.nom,
      type_tarif: t.type_tarif,
      mensualite: mensualiteGlobale,
      cout_total: coutTotalGlobal,
      frais_adhesion: fraisAdhesionGlobal,
      frais_adhesion_apporteur: Number(t.frais_adhesion_apporteur || 0),
      garanties: garantiesList,
      compatible_lemoine: t.compatible_lemoine == 1,
      erreurs: t.listeErreurs ? [t.listeErreurs] : []
    })
  }

  return tarifs
}

/**
 * Récupère les tarifs d'assurance depuis l'API Exade
 */
export async function getExadeTarifs(payload: {
  assure: any
  pret: any
  garanties?: any
  idTarif?: number
}): Promise<ExadeTarif[]> {
  // Mode mock
  if (EXADE_CONFIG.useMock) {
    console.log('[EXADE] Mock mode enabled')
    return [
      {
        id_simulation: 'MOCK_SIM_001',
        id_tarif: '1',
        compagnie: 'GENERALI',
        nom: 'ASSUREA PRET 7301 CI',
        type_tarif: 'NON REVISABLE',
        mensualite: 45.50,
        cout_total: 12500,
        frais_adhesion: 2000,
        frais_adhesion_apporteur: 15000,
        garanties: [],
        compatible_lemoine: true
      },
      {
        id_simulation: 'MOCK_SIM_001',
        id_tarif: '2',
        compagnie: 'SWISSLIFE',
        nom: 'ASSUREA PREMIUM',
        type_tarif: 'NON REVISABLE',
        mensualite: 48.20,
        cout_total: 13200,
        frais_adhesion: 2500,
        frais_adhesion_apporteur: 16000,
        garanties: [],
        compatible_lemoine: true
      }
    ]
  }

  validateExadeConfig()

  const innerXml = buildInnerTarifXml(payload)
  const envelope = buildSoapEnvelope(innerXml)

  // Structured logging for debugging "Aucun tarif selectionné"
  console.log('[EXADE] --- START REQUEST DEBUG ---')
  console.log('[EXADE] Simulation Parameters:', {
    date_effet: payload.pret?.date_effet,
    objet_financement: payload.pret?.objet_financement_code || 1,
    type_pret: payload.pret?.type_pret_code || 1,
    capital: payload.pret?.montant_capital || payload.pret?.montant,
    duree_mois: payload.pret?.duree_mois || payload.pret?.duree,
    taux: payload.pret?.taux_nominal || payload.pret?.taux,
  })

  const assure1 = payload.assure || {}
  console.log('[EXADE] Assure 1:', {
    date_naissance: assure1.client_date_naissance || assure1.date_naissance,
    profession_code: assure1.client_categorie_professionnelle || assure1.categorie_professionnelle,
    fumeur: assure1.fumeur || assure1.client_fumeur,
    type_adhesion: assure1.type_adhesion,
    encours_lemoine: assure1.encours_lemoine,
    dept_naissance: assure1.departement_naissance, // Important for some tariffs
    code_postal: assure1.code_postal || assure1.client_adresse,
  })

  if (assure1.conjoint) {
    console.log('[EXADE] Assure 2 (Conjoint):', {
      date_naissance: assure1.conjoint.client_date_naissance || assure1.conjoint.date_naissance,
      profession_code: assure1.conjoint.client_categorie_professionnelle || assure1.conjoint.categorie_professionnelle,
    })
  }

  console.log('[EXADE] Garanties requested:', {
    code: payload.garanties?.code,
    quotite: payload.garanties?.quotite
  })

  // console.log('[EXADE] Inner XML (first 1500 chars):', innerXml.substring(0, 1500))
  // console.log('[EXADE] Full envelope (first 2000 chars):', envelope.substring(0, 2000))


  // Write to file for debugging
  if (typeof window === 'undefined') {
    const fs = require('fs')
    const path = require('path')
    try {
      const logPath = path.join(process.cwd(), 'exade_request_debug.xml')
      fs.writeFileSync(logPath, envelope, 'utf-8')
      console.log('[EXADE] Full request written to:', logPath)
    } catch (err) {
      console.error('[EXADE] Could not write debug file:', err)
    }
  }

  const res = await fetch(EXADE_CONFIG.soapUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'text/xml;charset=utf-8',
      'SOAPAction': 'A_WebService#webservice_tarificateur',
    },
    body: envelope,
  })

  if (!res.ok) {
    const text = await res.text()
    console.error('[EXADE] HTTP Error Response:', text.substring(0, 1000))
    throw new Error(`[EXADE] HTTP ${res.status}: ${text.substring(0, 500)}`)
  }

  const xmlText = await res.text()
  // console.log('[EXADE] Raw SOAP Response (first 2000 chars):', xmlText.substring(0, 2000))


  const simulation = parseExadeResponse(xmlText)
  const tarifs = mapSimulationToTarifs(simulation)

  if (tarifs.length === 0) {
    throw new Error('[EXADE] Aucun tarif retourné par l\'API')
  }

  return tarifs
}

================
File: lib/services/gemini-extraction.ts
================
import { GoogleGenAI, createPartFromUri } from "@google/genai";
import { supabase } from '@/lib/supabase';

/**
 * Service d'extraction de documents utilisant Google Gemini
 * Utilisé pour les fichiers volumineux (> 10MB) qui ne peuvent pas être traités par OpenRouter
 */
export class GeminiExtractionService {
  private static ai: GoogleGenAI | null = null;

  /**
   * Initialise le client Gemini
   */
  private static getClient(): GoogleGenAI {
    if (!this.ai) {
      const apiKey = process.env.GEMINI_API_KEY || process.env.NEXT_PUBLIC_GEMINI_API_KEY;
      
      if (!apiKey) {
        throw new Error('GEMINI_API_KEY non configurée. Vérifiez votre fichier .env');
      }

      this.ai = new GoogleGenAI({ apiKey });
    }

    return this.ai;
  }

  /**
   * Upload un fichier vers l'API Gemini et retourne son URI
   */
  private static async uploadFile(fileBuffer: ArrayBuffer, fileName: string, mimeType: string): Promise<{ uri: string, name: string }> {
    console.log(`[GeminiExtraction] Upload fichier: ${fileName} (${fileBuffer.byteLength} bytes, type: ${mimeType})`);
    
    try {
      const ai = this.getClient();
      
      // Convertir ArrayBuffer en Buffer Node.js
      const buffer = Buffer.from(fileBuffer);
      
      // Créer un Blob compatible avec l'API Gemini
      const fileBlob = new Blob([buffer], { type: mimeType });

      console.log(`[GeminiExtraction] Tentative d'upload vers Gemini...`);
      
      const file = await ai.files.upload({
        file: fileBlob,
        config: {
          displayName: fileName,
        },
      });
      
      console.log(`[GeminiExtraction] Upload réussi: ${file.name}`);
      
      if (!file.name) {
        throw new Error('Nom du fichier manquant après l\'upload');
      }

      // Attendre que le fichier soit traité
      let getFile = await ai.files.get({ name: file.name });
      let attempts = 0;
      const maxAttempts = 20;

      while (getFile.state === 'PROCESSING' && attempts < maxAttempts) {
        console.log(`[GeminiExtraction] Fichier en cours de traitement... (${attempts + 1}/${maxAttempts})`);
        await new Promise((resolve) => setTimeout(resolve, 2000)); // Attendre 2 secondes
        getFile = await ai.files.get({ name: file.name });
        attempts++;
      }

      if (getFile.state === 'FAILED') {
        throw new Error('Le traitement du fichier a échoué');
      }

      if (getFile.state === 'PROCESSING') {
        throw new Error('Le traitement du fichier prend trop de temps');
      }

      if (!file.uri) {
        throw new Error('URI du fichier manquant après l\'upload');
      }

      return {
        uri: file.uri,
        name: file.name
      };
      
    } catch (uploadError: any) {
      console.error(`[GeminiExtraction] Erreur upload:`, {
        message: uploadError.message,
        stack: uploadError.stack,
        fileName,
        mimeType
      });
      throw new Error(`Échec upload fichier ${fileName}: ${uploadError.message}`);
    }
  }

  /**
   * Télécharge un document depuis Supabase Storage
   */
  private static async downloadDocument(storagePath: string): Promise<ArrayBuffer> {
    console.log(`[GeminiExtraction] Téléchargement: ${storagePath}`);
    
    const { data, error } = await supabase.storage
      .from('documents')
      .download(storagePath);

    if (error) {
      throw new Error(`Erreur téléchargement: ${error.message}`);
    }

    return await data.arrayBuffer();
  }

  /**
   * Extrait les informations des documents en utilisant Gemini
   */
  static async extractFromDocuments(
    documents: Array<{ id: string; storage_path: string; document_name: string; mime_type: string }>,
    systemPrompt: string,
    userPrompt: string
  ): Promise<any> {
    try {
      console.log(`[GeminiExtraction] Extraction de ${documents.length} document(s)`);
      
      const ai = this.getClient();
      const content: any[] = [userPrompt];

      // Upload tous les documents vers Gemini
      for (const doc of documents) {
        console.log(`[GeminiExtraction] Traitement: ${doc.document_name}`);
        
        // Télécharger le fichier depuis Supabase
        const fileBuffer = await this.downloadDocument(doc.storage_path);
        
        // Upload vers Gemini
        const { uri } = await this.uploadFile(fileBuffer, doc.document_name, doc.mime_type);
        
        // Ajouter à la requête
        const filePart = createPartFromUri(uri, doc.mime_type);
        content.push(filePart);
      }

      console.log(`[GeminiExtraction] Envoi de la requête à Gemini 2.5 Pro`);
      
      // Préparer les parts avec le system prompt intégré dans le message user
      const userParts = [
        { text: `${systemPrompt}\n\n${userPrompt}` }
      ];

      // Ajouter les fichiers
      for (let i = 1; i < content.length; i++) {
        userParts.push(content[i]);
      }
      
      // Générer le contenu avec Gemini
      const response = await ai.models.generateContent({
        model: 'gemini-2.5-pro',
        contents: [
          {
            role: 'user',
            parts: userParts
          }
        ],
      });

      const responseText = response.text;
      
      if (!responseText) {
        throw new Error('Réponse vide de Gemini');
      }
      
      console.log(`[GeminiExtraction] Réponse reçue (${responseText.length} caractères)`);
      console.log(`[GeminiExtraction] Aperçu: ${responseText.substring(0, 200)}...`);

      // Parser la réponse JSON de manière robuste
      let extractedData: any;
      
      try {
        // Méthode 1: Nettoyer les backticks markdown
        let cleaned = responseText.trim();
        
        // Retirer les backticks markdown au début et à la fin
        if (cleaned.startsWith('```')) {
          cleaned = cleaned.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/i, '').trim();
        }
        
        // Méthode 2: Extraire le JSON avec regex
        const jsonMatch = cleaned.match(/\{[\s\S]*\}/);
        
        if (!jsonMatch) {
          console.error('[GeminiExtraction] Réponse complète:', responseText);
          throw new Error('Aucun objet JSON trouvé dans la réponse');
        }
        
        // Parser le JSON
        extractedData = JSON.parse(jsonMatch[0]);
        
        // Validation basique de la structure
        if (!extractedData.emprunteurs || !extractedData.pret) {
          console.warn('[GeminiExtraction] Structure JSON incomplète, tentative de correction...');
          console.log('[GeminiExtraction] Données extraites:', JSON.stringify(extractedData, null, 2));
        }
        
        console.log('[GeminiExtraction] JSON parsé avec succès');
        return extractedData;
        
      } catch (parseError: any) {
        console.error('[GeminiExtraction] Erreur parsing JSON:', parseError.message);
        console.error('[GeminiExtraction] Réponse brute:', responseText);
        throw new Error(`Impossible de parser la réponse JSON: ${parseError.message}`);
      }

    } catch (error: any) {
      console.error('[GeminiExtraction] Erreur:', error);
      throw new Error(`Erreur Gemini: ${error.message}`);
    }
  }
}

================
File: lib/services/pret-data.ts
================
import { supabase } from '@/lib/supabase'
import { Database } from '@/types/supabase'

type PretData = Database['public']['Tables']['pret_data']['Row']
type PretDataInsert = Database['public']['Tables']['pret_data']['Insert']
type PretDataUpdate = Database['public']['Tables']['pret_data']['Update']

export class PretDataService {
  static async getByDossierId(dossierId: string) {
    const { data, error } = await supabase
      .from('pret_data')
      .select('*')
      .eq('dossier_id', dossierId)
      .order('updated_at', { ascending: false })
      .limit(1)

    if (error) {
      console.error('[PretDataService.getByDossierId] error', error)
      throw error
    }

    return Array.isArray(data) && data.length > 0 ? data[0] as PretData : null
  }

  static async upsertByDossierId(dossierId: string, payload: Partial<PretDataInsert>) {
    // Déterminer s'il existe déjà des données
    const existing = await this.getByDossierId(dossierId)

    const record: PretDataInsert = {
      dossier_id: dossierId,
      banque_preteuse: payload.banque_preteuse as string,
      montant_capital: payload.montant_capital as number,
      duree_mois: payload.duree_mois as number,
      type_pret: payload.type_pret as string,
      cout_assurance_banque: payload.cout_assurance_banque ?? null,
      taux_effectif: (payload as any)?.taux_effectif ?? null,
      taux_nominal: (payload as any)?.taux_nominal ?? null,
      type_garantie: (payload as any)?.type_garantie ?? null,
      apport_personnel: (payload as any)?.apport_personnel ?? null,
      // Nouveaux champs d'extraction
      date_debut: (payload as any)?.date_debut ?? null,
      date_fin: (payload as any)?.date_fin ?? null,
      date_debut_effective: (payload as any)?.date_debut_effective ?? null,
      duree_restante_mois: (payload as any)?.duree_restante_mois ?? null,
      capital_restant_du: (payload as any)?.capital_restant_du ?? null,
    }

    if (existing) {
      const { data, error } = await supabase
        .from('pret_data')
        .update({ ...(record as PretDataUpdate), updated_at: new Date().toISOString() })
        .eq('dossier_id', dossierId)
        .select()
        .limit(1)

      if (error) {
        console.error('[PretDataService.upsertByDossierId] update error', error)
        throw error
      }
      if (!data || data.length === 0) {
        throw new Error('Aucune ligne mise à jour (RLS a probablement bloqué la requête)')
      }
      return data[0] as PretData
    }

    const { data, error } = await supabase
      .from('pret_data')
      .insert({ ...record, updated_at: new Date().toISOString() })
      .select()
      .limit(1)

    if (error) {
      console.error('[PretDataService.upsertByDossierId] insert error', error)
      throw error
    }
    if (!data || data.length === 0) {
      throw new Error('Aucune ligne insérée (RLS a probablement bloqué la requête)')
    }

    return data[0] as PretData
  }
}

================
File: lib/services/read-status-cache.ts
================
interface PendingUpdate {
  dossierId: string;
  isRead: boolean;
  timestamp: number;
}

interface OverrideEntry {
  isRead: boolean;
  timestamp: number;
}

interface CacheData {
  pendingUpdates: PendingUpdate[];
  overrides: Record<string, OverrideEntry>;
  lastSync: number;
}

export class ReadStatusCache {
  private static readonly STORAGE_KEY = 'dossier_read_status_cache';
  private static readonly SYNC_INTERVAL = 2000; // 2 secondes
  private static readonly BATCH_SIZE = 10;
  private static readonly OVERRIDE_TTL_MS = 24 * 60 * 60 * 1000; // 24h
  private static syncTimeout: NodeJS.Timeout | null = null;
  private static syncCallbacks: Set<() => void> = new Set();

  /**
   * Marque un dossier comme lu de manière optimiste
   */
  static markAsReadOptimistic(dossierId: string): void {
    // Ajouter à la queue locale
    this.addPendingUpdate(dossierId, true);
    this.setOverride(dossierId, true);
    
    // Démarrer la synchronisation en arrière-plan
    this.scheduleSync();
  }

  /**
   * Marque un dossier comme non lu de manière optimiste
   */
  static markAsUnreadOptimistic(dossierId: string): void {
    this.addPendingUpdate(dossierId, false);
    this.setOverride(dossierId, false);
    this.scheduleSync();
  }

  /**
   * Récupère l'état de lecture depuis le cache local
   */
  static getReadStatus(dossierId: string): boolean | null {
    const cache = this.getCache();
    // 1) Priorité aux overrides locaux (persiste même après refresh)
    const override = cache.overrides[dossierId];
    if (override) {
      return override.isRead;
    }
    const pendingUpdate = cache.pendingUpdates.find(update => update.dossierId === dossierId);
    
    if (pendingUpdate) {
      return pendingUpdate.isRead;
    }
    
    return null; // Pas dans le cache, utiliser l'état de la DB
  }

  /**
   * Vérifie si un dossier a des mises à jour en attente
   */
  static hasPendingUpdates(dossierId: string): boolean {
    const cache = this.getCache();
    return cache.pendingUpdates.some(update => update.dossierId === dossierId);
  }

  /**
   * Ajoute une mise à jour à la queue
   */
  private static addPendingUpdate(dossierId: string, isRead: boolean): void {
    const cache = this.getCache();
    
    // Supprimer les anciennes mises à jour pour ce dossier
    cache.pendingUpdates = cache.pendingUpdates.filter(update => update.dossierId !== dossierId);
    
    // Ajouter la nouvelle mise à jour
    cache.pendingUpdates.push({
      dossierId,
      isRead,
      timestamp: Date.now()
    });
    
    this.saveCache(cache);
  }

  /**
   * Définit/écrase un override local
   */
  private static setOverride(dossierId: string, isRead: boolean): void {
    const cache = this.getCache();
    cache.overrides[dossierId] = { isRead, timestamp: Date.now() };
    this.saveCache(cache);
  }

  /**
   * Planifie une synchronisation
   */
  private static scheduleSync(): void {
    if (this.syncTimeout) {
      clearTimeout(this.syncTimeout);
    }
    
    this.syncTimeout = setTimeout(() => {
      this.syncWithDatabase();
    }, this.SYNC_INTERVAL);
  }

  /**
   * Synchronise avec la base de données
   */
  private static async syncWithDatabase(): Promise<void> {
    const cache = this.getCache();
    
    if (cache.pendingUpdates.length === 0) {
      return;
    }

    try {
      // Traiter par batch
      const batches = this.chunkArray(cache.pendingUpdates, this.BATCH_SIZE);
      
      for (const batch of batches) {
        await this.processBatch(batch);
      }
      
      // Marquer comme synchronisé
      cache.lastSync = Date.now();
      cache.pendingUpdates = [];
      this.saveCache(cache);
      
      // Notifier les callbacks de synchronisation
      this.syncCallbacks.forEach(callback => callback());
      
    } catch (error) {
      console.error('Erreur lors de la synchronisation:', error);
      // Garder les mises à jour en attente pour un retry
    }
  }

  /**
   * Traite un batch de mises à jour
   */
  private static async processBatch(batch: PendingUpdate[]): Promise<void> {
    const { supabase } = await import('@/lib/supabase');
    
    // Grouper par état
    const readIds = batch.filter(update => update.isRead).map(update => update.dossierId);
    const unreadIds = batch.filter(update => !update.isRead).map(update => update.dossierId);
    
    // Mettre à jour les lus
    if (readIds.length > 0) {
      const { error: readError } = await supabase
        .from('dossiers')
        .update({ is_read: true })
        .in('id', readIds);
        
      if (readError) throw readError;
    }
    
    // Mettre à jour les non lus
    if (unreadIds.length > 0) {
      const { error: unreadError } = await supabase
        .from('dossiers')
        .update({ is_read: false })
        .in('id', unreadIds);
        
      if (unreadError) throw unreadError;
    }
  }

  /**
   * Divise un tableau en chunks
   */
  private static chunkArray<T>(array: T[], size: number): T[][] {
    const chunks: T[][] = [];
    for (let i = 0; i < array.length; i += size) {
      chunks.push(array.slice(i, i + size));
    }
    return chunks;
  }

  /**
   * Récupère le cache depuis localStorage
   */
  private static getCache(): CacheData {
    try {
      const stored = localStorage.getItem(this.STORAGE_KEY);
      const cache: CacheData = stored ? JSON.parse(stored) : { pendingUpdates: [], overrides: {}, lastSync: 0 };
      // Nettoyer les overrides trop anciens
      const now = Date.now();
      const overrides: Record<string, OverrideEntry> = {};
      for (const [id, entry] of Object.entries(cache.overrides || {})) {
        if (now - entry.timestamp < this.OVERRIDE_TTL_MS) {
          overrides[id] = entry;
        }
      }
      cache.overrides = overrides;
      return cache;
    } catch {
      return { pendingUpdates: [], overrides: {}, lastSync: 0 };
    }
  }

  /**
   * Sauvegarde le cache dans localStorage
   */
  private static saveCache(cache: CacheData): void {
    try {
      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(cache));
    } catch (error) {
      console.error('Erreur lors de la sauvegarde du cache:', error);
    }
  }

  /**
   * Force la synchronisation immédiate
   */
  static async forceSync(): Promise<void> {
    if (this.syncTimeout) {
      clearTimeout(this.syncTimeout);
    }
    await this.syncWithDatabase();
  }

  /**
   * Nettoie le cache (pour les tests)
   */
  static clearCache(): void {
    localStorage.removeItem(this.STORAGE_KEY);
  }

  /**
   * Ajoute un callback de synchronisation
   */
  static onSync(callback: () => void): () => void {
    this.syncCallbacks.add(callback);
    return () => this.syncCallbacks.delete(callback);
  }
}

================
File: lib/supabase.ts
================
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);

================
File: lib/utils.ts
================
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

================
File: lib/utils/activity-config.ts
================
/**
 * 🎨 CONFIGURATION DES TYPES D'ACTIVITÉS
 * 
 * Ce module centralise la configuration des activités pour l'affichage dans l'application.
 * Chaque type d'activité a son icône, couleur et label associé.
 * 
 * @module lib/utils/activity-config
 */

/**
 * Types d'activités reconnus dans l'application
 * Basé sur les types trackés dans la table `activities`
 */
export type ActivityType = 
  | 'dossier_created'      // Création d'un nouveau dossier
  | 'devis_envoye'         // Envoi d'un devis
  | 'devis_accepte'        // Acceptation d'un devis
  | 'devis_refuse'         // Refus d'un devis
  | 'dossier_finalise'     // Finalisation d'un dossier
  | 'dossier_supprime'     // Suppression d'un dossier
  | 'dossier_attribue'     // Attribution d'un dossier à un apporteur
  | 'classement_updated'   // Mise à jour du classement
  | 'nouveau_dossier'      // Legacy: ancien type pour dossier créé
  | 'validation_devis'     // Legacy: ancien type pour devis accepté
  | 'refus_devis'          // Legacy: ancien type pour devis refusé
  | 'finalisation'         // Legacy: ancien type pour finalisation
  | 'nouveau_apporteur'    // Nouveau apporteur enregistré
  | 'modification_dossier';// Modification d'un dossier

interface ActivityConfig {
  icon: string;
  color: string;
  bgColor: string;
  label: string;
}

/**
 * Configuration centralisée des types d'activités
 * Source de vérité unique pour l'affichage des activités
 */
export const ACTIVITY_CONFIG: Partial<Record<ActivityType, ActivityConfig>> = {
  // =========================================
  // ACTIVITÉS PRINCIPALES (standard)
  // =========================================
  dossier_created: {
    icon: 'ri-file-add-line',
    color: 'text-[#335FAD] dark:text-[#335FAD]',
    bgColor: 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30',
    label: 'Nouveau dossier'
  },
  devis_envoye: {
    icon: 'ri-send-plane-line',
    color: 'text-orange-600 dark:text-orange-400',
    bgColor: 'bg-orange-100 dark:bg-orange-900/30',
    label: 'Devis envoyé'
  },
  devis_accepte: {
    icon: 'ri-check-double-line',
    color: 'text-green-600 dark:text-green-400',
    bgColor: 'bg-green-100 dark:bg-green-900/30',
    label: 'Devis validé'
  },
  devis_refuse: {
    icon: 'ri-close-circle-line',
    color: 'text-red-600 dark:text-red-400',
    bgColor: 'bg-red-100 dark:bg-red-900/30',
    label: 'Devis refusé'
  },
  dossier_finalise: {
    icon: 'ri-award-line',
    color: 'text-purple-600 dark:text-purple-400',
    bgColor: 'bg-purple-100 dark:bg-purple-900/30',
    label: 'Dossier finalisé'
  },
  dossier_supprime: {
    icon: 'ri-delete-bin-line',
    color: 'text-red-600 dark:text-red-400',
    bgColor: 'bg-red-100 dark:bg-red-900/30',
    label: 'Dossier supprimé'
  },
  dossier_attribue: {
    icon: 'ri-user-add-line',
    color: 'text-blue-600 dark:text-blue-400',
    bgColor: 'bg-blue-100 dark:bg-blue-900/30',
    label: 'Dossier attribué'
  },
  classement_updated: {
    icon: 'ri-trophy-line',
    color: 'text-yellow-600 dark:text-yellow-400',
    bgColor: 'bg-yellow-100 dark:bg-yellow-900/30',
    label: 'Classement mis à jour'
  },
  
  // =========================================
  // ACTIVITÉS LEGACY (compatibilité arrière)
  // =========================================
  nouveau_dossier: {
    icon: 'ri-file-add-line',
    color: 'text-[#335FAD] dark:text-[#335FAD]',
    bgColor: 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30',
    label: 'Nouveau dossier'
  },
  validation_devis: {
    icon: 'ri-check-double-line',
    color: 'text-green-600 dark:text-green-400',
    bgColor: 'bg-green-100 dark:bg-green-900/30',
    label: 'Devis validé'
  },
  refus_devis: {
    icon: 'ri-close-circle-line',
    color: 'text-red-600 dark:text-red-400',
    bgColor: 'bg-red-100 dark:bg-red-900/30',
    label: 'Devis refusé'
  },
  finalisation: {
    icon: 'ri-award-line',
    color: 'text-purple-600 dark:text-purple-400',
    bgColor: 'bg-purple-100 dark:bg-purple-900/30',
    label: 'Dossier finalisé'
  },
  nouveau_apporteur: {
    icon: 'ri-user-add-line',
    color: 'text-[#335FAD] dark:text-[#335FAD]',
    bgColor: 'bg-[#335FAD]/10 dark:bg-[#335FAD]/30',
    label: 'Nouvel apporteur'
  },
  modification_dossier: {
    icon: 'ri-edit-line',
    color: 'text-orange-600 dark:text-orange-400',
    bgColor: 'bg-orange-100 dark:bg-orange-900/30',
    label: 'Dossier modifié'
  }
} as const;

/**
 * Configuration par défaut pour les activités inconnues
 */
const DEFAULT_ACTIVITY_CONFIG: ActivityConfig = {
  icon: 'ri-information-line',
  color: 'text-gray-600 dark:text-gray-400',
  bgColor: 'bg-gray-100 dark:bg-gray-700',
  label: 'Activité'
};

/**
 * Obtient la configuration d'un type d'activité
 * 
 * @param type - Type d'activité
 * @returns Configuration de l'activité ou configuration par défaut si inconnu
 * 
 * @example
 * const config = getActivityConfig('dossier_created');
 * // { icon: '...', color: '...', bgColor: '...', label: 'Nouveau dossier' }
 */
export function getActivityConfig(type: string): ActivityConfig {
  return ACTIVITY_CONFIG[type as ActivityType] || DEFAULT_ACTIVITY_CONFIG;
}

================
File: lib/utils/apporteur-badges.ts
================
/**
 * 🎨 CONFIGURATION DES BADGES DE STATUT APPORTEUR
 * 
 * Ce module centralise la configuration des badges pour les statuts des apporteurs.
 * Similaire à statut-mapping.ts, mais spécifique aux apporteurs.
 * 
 * @module lib/utils/apporteur-badges
 */

export type ApporteurStatut = 'actif' | 'inactif' | 'en_attente' | 'suspendu' | 'refuse';

interface BadgeConfig {
  color: string;
  text: string;
  icon: string;
}

/**
 * Configuration des badges de statut apporteur
 * Source de vérité unique pour l'affichage des statuts apporteurs
 */
export const APPORTEUR_BADGE_CONFIG: Record<ApporteurStatut, BadgeConfig> = {
  actif: { 
    color: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400', 
    text: 'Actif', 
    icon: 'ri-check-line' 
  },
  inactif: { 
    color: 'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400', 
    text: 'Inactif', 
    icon: 'ri-close-line' 
  },
  en_attente: { 
    color: 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400', 
    text: 'En attente', 
    icon: 'ri-time-line' 
  },
  suspendu: { 
    color: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400', 
    text: 'Suspendu', 
    icon: 'ri-pause-line' 
  },
  refuse: { 
    color: 'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400', 
    text: 'Refusé', 
    icon: 'ri-close-line' 
  }
} as const;

/**
 * Obtient la configuration du badge pour un statut apporteur
 * 
 * @param statut - Statut de l'apporteur
 * @returns Configuration du badge ou null si statut inconnu
 * 
 * @example
 * const config = getApporteurBadgeConfig('actif');
 * // { color: '...', text: 'Actif', icon: 'ri-check-line' }
 */
export function getApporteurBadgeConfig(statut: string): BadgeConfig | null {
  return APPORTEUR_BADGE_CONFIG[statut as ApporteurStatut] || null;
}

================
File: lib/utils/formatters.ts
================
/**
 * 🎨 UTILITAIRES DE FORMATAGE CENTRALISÉS
 * 
 * Ce module centralise toutes les fonctions de formatage utilisées dans l'application.
 * Objectif : Cohérence totale de l'affichage et maintenance simplifiée.
 * 
 * @module lib/utils/formatters
 */

/**
 * Formate une date en français
 * 
 * @param dateString - Date ISO (YYYY-MM-DD) ou string de date valide
 * @param includeTime - Si true, inclut l'heure et les minutes (défaut: false)
 * @returns Date formatée en français (JJ/MM/AAAA ou JJ/MM/AAAA HH:MM)
 * 
 * @example
 * formatDate('2024-01-15') // "15/01/2024"
 * formatDate('2024-01-15T14:30:00', true) // "15/01/2024 14:30"
 */
export function formatDate(dateString: string, includeTime = false): string {
  if (!dateString) return '-';
  
  const options: Intl.DateTimeFormatOptions = {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
  };
  
  if (includeTime) {
    options.hour = '2-digit';
    options.minute = '2-digit';
  }
  
  try {
    return new Date(dateString).toLocaleDateString('fr-FR', options);
  } catch (error) {
    console.warn('[formatDate] Invalid date:', dateString);
    return '-';
  }
}

/**
 * Formate un montant en euros
 * 
 * @param amount - Montant numérique
 * @param options - Options de formatage
 * @param options.compact - Si true, utilise k€ et M€ pour les grands montants (défaut: false)
 * @param options.decimals - Nombre de décimales (défaut: 2)
 * @returns Montant formaté en euros
 * 
 * @example
 * formatCurrency(1234.56) // "1 234,56 €"
 * formatCurrency(1234.56, { decimals: 0 }) // "1 235 €"
 * formatCurrency(1500000, { compact: true }) // "1.5M€"
 * formatCurrency(2500, { compact: true }) // "2k€"
 */
export function formatCurrency(
  amount: number,
  options?: {
    compact?: boolean;
    decimals?: number;
  }
): string {
  if (amount === null || amount === undefined) return '-';
  
  const { compact = false, decimals = 2 } = options || {};
  
  // Mode compact (k€, M€)
  if (compact) {
    if (amount >= 1000000) {
      return `${(amount / 1000000).toFixed(1)}M€`;
    }
    if (amount >= 1000) {
      return `${(amount / 1000).toFixed(0)}k€`;
    }
    return `${amount}€`;
  }
  
  // Mode standard avec Intl.NumberFormat
  return new Intl.NumberFormat('fr-FR', {
    style: 'currency',
    currency: 'EUR',
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals,
  }).format(amount);
}

/**
 * Formate un nombre avec séparateurs de milliers
 * 
 * @param number - Nombre à formater
 * @returns Nombre formaté avec espaces comme séparateurs de milliers
 * 
 * @example
 * formatNumber(1234567) // "1 234 567"
 */
export function formatNumber(number: number): string {
  if (number === null || number === undefined) return '-';
  return new Intl.NumberFormat('fr-FR').format(number);
}

/**
 * Formate un pourcentage
 * 
 * @param percentage - Pourcentage à formater
 * @param decimals - Nombre de décimales (défaut: 1)
 * @returns Pourcentage formaté
 * 
 * @example
 * formatPercentage(12.3456) // "12.3%"
 * formatPercentage(12.3456, 2) // "12.35%"
 */
export function formatPercentage(percentage: number, decimals = 1): string {
  if (percentage === null || percentage === undefined) return '-';
  return `${percentage.toFixed(decimals)}%`;
}

/**
 * Calcule et retourne la couleur appropriée selon l'âge d'un dossier
 * 
 * @param days - Nombre de jours depuis la création
 * @returns Classe Tailwind pour la couleur du texte
 * 
 * @example
 * getAgeColor(2) // "text-green-600 dark:text-green-400"
 * getAgeColor(5) // "text-orange-600 dark:text-orange-400"
 * getAgeColor(10) // "text-red-600 dark:text-red-400"
 */
export function getAgeColor(days: number): string {
  if (days <= 3) return 'text-green-600 dark:text-green-400';
  if (days <= 7) return 'text-orange-600 dark:text-orange-400';
  return 'text-red-600 dark:text-red-400';
}

================
File: lib/utils/statut-mapping.ts
================
/**
 * 🎯 SOURCE DE VÉRITÉ UNIQUE POUR LES STATUTS DE DOSSIERS
 * 
 * Ce fichier centralise TOUTE la logique de mapping des statuts.
 * À utiliser PARTOUT dans l'application pour garantir la cohérence.
 * 
 * RÈGLES :
 * 1. TOUJOURS sélectionner `statut_canon` dans les requêtes DB
 * 2. TOUJOURS utiliser mapStatutForDisplay() pour l'affichage
 * 3. JAMAIS créer de mapping local ailleurs dans le code
 */

/**
 * Type des statuts canoniques (source DB - ENUM dossier_statut)
 */
export type StatutCanonique = 
  | 'en_attente'
  | 'devis_disponible'
  | 'devis_accepte'
  | 'refuse'
  | 'finalise';

/**
 * Type des statuts pour l'affichage UI
 */
export type StatutDisplay = 
  | 'nouveau'
  | 'devis_envoye'
  | 'valide'
  | 'refuse'
  | 'finalise';

/**
 * Mapping canonique : DB → UI
 * C'est LA source de vérité pour toute l'application
 */
export const STATUT_CANONIQUE_TO_DISPLAY: Record<StatutCanonique, StatutDisplay> = {
  'en_attente': 'nouveau',
  'devis_disponible': 'devis_envoye',
  'devis_accepte': 'valide',
  'refuse': 'refuse',
  'finalise': 'finalise',
} as const;

/**
 * 🎯 FONCTION PRINCIPALE DE MAPPING
 * À utiliser PARTOUT pour convertir un statut canonique en statut d'affichage
 * 
 * @param statutCanonique - Valeur de `statut_canon` depuis la DB
 * @returns Statut formaté pour l'affichage
 * 
 * @example
 * ```typescript
 * const displayStatut = mapStatutForDisplay(dossier.statut_canon);
 * // 'en_attente' → 'nouveau'
 * // 'devis_accepte' → 'valide'
 * ```
 */
export function mapStatutForDisplay(statutCanonique: string): StatutDisplay {
  return STATUT_CANONIQUE_TO_DISPLAY[statutCanonique as StatutCanonique] || 'nouveau';
}

/**
 * 🔧 NORMALISATION DES VALEURS LEGACY (avec accents)
 * 
 * Certaines valeurs dans la DB legacy contiennent des accents français.
 * Cette fonction les normalise vers les valeurs canoniques.
 * 
 * ⚠️ À utiliser UNIQUEMENT si vous DEVEZ lire le champ 'statut' (legacy)
 * Dans 99% des cas, utilisez 'statut_canon' directement !
 * 
 * @param statutLegacy - Valeur du champ 'statut' (legacy, peut contenir accents)
 * @returns Valeur normalisée sans accent
 */
export function normalizeLegacyStatut(statutLegacy: string): StatutCanonique {
  const normalizeMap: Record<string, StatutCanonique> = {
    // Valeurs avec accents (legacy)
    'finalisé': 'finalise',
    'refusé': 'refuse',
    // Valeurs canoniques (passthrough)
    'en_attente': 'en_attente',
    'devis_envoye': 'devis_disponible', // Mapping historique
    'devis_accepte': 'devis_accepte',
    'devis_disponible': 'devis_disponible',
    'finalise': 'finalise',
    'refuse': 'refuse',
  };
  
  return normalizeMap[statutLegacy] || 'en_attente';
}

/**
 * 🎨 CONFIGURATION DES BADGES UI
 * Centralise les couleurs et icônes pour chaque statut
 */
export const STATUT_BADGE_CONFIG = {
  nouveau: { 
    color: 'bg-[#335FAD]/10 text-[#335FAD] dark:bg-[#335FAD]/30 dark:text-[#335FAD]', 
    text: 'Nouveau', 
    icon: 'ri-file-add-line' 
  },
  devis_envoye: { 
    color: 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400', 
    text: 'Devis envoyé', 
    icon: 'ri-send-plane-line' 
  },
  valide: { 
    color: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400', 
    text: 'Validé', 
    icon: 'ri-check-line' 
  },
  refuse: { 
    color: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400', 
    text: 'Refusé', 
    icon: 'ri-close-line' 
  },
  finalise: { 
    color: 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400', 
    text: 'Finalisé', 
    icon: 'ri-checkbox-circle-line' 
  },
} as const;

/**
 * 🏷️ Génère un badge JSX pour un statut
 * 
 * @param statutCanonique - Statut canonique depuis la DB
 * @returns Configuration du badge (color, text, icon)
 */
export function getStatutBadgeConfig(statutCanonique: string) {
  const displayStatut = mapStatutForDisplay(statutCanonique);
  return STATUT_BADGE_CONFIG[displayStatut];
}

/**
 * ✅ VALIDATION : Vérifie si un statut est "validé" (pour calculs stats)
 * Un dossier est considéré validé s'il est finalisé OU accepté
 */
export function isStatutValide(statutCanonique: string): boolean {
  return ['finalise', 'devis_accepte'].includes(statutCanonique);
}

/**
 * ✅ VALIDATION : Vérifie si un dossier est finalisé
 */
export function isStatutFinalise(statutCanonique: string): boolean {
  return statutCanonique === 'finalise';
}

================
File: next-env.d.ts
================
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

================
File: next.config.ts
================
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  // Note: output: "export" removed to support API routes
  images: {
    unoptimized: true,
  },
  typescript: {
    // ignoreBuildErrors: true,
  },
  // Configuration pour les uploads de fichiers
  serverExternalPackages: [],
};

export default nextConfig;

================
File: package.json
================
{
  "name": "next-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "cross-env NODE_ENV=development next dev -H 0.0.0.0 -p 3000",
    "build": "next build",
    "lint": "next lint",
    "test:extraction": "node scripts/test-extraction.js"
  },
  "dependencies": {
    "@google/genai": "^1.25.0",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-slot": "^1.2.3",
    "@react-google-maps/api": "^2.19.3",
    "@supabase/supabase-js": "^2.39.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "dotenv": "^17.2.3",
    "fast-xml-parser": "^4.5.3",
    "lucide-react": "^0.544.0",
    "next": "15.3.2",
    "react": "^19.0.0",
    "react-day-picker": "^9.11.0",
    "react-dom": "^19.0.0",
    "recharts": "^3.0.2",
    "tailwind-merge": "^3.3.1",
    "tailwindcss-animate": "^1.0.7"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.21",
    "cross-env": "^7.0.3",
    "postcss": "^8.5.5",
    "shadcn": "^3.3.1",
    "tailwindcss": "^3.4.17",
    "typescript": "^5"
  }
}

================
File: postcss.config.mjs
================
const config = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  }
}

export default config;

================
File: public/assets/svgs/gmb-courtagegrand.svg
================
<svg width="3618" height="856" viewBox="0 0 3618 856" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M168.249 0.55251C109.991 7.222 61.0545 36.7124 30.4392 83.5595C25.2964 91.4344 16.9395 107.907 13.0824 117.711C1.35055 147.522 -2.74757 184.888 1.83269 219.923C10.0289 283.001 46.7513 335.715 101.071 362.312C119.553 371.392 137.794 377.178 158.043 380.392C171.141 382.481 212.524 382.481 227.149 380.392C248.604 377.339 266.925 372.919 284.924 366.491C295.853 362.553 313.451 354.357 321.165 349.696L325.986 346.804V264.439V182.156H264.916H203.846V198.628V215.101H246.032H288.219L288.058 270.707L287.817 326.313L281.389 329.768C258.568 341.982 225.06 349.295 191.552 349.295C157.963 349.295 131.446 341.42 104.527 323.5C94.402 316.751 78.1702 301.081 71.099 291.439C54.7868 269.02 44.5014 242.663 40.6443 213.494C39.1979 202.405 39.3586 178.138 41.0461 166.486C48.7602 112.487 78.8131 69.417 123.892 47.5604C141.088 39.2034 156.838 35.1053 178.373 33.4178C198.542 31.8107 222.006 34.3821 240.006 40.0873C257.041 45.5515 276.487 56.8012 288.862 68.4527C292.397 71.7473 295.612 74.4794 296.013 74.4794C296.978 74.4794 321.165 50.1317 321.165 49.0871C321.165 48.605 318.834 46.1943 315.942 43.7033C290.148 20.8824 261.139 7.54342 225.301 2.07926C213.247 0.231089 179.177 -0.652819 168.249 0.55251Z" fill="white"/>
<path d="M356.28 1.91876C355.959 2.15982 355.718 194.37 355.718 429.007V855.533H368.173H380.628V428.445V1.35627H368.735C362.146 1.35627 356.521 1.59733 356.28 1.91876Z" fill="white"/>
<path d="M414.779 2.32123C414.538 2.88372 414.457 195.013 414.538 429.249L414.779 855.132L427.073 855.373L439.287 855.614V428.445V1.35697H427.234C418.314 1.35697 415.02 1.59803 414.779 2.32123Z" fill="white"/>
<path d="M473.84 428.445V855.614L486.134 855.373L498.348 855.132V428.445V1.75874L486.134 1.51768L473.84 1.27661V428.445Z" fill="white"/>
<path d="M534.669 1.91876C534.348 2.15982 534.106 194.37 534.106 429.007V855.533H546.562H559.017V428.445V1.35627H547.124C540.535 1.35627 534.91 1.59733 534.669 1.91876Z" fill="white"/>
<path d="M594.373 227.959V260.904H598.793H603.212L603.292 233.744V206.664L613.98 233.583L624.667 260.503H627.801H630.854L641.381 233.985L651.827 207.548L652.068 234.226L652.229 260.904H657.05H661.872L661.711 228.119L661.47 195.415H654.398H647.247L637.926 219.682C632.783 233.101 628.363 244.03 628.122 244.03C627.801 244.03 623.462 233.423 618.48 220.486C613.498 207.629 608.998 196.54 608.596 195.977C608.114 195.334 605.542 195.013 601.123 195.013H594.373V227.959Z" fill="white"/>
<path d="M677.139 228.039V261.065L691.844 260.744C708.558 260.342 713.218 259.137 718.361 253.994C722.057 250.298 723.182 246.762 722.78 240.414C722.379 234.066 719.727 230.209 713.861 227.638L709.843 225.87L712.415 224.745C722.941 220.406 722.7 203.531 712.013 197.987C708.075 195.978 700.683 195.013 688.629 195.013H677.139V228.039ZM705.745 204.897C709.12 206.665 710.165 208.111 710.647 211.727C711.209 215.665 709.281 219.441 705.906 221.209C704.299 222.093 700.442 222.656 695.058 222.977L686.781 223.379V213.093V202.808L695.058 203.21C700.201 203.531 704.299 204.174 705.745 204.897ZM708.236 232.7C712.254 234.548 713.62 236.798 713.62 241.78C713.62 244.753 713.138 246.119 711.611 247.726C708.156 251.423 705.504 252.307 695.861 252.708L686.781 253.11V242.102V231.173H695.861C702.933 231.173 705.584 231.495 708.236 232.7Z" fill="white"/>
<path d="M593.167 352.67C592.926 353.232 592.846 466.533 592.926 604.423L593.167 855.132H663.478C740.378 855.132 737.968 855.212 757.896 850.23C791.886 841.632 818.484 820.258 834.233 788.839C844.68 768.107 848.858 745.527 848.055 714.671C847.572 695.385 845.805 683.895 841.064 669.752C834.555 650.306 825.876 635.521 813.421 622.985C804.904 614.307 797.109 608.602 786.422 603.218C776.136 598.075 769.949 595.986 754.441 592.29C747.289 590.602 741.664 588.995 741.985 588.674C742.387 588.432 747.369 587.227 753.075 586.022C761.833 584.254 765.047 583.129 773.163 579.111C798.716 566.415 815.912 546.166 825.394 517.639C833.992 492.086 833.912 452.23 825.314 426.597C820.171 411.088 811.734 397.669 799.761 385.776C782.083 368.259 762.315 359.179 729.771 353.634C722.781 352.429 713.299 352.188 657.612 351.947C605.301 351.706 593.489 351.786 593.167 352.67ZM721.334 388.187C741.905 392.205 755.324 398.633 767.378 410.285C784.252 426.516 792.85 450.061 792.85 480.033C792.85 509.202 784.252 532.103 766.414 550.424C755.646 561.594 742.628 568.906 725.754 573.326L717.718 575.415L674.969 575.736L632.14 575.977V481.078V386.098L673.362 386.5C707.272 386.821 715.709 387.062 721.334 388.187ZM732.584 611.012C752.914 616.396 766.735 624.271 780.074 638.172C786.422 644.762 790.842 651.431 796.225 662.359C803.939 678.27 807.314 694.903 807.314 717.322C807.314 748.982 798.797 774.053 782.083 791.812C768.181 806.517 752.833 814.633 730.173 819.052C724.468 820.177 716.111 820.418 677.782 820.74L632.14 821.061V714.51V607.959L677.782 608.2L723.343 608.521L732.584 611.012Z" fill="white"/>
<path d="M49.5637 606.834V855.533H62.0188H74.4739V615.432V375.41L67.4026 370.83C63.5455 368.259 58.0814 364.402 55.3493 362.152C52.6172 359.982 50.2066 358.134 49.9655 358.134C49.7244 358.134 49.5637 470.069 49.5637 606.834Z" fill="white"/>
<path d="M313.129 381.035C312.004 381.598 306.861 383.847 301.719 385.937L292.237 389.794V622.663V855.533H304.692H317.147V617.681C317.147 427.882 316.906 379.83 316.183 379.83C315.62 379.91 314.254 380.392 313.129 381.035Z" fill="white"/>
<path d="M110.634 624.431V855.533H123.089H135.544V628.128C135.544 446.846 135.303 400.642 134.58 400.401C131.526 399.437 113.205 394.053 112.08 393.731C110.714 393.33 110.634 404.66 110.634 624.431Z" fill="white"/>
<path d="M244.827 402.009C239.283 402.973 234.301 403.857 233.819 403.857C233.015 403.937 232.774 449.659 232.774 629.735V855.614L245.068 855.373L257.282 855.132L257.523 627.486C257.684 411.089 257.604 399.919 256.318 400C255.514 400.08 250.372 400.964 244.827 402.009Z" fill="white"/>
<path d="M172.507 630.941V855.614L184.802 855.373L197.016 855.132V630.941V406.75L184.802 406.508L172.507 406.267V630.941Z" fill="white"/>
<path d="M1152.79 511.251C1135.24 513.758 1119.66 518.235 1104.08 525.577C1085.45 534.352 1075.25 541.336 1059.84 555.842C1024.74 589.688 1006.84 634.1 1006.84 688.362C1006.84 726.327 1015.79 758.382 1034.06 786.14C1063.96 831.805 1108.38 854.907 1165.68 855.086C1198.45 855.086 1225.67 847.923 1247.88 833.417C1262.38 824.105 1283.52 802.078 1294.98 784.528L1304.11 770.381L1300.35 767.694C1296.59 765.187 1296.05 765.366 1290.86 771.992C1261.31 809.062 1243.04 823.03 1214.57 830.194C1200.78 833.775 1166.58 833.238 1151.89 829.477C1112.67 819.27 1082.41 789.363 1070.59 749.428C1065.93 734.027 1062.35 707.165 1062.35 687.645C1062.35 615.297 1085.45 562.289 1126.1 541.157C1133.09 537.575 1143.48 533.457 1149.38 531.845C1163.17 528.263 1193.8 528.263 1208.12 532.024C1242.15 540.799 1268.47 567.661 1283.52 609.208C1287.64 620.49 1288.89 622.281 1292.65 622.281C1296.23 622.281 1296.77 621.564 1296.05 617.266C1295.69 614.58 1293.9 591.121 1292.47 564.975C1289.07 509.281 1289.07 509.46 1284.23 509.46C1281.73 509.46 1279.76 511.788 1277.43 517.16C1272.95 527.368 1265.61 533.277 1258.45 532.203C1255.58 531.845 1246.63 528.442 1238.57 524.861C1211.35 512.683 1178.75 507.49 1152.79 511.251Z" fill="white"/>
<path d="M1479.25 511.43C1461.16 513.937 1435.56 522.712 1419.8 532.024C1402.43 542.232 1377.35 565.87 1365.89 583.241C1347.99 609.924 1339.93 636.428 1338.67 674.214C1336.7 730.983 1351.75 773.246 1386.49 808.525C1417.83 840.401 1453.28 855.086 1498.41 855.086C1542.83 855.086 1578.28 840.58 1609.62 809.42C1617.5 801.541 1627.53 790.08 1631.65 783.812C1670.15 726.685 1671.41 641.442 1634.51 584.495C1612.31 550.29 1577.21 524.324 1539.78 514.832C1522.95 510.534 1496.09 508.923 1479.25 511.43ZM1525.28 531.845C1576.67 545.276 1604.97 600.433 1604.97 687.108C1604.97 744.235 1593.33 782.379 1568.25 807.809C1548.56 827.866 1526.53 837.178 1498.41 837.178C1471.55 837.178 1454.18 830.015 1435.56 811.211C1412.1 787.572 1399.2 753.189 1395.26 704.658C1388.28 614.043 1418.18 546.709 1472.27 531.666C1483.91 528.442 1512.56 528.622 1525.28 531.845Z" fill="white"/>
<path d="M2780.28 511.609C2779.38 512.862 2750.91 578.406 2717.42 657.202C2683.75 735.997 2653.31 805.302 2649.73 811.211C2638.62 829.657 2635.94 831.626 2611.94 838.252C2610.69 838.611 2609.61 840.939 2609.61 843.446V847.923H2662.44H2715.27V843.446C2715.27 838.79 2714.19 838.252 2699.15 836.283C2688.94 835.029 2679.99 829.657 2677.66 823.568C2674.8 816.226 2677.12 808.167 2692.53 771.276L2707.03 736.893L2770.61 737.251L2834 737.788L2846.36 766.978C2862.12 804.406 2865.52 816.584 2862.12 824.642C2859.43 830.91 2848.86 836.999 2840.27 837.178C2832.75 837.178 2829.88 838.969 2829.88 843.625V847.923H2895.42H2960.79L2960.25 843.088C2959.71 838.611 2958.82 837.894 2951.12 836.82C2939.84 835.208 2928.38 828.224 2922.64 819.807C2913.69 806.376 2907.42 792.05 2848.68 651.829C2799.44 534.352 2788.87 510.176 2785.83 509.818C2783.68 509.46 2781.35 510.355 2780.28 511.609ZM2800.15 655.053C2814.48 689.436 2826.3 717.731 2826.3 718.268C2826.3 718.626 2801.41 718.985 2770.78 718.985C2740.34 718.985 2715.27 718.626 2715.27 718.268C2715.27 717.91 2727.09 690.332 2741.41 657.023C2755.74 623.534 2768.28 594.344 2769.35 591.837C2770.78 588.256 2771.32 587.897 2772.57 590.046C2773.29 591.479 2785.83 620.848 2800.15 655.053Z" fill="white"/>
<path d="M3139.69 510.713C3126.44 512.146 3104.77 516.981 3093.31 521.279C3055.52 535.427 3020.96 569.452 3000.72 612.252C2987.29 640.726 2984.96 652.187 2984.96 688.541C2984.96 717.552 2985.32 721.133 2989.98 735.997C3002.87 778.26 3031.17 813.539 3068.06 833.417C3095.82 848.281 3126.8 855.086 3166.73 855.086C3204.88 855.086 3233.53 848.997 3265.41 834.133L3282.78 825.896L3283.31 760.352C3283.85 700.539 3284.21 694.271 3287.07 689.794C3292.09 682.273 3300.51 677.796 3310.35 677.796C3318.59 677.796 3318.77 677.617 3318.77 672.423V667.051L3254.84 667.409L3190.73 667.946V672.423C3190.73 676.721 3191.45 676.9 3202.91 678.154C3217.59 679.587 3224.93 683.526 3229.95 693.018C3233.53 699.823 3233.71 702.688 3233.71 760.173V820.165L3222.43 825.717C3196.1 838.79 3159.57 841.655 3133.42 832.701C3106.02 823.568 3085.25 807.629 3069.67 783.991C3017.02 703.404 3037.26 575.003 3108.35 540.083C3126.44 531.129 3139.69 528.442 3163.87 528.442C3182.31 528.621 3187.33 529.338 3199.32 533.457C3232.81 544.739 3252.69 566.408 3270.24 610.282C3271.67 614.043 3273.29 615.297 3276.33 614.759C3280.99 614.043 3280.99 620.132 3275.79 556.021C3273.82 531.845 3272.21 511.43 3272.21 510.713C3272.21 509.818 3270.06 509.46 3267.38 509.818C3263.61 510.176 3262.18 511.43 3261.82 514.832C3260.93 523.07 3257.53 529.159 3253.41 530.233C3250.9 530.77 3238.54 527.726 3221.71 522.175C3187.68 511.072 3165.84 508.027 3139.69 510.713Z" fill="white"/>
<path d="M1683.22 517.877C1682.51 518.414 1681.97 520.921 1681.97 523.249C1681.97 527.189 1682.69 527.368 1694.15 527.368C1710.62 527.547 1719.94 531.845 1725.31 542.052L1729.43 549.753L1730.5 652.724C1731.22 719.88 1732.29 759.636 1733.73 767.157C1738.56 793.303 1746.98 809.062 1765.24 826.254C1779.75 839.685 1794.79 847.027 1817.36 851.683C1842.25 856.877 1889.53 855.802 1908.51 849.713C1928.21 843.446 1941.46 835.566 1955.07 821.956C1984.62 792.587 1988.2 773.067 1988.2 636.786C1988.38 551.007 1988.74 546.53 1996.62 537.755C2001.99 531.666 2013.27 527.368 2024.55 527.368C2034.76 527.368 2034.76 527.368 2034.76 521.995V516.623L1976.2 516.981L1917.46 517.518L1916.93 522.175C1916.39 526.831 1916.57 526.831 1930.54 527.726C1947.73 528.621 1955.43 532.561 1960.44 542.59C1963.84 549.574 1964.02 553.335 1964.02 650.038C1964.02 740.474 1963.67 751.756 1960.8 765.545C1959.01 773.962 1955.43 784.528 1952.92 789.363C1943.79 805.839 1922.12 821.956 1898.84 829.477C1887.02 833.238 1854.61 834.492 1841 831.984C1817.18 827.328 1795.33 809.778 1787.63 789.363C1779.57 767.694 1778.5 751.04 1779.03 645.919C1779.57 551.365 1779.75 547.783 1783.15 541.694C1788.35 532.74 1799.81 527.368 1813.95 527.368H1825.24V521.995V516.623H1754.86C1716 516.623 1683.76 517.16 1683.22 517.877Z" fill="white"/>
<path d="M2048.55 517.877C2047.83 518.414 2047.3 520.742 2047.3 522.891C2047.3 526.652 2048.37 527.01 2061.44 527.726C2078.46 528.622 2086.16 532.561 2091.17 542.59C2094.57 549.574 2094.75 553.872 2095.29 671.528C2095.65 738.504 2095.29 799.213 2094.75 806.197C2092.78 828.403 2084.37 836.283 2061.09 838.252C2048.19 839.506 2047.3 839.685 2047.3 843.625V847.923H2118.93H2190.56V843.625C2190.56 839.685 2189.67 839.506 2176.77 838.252C2154.75 836.462 2146.69 829.657 2144 810.137C2143.11 803.869 2142.21 775.037 2142.21 746.205V693.913H2159.76L2177.13 694.092L2232.65 770.918L2288.16 847.923H2332.39H2376.81V843.446C2376.81 838.432 2376.98 838.432 2361.58 835.566C2343.85 832.343 2330.6 824.642 2315.74 809.062C2305.17 797.959 2228.71 694.63 2226.74 688.899C2226.56 688.183 2232.11 685.676 2239.27 683.347C2246.43 681.019 2257.18 676.721 2263.09 673.498C2310.9 648.427 2320.4 584.674 2282.07 547.067C2262.01 527.368 2243.03 521.279 2193.25 518.414C2158.86 516.444 2050.34 515.907 2048.55 517.877ZM2209.37 541.874C2222.44 546.709 2237.3 560.498 2243.75 573.571C2248.4 583.062 2248.76 585.39 2248.76 605.268C2248.76 625.325 2248.4 627.295 2243.75 636.249C2229.78 662.753 2205.25 675.289 2164.24 677.259L2142.21 678.333V610.103V541.694L2146.33 540.799C2167.46 535.606 2194.14 536.143 2209.37 541.874Z" fill="white"/>
<path d="M2359.97 533.994C2359.43 543.664 2358.36 561.393 2357.82 573.571L2356.57 595.777L2361.76 595.061C2366.42 594.523 2366.96 593.807 2368.21 585.748C2370.72 568.198 2379.67 553.335 2392.56 545.813C2400.8 540.799 2401.52 540.799 2435.54 540.262L2469.93 539.545L2469.57 680.303C2469.03 819.986 2469.03 820.882 2465.27 825.896C2459.36 833.775 2452.02 836.999 2437.16 838.252C2424.26 839.506 2423.37 839.685 2423.37 843.625V847.923H2494.1H2564.84V843.625C2564.84 839.685 2563.95 839.327 2551.95 838.252C2535.47 836.82 2527.41 832.701 2522.76 823.568C2519.35 816.763 2519.17 812.465 2518.64 678.154L2518.1 539.904H2550.16C2586.15 539.904 2593.85 541.515 2605.31 551.365C2613.91 558.707 2619.82 570.347 2622.5 584.674C2624.47 594.702 2624.83 595.419 2629.49 595.419H2634.5L2633.43 574.287C2632.89 562.826 2632 545.276 2631.28 535.427L2630.2 517.519L2495.72 516.981L2361.23 516.623L2359.97 533.994Z" fill="white"/>
<path d="M3336.14 517.877C3335.43 518.414 3334.89 520.921 3334.89 523.249C3334.89 527.189 3335.6 527.368 3345.81 527.368C3370.17 527.368 3378.76 533.815 3381.45 554.409C3383.6 571.064 3383.78 794.199 3381.63 810.853C3380.55 818.375 3378.76 824.463 3376.61 826.791C3371.06 833.059 3360.68 836.999 3347.6 838.252C3335.78 839.327 3334.89 839.864 3334.89 843.625V847.923H3462.57H3590.26L3604.05 807.809C3611.57 785.782 3617.84 766.799 3617.84 765.725C3617.84 764.65 3615.87 763.755 3613.72 763.755C3610.31 763.755 3607.63 766.978 3599.75 780.23C3588.47 799.392 3572.17 816.942 3560.35 822.672C3554.08 825.538 3546.02 827.149 3529.91 828.403C3501.61 830.91 3444.66 829.836 3439.29 826.791C3430.88 822.135 3430.7 820.344 3430.16 750.682L3429.62 684.959H3474.03C3521.31 684.959 3528.83 686.034 3538.86 693.376C3545.85 698.748 3548.89 705.195 3551.58 721.313C3553.73 732.953 3553.9 733.311 3558.92 733.311H3564.11V676.005V618.699H3558.92C3554.08 618.699 3553.73 619.237 3552.65 628.012C3550.68 642.875 3543.7 655.59 3534.92 660.425C3527.76 664.186 3525.07 664.365 3478.69 664.902L3429.8 665.439V600.97V536.322H3483.35C3512.72 536.322 3541.01 537.217 3546.38 538.113C3567.16 542.053 3575.57 552.977 3582.74 585.032C3583.63 589.151 3584.89 590.046 3589.18 590.046H3594.38L3593.48 574.287C3592.94 565.691 3591.87 549.395 3591.33 538.113L3590.08 517.519L3463.65 516.981C3394.16 516.802 3336.68 517.16 3336.14 517.877Z" fill="white"/>
</svg>

================
File: public/assets/svgs/logo-cote.svg
================
<svg width="1523" height="540" viewBox="0 0 1523 540" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M98.3982 2.40319C84.9315 5.20319 70.5315 11.3365 60.1315 18.4032C47.9982 26.6699 29.3315 43.7365 23.8649 51.4699C17.7315 60.2699 9.06486 77.2032 5.86486 86.6699C-4.26847 116.937 -1.20181 151.737 14.5315 182.803C25.0649 203.603 45.0649 220.937 71.8649 232.27C90.3982 240.27 96.7982 241.47 119.065 241.337C149.732 241.203 171.998 235.737 193.732 222.803L202.265 217.603L202.665 170.537L203.065 123.603H162.265H121.465V136.27L121.332 149.07L149.465 148.937L177.732 148.67L178.132 177.337L178.398 205.87L168.132 209.87C152.132 216.27 143.865 217.47 120.398 217.603C100.398 217.603 98.2649 217.337 87.1982 213.737C73.7315 209.337 58.7982 199.603 48.6649 188.537C39.7315 178.937 28.5315 156.27 26.3982 143.47C24.2649 131.337 25.3315 107.87 28.3982 94.9365C31.7315 80.9365 41.4649 63.0699 51.0649 53.4699C70.7982 33.7365 91.9982 24.5365 122.398 22.6699C141.198 21.6032 156.398 24.6699 174.798 33.2032L189.598 40.0032L195.332 33.7365C204.532 23.6032 203.865 22.4032 184.798 12.9365C164.798 3.06986 155.598 0.936527 130.398 0.136527C114.398 -0.263473 108.932 0.136527 98.3982 2.40319Z" fill="black"/>
<path d="M260.265 268.403C260.531 415.736 260.798 536.27 260.931 536.27C261.065 536.27 264.931 536.27 269.731 536.27H278.398V269.203V2.26975H274.131C271.731 2.26975 267.465 1.86975 264.798 1.46975L259.865 0.536414L260.265 268.403Z" fill="black"/>
<path d="M221.198 268.27C221.065 414.803 220.798 534.936 220.532 535.47C220.265 535.87 224.665 536.27 230.532 536.27L241.065 536.403V270.003V3.60305H233.198C228.798 3.60305 224.398 3.20305 223.332 2.80305C221.465 2.13638 221.198 31.8697 221.198 268.27Z" fill="black"/>
<path d="M334.132 45.8698C333.865 70.0032 333.865 190.27 334.132 313.203L334.398 536.937H343.732H353.065L353.198 477.203C353.465 394.803 353.465 203.87 353.332 93.8698L353.065 2.26983H343.732H334.532L334.132 45.8698Z" fill="black"/>
<path d="M298.131 269.203C297.865 415.336 297.865 535.07 297.865 535.336C297.998 535.603 302.265 536.136 307.465 536.536L316.931 537.336L316.798 270.403L316.665 3.60306H307.598H298.398L298.131 269.203Z" fill="black"/>
<path d="M369.731 370.537C369.731 456.537 369.331 529.07 368.931 531.87C368.131 536.403 368.398 536.803 372.265 537.47C374.531 538.003 392.665 538.67 412.531 539.203C446.265 539.87 449.198 539.737 459.731 537.07C484.665 530.803 506.131 515.737 515.065 498.27C516.398 495.737 519.198 491.203 521.198 488.27C523.465 485.203 526.265 478.27 527.865 471.603C530.265 462.137 530.665 457.87 529.998 445.603C529.198 428.803 526.131 418.003 518.665 405.737C513.198 396.537 495.065 378.27 486.798 373.337C483.598 371.47 481.065 369.337 481.065 368.403C481.065 367.603 485.598 363.07 491.198 358.27C499.465 351.203 502.531 347.47 508.398 336.937C516.531 322.27 518.798 313.87 518.665 296.27C518.398 270.537 507.198 250.137 484.665 234.537C463.998 220.27 456.265 218.403 411.731 216.937C392.265 216.27 374.931 215.337 373.065 214.937L369.731 214.137V370.537ZM423.065 240.937C439.198 241.87 448.398 242.937 454.531 244.803C470.665 249.87 485.998 264.003 491.598 278.937C495.465 289.07 497.465 302.803 496.531 310.537C495.465 318.003 488.665 334.27 486.531 334.27C485.865 334.27 484.131 336.137 482.798 338.403C479.998 343.203 469.598 351.203 459.998 356.137C452.265 360.003 448.265 360.27 411.731 358.67L391.065 357.87L390.665 298.803L390.265 239.603H395.331C398.131 239.603 410.665 240.27 423.065 240.937ZM455.465 384.67C460.531 386.003 468.131 389.07 472.398 391.603C483.331 398.137 495.865 410.803 500.265 419.737C508.531 436.937 509.865 464.803 502.798 479.07C497.598 489.603 485.731 503.337 475.998 509.87C462.931 518.67 453.731 520.137 419.865 518.937C404.798 518.403 392.131 517.603 391.731 517.203C391.331 516.67 391.198 485.737 391.465 448.403L391.998 380.537L419.065 381.47C437.998 382.003 448.931 383.07 455.465 384.67Z" fill="black"/>
<path d="M29.5982 257.87C29.9982 272.403 30.3982 340.803 30.3982 409.87V535.603H34.2649C36.2649 535.603 40.7982 536.003 44.2649 536.403L50.3982 537.336V389.736V242.136L44.1316 239.336C40.5316 237.87 36.1316 235.47 34.1316 234.136C32.2649 232.67 30.2649 231.603 29.5982 231.603C29.0649 231.603 29.0649 243.47 29.5982 257.87Z" fill="black"/>
<path d="M196.931 240.137C195.198 242.003 191.065 244.27 187.731 245.337L181.731 247.337V392.137V536.937H191.731H201.731V387.737C201.731 305.603 201.465 238.137 200.931 237.737C200.531 237.337 198.798 238.403 196.931 240.137Z" fill="black"/>
<path d="M69.0647 392.803C69.0647 470.67 68.798 534.803 68.5314 535.47C68.1314 536.003 72.398 536.403 77.8647 536.403L87.7314 536.27L87.4647 397.203L87.0647 258.003L80.398 255.603C76.798 254.27 72.6647 252.803 71.4647 252.27C69.198 251.336 69.0647 258.67 69.0647 392.803Z" fill="black"/>
<path d="M157.732 254.936C155.598 256.003 151.465 257.203 148.532 257.603L143.465 258.403L144.265 293.336C144.665 312.536 144.665 375.07 144.132 432.27L143.065 536.403H152.798H162.398V394.67C162.398 316.67 162.265 252.936 162.132 253.07C161.865 253.07 159.998 253.87 157.732 254.936Z" fill="black"/>
<path d="M106.531 396.537L107.065 535.337L112.931 536.137C116.131 536.537 120.131 536.937 121.865 536.937H125.065V398.27V259.603H121.865C120.131 259.603 115.865 259.203 112.398 258.67L106.131 257.87L106.531 396.537Z" fill="black"/>
<path d="M715.759 416.516C684.819 421.649 665 443.606 665 472.693C665.143 500.924 680.684 523.309 706.063 531.579C724.599 537.71 740.426 536.855 755.824 529.013C760.387 526.731 764.95 524.735 765.948 524.735C767.088 524.735 768.086 521.598 768.799 516.608C769.37 512.188 770.083 507.768 770.51 506.627C772.079 502.635 767.516 505.059 762.668 510.62C755.254 519.317 745.701 523.309 732.156 523.309C724.457 523.309 719.324 522.454 714.761 520.458C705.065 516.323 694.942 506.2 690.237 495.791C686.53 487.664 686.102 485.525 686.102 470.412V453.872L691.948 445.46C699.932 433.911 709.2 429.206 725.597 428.207C744.703 427.067 754.113 431.772 766.09 448.597L769.085 452.731L767.944 444.889C767.374 440.612 766.803 433.483 766.803 429.063L766.661 420.936L761.385 420.223C758.391 419.938 751.547 418.512 745.986 417.229C735.15 414.805 727.308 414.662 715.759 416.516Z" fill="black"/>
<path d="M1261.56 423.218C1254.43 439.9 1235.9 481.534 1231.76 489.946C1229.34 494.651 1225.63 503.634 1223.49 509.765C1221.35 515.896 1217.36 524.166 1214.94 527.873L1210.23 534.717H1226.63C1235.61 534.717 1242.88 534.146 1242.88 533.433C1242.88 532.72 1240.6 530.867 1237.75 529.156C1232.19 525.876 1232.19 525.876 1237.61 511.618L1240.6 503.634L1253.72 502.636C1260.85 502.065 1270.12 502.065 1274.25 502.636L1281.67 503.634L1285.8 512.759C1291.08 524.308 1291.08 527.16 1285.66 530.154C1283.38 531.437 1281.38 532.863 1281.38 533.291C1281.38 534.004 1311.32 534.146 1317.6 533.576C1319.88 533.291 1319.59 532.578 1315.74 528.3C1313.32 525.449 1309.47 519.46 1307.19 515.04C1303.34 507.198 1287.08 467.275 1287.08 465.279C1287.08 463.996 1266.98 417.229 1265.84 416.089C1265.41 415.518 1263.41 418.798 1261.56 423.218ZM1274.39 479.395L1278.39 489.09H1263.41C1249.73 489.09 1248.44 488.805 1249.16 486.524C1249.44 485.241 1250.3 482.532 1250.73 480.536C1251.3 478.539 1254 471.696 1256.86 465.137L1261.85 453.302L1266.12 461.572C1268.41 466.135 1272.11 474.119 1274.39 479.395Z" fill="black"/>
<path d="M1443.92 417.228C1445.06 418.654 1447.49 421.791 1449.2 423.929C1452.48 427.922 1452.48 428.207 1452.48 474.546V521.17L1448.91 526.588C1446.92 529.44 1444.49 531.864 1443.5 532.006C1442.5 532.006 1443.07 532.434 1444.64 533.004C1446.2 533.575 1463.6 533.86 1483.28 533.575L1519.06 533.147L1520.06 523.594C1520.49 518.318 1521.34 512.33 1521.77 510.049C1523.2 503.633 1519.06 505.344 1514.22 513.043C1510.22 519.459 1509.37 520.029 1503.09 520.885C1493.26 522.311 1474.15 522.168 1473.29 520.6C1472.87 520.029 1472.3 511.047 1472.01 500.638L1471.44 481.96H1484.99C1497.82 481.96 1498.96 482.245 1502.67 485.81C1504.81 487.806 1506.94 489.374 1507.23 488.947C1508.23 487.806 1509.08 464.85 1508.08 464.85C1507.51 464.85 1506.23 465.848 1505.23 466.989C1503.81 468.7 1499.96 469.128 1487.55 469.128H1471.73L1471.3 449.879L1470.73 430.631H1490.12H1509.65L1512.5 435.621C1515.93 441.324 1520.35 442.608 1518.92 437.332C1518.49 435.621 1518.07 430.06 1518.07 424.928V415.66L1495.68 416.8C1474.15 417.798 1450.77 417.228 1444.64 415.375C1442.07 414.662 1441.93 414.804 1443.92 417.228Z" fill="black"/>
<path d="M826.545 418.94C808.865 423.93 799.169 431.202 791.47 444.747C774.788 474.689 786.765 514.897 816.849 529.583C831.678 536.855 853.065 537.283 866.325 530.439C882.152 522.454 896.125 506.342 901.543 490.088C905.25 478.824 903.824 461.857 898.121 450.165C891.99 437.903 878.445 424.928 867.038 420.651C855.347 416.373 838.379 415.661 826.545 418.94ZM860.765 433.483C869.605 438.046 875.736 444.177 879.443 452.304C882.437 458.863 882.865 462 882.865 476.258C882.865 491.229 882.58 493.367 878.872 501.209C873.882 511.76 870.46 515.468 861.905 519.888C854.063 523.88 839.805 524.593 832.106 521.313C813.57 513.471 803.589 496.647 803.589 472.693C803.447 460.431 806.869 448.454 812.429 441.468C815.281 437.761 823.551 432.77 830.822 430.489C836.668 428.493 854.491 430.346 860.765 433.483Z" fill="black"/>
<path d="M920.649 417.942C920.649 418.37 921.932 419.938 923.358 421.221C925.924 423.645 926.209 426.354 926.637 465.992C927.065 513.757 927.207 514.47 939.042 525.163C948.452 533.575 966.845 537.14 981.103 533.148C988.66 531.009 999.781 520.173 1005.2 509.764L1009.62 501.209L1010.48 463.425C1011.19 426.782 1011.33 425.499 1014.47 420.936L1017.75 416.373H1003.49C989.516 416.373 986.236 417.514 991.654 420.508C993.793 421.792 994.078 425.641 994.506 463.283C994.934 503.348 994.934 505.059 991.939 511.19C986.379 522.882 972.976 526.732 960.572 520.458C946.884 513.471 944.317 501.495 945.743 453.017C946.599 424.786 946.884 421.792 949.308 420.508C954.441 417.799 951.874 417.086 936.333 417.086C927.635 417.086 920.649 417.514 920.649 417.942Z" fill="black"/>
<path d="M1038.99 421.507C1041.7 425.784 1041.84 428.778 1041.84 475.973C1041.84 525.591 1041.84 526.019 1038.71 529.013C1037 530.582 1035.14 531.865 1034.43 531.865C1033.86 531.865 1033.29 532.435 1033.29 533.291C1033.29 534.146 1039.99 534.717 1050.4 534.717C1059.81 534.717 1067.51 534.289 1067.51 533.718C1067.51 533.148 1066.22 531.295 1064.66 529.726C1060.95 525.876 1059.52 511.761 1061.09 495.649L1062.09 484.67L1068.51 485.098C1074.78 485.526 1075.06 485.811 1080.48 494.794C1095.45 520.316 1103.72 533.148 1105.58 533.861C1106.72 534.431 1112.14 534.717 1117.7 534.717H1127.68L1124.97 531.437C1103.72 504.347 1090.75 484.67 1092.46 481.961C1093.03 481.106 1094.17 480.536 1095.17 480.536C1099.16 480.536 1108.86 470.127 1113.28 461.144C1117.7 452.304 1117.84 451.592 1116.13 444.462C1113.99 434.482 1108.86 427.353 1100.73 422.505C1093.6 418.37 1095.03 418.513 1052.96 417.372L1036.28 416.944L1038.99 421.507ZM1090.46 436.193C1095.45 441.04 1096.02 442.466 1096.02 448.597C1096.02 464.852 1091.03 471.696 1078.49 472.979C1074.21 473.406 1068.36 473.406 1065.51 472.836L1060.38 471.838V458.721C1060.38 451.449 1060.81 442.181 1061.23 438.046L1062.23 430.632H1073.64C1084.9 430.632 1085.05 430.632 1090.46 436.193Z" fill="black"/>
<path d="M1138.8 426.497C1138.8 431.772 1138.37 438.046 1137.94 440.47C1136.66 447.028 1140.94 446.316 1144.36 439.329C1147.78 432.77 1149.35 432.057 1160.33 432.057H1168.74V479.109C1168.74 514.897 1168.31 526.446 1167.03 527.587C1166.03 528.442 1163.89 530.011 1162.32 531.152C1160.76 532.15 1159.76 533.433 1160.19 533.861C1160.76 534.431 1189.99 535.144 1196.4 534.859C1197.11 534.716 1196.4 533.29 1194.69 531.437C1189.13 525.448 1188.7 521.741 1188.7 476.115V432.057H1200.82H1212.94L1214.94 437.048C1217.65 443.606 1220.07 443.464 1220.07 436.62C1220.07 433.768 1220.5 428.065 1220.93 424.215L1221.78 417.086H1180.29H1138.8V426.497Z" fill="black"/>
<path d="M1364.08 417.8C1349.82 421.222 1333.57 431.488 1326.72 441.468C1314.74 458.578 1315.74 489.518 1328.72 510.05C1339.41 526.875 1356.09 534.717 1380.9 534.717C1394.45 534.574 1402 533.006 1414.27 527.302L1423.82 523.025L1424.25 502.636C1424.67 485.098 1425.1 481.819 1427.38 479.252L1429.95 476.401L1405.57 475.973L1381.19 475.545V479.395C1381.19 483.387 1381.33 483.387 1390.17 483.387C1402.72 483.387 1404.14 484.67 1405.57 498.501C1407.56 517.749 1407.56 517.464 1400.86 520.458C1392.59 524.166 1374.2 524.308 1366.22 520.601C1351.96 514.185 1339.84 491.942 1338.7 470.27C1338.13 459.434 1338.41 457.01 1341.26 451.734C1349.25 436.05 1361.94 428.778 1381.19 428.636C1397.58 428.636 1405.57 432.343 1411.98 443.179L1416.55 450.593L1417.26 440.328C1417.69 434.624 1418.54 428.208 1418.97 425.927C1419.83 422.505 1419.54 422.077 1416.69 422.077C1414.84 422.077 1408.14 420.794 1401.86 419.226C1390.03 416.374 1373.2 415.661 1364.08 417.8Z" fill="black"/>
</svg>

================
File: public/assets/svgs/logo-entier-final.svg
================
<svg width="567" height="538" viewBox="0 0 567 538" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M98.3982 2.4032C84.9315 5.2032 70.5315 11.3365 60.1315 18.4032C47.9982 26.6699 29.3315 43.7365 23.8649 51.4699C17.7315 60.2699 9.06486 77.2032 5.86486 86.6699C-4.26847 116.937 -1.20181 151.737 14.5315 182.803C25.0649 203.603 45.0649 220.937 71.8649 232.27C90.3982 240.27 96.7982 241.47 119.065 241.337C149.732 241.203 171.998 235.737 193.732 222.803L202.265 217.603L202.665 170.537L203.065 123.603H162.265H121.465V136.27L121.332 149.07L149.465 148.937L177.732 148.67L178.132 177.337L178.398 205.87L168.132 209.87C152.132 216.27 143.865 217.47 120.398 217.603C100.398 217.603 98.2649 217.337 87.1982 213.737C73.7315 209.337 58.7982 199.603 48.6649 188.537C39.7315 178.937 28.5315 156.27 26.3982 143.47C24.2649 131.337 25.3315 107.87 28.3982 94.9365C31.7315 80.9365 41.4649 63.0699 51.0649 53.4699C70.7982 33.7365 91.9982 24.5365 122.398 22.6699C141.198 21.6032 156.398 24.6699 174.798 33.2032L189.598 40.0032L195.332 33.7365C204.532 23.6032 203.865 22.4032 184.798 12.9365C164.798 3.06985 155.598 0.936523 130.398 0.13652C114.398 -0.263474 108.932 0.13652 98.3982 2.4032Z" fill="#1329A7"/>
<path d="M29.5982 257.87C29.9982 272.403 30.3982 340.803 30.3982 409.87V535.603H34.2649C36.2649 535.603 40.7982 536.003 44.2649 536.403L50.3982 537.336V389.736V242.136L44.1316 239.336C40.5316 237.87 36.1316 235.47 34.1316 234.136C32.2649 232.669 30.2649 231.603 29.5982 231.603C29.0649 231.603 29.0649 243.47 29.5982 257.87Z" fill="#1329A7"/>
<path d="M196.931 240.136C195.198 242.003 191.065 244.27 187.731 245.336L181.731 247.336V392.136V536.936H191.731H201.731V387.736C201.731 305.603 201.465 238.136 200.931 237.736C200.531 237.336 198.798 238.403 196.931 240.136Z" fill="#1329A7"/>
<path d="M69.0647 392.803C69.0647 470.669 68.798 534.803 68.5314 535.469C68.1314 536.003 72.398 536.403 77.8647 536.403L87.7314 536.269L87.4647 397.203L87.0647 258.003L80.398 255.603C76.798 254.269 72.6647 252.803 71.4647 252.269C69.198 251.336 69.0647 258.669 69.0647 392.803Z" fill="#1329A7"/>
<path d="M157.732 254.936C155.598 256.003 151.465 257.203 148.532 257.603L143.465 258.403L144.265 293.336C144.665 312.536 144.665 375.069 144.132 432.269L143.065 536.403H152.798H162.398V394.669C162.398 316.669 162.265 252.936 162.132 253.069C161.865 253.069 159.998 253.869 157.732 254.936Z" fill="#1329A7"/>
<path d="M106.531 396.536L107.065 535.336L112.931 536.136C116.131 536.536 120.131 536.936 121.865 536.936H125.065V398.27V259.603H121.865C120.131 259.603 115.865 259.203 112.398 258.67L106.131 257.87L106.531 396.536Z" fill="#1329A7"/>
<path d="M239.355 45.9633C239.622 70.1117 239.622 190.453 239.355 313.463L239.088 537.336H229.754H220.419L220.286 477.566C220.019 395.114 220.019 204.062 220.153 93.9933L220.419 2.33618L229.754 16.5117L239.355 29.0195L239.355 45.9633Z" fill="#1329A7"/>
<path d="M257.965 290.836C258.238 426.417 258.512 537.336 258.648 537.336C258.785 537.336 262.749 537.336 267.67 537.336H276.555V291.572V57.223L269.483 52.1617L262.612 47.5605L257.555 44.3362L257.965 290.836Z" fill="#1329A7"/>
<path d="M313.36 116.684C313.62 137.357 313.62 240.379 313.36 345.684L313.1 537.336H304H294.9L294.77 486.168C294.51 415.584 294.51 252.028 294.64 157.801L294.9 79.3362H304H313.36V116.684Z" fill="#1329A7"/>
<path d="M350.145 289.336C349.871 425.742 349.598 537.336 349.461 537.336C349.325 537.336 345.361 537.336 340.44 537.336H331.555V290.077V54.3014L338.627 49.2093L345.497 44.5801L350.555 41.3362L350.145 289.336Z" fill="#1329A7"/>
<path d="M368.755 46.2695C368.488 70.4028 368.488 190.669 368.755 313.603L369.022 537.336H378.355H387.688L387.822 477.603C388.088 395.203 388.088 204.27 387.955 94.2695L387.688 2.66949L378.355 16.8362L368.755 29.3362L368.755 46.2695Z" fill="#1329A7"/>
<path d="M406.208 368.332C406.208 454.332 405.808 526.865 405.408 529.665C404.608 534.198 404.875 534.598 408.741 535.265C411.008 535.798 429.141 536.465 449.008 536.998C482.741 537.665 485.675 537.532 496.208 534.865C521.141 528.598 542.608 513.532 551.541 496.065C552.875 493.532 555.675 488.998 557.675 486.065C559.941 482.998 562.741 476.065 564.341 469.398C566.741 459.932 567.141 455.665 566.475 443.398C565.675 426.598 562.608 415.798 555.141 403.532C549.675 394.332 531.541 376.065 523.275 371.132C520.075 369.265 517.541 367.132 517.541 366.198C517.541 365.398 522.075 360.865 527.675 356.065C535.941 348.998 539.008 345.265 544.875 334.732C553.008 320.065 555.275 311.665 555.141 294.065C554.875 268.332 543.675 247.932 521.141 232.332C500.475 218.065 492.741 216.198 448.208 214.732C428.741 214.065 411.408 213.132 409.541 212.732L406.208 211.932V368.332ZM459.541 238.732C475.675 239.665 484.875 240.732 491.008 242.598C507.141 247.665 522.475 261.798 528.075 276.732C531.941 286.865 533.941 300.598 533.008 308.332C531.941 315.798 525.141 332.065 523.008 332.065C522.341 332.065 520.608 333.932 519.275 336.198C516.475 340.998 506.075 348.998 496.475 353.932C488.741 357.798 484.741 358.065 448.208 356.465L427.541 355.665L427.141 296.598L426.741 237.398H431.808C434.608 237.398 447.141 238.065 459.541 238.732ZM491.941 382.465C497.008 383.798 504.608 386.865 508.875 389.398C519.808 395.932 532.341 408.598 536.741 417.532C545.008 434.732 546.341 462.598 539.275 476.865C534.075 487.398 522.208 501.132 512.475 507.665C499.408 516.465 490.208 517.932 456.341 516.732C441.275 516.198 428.608 515.398 428.208 514.998C427.808 514.465 427.675 483.532 427.941 446.198L428.475 378.332L455.541 379.265C474.475 379.798 485.408 380.865 491.941 382.465Z" fill="#1329A7"/>
</svg>

================
File: public/assets/svgs/logo-entier.svg
================
<svg width="730" height="655" viewBox="0 0 730 655" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M198.398 2.40319C184.932 5.20319 170.532 11.3365 160.132 18.4032C147.998 26.6699 129.332 43.7365 123.865 51.4699C117.732 60.2699 109.065 77.2032 105.865 86.6699C95.7315 116.937 98.7982 151.737 114.532 182.803C125.065 203.603 145.065 220.937 171.865 232.27C190.398 240.27 196.798 241.47 219.065 241.337C249.732 241.203 271.998 235.737 293.732 222.803L302.265 217.603L302.665 170.537L303.065 123.603H262.265H221.465V136.27L221.332 149.07L249.465 148.937L277.732 148.67L278.132 177.337L278.398 205.87L268.132 209.87C252.132 216.27 243.865 217.47 220.398 217.603C200.398 217.603 198.265 217.337 187.198 213.737C173.732 209.337 158.798 199.603 148.665 188.537C139.732 178.937 128.532 156.27 126.398 143.47C124.265 131.337 125.332 107.87 128.398 94.9365C131.732 80.9365 141.465 63.0699 151.065 53.4699C170.798 33.7365 191.998 24.5365 222.398 22.6699C241.198 21.6032 256.398 24.6699 274.798 33.2032L289.598 40.0032L295.332 33.7365C304.532 23.6032 303.865 22.4032 284.798 12.9365C264.798 3.06986 255.598 0.936527 230.398 0.136527C214.398 -0.263473 208.932 0.136527 198.398 2.40319Z" fill="black"/>
<path d="M360.265 268.403C360.531 415.736 360.798 536.27 360.931 536.27C361.065 536.27 364.931 536.27 369.731 536.27H378.398V269.203V2.26975H374.131C371.731 2.26975 367.465 1.86975 364.798 1.46975L359.865 0.536414L360.265 268.403Z" fill="black"/>
<path d="M321.198 268.27C321.065 414.803 320.798 534.936 320.532 535.47C320.265 535.87 324.665 536.27 330.532 536.27L341.065 536.403V270.003V3.60305H333.198C328.798 3.60305 324.398 3.20305 323.332 2.80305C321.465 2.13638 321.198 31.8697 321.198 268.27Z" fill="black"/>
<path d="M434.132 45.8698C433.865 70.0032 433.865 190.27 434.132 313.203L434.398 536.937H443.732H453.065L453.198 477.203C453.465 394.803 453.465 203.87 453.332 93.8698L453.065 2.26983H443.732H434.532L434.132 45.8698Z" fill="black"/>
<path d="M398.131 269.203C397.865 415.336 397.865 535.07 397.865 535.336C397.998 535.603 402.265 536.136 407.465 536.536L416.931 537.336L416.798 270.403L416.665 3.60306H407.598H398.398L398.131 269.203Z" fill="black"/>
<path d="M469.731 370.537C469.731 456.537 469.331 529.07 468.931 531.87C468.131 536.403 468.398 536.803 472.265 537.47C474.531 538.003 492.665 538.67 512.531 539.203C546.265 539.87 549.198 539.737 559.731 537.07C584.665 530.803 606.131 515.737 615.065 498.27C616.398 495.737 619.198 491.203 621.198 488.27C623.465 485.203 626.265 478.27 627.865 471.603C630.265 462.137 630.665 457.87 629.998 445.603C629.198 428.803 626.131 418.003 618.665 405.737C613.198 396.537 595.065 378.27 586.798 373.337C583.598 371.47 581.065 369.337 581.065 368.403C581.065 367.603 585.598 363.07 591.198 358.27C599.465 351.203 602.531 347.47 608.398 336.937C616.531 322.27 618.798 313.87 618.665 296.27C618.398 270.537 607.198 250.137 584.665 234.537C563.998 220.27 556.265 218.403 511.731 216.937C492.265 216.27 474.931 215.337 473.065 214.937L469.731 214.137V370.537ZM523.065 240.937C539.198 241.87 548.398 242.937 554.531 244.803C570.665 249.87 585.998 264.003 591.598 278.937C595.465 289.07 597.465 302.803 596.531 310.537C595.465 318.003 588.665 334.27 586.531 334.27C585.865 334.27 584.131 336.137 582.798 338.403C579.998 343.203 569.598 351.203 559.998 356.137C552.265 360.003 548.265 360.27 511.731 358.67L491.065 357.87L490.665 298.803L490.265 239.603H495.331C498.131 239.603 510.665 240.27 523.065 240.937ZM555.465 384.67C560.531 386.003 568.131 389.07 572.398 391.603C583.331 398.137 595.865 410.803 600.265 419.737C608.531 436.937 609.865 464.803 602.798 479.07C597.598 489.603 585.731 503.337 575.998 509.87C562.931 518.67 553.731 520.137 519.865 518.937C504.798 518.403 492.131 517.603 491.731 517.203C491.331 516.67 491.198 485.737 491.465 448.403L491.998 380.537L519.065 381.47C537.998 382.003 548.931 383.07 555.465 384.67Z" fill="black"/>
<path d="M129.598 257.87C129.998 272.403 130.398 340.803 130.398 409.87V535.603H134.265C136.265 535.603 140.798 536.003 144.265 536.403L150.398 537.336V389.736V242.136L144.132 239.336C140.532 237.87 136.132 235.47 134.132 234.136C132.265 232.67 130.265 231.603 129.598 231.603C129.065 231.603 129.065 243.47 129.598 257.87Z" fill="black"/>
<path d="M296.931 240.137C295.198 242.003 291.065 244.27 287.731 245.337L281.731 247.337V392.137V536.937H291.731H301.731V387.737C301.731 305.603 301.465 238.137 300.931 237.737C300.531 237.337 298.798 238.403 296.931 240.137Z" fill="black"/>
<path d="M169.065 392.803C169.065 470.67 168.798 534.803 168.531 535.47C168.131 536.003 172.398 536.403 177.865 536.403L187.731 536.27L187.465 397.203L187.065 258.003L180.398 255.603C176.798 254.27 172.665 252.803 171.465 252.27C169.198 251.336 169.065 258.67 169.065 392.803Z" fill="black"/>
<path d="M257.732 254.936C255.598 256.003 251.465 257.203 248.532 257.603L243.465 258.403L244.265 293.336C244.665 312.536 244.665 375.07 244.132 432.27L243.065 536.403H252.798H262.398V394.67C262.398 316.67 262.265 252.936 262.132 253.07C261.865 253.07 259.998 253.87 257.732 254.936Z" fill="black"/>
<path d="M206.531 396.537L207.065 535.337L212.931 536.137C216.131 536.537 220.131 536.937 221.865 536.937H225.065V398.27V259.603H221.865C220.131 259.603 215.865 259.203 212.398 258.67L206.131 257.87L206.531 396.537Z" fill="black"/>
<path d="M163.172 591.737C146.842 594.446 136.382 606.035 136.382 621.386C136.458 636.286 144.66 648.1 158.055 652.465C167.837 655.7 176.19 655.249 184.317 651.11C186.725 649.906 189.133 648.853 189.66 648.853C190.262 648.853 190.789 647.197 191.165 644.563C191.466 642.23 191.842 639.898 192.068 639.296C192.896 637.189 190.488 638.468 187.929 641.403C184.016 645.993 178.974 648.1 171.826 648.1C167.762 648.1 165.053 647.648 162.645 646.595C157.528 644.413 152.185 639.07 149.702 633.577C147.745 629.287 147.519 628.158 147.519 620.182V611.453L150.605 607.013C154.819 600.918 159.71 598.434 168.364 597.908C178.448 597.306 183.414 599.789 189.735 608.668L191.316 610.851L190.714 606.712C190.413 604.454 190.112 600.692 190.112 598.359L190.036 594.07L187.252 593.693C185.672 593.543 182.06 592.79 179.125 592.113C173.406 590.834 169.267 590.759 163.172 591.737Z" fill="black"/>
<path d="M451.233 595.274C447.47 604.078 437.688 626.052 435.505 630.492C434.226 632.975 432.27 637.716 431.141 640.951C430.012 644.187 427.905 648.552 426.626 650.508L424.143 654.12H432.796C437.537 654.12 441.375 653.819 441.375 653.443C441.375 653.067 440.171 652.089 438.666 651.186C435.731 649.455 435.731 649.455 438.591 641.93L440.171 637.716L447.094 637.189C450.857 636.888 455.748 636.888 457.93 637.189L461.843 637.716L464.026 642.532C466.81 648.627 466.81 650.132 463.95 651.712C462.746 652.39 461.693 653.142 461.693 653.368C461.693 653.744 477.496 653.819 480.807 653.518C482.011 653.368 481.86 652.992 479.828 650.734C478.549 649.229 476.517 646.068 475.313 643.736C473.282 639.597 464.703 618.527 464.703 617.473C464.703 616.796 454.093 592.113 453.491 591.511C453.265 591.21 452.211 592.941 451.233 595.274ZM458.006 624.923L460.113 630.04H452.211C444.987 630.04 444.31 629.89 444.686 628.685C444.837 628.008 445.288 626.578 445.514 625.525C445.815 624.471 447.245 620.859 448.75 617.398L451.383 611.152L453.641 615.517C454.845 617.925 456.802 622.139 458.006 624.923Z" fill="black"/>
<path d="M547.479 592.113C548.081 592.865 549.36 594.521 550.263 595.65C551.994 597.757 551.994 597.907 551.994 622.364V646.971L550.113 649.831C549.059 651.336 547.78 652.615 547.253 652.69C546.727 652.69 547.028 652.916 547.855 653.217C548.683 653.518 557.864 653.668 568.248 653.518L587.137 653.292L587.663 648.25C587.889 645.466 588.341 642.305 588.566 641.101C589.319 637.715 587.137 638.618 584.578 642.682C582.471 646.068 582.019 646.369 578.708 646.821C573.516 647.573 563.432 647.498 562.981 646.67C562.755 646.369 562.454 641.628 562.304 636.135L562.003 626.277H569.152C575.924 626.277 576.526 626.427 578.483 628.309C579.611 629.362 580.74 630.19 580.891 629.964C581.417 629.362 581.869 617.247 581.342 617.247C581.041 617.247 580.364 617.774 579.837 618.376C579.085 619.279 577.053 619.504 570.506 619.504H562.153L561.927 609.345L561.626 599.187H571.861H582.17L583.675 601.82C585.481 604.83 587.814 605.508 587.061 602.723C586.836 601.82 586.61 598.886 586.61 596.177V591.285L574.795 591.887C563.432 592.414 551.091 592.113 547.855 591.135C546.501 590.758 546.426 590.834 547.479 592.113Z" fill="black"/>
<path d="M221.642 593.016C212.311 595.65 207.194 599.488 203.13 606.637C194.326 622.439 200.647 643.66 216.525 651.411C224.351 655.249 235.638 655.475 242.637 651.863C250.99 647.649 258.364 639.145 261.224 630.567C263.18 624.622 262.428 615.667 259.418 609.496C256.182 603.025 249.033 596.177 243.013 593.919C236.842 591.662 227.888 591.285 221.642 593.016ZM239.702 600.692C244.368 603.1 247.603 606.336 249.56 610.625C251.14 614.087 251.366 615.742 251.366 623.267C251.366 631.169 251.215 632.297 249.259 636.436C246.625 642.005 244.819 643.961 240.304 646.294C236.165 648.401 228.64 648.777 224.577 647.046C214.794 642.908 209.526 634.028 209.526 621.386C209.451 614.914 211.257 608.593 214.192 604.906C215.697 602.949 220.061 600.316 223.899 599.112C226.985 598.058 236.391 599.036 239.702 600.692Z" fill="black"/>
<path d="M271.308 592.49C271.308 592.715 271.985 593.543 272.737 594.22C274.092 595.5 274.242 596.929 274.468 617.849C274.694 643.058 274.769 643.435 281.015 649.078C285.982 653.518 295.689 655.4 303.214 653.292C307.202 652.164 313.072 646.445 315.932 640.951L318.264 636.436L318.716 616.495C319.092 597.155 319.167 596.478 320.823 594.07L322.554 591.662H315.029C307.654 591.662 305.923 592.264 308.783 593.844C309.911 594.521 310.062 596.553 310.288 616.419C310.513 637.565 310.513 638.468 308.933 641.704C305.998 647.874 298.925 649.906 292.378 646.595C285.154 642.908 283.799 636.587 284.552 611.001C285.003 596.102 285.154 594.521 286.433 593.844C289.142 592.414 287.788 592.038 279.585 592.038C274.995 592.038 271.308 592.264 271.308 592.49Z" fill="black"/>
<path d="M333.766 594.371C335.196 596.629 335.271 598.209 335.271 623.117C335.271 649.304 335.271 649.53 333.615 651.11C332.712 651.938 331.734 652.615 331.358 652.615C331.057 652.615 330.756 652.916 330.756 653.368C330.756 653.819 334.293 654.12 339.786 654.12C344.753 654.12 348.816 653.895 348.816 653.594C348.816 653.293 348.139 652.314 347.311 651.487C345.355 649.455 344.602 642.005 345.43 633.502L345.957 627.707L349.343 627.933C352.654 628.159 352.804 628.309 355.664 633.05C363.565 646.52 367.93 653.293 368.908 653.669C369.51 653.97 372.37 654.12 375.305 654.12H380.572L379.142 652.39C367.93 638.092 361.082 627.707 361.985 626.277C362.286 625.826 362.888 625.525 363.415 625.525C365.522 625.525 370.639 620.032 372.972 615.291C375.305 610.625 375.38 610.249 374.477 606.486C373.348 601.219 370.639 597.456 366.35 594.898C362.587 592.715 363.34 592.791 341.141 592.189L332.336 591.963L333.766 594.371ZM360.932 602.122C363.565 604.68 363.866 605.433 363.866 608.669C363.866 617.247 361.233 620.859 354.61 621.537C352.353 621.762 349.268 621.762 347.763 621.461L345.054 620.935V614.012C345.054 610.174 345.279 605.282 345.505 603.1L346.032 599.187H352.052C357.997 599.187 358.072 599.187 360.932 602.122Z" fill="black"/>
<path d="M386.442 597.005C386.442 599.789 386.216 603.1 385.99 604.379C385.313 607.841 387.57 607.465 389.377 603.777C391.183 600.316 392.01 599.939 397.805 599.939H402.244V624.772C402.244 643.66 402.019 649.756 401.341 650.358C400.815 650.809 399.686 651.637 398.858 652.239C398.03 652.766 397.504 653.443 397.729 653.669C398.03 653.97 413.457 654.346 416.843 654.195C417.219 654.12 416.843 653.368 415.94 652.389C413.005 649.229 412.78 647.272 412.78 623.192V599.939H419.176H425.572L426.626 602.573C428.056 606.035 429.335 605.96 429.335 602.347C429.335 600.842 429.561 597.832 429.786 595.801L430.238 592.038H408.34H386.442V597.005Z" fill="black"/>
<path d="M505.339 592.414C497.813 594.22 489.235 599.639 485.623 604.906C479.302 613.936 479.828 630.266 486.676 641.102C492.32 649.982 501.124 654.12 514.218 654.12C521.367 654.045 525.355 653.217 531.827 650.207L536.869 647.95L537.094 637.189C537.32 627.933 537.546 626.202 538.75 624.848L540.105 623.343L527.237 623.117L514.369 622.891V624.923C514.369 627.03 514.444 627.03 519.109 627.03C525.732 627.03 526.484 627.707 527.237 635.007C528.29 645.165 528.29 645.015 524.753 646.595C520.389 648.552 510.681 648.627 506.467 646.671C498.942 643.284 492.546 631.545 491.944 620.107C491.643 614.388 491.793 613.109 493.298 610.324C497.512 602.047 504.21 598.209 514.369 598.134C523.023 598.134 527.237 600.09 530.623 605.809L533.031 609.722L533.407 604.304C533.633 601.294 534.084 597.908 534.31 596.704C534.762 594.898 534.611 594.672 533.106 594.672C532.128 594.672 528.591 593.995 525.28 593.167C519.034 591.662 510.155 591.286 505.339 592.414Z" fill="black"/>
<path d="M0 625.497V629.837L40.1914 629.527C62.3019 629.32 80.5895 629.01 80.8995 628.7C81.1061 628.39 81.6227 626.944 82.036 625.291L82.6559 622.501H49.2836C30.8926 622.501 12.2951 622.191 7.95563 621.881L0 621.158V625.497Z" fill="black"/>
<path d="M96.0875 625.601V629.734H107.453H118.818V625.601V621.468H107.453H96.0875V625.601Z" fill="black"/>
<path d="M606.746 625.549V629.166H621.211H635.676V625.549V621.933H621.211H606.746V625.549Z" fill="black"/>
<path d="M653.24 624.619C652.62 626.066 652.207 627.719 652.207 628.235C652.207 628.752 667.188 629.165 689.919 629.165C710.686 629.165 727.94 629.165 728.457 629.165C728.87 629.165 729.283 627.615 729.49 625.549L729.8 621.933H691.985H654.273L653.24 624.619Z" fill="black"/>
</svg>

================
File: public/assets/svgs/logo.svg
================
<svg width="1173" height="1047" viewBox="0 0 1173 1047" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M328.966 1.4158C270.708 8.0853 221.772 37.5757 191.156 84.4228C186.014 92.2976 177.657 108.77 173.8 118.574C162.068 148.386 157.97 185.751 162.55 220.786C170.746 283.865 207.469 336.578 261.789 363.175C280.27 372.256 298.511 378.041 318.761 381.255C331.859 383.345 373.242 383.345 387.866 381.255C409.321 378.202 427.642 373.782 445.642 367.354C456.57 363.416 474.168 355.22 481.882 350.56L486.703 347.667V265.303V183.019H425.633H364.563V199.492V215.964H406.75H448.936L448.776 271.57L448.534 327.176L442.106 330.631C419.285 342.846 385.777 350.158 352.269 350.158C318.68 350.158 292.163 342.283 265.244 324.364C255.119 317.614 238.887 301.945 231.816 292.302C215.504 269.883 205.219 243.526 201.362 214.357C199.915 203.268 200.076 179.001 201.763 167.35C209.477 113.351 239.53 70.2803 284.61 48.4236C301.806 40.0667 317.555 35.9686 339.091 34.2811C359.26 32.674 382.723 35.2454 400.723 40.9506C417.758 46.4148 437.204 57.6645 449.579 69.316C453.115 72.6106 456.329 75.3427 456.731 75.3427C457.695 75.3427 481.882 50.995 481.882 49.9504C481.882 49.4683 479.552 47.0576 476.659 44.5666C450.865 21.7457 421.857 8.40671 386.018 2.94254C373.965 1.09436 339.894 0.210449 328.966 1.4158Z" fill="white"/>
<path d="M516.997 2.78204C516.676 3.02313 516.435 195.233 516.435 429.871V856.396H528.89H541.345V429.308V2.21954H529.452C522.863 2.21954 517.238 2.46063 516.997 2.78204Z" fill="white"/>
<path d="M575.496 3.18451C575.255 3.74701 575.175 195.877 575.255 430.112L575.496 855.995L587.79 856.236L600.004 856.478V429.309V2.22028H587.951C579.032 2.22028 575.737 2.4613 575.496 3.18451Z" fill="white"/>
<path d="M634.557 429.309V856.478L646.851 856.236L659.065 855.995V429.309V2.62201L646.851 2.38098L634.557 2.13989V429.309Z" fill="white"/>
<path d="M695.386 2.78204C695.065 3.02313 694.823 195.233 694.823 429.871V856.396H707.279H719.734V429.308V2.21954H707.841C701.252 2.21954 695.627 2.46063 695.386 2.78204Z" fill="white"/>
<path d="M755.09 228.822V261.768H759.51H763.929L764.01 234.607V207.528L774.697 234.447L785.384 261.366H788.518H791.571L802.098 234.849L812.544 208.412L812.785 235.09L812.946 261.768H817.767H822.589L822.428 228.983L822.187 196.278H815.116H807.964L798.643 220.545C793.5 233.965 789.08 244.893 788.839 244.893C788.518 244.893 784.179 234.286 779.197 221.349C774.215 208.492 769.715 197.403 769.313 196.84C768.831 196.198 766.259 195.876 761.84 195.876H755.09V228.822Z" fill="white"/>
<path d="M837.856 228.903V261.929L852.561 261.607C869.275 261.206 873.935 260 879.078 254.857C882.775 251.161 883.9 247.625 883.498 241.277C883.096 234.929 880.444 231.072 874.578 228.501L870.561 226.733L873.132 225.608C883.658 221.269 883.417 204.394 872.73 198.85C868.793 196.841 861.4 195.877 849.347 195.877H837.856V228.903ZM866.462 205.76C869.837 207.528 870.882 208.975 871.364 212.591C871.927 216.528 869.998 220.305 866.623 222.072C865.016 222.956 861.159 223.519 855.775 223.84L847.499 224.242V213.957V203.671L855.775 204.073C860.918 204.394 865.016 205.037 866.462 205.76ZM868.953 233.563C872.971 235.411 874.337 237.661 874.337 242.643C874.337 245.617 873.855 246.983 872.328 248.59C868.873 252.286 866.221 253.17 856.579 253.572L847.499 253.974V242.965V232.037H856.579C863.65 232.037 866.302 232.358 868.953 233.563Z" fill="white"/>
<path d="M753.885 353.533C753.644 354.096 753.563 467.397 753.644 605.286L753.885 855.995H824.196C901.096 855.995 898.685 856.075 918.613 851.093C952.603 842.495 979.201 821.121 994.951 789.702C1005.4 768.97 1009.58 746.39 1008.77 715.534C1008.29 696.249 1006.52 684.758 1001.78 670.615C995.272 651.169 986.594 636.384 974.139 623.849C965.621 615.17 957.826 609.465 947.139 604.081C936.854 598.938 930.666 596.849 915.158 593.153C908.006 591.465 902.381 589.858 902.703 589.537C903.104 589.296 908.086 588.09 913.792 586.885C922.55 585.117 925.765 583.992 933.881 579.975C959.434 567.278 976.63 547.029 986.111 518.503C994.709 492.95 994.629 453.093 986.031 427.46C980.888 411.952 972.451 398.532 960.478 386.64C942.8 369.122 923.033 360.042 890.489 354.497C883.498 353.292 874.016 353.051 818.33 352.81C766.018 352.569 754.206 352.649 753.885 353.533ZM882.051 389.05C902.622 393.068 916.042 399.496 928.095 411.148C944.97 427.38 953.568 450.924 953.568 480.896C953.568 510.065 944.97 532.967 927.131 551.288C916.363 562.457 903.345 569.769 886.471 574.189L878.435 576.278L835.686 576.6L792.857 576.841V481.941V386.961L834.079 387.363C867.989 387.684 876.426 387.925 882.051 389.05ZM893.301 611.876C913.631 617.259 927.452 625.134 940.791 639.036C947.139 645.625 951.559 652.294 956.942 663.223C964.657 679.133 968.032 695.767 968.032 718.186C968.032 749.846 959.514 774.917 942.8 792.675C928.898 807.38 913.551 815.496 890.89 819.916C885.185 821.04 876.828 821.282 838.499 821.603L792.857 821.924V715.373V608.822L838.499 609.063L884.06 609.385L893.301 611.876Z" fill="white"/>
<path d="M210.281 607.697V856.396H222.736H235.191V616.295V376.273L228.12 371.693C224.263 369.122 218.799 365.265 216.067 363.015C213.334 360.845 210.924 358.997 210.683 358.997C210.442 358.997 210.281 470.932 210.281 607.697Z" fill="white"/>
<path d="M473.846 381.898C472.721 382.461 467.579 384.711 462.436 386.8L452.954 390.657V623.527V856.396H465.409H477.864V618.545C477.864 428.745 477.623 380.693 476.9 380.693C476.337 380.773 474.971 381.255 473.846 381.898Z" fill="white"/>
<path d="M271.351 625.295V856.396H283.806H296.261V628.991C296.261 447.709 296.02 401.505 295.297 401.264C292.243 400.3 273.922 394.916 272.797 394.595C271.431 394.193 271.351 405.523 271.351 625.295Z" fill="white"/>
<path d="M405.544 402.872C400 403.836 395.018 404.72 394.536 404.72C393.732 404.8 393.491 450.523 393.491 630.599V856.478L405.785 856.236L417.999 855.995L418.241 628.349C418.401 411.952 418.321 400.783 417.035 400.863C416.232 400.943 411.089 401.827 405.544 402.872Z" fill="white"/>
<path d="M333.225 631.804V856.478L345.519 856.236L357.733 855.995V631.804V407.613L345.519 407.372L333.225 407.131V631.804Z" fill="white"/>
<path d="M66.0432 891.753C58.1684 892.878 51.1775 894.887 44.1866 898.181C35.8296 902.119 31.2494 905.253 24.3388 911.761C8.58915 926.949 0.553619 946.877 0.553619 971.224C0.553619 988.26 4.57139 1002.64 12.7676 1015.1C26.187 1035.59 46.1151 1045.95 71.8288 1046.04C86.5338 1046.04 98.7478 1042.82 108.712 1036.31C115.221 1032.13 124.703 1022.25 129.845 1014.38L133.943 1008.03L132.256 1006.82C130.569 1005.7 130.327 1005.78 127.997 1008.75C114.739 1025.38 106.542 1031.65 93.7658 1034.87C87.5784 1036.47 72.2306 1036.23 65.6414 1034.54C48.0436 1029.96 34.4636 1016.54 29.1601 998.626C27.0709 991.715 25.4638 979.662 25.4638 970.903C25.4638 938.439 35.8296 914.654 54.0703 905.172C57.2041 903.565 61.8647 901.717 64.5165 900.994C70.7038 899.387 84.4446 899.387 90.873 901.074C106.141 905.012 117.953 917.065 124.703 935.707C126.551 940.77 127.113 941.573 128.801 941.573C130.408 941.573 130.649 941.252 130.327 939.323C130.167 938.118 129.363 927.591 128.72 915.86C127.194 890.869 127.194 890.949 125.024 890.949C123.899 890.949 123.015 891.994 121.971 894.405C119.962 898.985 116.667 901.637 113.453 901.155C112.167 900.994 108.149 899.467 104.533 897.86C92.3194 892.396 77.6947 890.065 66.0432 891.753Z" fill="white"/>
<path d="M212.531 891.833C204.415 892.958 192.924 896.896 185.853 901.074C178.058 905.654 166.809 916.261 161.666 924.056C153.63 936.029 150.014 947.921 149.452 964.876C148.568 990.349 155.318 1009.31 170.907 1025.14C184.969 1039.45 200.879 1046.04 221.129 1046.04C241.057 1046.04 256.967 1039.53 271.03 1025.54C274.565 1022.01 279.065 1016.87 280.913 1014.05C298.19 988.42 298.752 950.171 282.199 924.618C272.235 909.27 256.485 897.619 239.691 893.36C232.138 891.432 220.084 890.708 212.531 891.833ZM233.182 900.994C256.244 907.02 268.94 931.77 268.94 970.662C268.94 996.295 263.717 1013.41 252.467 1024.82C243.628 1033.82 233.745 1038 221.129 1038C209.076 1038 201.281 1034.79 192.924 1026.35C182.398 1015.74 176.612 1000.31 174.844 978.537C171.71 937.877 185.13 907.663 209.397 900.913C214.62 899.467 227.477 899.547 233.182 900.994Z" fill="white"/>
<path d="M796.312 891.914C795.91 892.476 783.134 921.887 768.108 957.243C753.001 992.599 739.34 1023.7 737.733 1026.35C732.751 1034.63 731.546 1035.51 720.778 1038.48C720.216 1038.64 719.734 1039.69 719.734 1040.81V1042.82H743.438H767.143V1040.81C767.143 1038.72 766.661 1038.48 759.911 1037.6C755.331 1037.04 751.313 1034.63 750.269 1031.89C748.983 1028.6 750.028 1024.98 756.938 1008.43L763.447 993.001L791.973 993.162L820.419 993.403L825.963 1006.5C833.035 1023.29 834.561 1028.76 833.035 1032.38C831.829 1035.19 827.088 1037.92 823.231 1038C819.856 1038 818.571 1038.8 818.571 1040.89V1042.82H847.981H877.31L877.069 1040.65C876.828 1038.64 876.426 1038.32 872.971 1037.84C867.909 1037.12 862.766 1033.98 860.195 1030.21C856.177 1024.18 853.365 1017.75 827.008 954.832C804.91 902.119 800.169 891.271 798.803 891.11C797.839 890.95 796.794 891.352 796.312 891.914ZM805.232 956.279C811.66 971.707 816.964 984.403 816.964 984.644C816.964 984.805 805.794 984.965 792.053 984.965C778.393 984.965 767.143 984.805 767.143 984.644C767.143 984.483 772.447 972.109 778.875 957.163C785.304 942.136 790.928 929.038 791.411 927.913C792.053 926.306 792.294 926.145 792.857 927.11C793.178 927.752 798.803 940.931 805.232 956.279Z" fill="white"/>
<path d="M957.585 891.512C951.639 892.155 941.916 894.324 936.773 896.253C919.818 902.601 904.31 917.868 895.23 937.073C889.203 949.85 888.158 954.993 888.158 971.305C888.158 984.322 888.319 985.929 890.408 992.599C896.194 1011.56 908.89 1027.39 925.443 1036.31C937.898 1042.98 951.8 1046.04 969.719 1046.04C986.835 1046.04 999.692 1043.3 1013.99 1036.63L1021.79 1032.94L1022.03 1003.53C1022.27 976.689 1022.43 973.876 1023.72 971.867C1025.97 968.492 1029.74 966.483 1034.16 966.483C1037.86 966.483 1037.94 966.403 1037.94 964.073V961.662L1009.25 961.823L980.487 962.064V964.073C980.487 966.001 980.808 966.082 985.951 966.644C992.54 967.287 995.835 969.055 998.085 973.314C999.692 976.367 999.772 977.653 999.772 1003.45V1030.37L994.71 1032.86C982.897 1038.72 966.505 1040.01 954.773 1035.99C942.479 1031.89 933.157 1024.74 926.167 1014.13C902.542 977.974 911.622 920.359 943.523 904.69C951.639 900.672 957.585 899.467 968.433 899.467C976.71 899.547 978.96 899.869 984.344 901.717C999.37 906.779 1008.29 916.502 1016.16 936.189C1016.81 937.877 1017.53 938.439 1018.9 938.198C1020.99 937.877 1020.99 940.609 1018.66 911.842C1017.77 900.994 1017.05 891.833 1017.05 891.512C1017.05 891.11 1016.08 890.949 1014.88 891.11C1013.19 891.271 1012.55 891.833 1012.39 893.36C1011.99 897.056 1010.46 899.788 1008.61 900.271C1007.49 900.512 1001.94 899.146 994.388 896.655C979.121 891.673 969.317 890.307 957.585 891.512Z" fill="white"/>
<path d="M304.056 894.726C303.734 894.967 303.493 896.092 303.493 897.137C303.493 898.904 303.815 898.985 308.957 898.985C316.35 899.065 320.529 900.994 322.939 905.574L324.787 909.029L325.269 955.233C325.591 985.367 326.073 1003.21 326.716 1006.58C328.885 1018.31 332.662 1025.38 340.858 1033.1C347.367 1039.12 354.117 1042.42 364.242 1044.51C375.411 1046.84 396.625 1046.36 405.143 1043.62C413.982 1040.81 419.928 1037.28 426.035 1031.17C439.294 1017.99 440.901 1009.23 440.901 948.082C440.981 909.592 441.142 907.583 444.678 903.645C447.088 900.913 452.151 898.985 457.213 898.985C461.793 898.985 461.793 898.985 461.793 896.574V894.163L435.517 894.324L409.16 894.565L408.919 896.654C408.678 898.744 408.759 898.744 415.026 899.145C422.74 899.547 426.196 901.315 428.446 905.815C429.972 908.949 430.053 910.636 430.053 954.028C430.053 994.608 429.892 999.67 428.606 1005.86C427.803 1009.63 426.196 1014.37 425.071 1016.54C420.973 1023.94 411.25 1031.17 400.803 1034.54C395.5 1036.23 380.956 1036.79 374.849 1035.67C364.161 1033.58 354.358 1025.71 350.903 1016.54C347.287 1006.82 346.805 999.349 347.046 952.18C347.287 909.752 347.367 908.145 348.894 905.413C351.224 901.395 356.367 898.985 362.715 898.985H367.777V896.574V894.163H336.198C318.761 894.163 304.297 894.404 304.056 894.726Z" fill="white"/>
<path d="M467.981 894.726C467.659 894.968 467.418 896.012 467.418 896.976C467.418 898.664 467.9 898.825 473.766 899.146C481.4 899.548 484.855 901.316 487.105 905.815C488.632 908.949 488.712 910.878 488.953 963.671C489.114 993.724 488.953 1020.96 488.712 1024.1C487.828 1034.06 484.052 1037.6 473.605 1038.48C467.82 1039.04 467.418 1039.12 467.418 1040.89V1042.82H499.56H531.702V1040.89C531.702 1039.12 531.301 1039.04 525.515 1038.48C515.631 1037.68 512.015 1034.63 510.81 1025.87C510.408 1023.05 510.006 1010.12 510.006 997.179V973.716H517.881L525.676 973.796L550.586 1008.27L575.496 1042.82H595.344H615.272V1040.81C615.272 1038.56 615.352 1038.56 608.442 1037.28C600.486 1035.83 594.54 1032.38 587.871 1025.38C583.13 1020.4 548.818 974.037 547.934 971.466C547.854 971.144 550.345 970.019 553.559 968.975C556.773 967.93 561.595 966.002 564.246 964.555C585.701 953.305 589.96 924.699 572.764 907.824C563.764 898.985 555.246 896.253 532.908 894.968C517.479 894.084 468.784 893.843 467.981 894.726ZM540.14 905.494C546.006 907.664 552.675 913.851 555.568 919.717C557.657 923.976 557.818 925.02 557.818 933.94C557.818 942.94 557.657 943.824 555.568 947.841C549.3 959.734 538.291 965.359 519.89 966.243L510.006 966.725V936.109V905.414L511.855 905.012C521.337 902.682 533.309 902.923 540.14 905.494Z" fill="white"/>
<path d="M607.718 901.958C607.477 906.298 606.995 914.253 606.754 919.717L606.192 929.681L608.522 929.36C610.611 929.119 610.852 928.797 611.415 925.181C612.54 917.306 616.557 910.637 622.343 907.262C626.039 905.012 626.361 905.012 641.628 904.771L657.056 904.449L656.896 967.609C656.655 1030.29 656.655 1030.69 654.967 1032.94C652.315 1036.47 649.021 1037.92 642.351 1038.48C636.566 1039.04 636.164 1039.12 636.164 1040.89V1042.82H667.904H699.645V1040.89C699.645 1039.12 699.243 1038.96 693.859 1038.48C686.466 1037.84 682.85 1035.99 680.761 1031.89C679.235 1028.84 679.154 1026.91 678.913 966.644L678.672 904.61H693.056C709.207 904.61 712.662 905.333 717.805 909.753C721.662 913.047 724.314 918.271 725.519 924.699C726.403 929.199 726.564 929.52 728.653 929.52H730.903L730.421 920.038C730.18 914.896 729.778 907.021 729.457 902.601L728.974 894.566L668.628 894.325L608.281 894.164L607.718 901.958Z" fill="white"/>
<path d="M1045.74 894.726C1045.41 894.968 1045.17 896.092 1045.17 897.137C1045.17 898.905 1045.49 898.985 1050.07 898.985C1061 898.985 1064.86 901.878 1066.07 911.119C1067.03 918.592 1067.11 1018.71 1066.15 1026.19C1065.66 1029.56 1064.86 1032.29 1063.9 1033.34C1061.4 1036.15 1056.74 1037.92 1050.88 1038.48C1045.57 1038.96 1045.17 1039.21 1045.17 1040.89V1042.82H1102.47H1159.76L1165.95 1024.82C1169.32 1014.94 1172.13 1006.42 1172.13 1005.94C1172.13 1005.46 1171.25 1005.05 1170.29 1005.05C1168.76 1005.05 1167.55 1006.5 1164.02 1012.45C1158.96 1021.05 1151.64 1028.92 1146.34 1031.49C1143.53 1032.78 1139.91 1033.5 1132.68 1034.06C1119.98 1035.19 1094.43 1034.71 1092.02 1033.34C1088.24 1031.25 1088.16 1030.45 1087.92 999.188L1087.68 969.698H1107.61C1128.82 969.698 1132.2 970.18 1136.7 973.475C1139.83 975.885 1141.2 978.778 1142.4 986.01C1143.37 991.233 1143.45 991.394 1145.7 991.394H1148.03V965.68V939.966H1145.7C1143.53 939.966 1143.37 940.208 1142.88 944.145C1142 950.814 1138.87 956.52 1134.93 958.689C1131.72 960.377 1130.51 960.457 1109.7 960.698L1087.76 960.939V932.011V903.003H1111.79C1124.97 903.003 1137.66 903.405 1140.07 903.807C1149.39 905.574 1153.17 910.476 1156.38 924.86C1156.79 926.708 1157.35 927.11 1159.28 927.11H1161.61L1161.21 920.038C1160.96 916.181 1160.48 908.869 1160.24 903.807L1159.68 894.566L1102.95 894.325C1071.77 894.244 1045.98 894.405 1045.74 894.726Z" fill="white"/>
</svg>

================
File: public/favicon.svg
================
<svg width="32" height="32" viewBox="0 0 567 538" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M98.3982 2.4032C84.9315 5.2032 70.5315 11.3365 60.1315 18.4032C47.9982 26.6699 29.3315 43.7365 23.8649 51.4699C17.7315 60.2699 9.06486 77.2032 5.86486 86.6699C-4.26847 116.937 -1.20181 151.737 14.5315 182.803C25.0649 203.603 45.0649 220.937 71.8649 232.27C90.3982 240.27 96.7982 241.47 119.065 241.337C149.732 241.203 171.998 235.737 193.732 222.803L202.265 217.603L202.665 170.537L203.065 123.603H162.265H121.465V136.27L121.332 149.07L149.465 148.937L177.732 148.67L178.132 177.337L178.398 205.87L168.132 209.87C152.132 216.27 143.865 217.47 120.398 217.603C100.398 217.603 98.2649 217.337 87.1982 213.737C73.7315 209.337 58.7982 199.603 48.6649 188.537C39.7315 178.937 28.5315 156.27 26.3982 143.47C24.2649 131.337 25.3315 107.87 28.3982 94.9365C31.7315 80.9365 41.4649 63.0699 51.0649 53.4699C70.7982 33.7365 91.9982 24.5365 122.398 22.6699C141.198 21.6032 156.398 24.6699 174.798 33.2032L189.598 40.0032L195.332 33.7365C204.532 23.6032 203.865 22.4032 184.798 12.9365C164.798 3.06985 155.598 0.936523 130.398 0.13652C114.398 -0.263474 108.932 0.13652 98.3982 2.4032Z" fill="#1329A7"/>
  <path d="M29.5982 257.87C29.9982 272.403 30.3982 340.803 30.3982 409.87V535.603H34.2649C36.2649 535.603 40.7982 536.003 44.2649 536.403L50.3982 537.336V389.736V242.136L44.1316 239.336C40.5316 237.87 36.1316 235.47 34.1316 234.136C32.2649 232.669 30.2649 231.603 29.5982 231.603C29.0649 231.603 29.0649 243.47 29.5982 257.87Z" fill="#1329A7"/>
  <path d="M196.931 240.136C195.198 242.003 191.065 244.27 187.731 245.336L181.731 247.336V392.136V536.936H191.731H201.731V387.736C201.731 305.603 201.465 238.136 200.931 237.736C200.531 237.336 198.798 238.403 196.931 240.136Z" fill="#1329A7"/>
  <path d="M69.0647 392.803C69.0647 470.669 68.798 534.803 68.5314 535.469C68.1314 536.003 72.398 536.403 77.8647 536.403L87.7314 536.269L87.4647 397.203L87.0647 258.003L80.398 255.603C76.798 254.269 72.6647 252.803 71.4647 252.269C69.198 251.336 69.0647 258.669 69.0647 392.803Z" fill="#1329A7"/>
  <path d="M157.732 254.936C155.598 256.003 151.465 257.203 148.532 257.603L143.465 258.403L144.265 293.336C144.665 312.536 144.665 375.069 144.132 432.269L143.065 536.403H152.798H162.398V394.669C162.398 316.669 162.265 252.936 162.132 253.069C161.865 253.069 159.998 253.869 157.732 254.936Z" fill="#1329A7"/>
  <path d="M106.531 396.536L107.065 535.336L112.931 536.136C116.131 536.536 120.131 536.936 121.865 536.936H125.065V398.27V259.603H121.865C120.131 259.603 115.865 259.203 112.398 258.67L106.131 257.87L106.531 396.536Z" fill="#1329A7"/>
  <path d="M239.355 45.9633C239.622 70.1117 239.622 190.453 239.355 313.463L239.088 537.336H229.754H220.419L220.286 477.566C220.019 395.114 220.019 204.062 220.153 93.9933L220.419 2.33618L229.754 16.5117L239.355 29.0195L239.355 45.9633Z" fill="#1329A7"/>
  <path d="M257.965 290.836C258.238 426.417 258.512 537.336 258.648 537.336C258.785 537.336 262.749 537.336 267.67 537.336H276.555V291.572V57.223L269.483 52.1617L262.612 47.5605L257.555 44.3362L257.965 290.836Z" fill="#1329A7"/>
  <path d="M313.36 116.684C313.62 137.357 313.62 240.379 313.36 345.684L313.1 537.336H304H294.9L294.77 486.168C294.51 415.584 294.51 252.028 294.64 157.801L294.9 79.3362H304H313.36V116.684Z" fill="#1329A7"/>
  <path d="M350.145 289.336C349.871 425.742 349.598 537.336 349.461 537.336C349.325 537.336 345.361 537.336 340.44 537.336H331.555V290.077V54.3014L338.627 49.2093L345.497 44.5801L350.555 41.3362L350.145 289.336Z" fill="#1329A7"/>
  <path d="M368.755 46.2695C368.488 70.4028 368.488 190.669 368.755 313.603L369.022 537.336H378.355H387.688L387.822 477.603C388.088 395.203 388.088 204.27 387.955 94.2695L387.688 2.66949L378.355 16.8362L368.755 29.3362L368.755 46.2695Z" fill="#1329A7"/>
  <path d="M406.208 368.332C406.208 454.332 405.808 526.865 405.408 529.665C404.608 534.198 404.875 534.598 408.741 535.265C411.008 535.798 429.141 536.465 449.008 536.998C482.741 537.665 485.675 537.532 496.208 534.865C521.141 528.598 542.608 513.532 551.541 496.065C552.875 493.532 555.675 488.998 557.675 486.065C559.941 482.998 562.741 476.065 564.341 469.398C566.741 459.932 567.141 455.665 566.475 443.398C565.675 426.598 562.608 415.798 555.141 403.532C549.675 394.332 531.541 376.065 523.275 371.132C520.075 369.265 517.541 367.132 517.541 366.198C517.541 365.398 522.075 360.865 527.675 356.065C535.941 348.998 539.008 345.265 544.875 334.732C553.008 320.065 555.275 311.665 555.141 294.065C554.875 268.332 543.675 247.932 521.141 232.332C500.475 218.065 492.741 216.198 448.208 214.732C428.741 214.065 411.408 213.132 409.541 212.732L406.208 211.932V368.332ZM459.541 238.732C475.675 239.665 484.875 240.732 491.008 242.598C507.141 247.665 522.475 261.798 528.075 276.732C531.941 286.865 533.941 300.598 533.008 308.332C531.941 315.798 525.141 332.065 523.008 332.065C522.341 332.065 520.608 333.932 519.275 336.198C516.475 340.998 506.075 348.998 496.475 353.932C488.741 357.798 484.741 358.065 448.208 356.465L427.541 355.665L427.141 296.598L426.741 237.398H431.808C434.608 237.398 447.141 238.065 459.541 238.732ZM491.941 382.465C497.008 383.798 504.608 386.865 508.875 389.398C519.808 395.932 532.341 408.598 536.741 417.532C545.008 434.732 546.341 462.598 539.275 476.865C534.075 487.398 522.208 501.132 512.475 507.665C499.408 516.465 490.208 517.932 456.341 516.732C441.275 516.198 428.608 515.398 428.208 514.998C427.808 514.465 427.675 483.532 427.941 446.198L428.475 378.332L455.541 379.265C474.475 379.798 485.408 380.865 491.941 382.465Z" fill="#1329A7"/>
</svg>

================
File: README-EXTRACTION.md
================
# 🚀 Service d'Extraction Intelligente - Guide de Démarrage

## 🎯 Installation Rapide

### 1. Configuration OpenRouter

1. Créez un compte sur [OpenRouter](https://openrouter.ai/)
2. Générez une clé API
3. Ajoutez-la à votre `.env` :

```bash
OPENROUTER_API_KEY=sk-or-v1-your-key-here
OPENROUTER_MODEL=openai/gpt-4o
```

### 2. Test de l'installation

```bash
npm run test:extraction
```

## 🔧 Utilisation

### Flux automatique

Le service s'active automatiquement lors de la création d'un dossier :

1. **Apporteur** upload les documents
2. **API** déclenche l'extraction automatiquement
3. **Données** sont sauvegardées dans `pret_data`
4. **Admin** voit le dossier pré-rempli

### Test manuel

```typescript
import { DocumentExtractionService } from "@/lib/services/document-extraction";

const result = await DocumentExtractionService.extractFromDossier("dossier-id");
console.log("Résultat:", result);
```

## 📊 Données extraites

### ✅ Données principales

- **Emprunteurs** : nom, prénom, date de naissance
- **Prêt** : montant, durée, taux, banque
- **Tableau d'amortissement** : échéances complètes

### 🧮 Calculs automatiques

- **Date de début effective** : demande + 3 mois
- **Durée restante** : calculée à partir de la date effective
- **Capital restant dû** : interpolation linéaire précise

## 🛡️ Gestion d'erreurs

### Statuts de dossier

- `en_attente` : Extraction réussie
- `en_attente_extraction_manuelle` : Extraction échouée

### Activités créées

- `extraction_automatique` : Succès
- `extraction_echouee` : Échec

## 🎨 Interface

### Composants disponibles

```tsx
import {
    ExtractedDataDisplay,
    ExtractionResult,
} from "@/components/ExtractionResult";

// Afficher le statut
<ExtractionResult extractionData={result} />;

// Afficher les données extraites
<ExtractedDataDisplay extractedData={data} />;
```

## 🔍 Débogage

### Logs utiles

```bash
[DocumentExtractionService] Début extraction pour dossier {id}
[DocumentExtractionService] Extraction réussie avec confidence {confidence}
```

### Vérifications

1. **Variables d'environnement** : `OPENROUTER_API_KEY` définie
2. **Documents** : Présents dans Supabase Storage
3. **Base de données** : Table `pret_data` mise à jour

## 🚀 Modèles recommandés

| Modèle                        | Usage      | Coût   | Performance |
| ----------------------------- | ---------- | ------ | ----------- |
| `openai/gpt-4o`               | Production | Élevé  | Excellent   |
| `anthropic/claude-3.5-sonnet` | Production | Moyen  | Très bon    |
| `openai/gpt-4o-mini`          | Tests      | Faible | Bon         |

## 📝 Exemples de documents

### Formats supportés

- **PDF** : Offres de prêt, tableaux d'amortissement
- **Images** : Documents scannés (JPEG, PNG)
- **Excel** : Tableaux d'amortissement

### Structure attendue

```
Document 1: offrePret.pdf
- Informations emprunteur
- Conditions du prêt
- Montant et durée

Document 2: tableauAmortissement.pdf
- Échéances détaillées
- Capital restant dû
- Intérêts et assurance
```

## 🆘 Résolution de problèmes

### Erreur : "OPENROUTER_API_KEY non configurée"

```bash
# Vérifiez votre .env
echo $OPENROUTER_API_KEY
```

### Erreur : "Aucun document pertinent trouvé"

- Vérifiez que les documents sont uploadés
- Vérifiez les types : `offrePret`, `tableauAmortissement`

### Erreur : "Impossible de parser la réponse JSON"

- Le modèle IA a retourné un format invalide
- Essayez un autre modèle ou ajustez le prompt

## 🔄 Mise à jour

### Ajouter un nouveau modèle

```bash
# Dans .env
OPENROUTER_MODEL=anthropic/claude-3.5-sonnet
```

## 🔄 Mise à jour

### Ajouter un nouveau modèle

```bash
# Dans .env
OPENROUTER_MODEL=anthropic/claude-3.5-sonnet
```

### Modifier le prompt

Le prompt système optimisé pour extraction ciblée :

```
Tu es un expert en analyse de documents bancaires français.

CONTEXTE : Tu vas recevoir un ou plusieurs fichiers de prêt et une date clé appelée "date_effective".

MISSION : Ta mission est double :
1. Analyse l'ensemble des documents pour extraire les informations générales sur les emprunteurs et le prêt.
2. Localise le tableau d'amortissement et extrais UNIQUEMENT les deux lignes qui encadrent la "date_effective" fournie.

FORMAT DE SORTIE JSON STRICT :
Tu dois retourner UNIQUEMENT un objet JSON valide, sans aucun texte explicatif avant ou après.
Retourne directement l'objet JSON suivant :

{
  "emprunteurs": {
    "principal": {
      "nom": "string | null",
      "prenom": "string | null", 
      "dateNaissance": "YYYY-MM-DD | null"
    },
    "conjoint": null | {
      "nom": "string | null",
      "prenom": "string | null",
      "dateNaissance": "YYYY-MM-DD | null"
    }
  },
  "pret": {
    "montantInitial": number | null,
    "dureeInitialeMois": number | null,
    "dateDebut": "YYYY-MM-DD | null",
    "dateFin": "YYYY-MM-DD | null", 
    "tauxNominal": number | null,
    "banquePreteuse": "string | null",
    "typePret": "string | null"
  },
  "lignesAmortissementCibles": {
    "echeanceAvant": {
      "date": "YYYY-MM-DD",
      "capitalRestantDu": number
    } | null,
    "echeanceApres": {
      "date": "YYYY-MM-DD",
      "capitalRestantDu": number
    } | null
  },
  "metadata": {
    "confidence": number,
    "warnings": ["string"]
  }
}

RÈGLES D'EXTRACTION STRICTES :
- L'utilisateur te fournira la "date_effective". Trouve l'échéance la plus proche AVANT cette date et l'échéance la plus proche APRÈS cette date.
- Si la "date_effective" tombe exactement sur une échéance, retourne cette même échéance pour "echeanceAvant" ET "echeanceApres".
- Si tu ne trouves pas de tableau d'amortissement, retourne null pour "echeanceAvant" et "echeanceApres" et ajoute un warning.
- Si une autre donnée n'est pas trouvée, utilise null.
- Dates : Convertis-les TOUJOURS au format YYYY-MM-DD.
- Montants : Retourne des nombres.

DÉTECTION DU TABLEAU D'AMORTISSEMENT :
- Le tableau d'amortissement peut être dans N'IMPORTE QUEL document
- Cherche des patterns comme : "Tableau d'amortissement", "Échéances", "Plan de remboursement", "Amortissement"
- Les colonnes peuvent être nommées différemment : "CRD", "Capital Restant Dû", "Reste à payer", "Capital dû"
- Si tu vois des lignes avec des dates et des montants, c'est probablement le tableau d'amortissement
- Même si le tableau semble incomplet, extrais les deux lignes qui encadrent la date_effective
- Si aucun tableau n'est trouvé après analyse exhaustive, retourne null pour les échéances mais ajoute un warning explicite

GESTION DU CONJOINT :
- Si les documents ne mentionnent qu'un seul emprunteur, retourne null pour le champ "conjoint"
- Si les documents mentionnent un co-emprunteur/conjoint, remplis ses informations
- En cas de doute, privilégie null pour éviter les erreurs

CONSOLIDATION DES DONNÉES :
- Si une même information apparaît dans plusieurs documents avec des valeurs différentes, privilégie la source la plus récente ou la plus détaillée
- Ajoute un warning dans metadata.warnings pour signaler les incohérences détectées
```

**Localisation** : `lib/services/document-extraction.ts` - Variable
`SYSTEM_PROMPT`

## 📞 Support

- **Documentation** : `documents/architecture/document-extraction-service.md`
- **Tests** : `npm run test:extraction`
- **Logs** : Console du navigateur et logs serveur

================
File: README.md
================
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

================
File: services/api.ts
================
import { Broker, BrokerInvite, ExadeConfig, WalletSummary } from '../types/model';
import { supabase } from '../lib/supabase';

// --- CENTRALIZED API SERVICE ---

export const api = {
    // --- BROKER CONTEXT ---

    /**
     * Get the list of brokers user has access to.
     * Uses RPC get_my_brokers which returns brokers where user is broker_user OR apporteur.
     */
    getMyBrokers: async (): Promise<Broker[]> => {
        const { data, error } = await supabase.rpc('get_my_brokers');

        if (error) {
            console.error('Error fetching brokers:', error);
            return [];
        }

        if (!data || data.length === 0) {
            return [];
        }

        // Map RPC result to Broker type
        return data.map((row: any) => ({
            id: row.broker_id,
            name: row.broker_name,
            status: row.broker_status,
            onboarding_status: row.onboarding_status || 'created',
        }));
    },

    // --- USER PROFILE ---

    /**
     * Get the apporteur profile of the currently authenticated user.
     * Returns null if user is not authenticated or has no apporteur profile.
     */
    getCurrentApporteurProfile: async (): Promise<{
        id: string;
        user_id: string;
        nom: string;
        prenom: string;
        email: string;
        telephone?: string;
        statut: string;
    } | null> => {
        // Get current user
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
            return null;
        }

        // Get apporteur profile linked to this user
        const { data, error } = await supabase
            .from('apporteur_profiles')
            .select('id, user_id, nom, prenom, email, telephone, statut')
            .eq('user_id', user.id)
            .single();

        if (error) {
            if (error.code !== 'PGRST116') { // Not found is ok
                console.error('Error fetching apporteur profile:', error);
            }
            return null;
        }

        return data;
    },

    // --- INVITES ---

    /**
     * Create a new invite link.
     * Uses RPC create_broker_invite.
     */
    createBrokerInvite: async (payload: { brokerId: string, type: 'apporteur' | 'broker_user', expiresInHours: number, maxUses: number }): Promise<BrokerInvite> => {
        const { data, error } = await supabase.rpc('create_broker_invite', {
            p_broker_id: payload.brokerId,
            p_invite_type: payload.type,
            p_expires_in_hours: payload.expiresInHours,
            p_max_uses: payload.maxUses
        });

        if (error) {
            console.error('Error creating invite:', error);
            throw new Error(`Erreur lors de la création de l'invitation: ${error.message}`);
        }

        if (!data?.success) {
            throw new Error(data?.error || "Erreur lors de la création de l'invitation");
        }

        // Build the invite link URL
        const baseUrl = typeof window !== 'undefined' ? window.location.origin : process.env.NEXT_PUBLIC_APP_URL || '';
        const linkUrl = `${baseUrl}/invite/${data.token}`;

        return {
            id: data.invite_id,
            broker_id: payload.brokerId,
            invite_type: payload.type,
            token: data.token,
            expires_at: data.expires_at,
            max_uses: data.max_uses,
            uses: 0,
            link_url: linkUrl
        };
    },

    /**
     * Validate an invite token.
     * Uses RPC validate_broker_invite.
     */
    validateBrokerInvite: async (token: string): Promise<{
        is_valid: boolean;
        reason?: string;
        broker_id?: string;
        broker_name?: string;
        owner_name?: string;
        invite_type?: 'apporteur' | 'broker_user';
        expires_at?: string;
        uses_remaining?: number;
    }> => {
        const { data, error } = await supabase.rpc('validate_broker_invite', {
            p_token: token
        });

        if (error) {
            console.error('Error validating invite:', error);
            return { is_valid: false, reason: 'Erreur de validation' };
        }

        return {
            is_valid: data?.is_valid || false,
            reason: data?.reason,
            broker_id: data?.broker_id,
            broker_name: data?.broker_name,
            owner_name: data?.owner_name,
            invite_type: data?.invite_type,
            expires_at: data?.expires_at,
            uses_remaining: data?.uses_remaining
        };
    },

    /**
     * Consume an invite token (use it to join a broker).
     * Uses RPC consume_broker_invite.
     */
    consumeBrokerInvite: async (token: string): Promise<{
        success: boolean;
        error?: string;
        broker_id?: string;
        invite_type?: string;
    }> => {
        const { data, error } = await supabase.rpc('consume_broker_invite', {
            p_token: token
        });

        if (error) {
            console.error('Error consuming invite:', error);
            return { success: false, error: 'Erreur lors de l\'acceptation de l\'invitation' };
        }

        return {
            success: data?.success || false,
            error: data?.error,
            broker_id: data?.broker_id,
            invite_type: data?.invite_type
        };
    },

    // --- EXADE ---

    /**
     * Get Exade Configuration for a broker.
     * Reads from broker_exade_configs table.
     * Note: Secrets (vault_secret_*) are not exposed to the client.
     */
    getExadeConfig: async (brokerId: string): Promise<ExadeConfig | null> => {
        const { data, error } = await supabase
            .from('broker_exade_configs')
            .select('id, broker_id, environment, code_courtier, is_enabled, last_tested_at, last_test_status')
            .eq('broker_id', brokerId)
            .eq('is_enabled', true)
            .single();

        if (error) {
            // PGRST116 = no rows found, which is normal for unconfigured brokers
            if (error.code !== 'PGRST116') {
                console.error('Error fetching Exade config:', error);
            }
            return null;
        }

        if (!data) {
            return null;
        }

        return {
            id: data.id,
            broker_id: data.broker_id,
            environment: data.environment,
            code_courtier: data.code_courtier,
            is_enabled: data.is_enabled,
            last_tested_at: data.last_tested_at,
            last_test_status: data.last_test_status as 'success' | 'error' | null
        };
    },

    /**
     * Save Exade Configuration.
     * Upserts into broker_exade_configs table.
     * Note: Secrets should be handled via separate secure RPC (not implemented here).
     */
    saveExadeConfig: async (brokerId: string, config: Partial<ExadeConfig>): Promise<void> => {
        // First check if config exists
        const { data: existing } = await supabase
            .from('broker_exade_configs')
            .select('id')
            .eq('broker_id', brokerId)
            .single();

        const payload = {
            broker_id: brokerId,
            code_courtier: config.code_courtier,
            environment: config.environment,
            is_enabled: config.is_enabled ?? true,
            configured_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        let error;

        if (existing?.id) {
            // Update existing config
            const result = await supabase
                .from('broker_exade_configs')
                .update(payload)
                .eq('id', existing.id);
            error = result.error;
        } else {
            // Insert new config
            const result = await supabase
                .from('broker_exade_configs')
                .insert(payload);
            error = result.error;
        }

        if (error) {
            console.error('Error saving Exade config:', error);
            throw new Error('Erreur lors de la sauvegarde de la configuration Exade');
        }
    },

    /**
     * Test Exade Connection.
     * Note: Real test requires server-side call with secrets.
     * Currently shows "Test indisponible" in UI.
     */
    testExadeConfig: async (brokerId: string): Promise<void> => {
        // TODO: Implement via server-side API route that can access Vault secrets
        throw new Error("Test indisponible: La fonctionnalité de test nécessite une configuration serveur.");
    },

    // --- WALLET ---

    /**
     * Get Wallet Summary for a broker.
     * Uses RPC get_wallet_summary and fetches recent transactions.
     */
    getWalletSummary: async (brokerId: string, ownerType: 'broker' | 'apporteur' = 'broker', ownerId?: string): Promise<WalletSummary> => {
        // Get wallet summary via RPC
        const { data: summaryData, error: summaryError } = await supabase.rpc('get_wallet_summary', {
            p_broker_id: brokerId,
            p_owner_type: ownerType,
            p_owner_id: ownerId || null
        });

        if (summaryError) {
            console.error('Error fetching wallet summary:', summaryError);
            // Return empty state on error
            return {
                broker_id: brokerId,
                balance_available: 0,
                balance_pending: 0,
                total_earnings: 0,
                recent_history: []
            };
        }

        // Get the first result (there should only be one wallet account per owner)
        const summary = summaryData?.[0];

        // Fetch recent transactions (last 10)
        const { data: transactionsData } = await supabase
            .from('wallet_transactions')
            .select('id, amount, label, status, created_at')
            .eq('broker_id', brokerId)
            .order('created_at', { ascending: false })
            .limit(10);

        // Calculate total earnings from credit transactions
        const { data: earningsData } = await supabase
            .from('wallet_transactions')
            .select('amount')
            .eq('broker_id', brokerId)
            .eq('type', 'credit')
            .eq('status', 'available');

        const totalEarnings = earningsData?.reduce((sum, t) => sum + Number(t.amount || 0), 0) || 0;

        // Map transactions to WalletTransaction type
        const recentHistory = (transactionsData || []).map((t: any) => ({
            id: t.id,
            date: t.created_at,
            amount: Number(t.amount),
            label: t.label,
            status: t.status === 'available' ? 'completed' as const : 'pending' as const
        }));

        return {
            broker_id: brokerId,
            balance_available: Number(summary?.balance_available || 0),
            balance_pending: Number(summary?.balance_pending || 0),
            total_earnings: totalEarnings,
            recent_history: recentHistory
        };
    },

    // --- DOCUMENTS ---

    /**
     * Get a signed view URL for a document.
     * Accepts either a document ID (uuid) or a storage path directly.
     * Returns a time-limited signed URL for private bucket access.
     */
    getDocumentViewUrl: async (documentIdOrPath: string): Promise<string> => {
        let storagePath: string;
        let bucket: string = 'documents';

        // Check if input looks like a UUID (document ID) or a path
        const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(documentIdOrPath);

        if (isUuid) {
            // Fetch document metadata from DB to get storage_path and bucket
            const { data: doc, error } = await supabase
                .from('documents')
                .select('storage_path, storage_bucket')
                .eq('id', documentIdOrPath)
                .single();

            if (error || !doc) {
                console.error('Error fetching document:', error);
                throw new Error('Document non trouvé');
            }

            storagePath = doc.storage_path;
            bucket = doc.storage_bucket || 'documents';
        } else {
            // Input is already a storage path
            storagePath = documentIdOrPath;
        }

        // Create signed URL (valid for 1 hour)
        const { data, error } = await supabase.storage
            .from(bucket)
            .createSignedUrl(storagePath, 3600);

        if (error || !data?.signedUrl) {
            console.error('Error creating signed URL:', error);
            throw new Error('Impossible de générer l\'URL du document');
        }

        return data.signedUrl;
    }
};

================
File: supabase/functions/generate-pdf/index.ts
================
import { serve } from "https://deno.land/std@0.177.0/http/server.ts"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

interface PDFRequest {
  dossierId: string;
  devisId: string;
}

serve(async (req) => {
  // Handle CORS
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // Initialize Supabase client
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
      { global: { headers: { Authorization: req.headers.get('Authorization')! } } }
    )

    // Get authenticated user
    const { data: { user }, error: userError } = await supabaseClient.auth.getUser()
    if (userError || !user) {
      throw new Error('Non authentifié')
    }

    const pdfRequest: PDFRequest = await req.json()

    // Récupérer toutes les données nécessaires
    const { data: dossierData, error: dossierError } = await supabaseClient
      .from('dossiers')
      .select(`
        *,
        client_info:client_infos(*),
        devis:devis(*)
      `)
      .eq('id', pdfRequest.dossierId)
      .eq('user_id', user.id)
      .single()

    if (dossierError || !dossierData) {
      throw new Error('Dossier non trouvé')
    }

    // Générer le contenu HTML du PDF
    const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>Devis Assurance Emprunteur - ${dossierData.numero_dossier}</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 40px; }
            .header { text-align: center; border-bottom: 2px solid #4F46E5; padding-bottom: 20px; margin-bottom: 30px; }
            .logo { font-size: 24px; font-weight: bold; color: #4F46E5; }
            .section { margin-bottom: 30px; }
            .section h2 { color: #4F46E5; border-bottom: 1px solid #E5E7EB; padding-bottom: 10px; }
            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            .info-item { margin-bottom: 10px; }
            .info-item strong { color: #374151; }
            .highlight { background-color: #F0FDF4; padding: 20px; border-radius: 8px; border-left: 4px solid #10B981; }
            .garanties { list-style: none; padding: 0; }
            .garanties li { padding: 5px 0; }
            .garanties li:before { content: "✓"; color: #10B981; font-weight: bold; margin-right: 10px; }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="logo">GMB COURTAGE</div>
            <h1>Devis Assurance Emprunteur</h1>
            <p>Dossier N° ${dossierData.numero_dossier}</p>
        </div>

        <div class="section">
            <h2>Informations Client</h2>
            <div class="info-grid">
                <div>
                    <div class="info-item"><strong>Nom :</strong> ${dossierData.client_info.prenom} ${dossierData.client_info.nom}</div>
                    <div class="info-item"><strong>Email :</strong> ${dossierData.client_info.email}</div>
                    <div class="info-item"><strong>Téléphone :</strong> ${dossierData.client_info.telephone}</div>
                </div>
                <div>
                    <div class="info-item"><strong>Profession :</strong> ${dossierData.client_info.profession}</div>
                    <div class="info-item"><strong>Revenus :</strong> ${dossierData.client_info.revenus}€/mois</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Votre Devis</h2>
            <div class="highlight">
                <h3>💰 Économies Estimées : ${dossierData.devis.economies_estimees}€</h3>
                <p><strong>Coût mensuel :</strong> ${dossierData.devis.cout_assurance}€</p>
                <p><strong>Compagnie :</strong> ${dossierData.devis.compagnie}</p>
                <p><strong>Type de couverture :</strong> ${dossierData.devis.type_couverture}</p>
            </div>
        </div>

        <div class="section">
            <h2>Garanties Incluses</h2>
            <ul class="garanties">
                ${JSON.parse(dossierData.devis.details_couverture).map(garantie => `<li>${garantie}</li>`).join('')}
            </ul>
        </div>

        <div class="section">
            <h2>Informations Légales</h2>
            <p><small>
                Ce devis est valable jusqu'au ${new Date(dossierData.devis.date_expiration).toLocaleDateString('fr-FR')}.
                GMB Courtage - Société de courtage en assurances.
                Document généré le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}
            </small></p>
        </div>
    </body>
    </html>
    `

    // TODO: Ici, on devrait utiliser une bibliothèque comme Puppeteer ou wkhtmltopdf
    // pour convertir le HTML en PDF. Pour cette démonstration, on retourne le HTML.
    
    // En production, vous pourriez utiliser :
    // - Une API externe comme HTMLCSStoImage
    // - Puppeteer avec Deno
    // - Un service dédié de génération PDF

    // Pour l'instant, simuler la génération PDF
    const pdfFileName = `devis_${dossierData.numero_dossier}_${Date.now()}.pdf`
    
    // TODO: Sauvegarder le PDF dans Supabase Storage
    // et mettre à jour l'URL dans la table devis
    
    await supabaseClient
      .from('devis')
      .update({ 
        pdf_url: `/storage/pdfs/${pdfFileName}`,
        updated_at: new Date().toISOString()
      })
      .eq('id', pdfRequest.devisId)

    return new Response(
      JSON.stringify({
        success: true,
        pdfUrl: `/storage/pdfs/${pdfFileName}`,
        htmlContent: htmlContent // Pour débug
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200,
      },
    )

  } catch (error) {
    console.error('Erreur génération PDF:', error)
    return new Response(
      JSON.stringify({
        error: error.message || 'Erreur génération PDF'
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400,
      },
    )
  }
})

================
File: supabase/functions/manage-devis/index.ts
================
import { serve } from "https://deno.land/std@0.177.0/http/server.ts"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

interface DevisAction {
  action: 'validate' | 'refuse';
  devisId: string;
  dossierId: string;
  reason?: string; // Pour le refus
}

serve(async (req) => {
  // Handle CORS
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // Initialize Supabase client
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
      { global: { headers: { Authorization: req.headers.get('Authorization')! } } }
    )

    // Get authenticated user
    const { data: { user }, error: userError } = await supabaseClient.auth.getUser()
    if (userError || !user) {
      throw new Error('Non authentifié')
    }

    const actionData: DevisAction = await req.json()

    // Vérifier que l'utilisateur possède bien ce dossier
    const { data: dossier, error: dossierError } = await supabaseClient
      .from('dossiers')
      .select('id, numero_dossier')
      .eq('id', actionData.dossierId)
      .eq('user_id', user.id)
      .single()

    if (dossierError || !dossier) {
      throw new Error('Dossier non trouvé ou accès non autorisé')
    }

    if (actionData.action === 'validate') {
      // Valider le devis
      const { error: devisError } = await supabaseClient
        .from('devis')
        .update({ 
          statut: 'accepte',
          validated_at: new Date().toISOString(),
          validated_by: user.id
        })
        .eq('id', actionData.devisId)

      if (devisError) throw devisError

      // Mettre à jour le statut du dossier
      await supabaseClient
        .from('dossiers')
        .update({ 
          statut_canon: 'devis_accepte',
          updated_at: new Date().toISOString()
        })
        .eq('id', actionData.dossierId)

      // Mettre à jour les étapes de processus
      await supabaseClient
        .from('process_steps')
        .update({ 
          status: 'completed', 
          completed_at: new Date().toISOString() 
        })
        .eq('dossier_id', actionData.dossierId)
        .eq('step_order', 5)

      await supabaseClient
        .from('process_steps')
        .update({ status: 'current' })
        .eq('dossier_id', actionData.dossierId)
        .eq('step_order', 6)

      // Créer une notification pour GMB
      await supabaseClient
        .from('notifications')
        .insert({
          type: 'devis_accepte',
          dossier_id: actionData.dossierId,
          user_id: user.id,
          title: 'Devis accepté',
          message: `Devis accepté pour le dossier ${dossier.numero_dossier}`
        })

    } else if (actionData.action === 'refuse') {
      if (!actionData.reason) {
        throw new Error('Raison du refus obligatoire')
      }

      // Refuser le devis
      const { error: devisError } = await supabaseClient
        .from('devis')
        .update({ 
          statut: 'refuse',
          refused_at: new Date().toISOString(),
          refuse_reason: actionData.reason
        })
        .eq('id', actionData.devisId)

      if (devisError) throw devisError

      // Mettre à jour le statut du dossier
      await supabaseClient
        .from('dossiers')
        .update({ 
          statut_canon: 'refuse',
          commentaires: actionData.reason,
          updated_at: new Date().toISOString()
        })
        .eq('id', actionData.dossierId)

      // Mettre à jour l'étape de processus
      await supabaseClient
        .from('process_steps')
        .update({ 
          status: 'error', 
          completed_at: new Date().toISOString() 
        })
        .eq('dossier_id', actionData.dossierId)
        .eq('step_order', 5)

      // Créer une notification pour GMB avec le commentaire
      await supabaseClient
        .from('notifications')
        .insert({
          type: 'devis_refuse',
          dossier_id: actionData.dossierId,
          user_id: user.id,
          title: 'Devis refusé',
          message: `Devis refusé pour le dossier ${dossier.numero_dossier}`,
          details: { reason: actionData.reason }
        })
    }

    return new Response(
      JSON.stringify({
        success: true,
        action: actionData.action,
        message: actionData.action === 'validate' 
          ? 'Devis validé avec succès' 
          : 'Devis refusé, votre commentaire a été transmis'
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200,
      },
    )

  } catch (error) {
    console.error('Erreur gestion devis:', error)
    return new Response(
      JSON.stringify({
        error: error.message || 'Erreur interne'
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400,
      },
    )
  }
})

================
File: supabase/functions/manage-documents/index.ts
================
import { serve } from "https://deno.land/std@0.177.0/http/server.ts"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

interface DocumentAction {
  action: 'delete' | 'add';
  dossierId: string;
  documentType: string;
  documentData?: {
    nom: string;
    url: string;
    taille: string;
    type_mime: string;
  };
}

serve(async (req) => {
  // Handle CORS
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // Initialize Supabase client
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
      { global: { headers: { Authorization: req.headers.get('Authorization')! } } }
    )

    // Get authenticated user (admin)
    const { data: { user }, error: userError } = await supabaseClient.auth.getUser()
    if (userError || !user) {
      throw new Error('Non authentifié')
    }

    // Vérifier que l'utilisateur est admin
    const { data: profile, error: profileError } = await supabaseClient
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single()

    if (profileError || profile?.role !== 'admin') {
      throw new Error('Accès non autorisé - Admin seulement')
    }

    const { action, dossierId, documentType, documentData }: DocumentAction = await req.json()

    // Vérifier que le dossier existe
    const { data: dossierExists, error: dossierError } = await supabaseClient
      .from('dossiers')
      .select('id')
      .eq('id', dossierId)
      .single()

    if (dossierError || !dossierExists) {
      throw new Error('Dossier non trouvé')
    }

    if (action === 'delete') {
      // Supprimer le document de la base de données
      const { error: deleteError } = await supabaseClient
        .from('documents')
        .delete()
        .eq('dossier_id', dossierId)
        .eq('type_document', documentType)

      if (deleteError) throw deleteError

      // TODO: Supprimer aussi le fichier physique du Storage
      // const { error: storageError } = await supabaseClient.storage
      //   .from('documents')
      //   .remove([`${dossierId}/${documentType}`])

      // Log de l'action admin
      await supabaseClient
        .from('admin_logs')
        .insert({
          admin_id: user.id,
          action: 'delete_document',
          dossier_id: dossierId,
          details: { document_type: documentType }
        })

      return new Response(
        JSON.stringify({
          success: true,
          message: 'Document supprimé avec succès'
        }),
        {
          headers: { ...corsHeaders, 'Content-Type': 'application/json' },
          status: 200,
        },
      )

    } else if (action === 'add') {
      if (!documentData) {
        throw new Error('Données du document manquantes')
      }

      // Ajouter le document en base de données
      const { error: insertError } = await supabaseClient
        .from('documents')
        .insert({
          dossier_id: dossierId,
          type_document: documentType,
          nom_fichier: documentData.nom,
          url_fichier: documentData.url,
          taille_fichier: documentData.taille,
          type_mime: documentData.type_mime,
          uploaded_by: user.id,
          uploaded_at: new Date().toISOString()
        })

      if (insertError) throw insertError

      // Log de l'action admin
      await supabaseClient
        .from('admin_logs')
        .insert({
          admin_id: user.id,
          action: 'add_document',
          dossier_id: dossierId,
          details: { 
            document_type: documentType,
            document_name: documentData.nom
          }
        })

      return new Response(
        JSON.stringify({
          success: true,
          message: 'Document ajouté avec succès'
        }),
        {
          headers: { ...corsHeaders, 'Content-Type': 'application/json' },
          status: 200,
        },
      )
    }

    throw new Error('Action non reconnue')

  } catch (error) {
    console.error('Erreur gestion documents:', error)
    return new Response(
      JSON.stringify({
        error: error.message || 'Erreur interne'
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400,
      },
    )
  }
})

================
File: supabase/functions/update-client-data/index.ts
================
import { serve } from "https://deno.land/std@0.177.0/http/server.ts"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

interface ClientData {
  dossierId: string;
  clientData: {
    client_nom: string;
    client_prenom: string;
    client_email: string;
    client_telephone: string;
    client_date_naissance: string;
    client_adresse: string;
    client_profession: string;
    client_fumeur: boolean;
  };
}

serve(async (req) => {
  // Handle CORS
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // Initialize Supabase client
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
      { global: { headers: { Authorization: req.headers.get('Authorization')! } } }
    )

    // Get authenticated user (admin)
    const { data: { user }, error: userError } = await supabaseClient.auth.getUser()
    if (userError || !user) {
      throw new Error('Non authentifié')
    }

    // Vérifier que l'utilisateur est admin
    const { data: profile, error: profileError } = await supabaseClient
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single()

    if (profileError || profile?.role !== 'admin') {
      throw new Error('Accès non autorisé - Admin seulement')
    }

    const { dossierId, clientData }: ClientData = await req.json()

    // Vérifier que le dossier existe
    const { data: dossierExists, error: dossierError } = await supabaseClient
      .from('dossiers')
      .select('id')
      .eq('id', dossierId)
      .single()

    if (dossierError || !dossierExists) {
      throw new Error('Dossier non trouvé')
    }

    // Mettre à jour les informations client dans la table client_infos
    const { error: updateClientError } = await supabaseClient
      .from('client_infos')
      .update({
        nom: clientData.client_nom,
        prenom: clientData.client_prenom,
        email: clientData.client_email,
        telephone: clientData.client_telephone,
        date_naissance: clientData.client_date_naissance,
        adresse: clientData.client_adresse,
        profession: clientData.client_profession,
        fumeur: clientData.client_fumeur,
        updated_at: new Date().toISOString()
      })
      .eq('dossier_id', dossierId)

    if (updateClientError) throw updateClientError

    // Mettre à jour également la table dossiers pour les champs directs
    const { error: updateDossierError } = await supabaseClient
      .from('dossiers')
      .update({
        updated_at: new Date().toISOString()
      })
      .eq('id', dossierId)

    if (updateDossierError) throw updateDossierError

    // Log de l'action admin
    await supabaseClient
      .from('admin_logs')
      .insert({
        admin_id: user.id,
        action: 'update_client_data',
        dossier_id: dossierId,
        details: { updated_fields: Object.keys(clientData) }
      })

    return new Response(
      JSON.stringify({
        success: true,
        message: 'Données client mises à jour avec succès'
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200,
      },
    )

  } catch (error) {
    console.error('Erreur mise à jour données client:', error)
    return new Response(
      JSON.stringify({
        error: error.message || 'Erreur interne'
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400,
      },
    )
  }
})

================
File: supabase/functions/update-pret-data/index.ts
================
import { serve } from "https://deno.land/std@0.177.0/http/server.ts"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

interface PretData {
  dossierId: string;
  pretData: {
    banque_preteuse: string;
    montant_capital: number;
    duree_mois: number;
    type_pret: string;
    cout_assurance_banque?: number;
  };
}

serve(async (req) => {
  // Handle CORS
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // Initialize Supabase client
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
      { global: { headers: { Authorization: req.headers.get('Authorization')! } } }
    )

    // Get authenticated user (admin)
    const { data: { user }, error: userError } = await supabaseClient.auth.getUser()
    if (userError || !user) {
      throw new Error('Non authentifié')
    }

    // Vérifier que l'utilisateur est admin
    const { data: profile, error: profileError } = await supabaseClient
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single()

    if (profileError || profile?.role !== 'admin') {
      throw new Error('Accès non autorisé - Admin seulement')
    }

    const { dossierId, pretData }: PretData = await req.json()

    // Vérifier que le dossier existe
    const { data: dossierExists, error: dossierError } = await supabaseClient
      .from('dossiers')
      .select('id')
      .eq('id', dossierId)
      .single()

    if (dossierError || !dossierExists) {
      throw new Error('Dossier non trouvé')
    }

    // Mettre à jour ou créer les informations de prêt dans la table pret_infos
    const { error: upsertPretError } = await supabaseClient
      .from('pret_infos')
      .upsert({
        dossier_id: dossierId,
        banque_preteuse: pretData.banque_preteuse,
        montant_capital: pretData.montant_capital,
        duree_mois: pretData.duree_mois,
        type_pret: pretData.type_pret,
        cout_assurance_banque: pretData.cout_assurance_banque,
        updated_at: new Date().toISOString()
      })

    if (upsertPretError) throw upsertPretError

    // Mettre à jour la table dossiers avec les infos principales
    const { error: updateDossierError } = await supabaseClient
      .from('dossiers')
      .update({
        montant_capital: pretData.montant_capital,
        duree_pret: Math.round(pretData.duree_mois / 12),
        updated_at: new Date().toISOString()
      })
      .eq('id', dossierId)

    if (updateDossierError) throw updateDossierError

    // Si les données de prêt changent, il faut potentiellement recalculer les devis
    // Marquer pour une nouvelle tarification si montant ou durée ont changé
    await supabaseClient
      .from('devis')
      .update({ needs_recalculation: true })
      .eq('dossier_id', dossierId)

    // Log de l'action admin
    await supabaseClient
      .from('admin_logs')
      .insert({
        admin_id: user.id,
        action: 'update_pret_data',
        dossier_id: dossierId,
        details: { updated_fields: Object.keys(pretData) }
      })

    return new Response(
      JSON.stringify({
        success: true,
        message: 'Données de prêt mises à jour avec succès',
        recalculation_needed: true
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200,
      },
    )

  } catch (error) {
    console.error('Erreur mise à jour données prêt:', error)
    return new Response(
      JSON.stringify({
        error: error.message || 'Erreur interne'
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400,
      },
    )
  }
})

================
File: supabase/migrations/test_inter_broker_leak.sql
================
-- Script de test pour vérifier l'isolation inter-brokers
-- Ce script crée 2 brokers, des users/apporteurs, et vérifie qu'ils ne peuvent pas accéder aux données de l'autre

-- IMPORTANT : Ce script doit être exécuté avec un user ayant les droits nécessaires
-- Il simule les requêtes que ferait chaque user pour vérifier l'isolation

BEGIN;

-- ============================================
-- SETUP : Créer les données de test
-- ============================================

-- Créer 2 brokers
INSERT INTO brokers (id, name, status) VALUES
    ('00000000-0000-0000-0000-000000000001', 'Broker A Test', 'actif'),
    ('00000000-0000-0000-0000-000000000002', 'Broker B Test', 'actif')
ON CONFLICT (id) DO NOTHING;

-- Note : Les users Supabase doivent être créés manuellement via auth.users
-- Ici on suppose qu'ils existent déjà avec ces IDs :
-- - user_courtier_a_id (pour broker A)
-- - user_apporteur_b_id (pour broker B)

-- Créer les liens broker_users et broker_apporteurs
-- (À adapter selon vos IDs réels)

-- Exemple pour broker A (courtier)
-- INSERT INTO broker_users (broker_id, user_id, role)
-- VALUES ('00000000-0000-0000-0000-000000000001', 'user_courtier_a_id', 'admin')
-- ON CONFLICT DO NOTHING;

-- Exemple pour broker B (apporteur)
-- INSERT INTO broker_apporteurs (broker_id, apporteur_profile_id, status)
-- VALUES ('00000000-0000-0000-0000-000000000002', 'apporteur_b_profile_id', 'actif')
-- ON CONFLICT DO NOTHING;

-- Créer un dossier dans Broker B
-- INSERT INTO dossiers (broker_id, apporteur_id, ...)
-- VALUES ('00000000-0000-0000-0000-000000000002', 'apporteur_b_profile_id', ...);

-- ============================================
-- TESTS À EFFECTUER (à exécuter avec chaque user)
-- ============================================

-- TEST 1 : User courtier A ne doit PAS voir les dossiers de Broker B
-- Exécuter avec auth.uid() = user_courtier_a_id
/*
SELECT COUNT(*) as dossiers_broker_b
FROM dossiers
WHERE broker_id = '00000000-0000-0000-0000-000000000002';
-- Résultat attendu : 0
*/

-- TEST 2 : Apporteur B ne doit PAS voir les dossiers de Broker A
-- Exécuter avec auth.uid() = user_apporteur_b_id
/*
SELECT COUNT(*) as dossiers_broker_a
FROM dossiers
WHERE broker_id = '00000000-0000-0000-0000-000000000001';
-- Résultat attendu : 0
*/

-- TEST 3 : Vérifier que les documents ne sont pas accessibles via storage
-- Ce test doit être fait côté application avec les signed URLs
-- Vérifier que :
-- - Un user de Broker A ne peut pas obtenir une signed URL pour un document de Broker B
-- - Les policies storage.objects bloquent l'accès

-- TEST 4 : Vérifier les wallet transactions
/*
-- User courtier A ne doit pas voir les transactions de Broker B
SELECT COUNT(*) as transactions_broker_b
FROM wallet_transactions
WHERE broker_id = '00000000-0000-0000-0000-000000000002';
-- Résultat attendu : 0
*/

-- ============================================
-- NETTOYAGE (optionnel, à exécuter après les tests)
-- ============================================
-- DELETE FROM dossiers WHERE broker_id IN ('00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002');
-- DELETE FROM broker_users WHERE broker_id IN ('00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002');
-- DELETE FROM broker_apporteurs WHERE broker_id IN ('00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002');
-- DELETE FROM brokers WHERE id IN ('00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002');

COMMIT;

================
File: tailwind.config.js
================
/** @type {import('tailwindcss').Config} */
module.exports = {
    darkMode: ["class"],
    content: ["./{app,components,libs,pages,hooks}/**/*.{html,js,ts,jsx,tsx}"],
  theme: {
  	extend: {
  		borderRadius: {
  			lg: 'var(--radius)',
  			md: 'calc(var(--radius) - 2px)',
  			sm: 'calc(var(--radius) - 4px)'
  		},
  		colors: {
  			background: 'hsl(var(--background))',
  			foreground: 'hsl(var(--foreground))',
  			card: {
  				DEFAULT: 'hsl(var(--card))',
  				foreground: 'hsl(var(--card-foreground))'
  			},
  			popover: {
  				DEFAULT: 'hsl(var(--popover))',
  				foreground: 'hsl(var(--popover-foreground))'
  			},
  			primary: {
  				DEFAULT: 'hsl(var(--primary))',
  				foreground: 'hsl(var(--primary-foreground))'
  			},
  			secondary: {
  				DEFAULT: 'hsl(var(--secondary))',
  				foreground: 'hsl(var(--secondary-foreground))'
  			},
  			muted: {
  				DEFAULT: 'hsl(var(--muted))',
  				foreground: 'hsl(var(--muted-foreground))'
  			},
  			accent: {
  				DEFAULT: 'hsl(var(--accent))',
  				foreground: 'hsl(var(--accent-foreground))'
  			},
  			destructive: {
  				DEFAULT: 'hsl(var(--destructive))',
  				foreground: 'hsl(var(--destructive-foreground))'
  			},
  			border: 'hsl(var(--border))',
  			input: 'hsl(var(--input))',
  			ring: 'hsl(var(--ring))',
  			chart: {
  				'1': 'hsl(var(--chart-1))',
  				'2': 'hsl(var(--chart-2))',
  				'3': 'hsl(var(--chart-3))',
  				'4': 'hsl(var(--chart-4))',
  				'5': 'hsl(var(--chart-5))'
  			}
  		}
  	}
  },
  plugins: [require("tailwindcss-animate")],
}

================
File: tsconfig.json
================
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"],
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules", "supabase/functions"]
}

================
File: types/data-comparison.ts
================
// Types pour la comparaison de données extraites vs données actuelles

export interface FieldDifference {
  field: string
  label: string
  currentValue: any
  extractedValue: any
  isDifferent: boolean
  isNew: boolean // Champ vide actuellement, nouvelle valeur proposée
  category: 'principal' | 'conjoint' | 'pret'
}

export interface DiffReport {
  // Indicateurs de présence de différences
  hasClientDifferences: boolean
  hasTypeMismatch: boolean
  
  // Liste des différences par catégorie
  principalDiffs: FieldDifference[]
  conjointDiffs: FieldDifference[]
  
  // Conflit de type de dossier
  currentType: 'seul' | 'couple'
  detectedType: 'seul' | 'couple'
  
  // Champs non trouvés par l'IA (non bloquants)
  champsManquants: string[]
  
  // Métadonnées
  totalDifferences: number
  confidence: number
}

export interface ExtractedClientData {
  // Emprunteur principal
  principal: {
    civilite?: 'M' | 'Mme' | 'Mlle' | null
    nom?: string | null
    prenom?: string | null
    nomNaissance?: string | null
    dateNaissance?: string | null
    fumeur?: boolean | null
    categorieProfessionnelle?: string | null
    profession?: string | null
    email?: string | null
    telephone?: string | null
  }
  
  // Conjoint (si couple)
  conjoint?: {
    civilite?: 'M' | 'Mme' | 'Mlle' | null
    nom?: string | null
    prenom?: string | null
    nomNaissance?: string | null
    dateNaissance?: string | null
    fumeur?: boolean | null
    categorieProfessionnelle?: string | null
    profession?: string | null
    email?: string | null
    telephone?: string | null
  } | null
  
  // Métadonnées
  nombreAssures: number
  champsManquants: string[]
}

export interface CurrentClientData {
  // Emprunteur principal
  civilite?: string | null
  client_nom: string
  client_prenom: string
  nom_naissance?: string | null
  client_date_naissance: string
  client_fumeur: boolean
  categorie_professionnelle?: number | null  // Code Exade 1-11
  client_email: string
  client_telephone?: string | null
  
  // Conjoint
  conjoint_civilite?: string | null
  conjoint_nom?: string | null
  conjoint_prenom?: string | null
  conjoint_nom_naissance?: string | null
  conjoint_date_naissance?: string | null
  conjoint_fumeur?: boolean | null
  conjoint_categorie_professionnelle?: number | null  // Code Exade 1-11
  conjoint_email?: string | null
  conjoint_telephone?: string | null
}

export interface ApplyChangesPayload {
  selectedFields: string[]
  updateType: boolean // true si on doit changer le type de dossier
  newType?: 'seul' | 'couple'
  extractedData: ExtractedClientData
}

================
File: types/document-extraction.ts
================
// Types pour le service d'extraction de documents
export interface EmprunteurInfo {
  nom: string | null
  prenom: string | null
  dateNaissance: string | null
}

export interface PretInfo {
  montantInitial: number | null
  dureeInitialeMois: number | null
  dateDebut: string | null
  dateFin: string | null
  tauxNominal: number | null
  banquePreteuse: string | null
  typePret: string | null
}

export interface Echeance {
  numero: number
  date: string
  capitalRestantDu: number
  interets: number
  assurance: number
  capital: number
  mensualite: number
}

export interface ExtractionMetadata {
  confidence: number
  warnings: string[]
  sourcesUtilisees?: string[]
  champsManquants?: string[]
}

export interface LigneAmortissementCible {
  date: string
  capitalRestantDu: number
}

export interface LignesAmortissementCibles {
  echeanceAvant: LigneAmortissementCible | null
  echeanceApres: LigneAmortissementCible | null
}

export interface ExtractedDataCiblee {
  emprunteurs: {
    principal: EmprunteurInfo | null
    conjoint: EmprunteurInfo | null
  }
  nombreAssures?: number
  pret: PretInfo | null
  lignesAmortissementCibles: LignesAmortissementCibles
  metadata: ExtractionMetadata
}

export interface ExtractedData {
  emprunteurs: {
    principal: EmprunteurInfo | null
    conjoint: EmprunteurInfo | null
  }
  pret: PretInfo | null
  tableauAmortissement: Echeance[]
  metadata: ExtractionMetadata
}

export interface CalculatedData {
  dateDebutEffective: string
  dureeRestanteMois: number
  capitalRestantDu: number
}

export interface ConsolidatedDataCiblee extends ExtractedDataCiblee {
  calculs: CalculatedData | null
}

export interface ConsolidatedData extends ExtractedData {
  calculs: CalculatedData | null
}

export interface DocumentSource {
  type: 'offrePret' | 'tableauAmortissement' | 'carteIdentite'
  content: string
  confidence: number
}

export interface ExtractionError {
  type: 'critical' | 'warning' | 'info'
  code: string
  message: string
  field?: string
  suggestion?: string
  source?: string
}

// Types pour l'intégration avec l'API Exade
export interface ExadeCompatibleData {
  assure: {
    nom: string
    prenom: string
    date_naissance: string
    fumeur?: boolean
    profession?: string
    revenus?: number
  }
  conjoint?: {
    nom: string
    prenom: string
    date_naissance: string
    fumeur?: boolean
    profession?: string
    revenus?: number
  }
  pret: {
    montant: number
    duree: number
    taux: number
    type?: string
  }
}

================
File: types/model.ts
================
/**
 * DOMAIN TYPES - Based on db.md
 * These types serve as the interface for the application Logic.
 * They are designed to be mapped to Supabase DB types later.
 */

export type BrokerStatus = 'actif' | 'suspendu' | 'inactif';
export type BrokerOnboardingStatus = 'created' | 'exade_pending' | 'ready';
export type BrokerUserRole = 'owner' | 'admin' | 'member';

export interface Broker {
  id: string;
  name: string;
  status: BrokerStatus;
  onboarding_status: BrokerOnboardingStatus;
  // Minimal fields for UI
}

export type BrokerInviteType = 'apporteur' | 'broker_user';

export interface BrokerInvite {
  id: string;
  broker_id: string;
  invite_type: BrokerInviteType;
  token: string;
  expires_at: string;
  max_uses: number;
  uses: number;
  revoked_at?: string | null;
  // Link generation helper
  link_url?: string; 
}

export type ExadeEnvironment = 'stage' | 'prod';

export interface ExadeConfig {
  id: string;
  broker_id: string;
  environment: ExadeEnvironment;
  code_courtier: string;
  is_enabled: boolean;
  last_tested_at?: string | null;
  last_test_status?: 'success' | 'error' | null;
}

export interface WalletSummary {
  broker_id: string;
  balance_available: number;
  balance_pending: number;
  total_earnings: number;
  recent_history: WalletTransaction[];
}

export interface WalletTransaction {
  id: string;
  date: string;
  amount: number;
  label: string;
  status: 'completed' | 'pending';
}

export type DocumentSource = 'uploaded' | 'exade_generated' | 'system';
export type DocumentVisibility = 'apporteur' | 'broker_only' | 'admin_only';

export interface DocumentItem {
  id: string;
  dossier_id?: string;
  document_name: string;
  document_type: string;
  url?: string; // For stub/preview
  source?: DocumentSource;
  visibility?: DocumentVisibility;
  created_at?: string;
}

================
File: types/supabase.ts
================
export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "13.0.4"
  }
  public: {
    Tables: {
      activities: {
        Row: {
          activity_data: Json | null
          activity_description: string | null
          activity_title: string
          activity_type: string
          created_at: string | null
          dossier_id: string | null
          id: string
          is_read: boolean | null
          user_id: string | null
        }
        Insert: {
          activity_data?: Json | null
          activity_description?: string | null
          activity_title: string
          activity_type: string
          created_at?: string | null
          dossier_id?: string | null
          id?: string
          is_read?: boolean | null
          user_id?: string | null
        }
        Update: {
          activity_data?: Json | null
          activity_description?: string | null
          activity_title?: string
          activity_type?: string
          created_at?: string | null
          dossier_id?: string | null
          id?: string
          is_read?: boolean | null
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "activities_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "activities_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_enriched"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "activities_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_computed_status"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "activities_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_process_dates"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "activities_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "apporteur_profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      apporteur_profiles: {
        Row: {
          cgu_accepted_at: string | null
          created_at: string | null
          email: string
          id: string
          nom: string
          prenom: string
          statut: Database["public"]["Enums"]["apporteur_statut"]
          telephone: string | null
          updated_at: string | null
          user_id: string | null
        }
        Insert: {
          cgu_accepted_at?: string | null
          created_at?: string | null
          email: string
          id?: string
          nom: string
          prenom: string
          statut?: Database["public"]["Enums"]["apporteur_statut"]
          telephone?: string | null
          updated_at?: string | null
          user_id?: string | null
        }
        Update: {
          cgu_accepted_at?: string | null
          created_at?: string | null
          email?: string
          id?: string
          nom?: string
          prenom?: string
          statut?: Database["public"]["Enums"]["apporteur_statut"]
          telephone?: string | null
          updated_at?: string | null
          user_id?: string | null
        }
        Relationships: []
      }
      client_infos: {
        Row: {
          categorie_professionnelle: number | null
          client_adresse: string | null
          client_civilite: string | null
          client_date_naissance: string
          client_email: string
          client_fumeur: boolean | null
          client_nom: string
          client_nom_naissance: string | null
          client_prenom: string
          client_profession: string | null
          client_telephone: string | null
          conjoint_categorie_professionnelle: number | null
          conjoint_civilite: string | null
          conjoint_date_naissance: string | null
          conjoint_email: string | null
          conjoint_fumeur: boolean | null
          conjoint_nom: string | null
          conjoint_nom_naissance: string | null
          conjoint_prenom: string | null
          conjoint_profession: string | null
          conjoint_telephone: string | null
          created_at: string | null
          dossier_id: string | null
          id: string
          updated_at: string | null
        }
        Insert: {
          categorie_professionnelle?: number | null
          client_adresse?: string | null
          client_civilite?: string | null
          client_date_naissance: string
          client_email: string
          client_fumeur?: boolean | null
          client_nom: string
          client_nom_naissance?: string | null
          client_prenom: string
          client_profession?: string | null
          client_telephone?: string | null
          conjoint_categorie_professionnelle?: number | null
          conjoint_civilite?: string | null
          conjoint_date_naissance?: string | null
          conjoint_email?: string | null
          conjoint_fumeur?: boolean | null
          conjoint_nom?: string | null
          conjoint_nom_naissance?: string | null
          conjoint_prenom?: string | null
          conjoint_profession?: string | null
          conjoint_telephone?: string | null
          created_at?: string | null
          dossier_id?: string | null
          id?: string
          updated_at?: string | null
        }
        Update: {
          categorie_professionnelle?: number | null
          client_adresse?: string | null
          client_civilite?: string | null
          client_date_naissance?: string
          client_email?: string
          client_fumeur?: boolean | null
          client_nom?: string
          client_nom_naissance?: string | null
          client_prenom?: string
          client_profession?: string | null
          client_telephone?: string | null
          conjoint_categorie_professionnelle?: number | null
          conjoint_civilite?: string | null
          conjoint_date_naissance?: string | null
          conjoint_email?: string | null
          conjoint_fumeur?: boolean | null
          conjoint_nom?: string | null
          conjoint_nom_naissance?: string | null
          conjoint_prenom?: string | null
          conjoint_profession?: string | null
          conjoint_telephone?: string | null
          created_at?: string | null
          dossier_id?: string | null
          id?: string
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "client_infos_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "client_infos_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_enriched"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "client_infos_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_computed_status"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "client_infos_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_process_dates"
            referencedColumns: ["id"]
          },
        ]
      }
      devis: {
        Row: {
          compagnie: string | null
          cout_mensuel: number | null
          cout_total: number | null
          created_at: string | null
          date_acceptation: string | null
          date_envoi: string | null
          date_expiration: string | null
          date_generation: string | null
          date_refus: string | null
          donnees_devis: Json
          dossier_id: string | null
          economie_estimee: number | null
          id: string
          motif_refus: string | null
          numero_devis: string
          pdf_created_at: string | null
          pdf_url: string | null
          produit: string | null
          reference: string | null
          statut: string | null
          updated_at: string | null
        }
        Insert: {
          compagnie?: string | null
          cout_mensuel?: number | null
          cout_total?: number | null
          created_at?: string | null
          date_acceptation?: string | null
          date_envoi?: string | null
          date_expiration?: string | null
          date_generation?: string | null
          date_refus?: string | null
          donnees_devis: Json
          dossier_id?: string | null
          economie_estimee?: number | null
          id?: string
          motif_refus?: string | null
          numero_devis: string
          pdf_created_at?: string | null
          pdf_url?: string | null
          produit?: string | null
          reference?: string | null
          statut?: string | null
          updated_at?: string | null
        }
        Update: {
          compagnie?: string | null
          cout_mensuel?: number | null
          cout_total?: number | null
          created_at?: string | null
          date_acceptation?: string | null
          date_envoi?: string | null
          date_expiration?: string | null
          date_generation?: string | null
          date_refus?: string | null
          donnees_devis?: Json
          dossier_id?: string | null
          economie_estimee?: number | null
          id?: string
          motif_refus?: string | null
          numero_devis?: string
          pdf_created_at?: string | null
          pdf_url?: string | null
          produit?: string | null
          reference?: string | null
          statut?: string | null
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "devis_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "devis_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_enriched"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "devis_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_computed_status"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "devis_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_process_dates"
            referencedColumns: ["id"]
          },
        ]
      }
      devis_history: {
        Row: {
          action: string
          commentaire: string | null
          created_at: string | null
          devis_id: string
          dossier_id: string
          id: string
          motif_refus: string | null
          statut_nouveau: string | null
          statut_precedent: string | null
          updated_at: string | null
          user_id: string | null
          user_type: string | null
        }
        Insert: {
          action: string
          commentaire?: string | null
          created_at?: string | null
          devis_id: string
          dossier_id: string
          id?: string
          motif_refus?: string | null
          statut_nouveau?: string | null
          statut_precedent?: string | null
          updated_at?: string | null
          user_id?: string | null
          user_type?: string | null
        }
        Update: {
          action?: string
          commentaire?: string | null
          created_at?: string | null
          devis_id?: string
          dossier_id?: string
          id?: string
          motif_refus?: string | null
          statut_nouveau?: string | null
          statut_precedent?: string | null
          updated_at?: string | null
          user_id?: string | null
          user_type?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "devis_history_devis_id_fkey"
            columns: ["devis_id"]
            isOneToOne: false
            referencedRelation: "devis"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "devis_history_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "devis_history_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_enriched"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "devis_history_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_computed_status"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "devis_history_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_process_dates"
            referencedColumns: ["id"]
          },
        ]
      }
      documents: {
        Row: {
          created_at: string | null
          document_name: string
          document_type: string
          dossier_id: string | null
          file_size: number | null
          id: string
          mime_type: string | null
          storage_bucket: string | null
          storage_path: string
          updated_at: string | null
          uploaded_by: string | null
        }
        Insert: {
          created_at?: string | null
          document_name: string
          document_type: string
          dossier_id?: string | null
          file_size?: number | null
          id?: string
          mime_type?: string | null
          storage_bucket?: string | null
          storage_path: string
          updated_at?: string | null
          uploaded_by?: string | null
        }
        Update: {
          created_at?: string | null
          document_name?: string
          document_type?: string
          dossier_id?: string | null
          file_size?: number | null
          id?: string
          mime_type?: string | null
          storage_bucket?: string | null
          storage_path?: string
          updated_at?: string | null
          uploaded_by?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "documents_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "documents_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_enriched"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "documents_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_computed_status"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "documents_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_process_dates"
            referencedColumns: ["id"]
          },
        ]
      }
      dossiers: {
        Row: {
          admin_id: string | null
          apporteur_id: string | null
          commentaire: string | null
          commentaire_refus: string | null
          comparison_modal_seen: boolean | null
          created_at: string | null
          date_creation: string | null
          devis_selectionne_id: string | null
          economie_generee: number | null
          extracted_client_data: Json | null
          id: string
          is_couple: boolean | null
          is_read: boolean | null
          last_extraction_at: string | null
          montant_capital: number | null
          notes_interne: string | null
          numero_dossier: string
          statut: string | null
          statut_canon: Database["public"]["Enums"]["dossier_statut"]
          type_dossier: string
          updated_at: string | null
        }
        Insert: {
          admin_id?: string | null
          apporteur_id?: string | null
          commentaire?: string | null
          commentaire_refus?: string | null
          comparison_modal_seen?: boolean | null
          created_at?: string | null
          date_creation?: string | null
          devis_selectionne_id?: string | null
          economie_generee?: number | null
          extracted_client_data?: Json | null
          id?: string
          is_couple?: boolean | null
          is_read?: boolean | null
          last_extraction_at?: string | null
          montant_capital?: number | null
          notes_interne?: string | null
          numero_dossier: string
          statut?: string | null
          statut_canon?: Database["public"]["Enums"]["dossier_statut"]
          type_dossier: string
          updated_at?: string | null
        }
        Update: {
          admin_id?: string | null
          apporteur_id?: string | null
          commentaire?: string | null
          commentaire_refus?: string | null
          comparison_modal_seen?: boolean | null
          created_at?: string | null
          date_creation?: string | null
          devis_selectionne_id?: string | null
          economie_generee?: number | null
          extracted_client_data?: Json | null
          id?: string
          is_couple?: boolean | null
          is_read?: boolean | null
          last_extraction_at?: string | null
          montant_capital?: number | null
          notes_interne?: string | null
          numero_dossier?: string
          statut?: string | null
          statut_canon?: Database["public"]["Enums"]["dossier_statut"]
          type_dossier?: string
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "dossiers_apporteur_id_fkey"
            columns: ["apporteur_id"]
            isOneToOne: false
            referencedRelation: "apporteur_profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "dossiers_devis_selectionne_id_fkey"
            columns: ["devis_selectionne_id"]
            isOneToOne: false
            referencedRelation: "devis"
            referencedColumns: ["id"]
          },
        ]
      }
      monthly_stats: {
        Row: {
          apporteur_id: string
          classement_position: number | null
          created_at: string | null
          id: string
          month_year: string
          total_dossiers: number | null
          total_economies: number | null
          updated_at: string | null
        }
        Insert: {
          apporteur_id: string
          classement_position?: number | null
          created_at?: string | null
          id?: string
          month_year: string
          total_dossiers?: number | null
          total_economies?: number | null
          updated_at?: string | null
        }
        Update: {
          apporteur_id?: string
          classement_position?: number | null
          created_at?: string | null
          id?: string
          month_year?: string
          total_dossiers?: number | null
          total_economies?: number | null
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "monthly_stats_apporteur_id_fkey"
            columns: ["apporteur_id"]
            isOneToOne: false
            referencedRelation: "apporteur_profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      notifications: {
        Row: {
          created_at: string | null
          data: Json | null
          id: string
          is_read: boolean | null
          message: string
          title: string
          type: string
          updated_at: string | null
          user_id: string
        }
        Insert: {
          created_at?: string | null
          data?: Json | null
          id?: string
          is_read?: boolean | null
          message: string
          title: string
          type?: string
          updated_at?: string | null
          user_id: string
        }
        Update: {
          created_at?: string | null
          data?: Json | null
          id?: string
          is_read?: boolean | null
          message?: string
          title?: string
          type?: string
          updated_at?: string | null
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "notifications_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "apporteur_profiles"
            referencedColumns: ["id"]
          },
        ]
      }
      pret_data: {
        Row: {
          apport_personnel: number | null
          banque_preteuse: string
          capital_restant_du: number | null
          cout_assurance_banque: number | null
          created_at: string | null
          date_debut: string | null
          date_debut_effective: string | null
          date_fin: string | null
          dossier_id: string | null
          duree_mois: number
          duree_restante_mois: number | null
          id: string
          montant_capital: number
          taux_assurance: number | null
          taux_effectif: number | null
          taux_nominal: number | null
          type_garantie: string | null
          type_pret: string
          updated_at: string | null
        }
        Insert: {
          apport_personnel?: number | null
          banque_preteuse: string
          capital_restant_du?: number | null
          cout_assurance_banque?: number | null
          created_at?: string | null
          date_debut?: string | null
          date_debut_effective?: string | null
          date_fin?: string | null
          dossier_id?: string | null
          duree_mois: number
          duree_restante_mois?: number | null
          id?: string
          montant_capital: number
          taux_assurance?: number | null
          taux_effectif?: number | null
          taux_nominal?: number | null
          type_garantie?: string | null
          type_pret: string
          updated_at?: string | null
        }
        Update: {
          apport_personnel?: number | null
          banque_preteuse?: string
          capital_restant_du?: number | null
          cout_assurance_banque?: number | null
          created_at?: string | null
          date_debut?: string | null
          date_debut_effective?: string | null
          date_fin?: string | null
          dossier_id?: string | null
          duree_mois?: number
          duree_restante_mois?: number | null
          id?: string
          montant_capital?: number
          taux_assurance?: number | null
          taux_effectif?: number | null
          taux_nominal?: number | null
          type_garantie?: string | null
          type_pret?: string
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "pret_data_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "pret_data_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_enriched"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "pret_data_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_computed_status"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "pret_data_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_process_dates"
            referencedColumns: ["id"]
          },
        ]
      }
      process_steps: {
        Row: {
          completed_at: string | null
          created_at: string | null
          dossier_id: string | null
          id: string
          started_at: string | null
          status: string | null
          step_description: string | null
          step_name: string
          step_order: number
          updated_at: string | null
        }
        Insert: {
          completed_at?: string | null
          created_at?: string | null
          dossier_id?: string | null
          id?: string
          started_at?: string | null
          status?: string | null
          step_description?: string | null
          step_name: string
          step_order: number
          updated_at?: string | null
        }
        Update: {
          completed_at?: string | null
          created_at?: string | null
          dossier_id?: string | null
          id?: string
          started_at?: string | null
          status?: string | null
          step_description?: string | null
          step_name?: string
          step_order?: number
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "process_steps_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "process_steps_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_enriched"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "process_steps_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_computed_status"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "process_steps_dossier_id_fkey"
            columns: ["dossier_id"]
            isOneToOne: false
            referencedRelation: "dossiers_with_process_dates"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      [_ in never]: never
    }
    Enums: {
      apporteur_statut: "actif" | "inactif" | "suspendu"
      dossier_statut:
        | "en_attente"
        | "devis_disponible"
        | "devis_accepte"
        | "refuse"
        | "finalise"
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}

type DatabaseWithoutInternals = Omit<Database, "__InternalSupabase">

type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, "public">]

export type Tables<
  DefaultSchemaTableNameOrOptions extends
    | keyof (DefaultSchema["Tables"] & DefaultSchema["Views"])
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema["Tables"] &
        DefaultSchema["Views"])
    ? (DefaultSchema["Tables"] &
        DefaultSchema["Views"])[DefaultSchemaTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  DefaultSchemaEnumNameOrOptions extends
    | keyof DefaultSchema["Enums"]
    | { schema: keyof DatabaseWithoutInternals },
  EnumName extends DefaultSchemaEnumNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = DefaultSchemaEnumNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema["Enums"]
    ? DefaultSchema["Enums"][DefaultSchemaEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof DefaultSchema["CompositeTypes"]
    | { schema: keyof DatabaseWithoutInternals },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema["CompositeTypes"]
    ? DefaultSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never

export const Constants = {
  public: {
    Enums: {
      apporteur_statut: ["actif", "inactif", "suspendu"],
      dossier_statut: [
        "en_attente",
        "devis_disponible",
        "devis_accepte",
        "refuse",
        "finalise",
      ],
    },
  },
} as const
